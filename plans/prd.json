{
  "name": "Auth/RBAC E2E Testing",
  "description": "End-to-end tests for WorkOS authentication and role-based access control (RBAC) in Mastra Playground",
  "version": "1.1.0",
  "testDir": "packages/playground/e2e/tests/auth",
  "features": [
    {
      "id": "F001",
      "name": "E2E Test Infrastructure Setup",
      "description": "Set up the E2E testing infrastructure for auth tests including test fixtures, helpers, and kitchen-sink app configuration with WorkOS auth enabled",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-01-22",
      "tasks": [
        "Create auth test directory at packages/playground/e2e/tests/auth/",
        "Create test fixtures for different user roles (admin, member, viewer)",
        "Configure kitchen-sink app with WorkOS auth provider and RBAC",
        "Create auth helper utilities for login/logout operations",
        "Add environment variable templates for WorkOS credentials"
      ],
      "acceptanceCriteria": [
        "Auth test directory structure exists",
        "Test fixtures can simulate different user roles",
        "Kitchen-sink app runs with auth enabled",
        "Helper utilities are reusable across all auth tests"
      ],
      "implementation": {
        "files": [
          "packages/playground/e2e/tests/auth/infrastructure.spec.ts",
          "packages/playground/e2e/tests/auth/README.md",
          "packages/playground/e2e/tests/__utils__/auth.ts",
          "packages/playground/e2e/tests/__utils__/index.ts",
          "packages/playground/e2e/kitchen-sink/fixtures/auth-roles.fixture.ts",
          "packages/playground/e2e/kitchen-sink/.env.example"
        ],
        "testsAdded": 16,
        "approach": "Uses Playwright route interception to mock /api/auth/capabilities and /api/auth/me endpoints, enabling role-based testing without requiring real WorkOS credentials."
      }
    },
    {
      "id": "F002",
      "name": "Login Flow E2E Tests",
      "description": "Test the complete login flow including redirects, session management, and error handling",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-01-22",
      "tasks": [
        "Test unauthenticated user is redirected to login page",
        "Test successful login redirects to original destination",
        "Test login with invalid credentials shows error",
        "Test session persistence across page reloads",
        "Test login state is reflected in UI (user avatar, name display)"
      ],
      "acceptanceCriteria": [
        "Unauthenticated access redirects to /auth/login",
        "Successful login redirects back to requested page",
        "Invalid credentials display appropriate error message",
        "Session survives page refresh",
        "User info displays correctly after login"
      ],
      "implementation": {
        "files": ["packages/playground/e2e/tests/auth/login-flow.spec.ts"],
        "testsAdded": 23,
        "approach": "Uses Playwright route interception to mock auth endpoints. Tests cover unauthenticated access redirect, login page variations (SSO, credentials, both), successful login state transitions, invalid credentials error handling, session persistence across page reloads and navigation, sign-up link toggling, and auth disabled state."
      }
    },
    {
      "id": "F003",
      "name": "Sign Up Flow E2E Tests",
      "description": "Test the user registration and sign-up flow with WorkOS AuthKit",
      "priority": "P1",
      "status": "pending",
      "tasks": [
        "Test sign-up link is accessible from login page",
        "Test sign-up form validation (email format, password strength)",
        "Test successful sign-up creates user and logs them in",
        "Test sign-up with existing email shows appropriate error",
        "Test email verification flow if enabled"
      ],
      "acceptanceCriteria": [
        "Sign-up link navigates to registration form",
        "Form validation prevents invalid submissions",
        "New users are created and auto-logged in",
        "Duplicate email registration shows error",
        "Email verification completes successfully"
      ]
    },
    {
      "id": "F004",
      "name": "Logout Flow E2E Tests",
      "description": "Test the logout functionality and session cleanup",
      "priority": "P1",
      "status": "pending",
      "tasks": [
        "Test logout button is visible when authenticated",
        "Test clicking logout clears session",
        "Test logged out user is redirected to login",
        "Test back button after logout does not restore session",
        "Test logout from multiple tabs synchronizes state"
      ],
      "acceptanceCriteria": [
        "Logout button appears for authenticated users",
        "Session is cleared on logout",
        "User redirected to login after logout",
        "Browser back does not bypass logout",
        "Multi-tab logout works correctly"
      ]
    },
    {
      "id": "F005",
      "name": "Admin Role E2E Tests",
      "description": "Test that admin role has full access to all Mastra resources (agents, workflows, tools, MCPs)",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-01-22",
      "tasks": [
        "Test admin can view all agents",
        "Test admin can create/edit/delete agents",
        "Test admin can view all workflows",
        "Test admin can create/run/delete workflows",
        "Test admin can view and execute all tools",
        "Test admin can configure MCP servers",
        "Test admin can access settings and configuration"
      ],
      "acceptanceCriteria": [
        "Admin sees all navigation items",
        "Admin can perform CRUD on agents",
        "Admin can perform CRUD on workflows",
        "Admin can execute any tool",
        "Admin can manage MCP servers",
        "Admin can access all settings"
      ],
      "implementation": {
        "files": ["packages/playground/e2e/tests/auth/admin-role.spec.ts"],
        "testsAdded": 21,
        "approach": "Uses Playwright route interception to mock admin auth state with wildcard ['*'] permissions. Tests cover navigation access to all main sections, agent viewing and settings access, workflow viewing and execution controls, tool viewing and execution panel access, MCP server access, and verification that admin has more permissions than member/viewer roles."
      }
    },
    {
      "id": "F006",
      "name": "Member Role E2E Tests",
      "description": "Test that member role has limited access - can read agents and has full workflow access",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-01-22",
      "tasks": [
        "Test member can view agents list",
        "Test member cannot create/edit/delete agents",
        "Test member can view workflows",
        "Test member can create/run workflows",
        "Test member can edit own workflows",
        "Test member has restricted tool access",
        "Test member cannot access admin settings"
      ],
      "acceptanceCriteria": [
        "Member can read agents but not modify",
        "Create agent button is hidden for members",
        "Member has full workflow permissions",
        "Member restricted from admin-only features",
        "Permission denied shows appropriate message"
      ],
      "implementation": {
        "files": ["packages/playground/e2e/tests/auth/member-role.spec.ts"],
        "testsAdded": 25,
        "approach": "Uses Playwright route interception to mock member auth state with permissions ['agents:read', 'workflows:*', 'tools:read', 'tools:execute']. Tests cover navigation access to main sections, agent read-only access verification (no create/edit buttons), full workflow access including execution controls, tool viewing and execution panel access, permission verification, and comparison with admin/viewer roles."
      }
    },
    {
      "id": "F007",
      "name": "Viewer Role E2E Tests",
      "description": "Test that viewer role has read-only access to agents and workflows",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-01-22",
      "tasks": [
        "Test viewer can view agents list",
        "Test viewer cannot modify agents",
        "Test viewer can view workflows list",
        "Test viewer cannot create/edit workflows",
        "Test viewer cannot run workflows",
        "Test viewer sees read-only UI state",
        "Test action buttons are hidden or disabled for viewer"
      ],
      "acceptanceCriteria": [
        "Viewer can only read agents",
        "Viewer can only read workflows",
        "All create/edit/delete buttons hidden",
        "Run workflow button is disabled",
        "UI clearly indicates read-only state"
      ],
      "implementation": {
        "files": ["packages/playground/e2e/tests/auth/viewer-role.spec.ts"],
        "testsAdded": 28,
        "approach": "Uses Playwright route interception to mock viewer auth state with permissions ['agents:read', 'workflows:read']. Tests cover navigation access to read-only sections, agent and workflow read-only access verification, tools access denial (no tools permission), read-only UI state verification including disabled/hidden action buttons, and comparison with admin/member roles."
      }
    },
    {
      "id": "F008",
      "name": "Unauthorized Access E2E Tests",
      "description": "Test that users without roles (_default) are properly restricted",
      "priority": "P1",
      "status": "pending",
      "tasks": [
        "Test user with no organization membership has _default permissions",
        "Test _default permissions deny access to protected resources",
        "Test appropriate error page shown for unauthorized access",
        "Test API calls return 403 for unauthorized users",
        "Test deep links to protected pages redirect appropriately"
      ],
      "acceptanceCriteria": [
        "Users without roles get _default permissions",
        "Protected resources return 403",
        "Friendly error page displayed",
        "Deep links handled gracefully",
        "No information leakage on unauthorized access"
      ]
    },
    {
      "id": "F009",
      "name": "Session Expiry E2E Tests",
      "description": "Test session timeout and token refresh behavior",
      "priority": "P2",
      "status": "pending",
      "tasks": [
        "Test session expires after configured timeout",
        "Test expired session redirects to login",
        "Test token refresh extends session",
        "Test graceful handling of expired token during action",
        "Test remember me functionality if available"
      ],
      "acceptanceCriteria": [
        "Session expires correctly",
        "Expired users redirected to login",
        "Token refresh works transparently",
        "Mid-action expiry handled gracefully"
      ]
    },
    {
      "id": "F010",
      "name": "Role Switching E2E Tests",
      "description": "Test behavior when user's role changes while logged in",
      "priority": "P2",
      "status": "pending",
      "tasks": [
        "Test UI updates when role permissions change",
        "Test cached permissions are invalidated on role change",
        "Test user sees updated access after role upgrade",
        "Test user loses access immediately after role downgrade"
      ],
      "acceptanceCriteria": [
        "Role changes reflect in UI",
        "Permission cache cleared on role change",
        "Upgraded users get immediate access",
        "Downgraded users lose access immediately"
      ]
    },
    {
      "id": "F011",
      "name": "Server-Side Permission Enforcement Tests",
      "description": "Test that the server properly enforces RBAC permissions on API endpoints, independent of UI state. These tests verify security at the API level, not just UI restrictions.",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-01-22",
      "tasks": [
        "Test viewer cannot execute workflow via direct API call (expect 403)",
        "Test viewer cannot execute tools via direct API call (expect 403)",
        "Test member cannot modify agent settings via direct API call (expect 403)",
        "Test member cannot delete agents via direct API call (expect 403)",
        "Test unauthenticated user cannot access any protected API endpoints (expect 401)",
        "Test API returns 403 not 404 for unauthorized resource access (no information leakage)",
        "Test permission checks cannot be bypassed by manipulating client-side state"
      ],
      "acceptanceCriteria": [
        "All protected API endpoints return 401 for unauthenticated requests",
        "All protected API endpoints return 403 for insufficient permissions",
        "Direct API calls fail even when mocked UI would allow the action",
        "No information leakage via error messages or status codes",
        "Tests do NOT mock auth endpoints - they test real server enforcement"
      ],
      "notes": "CRITICAL: These tests must NOT use route interception for auth endpoints. They should test actual server-side permission enforcement by making real API calls and verifying the server rejects unauthorized actions.",
      "implementation": {
        "files": [
          "packages/playground/e2e/tests/auth/server-permission-enforcement.spec.ts",
          "packages/playground/e2e/kitchen-sink/src/mastra/test-auth.ts",
          "packages/playground/e2e/playwright.auth-server.config.ts"
        ],
        "testsAdded": 23,
        "approach": "Created TestAuthProvider that authenticates based on Bearer token value as role. Uses SEPARATE playwright config (playwright.auth-server.config.ts) that starts server with E2E_TEST_AUTH=true. This keeps UI tests fast (no server auth overhead) while server permission tests verify real RBAC enforcement. Direct API tests send Bearer tokens manually to verify 401/403 responses."
      }
    },
    {
      "id": "F012",
      "name": "Direct API Bypass Prevention Tests",
      "description": "Test that users cannot bypass UI restrictions by making direct API calls or manipulating URLs",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-01-22",
      "tasks": [
        "Test viewer making POST to /api/workflows/{id}/run returns 403",
        "Test viewer making DELETE to /api/agents/{id} returns 403",
        "Test member making PUT to /api/agents/{id}/settings returns 403",
        "Test direct URL access to admin pages with viewer role shows permission denied",
        "Test API rate limiting on permission-denied requests",
        "Test no sensitive data returned in 403 error responses"
      ],
      "acceptanceCriteria": [
        "All write operations blocked at API level for read-only roles",
        "Direct URL manipulation does not grant unauthorized access",
        "API error responses do not leak sensitive information",
        "Server logs show blocked unauthorized attempts"
      ],
      "implementation": {
        "files": [
          "packages/playground/e2e/tests/auth/api-bypass-prevention.spec.ts",
          "packages/playground/e2e/playwright.auth-server.config.ts",
          "packages/playground/e2e/playwright.config.ts"
        ],
        "testsAdded": 21,
        "approach": "Created comprehensive API bypass prevention tests that verify users cannot bypass UI restrictions. Tests cover direct URL access to protected pages, direct API calls with wrong role, cross-role bypass attempts, error response security, and multiple sequential bypass attempts. Tests run with E2E_TEST_AUTH=true via playwright.auth-server.config.ts. Note: Some PRD tasks (workflow run, agent delete, agent settings) are not testable because those routes don't have requiresPermission configured or don't exist - tests focus on currently enforceable permissions (agents:read, agents:execute)."
      },
      "notes": "Some tasks from original PRD could not be implemented as specified because: (1) Workflow routes don't have requiresPermission configured, (2) DELETE /api/agents/{id} endpoint doesn't exist, (3) PUT /api/agents/{id}/settings endpoint doesn't exist. Tests verify all currently enforceable permissions."
    },
    {
      "id": "F013",
      "name": "Fix Conditional Assertions in Existing Tests",
      "description": "Refactor existing tests to remove conditional assertions that can silently pass when UI elements are missing",
      "priority": "P1",
      "status": "pending",
      "tasks": [
        "Replace 'if (visible) { expect }' patterns with explicit assertions",
        "Add data-testid attributes to replace fragile .first() selectors",
        "Ensure all permission UI tests have explicit visible/not-visible assertions",
        "Remove silent pass conditions in viewer-role.spec.ts (lines 156-160, 187-192, etc.)",
        "Remove silent pass conditions in member-role.spec.ts (lines 121-128, etc.)",
        "Add test coverage for cases where buttons should NOT exist vs should be disabled"
      ],
      "acceptanceCriteria": [
        "No tests use 'if (await element.isVisible())' conditional patterns",
        "All selectors use data-testid or unique role/name combinations",
        "Tests fail explicitly when expected restrictions are not present",
        "Code review confirms no silent pass conditions remain"
      ]
    }
  ],
  "rolePermissions": {
    "admin": ["*"],
    "member": ["agents:read", "workflows:*", "tools:read", "tools:execute"],
    "viewer": ["agents:read", "workflows:read"],
    "_default": []
  },
  "testConfiguration": {
    "testFramework": "playwright",
    "workingDirectory": "packages/playground/e2e",
    "baseUrl": "http://localhost:4111",
    "typecheckCommand": "pnpm typecheck",
    "configs": {
      "uiTests": {
        "config": "playwright.config.ts",
        "description": "UI tests with mocked auth via route interception. Server runs WITHOUT E2E_TEST_AUTH for faster execution.",
        "excludes": ["server-permission-enforcement.spec.ts", "api-bypass-prevention.spec.ts"]
      },
      "serverPermissionTests": {
        "config": "playwright.auth-server.config.ts",
        "description": "Server-side permission enforcement and API bypass prevention tests. Server runs WITH E2E_TEST_AUTH=true to enable TestAuthProvider.",
        "includes": ["server-permission-enforcement.spec.ts", "api-bypass-prevention.spec.ts"]
      }
    },
    "runIndividualSuites": {
      "note": "CRITICAL: ALWAYS run test files INDIVIDUALLY. NEVER run the full test suite - it causes timeouts, flakiness, and unclear failures. Run ONE spec file at a time.",
      "infrastructure": "CI=true npx playwright test -c playwright.config.ts --reporter=list tests/auth/infrastructure.spec.ts",
      "loginFlow": "CI=true npx playwright test -c playwright.config.ts --reporter=list tests/auth/login-flow.spec.ts",
      "adminRole": "CI=true npx playwright test -c playwright.config.ts --reporter=list tests/auth/admin-role.spec.ts",
      "memberRole": "CI=true npx playwright test -c playwright.config.ts --reporter=list tests/auth/member-role.spec.ts",
      "viewerRole": "CI=true npx playwright test -c playwright.config.ts --reporter=list tests/auth/viewer-role.spec.ts",
      "serverPermissionEnforcement": "CI=true npx playwright test -c playwright.auth-server.config.ts --reporter=list tests/auth/server-permission-enforcement.spec.ts",
      "apiBypassPrevention": "CI=true npx playwright test -c playwright.auth-server.config.ts --reporter=list tests/auth/api-bypass-prevention.spec.ts"
    },
    "runAllAuthTests": {
      "WARNING": "DO NOT USE THESE COMMANDS. They are provided for CI pipelines only. Claude and developers should ALWAYS run individual spec files using runIndividualSuites above.",
      "ciOnly_uiTests": "CI=true npx playwright test -c playwright.config.ts --reporter=list tests/auth/",
      "ciOnly_serverTests": "CI=true npx playwright test -c playwright.auth-server.config.ts --reporter=list"
    },
    "debugSingleTest": "CI=true npx playwright test -c playwright.config.ts --reporter=list --debug tests/auth/{spec-file}.spec.ts",
    "warnings": [
      "NEVER run the full test suite - ALWAYS run individual spec files one at a time",
      "Running multiple spec files together causes timeouts, flakiness, and unclear failures",
      "Always use --reporter=list to avoid HTML report hanging in CI",
      "Always prefix with CI=true to ensure consistent behavior",
      "Run from packages/playground/e2e directory",
      "Use playwright.auth-server.config.ts for server-permission-enforcement.spec.ts and api-bypass-prevention.spec.ts"
    ]
  },
  "qaReview": {
    "reviewedAt": "2026-01-22",
    "overallAssessment": "Tests provide good UI regression coverage but CRITICAL gaps in server-side security enforcement testing",
    "ratings": {
      "userFlowCoverage": "3/5 - Good UI flow coverage but missing actual user interactions",
      "securityEnforcement": "1/5 - CRITICAL: Only tests UI restrictions, not server enforcement",
      "testReliability": "2/5 - Conditional assertions can silently pass",
      "realWorldScenarios": "2/5 - Heavy mocking means tests verify mock behavior, not real app"
    },
    "actionItems": [
      {
        "id": "QA001",
        "priority": "CRITICAL",
        "category": "Security",
        "issue": "No server-side permission enforcement tests",
        "description": "All tests mock auth endpoints. No tests verify that the server actually enforces RBAC permissions on API calls.",
        "recommendation": "Implement F011 - Add tests that make real API calls without mocking auth and verify 403 responses for unauthorized actions",
        "relatedFeature": "F011"
      },
      {
        "id": "QA002",
        "priority": "CRITICAL",
        "category": "Security",
        "issue": "No direct API bypass prevention tests",
        "description": "Tests only verify UI hides/disables buttons. A malicious user could make direct API calls to bypass UI restrictions.",
        "recommendation": "Implement F012 - Add tests that attempt API calls as wrong role and verify server rejection",
        "relatedFeature": "F012"
      },
      {
        "id": "QA003",
        "priority": "HIGH",
        "category": "Test Quality",
        "issue": "Conditional assertions that silently pass",
        "description": "Multiple tests use 'if (visible) { expect }' patterns. If the element doesn't exist, the test passes without verifying anything.",
        "recommendation": "Implement F013 - Replace with explicit assertions: expect(element).toBeVisible() or expect(element).not.toBeVisible()",
        "relatedFeature": "F013",
        "examples": [
          "viewer-role.spec.ts:156-160 - runButton visibility check",
          "viewer-role.spec.ts:187-192 - edit/delete button checks",
          "member-role.spec.ts:121-128 - settings section check",
          "admin-role.spec.ts:90-95 - settings controls check"
        ]
      },
      {
        "id": "QA004",
        "priority": "HIGH",
        "category": "Test Quality",
        "issue": "Over-mocked authentication",
        "description": "Every test intercepts real auth endpoints. Tests verify mock behavior, not actual application security.",
        "recommendation": "Add at least one test per role that uses real auth endpoints if test environment supports it, or clearly document these as 'UI Permission Tests' not 'Security Tests'"
      },
      {
        "id": "QA005",
        "priority": "MEDIUM",
        "category": "Test Quality",
        "issue": "Non-unique selectors using .first()",
        "description": "Multiple tests rely on .first() calls, suggesting non-unique selectors that may be fragile.",
        "recommendation": "Add data-testid attributes to key UI elements and use them in tests",
        "examples": [
          "viewer-role.spec.ts:152 - runButton.first()",
          "member-role.spec.ts:165 - triggerButton.first()",
          "admin-role.spec.ts:119 - workflowRow.first()"
        ]
      },
      {
        "id": "QA006",
        "priority": "MEDIUM",
        "category": "Coverage",
        "issue": "Missing logout flow tests",
        "description": "F004 (Logout Flow) is pending - no tests verify logout invalidates sessions.",
        "recommendation": "Implement F004 with focus on session invalidation, not just UI state"
      },
      {
        "id": "QA007",
        "priority": "LOW",
        "category": "Organization",
        "issue": "Fixture validation tests in E2E suite",
        "description": "infrastructure.spec.ts contains tests like 'ROLE_PERMISSIONS matches PRD specification' which are unit tests, not E2E tests.",
        "recommendation": "Move pure fixture/helper validation tests to a unit test file"
      }
    ],
    "securityTestingGuidelines": {
      "principle": "UI permission checks are NOT security. Server MUST independently validate all permissions.",
      "mustTest": [
        "Server returns 401 for unauthenticated API requests",
        "Server returns 403 for authenticated but unauthorized API requests",
        "Direct API calls fail for restricted actions regardless of mocked UI state",
        "No information leakage in error responses",
        "Session invalidation actually works at server level"
      ],
      "antiPatterns": [
        "Testing only that buttons are hidden/disabled (security by obscurity)",
        "Conditional assertions that pass when elements don't exist",
        "Mocking auth endpoints when testing security enforcement",
        "Assuming UI restrictions = server restrictions"
      ]
    }
  }
}
