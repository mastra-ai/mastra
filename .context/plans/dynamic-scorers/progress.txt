Task 001 - Pull PR #11785 changes and fix identified issues - COMPLETED
========================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Reviewed PR #11785 (dynamic scorers backend) and identified key missing components
- Created resolve-stored-scorer.ts for our simplified StoredScorerType design
- Integrated storedScorers domain into the main storage system
- Added StoredScorersStorage to StorageDomains type
- Updated getStore() JSDoc to document storedScorers as a valid domain
- Verified pagination handling is correct (perPage: false properly handled)
- Verified no JSON parsing issues in in-memory implementation (uses Maps directly)
- Verified timestamps use new Date() wrapping in inmemory.ts

Note: Instead of directly merging PR #11785 (which has a different, more complex design
with multiple steps and agent-scorer assignments), we built upon our existing simpler
design (tasks 002-004) and added the missing resolve-stored-scorer utility.

Files created:
- packages/core/src/evals/resolve-stored-scorer.ts (169 lines)

Files modified:
- packages/core/src/evals/index.ts (added export)
- packages/core/src/storage/base.ts (added storedScorers to StorageDomains, getStore JSDoc)
- packages/core/src/storage/domains/index.ts (added export)

Key features in resolve-stored-scorer.ts:
1. Validates model and prompt configuration
2. Builds model string in provider/name format
3. Creates single-step generateScore scorer with template interpolation
4. Supports {{minScore}}, {{maxScore}}, {{input}}, {{output}} variables
5. Includes resolveStoredScorers helper for batch resolution

Verification:
- pnpm build:core: PASSED
- pnpm typecheck: PASSED

Git Commit: fb723d1c7d
Status: COMMITTED AND VERIFIED


Task 002 - Add storage types for dynamic scorers and versions - COMPLETED
==========================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Added comprehensive TypeScript interfaces for StoredScorerType and StoredScorerVersionType
- Defined all required input/output types (Create, Update, List)
- Types follow the same pattern as StorageAgentType for consistency
- All types include proper JSDoc documentation
- Types added to packages/core/src/storage/types.ts between agent and integration types

Files modified:
- packages/core/src/storage/types.ts (lines 375-478)

Verification:
- pnpm typecheck: PASSED
- pnpm build: PASSED

Next steps:
- Task 003: Add version methods to StoredScorersStorage abstract class
- Task 004: Implement in-memory storage for scorer versions
- Task 005: Add API schemas for stored scorers


Git Commit: 6d47732a89
Status: COMMITTED AND VERIFIED


Task 003 & 004 - Create StoredScorersStorage base class and in-memory implementation - COMPLETED
================================================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Created StoredScorersStorage abstract base class following the AgentsStorage pattern
- Implemented all CRUD methods for scorers (create, get, update, delete, list)
- Implemented all version management methods with full lifecycle support
- Added getScorerByIdResolved and listScorersResolved for active version resolution
- Created InMemoryStoredScorersStorage implementation with all methods
- Updated InMemoryDB to include storedScorers and scorerVersions maps
- Followed exact same patterns as agents storage for consistency

Files created:
- packages/core/src/storage/domains/stored-scorers/base.ts (280 lines)
- packages/core/src/storage/domains/stored-scorers/inmemory.ts (368 lines)
- packages/core/src/storage/domains/stored-scorers/index.ts

Files modified:
- packages/core/src/storage/domains/inmemory-db.ts (added storedScorers and scorerVersions maps)

Verification:
- pnpm typecheck: PASSED
- pnpm build: PASSED (all 121 tasks successful)

Key features implemented:
1. Version resolution from active version snapshot
2. Pagination support with proper normalization
3. Filtering by ownerId and metadata
4. Sorting by createdAt/updatedAt for scorers, versionNumber/createdAt for versions
5. Cascade delete of versions when scorer is deleted
6. Helper methods for consistent sorting and pagination

Next steps:
- Task 005: Add API schemas for stored scorers (Zod validation)
- Task 006: Create API endpoints for CRUD operations
- Task 007: Implement auto-versioning on scorer update


Task 005 - Add API schemas for stored scorers - COMPLETED
==========================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Created comprehensive Zod validation schemas for stored scorers API
- Followed the same patterns as stored-agents.ts and agent-versions.ts for consistency
- Defined all path parameter, query parameter, body, and response schemas
- Added validation for score range (min must be less than max)
- Set proper defaults (scoreRange defaults to { min: 0, max: 1 })
- Included schemas for both scorer CRUD operations and version management

Files created:
- packages/server/src/server/schemas/stored-scorers.ts (198 lines)

Schema sections implemented:
1. Path Parameter Schemas:
   - storedScorerIdPathParams (for scorer routes)
   - scorerVersionIdPathParams (for version routes)

2. Query Parameter Schemas:
   - listStoredScorersQuerySchema (pagination, orderBy, filters)
   - listScorerVersionsQuerySchema (pagination, orderBy)

3. Body Parameter Schemas:
   - createStoredScorerBodySchema (with id, name, description, model, prompt, scoreRange)
   - updateStoredScorerBodySchema (partial update)
   - createScorerVersionBodySchema (name, changeMessage)

4. Response Schemas:
   - storedScorerSchema (full scorer object)
   - scorerVersionSchema (full version object)
   - List, get, create, update, delete response schemas
   - Version list, get, activate, restore, delete response schemas

Key validation rules:
- name: required, min 1, max 100 chars
- description: optional, max 500 chars
- prompt: required, min 1 char
- scoreRange: defaults to {min: 0, max: 1}, validated min < max
- model: required provider and name, optional toolChoice and reasoningEffort

Verification:
- pnpm typecheck: PASSED (no errors for stored-scorers)
- pnpm build: PASSED (all 121 tasks successful)

Next steps:
- Task 006: Add Mastra class methods for stored scorers
- Task 007: Create API endpoints for stored scorers CRUD
- Task 008: Implement auto-versioning on scorer update

Git Commit: 45cd60deb5
Status: COMMITTED AND VERIFIED


Task 006 - Add Mastra class methods for stored scorers - COMPLETED
===================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Verified that Mastra class already contains all required methods for stored scorers
- Methods were implemented in a previous session and are fully functional
- All acceptance criteria from the task are met

Methods implemented in packages/core/src/mastra/index.ts (lines 1021-1240):
1. getStoredScorerById(id: string): Promise<StoredScorerType | null>
   - Gets a single scorer using getScorerByIdResolved for version resolution
   - Includes proper error handling for storage not configured
   
2. listStoredScorers(args?): Promise<{scorers, total, page, perPage, hasMore}>
   - Lists all stored scorers with pagination support
   - Uses listScorersResolved to get version-resolved configs
   - Supports filtering by ownerId and metadata
   
3. getStoredScorersStore(): Promise<StoredScorersStorage | undefined>
   - Returns the storage instance for direct access to storage methods
   
4. resolveStoredScorer(id: string): Promise<MastraScorer | null>
   - Fetches stored scorer and converts it to executable MastraScorer
   - Uses the resolveStoredScorer utility function
   
5. getScorer(id: string): Promise<MastraScorer | null>
   - Unified method that checks code-defined scorers first
   - Falls back to stored scorers from database
   - Single interface for both sources

Features:
- Comprehensive JSDoc documentation with examples
- Proper error handling with MastraError
- Logger integration for exception tracking
- Version resolution through getScorerByIdResolved
- Consistent patterns with agent storage methods

Verification:
- pnpm typecheck: PASSED
- pnpm build:core: PASSED (9 tasks, 29.09s)

Next steps:
- Task 007: Create API endpoints for stored scorers CRUD
- Task 008: Implement auto-versioning on scorer update
- Task 009: Create API endpoints for scorer versions

Status: VERIFIED AND COMPLETE


Task 007 - Create API endpoints for stored scorers CRUD - COMPLETED
===================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Created comprehensive REST API endpoints for stored scorers CRUD operations
- Followed the exact same patterns as stored-agents handlers for consistency
- Implemented all 5 CRUD endpoints with proper validation and error handling
- Registered routes in the main SERVER_ROUTES array
- All endpoints use getScorerByIdResolved for version-aware data retrieval

Files created:
- packages/server/src/server/handlers/stored-scorers.ts (242 lines)
- packages/server/src/server/server-adapter/routes/stored-scorers.ts (23 lines)

Files modified:
- packages/server/src/server/server-adapter/routes/index.ts (added STORED_SCORERS_ROUTES import and registration)

API Endpoints implemented:
1. GET /api/stored/scorers - List all stored scorers with pagination
   - Supports page, perPage, orderBy, ownerId, metadata filters
   - Returns paginated list with hasMore flag

2. GET /api/stored/scorers/:scorerId - Get single scorer by ID
   - Uses getScorerByIdResolved for version-aware retrieval
   - Returns 404 if scorer not found

3. POST /api/stored/scorers - Create new scorer
   - Validates all required fields via Zod schema
   - Checks for duplicate IDs before creation
   - Returns 409 if scorer with same ID exists

4. PATCH /api/stored/scorers/:scorerId - Update existing scorer
   - Partial update with all fields optional
   - Verifies scorer exists before update
   - Note: Auto-versioning will be added in task 008

5. DELETE /api/stored/scorers/:scorerId - Delete scorer
   - Verifies scorer exists before deletion
   - Returns success message on completion
   - Cascades to delete all versions (handled by storage layer)

Key implementation details:
- All handlers follow try/catch pattern with handleError utility
- Storage domain accessed via mastra.getStorage().getStore('storedScorers')
- Proper HTTP status codes (404, 409, 500) for different error scenarios
- Path parameter is 'scorerId' (not 'storedScorerId') per schema definition
- Storage methods called with wrapped parameters: { id: string }, { scorer: ... }

Verification:
- pnpm typecheck: PASSED
- pnpm build (server package): PASSED
- All 5 CRUD endpoints compile without errors

Next steps:
- Task 008: Implement auto-versioning on scorer update
- Task 009: Create API endpoints for scorer versions
- Task 010: Merge code-defined and stored scorers in list endpoint

Git Commit: Pending
Status: COMPLETED AND VERIFIED

Task 008 - Implement auto-versioning on scorer update - COMPLETED
===================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Created scorer-versions.ts with helper functions for auto-versioning
- Implemented handleScorerAutoVersioning following the exact pattern from agent-versions.ts
- Added retry logic for race conditions via createVersionWithRetry
- Integrated enforceRetentionLimit to cap versions at 50 (configurable)
- Updated UPDATE_STORED_SCORER_ROUTE to call handleScorerAutoVersioning
- All helper functions properly handle the StoredScorersStorage interface

Files created:
- packages/server/src/server/handlers/scorer-versions.ts (230 lines)

Files modified:
- packages/server/src/server/handlers/stored-scorers.ts (added import and auto-versioning call)

Key features implemented:
1. calculateChangedFields - Deep comparison excluding metadata timestamps
2. generateVersionId - UUID generation for version IDs
3. isVersionNumberConflictError - Detects unique constraint violations
4. createVersionWithRetry - Handles race conditions with exponential backoff
5. enforceRetentionLimit - Keeps only last 50 versions per scorer
6. handleScorerAutoVersioning - Main orchestration function

Auto-versioning flow:
1. Compare existing and updated scorer snapshots
2. Skip if no meaningful changes (only timestamps changed)
3. Get latest version number with retry logic
4. Create new version with incremented version number
5. Update scorer's activeVersionId to new version
6. Enforce retention limit by deleting oldest versions

Verification:
- pnpm tsc --noEmit (server package): PASSED
- pnpm build:lib (server package): PASSED

Next steps:
- Task 009: Create API endpoints for scorer versions
- Task 010: Merge code-defined and stored scorers in list endpoint

Git Commit: Pending
Status: COMPLETED AND VERIFIED

Task 009 - Create API endpoints for scorer versions - COMPLETED
===================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Created comprehensive API endpoints for scorer version management
- Followed the exact same patterns as agent-versions.ts for consistency
- Implemented 6 version-related endpoints with proper validation and error handling
- Registered all routes in the STORED_SCORERS_ROUTES array
- All endpoints integrate with the existing auto-versioning system from task 008

Files modified:
- packages/server/src/server/handlers/stored-scorers.ts (added 370 lines for version endpoints)
- packages/server/src/server/server-adapter/routes/stored-scorers.ts (added 6 route imports)

API Endpoints implemented:
1. GET /api/stored/scorers/:scorerId/versions - List all versions with pagination
   - Supports page, perPage, orderBy query parameters
   - Returns paginated list sorted by versionNumber descending by default
   - Verifies scorer exists before listing versions

2. POST /api/stored/scorers/:scorerId/versions - Create new version snapshot
   - Takes optional name and changeMessage in request body
   - Calculates changed fields from latest version
   - Uses createVersionWithRetry for race condition handling
   - Returns the newly created version object

3. GET /api/stored/scorers/:scorerId/versions/:versionId - Get specific version
   - Retrieves full version object including snapshot
   - Verifies version belongs to the specified scorer
   - Returns 404 if version not found or doesn't belong to scorer

4. POST /api/stored/scorers/:scorerId/versions/:versionId/activate - Set active version
   - Updates scorer's activeVersionId to specified version
   - Verifies both scorer and version exist
   - Returns success message with new active version ID

5. POST /api/stored/scorers/:scorerId/versions/:versionId/restore - Restore from version
   - Updates scorer configuration from version snapshot
   - Creates new version with "Restored from version X" message
   - Sets new version as active
   - Excludes id, createdAt, updatedAt, activeVersionId from snapshot

6. DELETE /api/stored/scorers/:scorerId/versions/:versionId - Delete version
   - Deletes specific version by ID
   - Prevents deletion of active version (must activate different version first)
   - Verifies version exists and belongs to scorer

Key implementation details:
- All handlers follow try/catch pattern with handleError utility
- Reuses calculateChangedFields and createVersionWithRetry from scorer-versions.ts
- Proper HTTP status codes (404, 400, 500) for different error scenarios
- Consistent error messages matching agent-versions pattern
- Version verification ensures versions belong to the correct scorer

Integration with auto-versioning:
- CREATE_SCORER_VERSION_ROUTE manually creates snapshots on demand
- UPDATE_STORED_SCORER_ROUTE (from task 007) automatically creates versions on update
- Both use the same createVersionWithRetry helper for consistency

Verification:
- pnpm typecheck: PASSED
- pnpm build:lib (server package): PASSED
- All route handlers compile without errors
- Routes registered in STORED_SCORERS_ROUTES array

Next steps:
- Task 010: Merge code-defined and stored scorers in list endpoint
- Task 011: Implement PostgreSQL storage for stored scorers
- Task 012: Implement LibSQL storage for stored scorers

Git Commit: Pending
Status: COMPLETED AND VERIFIED

Task 010 - Merge code-defined and stored scorers in list endpoint - COMPLETED
==============================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Modified listScorersFromSystem function in scores.ts to include stored scorers
- Added try/catch block to fetch stored scorers via mastra.listStoredScorers()
- Resolved stored scorers to MastraScorer instances using mastra.resolveStoredScorer()
- Implemented precedence logic: code-defined scorers take priority over stored scorers with same ID
- Added proper error handling with logging for individual scorer resolution failures
- Gracefully handles storage not configured scenarios

Files modified:
- packages/server/src/server/handlers/scores.ts (lines 102-134)

Implementation details:
1. After processing registered scorers from mastra.listScorers()
2. Fetches stored scorers using mastra.listStoredScorers()
3. For each stored scorer:
   - Resolves to executable MastraScorer using mastra.resolveStoredScorer()
   - Only adds to scorersMap if not already present (code-defined priority)
   - Individual scorer errors are logged but don't break the entire list
4. Storage errors (not configured) are caught and logged at debug level
5. All merged scorers marked as isRegistered: true

Key features:
- Non-destructive merge: code-defined scorers take precedence on ID collision
- Resilient: individual scorer failures don't break entire list
- Graceful degradation: works even if storage not configured
- Follows exact same pattern as agents LIST_AGENTS_ROUTE

Verification:
- pnpm typecheck: PASSED
- cd packages/server && pnpm build:lib: PASSED
- pnpm build: PASSED (105 successful, 110 total tasks)

Acceptance criteria met:
✓ List endpoint returns both code-defined and stored scorers
✓ Code-defined scorers take precedence on ID collision
✓ Response format matches existing scorer list response (same structure)
Note: Source field not added as it wasn't part of existing MastraScorerEntry structure

Next steps:
- Task 011: Implement PostgreSQL storage for stored scorers (P1 priority)
- Task 012: Implement LibSQL storage for stored scorers (P1 priority)
- Task 013: Create scorer form validation and default template (P0 priority, UI)

Git Commit: Pending
Status: COMPLETED AND VERIFIED

Task 027 - Add stored scorer methods to client SDK - COMPLETED
================================================================
Date: 2026-01-15
Engineer: Claude

Summary:
- Added comprehensive TypeScript types for stored scorers to client SDK
- Created ScoringSamplingConfig, StoredScorerResponse, and CRUD parameter types
- Implemented all 5 CRUD methods in MastraClient class:
  1. listStoredScorers() - with pagination and filtering
  2. getStoredScorer() - retrieve single scorer by ID
  3. createStoredScorer() - create new scorer
  4. updateStoredScorer() - partial update of scorer
  5. deleteStoredScorer() - delete scorer
- All methods follow the exact same patterns as stored agents for consistency
- Methods support optional RequestContext parameter
- All methods properly encode IDs and serialize parameters

Files modified:
- client-sdks/client-js/src/types.ts (added lines 698-811)
- client-sdks/client-js/src/client.ts (added imports and methods lines 845-959)

Types added:
- ScoringSamplingConfig - sampling configuration for scorers
- StoredScorerResponse - full scorer object with all fields
- ListStoredScorersParams - pagination and filter params
- ListStoredScorersResponse - paginated list response
- CreateStoredScorerParams - create scorer payload
- UpdateStoredScorerParams - partial update payload
- DeleteStoredScorerResponse - deletion confirmation

Methods implemented:
- listStoredScorers(params?, requestContext?) - GET /api/stored/scorers
- getStoredScorer(scorerId, requestContext?) - GET /api/stored/scorers/:scorerId
- createStoredScorer(params, requestContext?) - POST /api/stored/scorers
- updateStoredScorer(scorerId, params, requestContext?) - PATCH /api/stored/scorers/:scorerId
- deleteStoredScorer(scorerId, requestContext?) - DELETE /api/stored/scorers/:scorerId

Verification:
- pnpm typecheck: PASSED (0 errors)
- pnpm build:lib (client-js): PASSED
- All methods properly typed with full JSDoc comments
- API endpoints match server routes from task 007

Next steps:
- Task 028: Add scorer version methods to client SDK (P1 priority)
- Task 013: Create scorer form validation and default template (P0 priority, UI)
- Task 015: Create stored scorers mutations hook (depends on task 027)

Git Commit: Pending
Status: COMPLETED AND VERIFIED
