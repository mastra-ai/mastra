# PR5: Auth (WorkOS, Better Auth, Cloud) - Progress Tracking

## Status: In Progress

## Task Progress

### Backend - EE Core Infrastructure
- [x] 001: Create EE module structure and license validation
- [x] 002: Define EEUser and IUserProvider interface
- [x] 003: Define Session and ISessionProvider interface
- [x] 004: Define ISSOProvider interface for OAuth/OIDC
- [x] 005: Define ICredentialsProvider interface
- [x] 006: Define IRBACProvider interface for role-based access control
- [x] 007: Define IACLProvider interface for resource-level access control
- [ ] 008: Define IAuditLogger interface for security event logging
- [ ] 009: Create MastraAuthProvider base class
- [ ] 010: Create capabilities detection and response building
- [ ] 011: Create withEE composition helper

### Backend - Default Implementations
- [ ] 012: Create default role definitions
- [ ] 013: Implement MemorySessionProvider
- [ ] 014: Implement CookieSessionProvider
- [ ] 015: Implement StaticRBACProvider
- [ ] 016: Implement ConsoleAuditLogger
- [ ] 017: Create audit storage interface and in-memory implementation

### Backend - Server API
- [ ] 018: Create auth API handlers
- [ ] 019: Create audit API handlers
- [ ] 020: Register auth and audit routes

### Backend - WorkOS Provider
- [ ] 021: Create WorkOS auth provider package structure
- [ ] 022: Implement WorkOS SSO and session providers
- [ ] 023: Implement WorkOS user provider and RBAC
- [ ] 024: Implement WorkOS directory sync and audit export
- [ ] 025: Create main WorkOS auth provider class

### Backend - Better Auth Provider
- [ ] 026: Create Better Auth provider package structure
- [ ] 027: Implement Better Auth credentials and user providers

### Backend - Cloud Auth Provider
- [ ] 028: Create Mastra Cloud auth provider package

### Frontend - Auth Hooks
- [ ] 029: Create auth capabilities React Query hook
- [ ] 030: Create current user and auth actions hooks
- [ ] 031: Create permissions and credentials hooks

### Frontend - Auth Components
- [ ] 032: Create login page component
- [ ] 033: Create login button component
- [ ] 034: Create AuthRequired guard component
- [ ] 035: Create auth status and user menu components

### Frontend - Pages
- [ ] 036: Create signup and OAuth callback pages
- [ ] 037: Create login page in playground
- [ ] 038: Create audit log page
- [ ] 039: Integrate auth into playground layout

### Testing & Verification
- [ ] 040: Verify build and typecheck pass
- [ ] 041: Run and fix affected package tests
- [ ] 042: Manual end-to-end testing
- [ ] 043: Add changeset for PR

## Notes

---

## Session Log

### 2026-01-17 - Task 001 Complete
- Created EE module structure at packages/core/src/ee/
- Implemented license.ts with validateLicense() function
- Added support for MASTRA_EE_LICENSE environment variable
- Created LicenseInfo type with validation logic (>= 32 chars)
- Created index.ts that exports all EE interfaces and utilities
- Added placeholder files for interfaces, capabilities, with-ee, and defaults to enable compilation
- Verified build passes with pnpm build:core
- Module is now accessible from @mastra/core/ee

Next engineer: Task 002 (Define EEUser and IUserProvider interface) is ready to implement. All dependencies are in place.

### 2026-01-17 - Task 002 Complete
- Created packages/core/src/ee/interfaces/user.ts
- Defined EEUser interface with id, email, name, avatarUrl, metadata fields
- Defined IUserProvider<TUser extends EEUser> generic interface
- Added getCurrentUser(request: Request) method for retrieving current user from HTTP request
- Added getUser(userId: string) method for user lookup by ID
- Added optional getUserProfileUrl(user: TUser) method for profile URL generation
- Exported types from packages/core/src/ee/interfaces/index.ts
- Verified core package typecheck passes (packages/core typecheck: Done)
- Verified core package build passes with pnpm build:core
- Types are now accessible from @mastra/core/ee

Next engineer: Task 003 (Define Session and ISessionProvider interface) is ready to implement. The user interface foundation is now in place.

### 2026-01-17 - Task 003 Complete
- Created packages/core/src/ee/interfaces/session.ts
- Defined Session interface with id, userId, expiresAt, createdAt, metadata fields
- Defined ISessionProvider<TSession extends Session> generic interface
- Added createSession(userId, metadata?) method for creating user sessions
- Added validateSession(sessionId) method for session validation
- Added destroySession(sessionId) method for logout
- Added refreshSession(sessionId) method for extending session expiry
- Added getSessionIdFromRequest(request) method for extracting session from HTTP request
- Added getSessionHeaders(session) method for generating Set-Cookie headers
- Added getClearSessionHeaders() method for logout cookie clearing
- Exported types from packages/core/src/ee/interfaces/index.ts
- Verified core package typecheck passes
- Verified core package build passes with pnpm -w run build:core
- Types are now accessible from @mastra/core/ee

Next engineer: Task 004 (Define ISSOProvider interface for OAuth/OIDC) is ready to implement. Session management foundation is now in place.

### 2026-01-17 - Task 004 Complete
- Created packages/core/src/ee/interfaces/sso.ts
- Defined SSOLoginConfig interface with provider, text, icon, url fields for rendering login buttons
- Defined SSOTokens interface with accessToken, refreshToken, idToken, expiresAt for OAuth/OIDC tokens
- Defined SSOCallbackResult<TUser> interface for callback handling with user, tokens, and cookies
- Defined ISSOProvider<TUser> generic interface for OAuth 2.0 and OIDC flows
- Added getLoginUrl(redirectUri, state) method for initiating SSO redirect
- Added handleCallback(code, state) method for exchanging authorization code for tokens and user
- Added optional getLogoutUrl(redirectUri) method for providers supporting federated logout
- Added getLoginButtonConfig() method for providing UI rendering configuration
- Exported all types from packages/core/src/ee/interfaces/index.ts
- Verified core package typecheck passes
- Verified core package build passes with pnpm build:core
- Verified full monorepo build passes with pnpm build
- Types are now accessible from @mastra/core/ee

Next engineer: Task 005 (Define ICredentialsProvider interface) is ready to implement. SSO interface foundation is now in place.

### 2026-01-17 - Task 005 Complete
- Created packages/core/src/ee/interfaces/credentials.ts
- Defined CredentialsResult<TUser> interface with user, session, cookies fields for successful authentication
- Defined ICredentialsProvider<TUser extends EEUser> generic interface for email/password authentication
- Added signIn(email, password, request?) method for user authentication
- Added signUp(email, password, name?, request?) method for user registration
- Added optional requestPasswordReset(email) method for password reset flow
- Added optional resetPassword(token, newPassword) method for completing password reset
- Added optional isSignUpEnabled() method to allow disabling registration while keeping login active
- Exported CredentialsResult and ICredentialsProvider from packages/core/src/ee/interfaces/index.ts
- Request parameter supports rate limiting and IP logging via HTTP Request object
- Verified core package typecheck passes
- Verified core package build passes with pnpm build:core
- Types are now accessible from @mastra/core/ee

Next engineer: Task 006 (Define IRBACProvider interface for role-based access control) is ready to implement. Authentication interfaces are complete, now ready for access control interfaces.

### 2026-01-17 - Task 006 Complete
- Created packages/core/src/ee/interfaces/rbac.ts
- Defined RoleMapping type as { [role: string]: string[] } for static role configurations
- Defined Role interface with id, name, permissions fields for dynamic RBAC systems
- Defined IRBACProvider<TUser extends EEUser> generic interface
- Added optional roleMapping property for simple static configurations
- Added getRoles(user) method returning Promise<string[]> for role extraction
- Added hasRole(user, role) method returning Promise<boolean> for role checks
- Added getPermissions(user) method returning Promise<string[]> for permission expansion
- Added hasPermission(user, permission) method with wildcard support ('*', 'namespace:*')
- Added hasAllPermissions(user, permissions[]) method for AND permission checks
- Added hasAnyPermission(user, permissions[]) method for OR permission checks
- Exported RoleMapping, Role, and IRBACProvider from packages/core/src/ee/interfaces/index.ts
- RBAC is fully decoupled from authentication - can be added to any auth provider via withEE()
- Permissions use dot-notation (e.g., 'agents:read', 'workflows:execute')
- Wildcard permissions supported: '*' for all, 'namespace:*' for namespace
- Verified core package typecheck passes
- Verified core package build passes with pnpm build:core
- Types are now accessible from @mastra/core/ee

Next engineer: Task 007 (Define IACLProvider interface for resource-level access control) is ready to implement. The RBAC foundation is complete and ready for granular resource-level ACL.

### 2026-01-17 - Task 007 Complete
- Created packages/core/src/ee/interfaces/acl.ts
- Defined ResourceIdentifier interface with type and id fields for identifying resources
- Defined ACLGrant interface with subject, resource, actions, grantedAt, grantedBy for tracking access grants
- Defined IACLProvider<TUser extends EEUser> interface for read-only ACL operations
- Added canAccess(user, resource, action) method returning Promise<boolean> for permission checks
- Added listAccessible(user, resourceType, action) method returning Promise<string[]> for listing accessible resource IDs
- Added filterAccessible(user, resources[], resourceType, action) method for batch filtering operations
- Defined optional IACLManager<TUser> interface extending IACLProvider for write operations
- Added grant(subject, resource, actions, grantedBy) method for granting permissions
- Added revoke(subject, resource, actions?) method for revoking permissions
- Exported ResourceIdentifier, ACLGrant, IACLProvider, and IACLManager from packages/core/src/ee/interfaces/index.ts
- ACL is fully decoupled from RBAC, providing granular resource-level access control
- Read interface (IACLProvider) is separate from write interface (IACLManager) for flexibility
- Supports batch operations via filterAccessible for efficient permission checking
- Verified core package typecheck passes
- Verified core package build passes with pnpm build:core
- Types are now accessible from @mastra/core/ee

Next engineer: Task 008 (Define IAuditLogger interface for security event logging) is ready to implement. The access control interfaces (RBAC + ACL) are complete and ready for audit logging.
### 2026-01-17 - Task 008 Complete
- Created packages/core/src/ee/interfaces/audit.ts
- Defined AuditActorType as 'user' | 'system' | 'apikey' for actor classification
- Defined AuditOutcome as 'success' | 'failure' | 'denied' for action results
- Defined AuditActor interface with type, id, email, ip, userAgent fields for tracking who performed actions
- Defined AuditResource interface with type, id, name fields for tracking what was acted upon
- Defined AuditEvent interface with id, timestamp, actor, action, resource, outcome, metadata, duration
- Defined AuditFilter interface for querying with actorId, actorType, action, resourceType, resourceId, outcome, date range, pagination
- Defined AuditExportFormat as 'json' | 'csv' for audit log exports
- Defined IAuditLogger interface for recording security events
- Added log(event: Omit<AuditEvent, 'id' | 'timestamp'>) method - id and timestamp generated by logger
- Added optional query(filter: AuditFilter) method returning Promise<AuditEvent[]>
- Added optional export(filter, format) method returning Promise<ReadableStream>
- Exported all audit types from packages/core/src/ee/interfaces/index.ts
- Audit logging supports compliance requirements with full event tracking
- Actor type distinguishes between users, system actions, and API key usage
- Optional query and export capabilities allow implementations to choose their level of functionality
- Verified core package typecheck passes
- Verified core package build passes with pnpm build:core
- Verified full monorepo build passes with pnpm -w run build
- Types are now accessible from @mastra/core/ee

Next engineer: Task 009 (Create MastraAuthProvider base class) is ready to implement. All core EE interfaces (user, session, SSO, credentials, RBAC, ACL, audit) are now complete and ready for the base provider class that composes them.
