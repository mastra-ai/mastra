{
  "prNumber": 1,
  "prTitle": "Dynamic Agents UI",
  "prDescription": "Create/Edit/Delete agents dynamically via UI modal with version tracking",
  "sourceBranch": "total-cms",
  "targetBranch": "main",
  "tasks": [
    {
      "id": "001",
      "category": "backend",
      "priority": "P0",
      "title": "Define stored agent storage interface",
      "description": "Create the base storage interface for stored agents with CRUD operations and versioning support. This is the foundation for all agent storage implementations.",
      "files": [
        "packages/core/src/storage/domains/agents/base.ts",
        "packages/core/src/storage/domains/agents/index.ts"
      ],
      "steps": [
        "Create packages/core/src/storage/domains/agents/ directory",
        "Define StoredAgent type with id, name, description, modelId, providerId, systemPrompt, tools, etc.",
        "Define AgentVersion type with versionId, agentId, config snapshot, createdAt, description",
        "Create IStoredAgentStorage interface with: create, get, getAll, update, delete methods",
        "Create IAgentVersionStorage interface with: createVersion, getVersions, getVersion, restoreVersion methods",
        "Export types and interfaces from index.ts"
      ],
      "acceptanceCriteria": [
        "StoredAgent type includes all necessary agent configuration fields",
        "AgentVersion type captures full agent state for restoration",
        "Interfaces support async operations with proper error handling",
        "Types are exported and can be imported from @mastra/core"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true
    },
    {
      "id": "002",
      "category": "backend",
      "priority": "P0",
      "title": "Implement in-memory stored agent storage",
      "description": "Create the in-memory implementation of the stored agent storage interface for development and testing.",
      "files": ["packages/core/src/storage/domains/agents/inmemory.ts"],
      "steps": [
        "Create InMemoryStoredAgentStorage class implementing IStoredAgentStorage",
        "Implement CRUD operations using Map or array storage",
        "Create InMemoryAgentVersionStorage class implementing IAgentVersionStorage",
        "Implement version creation with automatic snapshot of agent config",
        "Add proper error handling for not found cases",
        "Export implementations from index.ts"
      ],
      "acceptanceCriteria": [
        "All CRUD operations work correctly",
        "Versions are created with timestamps and unique IDs",
        "getVersions returns versions sorted by creation date",
        "restoreVersion correctly updates agent with historical config"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["001"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "003",
      "category": "backend",
      "priority": "P0",
      "title": "Add stored agent methods to Mastra class",
      "description": "Extend the Mastra class to support stored agents alongside code-defined agents.",
      "files": ["packages/core/src/mastra/index.ts"],
      "steps": [
        "Add storedAgentStorage property to Mastra configuration",
        "Implement getStoredAgent(id) method that retrieves and instantiates agent from storage",
        "Implement getStoredAgents() method that returns all stored agents",
        "Implement createStoredAgent(config) method",
        "Implement updateStoredAgent(id, config) method",
        "Implement deleteStoredAgent(id) method",
        "Ensure stored agents can use tools registered with Mastra"
      ],
      "acceptanceCriteria": [
        "Stored agents can be retrieved and used like code agents",
        "Stored agents have access to Mastra-registered tools",
        "Methods properly propagate storage errors",
        "getAgent() can resolve both code and stored agents"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["001", "002"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "004",
      "category": "backend",
      "priority": "P0",
      "title": "Create stored agents API handler",
      "description": "Implement the server-side CRUD API endpoints for stored agents.",
      "files": [
        "packages/server/src/server/handlers/stored-agents.ts",
        "packages/server/src/server/schemas/stored-agents.ts"
      ],
      "steps": [
        "Create Zod schemas for stored agent request/response validation",
        "Implement GET /api/stored-agents - list all stored agents",
        "Implement GET /api/stored-agents/:id - get single stored agent",
        "Implement POST /api/stored-agents - create new stored agent",
        "Implement PUT /api/stored-agents/:id - update stored agent",
        "Implement DELETE /api/stored-agents/:id - delete stored agent",
        "Add proper error responses (404, 400, 500)"
      ],
      "acceptanceCriteria": [
        "All endpoints return proper HTTP status codes",
        "Request validation rejects invalid payloads with clear errors",
        "Response schemas match TypeScript types",
        "OpenAPI spec is generated correctly"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["003"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "005",
      "category": "backend",
      "priority": "P0",
      "title": "Create agent versions API handler",
      "description": "Implement the server-side API endpoints for agent version management.",
      "files": [
        "packages/server/src/server/handlers/agent-versions.ts",
        "packages/server/src/server/schemas/agent-versions.ts"
      ],
      "steps": [
        "Create Zod schemas for version request/response validation",
        "Implement GET /api/stored-agents/:id/versions - list versions for agent",
        "Implement GET /api/stored-agents/:id/versions/:versionId - get specific version",
        "Implement POST /api/stored-agents/:id/versions - save current state as version",
        "Implement POST /api/stored-agents/:id/versions/:versionId/restore - restore version",
        "Add proper error handling for invalid agent/version IDs"
      ],
      "acceptanceCriteria": [
        "Versions are listed in reverse chronological order",
        "Version details include full agent configuration snapshot",
        "Restore creates a new version with restored config",
        "Proper 404 errors for non-existent agents/versions"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["004"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "006",
      "category": "backend",
      "priority": "P0",
      "title": "Register stored agent routes",
      "description": "Wire up the stored agent and version handlers to the server router.",
      "files": [
        "packages/server/src/server/server-adapter/routes/stored-agents.ts",
        "packages/server/src/server/server-adapter/routes/agent-versions.ts",
        "packages/server/src/server/server-adapter/routes/index.ts"
      ],
      "steps": [
        "Create stored-agents.ts route file with route definitions",
        "Create agent-versions.ts route file with route definitions",
        "Register routes in the main routes index",
        "Ensure routes are included in OpenAPI documentation",
        "Add appropriate route tags for API organization"
      ],
      "acceptanceCriteria": [
        "Routes are accessible at expected paths",
        "Routes appear in OpenAPI/Swagger documentation",
        "Route middleware (auth, validation) is applied correctly"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["004", "005"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "007",
      "category": "frontend",
      "priority": "P1",
      "title": "Create agent form validation schema",
      "description": "Define Zod validation schema for the agent creation/edit form.",
      "files": ["packages/playground-ui/src/domains/agents/components/create-agent/form-validation.ts"],
      "steps": [
        "Define agentFormSchema with all required fields",
        "Add validation for name (required, min length)",
        "Add validation for description (optional, max length)",
        "Add validation for model selection (required provider + model)",
        "Add validation for system prompt (optional, max length)",
        "Add validation for tools array (optional)",
        "Export schema and infer TypeScript type"
      ],
      "acceptanceCriteria": [
        "Schema validates all agent configuration fields",
        "Error messages are user-friendly",
        "TypeScript type is correctly inferred from schema"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true
    },
    {
      "id": "008",
      "category": "frontend",
      "priority": "P1",
      "title": "Create model picker components",
      "description": "Build the model picker UI for selecting AI provider and model.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/model-picker/provider-select.tsx",
        "packages/playground-ui/src/domains/agents/components/model-picker/model-select.tsx",
        "packages/playground-ui/src/domains/agents/components/model-picker/use-model-picker.ts",
        "packages/playground-ui/src/domains/agents/components/model-picker/index.ts"
      ],
      "steps": [
        "Create useModelPicker hook to manage provider/model state",
        "Fetch available providers from API or config",
        "Create ProviderSelect dropdown component",
        "Create ModelSelect dropdown that filters by selected provider",
        "Handle loading and error states",
        "Export components from index.ts"
      ],
      "acceptanceCriteria": [
        "Provider dropdown shows all available providers",
        "Model dropdown filters based on selected provider",
        "Selected values are properly controlled via form state",
        "Loading states show appropriate feedback"
      ],
      "estimatedComplexity": "medium",
      "dependencies": [],
      "status": "completed",
      "passing": true
    },
    {
      "id": "009",
      "category": "frontend",
      "priority": "P1",
      "title": "Create agent form component",
      "description": "Build the main form component for creating/editing agents.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/create-agent/agent-form.tsx",
        "packages/playground-ui/src/domains/agents/components/create-agent/model-picker.tsx"
      ],
      "steps": [
        "Create AgentForm component using react-hook-form",
        "Integrate Zod validation schema",
        "Add name input field",
        "Add description textarea field",
        "Integrate ModelPicker for provider/model selection",
        "Add system prompt textarea",
        "Add tools selector (multi-select from available tools)",
        "Handle form submission with onSubmit callback"
      ],
      "acceptanceCriteria": [
        "Form displays all agent configuration fields",
        "Validation errors show inline below fields",
        "Form can be pre-populated for edit mode",
        "Submit button is disabled during submission"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["007", "008"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "010",
      "category": "frontend",
      "priority": "P1",
      "title": "Create stored agents React Query hooks",
      "description": "Build React Query hooks for fetching and mutating stored agents.",
      "files": ["packages/playground-ui/src/domains/agents/hooks/use-stored-agents.ts"],
      "steps": [
        "Create useStoredAgents hook for listing agents",
        "Create useStoredAgent(id) hook for single agent",
        "Create useCreateStoredAgent mutation hook",
        "Create useUpdateStoredAgent mutation hook",
        "Create useDeleteStoredAgent mutation hook",
        "Configure proper cache invalidation on mutations",
        "Add optimistic updates where appropriate"
      ],
      "acceptanceCriteria": [
        "Hooks properly fetch and cache agent data",
        "Mutations invalidate relevant queries",
        "Loading and error states are exposed",
        "TypeScript types are correctly inferred"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["006"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "011",
      "category": "frontend",
      "priority": "P1",
      "title": "Create agent versions React Query hooks",
      "description": "Build React Query hooks for agent version management.",
      "files": ["packages/playground-ui/src/domains/agents/hooks/use-agent-versions.ts"],
      "steps": [
        "Create useAgentVersions(agentId) hook for listing versions",
        "Create useAgentVersion(agentId, versionId) hook for single version",
        "Create useSaveAgentVersion mutation hook",
        "Create useRestoreAgentVersion mutation hook",
        "Ensure version list refreshes after save/restore",
        "Handle version comparison data fetching"
      ],
      "acceptanceCriteria": [
        "Versions are fetched and cached correctly",
        "Save version creates new entry and refreshes list",
        "Restore version updates agent and creates new version",
        "Error states are properly handled"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["006"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "012",
      "category": "frontend",
      "priority": "P1",
      "title": "Create agent creation dialog",
      "description": "Build the modal dialog for creating new agents.",
      "files": ["packages/playground-ui/src/domains/agents/components/create-agent/create-agent-dialog.tsx"],
      "steps": [
        "Create CreateAgentDialog component using Dialog from UI library",
        "Add dialog trigger button",
        "Integrate AgentForm inside dialog content",
        "Handle form submission with useCreateStoredAgent",
        "Show loading state during creation",
        "Close dialog on successful creation",
        "Show toast notification on success/error"
      ],
      "acceptanceCriteria": [
        "Dialog opens and closes correctly",
        "Form submission creates agent via API",
        "Success closes dialog and shows notification",
        "Errors display in dialog without closing"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["009", "010"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "013",
      "category": "frontend",
      "priority": "P1",
      "title": "Create agent edit dialog",
      "description": "Build the modal dialog for editing existing agents.",
      "files": ["packages/playground-ui/src/domains/agents/components/create-agent/edit-agent-dialog.tsx"],
      "steps": [
        "Create EditAgentDialog component accepting agent prop",
        "Pre-populate AgentForm with existing agent data",
        "Handle form submission with useUpdateStoredAgent",
        "Show loading state during update",
        "Close dialog on successful update",
        "Optionally prompt to save version before editing"
      ],
      "acceptanceCriteria": [
        "Form is pre-populated with agent configuration",
        "Changes are saved via PUT API call",
        "Version can be saved before making changes",
        "Success shows notification and closes dialog"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["009", "010"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "014",
      "category": "frontend",
      "priority": "P1",
      "title": "Create agent delete confirmation dialog",
      "description": "Build the confirmation dialog for deleting agents.",
      "files": ["packages/playground-ui/src/domains/agents/components/create-agent/delete-agent-confirm.tsx"],
      "steps": [
        "Create DeleteAgentConfirm component with agent name prop",
        "Display warning message about permanent deletion",
        "Add Cancel and Delete buttons",
        "Handle deletion with useDeleteStoredAgent",
        "Show loading state on Delete button",
        "Close on successful deletion"
      ],
      "acceptanceCriteria": [
        "Warning message shows agent name",
        "Cancel closes dialog without action",
        "Delete calls API and shows loading state",
        "Success closes dialog and shows notification"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["010"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "015",
      "category": "frontend",
      "priority": "P2",
      "title": "Create agent versions list component",
      "description": "Build the UI for displaying agent version history.",
      "files": ["packages/playground-ui/src/domains/agents/components/agent-versions/agent-versions-list.tsx"],
      "steps": [
        "Create AgentVersionsList component accepting agentId prop",
        "Use useAgentVersions hook to fetch versions",
        "Display versions in a list with timestamp and description",
        "Add 'View' button to see version details",
        "Add 'Restore' button with confirmation",
        "Add 'Compare' button to compare with current",
        "Handle empty state when no versions exist"
      ],
      "acceptanceCriteria": [
        "Versions display in reverse chronological order",
        "Each version shows timestamp and description",
        "Restore triggers confirmation and API call",
        "Empty state shows helpful message"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["011"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "016",
      "category": "frontend",
      "priority": "P2",
      "title": "Create save version dialog",
      "description": "Build the dialog for saving a new agent version.",
      "files": ["packages/playground-ui/src/domains/agents/components/agent-versions/save-version-dialog.tsx"],
      "steps": [
        "Create SaveVersionDialog component with agentId prop",
        "Add description input field for version notes",
        "Handle save with useSaveAgentVersion hook",
        "Show loading state during save",
        "Close on successful save",
        "Show toast notification"
      ],
      "acceptanceCriteria": [
        "Dialog allows entering version description",
        "Save creates new version with description",
        "Success notification shows version created",
        "Dialog closes and version list refreshes"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["011"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "017",
      "category": "frontend",
      "priority": "P2",
      "title": "Create version comparison dialog",
      "description": "Build the dialog for comparing agent versions.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/agent-versions/version-compare-dialog.tsx",
        "packages/playground-ui/src/domains/agents/components/agent-versions/json-diff-modal.tsx"
      ],
      "steps": [
        "Create VersionCompareDialog accepting two version IDs",
        "Fetch both version configurations",
        "Create JsonDiffModal component for visual diff",
        "Highlight added, removed, and changed fields",
        "Show side-by-side comparison",
        "Add 'Restore to this version' action"
      ],
      "acceptanceCriteria": [
        "Side-by-side comparison shows both versions",
        "Differences are highlighted with colors",
        "Can restore to either version from dialog",
        "Large configs are scrollable"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["011"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "018",
      "category": "frontend",
      "priority": "P1",
      "title": "Update agents page with stored agents",
      "description": "Modify the agents page to display and manage stored agents.",
      "files": ["packages/playground/src/pages/agents/index.tsx"],
      "steps": [
        "Fetch both code agents and stored agents",
        "Display stored agents in a separate section or with badge",
        "Add 'Create Agent' button that opens CreateAgentDialog",
        "Add Edit and Delete actions to stored agent cards",
        "Add 'Versions' action to view version history",
        "Ensure stored agents can be selected for chat"
      ],
      "acceptanceCriteria": [
        "Page shows both code and stored agents",
        "Stored agents are visually distinguished",
        "CRUD actions work for stored agents",
        "Stored agents can be used in chat interface"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["012", "013", "014", "015"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "019",
      "category": "backend",
      "priority": "P1",
      "title": "Implement PostgreSQL stored agent storage",
      "description": "Create PostgreSQL implementation of stored agent storage.",
      "files": ["stores/pg/src/storage/domains/agents/index.ts"],
      "steps": [
        "Create PgStoredAgentStorage class",
        "Implement table schema for stored_agents",
        "Implement table schema for agent_versions",
        "Implement all CRUD operations with SQL",
        "Implement version operations",
        "Add proper indexes for performance",
        "Handle JSON serialization for config fields"
      ],
      "acceptanceCriteria": [
        "All storage interface methods implemented",
        "Tables created with proper schema",
        "Queries are parameterized (SQL injection safe)",
        "JSON fields properly serialized/deserialized"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["001"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "020",
      "category": "backend",
      "priority": "P1",
      "title": "Implement LibSQL stored agent storage",
      "description": "Create LibSQL implementation of stored agent storage.",
      "files": ["stores/libsql/src/storage/domains/agents/index.ts"],
      "steps": [
        "Create LibSqlStoredAgentStorage class",
        "Implement table schema for stored_agents",
        "Implement table schema for agent_versions",
        "Implement all CRUD operations",
        "Implement version operations",
        "Handle SQLite-specific data types"
      ],
      "acceptanceCriteria": [
        "All storage interface methods implemented",
        "Compatible with LibSQL/Turso",
        "JSON stored as TEXT and parsed correctly",
        "Timestamps handled correctly"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["001"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "021",
      "category": "backend",
      "priority": "P2",
      "title": "Implement MongoDB stored agent storage",
      "description": "Create MongoDB implementation of stored agent storage.",
      "files": ["stores/mongodb/src/storage/domains/agents/index.ts"],
      "steps": [
        "Create MongoStoredAgentStorage class",
        "Define collection schema for stored_agents",
        "Define collection schema for agent_versions",
        "Implement all CRUD operations",
        "Implement version operations",
        "Add indexes for agentId lookups"
      ],
      "acceptanceCriteria": [
        "All storage interface methods implemented",
        "Documents stored with proper structure",
        "Queries use indexes effectively",
        "ObjectId handled correctly"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["001"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "022",
      "category": "sdk",
      "priority": "P2",
      "title": "Create client SDK stored agent resource",
      "description": "Add stored agent methods to the JavaScript client SDK.",
      "files": ["client-sdks/client-js/src/resources/stored-agent.ts", "client-sdks/client-js/src/resources/index.ts"],
      "steps": [
        "Create StoredAgentResource class",
        "Implement list() method",
        "Implement get(id) method",
        "Implement create(config) method",
        "Implement update(id, config) method",
        "Implement delete(id) method",
        "Implement listVersions(agentId) method",
        "Implement saveVersion(agentId, description) method",
        "Implement restoreVersion(agentId, versionId) method",
        "Export from resources index"
      ],
      "acceptanceCriteria": [
        "All methods call correct API endpoints",
        "TypeScript types match server responses",
        "Error handling for API failures",
        "Methods are documented with JSDoc"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["006"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "023",
      "category": "sdk",
      "priority": "P2",
      "title": "Add client SDK stored agent tests",
      "description": "Write tests for the stored agent client SDK resource.",
      "files": ["client-sdks/client-js/src/resources/stored-agent.test.ts"],
      "steps": [
        "Set up test mocks for HTTP client",
        "Test list() returns array of agents",
        "Test get(id) returns single agent",
        "Test create() sends correct payload",
        "Test update() sends correct payload",
        "Test delete() calls correct endpoint",
        "Test version methods",
        "Test error handling for 404, 500 responses"
      ],
      "acceptanceCriteria": [
        "All methods have test coverage",
        "Mocks verify correct API calls",
        "Error scenarios are tested",
        "Tests pass in CI"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["022"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "024",
      "category": "testing",
      "priority": "P0",
      "title": "Verify build and typecheck pass",
      "description": "Ensure the complete PR builds and passes type checking.",
      "files": [],
      "steps": [
        "Run pnpm build from monorepo root",
        "Fix any build errors",
        "Run pnpm typecheck from monorepo root",
        "Fix any type errors",
        "Verify no regressions in existing functionality"
      ],
      "acceptanceCriteria": [
        "pnpm build completes without errors",
        "pnpm typecheck completes without errors",
        "No TypeScript strict mode violations"
      ],
      "estimatedComplexity": "small",
      "dependencies": [
        "001",
        "002",
        "003",
        "004",
        "005",
        "006",
        "007",
        "008",
        "009",
        "010",
        "011",
        "012",
        "013",
        "014",
        "015",
        "016",
        "017",
        "018",
        "019",
        "020",
        "021",
        "022",
        "023"
      ],
      "status": "completed",
      "passing": true
    },
    {
      "id": "025",
      "category": "testing",
      "priority": "P1",
      "title": "Run and fix affected package tests",
      "description": "Run tests for all packages modified in this PR and fix failures.",
      "files": [],
      "steps": [
        "Run pnpm test:core for core package",
        "Run pnpm test in packages/server",
        "Run pnpm test in packages/playground-ui",
        "Run pnpm test in stores/pg",
        "Run pnpm test in stores/libsql",
        "Run pnpm test in client-sdks/client-js",
        "Fix any test failures"
      ],
      "acceptanceCriteria": [
        "All existing tests pass",
        "No regressions in test coverage",
        "New code has reasonable test coverage"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["024"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "026",
      "category": "testing",
      "priority": "P1",
      "title": "Manual end-to-end testing",
      "description": "Manually test the complete feature flow in the playground.",
      "files": [],
      "steps": [
        "Start playground with pnpm dev in packages/playground",
        "Navigate to Agents page",
        "Create a new agent via UI modal",
        "Verify agent appears in list",
        "Edit the agent and save changes",
        "Verify edit creates a new version",
        "View version history",
        "Compare two versions",
        "Restore a previous version",
        "Delete an agent with confirmation",
        "Verify deleted agent is removed"
      ],
      "acceptanceCriteria": [
        "All CRUD operations work in UI",
        "Version history shows all changes",
        "Version comparison displays diff correctly",
        "Restore updates agent to previous state",
        "Delete removes agent permanently"
      ],
      "estimatedComplexity": "medium",
      "dependencies": ["025"],
      "status": "completed",
      "passing": true
    },
    {
      "id": "027",
      "category": "bugfix",
      "priority": "P0",
      "title": "Fix activateVersion return type mismatch",
      "description": "The activateVersion method in client SDK returns Promise<void> but server returns response with success, message, and activeVersionId. Also, ActivateAgentVersionResponse type in types.ts uses 'version' field but server uses 'activeVersionId'.",
      "files": [
        "client-sdks/client-js/src/resources/stored-agent.ts",
        "client-sdks/client-js/src/types.ts",
        "client-sdks/client-js/src/resources/stored-agent.test.ts"
      ],
      "steps": [
        "Update ActivateAgentVersionResponse in types.ts to use activeVersionId instead of version",
        "Update activateVersion method in stored-agent.ts to return Promise<ActivateAgentVersionResponse>",
        "Ensure the request returns the parsed response object instead of void",
        "Update any callers if necessary"
      ],
      "acceptanceCriteria": [
        "activateVersion returns the server response with success, message, activeVersionId",
        "TypeScript types match server response schema",
        "Tests updated to verify return value"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["022"],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "028",
      "category": "bugfix",
      "priority": "P0",
      "title": "Add EXPERIMENTAL_FEATURES to deployer server",
      "description": "The PR adds MASTRA_EXPERIMENTAL_FEATURES handling to studio.ts and vite.config.ts but not to packages/deployer/src/server/index.ts, breaking the established pattern for environment variable replacements.",
      "files": [
        "packages/deployer/src/server/index.ts",
        "packages/playground-ui/src/domains/agents/hooks/use-agent-versions.ts"
      ],
      "steps": [
        "Add EXPERIMENTAL_FEATURES replacement to deployer server HTML processing",
        "Follow same pattern as MASTRA_CLOUD_API_ENDPOINT and MASTRA_HIDE_CLOUD_CTA",
        "Sanitize the value to 'true' or 'false' before injection",
        "Fix TypeScript error in use-agent-versions.ts (activateVersion return type)"
      ],
      "acceptanceCriteria": [
        "%%MASTRA_EXPERIMENTAL_FEATURES%% placeholder is replaced in production deployments",
        "Pattern matches other environment variable replacements in the file",
        "pnpm build passes without errors",
        "pnpm typecheck passes without errors"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "smthomas-review"
    },
    {
      "id": "029",
      "category": "bugfix",
      "priority": "P1",
      "title": "Fix multi-select-picker checkbox double-toggle bug",
      "description": "The row onClick and Checkbox onCheckedChange both fire when clicking the checkbox, potentially toggling twice and leaving selection unchanged.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/create-agent/multi-select-picker.tsx"
      ],
      "steps": [
        "Identify the row onClick handler and Checkbox onCheckedChange",
        "Either remove the Checkbox onCheckedChange and let row handle selection",
        "Or add event.stopPropagation() on Checkbox click to prevent row onClick from firing"
      ],
      "acceptanceCriteria": [
        "Clicking checkbox toggles selection exactly once",
        "Clicking row (outside checkbox) toggles selection exactly once",
        "No double-toggle behavior"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "030",
      "category": "bugfix",
      "priority": "P1",
      "title": "Fix listVersionsQuerySchema nested orderBy parsing",
      "description": "The listVersionsQuerySchema contains a nested orderBy object (versionOrderBySchema) which won't parse from HTTP query strings. Need to wrap with wrapSchemaForQueryParams.",
      "files": [
        "packages/server/src/server/schemas/agent-versions.ts"
      ],
      "steps": [
        "Import wrapSchemaForQueryParams from route-builder",
        "Wrap listVersionsQuerySchema with wrapSchemaForQueryParams",
        "Ensure nested orderBy parses correctly from requests"
      ],
      "acceptanceCriteria": [
        "orderBy parameter parses correctly from HTTP query strings",
        "API accepts nested orderBy as JSON in query params"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "031",
      "category": "refactor",
      "priority": "P1",
      "title": "Migrate useCallback to useEffectEvent in playground-ui",
      "description": "Multiple components use useCallback for simple event handlers. The playground-ui standards require using React 19's useEffectEvent instead.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/create-agent/instructions-enhancer.tsx",
        "packages/playground-ui/src/domains/agents/components/model-picker/provider-select.tsx",
        "packages/playground-ui/src/domains/agents/components/model-picker/model-select.tsx",
        "packages/playground-ui/src/domains/agents/components/create-agent/multi-select-picker.tsx"
      ],
      "steps": [
        "Replace useCallback with useEffectEvent for handleSelect, handleKeyDown, and similar handlers",
        "Update imports to include useEffectEvent from React",
        "Ensure handlers work correctly without dependency arrays"
      ],
      "acceptanceCriteria": [
        "No useCallback usage for event handlers in these components",
        "All event handlers use useEffectEvent pattern",
        "Functionality remains unchanged"
      ],
      "estimatedComplexity": "medium",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "smthomas-review"
    },
    {
      "id": "032",
      "category": "refactor",
      "priority": "P2",
      "title": "Export AgentVersionsListProps interface",
      "description": "Per coding guidelines, prop types should be exported separately from components for reuse.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/agent-versions/agent-versions-list.tsx"
      ],
      "steps": [
        "Add export keyword to AgentVersionsListProps interface declaration"
      ],
      "acceptanceCriteria": [
        "AgentVersionsListProps interface is exported",
        "Component still references the interface correctly"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "033",
      "category": "accessibility",
      "priority": "P2",
      "title": "Fix stored agent indicator accessibility",
      "description": "The stored agent tooltip trigger uses a non-focusable span and non-token class. Needs focusable button and design token for color.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/agent-table/columns.tsx"
      ],
      "steps": [
        "Replace span with button inside TooltipTrigger",
        "Add aria-label for accessibility",
        "Replace text-muted-foreground with design token class (e.g., text-icon3)"
      ],
      "acceptanceCriteria": [
        "Tooltip trigger is keyboard accessible (focusable button)",
        "Screen readers can access the tooltip content via aria-label",
        "Design token class used instead of text-muted-foreground"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "034",
      "category": "refactor",
      "priority": "P2",
      "title": "Replace arbitrary Tailwind values with design tokens",
      "description": "Multiple components use arbitrary Tailwind values (e.g., max-w-[120px], min-h-[32px], w-[var(...)], sm:max-w-[900px]) which violate playground-ui no-arbitrary-values rule.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/agent-versions/version-compare-dialog.tsx",
        "packages/playground-ui/src/domains/agents/components/create-agent/model-picker.tsx",
        "packages/playground-ui/src/domains/agents/components/create-agent/multi-select-picker.tsx",
        "packages/playground-ui/src/domains/agents/components/model-picker/model-select.tsx"
      ],
      "steps": [
        "Identify all arbitrary Tailwind values in the files",
        "Replace with design token classes or predefined utilities",
        "Add tokenized utilities if needed",
        "Replace text-gray-500 with appropriate token class"
      ],
      "acceptanceCriteria": [
        "No arbitrary bracketed Tailwind values remain",
        "All colors use design token classes",
        "Visual appearance unchanged"
      ],
      "estimatedComplexity": "medium",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "035",
      "category": "refactor",
      "priority": "P2",
      "title": "Clean up use-prompt-enhancer model parameter",
      "description": "The EnhancePromptParams interface declares model as 'Required when agentId is not provided' but the hook throws an error instead of using it. Either implement the functionality or remove the parameter.",
      "files": [
        "packages/playground-ui/src/domains/agents/hooks/use-prompt-enhancer.ts"
      ],
      "steps": [
        "Option A: Implement generic enhancement using the model parameter when agentId is undefined",
        "Option B: Remove model from EnhancePromptParams and update docs",
        "Update any callers accordingly"
      ],
      "acceptanceCriteria": [
        "API contract matches implementation",
        "No misleading documentation about model parameter"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "036",
      "category": "security",
      "priority": "P2",
      "title": "Sanitize EXPERIMENTAL_FEATURES before HTML injection",
      "description": "Directly interpolating the env value into HTML can break the page or allow unintended markup. Constrain to 'true' | 'false' before replacement.",
      "files": [
        "packages/cli/src/commands/studio/studio.ts"
      ],
      "steps": [
        "Create sanitized variable: const experimentalFeatures = process.env.EXPERIMENTAL_FEATURES === 'true' ? 'true' : 'false'",
        "Use sanitized variable in HTML replacement instead of raw env value"
      ],
      "acceptanceCriteria": [
        "Only 'true' or 'false' values are injected into HTML",
        "Invalid env values default to 'false'"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review"
    },
    {
      "id": "037",
      "category": "testing",
      "priority": "P1",
      "title": "Add changeset for PR",
      "description": "The PR is missing a changeset. Need to add one before merging.",
      "files": [
        ".changeset/every-beers-yawn.md"
      ],
      "steps": [
        "Create changeset file in .changeset directory",
        "Include @mastra/core, @mastra/server, @mastra/playground-ui, @mastra/client-js packages",
        "Use 'minor' version bump for new feature",
        "Write descriptive changelog entry"
      ],
      "acceptanceCriteria": [
        "Changeset file exists and is valid",
        "All affected packages are listed",
        "Changelog message describes the agent versioning feature"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "changeset-bot"
    },
    {
      "id": "038",
      "category": "bugfix",
      "priority": "P2",
      "title": "Fix deleteVersion return type to expose server response",
      "description": "The deleteVersion method in client SDK returns Promise<void> but server returns { success: boolean, message: string }. The DeleteAgentVersionResponse type already exists but isn't used.",
      "files": [
        "client-sdks/client-js/src/resources/stored-agent.ts",
        "client-sdks/client-js/src/resources/stored-agent.test.ts",
        "packages/playground-ui/src/domains/agents/hooks/use-agent-versions.ts"
      ],
      "steps": [
        "Import DeleteAgentVersionResponse from types.ts in stored-agent.ts",
        "Change deleteVersion return type from Promise<void> to Promise<DeleteAgentVersionResponse>",
        "Update the method to return the parsed response",
        "Update tests to verify the return value",
        "Update playground-ui hook to use DeleteAgentVersionResponse type"
      ],
      "acceptanceCriteria": [
        "deleteVersion returns { success: boolean, message: string }",
        "TypeScript types match server response",
        "Tests verify return value",
        "Playground UI hook uses correct type"
      ],
      "estimatedComplexity": "small",
      "dependencies": ["022"],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "039",
      "category": "refactor",
      "priority": "P2",
      "title": "Add hasMore field to ListAgentVersionsResponse",
      "description": "For consistency with other paginated responses (e.g., ListStoredAgentsResponse line 632), ListAgentVersionsResponse should include hasMore: boolean.",
      "files": [
        "client-sdks/client-js/src/types.ts",
        "packages/server/src/server/handlers/agent-versions.ts",
        "packages/server/src/server/schemas/agent-versions.ts"
      ],
      "steps": [
        "Add hasMore: boolean to ListAgentVersionsResponse interface in types.ts",
        "Update listVersionsResponseSchema in agent-versions.ts schema to include hasMore",
        "Update LIST_AGENT_VERSIONS_ROUTE handler to return hasMore: page * perPage + versions.length < total"
      ],
      "acceptanceCriteria": [
        "ListAgentVersionsResponse includes hasMore field",
        "Server handler calculates and returns hasMore",
        "Pagination consistency with other list responses"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "040",
      "category": "security",
      "priority": "P1",
      "title": "Sanitize EXPERIMENTAL_FEATURES in deployer server",
      "description": "Line 341 in deployer server uses '|| false' but doesn't sanitize like studio.ts does. Should use same pattern: === 'true' ? 'true' : 'false' to prevent arbitrary string injection.",
      "files": [
        "packages/deployer/src/server/index.ts"
      ],
      "steps": [
        "Update line 341 to use the same sanitization pattern as studio.ts",
        "Change from: process.env.EXPERIMENTAL_FEATURES || 'false'",
        "To: process.env.EXPERIMENTAL_FEATURES === 'true' ? 'true' : 'false'"
      ],
      "acceptanceCriteria": [
        "Only 'true' or 'false' values are injected into HTML",
        "Invalid env values default to 'false'",
        "Pattern matches studio.ts implementation"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "041",
      "category": "security",
      "priority": "P1",
      "title": "Fix window.open tab-nabbing vulnerability in provider-select",
      "description": "Lines 156 and 219 in provider-select.tsx call window.open without 'noopener,noreferrer' which enables tab-nabbing attacks where the opened page can redirect the opener.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/model-picker/provider-select.tsx"
      ],
      "steps": [
        "Update window.open call on line 156 to add 'noopener,noreferrer' as third argument",
        "Update window.open call on line 219 to add 'noopener,noreferrer' as third argument"
      ],
      "acceptanceCriteria": [
        "Both window.open calls include 'noopener,noreferrer' feature",
        "Tab-nabbing vulnerability is mitigated"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "042",
      "category": "refactor",
      "priority": "P2",
      "title": "Fix remaining arbitrary Tailwind values in instructions-enhancer",
      "description": "Task 034 missed some arbitrary Tailwind values in instructions-enhancer.tsx: line 117 has w-[280px] and line 134 has max-h-[250px].",
      "files": [
        "packages/playground-ui/src/domains/agents/components/create-agent/instructions-enhancer.tsx",
        "packages/playground-ui/src/ds/tokens/sizes.ts"
      ],
      "steps": [
        "Add popover-w-md: '280px' to sizes.ts if not exists",
        "Add scroll-h-md: '250px' to sizes.ts if not exists",
        "Replace w-[280px] with w-popover-w-md in line 117",
        "Replace max-h-[250px] with max-h-scroll-h-md in line 134"
      ],
      "acceptanceCriteria": [
        "No arbitrary bracketed Tailwind values remain in the file",
        "Design tokens used for sizing",
        "Visual appearance unchanged"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "pending",
      "passing": false,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "043",
      "category": "refactor",
      "priority": "P2",
      "title": "Fix remaining arbitrary Tailwind values in provider-select",
      "description": "Line 184 has w-[var(--radix-popover-trigger-width)] and max-h-[300px] which are arbitrary Tailwind values.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/model-picker/provider-select.tsx",
        "packages/playground-ui/src/ds/tokens/sizes.ts"
      ],
      "steps": [
        "For w-[var(--radix-popover-trigger-width)], use inline style to access CSS variable",
        "Add popover-max-h: '300px' to sizes.ts if not exists",
        "Replace max-h-[300px] with max-h-popover-max-h or use inline style"
      ],
      "acceptanceCriteria": [
        "No arbitrary bracketed Tailwind values remain",
        "CSS variables accessed via inline style where needed",
        "Visual appearance unchanged"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "pending",
      "passing": false,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "044",
      "category": "refactor",
      "priority": "P2",
      "title": "Extract perPage constant in agent-versions-list",
      "description": "The magic number 10 is used in two places (line 73 and calculation on line 79). Should be extracted to a constant to avoid divergence.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/agent-versions/agent-versions-list.tsx"
      ],
      "steps": [
        "Add const PER_PAGE = 10; at the top of the component or module",
        "Replace perPage: 10 with perPage: PER_PAGE",
        "Replace Math.ceil(total / 10) with Math.ceil(total / PER_PAGE)"
      ],
      "acceptanceCriteria": [
        "Magic number extracted to named constant",
        "Constant used in both places",
        "No functional change"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "pending",
      "passing": false,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "045",
      "category": "bugfix",
      "priority": "P2",
      "title": "Fix pagination disabled state inconsistency in agent-versions-list",
      "description": "Pagination buttons are disabled during isDeleting but not during isActivating. Both mutations affect the list data, so should disable during either operation.",
      "files": [
        "packages/playground-ui/src/domains/agents/components/agent-versions/agent-versions-list.tsx"
      ],
      "steps": [
        "Add const isMutating = isDeleting || isActivating;",
        "Replace disabled={page === 0 || isDeleting} with disabled={page === 0 || isMutating}",
        "Replace disabled={page >= totalPages - 1 || isDeleting} with disabled={page >= totalPages - 1 || isMutating}"
      ],
      "acceptanceCriteria": [
        "Pagination disabled during both delete and activate operations",
        "Consistent behavior for both mutations"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "pending",
      "passing": false,
      "source": "coderabbit-review-round2"
    },
    {
      "id": "046",
      "category": "refactor",
      "priority": "P2",
      "title": "Fix Map modification during iteration in inmemory storage",
      "description": "In deleteVersionsByAgentId (lines 279-287), deleting entries from a Map while iterating can cause unexpected behavior in some JS environments. Should collect IDs first, then delete.",
      "files": [
        "packages/core/src/storage/domains/agents/inmemory.ts"
      ],
      "steps": [
        "Create array const idsToDelete: string[] = [];",
        "In the for loop, push IDs to array instead of deleting immediately",
        "After the loop, iterate idsToDelete and delete each"
      ],
      "acceptanceCriteria": [
        "No Map modification during iteration",
        "Collect IDs first, then delete in separate loop",
        "Functionality unchanged"
      ],
      "estimatedComplexity": "small",
      "dependencies": [],
      "status": "completed",
      "passing": true,
      "source": "coderabbit-review-round2"
    }
  ]
}
