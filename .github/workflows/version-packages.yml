name: Version Packages

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches:
      - main
      - 0.x

jobs:
  version:
    # Only run on the main repository, not on forks
    if: ${{ github.repository == 'mastra-ai/mastra' }}
    runs-on: ubuntu-latest
    steps:
      - name: Initial checkout
        uses: actions/checkout@v5
        with:
          # Use default GITHUB_TOKEN for initial checkout
          # This is needed to access the .github/actions/app-auth action
          fetch-depth: 1
          persist-credentials: false

      - name: Dane App Auth
        id: app-auth
        uses: ./.github/actions/app-auth
        with:
          app-id: ${{ vars.DANE_APP_ID }}
          private-key: ${{ secrets.DANE_APP_PRIVATE_KEY }}

      - name: Re-checkout with app token
        uses: actions/checkout@v5
        with:
          token: ${{ steps.app-auth.outputs.token }}
          # Fetch entire git history so Changesets can generate changelogs
          # with the correct commits
          fetch-depth: 0
          persist-credentials: true

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Determine prerelease tag
        id: determine-tag
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "0.x" ]]; then
            echo "tag=alpha" >> $GITHUB_OUTPUT
          else
            echo "tag=alpha" >> $GITHUB_OUTPUT
          fi

      - name: Bump mcp-docs-server prerelease version
        env:
          GITHUB_TOKEN: ${{ steps.app-auth.outputs.token }}
          # husky precommit runs linting and typechecking - those are handled by other GH actions already
          HUSKY: 0
        run: |
          cd packages/mcp-docs-server
          pnpm version prerelease --preid ${{ steps.determine-tag.outputs.tag }} --no-git-tag-version
          cd ../..
          git add packages/mcp-docs-server/package.json
          git commit -m "chore: bump @mastra/mcp-docs-server prerelease version"

      - name: Create Release Pull Request
        uses: changesets/action@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-auth.outputs.token }}
          # husky precommit runs linting and typechecking - those are handled by other GH actions already
          HUSKY: 0
        with:
          title: 'chore: version packages'
          commit: 'chore: version packages'
          version: pnpm changeset-cli version
