name: Vitest Changed Tests

on:
  workflow_run:
    workflows: ['Prebuild']
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

# Explicitly restrict all permissions at workflow level
permissions: {}

jobs:
  test:
    name: Test (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'mastra-ai/mastra' && github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_CACHE: remote:r
    # Minimal permissions - read-only access
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Checkout trusted actions from base branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch == '0.x' && '0.x' || 'main' }}
          sparse-checkout: .github/actions
          path: trusted-actions

      # Copy trusted actions into the workspace
      - name: Use trusted actions
        run: |
          rm -rf .github/actions
          cp -r trusted-actions/.github/actions .github/actions

      - name: Get PR base branch
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find PR associated with this head SHA
          PR_DATA=$(gh api repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/pulls --jq '.[0]')
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref // "main"')
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Build packages
        run: pnpm turbo build --filter "!./examples/**/*" --filter "!./docs/" --filter "!./explorations/**/*"
        env:
          NODE_OPTIONS: '--max_old_space_size=6144'

      - name: Run changed tests (Shard ${{ matrix.shard }}/4)
        run: |
          pnpm vitest run \
            --project 'unit:*' --project 'typecheck:*' \
            --changed origin/${{ steps.pr-info.outputs.base_ref }} \
            --reporter=blob \
            --outputFile.blob=.vitest-reports/blob-${{ matrix.shard }}.json \
            --shard=${{ matrix.shard }}/4 \
            --passWithNoTests
        env:
          NODE_OPTIONS: '--max_old_space_size=6144'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-blob-${{ matrix.shard }}
          path: .vitest-reports/
          include-hidden-files: true
          retention-days: 1

  merge-reports:
    name: Merge Test Reports
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.event.workflow_run.conclusion == 'success'
    # Minimal permissions - read-only access
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Checkout trusted actions from base branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch == '0.x' && '0.x' || 'main' }}
          sparse-checkout: .github/actions
          path: trusted-actions

      # Copy trusted actions into the workspace
      - name: Use trusted actions
        run: |
          rm -rf .github/actions
          cp -r trusted-actions/.github/actions .github/actions

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: vitest-blob-*
          path: .vitest-reports
          merge-multiple: true

      - name: Merge reports
        run: pnpm vitest --merge-reports --reporter=default --reporter=github-actions --passWithNoTests
