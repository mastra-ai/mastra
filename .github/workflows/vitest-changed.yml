name: Vitest Changed Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, 0.x]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'mastra-ai/mastra' }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_CACHE: remote:r
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Build packages
        run: pnpm turbo build --filter "!./examples/**/*" --filter "!./docs/" --filter "!./explorations/**/*"
        env:
          NODE_OPTIONS: '--max_old_space_size=6144'

      - name: Run changed tests (Shard ${{ matrix.shard }}/4)
        run: |
          pnpm vitest run \
            --changed origin/${{ github.base_ref }} \
            --reporter=blob \
            --shard=${{ matrix.shard }}/4
        env:
          NODE_OPTIONS: '--max_old_space_size=6144'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-blob-${{ matrix.shard }}
          path: .vitest-reports/
          include-hidden-files: true
          retention-days: 1

  merge-reports:
    name: Merge Test Reports
    runs-on: ubuntu-latest
    needs: test
    if: always()
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: vitest-blob-*
          path: .vitest-reports
          merge-multiple: true

      - name: Merge reports
        run: pnpm vitest --merge-reports --reporter=default --reporter=github-actions
