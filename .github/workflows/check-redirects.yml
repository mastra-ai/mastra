name: Check Redirects

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
  deployment_status:

jobs:
  check-deleted-pages:
    name: Check for deleted pages without redirects
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for MDX changes
        id: mdx-changes
        run: |
          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q '\.mdx$'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.mdx-changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.mdx-changes.outputs.has_changes == 'true'
        run: npm install path-to-regexp

      - name: Check for removed pages without redirects
        if: steps.mdx-changes.outputs.has_changes == 'true'
        run: |
          node .github/scripts/check-deleted-pages.js
        env:
          BASE_REF: origin/${{ github.event.pull_request.base.ref }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}

      - name: Comment on PR if redirects are missing
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const missing = JSON.parse(fs.readFileSync('/tmp/missing-redirects.json', 'utf8'));
            const body = `## ðŸš¨ Missing Redirects Detected\n\nThe following pages were removed but don't have redirects in \`vercel.json\`:\n\n${missing.map(path => `- \`${path}\``).join('\n')}\n\nPlease add redirects for these pages to prevent 404 errors.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  check-duplicate-redirects:
    name: Check for duplicate redirects
    if: ${{ github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'Preview â€“ mastra-docs' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20.19.5'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: Install dependencies for docs
        run: npm ci
        working-directory: docs

      - name: Set deployment URL as env var
        run: echo "MASTRA_DEPLOYMENT_URL=${{ github.event.deployment_status.target_url }}" >> $GITHUB_ENV

      - name: Run check-duplicate-redirects
        run: node .github/scripts/check-duplicate-redirects.js
