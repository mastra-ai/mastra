name: Publish to npm

permissions:
  contents: write
  pull-requests: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      publish_type:
        description: Type of publish
        required: true
        type: choice
        options: [prerelease, stable, snapshot]
        default: prerelease
      tag:
        description: npm tag (snapshot only)
        required: false
        type: string
      dry_run:
        description: Dry run (no actual publish)
        required: false
        type: boolean
        default: false
  push:
    branches: [main]

concurrency: ${{ github.workflow }}-${{ github.ref }}

env:
  NODE_VERSION: '24'
  NPM_REGISTRY: 'https://registry.npmjs.org'

# =====================================================
# PRERELEASE
# =====================================================
jobs:
  prerelease:
    if: |
      github.repository == 'mastra-ai/mastra' &&
      (
        (github.event_name == 'push' &&
         startsWith(github.event.head_commit.message, 'chore: version packages') &&
         github.event.head_commit.author.username == 'dane-ai-mastra[bot]') ||
        (github.event_name == 'workflow_dispatch' &&
         github.event.inputs.publish_type == 'prerelease')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}

      - run: npm install -g npm@latest

      - run: pnpm build

      - id: tag
        run: echo "tag=alpha" >> "$GITHUB_OUTPUT"

      - run: pnpm publish -r --tag ${{ steps.tag.outputs.tag }} --access public --no-git-checks
        env:
          NPM_CONFIG_PROVENANCE: true

  # =====================================================
  # STABLE
  # =====================================================
  stable:
    if: |
      github.repository == 'mastra-ai/mastra' &&
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.publish_type == 'stable'
    runs-on: ubuntu-latest
    outputs:
      exited_prerelease: ${{ steps.exit.outputs.executed }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
          persist-credentials: false

      - id: auth
        uses: ./.github/actions/app-auth
        with:
          app-id: ${{ vars.DANE_APP_ID }}
          private-key: ${{ secrets.DANE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v5
        with:
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
          persist-credentials: true

      - id: precheck
        uses: andstor/file-existence-action@v3
        with:
          files: .changeset/pre.json

      - uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}

      - run: npm install -g npm@latest
      - run: pnpm build

      - id: exit
        if: steps.precheck.outputs.files_exists == 'true'
        env:
          GITHUB_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          pnpm changeset-cli pre exit
          pnpm changeset-cli version
          git pull
          git add -A
          git commit -m 'chore: version - exit prerelease mode' --no-verify
          git push
          echo "executed=true" >> "$GITHUB_OUTPUT"
          pnpm install
          pnpm build

      - if: ${{ !inputs.dry_run }}
        env:
          GITHUB_TOKEN: ${{ steps.auth.outputs.token }}
        run: pnpm publish -r --access public --no-git-checks

      - if: ${{ inputs.dry_run }}
        run: pnpm publish -r --dry-run --access public --no-git-checks

      - run: |
          pnpm changeset-cli tag
          git push --follow-tags
        if: ${{ !inputs.dry_run }}

  # =====================================================
  # ENTER PRERELEASE AFTER STABLE
  # =====================================================
  enter_prerelease:
    needs: stable
    if: |
      github.repository == 'mastra-ai/mastra' &&
      needs.stable.outputs.exited_prerelease == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
          persist-credentials: false

      - id: auth
        uses: ./.github/actions/app-auth
        with:
          app-id: ${{ vars.DANE_APP_ID }}
          private-key: ${{ secrets.DANE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v5
        with:
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
          persist-credentials: true

      - uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}

      - run: |
          git pull
          pnpm changeset-cli pre enter alpha
          git add -A
          git commit -m 'chore: version - enter prerelease mode' --no-verify
          git push --follow-tags
        if: ${{ !inputs.dry_run }}

  # =====================================================
  # SNAPSHOT
  # =====================================================
  snapshot:
    if: |
      github.repository == 'mastra-ai/mastra' &&
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.publish_type == 'snapshot' &&
      github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_CACHE: remote:r
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
          persist-credentials: false

      - id: auth
        uses: ./.github/actions/app-auth
        with:
          app-id: ${{ vars.DANE_APP_ID }}
          private-key: ${{ secrets.DANE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v5
        with:
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
          persist-credentials: true

      - uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}

      - run: npm install -g npm@latest

      - id: tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "FINAL_TAG=${TAG:-$(echo "$GITHUB_REF_NAME" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g')}" >> "$GITHUB_ENV"

      - run: pnpm turbo --filter "!./examples/**/*" --filter "!./docs/" build

      - run: pnpm changeset-cli pre exit
      - run: pnpm changeset-cli version --snapshot ${{ env.FINAL_TAG }}

      - run: pnpm publish -r --tag ${{ env.FINAL_TAG }} --access public --no-git-checks
        env:
          NPM_CONFIG_PROVENANCE: true
