name: RAG Tests

on:
  workflow_run:
    workflows: ['Quality assurance']
    types:
      - completed

jobs:
  check-changes:
    if: ${{ github.repository == 'mastra-ai/mastra' }}
    runs-on: ubuntu-latest
    outputs:
      rag-changed: ${{ steps.changes.outputs.rag }}
    permissions:
      contents: read
      statuses: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set pending status
        uses: ./.github/workflows/shared-actions/set-pr-status
        with:
          status: 'pending'
          context: 'RAG Tests'
          description: 'Checking for changes'
          sha: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Disable turbo telemetry
        run: pnpm turbo telemetry disable

      - name: Check for RAG package changes using Turborepo
        id: changes
        run: |
          set -e
          set -o pipefail

          # Get task hash for @mastra/rag tasks
          # Uses turbo's dry-run to get the computed hash based on task inputs
          get_task_hash() {
            local task=$1
            pnpm turbo "$task" --filter='@mastra/rag' --dry-run=json 2>/dev/null | \
              jq -r ".tasks[] | select(.package == \"@mastra/rag\" and .task == \"$task\") | .hash"
          }

          # Save current ref to return to later
          CURRENT_REF=$(git rev-parse HEAD)

          # Get current HEAD hashes
          echo "Getting task hashes for HEAD..."
          HEAD_BUILD_HASH=$(get_task_hash "build:lib")
          HEAD_TEST_HASH=$(get_task_hash "test")

          echo "HEAD build:lib hash: $HEAD_BUILD_HASH"
          echo "HEAD test hash: $HEAD_TEST_HASH"

          # Get main branch hashes
          echo "Getting task hashes for origin/main..."
          git checkout origin/main --quiet
          MAIN_BUILD_HASH=$(get_task_hash "build:lib")
          MAIN_TEST_HASH=$(get_task_hash "test")

          echo "Main build:lib hash: $MAIN_BUILD_HASH"
          echo "Main test hash: $MAIN_TEST_HASH"

          # Return to original ref
          git checkout "$CURRENT_REF" --quiet

          # Compare hashes - if they differ, the task inputs changed
          BUILD_CHANGED=false
          TEST_CHANGED=false

          if [ "$HEAD_BUILD_HASH" != "$MAIN_BUILD_HASH" ]; then
            echo "Build inputs changed (hash mismatch)"
            BUILD_CHANGED=true
          else
            echo "Build inputs unchanged (hash match)"
          fi

          if [ "$HEAD_TEST_HASH" != "$MAIN_TEST_HASH" ]; then
            echo "Test inputs changed (hash mismatch)"
            TEST_CHANGED=true
          else
            echo "Test inputs unchanged (hash match)"
          fi

          # Run tests if either build or test inputs changed
          if [ "$BUILD_CHANGED" = true ] || [ "$TEST_CHANGED" = true ]; then
            echo "rag=true" >> $GITHUB_OUTPUT
          else
            echo "rag=false" >> $GITHUB_OUTPUT
          fi

  skip-tests:
    needs: check-changes
    if: needs.check-changes.outputs.rag-changed == 'false'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
    steps:
      - uses: actions/checkout@v5
      - name: Set success status for unchanged RAG
        uses: ./.github/workflows/shared-actions/set-pr-status
        with:
          status: 'success'
          context: 'RAG Tests'
          description: 'RAG package unchanged - skipping tests'
          sha: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  test:
    needs: check-changes
    if: needs.check-changes.outputs.rag-changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_CACHE: remote:r
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Build RAG dependencies
        run: pnpm turbo build --filter="@mastra/rag^..."

      - name: Run RAG tests
        run: pnpm test:rag
        env:
          NODE_OPTIONS: '--max_old_space_size=8096'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}

  report-status:
    needs: [check-changes, test]
    if: ${{ always() && needs.check-changes.outputs.rag-changed == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      statuses: write
    steps:
      - uses: actions/checkout@v5
      - name: Set test status
        uses: ./.github/workflows/shared-actions/set-pr-status
        with:
          status: ${{ needs.test.result == 'success' && 'success' || 'failure' }}
          context: 'RAG Tests'
          description: ${{ needs.test.result == 'success' && 'All RAG tests passed' || 'RAG tests failed' }}
          sha: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
