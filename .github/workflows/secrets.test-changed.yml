name: Tests (Changed Packages)

on:
  workflow_run:
    workflows: ['Quality assurance']
    types:
      - completed

jobs:
  test:
    if: ${{ github.repository == 'mastra-ai/mastra' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: write
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_CACHE: remote:rw
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set pending status
        uses: ./.github/workflows/shared-actions/set-pr-status
        with:
          status: 'pending'
          context: 'Unit Tests'
          description: 'Running tests for changed packages'
          sha: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node

      - name: Install dependencies
        run: pnpm install

      - name: Get PR base ref
        id: get-base
        run: |
          # Get base ref from the PR that triggered the workflow
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          if [ -n "$PR_NUMBER" ]; then
            BASE_REF=$(gh pr view $PR_NUMBER --json baseRefName -q '.baseRefName')
          else
            BASE_REF="main"
          fi
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for affected packages
        id: affected
        run: |
          AFFECTED=$(pnpm turbo run test --filter='...[origin/${{ steps.get-base.outputs.base_ref }}]' --dry-run=json | jq -r '.packages | join(", ")')
          echo "packages=$AFFECTED" >> $GITHUB_OUTPUT
          if [ -z "$AFFECTED" ] || [ "$AFFECTED" = "" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no changes
        if: steps.affected.outputs.has_changes == 'false'
        uses: ./.github/workflows/shared-actions/set-pr-status
        with:
          status: 'success'
          context: 'Package Tests'
          description: 'No testable packages changed - skipping'
          sha: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Run tests for changed packages
        if: steps.affected.outputs.has_changes == 'true'
        run: pnpm turbo run test --filter='...[origin/${{ steps.get-base.outputs.base_ref }}] -- --changed origin/${{ steps.get-base.outputs.base_ref }}'
        env:
          NODE_OPTIONS: '--max_old_space_size=8096'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Set success status
        if: success() && steps.affected.outputs.has_changes == 'true'
        uses: ./.github/workflows/shared-actions/set-pr-status
        with:
          status: 'success'
          context: 'Package Tests'
          description: 'Tests passed for: ${{ steps.affected.outputs.packages }}'
          sha: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Set failure status
        if: failure()
        uses: ./.github/workflows/shared-actions/set-pr-status
        with:
          status: 'failure'
          context: 'Package Tests'
          description: 'Tests failed'
          sha: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
