services:
  fake-gcs:
    image: fsouza/fake-gcs-server:latest
    ports:
      - '4443:4443'
    command: -scheme http -port 4443 -backend memory -public-host localhost:4443
    healthcheck:
      test: ['CMD', 'wget', '-q', '-O', '-', 'http://localhost:4443/storage/v1/b']
      interval: 5s
      timeout: 5s
      retries: 5

  # Create test bucket on fake-gcs startup
  fake-gcs-setup:
    image: curlimages/curl:latest
    depends_on:
      fake-gcs:
        condition: service_healthy
    command: >
      -X POST
      http://fake-gcs:4443/storage/v1/b?project=test-project
      -H "Content-Type: application/json"
      -d '{"name": "test-bucket"}'
