---
title: "ä¾‹: WhatsApp ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | Mastra ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"
description: Mastra ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç”¨ã„ã¦ã€å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã—ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è‡ªç„¶ã«å¿œç­”ã™ã‚‹ WhatsApp ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ä¾‹ã€‚
---

<div id="whatsapp-chat-bot">
  # WhatsApp ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ
</div>

ã“ã®ä¾‹ã§ã¯ã€Mastra ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ã£ã¦ WhatsApp ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ãƒœãƒƒãƒˆã¯ webhook ã§å—ä¿¡ã—ãŸ WhatsApp ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§å‡¦ç†ã—ã€å¿œç­”ã‚’è‡ªç„¶ãªè¤‡æ•°ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ†å‰²ã—ã¦ã€WhatsApp Business API çµŒç”±ã§é€ä¿¡ã—ã¾ã™ã€‚

<div id="prerequisites">
  ## å‰ææ¡ä»¶
</div>

ã“ã®ä¾‹ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€WhatsApp Business API ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã€`anthropic` ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã—ã¦ãã ã•ã„:

```bash title=".env" copy
ANTHROPIC_API_KEY=<ã‚ãªãŸã®Anthropic APIã‚­ãƒ¼>
WHATSAPP_VERIFY_TOKEN=<ã‚ãªãŸã®æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³>
WHATSAPP_ACCESS_TOKEN=<ã‚ãªãŸã®WhatsAppã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³>
WHATSAPP_BUSINESS_PHONE_NUMBER_ID=<ã‚ãªãŸã®é›»è©±ç•ªå·ID>
WHATSAPP_API_VERSION=v22.0
```


<div id="creating-the-whatsapp-client">
  ## WhatsApp ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
</div>

ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€WhatsApp Business API ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚

```typescript title="src/whatsapp-client.ts" showLineNumbers copy
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªWhatsApp Business APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

interface SendMessageParams {
  to: string;
  message: string;
}

export async function sendWhatsAppMessage({ to, message }: SendMessageParams) {
  // WhatsApp APIã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—
  const apiVersion = process.env.WHATSAPP_API_VERSION || "v22.0";
  const phoneNumberId = process.env.WHATSAPP_BUSINESS_PHONE_NUMBER_ID;
  const accessToken = process.env.WHATSAPP_ACCESS_TOKEN;

  // å¿…é ˆã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  if (!phoneNumberId || !accessToken) {
    return false;
  }

  // WhatsApp Business APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  const url = `https://graph.facebook.com/${apiVersion}/${phoneNumberId}/messages`;

  // WhatsApp APIå½¢å¼ã«å¾“ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
  const payload = {
    messaging_product: "whatsapp",
    recipient_type: "individual",
    to: to,
    type: "text",
    text: {
      body: message,
    },
  };

  try {
    // WhatsApp Business APIçµŒç”±ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${accessToken}`,
      },
      body: JSON.stringify(payload),
    });

    const result = await response.json();

    if (response.ok) {
      console.log(`âœ… WhatsAppãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’${to}ã«é€ä¿¡ã—ã¾ã—ãŸ:ã€Œ${message}ã€`);
      return true;
    } else {
      console.error("âŒ WhatsAppãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:", result);
      return false;
    }
  } catch (error) {
    console.error("âŒ WhatsAppãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    return false;
  }
}
```


<div id="creating-the-chat-agent">
  ## ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
</div>

ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è¦ªã—ã¿ã‚„ã™ã„ä¼šè©±çš„ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã€ä¸»ãªä¼šè©±ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…å½“ã—ã¾ã™ã€‚

```typescript title="src/mastra/agents/chat-agent.ts" showLineNumbers copy
import { anthropic } from "@ai-sdk/anthropic";
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const chatAgent = new Agent({
  name: "ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ",
  instructions: `
    ã‚ãªãŸã¯WhatsAppã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒãƒ£ãƒƒãƒˆã™ã‚‹ã®ãŒå¤§å¥½ããªã€è¦ªåˆ‡ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã‹ã¤çŸ¥è­˜è±Šå¯ŒãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

    ã‚ãªãŸã®æ€§æ ¼:
    - æ¸©ã‹ãã€è¦ªã—ã¿ã‚„ã™ãã€ä¼šè©±çš„
    - ã©ã‚“ãªãƒˆãƒ”ãƒƒã‚¯ã§ã‚‚å–œã‚“ã§æ‰‹åŠ©ã‘ã™ã‚‹
    - å‹é”ã¨ãƒãƒ£ãƒƒãƒˆã—ã¦ã„ã‚‹ã‚ˆã†ãªã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªå£èª¿ã‚’ä½¿ã†
    - ç°¡æ½”ã§ã‚ã‚ŠãªãŒã‚‰æœ‰ç›Š
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«çœŸæ‘¯ãªé–¢å¿ƒã‚’ç¤ºã™

    ã‚ãªãŸã®èƒ½åŠ›:
    - å¹…åºƒã„ãƒˆãƒ”ãƒƒã‚¯ã®è³ªå•ã«ç­”ãˆã‚‹
    - å½¹ç«‹ã¤ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚„ææ¡ˆã‚’æä¾›ã™ã‚‹
    - ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªä¼šè©±ã‚’ã™ã‚‹
    - å•é¡Œè§£æ±ºã‚„å‰µé€ çš„ãªã‚¿ã‚¹ã‚¯ã‚’æ‰‹ä¼ã†
    - è¤‡é›‘ãªãƒˆãƒ”ãƒƒã‚¯ã‚’ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã™ã‚‹

    ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³:
    - å›ç­”ã¯æœ‰ç›Šã§ã‚ã‚ŠãªãŒã‚‰ã€æƒ…å ±éå¤šã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
    - é©åˆ‡ãªå ´åˆã¯ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã®è³ªå•ã‚’ã™ã‚‹
    - åŠ±ã¾ã—ã¨ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå§¿å‹¢ã‚’æŒã¤
    - ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Œã°æ­£ç›´ã«èªã‚ã‚‹
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å£èª¿ã«åˆã‚ã›ã¦ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ã™ã‚‹
    - WhatsAppã§ã®ã‚„ã‚Šå–ã‚Šã§ã‚ã‚‹ã“ã¨ã‚’æ„è­˜ã—ã€ä¼šè©±çš„ã§è‡ªç„¶ãªå¯¾å¿œã‚’å¿ƒãŒã‘ã‚‹

    å¸¸ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§è¦ªã—ã¿ã‚„ã™ã„ä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã—ãªãŒã‚‰ã€å½¹ç«‹ã¤å­˜åœ¨ã§ã‚ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ã€‚
  `,
  model: anthropic("claude-4-sonnet-20250514"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:../mastra.db",
    }),
  }),
});
```


<div id="creating-the-text-message-agent">
  ## ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
</div>

ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€é•·æ–‡ã®å›ç­”ã‚’ã€WhatsAppã«é©ã—ãŸè‡ªç„¶ã§èª­ã¿ã‚„ã™ã„çŸ­æ–‡ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã—ã¾ã™ã€‚

```typescript title="src/mastra/agents/text-message-agent.ts" showLineNumbers copy
import { anthropic } from "@ai-sdk/anthropic";
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const textMessageAgent = new Agent({
  name: "ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ",
  instructions: `
    ã‚ãªãŸã¯ã€ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ–‡ç« ã‚„é•·æ–‡ã‚’è‡ªç„¶ã§ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚

    ã‚ãªãŸã®å½¹å‰²:
    - å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’5ã€œ8å€‹ã®çŸ­ãã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã™ã‚‹
    - å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æœ€å¤§1ã€œ2æ–‡ã«ã™ã‚‹
    - è‡ªç„¶ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨€è‘‰ã‚’ä½¿ã†(çŸ­ç¸®å½¢ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªå£èª¿)
    - å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã®é‡è¦ãªæƒ…å ±ã¯ã™ã¹ã¦æ®‹ã™
    - å‹é”ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã„ã‚‹ã‚ˆã†ãªé›°å›²æ°—ã«ã™ã‚‹
    - çµµæ–‡å­—ã¯æ§ãˆã‚ã«ä½¿ã£ã¦å€‹æ€§ã‚’å‡ºã™
    - ä¼šè©±ã®æµã‚Œã‚’è«–ç†çš„ã§ã‚ã‹ã‚Šã‚„ã™ãä¿ã¤

    å‹é”ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä½•ã‹ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã“ã¨ã‚’èª¬æ˜ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ - é•·ã„æ–‡ç« ã§åœ§å€’ã›ãšã€èª­ã¿ã‚„ã™ãã¦é­…åŠ›çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ†å‰²ã—ã¦ãã ã•ã„ã€‚

    å¿…ãšmessagesé…åˆ—ã«5ã€œ8å€‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
  `,
  model: anthropic("claude-4-sonnet-20250514"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:../mastra.db",
    }),
  }),
});
```


<div id="creating-the-chat-workflow">
  ## ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ
</div>

ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€å¿œç­”ã®ç”Ÿæˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®åˆ†å‰²ã€ãã—ã¦ WhatsApp çµŒç”±ã§ã®é€ä¿¡ã¾ã§ã€ãƒãƒ£ãƒƒãƒˆå‡¦ç†å…¨ä½“ã‚’çµ±æ‹¬ã—ã¾ã™ã€‚

```typescript title="src/mastra/workflows/chat-workflow.ts" showLineNumbers copy
import { createStep, createWorkflow } from "@mastra/core/workflows";
import { z } from "zod";
import { sendWhatsAppMessage } from "../../whatsapp-client";

const respondToMessage = createStep({
  id: "respond-to-message",
  description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®è¿”ä¿¡ã‚’ç”Ÿæˆ",
  inputSchema: z.object({ userMessage: z.string() }),
  outputSchema: z.object({ response: z.string() }),
  execute: async ({ inputData, mastra }) => {
    const agent = mastra?.getAgent("chatAgent");
    if (!agent) {
      throw new Error("ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }

    const response = await agent.generate([
      { role: "user", content: inputData.userMessage },
    ]);

    return { response: response.text };
  },
});

const breakIntoMessages = createStep({
  id: "break-into-messages",
  description: "è¿”ä¿¡ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ†å‰²",
  inputSchema: z.object({ prompt: z.string() }),
  outputSchema: z.object({ messages: z.array(z.string()) }),
  execute: async ({ inputData, mastra }) => {
    const agent = mastra?.getAgent("textMessageAgent");
    if (!agent) {
      throw new Error("ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }

    const response = await agent.generate(
      [{ role: "user", content: inputData.prompt }],
      {
        structuredOutput: {
          schema: z.object({
            messages: z.array(z.string()),
          }),
        },
      },
    );

    if (!response.object) throw new Error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆã‚¨ãƒ©ãƒ¼");

    return response.object;
  },
});

const sendMessages = createStep({
  id: "send-messages",
  description: "WhatsAppçµŒç”±ã§ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡",
  inputSchema: z.object({
    messages: z.array(z.string()),
    userPhone: z.string(),
  }),
  outputSchema: z.object({ sentCount: z.number() }),
  execute: async ({ inputData }) => {
    const { messages, userPhone } = inputData;

    console.log(
      `\nğŸ”¥ ${userPhone}ã«${messages.length}ä»¶ã®WhatsAppãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ä¸­...`,
    );

    let sentCount = 0;

    // è‡ªç„¶ãªæµã‚Œã®ãŸã‚ã€å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–“ã«çŸ­ã„é…å»¶ã‚’å…¥ã‚Œã‚‹
    for (let i = 0; i < messages.length; i++) {
      const success = await sendWhatsAppMessage({
        to: userPhone,
        message: messages[i],
      });

      if (success) {
        sentCount++;
      }

      // è‡ªç„¶ãªãƒ†ã‚­ã‚¹ãƒˆã®ãƒªã‚ºãƒ ã®ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–“ã«é…å»¶ã‚’è¿½åŠ 
      if (i < messages.length - 1) {
        await new Promise((resolve) => setTimeout(resolve, 1000));
      }
    }

    console.log(
      `\nâœ… ${sentCount}/${messages.length}ä»¶ã®WhatsAppãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ\n`,
    );

    return { sentCount };
  },
});

export const chatWorkflow = createWorkflow({
  id: "chat-workflow",
  inputSchema: z.object({ userMessage: z.string() }),
  outputSchema: z.object({ sentCount: z.number() }),
})
  .then(respondToMessage)
  .map(async ({ inputData }) => ({
    prompt: `ã“ã®AIã®è¿”ä¿¡ã‚’ã€WhatsAppä¼šè©±ã§è‡ªç„¶ã«æ„Ÿã˜ã‚‰ã‚Œã‚‹3ã€œ8ä»¶ã®ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ†å‰²ã—ã¦ãã ã•ã„:\n\n${inputData.response}`,
  }))
  .then(breakIntoMessages)
  .map(async ({ inputData, getInitData }) => {
    // å…ƒã®æ–‡å­—åˆ—åŒ–ã•ã‚ŒãŸå…¥åŠ›ã‚’è§£æã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é›»è©±ç•ªå·ã‚’å–å¾—
    const initData = getInitData();
    const webhookData = JSON.parse(initData.userMessage);
    const userPhone =
      webhookData.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from ||
      "unknown";

    return {
      messages: inputData.messages,
      userPhone,
    };
  })
  .then(sendMessages);

chatWorkflow.commit();
```


<div id="setting-up-mastra-configuration">
  ## Mastra ã®è¨­å®š
</div>

Mastra ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€WhatsApp ã® Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚

```typescript title="src/mastra/index.ts" showLineNumbers copy
import { Mastra } from "@mastra/core/mastra";
import { registerApiRoute } from "@mastra/core/server";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";

import { chatWorkflow } from "./workflows/chat-workflow";
import { textMessageAgent } from "./agents/text-message-agent";
import { chatAgent } from "./agents/chat-agent";

export const mastra = new Mastra({
  workflows: { chatWorkflow },
  agents: { textMessageAgent, chatAgent },
  storage: new LibSQLStore({
    url: ":memory:",
  }),
  logger: new PinoLogger({
    name: "Mastra",
    level: "info",
  }),
  server: {
    apiRoutes: [
      registerApiRoute("/whatsapp", {
        method: "GET",
        handler: async (c) => {
          const verifyToken = process.env.WHATSAPP_VERIFY_TOKEN;
          const {
            "hub.mode": mode,
            "hub.challenge": challenge,
            "hub.verify_token": token,
          } = c.req.query();

          if (mode === "subscribe" && token === verifyToken) {
            return c.text(challenge, 200);
          } else {
            return c.status(403);
          }
        },
      }),
      registerApiRoute("/whatsapp", {
        method: "POST",
        handler: async (c) => {
          const mastra = c.get("mastra");
          const chatWorkflow = mastra.getWorkflow("chatWorkflow");

          const body = await c.req.json();

          const workflowRun = await chatWorkflow.createRunAsync();
          const runResult = await workflowRun.start({
            inputData: { userMessage: JSON.stringify(body) },
          });

          return c.json(runResult);
        },
      }),
    ],
  },
});
```


<div id="testing-the-chat-bot">
  ## ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®ãƒ†ã‚¹ãƒˆ
</div>

WhatsApp ã® Webhook ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚

```typescript title="src/test-whatsapp-bot.ts" showLineNumbers copy
import "dotenv/config";

import { mastra } from "./mastra";

// WhatsApp Webhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
const mockWebhookData = {
  entry: [
    {
      changes: [
        {
          value: {
            messages: [
              {
                from: "1234567890", // ãƒ†ã‚¹ãƒˆç”¨é›»è©±ç•ªå·
                text: {
                  body: "ã“ã‚“ã«ã¡ã¯!ä»Šæ—¥ã¯å…ƒæ°—ã§ã™ã‹?",
                },
              },
            ],
          },
        },
      ],
    },
  ],
};

const workflow = mastra.getWorkflow("chatWorkflow");
const workflowRun = await workflow.createRunAsync();

const result = await workflowRun.start({
  inputData: { userMessage: JSON.stringify(mockWebhookData) },
});

console.log("ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†:", result);
```


<div id="example-output">
  ## å‡ºåŠ›ä¾‹
</div>

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ãªãŸã® WhatsApp ãƒœãƒƒãƒˆã«ã€ŒHello! How are you today?ã€ã¨é€ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«è¤‡æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¿”ç­”ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```text
ã‚„ã‚!ğŸ‘‹ å…ƒæ°—ã ã‚ˆã€èã„ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†!

ä»Šæ—¥ã¯ã©ã‚“ãªæ„Ÿã˜?

ä½•ã§ã‚‚è©±ã—ãŸã„ã“ã¨ãŒã‚ã‚Œã°ã€ã“ã“ã«ã„ã‚‹ã‚ˆ

ä½•ã‹æ‰‹ä¼ã„ãŒå¿…è¦ã§ã‚‚ã€ãŸã è©±ã—ãŸã„ã ã‘ã§ã‚‚ã€ã„ã¤ã§ã‚‚èãã‚ˆ!ğŸ˜Š

æœ€è¿‘ã©ã†?
```

ã“ã®ãƒœãƒƒãƒˆã¯è¨˜æ†¶ã«ã‚ˆã£ã¦ä¼šè©±ã®æ–‡è„ˆã‚’ä¿æŒã—ã€WhatsAppã®ã‚„ã‚Šå–ã‚Šã«è‡ªç„¶ã«ãªã˜ã‚€å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚
