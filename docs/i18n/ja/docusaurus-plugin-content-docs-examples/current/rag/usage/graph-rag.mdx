---
title: "例: Graph RAG | RAG | Mastra ドキュメント"
description: OpenAI の埋め込みと PGVector を用いて、Mastra で Graph RAG システムを実装する例。
---

import GithubLink from "@site/src/components/GithubLink";


<div id="graph-rag">
  # Graph RAG
</div>

この例では、Mastra、OpenAI の埋め込み、そしてベクトル格納に PGVector を用いて、Retrieval-Augmented Generation（RAG）システムを実装する方法を示します。

<div id="overview">
  ## 概要
</div>

このシステムは、Mastra と OpenAI を用いて Graph RAG を実装しています。主な処理は次のとおりです：

1. 応答生成のために gpt-4o-mini を用いた Mastra エージェントをセットアップ
2. ベクトルストアとのやり取りとナレッジグラフの作成・走査を管理する GraphRAG ツールを作成
3. テキストドキュメントを小さなチャンクに分割
4. これらのチャンクに対して埋め込みを作成
5. それらを PostgreSQL のベクトルデータベースに保存
6. GraphRAG ツールを使い、クエリに基づいて関連チャンクのナレッジグラフを作成
   - ツールはベクトルストアから結果を返し、ナレッジグラフを生成
   - クエリを用いてナレッジグラフを走査
7. Mastra エージェントでコンテキストを踏まえた応答を生成

<div id="setup">
  ## セットアップ
</div>

<div id="environment-setup">
  ### 環境のセットアップ
</div>

環境変数が設定されていることを確認してください:

```bash title=".env"
OPENAI_API_KEY=your_openai_api_key_here
POSTGRES_CONNECTION_STRING=your_connection_string_here
```


<div id="dependencies">
  ### 依存関係
</div>

次に、必要な依存パッケージをインポートします。

```typescript copy showLineNumbers title="index.ts"
import { openai } from "@ai-sdk/openai";
import { Mastra } from "@mastra/core";
import { Agent } from "@mastra/core/agent";
import { PgVector } from "@mastra/pg";
import { MDocument, createGraphRAGTool } from "@mastra/rag";
import { embedMany } from "ai";
```


<div id="graphrag-tool-creation">
  ## GraphRAG ツールの作成
</div>

@mastra/rag からインポートした createGraphRAGTool を使うと、ベクトルデータベースに対してクエリを実行し、結果をナレッジグラフに変換するツールを作成できます。

```typescript copy showLineNumbers{8} title="index.ts"
const graphRagTool = createGraphRAGTool({
  vectorStoreName: "pgVector",
  indexName: "embeddings",
  model: openai.embedding("text-embedding-3-small"),
  graphOptions: {
    dimension: 1536,
    threshold: 0.7,
  },
});
```


<div id="agent-configuration">
  ## エージェント設定
</div>

応答を処理する Mastra エージェントを設定します：

```typescript copy showLineNumbers{19} title="index.ts"
const ragAgent = new Agent({
  name: "GraphRAG Agent",
  instructions: `あなたは提供されたコンテキストに基づいて質問に答える有用なアシスタントです。以下の形式で回答してください:

1. 直接的な事実: 質問に関連するテキストから直接述べられている事実のみをリストアップしてください(2-3個の箇条書き)
2. 見つけた関連性: テキストの異なる部分間で見つけた関係性をリストアップしてください(2-3個の箇条書き)
3. 結論: すべてをまとめた一文の要約

各セクションは簡潔にし、最も重要なポイントに焦点を当ててください。

重要: 質問に答えるよう求められた場合は、ツールで提供されたコンテキストのみに基づいて回答してください。
コンテキストに質問に完全に答えるための十分な情報が含まれていない場合は、そのことを明示的に述べてください。`,
  model: openai("gpt-4o-mini"),
  tools: {
    graphRagTool,
  },
});
```


<div id="instantiate-pgvector-and-mastra">
  ## PgVector と Mastra をインスタンス化する
</div>

以下のコンポーネントを使って PgVector と Mastra をインスタンス化します:

```typescript copy showLineNumbers{36} title="index.ts"
const pgVector = new PgVector({
  connectionString: process.env.POSTGRES_CONNECTION_STRING!,
});

export const mastra = new Mastra({
  agents: { ragAgent },
  vectors: { pgVector },
});
const agent = mastra.getAgent("ragAgent");
```


<div id="document-processing">
  ## ドキュメント処理
</div>

ドキュメントを作成し、チャンクに分割して処理します：

```typescript copy showLineNumbers{45} title="index.ts"
const doc = MDocument.fromText(`
# Riverdale Heights: コミュニティ開発調査
// ... テキストコンテンツ ...
`);

const chunks = await doc.chunk({
  strategy: "recursive",
  size: 512,
  overlap: 50,
  separator: "\n",
});
```


<div id="creating-and-storing-embeddings">
  ## 埋め込みの作成と保存
</div>

チャンクの埋め込みを生成し、ベクトルデータベースに保存します。

```typescript copy showLineNumbers{56} title="index.ts"
const { embeddings } = await embedMany({
  model: openai.embedding("text-embedding-3-small"),
  values: chunks.map((chunk) => chunk.text),
});

const vectorStore = mastra.getVector("pgVector");
await vectorStore.createIndex({
  indexName: "embeddings",
  dimension: 1536,
});
await vectorStore.upsert({
  indexName: "embeddings",
  vectors: embeddings,
  metadata: chunks?.map((chunk: any) => ({ text: chunk.text })),
});
```


<div id="graph-based-querying">
  ## グラフベースのクエリ
</div>

データ内の関係を探るために、さまざまなクエリを試してみましょう。

```typescript copy showLineNumbers{82} title="index.ts"
const queryOne =
  "Riverdale Heightsの現状に対する初期の鉄道決定の直接的および間接的な影響は何ですか?";
const answerOne = await ragAgent.generate(queryOne);
console.log("\nクエリ:", queryOne);
console.log("レスポンス:", answerOne.text);

const queryTwo =
  "交通インフラの変化は、地元企業やコミュニティスペースの異なる世代にどのような影響を与えましたか?";
const answerTwo = await ragAgent.generate(queryTwo);
console.log("\nクエリ:", queryTwo);
console.log("レスポンス:", answerTwo.text);

const queryThree =
  "Rossi家のビジネスとThompson Steel Worksが主要なインフラ変化にどのように対応したか、そしてそれらの対応がコミュニティにどのような影響を与えたかを比較してください。";
const answerThree = await ragAgent.generate(queryThree);
console.log("\nクエリ:", queryThree);
console.log("レスポンス:", answerThree.text);

const queryFour =
  "Thompson Steel Works跡地の変遷が、1932年から現在まで周辺のビジネスや文化スペースにどのような影響を与えたかを追跡してください。";
const answerFour = await ragAgent.generate(queryFour);
console.log("\nクエリ:", queryFour);
console.log("レスポンス:", answerFour.text);
```

<br />

<br />

<hr className="dark:border-[#404040] border-gray-300" />

<br />

<br />

<GithubLink
  link={
"https://github.com/mastra-ai/mastra/blob/main/examples/basics/rag/graph-rag"
}
/>
