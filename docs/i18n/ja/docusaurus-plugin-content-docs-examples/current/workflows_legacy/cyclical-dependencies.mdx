---
title: "例: 循環依存のあるワークフロー（レガシー） | ワークフロー（レガシー） | Mastra ドキュメント"
description: Mastra を用いて、循環依存や条件付きループを伴うレガシーなワークフローを作成する例。
---

import GithubLink from "@site/src/components/GithubLink";


<div id="workflow-legacy-with-cyclical-dependencies">
  # ワークフロー（レガシー）の循環依存
</div>

ワークフローは、条件に応じてステップを戻してループさせる循環依存をサポートします。以下の例では、条件分岐を使ってループを作成し、繰り返しの実行を処理する方法を示します。

```ts showLineNumbers copy
import { LegacyWorkflow, LegacyStep } from "@mastra/core/workflows/legacy";
import { z } from "zod";

async function main() {
  const doubleValue = new LegacyStep({
    id: "doubleValue",
    description: "入力値を2倍にします",
    inputSchema: z.object({
      inputValue: z.number(),
    }),
    outputSchema: z.object({
      doubledValue: z.number(),
    }),
    execute: async ({ context }) => {
      const doubledValue = context.inputValue * 2;
      return { doubledValue };
    },
  });

  const incrementByOne = new LegacyStep({
    id: "incrementByOne",
    description: "入力値に1を足します",
    outputSchema: z.object({
      incrementedValue: z.number(),
    }),
    execute: async ({ context }) => {
      const valueToIncrement = context?.getStepResult<{ firstValue: number }>(
        "trigger",
      )?.firstValue;
      if (!valueToIncrement) throw new Error("加算する値が指定されていません"),
      const incrementedValue = valueToIncrement + 1;
      return { incrementedValue };
    },
  });

  const cyclicalWorkflow = new LegacyWorkflow({
    name: "cyclical-workflow",
    triggerSchema: z.object({
      firstValue: z.number(),
    }),
  });

  cyclicalWorkflow
    .step(doubleValue, {
      variables: {
        inputValue: {
          step: "trigger",
          path: "firstValue",
        },
      },
    })
    .then(incrementByOne)
    .after(doubleValue)
    .step(doubleValue, {
      variables: {
        inputValue: {
          step: doubleValue,
          path: "doubledValue",
        },
      },
    })
    .commit();

  const { runId, start } = cyclicalWorkflow.createRun();

  console.log("実行ID", runId);

  const res = await start({ triggerData: { firstValue: 6 } });

  console.log(res.results);
}

main();
```

<br />

<br />

<hr className="dark:border-[#404040] border-gray-300" />

<br />

<br />

<GithubLink
  link={
"https://github.com/mastra-ai/mastra/blob/main/examples/basics/workflows-legacy/workflow-with-cyclical-deps"
}
/>


<div id="workflows-legacy">
  ## ワークフロー（レガシー）
</div>

以下のリンクは、レガシー版ワークフローのサンプルドキュメントです：

- [シンプルなワークフローの作成（レガシー）](/examples/workflows_legacy/creating-a-workflow)
- [順次ステップのワークフロー（レガシー）](/examples/workflows_legacy/sequential-steps)
- [ステップの並列実行](/examples/workflows_legacy/parallel-steps)
- [分岐パス](/examples/workflows_legacy/branching-paths)
- [条件分岐付きワークフロー（レガシー）（実験的）](/examples/workflows_legacy/conditional-branching)
- [ワークフロー（レガシー）からエージェントを呼び出す](/examples/workflows_legacy/calling-agent)
- [ツールをワークフローのステップとして使用（レガシー）](/examples/workflows_legacy/using-a-tool-as-a-step)
- [ワークフロー変数によるデータマッピング（レガシー）](/examples/workflows_legacy/workflow-variables)
- [人間参加型（Human-in-the-Loop）ワークフロー（レガシー）](/examples/workflows_legacy/human-in-the-loop)
- [一時停止と再開が可能なワークフロー（レガシー）](/examples/workflows_legacy/suspend-and-resume)