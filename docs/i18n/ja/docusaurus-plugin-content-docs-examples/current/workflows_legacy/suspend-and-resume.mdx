---
title: "例: サスペンドとリジュームを用いたワークフロー（レガシー） | Workflows（レガシー） | Mastra ドキュメント"
description: 実行中のレガシーワークフローのステップをサスペンドおよびリジュームするために Mastra を使用する例。
---

import GithubLink from "@site/src/components/GithubLink";


<div id="workflow-legacy-with-suspend-and-resume">
  # ワークフロー（レガシー）の一時停止と再開
</div>

ワークフローの各ステップは、実行の任意の時点で一時停止および再開できます。以下の例では、ワークフローステップを一時停止し、後で再開する方法を示します。

<div id="basic-example">
  ## 基本例
</div>

```ts showLineNumbers copy
import { Mastra } from "@mastra/core";
import { LegacyStep, LegacyWorkflow } from "@mastra/core/workflows/legacy";
import { z } from "zod";

const stepOne = new LegacyStep({
  id: "stepOne",
  outputSchema: z.object({
    doubledValue: z.number(),
  }),
  execute: async ({ context }) => {
    const doubledValue = context.triggerData.inputValue * 2;
    return { doubledValue };
  },
});
```

```ts showLineNumbers copy
const stepTwo = new LegacyStep({
  id: "stepTwo",
  outputSchema: z.object({
    incrementedValue: z.number(),
  }),
  execute: async ({ context, suspend }) => {
    const secondValue = context.inputData?.secondValue ?? 0;
    const doubledValue = context.getStepResult(stepOne)?.doubledValue ?? 0;

    const incrementedValue = doubledValue + secondValue;

    if (incrementedValue < 100) {
      await suspend();
      return { incrementedValue: 0 };
    }
    return { incrementedValue };
  },
});

// ワークフローを作成する
const myWorkflow = new LegacyWorkflow({
  name: "my-workflow",
  triggerSchema: z.object({
    inputValue: z.number(),
  }),
});

// ワークフローを並列実行する
myWorkflow.step(stepOne).then(stepTwo).commit();
```

```ts showLineNumbers copy
// ワークフローを登録する
export const mastra = new Mastra({
  legacy_workflows: { registeredWorkflow: myWorkflow },
});

// Mastra から登録済みのワークフローを取得する
const registeredWorkflow = mastra.legacy_getWorkflow("registeredWorkflow");
const { runId, start } = registeredWorkflow.createRun();

// 実行前にワークフローの監視を開始する
myWorkflow.watch(async ({ context, activePaths }) => {
  for (const _path of activePaths) {
    const stepTwoStatus = context.steps?.stepTwo?.status;
    if (stepTwoStatus === "suspended") {
console.log("ワークフローが一時停止しました。新しい値で再開します");

// 新しいコンテキストでワークフローを再開する
      await myWorkflow.resume({
        runId,
        stepId: "stepTwo",
        context: { secondValue: 100 },
      });
    }
  }
});

// ワークフローの実行を開始する
await start({ triggerData: { inputValue: 45 } });
```


<div id="advanced-example-with-multiple-suspension-points-using-asyncawait-pattern-and-suspend-payloads">
  ## async/await パターンとサスペンドペイロードを用いた、複数のサスペンションポイントを持つ高度な例
</div>

この例では、async/await パターンを使い、複数のサスペンションポイントを伴うより複雑なワークフローを示します。さまざまな段階で人の介入を必要とするコンテンツ生成ワークフローをシミュレートします。

```ts showLineNumbers copy
import { Mastra } from "@mastra/core";
import { LegacyStep, LegacyWorkflow } from "@mastra/core/workflows/legacy";
import { z } from "zod";

// ステップ 1: ユーザー入力を取得する
const getUserInput = new LegacyStep({
  id: "getUserInput",
  execute: async ({ context }) => {
    // 実際のアプリケーションでは、フォームや API から渡されることがあります
    return { userInput: context.triggerData.input };
  },
  outputSchema: z.object({ userInput: z.string() }),
});
```

```ts showLineNumbers copy
// ステップ 2: AI でコンテンツを生成（必要に応じて人手による指示待ちで一時停止）
const promptAgent = new LegacyStep({
  id: "promptAgent",
  inputSchema: z.object({
    guidance: z.string(),
  }),
  execute: async ({ context, suspend }) => {
    const userInput = context.getStepResult(getUserInput)?.userInput;
    console.log(`これに基づいてコンテンツを生成します: ${userInput}`);

    const guidance = context.inputData?.guidance;

    // AI によるコンテンツ生成を模擬
    const initialDraft = generateInitialDraft(userInput);

    // 信頼度が高い場合は、生成したコンテンツをそのまま返す
    if (initialDraft.confidenceScore > 0.7) {
      return { modelOutput: initialDraft.content };
    }

    console.log(
      "生成コンテンツの信頼度が低いため、人手による指示を待つため一時停止します",
      { guidance },
    );

    // 信頼度が低い場合は、人手による指示のために一時停止
    if (!guidance) {
      // 指示（guidance）が提供されていない場合にのみ一時停止
      await suspend();
      return undefined;
    }

    // 人手による指示を受けて再開後にこのコードが実行される
    console.log("人手による指示を受けて再開しました");

    // 人手による指示を用いて出力を改善
    return {
      modelOutput: enhanceWithGuidance(initialDraft.content, guidance),
    };
  },
  outputSchema: z.object({ modelOutput: z.string() }).optional(),
});
```

```ts showLineNumbers copy
// ステップ 3: コンテンツの品質を評価
const evaluateTone = new LegacyStep({
  id: "evaluateToneConsistency",
  execute: async ({ context }) => {
    const content = context.getStepResult(promptAgent)?.modelOutput;

    // 評価をシミュレーションする
    return {
      toneScore: { score: calculateToneScore(content) },
      completenessScore: { score: calculateCompletenessScore(content) },
    };
  },
  outputSchema: z.object({
    toneScore: z.any(),
    completenessScore: z.any(),
  }),
});
```

```ts showLineNumbers copy
// ステップ 4: 必要に応じて応答を改善（サスペンドする場合あり）
const improveResponse = new LegacyStep({
  id: "improveResponse",
  inputSchema: z.object({
    improvedContent: z.string(),
    resumeAttempts: z.number(),
  }),
  execute: async ({ context, suspend }) => {
    const content = context.getStepResult(promptAgent)?.modelOutput;
    const toneScore = context.getStepResult(evaluateTone)?.toneScore.score ?? 0;
    const completenessScore =
      context.getStepResult(evaluateTone)?.completenessScore.score ?? 0;

    const improvedContent = context.inputData.improvedContent;
    const resumeAttempts = context.inputData.resumeAttempts ?? 0;

    // スコアがしきい値を上回る場合は、軽微な修正を行う
    if (toneScore > 0.8 && completenessScore > 0.8) {
      return { improvedOutput: makeMinorImprovements(content) };
    }

    console.log(
      "コンテンツの品質がしきい値を下回ったため、人手による対応のためにサスペンドします",
      { improvedContent, resumeAttempts },
    );

    if (!improvedContent) {
      // コンテンツと再開試行回数を含むペイロードでサスペンド
      await suspend({
        content,
        scores: { tone: toneScore, completeness: completenessScore },
        needsImprovement: toneScore < 0.8 ? "トーン" : "網羅性",
        resumeAttempts: resumeAttempts + 1,
      });
      return { improvedOutput: content ?? "" };
    }

    console.log("人手による修正後に再開しました", improvedContent);
    return { improvedOutput: improvedContent ?? content ?? "" };
  },
  outputSchema: z.object({ improvedOutput: z.string() }).optional(),
});
```


```ts showLineNumbers copy
// ステップ5：最終評価
const evaluateImproved = new LegacyStep({
  id: "evaluateImprovedResponse",
  execute: async ({ context }) => {
    const improvedContent =
      context.getStepResult(improveResponse)?.improvedOutput;

    // 最終評価を擬似的に実行
    return {
      toneScore: { score: calculateToneScore(improvedContent) },
      completenessScore: { score: calculateCompletenessScore(improvedContent) },
    };
  },
  outputSchema: z.object({
    toneScore: z.any(),
    completenessScore: z.any(),
  }),
});

// ワークフローの構築
const contentWorkflow = new LegacyWorkflow({
  name: "content-generation-workflow",
  triggerSchema: z.object({ input: z.string() }),
});

contentWorkflow
  .step(getUserInput)
  .then(promptAgent)
  .then(evaluateTone)
  .then(improveResponse)
  .then(evaluateImproved)
  .commit();
```

```ts showLineNumbers copy
// ワークフローを登録
const mastra = new Mastra({
  legacy_workflows: { contentWorkflow },
});

// ヘルパー関数（シミュレーション）
function generateInitialDraft(input: string = "") {
  // AI によるコンテンツ生成を模擬
  return {
    content: `次の入力に基づいて生成されたコンテンツ: ${input}`,
    confidenceScore: 0.6, // 一時停止を発生させるため低めの信頼度を模擬
  };
}

function enhanceWithGuidance(content: string = "", guidance: string = "") {
  return `${content}（ガイダンスに基づいて強化: ${guidance}）`;
}

function makeMinorImprovements(content: string = "") {
  return `${content}（軽微な改良済み）`;
}

function calculateToneScore(_: string = "") {
  return 0.7; // 一時停止を発生させるスコアを模擬
}

function calculateCompletenessScore(_: string = "") {
  return 0.9;
}

// 使用例
async function runWorkflow() {
  const workflow = mastra.legacy_getWorkflow("contentWorkflow");
  const { runId, start } = workflow.createRun();

  let finalResult: any;

  // ワークフローを開始
  const initialResult = await start({
    triggerData: { input: "持続可能なエネルギーに関するコンテンツを作成" },
  });

  console.log("初期ワークフローの状態:", initialResult.results);

  const promptAgentStepResult = initialResult.activePaths.get("promptAgent");

  // promptAgent ステップが一時停止しているか確認
  if (promptAgentStepResult?.status === "suspended") {
    console.log("ワークフローが promptAgent ステップで一時停止");
    console.log("一時停止ペイロード:", promptAgentStepResult?.suspendPayload);

    // 人手によるガイダンスで再開
    const resumeResult1 = await workflow.resume({
      runId,
      stepId: "promptAgent",
      context: {
        guidance: "太陽光発電と風力発電の技術により重点を置いてください",
      },
    });

    console.log("ワークフローを再開し、次のステップへ進行");

    let improveResponseResumeAttempts = 0;
    let improveResponseStatus =
      resumeResult1?.activePaths.get("improveResponse")?.status;

    // improveResponse ステップが一時停止しているか確認
    while (improveResponseStatus === "suspended") {
      console.log("ワークフローが improveResponse ステップで一時停止");
      console.log(
        "一時停止ペイロード:",
        resumeResult1?.activePaths.get("improveResponse")?.suspendPayload,
      );

      const improvedContent =
        improveResponseResumeAttempts < 3
          ? undefined
          : "Completely revised content about sustainable energy focusing on solar and wind technologies";

      // 人手による改良で再開
      finalResult = await workflow.resume({
        runId,
        stepId: "improveResponse",
        context: {
          improvedContent,
          resumeAttempts: improveResponseResumeAttempts,
        },
      });

      improveResponseResumeAttempts =
        finalResult?.activePaths.get("improveResponse")?.suspendPayload
          ?.resumeAttempts ?? 0;
      improveResponseStatus =
        finalResult?.activePaths.get("improveResponse")?.status;

      console.log("改良後のレスポンス結果:", finalResult?.results);
    }
  }
  return finalResult;
}

// ワークフローを実行
const result = await runWorkflow();
console.log("ワークフローが完了しました");
console.log("最終的なワークフロー結果:", result);
```


<div id="workflows-legacy">
  ## ワークフロー（レガシー）
</div>

以下のリンクは、レガシー版ワークフローの例を示すドキュメントです。

- [シンプルなワークフローの作成（レガシー）](/examples/workflows_legacy/creating-a-workflow)
- [順次ステップのワークフロー（レガシー）](/examples/workflows_legacy/sequential-steps)
- [ステップの並列実行（レガシー）](/examples/workflows_legacy/parallel-steps)
- [分岐パス（レガシー）](/examples/workflows_legacy/branching-paths)
- [条件分岐付きワークフロー（レガシー・試験的）](/examples/workflows_legacy/conditional-branching)
- [ワークフローからエージェントを呼び出す（レガシー）](/examples/workflows_legacy/calling-agent)
- [ツールをワークフローのステップとして使用（レガシー）](/examples/workflows_legacy/using-a-tool-as-a-step)
- [循環依存を含むワークフロー（レガシー）](/examples/workflows_legacy/cyclical-dependencies)
- [ワークフロー変数によるデータマッピング（レガシー）](/examples/workflows_legacy/workflow-variables)
- [Human-in-the-Loop ワークフロー（レガシー）](/examples/workflows_legacy/human-in-the-loop)