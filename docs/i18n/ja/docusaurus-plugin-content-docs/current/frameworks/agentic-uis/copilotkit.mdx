---
title: "CopilotKit を Mastra と統合する | フレームワーク | Mastra ドキュメント"
description: "Mastra が CopilotKit の AGUI ライブラリをどのように活用しているか、またそれを用いて優れたユーザー体験を構築する方法を学びましょう"
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import Steps from "@site/src/components/Steps";
import StepItem from "@site/src/components/StepItem";


<div id="integrate-copilotkit-with-mastra">
  # Mastra と CopilotKit を統合する
</div>

CopilotKit は、アプリケーションにカスタマイズ可能な AI コパイロットを手早く組み込むための React コンポーネントを提供します。Mastra と組み合わせることで、双方向の状態同期やインタラクティブな UI を備えた高度な AI アプリを構築できます。

CopilotKit のコンセプト、コンポーネント、発展的な活用パターンについては、[CopilotKit ドキュメント](https://docs.copilotkit.ai/)をご覧ください。

このガイドでは、次の 2 つの統合方法を紹介します。

1. Mastra サーバーに CopilotKit を統合し、フロントエンドは別の React として構築する
2. Next.js アプリに CopilotKit を統合する

<Tabs>
  <TabItem value="mastra-server" label="Mastra サーバー">
    <Steps>
      <StepItem>
        React フロントエンドで必要な CopilotKit パッケージをインストールします：

        <Tabs>
          <TabItem value="npm" label="npm">
            ```bash copy
            npm install @copilotkit/react-core @copilotkit/react-ui
            ```
          </TabItem>

          <TabItem value="yarn" label="yarn">
            ```bash copy
            yarn add @copilotkit/react-core @copilotkit/react-ui
            ```
          </TabItem>

          <TabItem value="pnpm" label="pnpm">
            ```bash copy
            pnpm add @copilotkit/react-core @copilotkit/react-ui
            ```
          </TabItem>
        </Tabs>
      </StepItem>

      <StepItem>
        React フロントエンドに CopilotKit コンポーネントを作成します：

        ```tsx title="components/copilotkit-component.tsx" copy
        import { CopilotChat } from "@copilotkit/react-ui";
        import { CopilotKit } from "@copilotkit/react-core";
        import "@copilotkit/react-ui/styles.css";

        export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string }) {
          return (
            <CopilotKit runtimeUrl={runtimeUrl} agent="weatherAgent">
              <CopilotChat
                labels={{
                  title: "Your Assistant",
                  initial: "Hi! 👋 How can I assist you today?",
                }}
              />
            </CopilotKit>
          );
        }
        ```
      </StepItem>

      <StepItem>
        まだ Mastra サーバーをセットアップしていない場合は、[はじめに](/docs/getting-started/installation)に従って新しい Mastra プロジェクトをセットアップしてください。

        Mastra サーバーで、CopilotKit 連携用の追加パッケージをインストールします：

        <Tabs>
          <TabItem value="npm" label="npm">
            ```bash copy
            npm install @copilotkit/runtime @ag-ui/mastra
            ```
          </TabItem>

          <TabItem value="yarn" label="yarn">
            ```bash copy
            yarn add @copilotkit/runtime @ag-ui/mastra
            ```
          </TabItem>

          <TabItem value="pnpm" label="pnpm">
            ```bash copy
            pnpm add @copilotkit/runtime @ag-ui/mastra
            ```
          </TabItem>
        </Tabs>
      </StepItem>

      <StepItem>
        Mastra インスタンスを設定し、CopilotKit のランタイムエンドポイントを含めます：

        ```typescript title="src/mastra/index.ts" copy {2,5-8,12-28}
        import { Mastra } from "@mastra/core/mastra";
        import { registerCopilotKit } from "@ag-ui/mastra/copilotkit";
        import { weatherAgent } from "./agents/weather-agent";

        type WeatherRuntimeContext = {
          "user-id": string;
          "temperature-scale": "celsius" | "fahrenheit";
        };

        export const mastra = new Mastra({
          agents: { weatherAgent },
          server: {
            cors: {
              origin: "*",
              allowMethods: ["*"],
              allowHeaders: ["*"],
            },
            apiRoutes: [
              registerCopilotKit<WeatherRuntimeContext>({
                path: "/copilotkit",
                resourceId: "weatherAgent",
                setContext: (c, runtimeContext) => {
                  runtimeContext.set(
                    "user-id",
                    c.req.header("X-User-ID") || "anonymous",
                  );
                  runtimeContext.set("temperature-scale", "celsius");
                },
              }),
            ],
          },
        });
        ```
      </StepItem>

      <StepItem>
        React アプリで、Mastra サーバーの URL を指定してこのコンポーネントを使用します：

        ```tsx title="App.tsx" copy {5}
        import { CopilotKitComponent } from "./components/copilotkit-component";

        function App() {
          return <CopilotKitComponent runtimeUrl="http://localhost:4111/copilotkit" />;
        }

        export default App;
        ```

        これで、Mastra サーバーとフロントエンドの両方を起動できます。
      </StepItem>
    </Steps>
  </TabItem>

  <TabItem value="Next.js" label="Next.js">
    <Steps>
      <StepItem>
        Next.js アプリで必要なパッケージをインストールします:

        <Tabs>
          <TabItem value="npm" label="npm">
            ```bash copy
            npm install @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
            ```
          </TabItem>

          <TabItem value="yarn" label="yarn">
            ```bash copy
            yarn add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
            ```
          </TabItem>

          <TabItem value="pnpm" label="pnpm">
            ```bash copy
            pnpm add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
            ```
          </TabItem>
        </Tabs>
      </StepItem>

      <StepItem>
        CopilotKit コンポーネントを作成する:

        ```tsx title="components/copilotkit-component.tsx" copy
        'use client';
        import { CopilotChat } from "@copilotkit/react-ui";
        import { CopilotKit } from "@copilotkit/react-core";
        import "@copilotkit/react-ui/styles.css";

        export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
          return (
            <CopilotKit
              runtimeUrl={runtimeUrl}
              agent="weatherAgent"
            >
              <CopilotChat
                labels={{
                  title: "アシスタント",
                  initial: "こんにちは!👋 今日はどうされましたか?",
                }}
              />
            </CopilotKit>
          );
        }
        ```
      </StepItem>

      <StepItem>
        Mastra を Next.js アプリにどう統合するかによって、API ルートの実装には 2 つのアプローチがあります。

        1. アプリ内に Mastra のインスタンスを組み込んだフルスタック Next.js アプリ向け
        2. 別の Mastra サーバーと Mastra Client SDK を用いる Next.js アプリ向け

        <Tabs>
          <TabItem value="mastra-instance" label="Mastra インスタンスを利用">
            ローカルの Mastra エージェントに接続する API ルートを作成します。

            ```typescript title="app/api/copilotkit/route.ts" copy {1-7,11-26}
            import { mastra } from "../../mastra";
            import {
              CopilotRuntime,
              ExperimentalEmptyAdapter,
              copilotRuntimeNextJSAppRouterEndpoint,
            } from "@copilotkit/runtime";
            import { MastraAgent } from "@ag-ui/mastra";
            import { NextRequest } from "next/server";

            export const POST = async (req: NextRequest) => {
              const mastraAgents = MastraAgent.getLocalAgents({
                mastra,
                agentId: "weatherAgent",
              });

              const runtime = new CopilotRuntime({
                agents: mastraAgents,
              });

              const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
                runtime,
                serviceAdapter: new ExperimentalEmptyAdapter(),
                endpoint: "/api/copilotkit",
              });

              return handleRequest(req);
            };
            ```
          </TabItem>

          <TabItem value="mastra-client" label="Mastra Client SDK を利用">
            Mastra Client SDK をインストールします。

            <Tabs>
              <TabItem value="npm" label="npm">
                ```bash copy
                npm install @mastra/client-js
                ```
              </TabItem>

              <TabItem value="yarn" label="yarn">
                ```bash copy
                yarn add @mastra/client-js
                ```
              </TabItem>

              <TabItem value="pnpm" label="pnpm">
                ```bash copy
                pnpm add @mastra/client-js
                ```
              </TabItem>
            </Tabs>

            リモートの Mastra エージェントに接続する API ルートを作成します。

            ```typescript title="app/api/copilotkit/route.ts" copy {1-7,12-26}
            import { MastraClient } from "@mastra/client-js";
            import {
              CopilotRuntime,
              ExperimentalEmptyAdapter,
              copilotRuntimeNextJSAppRouterEndpoint,
            } from "@copilotkit/runtime";
            import { MastraAgent } from "@ag-ui/mastra";
            import { NextRequest } from "next/server";

            export const POST = async (req: NextRequest) => {
              const baseUrl = process.env.MASTRA_BASE_URL || "http://localhost:4111";
              const mastraClient = new MastraClient({ baseUrl });

              const mastraAgents = await MastraAgent.getRemoteAgents({ mastraClient });

              const runtime = new CopilotRuntime({
                agents: mastraAgents,
              });

              const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
                runtime,
                serviceAdapter: new ExperimentalEmptyAdapter(),
                endpoint: "/api/copilotkit",
              });

              return handleRequest(req);
            };
            ```
          </TabItem>
        </Tabs>
      </StepItem>

      <StepItem>
        ローカルの API エンドポイントを使ってコンポーネントを利用します:

        ```tsx title="App.tsx" copy {5}
        import { CopilotKitComponent } from "./components/copilotkit-component";

        function App() {
          return <CopilotKitComponent runtimeUrl="/api/copilotkit" />;
        }

        export default App;
        ```
      </StepItem>
    </Steps>
  </TabItem>
</Tabs>

未来を築き始めよう！

<br />

<img
  className="rounded-lg"
  src="/img/copilotkit/cpkoutput.jpg"
  alt="CopilotKitの出力"
  style={{ maxWidth: "700px", width: "100%" }}
/>

<div id="next-steps">
  ## 次のステップ
</div>

- [CopilotKit Documentation](https://docs.copilotkit.ai) - CopilotKit の包括的なリファレンス
- [React Hooks with CopilotKit](https://docs.copilotkit.ai/reference/hooks/useCoAgent) - React の高度な統合パターン
- [Next.js Integration with Mastra](/docs/frameworks/web-frameworks/next-js) - フルスタックの Next.js セットアップガイド