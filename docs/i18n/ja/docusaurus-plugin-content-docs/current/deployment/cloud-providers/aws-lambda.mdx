---
title: "AWS Lambda | デプロイ | Mastra ドキュメント"
description: "Docker コンテナと AWS Lambda Web Adapter を使用して、Mastra アプリケーションを AWS Lambda にデプロイします。"
---

import Steps from "@site/src/components/Steps";
import StepItem from "@site/src/components/StepItem";


<div id="aws-lambda">
  # AWS Lambda
</div>

Docker コンテナと AWS Lambda Web Adapter を使用して、Mastra アプリケーションを AWS Lambda にデプロイします。
この方法により、自動スケーリングに対応したコンテナ化された Lambda 関数として Mastra サーバーを実行できます。

:::note
このガイドは、デフォルトの
`npx create-mastra@latest` コマンドで Mastra アプリケーションを作成していることを前提としています。
新しい Mastra アプリケーションの作成方法については、
[クイックスタートガイド](/docs/getting-started/installation)を参照してください
:::

<div id="prerequisites">
  ## 前提条件
</div>

AWS Lambda にデプロイする前に、次を準備してください:

- [AWS CLI](https://aws.amazon.com/cli/) がインストール済みで、設定されていること
- [Docker](https://www.docker.com/) がインストール済みで、起動していること
- Lambda、ECR、IAM に対して適切な権限を持つ AWS アカウント
- 適切なメモリーストレージを設定した Mastra アプリケーション

<div id="memory-configuration">
  ## メモリ設定
</div>

:::note
AWS Lambda は一時的なファイルシステムを使用しており、
ファイルシステムに書き込まれたファイルは短期間で消える可能性があります。
`file` URL を用いる `LibSQLStore` のように、ファイルシステムを使う Mastra のストレージプロバイダの使用は避けてください。
:::

Lambda 関数ではファイルシステムのストレージに制約があります。Mastra アプリケーションは、インメモリまたは外部ストレージプロバイダを使用するように構成してください。

<div id="option-1-in-memory-simplest">
  ### オプション 1: メモリ内（最も簡単）
</div>

```typescript title="src/mastra/index.ts" copy showLineNumbers
import { LibSQLStore } from "@mastra/libsql";

const storage = new LibSQLStore({
  url: ":memory:", // メモリ内ストレージ
});
```


<div id="option-2-external-storage-providers">
  ### オプション 2: 外部ストレージプロバイダー
</div>

Lambda の呼び出し間でメモリを永続化するには、Turso と組み合わせた `LibSQLStore` や、`PostgreStore` などの外部ストレージプロバイダーを使用します:

```typescript title="src/mastra/index.ts" copy showLineNumbers
import { LibSQLStore } from "@mastra/libsql";

const storage = new LibSQLStore({
  url: "libsql://your-database.turso.io", // 外部Tursoデータベース
  authToken: process.env.TURSO_AUTH_TOKEN,
});
```

メモリの設定オプションについて詳しくは、[メモリに関するドキュメント](/docs/memory/overview)をご覧ください。


<div id="creating-a-dockerfile">
  ## Dockerfile の作成
</div>

Mastra プロジェクトのルートディレクトリに `Dockerfile` を作成します。

```dockerfile title="Dockerfile" copy showLineNumbers
FROM node:22-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY src ./src
RUN npx mastra build
RUN apk add --no-cache gcompat

COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.9.0 /lambda-adapter /opt/extensions/lambda-adapter
RUN addgroup -g 1001 -S nodejs && \
  adduser -S mastra -u 1001 && \
  chown -R mastra:nodejs /app

USER mastra

ENV PORT=8080
ENV NODE_ENV=production
ENV READINESS_CHECK_PATH="/api"

EXPOSE 8080

CMD ["node", "--import=./.mastra/output/instrumentation.mjs", ".mastra/output/index.mjs"]
```


<div id="building-and-deploying">
  ## ビルドとデプロイ
</div>

<Steps>

<StepItem>

デプロイ用の環境変数を設定します:

```bash copy
export PROJECT_NAME="your-mastra-app"
export AWS_REGION="us-east-1"
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
```

</StepItem>

<StepItem>

ローカルで Docker イメージをビルドします:

```bash copy
docker build -t "$PROJECT_NAME" .
```

</StepItem>

<StepItem>

Docker イメージを保存するための Amazon ECR リポジトリを作成します:

```bash copy
aws ecr create-repository --repository-name "$PROJECT_NAME" --region "$AWS_REGION"
```

</StepItem>

<StepItem>

Amazon ECR にログインします:

```bash copy
aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
```

</StepItem>

<StepItem>

イメージに ECR リポジトリの URI を付けてプッシュします:

```bash copy
docker tag "$PROJECT_NAME":latest "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$PROJECT_NAME":latest
docker push "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$PROJECT_NAME":latest
```

</StepItem>

<StepItem>

AWS コンソールで Lambda 関数を作成します:

1. [AWS Lambda コンソール](https://console.aws.amazon.com/lambda/) に移動
2. **Create function** をクリック
3. **Container image** を選択
4. 関数を構成:
   - **Function name**: 関数名（例: `mastra-app`）
   - **Container image URI**: **Browse images** をクリックし、ECR リポジトリを選んで `latest` タグを指定
   - **Architecture**: Docker ビルドに合ったアーキテクチャを選択（通常は `x86_64`）

</StepItem>

<StepItem>

外部アクセス用に Function URL を有効化します:

1. Lambda 関数の設定で **Configuration** > **Function URL** に移動
2. **Create function URL** をクリック
3. **Auth type** を **NONE** に設定（パブリックアクセス）
4. **CORS** を設定:
   - **Allow-Origin**: `*`（本番では自ドメインに制限）
   - **Allow-Headers**: `content-type`（CloudFront/API Gateway などと併用する場合は `x-amzn-request-context` も必要）
   - **Allow-Methods**: `*`（本番では精査して制限）
5. **Save** をクリック

</StepItem>

<StepItem>

Lambda 関数の設定で環境変数を追加します:

1. **Configuration** > **Environment variables** に移動
2. Mastra アプリに必要な変数を追加:
   - `OPENAI_API_KEY`: OpenAI の API キー（OpenAI を使用する場合）
   - `ANTHROPIC_API_KEY`: Anthropic の API キー（Anthropic を使用する場合）
   - `TURSO_AUTH_TOKEN`: Turso の認証トークン（LibSQL を Turso と併用する場合）
   - 必要に応じて他のプロバイダー固有の API キー

</StepItem>

<StepItem>

関数のメモリとタイムアウトを設定します:

1. **Configuration** > **General configuration** に移動
2. 次の推奨値を設定:
   - **Memory**: 512 MB（アプリの要件に応じて調整）
   - **Timeout**: 30 秒（アプリの要件に応じて調整）
   - **Ephemeral storage**: 512 MB（任意・一時ファイル用）

</StepItem>

</Steps>

<div id="testing-your-deployment">
  ## デプロイのテスト
</div>

デプロイが完了したら、Lambda 関数をテストします。

1. Lambda コンソールで **Function URL** をコピーする
2. ブラウザでその URL を開き、Mastra サーバーのホーム画面を表示する
3. 生成された API エンドポイントを使ってエージェントやワークフローをテストする

利用可能な API エンドポイントの詳細は、[サーバーのドキュメント](/docs/deployment/server-deployment)を参照してください。

<div id="connecting-your-client">
  ## クライアントの接続
</div>

クライアントアプリケーションを更新し、Lambda 関数の URL を使用するようにします。

```typescript title="src/client.ts" copy showLineNumbers
import { MastraClient } from "@mastra/client-js";

const mastraClient = new MastraClient({
  baseUrl: "https://your-function-url.lambda-url.us-east-1.on.aws",
});
```


<div id="troubleshooting">
  ## トラブルシューティング
</div>

<div id="function-timeout-errors">
  ### 関数のタイムアウトエラー
</div>

Lambda 関数がタイムアウトする場合:

- **Configuration** > **General configuration** でタイムアウト値を延長する
- コールドスタートを短縮するように Mastra アプリケーションを最適化する
- パフォーマンスを安定させるためにプロビジョンド同時実行の利用を検討する

<div id="memory-issues">
  ### メモリに関する問題
</div>

メモリ関連のエラーが発生した場合は、次の対処を行ってください。

- **Configuration** > **General configuration** でメモリの割り当てを増やす
- CloudWatch Logs でメモリ使用状況を監視する
- アプリケーションのメモリ使用量を最適化する

<div id="cors-issues">
  ### CORS の問題
</div>

エンドポイントにはアクセス時に CORS エラーが出るが、ホームページでは発生しない場合:

- Mastra サーバーの設定で CORS ヘッダーが正しく設定されているか確認する
- Lambda Function URL の CORS 設定を確認する
- クライアントが正しい URL にリクエストしていることを確認する

<div id="container-image-issues">
  ### コンテナイメージに関する問題
</div>

Lambda 関数の起動に失敗する場合:

- Docker イメージがローカルで正常にビルドできることを確認する
- Dockerfile の `CMD` 命令が正しいかを確認する
- コンテナの起動エラーについて CloudWatch Logs を確認する
- Lambda Web Adapter がコンテナに正しくインストールされていることを確認する

<div id="production-considerations">
  ## 本番運用の考慮事項
</div>

本番環境へのデプロイ時には、次の点を検討してください：

<div id="security">
  ### セキュリティ
</div>

- CORS の許可元は信頼できるドメインに限定する
- 他の AWS サービスへの安全なアクセスには AWS IAM ロールを使用する
- 機密性の高い環境変数は AWS Secrets Manager または Parameter Store に保存する

<div id="monitoring">
  ### 監視
</div>

- Lambda 関数の CloudWatch モニタリングを有効にする
- エラーやパフォーマンスメトリクス向けに CloudWatch アラームを設定する
- 分散トレーシングには AWS X-Ray を使用する

<div id="scaling">
  ### スケーリング
</div>

- 予測可能なパフォーマンスのためにプロビジョンドコンカレンシーを設定する
- 同時実行数を監視し、必要に応じて上限を調整する
- より複雑なルーティングが必要な場合は Application Load Balancer の利用を検討する

<div id="next-steps">
  ## 次のステップ
</div>

- [Mastra クライアント SDK](/reference/client-js/mastra-client)
- [AWS Lambda ドキュメント](https://docs.aws.amazon.com/lambda/)
- [AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)