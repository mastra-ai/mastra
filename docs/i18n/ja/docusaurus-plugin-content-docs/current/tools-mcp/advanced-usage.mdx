---
title: "高度なツール活用 | Tools & MCP | Mastra Docs"
description: このページでは、Mastra のツールにおける高度な機能（中断シグナルや Vercel AI SDK のツール形式との互換性など）について説明します。
---

<div id="advanced-tool-usage">
  # 高度なツール活用
</div>

このページでは、Mastra でのツール利用に関する高度な手法や機能について説明します。

<div id="abort-signals">
  ## 中断シグナル
</div>

`generate()` または `stream()` を使ってエージェントとの対話を開始する際、`AbortSignal` を渡せます。Mastra は、このシグナルをその対話中に行われるすべてのツール実行へ自動的に転送します。

これにより、親のエージェント呼び出しが中断された場合に、ネットワークリクエストや重い計算など、ツール内の長時間実行処理をキャンセルできます。

ツールの `execute` 関数の第2引数から `abortSignal` にアクセスできます。

```typescript
import { createTool } from "@mastra/core/tools";
import { z } from "zod";

export const longRunningTool = createTool({
  id: "long-computation",
  description: "時間がかかる可能性のある計算を実行します",
  inputSchema: z.object({ /* ... */ }),
  execute: async ({ context }, { abortSignal }) => {
    // 例: fetch に中断シグナルを渡す
    const response = await fetch("https://api.example.com/data", {
      signal: abortSignal, // ここに中断シグナルを渡す
    });

    if (abortSignal?.aborted) {
      console.log("ツールの実行が中断されました。");
      throw new Error("中断");
    }

    // 例: ループ中に中断シグナルを確認する
    for (let i = 0; i < 1000000; i++) {
      if (abortSignal?.aborted) {
        console.log("ループ中にツールの実行が中断されました。");
        throw new Error("中断");
      }
      // ... 計算ステップを実行 ...
    }

    const data = await response.json();
    return { result: data };
  },\n});
```

これを使用するには、エージェントを呼び出すときに `AbortController` のシグナルを渡します。

```typescript
import { Agent } from "@mastra/core/agent";
// 'agent' は longRunningTool が設定された Agent インスタンスであると仮定します

const controller = new AbortController();

// エージェントの呼び出しを開始
const promise = agent.generate("時間のかかる計算を実行してください。", {
  abortSignal: controller.signal,
});

// 必要に応じて後で:
// controller.abort();

try {
  const result = await promise;
  console.log(result.text);
} catch (error) {
  if (error.name === "AbortError") {
    console.log("エージェントの生成は中断されました。");
  } else {
    console.error("エラーが発生しました：", error);
  }
}
```


<div id="ai-sdk-tool-format">
  ## AI SDK ツール形式
</div>

Mastra は、Vercel AI SDK（`ai` パッケージ）で使用されているツール形式との互換性を保っています。`ai` パッケージの `tool` 関数でツールを定義し、Mastra の `createTool` で作成したツールとあわせて、Mastra エージェント内でそのまま使用できます。

まずは、`ai` パッケージがインストールされていることを確認してください。

```bash npm2yarn copy
npm install ai
```

こちらは、Vercel AI SDK 形式で定義されたツールの例です：

```typescript title="src/mastra/tools/vercelWeatherTool.ts" copy
import { tool } from "ai";
import { z } from "zod";

export const vercelWeatherTool = tool({
  description: "Vercel AI SDK形式で現在の天気を取得します",
  parameters: z.object({
    city: z.string().describe("天気を取得する都市名"),
  }),
  execute: async ({ city }) => {
    console.log(`${city}の天気を取得中 (Vercel形式ツール)`);
    // 実際のAPI呼び出しに置き換えてください
    const data = await fetch(`https://api.example.com/weather?city=${city}`);
    return data.json();
  },
});
```

その後、このツールを他のツールと同様に Mastra エージェントに追加できます：

```typescript title="src/mastra/agents/mixedToolsAgent.ts"
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { vercelWeatherTool } from "../tools/vercelWeatherTool"; // Vercel AI SDK ツール
import { mastraTool } from "../tools/mastraTool"; // Mastra createTool ツール

export const mixedToolsAgent = new Agent({
  name: "Mixed Tools Agent",
  instructions: "異なる形式で定義されたツールを使用できます。",
  model: openai("gpt-4o-mini"),
  tools: {
    weatherVercel: vercelWeatherTool,
    someMastraTool: mastraTool,
  },
});
```

Mastra は両方のツール形式に対応しており、必要に応じて組み合わせて使えます。
