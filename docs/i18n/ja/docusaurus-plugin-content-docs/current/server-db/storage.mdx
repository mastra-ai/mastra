---
title: "MastraStorage | サーバー & DB | Mastra ドキュメント"
description: Mastra のストレージシステムとデータ永続化機能の概要
---

import PropertiesTable from "@site/src/components/PropertiesTable";
import { SchemaTable } from "@site/src/components/SchemaTable";
import { StorageOverviewImage } from "@site/src/components/StorageOverviewImage";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";


<div id="mastrastorage">
  # MastraStorage
</div>

`MastraStorage` は、次の内容を管理するための統一インターフェースを提供します：

- **Suspended Workflows**: 一時停止中のワークフローのシリアライズ済み状態（後で再開できるようにするため）
- **Memory**: アプリケーション内の `resourceId` ごとのスレッドとメッセージ
- **Traces**: Mastra のすべてのコンポーネント由来の OpenTelemetry トレース
- **Eval Datasets**: 評価実行のスコアとその理由

<br />

<br />

<StorageOverviewImage />

Mastra には複数のストレージプロバイダーがあり、相互に置き換えて使用できます。たとえば、開発では libsql を、本番では postgres を使っても、どちらでもコードは同様に動作します。

<div id="configuration">
  ## 設定
</div>

Mastra では、デフォルトのストレージオプションを設定できます。

```typescript copy
import { Mastra } from "@mastra/core/mastra";
import { LibSQLStore } from "@mastra/libsql";

const mastra = new Mastra({
  storage: new LibSQLStore({
    url: "file:./mastra.db",
  }),
});
```

`storage` 設定を指定しない場合、Mastra はアプリケーションの再起動やデプロイ後もデータを保持しません。ローカルでのテスト以外のデプロイでは、`Mastra` 側、または `new Memory()` 内で直接、独自のストレージ設定を用意してください。


<div id="data-schema">
  ## データ スキーマ
</div>

<Tabs>
  <TabItem value="メッセージ" label="メッセージ">
    会話メッセージとそのメタデータを保存します。各メッセージはスレッドに属し、送信者のロールやメッセージタイプに関するメタデータとともに、実際のコンテンツを含みます。

    <br />

    <SchemaTable
      columns={[
{
name: "id",
type: "uuidv4",
description:
  "メッセージの一意の識別子（形式: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`）",
constraints: [{ type: "primaryKey" }, { type: "nullable", value: false }],
},
{
name: "thread_id",
type: "uuidv4",
description: "親スレッドの参照",
constraints: [
  { type: "foreignKey", value: "threads.id" },
  { type: "nullable", value: false },
],
},
{
name: "resourceId",
type: "uuidv4",
description: "このメッセージの所有元リソースのID",
constraints: [{ type: "nullable", value: true }],
},
{
name: "content",
type: "text",
description:
  "V2形式のメッセージ内容を表すJSON。例: `{ format: 2, parts: [...] }`",
constraints: [{ type: "nullable", value: false }],
},
{
name: "role",
type: "text",
description: "`user | assistant` の列挙値",
constraints: [{ type: "nullable", value: false }],
},
{
name: "createdAt",
type: "timestamp",
description: "スレッド内でのメッセージの並び順に使用",
constraints: [{ type: "nullable", value: false }],
},
]}
    />

    `content` 列には `MastraMessageContentV2` 型に準拠するJSONオブジェクトが含まれます。これは AI SDK の `UIMessage` のメッセージ形状に近づけて設計されています。

    <SchemaTable
      columns={[
{
name: "format",
type: "integer",
description: "メッセージ形式のバージョン（現在は 2）",
constraints: [{ type: "nullable", value: false }],
},
{
name: "parts",
type: "array (JSON)",
description:
  "メッセージ部品の配列（text、tool-invocation、file、reasoning など）。この配列内の各要素の構造は `type` によって異なります。",
constraints: [{ type: "nullable", value: false }],
},
{
name: "experimental_attachments",
type: "array (JSON)",
description: "任意のファイル添付の配列",
constraints: [{ type: "nullable", value: true }],
},
{
name: "content",
type: "text",
description: "メッセージのメインテキスト内容（任意）",
constraints: [{ type: "nullable", value: true }],
},
{
name: "toolInvocations",
type: "array (JSON)",
description: "ツール呼び出しと結果の要約（任意）の配列",
constraints: [{ type: "nullable", value: true }],
},
{
name: "reasoning",
type: "object (JSON)",
description:
  "アシスタントの応答の背後にある推論プロセスに関する情報（任意）",
constraints: [{ type: "nullable", value: true }],
},
{
name: "annotations",
type: "object (JSON)",
description: "追加のメタデータまたは注釈（任意）",
constraints: [{ type: "nullable", value: true }],
},
]}
    />
  </TabItem>

  <TabItem value="スレッド" label="スレッド">
    関連するメッセージをまとめ、リソースに紐づけます。会話に関するメタデータを含みます。

    <br />

    <SchemaTable
      columns={[
{
name: "id",
type: "uuidv4",
description:
  "スレッドの一意な識別子（形式: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`）",
constraints: [{ type: "primaryKey" }, { type: "nullable", value: false }],
},
{
name: "resourceId",
type: "text",
description:
  "このスレッドが紐づく外部リソースの主識別子。関連スレッドのグルーピングや取得に使用します。",
constraints: [{ type: "nullable", value: false }],
},
{
name: "title",
type: "text",
description: "会話スレッドのタイトル",
constraints: [{ type: "nullable", value: false }],
},
{
name: "metadata",
type: "text",
description: "JSON 文字列として表現したカスタムスレッドメタデータ。例:",
example: {
  category: "support",
  priority: 1,
},
},
{
name: "createdAt",
type: "timestamp",
constraints: [{ type: "nullable", value: false }],
},
{
name: "updatedAt",
type: "timestamp",
description: "スレッドの並び順履歴に使用",
constraints: [{ type: "nullable", value: false }],
},
]}
    />
  </TabItem>

  <TabItem value="リソース" label="リソース">
    ユーザー固有のデータを、リソース単位のワーキングメモリとして保存します。各リソースはユーザーまたはエンティティを表し、そのユーザーのすべての会話スレッドにわたってワーキングメモリを保持できます。

    <br />

    <SchemaTable
      columns={[
{
name: "id",
type: "text",
description:
  "リソース識別子（ユーザーまたはエンティティ ID）— スレッドやエージェント呼び出しで使用される resourceId と同一",
constraints: [{ type: "primaryKey" }, { type: "nullable", value: false }],
},
{
name: "workingMemory",
type: "text",
description:
  "Markdown テキスト形式の永続的なワーキングメモリデータ。ユーザープロフィール、嗜好、会話スレッドをまたいで保持されるコンテキスト情報を含みます。",
constraints: [{ type: "nullable", value: true }],
},
{
name: "metadata",
type: "jsonb",
description: "JSON 形式の追加リソースメタデータ。例：",
example: {
  preferences: { language: "en", timezone: "UTC" },
  tags: ["premium", "beta-user"],
},
constraints: [{ type: "nullable", value: true }],
},
{
name: "createdAt",
type: "timestamp",
description: "リソースレコードが最初に作成された日時",
constraints: [{ type: "nullable", value: false }],
},
{
name: "updatedAt",
type: "timestamp",
description: "ワーキングメモリが最後に更新された日時",
constraints: [{ type: "nullable", value: false }],
},
]}
    />
  </TabItem>

  <TabItem value="ワークフロー" label="ワークフロー">
    ワークフローで `suspend` が呼び出されると、その状態は次の形式で保存されます。`resume` が呼び出されると、その状態が復元されます。

    <br />

    <SchemaTable
      columns={[
{
name: "workflow_name",
type: "text",
description: "ワークフロー名",
constraints: [{ type: "nullable", value: false }]
},
{
name: "run_id",
type: "uuidv4",
description: "ワークフロー実行の一意の識別子。suspend/resume の各サイクルをまたいで状態を追跡するために使用されます（形式: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`）",
constraints: [{ type: "nullable", value: false }]
},
{
name: "snapshot",
type: "text",
description: "ワークフロー状態を JSON でシリアライズしたもの。例:",
example: {
  value: { currentState: 'running' },
  context: {
    stepResults: {},
    attempts: {},
    triggerData: {}
  },
  activePaths: [],
  runId: '550e8400-e29b-41d4-a716-446655440000',
  timestamp: 1648176000000
},
constraints: [{ type: "nullable", value: false }]
},
{
name: "createdAt",
type: "timestamp",
constraints: [{ type: "nullable", value: false }]
},
{
name: "updatedAt",
type: "timestamp",
description: "最終更新時刻。ワークフロー実行中の状態変更を追跡するために使用されます",
constraints: [{ type: "nullable", value: false }]
}
]}
    />
  </TabItem>

  <TabItem value="評価" label="評価">
    エージェントの出力に対してメトリクスを実行した評価結果を保存します。

    <br />

    <SchemaTable
      columns={[
{
name: "input",
type: "text",
description: "エージェントに提供された入力",
constraints: [{ type: "nullable", value: false }]
},
{
name: "output",
type: "text",
description: "エージェントが生成した出力",
constraints: [{ type: "nullable", value: false }]
},
{
name: "result",
type: "jsonb",
description: "スコアと詳細を含む評価結果データ。例:",
example: {
  score: 0.95,
  details: {
    reason: "応答はソース資料を正確に反映しています",
    citations: ["page 1", "page 3"]
  }
},
constraints: [{ type: "nullable", value: false }]
},
{
name: "agent_name",
type: "text",
constraints: [{ type: "nullable", value: false }]
},
{
name: "metric_name",
type: "text",
description: "例: Faithfulness、Hallucination など",
constraints: [{ type: "nullable", value: false }]
},
{
name: "instructions",
type: "text",
description: "エージェント向けのシステムプロンプトまたは指示",
constraints: [{ type: "nullable", value: false }]
},
{
name: "test_info",
type: "jsonb",
description: "追加のテスト用メタデータおよび設定",
constraints: [{ type: "nullable", value: false }]
},
{
name: "global_run_id",
type: "uuidv4",
description: "関連する評価実行をグループ化（例: CI 実行内のすべてのユニットテスト）",
constraints: [{ type: "nullable", value: false }]
},
{
name: "run_id",
type: "uuidv4",
description: "評価対象の実行の一意の識別子（形式: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`）",
constraints: [{ type: "nullable", value: false }]
},
{
name: "created_at",
type: "timestamp",
constraints: [{ type: "nullable", value: false }]
}
]}
    />
  </TabItem>

  <TabItem value="トレース" label="トレース">
    OpenTelemetry のトレースを収集し、監視とデバッグに活用します。

    <br />

    <SchemaTable
      columns={[
{
name: "id",
type: "text",
description: "一意のトレース識別子",
constraints: [
  { type: "nullable", value: false },
  { type: "primaryKey" }
]
},
{
name: "parentSpanId",
type: "text",
description: "親スパンの ID。トップレベルのスパンの場合は null",
},
{
name: "name",
type: "text",
description: "階層的な操作名（例: `workflow.myWorkflow.execute`、`http.request`、`database.query`）",
constraints: [{ type: "nullable", value: false }],
},
{
name: "traceId",
type: "text",
description: "関連するスパンをまとめるルートトレース識別子",
constraints: [{ type: "nullable", value: false }]
},
{
name: "scope",
type: "text",
description: "スパンを作成したライブラリ/パッケージ/サービス（例: `@mastra/core`、`express`、`pg`）",
constraints: [{ type: "nullable", value: false }]
},
{
name: "kind",
type: "integer",
description: "`INTERNAL`（0、プロセス内）、`CLIENT`（1、送信呼び出し）、`SERVER`（2、受信呼び出し）、`PRODUCER`（3、非同期ジョブの作成）、`CONSUMER`（4、非同期ジョブの処理）",
constraints: [{ type: "nullable", value: false }]
},
{
name: "attributes",
type: "jsonb",
description: "スパンのメタデータを含むユーザー定義のキーと値のペア",
},
{
name: "status",
type: "jsonb",
description: "`code`（UNSET=0、ERROR=1、OK=2）と任意の `message` を含む JSON オブジェクト。例:",
example: {
  code: 1,
  message: "HTTP リクエストがステータス 500 で失敗しました"
}
},
{
name: "events",
type: "jsonb",
description: "スパンの実行中に発生したタイムスタンプ付きイベント",
},
{
name: "links",
type: "jsonb",
description: "他の関連スパンへのリンク",
},
{
name: "other",
type: "text",
description: "追加の OpenTelemetry スパンフィールドを文字列化した JSON。例:",
example: {
  droppedAttributesCount: 2,
  droppedEventsCount: 1,
  instrumentationLibrary: "@opentelemetry/instrumentation-http"
}
},
{
name: "startTime",
type: "bigint",
description: "スパン開始時点の Unix エポックからの経過ナノ秒",
constraints: [{ type: "nullable", value: false }]
},
{
name: "endTime",
type: "bigint",
description: "スパン終了時点の Unix エポックからの経過ナノ秒",
constraints: [{ type: "nullable", value: false }]
},
{
name: "createdAt",
type: "timestamp",
constraints: [{ type: "nullable", value: false }]
}
]}
    />
  </TabItem>
</Tabs>

<div id="querying-messages">
  ### メッセージの照会
</div>

メッセージは内部的に V2 形式で保存されており、概ね AI SDK の `UIMessage` 形式に相当します。`getMessages` を使ってメッセージを取得する際は、出力形式を指定できます。後方互換性のため、既定は `v1` です。

```typescript copy
// デフォルトのV1形式でメッセージを取得（AI SDKのCoreMessage形式とほぼ同等）
const messagesV1 = await mastra
  .getStorage()
  .getMessages({ threadId: "your-thread-id" });

// V2形式でメッセージを取得（AI SDKのUIMessage形式とほぼ同等）
const messagesV2 = await mastra
  .getStorage()
  .getMessages({ threadId: "your-thread-id", format: "v2" });
```

メッセージIDの配列を使ってメッセージを取得することもできます。`getMessages` と異なり、こちらはデフォルトで V2 形式です。

```typescript copy
const messagesV1 = await mastra
  .getStorage()
  .getMessagesById({ messageIds: messageIdArr, format: "v1" });

const messagesV2 = await mastra
  .getStorage()
  .getMessagesById({ messageIds: messageIdArr });
```


<div id="storage-providers">
  ## ストレージプロバイダー
</div>

Mastra は次のプロバイダーをサポートしています：

- ローカル開発には [LibSQL Storage](/reference/storage/libsql) をご確認ください
- 本番環境には [PostgreSQL Storage](/reference/storage/postgresql) をご確認ください
- サーバーレスデプロイには [Upstash Storage](/reference/storage/upstash) をご確認ください
- ドキュメント指向ストレージには [MongoDB Storage](/reference/storage/mongodb) をご確認ください