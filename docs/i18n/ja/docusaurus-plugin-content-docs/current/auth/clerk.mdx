---
title: "MastraAuthClerk クラス | 認証 | Mastra ドキュメント"
description: "Clerk 認証を用いて Mastra アプリケーションを認証する MastraAuthClerk クラスのドキュメント。"
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";


<div id="mastraauthclerk-class">
  # MastraAuthClerk クラス
</div>

`MastraAuthClerk` クラスは、Clerk を用いて Mastra の認証を提供します。Clerk の認証システムで受信リクエストを検証し、`experimental_auth` オプションを介して Mastra サーバーと統合します。

<div id="prerequisites">
  ## 前提条件
</div>

この例では Clerk の認証を使用します。.env ファイルに Clerk の認証情報を追加し、Clerk プロジェクトが正しく設定されていることを確認してください。

```env title=".env" copy
CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_JWKS_URI=https://your-clerk-domain.clerk.accounts.dev/.well-known/jwks.json
```

> **注:** これらのキーは Clerk ダッシュボードの「API Keys」で確認できます。


<div id="installation">
  ## インストール
</div>

`MastraAuthClerk` クラスを使用する前に、`@mastra/auth-clerk` パッケージをインストールする必要があります。

```bash copy
npm install @mastra/auth-clerk@latest
```


<div id="usage-example">
  ## 使用例
</div>

```typescript {2,7-11} title="src/mastra/index.ts" showLineNumbers copy
import { Mastra } from "@mastra/core/mastra";
import { MastraAuthClerk } from "@mastra/auth-clerk";

export const mastra = new Mastra({
  // ..
  server: {
    experimental_auth: new MastraAuthClerk({
      publishableKey: process.env.CLERK_PUBLISHABLE_KEY,
      secretKey: process.env.CLERK_SECRET_KEY,
      jwksUri: process.env.CLERK_JWKS_URI,
    }),
  },
});
```

> **注:** 既定の `authorizeUser` メソッドは、認証済みユーザーをすべて許可します。ユーザーの認可をカスタマイズするには、プロバイダーを構成する際にカスタムの `authorizeUser` 関数を指定してください。

> 利用可能なすべての設定オプションについては、[MastraAuthClerk](/reference/auth/clerk) の API リファレンスを参照してください。


<div id="client-side-setup">
  ## クライアント側のセットアップ
</div>

Clerk 認証を利用する場合は、クライアント側で Clerk からアクセストークンを取得し、それを Mastra へのリクエストに渡す必要があります。

<div id="retrieving-the-access-token">
  ### アクセストークンの取得
</div>

Clerk の React フックを使ってユーザーを認証し、アクセストークンを取得します:

```typescript title="lib/auth.ts" showLineNumbers copy
import { useAuth } from "@clerk/nextjs";

export const useClerkAuth = () => {
  const { getToken } = useAuth();

  const getAccessToken = async () => {
    const token = await getToken();
    return token;
  };

  return { getAccessToken };
};
```

> 詳細は [Clerk のドキュメント](https://clerk.com/docs)をご参照ください。


<div id="configuring-mastraclient">
  ## `MastraClient` の設定
</div>

`experimental_auth` が有効な場合、`MastraClient` で行うすべてのリクエストには、`Authorization` ヘッダーに有効な Clerk のアクセストークンを含める必要があります。

```typescript {6} title="lib/mastra/mastra-client.ts" showLineNumbers copy
import { MastraClient } from "@mastra/client-js";

export const mastraClient = new MastraClient({
  baseUrl: "https://<mastra-api-url>",
  headers: {
    Authorization: `Bearer ${accessToken}`,
  },
});
```

> 注意: Authorization ヘッダーのアクセス トークンには `Bearer` を付与する必要があります。
> さらに詳しい設定オプションについては、[Mastra Client SDK](/docs/server-db/mastra-client) をご覧ください。


<div id="making-authenticated-requests">
  ### 認証リクエストの送信
</div>

`MastraClient` に Clerk のアクセストークンを設定すると、認証済みリクエストを送信できます。

<Tabs>
  <TabItem value="react" label="React">
    ```tsx title="src/components/test-agent.tsx" showLineNumbers copy
    "use client";

    import { useAuth } from "@clerk/nextjs";
    import { MastraClient } from "@mastra/client-js";

    export const TestAgent = () => {
      const { getToken } = useAuth();

      async function handleClick() {
        const token = await getToken();

        const client = new MastraClient({
          baseUrl: "http://localhost:4111",
          headers: token ? { Authorization: `Bearer ${token}` } : undefined,
        });

        const weatherAgent = client.getAgent("weatherAgent");
        const response = await weatherAgent.generate({
          messages: "ニューヨークの天気は？",
        });

        console.log({ response });
      }

      return <button onClick={handleClick}>Test Agent</button>;
    };
    ```

  </TabItem>
  <TabItem value="curl" label="cURL">
    ```bash copy
    curl -X POST http://localhost:4111/api/agents/weatherAgent/generate \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer <your-clerk-access-token>" \
      -d '{
        "messages": "ロンドンの天気"
      }'
    ```
  </TabItem>
</Tabs>