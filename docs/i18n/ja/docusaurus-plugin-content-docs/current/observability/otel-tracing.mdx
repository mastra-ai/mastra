---
title: "OTEL トレーシング | オブザーバビリティ | Mastra ドキュメント"
description: "Mastra アプリケーションで OpenTelemetry トレーシングを設定する"
---

<div id="otel-tracing">
  # OTEL トレーシング
</div>

Mastra はアプリケーションのトレーシングと監視のために OpenTelemetry Protocol (OTLP) をサポートしています。テレメトリを有効化すると、Mastra はエージェントの操作、LLM との対話、ツールの実行、連携（インテグレーション）の呼び出し、ワークフローの実行、データベース操作など、すべてのコア・プリミティブを自動的にトレースします。テレメトリ データは任意の OTEL コレクターへエクスポートできます。

<div id="basic-configuration">
  ### 基本設定
</div>

テレメトリーを有効にする簡単な例を次に示します：

```ts title="mastra.config.ts" showLineNumbers copy
export const mastra = new Mastra({
  // ... その他の設定
  telemetry: {
    serviceName: "my-app",
    enabled: true,
    sampling: {
      type: "always_on",
    },
    export: {
      type: "otlp",
      endpoint: "http://localhost:4318", // SigNoz ローカルエンドポイント
    },
  },
});
```


<div id="configuration-options">
  ### 設定オプション
</div>

telemetry の設定では次のプロパティを指定できます:

```ts
type OtelConfig = {
  // トレース内でサービスを識別するための名前（オプション）
  serviceName?: string;

  // テレメトリの有効化/無効化（デフォルトはtrue）
  enabled?: boolean;

  // サンプリングするトレースの数を制御
  sampling?: {
    type: "ratio" | "always_on" | "always_off" | "parent_based";
    probability?: number; // 比率サンプリング用
    root?: {
      probability: number; // 親ベースサンプリング用
    };
  };

  // テレメトリデータの送信先
  export?: {
    type: "otlp" | "console";
    endpoint?: string;
    headers?: Record<string, string>;
  };
};
```

詳細は、上記のインライン型定義をご参照ください。


<div id="environment-variables">
  ### 環境変数
</div>

OTLP のエンドポイントとヘッダーは、環境変数で設定できます。

```env title=".env" copy
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
OTEL_EXPORTER_OTLP_HEADERS=x-api-key=your-api-key
```

次に、あなたのconfigで:

```ts title="mastra.config.ts" showLineNumbers copy
export const mastra = new Mastra({
  // ... その他の設定
  telemetry: {
    serviceName: "my-app",
    enabled: true,
    export: {
      type: "otlp",
      // エンドポイントとヘッダーは環境変数から取得されます
    },
  },
});
```


<div id="example-signoz-integration">
  ### 例: SigNoz との連携
</div>

[SigNoz](https://signoz.io) では、トレースされたエージェントのやり取りは次のように表示されます:

<img
  src="/img/signoz-telemetry-demo.png"
  alt="エージェントのやり取りのトレース。スパン、LLM 呼び出し、ツール実行を表示"
  style={{ maxWidth: "800px", width: "100%", margin: "8px 0" }}
  className="nextra-image rounded-md"
  data-zoom
  width={800}
  height={400}
/>

<div id="other-supported-providers">
  ### その他の対応プロバイダー
</div>

Mastra は Datadog、New Relic、Jaeger など、OTLP 互換のオブザーバビリティプラットフォームを幅広くサポートしています。上記と同じ OTLP エンドポイントのパターンで設定してください。

<div id="custom-instrumentation-files">
  ### カスタムインストルメンテーションファイル
</div>

Mastra プロジェクトでは、`/mastra` フォルダに配置することでカスタムのインストルメンテーションファイルを定義できます。Mastra はデフォルトのインストルメンテーションではなく、これらのファイルを自動的に検出してバンドルします。

<div id="supported-file-types">
  #### 対応しているファイルタイプ
</div>

Mastra は、次の拡張子を持つインストルメンテーション用ファイルを探します:

- `instrumentation.js`
- `instrumentation.ts`
- `instrumentation.mjs`

<div id="example">
  #### 例
</div>

```ts title="/mastra/instrumentation.ts" showLineNumbers copy
import { NodeSDK } from "@opentelemetry/sdk-node";
import { getNodeAutoInstrumentations } from "@opentelemetry/auto-instrumentations-node";
import { OTLPTraceExporter } from "@opentelemetry/exporter-trace-otlp-http";

const sdk = new NodeSDK({
  traceExporter: new OTLPTraceExporter({
    url: "http://localhost:4318/v1/traces",
  }),
  instrumentations: [getNodeAutoInstrumentations()],
});

sdk.start();
```

Mastra がカスタムのインストルメンテーションファイルを検出すると、デフォルトのインストルメンテーションを自動的に置き換え、ビルド時にバンドルします。


<div id="tracing-outside-mastra-server-environment">
  ### Mastra サーバー環境外でのトレース
</div>

`mastra start` や `mastra dev` コマンドを使用すると、Mastra はトレースに必要なインストルメンテーションファイルを自動的に用意して読み込みます。ただし、Mastra を自分のアプリケーションの依存関係として使用する場合（Mastra サーバー環境外）には、インストルメンテーションファイルを手動で提供する必要があります。

この場合にトレースを有効化するには:

1. 設定で Mastra のテレメトリーを有効にします:

```typescript
export const mastra = new Mastra({
  telemetry: {
    enabled: true,
  },
});
```

2. プロジェクト内にインストルメンテーション用ファイルを作成します（例: `instrumentation.mjs`）:

```typescript
import { NodeSDK } from "@opentelemetry/sdk-node";
import { getNodeAutoInstrumentations } from "@opentelemetry/auto-instrumentations-node";
import { OTLPTraceExporter } from "@opentelemetry/exporter-trace-otlp-http";

const sdk = new NodeSDK({
  traceExporter: new OTLPTraceExporter(),
  instrumentations: [getNodeAutoInstrumentations()],
});

sdk.start();
```

3. OpenTelemetry の環境変数を追加する:

```bash
OTEL_EXPORTER_OTLP_ENDPOINT=https://api.braintrust.dev/otel
OTEL_EXPORTER_OTLP_HEADERS="Authorization=Bearer <APIキー>, x-bt-parent=project_name:<プロジェクト名>"
```

4. アプリケーションを起動する前に OpenTelemetry SDK を実行します:

```bash
node --import=./instrumentation.mjs --import=@opentelemetry/instrumentation/hook.mjs src/index.js
```


<div id="nextjs-specific-tracing-steps">
  ### Next.js 特有のトレーシング手順
</div>

Next.js を使用している場合は、次の 3 つの追加設定が必要です:

1. `next.config.ts` で instrumentation フックを有効にする
2. Mastra のテレメトリー設定を行う
3. OpenTelemetry エクスポーターを設定する

実装の詳細は、[Next.js のトレーシング](./nextjs-tracing) ガイドを参照してください。