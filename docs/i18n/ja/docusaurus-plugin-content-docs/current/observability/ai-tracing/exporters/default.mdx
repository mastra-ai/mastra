---
title: "デフォルトエクスポーター | AI トレーシング | 可観測性 | Mastra ドキュメント"
description: "開発・デバッグ用途にトレースをローカル保存する"
---

<div id="default-exporter">
  # デフォルトエクスポーター
</div>

`DefaultExporter` はトレースを設定済みのストレージバックエンドに保存し、Mastra Playground から参照できるようにします。デフォルトのオブザーバビリティ構成を使用している場合は自動的に有効になり、外部サービスは不要です。

<div id="when-to-use-defaultexporter">
  ## DefaultExporter を使うべきとき
</div>

DefaultExporter は次の用途に最適です:

- **ローカル開発** - トレースをオフラインでデバッグ・分析
- **データの所有** - トレースデータを完全にコントロール
- **依存関係なし** - 外部サービスは不要
- **Playground との統合** - Mastra Playground の UI でトレースを表示

<div id="configuration">
  ## 設定
</div>

<div id="prerequisites">
  ### 前提条件
</div>

1. **ストレージバックエンド**: ストレージプロバイダー（LibSQL、PostgreSQL など）を設定する
2. **Mastra Playground**: ローカルでトレースを確認できるようインストールする

<div id="basic-setup">
  ### 基本的な設定
</div>

```typescript title="src/mastra/index.ts"
import { Mastra } from "@mastra/core";
import { DefaultExporter } from "@mastra/core/ai-tracing";
import { LibSQLStore } from "@mastra/libsql";

export const mastra = new Mastra({
  storage: new LibSQLStore({
    url: "file:./mastra.db", // トレースの永続化に必要
  }),
  observability: {
    configs: {
      local: {
        serviceName: "my-service",
        exporters: [new DefaultExporter()],
      },
    },
  },
});
```


<div id="automatic-configuration">
  ### 自動設定
</div>

デフォルトのオブザーバビリティ設定を使用する場合、DefaultExporter が自動的に含まれます。

```typescript
export const mastra = new Mastra({
  storage: new LibSQLStore({
    url: "file:./mastra.db",
  }),
  observability: {
    default: { enabled: true }, // DefaultExporterが自動的に含まれます
  },
});
```


<div id="viewing-traces">
  ## トレースの閲覧
</div>

<div id="mastra-playground">
  ### Mastra Playground
</div>

ローカルのPlaygroundからトレースにアクセスします：

1. Playground を起動する
2. Observability に移動する
3. ローカルのトレースをフィルタリング・検索する
4. スパンの詳細を確認する

<div id="tracing-strategies">
  ## トレース戦略
</div>

DefaultExporter は、利用しているストレージプロバイダーに応じて、最適なトレース戦略を自動的に選択します。必要に応じて、この選択を手動で上書きすることも可能です。

<div id="available-strategies">
  ### 利用可能な戦略
</div>

| 戦略                   | 説明                                         | ユースケース                 |
| ---------------------- | -------------------------------------------- | ---------------------------- |
| **realtime**           | 各イベントを即時に処理する                   | 開発・デバッグ・低トラフィック |
| **batch-with-updates** | イベントをバッファし、ライフサイクル全体に対応したバッチ書き込みを行う | 低トラフィックの本番環境     |
| **insert-only**        | 完了したスパンのみを処理し、更新は無視する   | 高トラフィックの本番環境     |

<div id="strategy-configuration">
  ### ストラテジー設定
</div>

```typescript
new DefaultExporter({
  strategy: "auto", // デフォルト - ストレージプロバイダーに決定を任せる
  // または明示的に設定:
  // strategy: 'realtime' | 'batch-with-updates' | 'insert-only'

  // バッチ処理の設定(batch-with-updatesとinsert-onlyの両方に適用)
  maxBatchSize: 1000, // バッチあたりの最大スパン数
  maxBatchWaitMs: 5000, // フラッシュ前の最大待機時間
  maxBufferSize: 10000, // バッファする最大スパン数
});
```


<div id="storage-provider-support">
  ## ストレージプロバイダーのサポート
</div>

ストレージプロバイダーによって対応するトレーシング戦略は異なります。

strategy を `'auto'` に設定すると、`DefaultExporter` がストレージプロバイダーに最適な戦略を自動選択します。ストレージプロバイダーがサポートしていないモードに strategy を設定すると、エラーメッセージが表示されます。

| ストレージプロバイダー                            | 推奨戦略             | サポートされる戦略                           | 注記                                  |
| ------------------------------------------------ | -------------------- | ------------------------------------------- | ------------------------------------- |
| **[LibSQL](/reference/storage/libsql)**          | batch-with-updates   | realtime, batch-with-updates, insert-only   | 既定のストレージ。開発に適しています |
| **[PostgreSQL](/reference/storage/postgresql)**  | batch-with-updates   | batch-with-updates, insert-only             | 本番環境に推奨                        |

<div id="strategy-benefits">
  ### 戦略のメリット
</div>

- **realtime**: 即時に可視化でき、デバッグに最適
- **batch-with-updates**: スループットが10〜100倍に向上し、スパンのライフサイクルを完全にカバー
- **insert-only**: データベース操作をさらに70%削減し、分析に最適

<div id="batching-behavior">
  ## バッチ化の挙動
</div>

<div id="flush-triggers">
  ### フラッシュトリガー
</div>

両方のバッチ戦略（`batch-with-updates` と `insert-only`）では、次のいずれかの条件を満たすとトレースはストレージにフラッシュされます：

1. **サイズトリガー**：バッファが `maxBatchSize` スパンに到達したとき
2. **時間トリガー**：最初のイベントから `maxBatchWaitMs` 経過したとき
3. **緊急フラッシュ**：バッファが `maxBufferSize` の上限に近づいたとき
4. **シャットダウン**：保留中のすべてのイベントを強制的にフラッシュ

<div id="error-handling">
  ### エラー処理
</div>

DefaultExporter は本番環境向けに堅牢なエラー処理を備えています:

- **再試行ロジック**: 指数バックオフ（500ms、1s、2s、4s）
- **一時的な障害**: バックオフ付きで自動再試行
- **永続的な障害**: 4回失敗した後にバッチを破棄
- **バッファオーバーフロー**: ストレージ障害時のメモリ問題を防止

<div id="configuration-examples">
  ### 設定例
</div>

```typescript
// 設定不要 - ほとんどのユーザーに推奨
new DefaultExporter();

// 開発環境でのオーバーライド
new DefaultExporter({
  strategy: "realtime", // デバッグ用の即時表示
});

// 高スループット本番環境
new DefaultExporter({
  maxBatchSize: 2000, // より大きなバッチサイズ
  maxBatchWaitMs: 10000, // バッチを満たすまで長く待機
  maxBufferSize: 50000, // 長時間の停止に対応
});

// 低レイテンシ本番環境
new DefaultExporter({
  maxBatchSize: 100, // より小さなバッチサイズ
  maxBatchWaitMs: 1000, // 素早くフラッシュ
});
```


<div id="related">
  ## 関連項目
</div>

- [AI トレーシングの概要](/docs/observability/ai-tracing/overview)
- [CloudExporter](/docs/observability/ai-tracing/exporters/cloud)
- [ストレージの設定](/docs/server-db/storage)