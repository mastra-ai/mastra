---
title: "リファレンス: インターフェース | オブザーバビリティ | Mastra ドキュメント"
description: AI トレーシングの型定義とインターフェース
---

import PropertiesTable from "@site/src/components/PropertiesTable";


<div id="interfaces">
  # インターフェイス
</div>

<div id="core-interfaces">
  ## コア・インターフェース
</div>

<div id="aitracing">
  ### AITracing
</div>

AI Tracing の主要なインターフェイス。

```typescript
interface AITracing {
  /** 現在の設定を取得 */
  getConfig(): Readonly<Required<TracingConfig>>;

  /** すべてのエクスポーターを取得 */
  getExporters(): readonly AITracingExporter[];

  /** すべてのプロセッサーを取得 */
  getProcessors(): readonly AISpanProcessor[];

  /** ロガーインスタンスを取得(エクスポーターおよびその他のコンポーネント用) */
  getLogger(): IMastraLogger;

  /** 特定のAISpanTypeの新しいスパンを開始 */
  startSpan<TType extends AISpanType>(
    options: StartSpanOptions<TType>,
  ): AISpan<TType>;

  /** AIトレーシングをシャットダウンしてリソースをクリーンアップ */
  shutdown(): Promise<void>;
}
```


<div id="aispantypemap">
  ### AISpanTypeMap
</div>

スパン種別と、それに対応する属性インターフェースのマッピング。

```typescript
interface AISpanTypeMap {
  AGENT_RUN: AgentRunAttributes;
  WORKFLOW_RUN: WorkflowRunAttributes;
  MODEL_GENERATION: ModelGenerationAttributes;
  MODEL_STEP: ModelStepAttributes;
  MODEL_CHUNK: ModelChunkAttributes;
  TOOL_CALL: ToolCallAttributes;
  MCP_TOOL_CALL: MCPToolCallAttributes;
  WORKFLOW_STEP: WorkflowStepAttributes;
  WORKFLOW_CONDITIONAL: WorkflowConditionalAttributes;
  WORKFLOW_CONDITIONAL_EVAL: WorkflowConditionalEvalAttributes;
  WORKFLOW_PARALLEL: WorkflowParallelAttributes;
  WORKFLOW_LOOP: WorkflowLoopAttributes;
  WORKFLOW_SLEEP: WorkflowSleepAttributes;
  WORKFLOW_WAIT_EVENT: WorkflowWaitEventAttributes;
  GENERIC: AIBaseAttributes;
}
```

このマッピングは、スパンの作成や処理の際に、各スパン種別で使用される属性インターフェースを定義します。


<div id="aispan">
  ### AISpan
</div>

内部でトレース用途に用いられる AI Span インターフェース。

```typescript
interface AISpan<TType extends AISpanType> {
  readonly id: string;
  readonly traceId: string;
  readonly type: TType;
  readonly name: string;

  /** 内部スパンかどうか (mastraの内部操作用スパン) */
  isInternal: boolean;

  /** 親スパンへの参照 (ルートスパンの場合はundefined) */
  parent?: AnyAISpan;

  /** AITracingインスタンスへのポインタ */
  aiTracing: AITracing;

  attributes?: AISpanTypeMap[TType];
  metadata?: Record<string, any>;
  input?: any;
  output?: any;
  errorInfo?: any;

  /** スパンを終了 */
  end(options?: EndSpanOptions<TType>): void;

  /** スパンのエラーを記録し、オプションでスパンを終了 */
  error(options: ErrorSpanOptions<TType>): void;

  /** スパン属性を更新 */
  update(options: UpdateSpanOptions<TType>): void;

  /** 子スパンを作成 - 親とは独立して任意のスパンタイプを指定可能 */
  createChildSpan<TChildType extends AISpanType>(
    options: ChildSpanOptions<TChildType>,
  ): AISpan<TChildType>;

  /** イベントスパンを作成 - 親とは独立して任意のスパンタイプを指定可能 */
  createEventSpan<TChildType extends AISpanType>(
    options: ChildEventOptions<TChildType>,
  ): AISpan<TChildType>;

  /** トレースのルートスパンである場合にTRUEを返す */
  get isRootSpan(): boolean;

  /** 有効なスパンである場合にTRUEを返す (NO-OPスパンではない) */
  get isValid(): boolean;
}
```


<div id="aitracingexporter">
  ### AITracingExporter
</div>

トレーシングエクスポーター用のインターフェース。

```typescript
interface AITracingExporter {
  /** エクスポーター名 */
  name: string;

  /** エクスポーターを初期化（すべての依存関係の準備完了後に呼び出される） */
  init?(): void;

  /** トレーシングイベントをエクスポート */
  exportEvent(event: AITracingEvent): Promise<void>;

  /** エクスポーターをシャットダウン */
  shutdown(): Promise<void>;
}
```


<div id="aispanprocessor">
  ### AISpanProcessor
</div>

スパンプロセッサ用のインターフェース。

```typescript
interface AISpanProcessor {
  /** プロセッサー名 */
  name: string;

  /** エクスポート前にスパンを処理する */
  process(span?: AnyAISpan): AnyAISpan | undefined;

  /** プロセッサーをシャットダウンする */
  shutdown(): Promise<void>;
}
```


<div id="span-types">
  ## スパンのタイプ
</div>

<div id="aispantype">
  ### AISpanType
</div>

AI 固有のスパンタイプと、それに付随するメタデータ。

```typescript
enum AISpanType {
  /** エージェント実行 - エージェントプロセスのルートスパン */
  AGENT_RUN = "agent_run",

  /** カスタム操作用の汎用スパン */
  GENERIC = "generic",

  /** モデル生成 - モデル呼び出し、トークン使用量、プロンプト、補完を含む */
  MODEL_GENERATION = "model_generation",

  /** 生成内の単一モデル実行ステップ(1回のAPI呼び出し) */
  MODEL_STEP = "model_step",

  /** 個別のモデルストリーミングチャンク/イベント */
  MODEL_CHUNK = "model_chunk",

  /** MCP(Model Context Protocol)ツール実行 */
  MCP_TOOL_CALL = "mcp_tool_call",

  /** 関数/ツール実行 - 入力、出力、エラーを含む */
  TOOL_CALL = "tool_call",

  /** ワークフロー実行 - ワークフロープロセスのルートスパン */
  WORKFLOW_RUN = "workflow_run",

  /** ワークフローステップ実行 - ステップステータス、データフローを含む */
  WORKFLOW_STEP = "workflow_step",

  /** ワークフロー条件分岐実行 - 条件評価を含む */
  WORKFLOW_CONDITIONAL = "workflow_conditional",

  /** 条件分岐内の個別の条件評価 */
  WORKFLOW_CONDITIONAL_EVAL = "workflow_conditional_eval",

  /** ワークフロー並列実行 */
  WORKFLOW_PARALLEL = "workflow_parallel",

  /** ワークフローループ実行 */
  WORKFLOW_LOOP = "workflow_loop",

  /** ワークフロースリープ操作 */
  WORKFLOW_SLEEP = "workflow_sleep",

  /** ワークフローイベント待機操作 */
  WORKFLOW_WAIT_EVENT = "workflow_wait_event",
}
```


<div id="anyaispan">
  ### AnyAISpan
</div>

あらゆるスパンを扱う必要がある場合に用いるユニオン型。

```typescript
type AnyAISpan = AISpan<keyof AISpanTypeMap>;
```


<div id="span-attributes">
  ## span 属性
</div>

<div id="agentrunattributes">
  ### AgentRunAttributes
</div>

Agent Run の属性。

```typescript
interface AgentRunAttributes {
  /** エージェント識別子 */
  agentId: string;

  /** エージェントへの指示 */
  instructions?: string;

  /** エージェントプロンプト */
  prompt?: string;

  /** この実行で使用可能なツール */
  availableTools?: string[];

  /** 最大ステップ数 */
  maxSteps?: number;
}
```


<div id="modelgenerationattributes">
  ### ModelGenerationAttributes
</div>

モデル生成の属性。

```typescript
interface ModelGenerationAttributes {
  /** モデル名（例：'gpt-4'、'claude-3'） */
  model?: string;

  /** モデルプロバイダー（例：'openai'、'anthropic'） */
  provider?: string;

  /** このモデル呼び出しが生成した結果・出力のタイプ */
  resultType?:
    | "tool_selection"
    | "response_generation"
    | "reasoning"
    | "planning";

  /** トークン使用量の統計 */
  usage?: {
    promptTokens?: number;
    completionTokens?: number;
    totalTokens?: number;
    promptCacheHitTokens?: number;
    promptCacheMissTokens?: number;
  };

  /** モデルのパラメータ */
  parameters?: {
    maxOutputTokens?: number;
    temperature?: number;
    topP?: number;
    topK?: number;
    presencePenalty?: number;
    frequencyPenalty?: number;
    stopSequences?: string[];
    seed?: number;
    maxRetries?: number;
  };

  /** ストリーミングレスポンスかどうか */
  streaming?: boolean;

  /** 生成が終了した理由 */
  finishReason?: string;
}
```


<div id="modelstepattributes">
  ### ModelStepAttributes
</div>

モデルステップ属性 — 1 回の生成プロセス内における単一のモデル実行に関する属性。

```typescript
interface ModelStepAttributes {
  /** 生成処理におけるこのステップのインデックス (0, 1, 2, ...) */
  stepIndex?: number;

  /** トークン使用量の統計 */
  usage?: UsageStats;

  /** このステップが終了した理由 (stop, tool-calls, length など) */
  finishReason?: string;

  /** 実行を継続するかどうか */
  isContinued?: boolean;

  /** 結果に関する警告 */
  warnings?: Record<string, any>;
}
```


<div id="modelchunkattributes">
  ### ModelChunkAttributes
</div>

Model Chunk の属性 — 個々のストリーミングチャンク／イベント用。

```typescript
interface ModelChunkAttributes {
  /** チャンクの種類 (text-delta、reasoning-delta、tool-call など) */
  chunkType?: string;

  /** ストリーム内でのこのチャンクの順序番号 */
  sequenceNumber?: number;
}
```


<div id="toolcallattributes">
  ### ToolCallAttributes
</div>

ツール呼び出しの属性。

```typescript
interface ToolCallAttributes {
  toolId?: string;
  toolType?: string;
  toolDescription?: string;
  success?: boolean;
}
```


<div id="mcptoolcallattributes">
  ### MCPToolCallAttributes
</div>

MCP ツール呼び出しの属性。

```typescript
interface MCPToolCallAttributes {
  /** MCPツール/関数のID */
  toolId: string;

  /** MCPサーバー識別子 */
  mcpServer: string;

  /** MCPサーバーバージョン */
  serverVersion?: string;

  /** ツール実行が成功したかどうか */
  success?: boolean;
}
```


<div id="workflowrunattributes">
  ### WorkflowRunAttributes
</div>

Workflow Run の属性。

```typescript
interface WorkflowRunAttributes {
  /** ワークフロー識別子 */
  workflowId: string;

  /** ワークフローのバージョン */
  workflowVersion?: string;

  /** ワークフロー実行ID */
  runId?: string;

  /** ワークフロー実行の最終ステータス */
  status?: WorkflowRunStatus;
}
```


<div id="workflowstepattributes">
  ### WorkflowStepAttributes
</div>

ワークフローステップの属性。

```typescript
interface WorkflowStepAttributes {
  /** ステップ識別子 */
  stepId?: string;

  /** ステップの種類 */
  stepType?: string;

  /** ステップのステータス */
  status?: WorkflowStepStatus;

  /** ステップの実行順序 */
  stepNumber?: number;

  /** 結果格納キー */
  resultKey?: string;
}
```


<div id="options-types">
  ## オプションの種類
</div>

<div id="startspanoptions">
  ### StartSpanOptions
</div>

新しいスパンを開始する際のオプション。

```typescript
interface StartSpanOptions<TType extends AISpanType> {
  /** スパンの種類 */
  type: TType;

  /** スパン名 */
  name: string;

  /** スパンの属性 */
  attributes?: AISpanTypeMap[TType];

  /** スパンのメタデータ */
  metadata?: Record<string, any>;

  /** 入力データ */
  input?: any;

  /** 親スパン */
  parent?: AnyAISpan;

  /** ポリシーレベルのトレース設定 */
  tracingPolicy?: TracingPolicy;

  /** カスタムサンプラー戦略使用時に渡すオプション */
  customSamplerOptions?: CustomSamplerOptions;
}
```


<div id="updatespanoptions">
  ### UpdateSpanOptions
</div>

スパン更新用のオプション。

```typescript
interface UpdateSpanOptions<TType extends AISpanType> {
  /** スパン属性 */
  attributes?: Partial<AISpanTypeMap[TType]>;

  /** スパンのメタデータ */
  metadata?: Record<string, any>;

  /** 入力データ */
  input?: any;

  /** 出力データ */
  output?: any;
}
```


<div id="endspanoptions">
  ### EndSpanOptions
</div>

スパンを終了するためのオプション。

```typescript
interface EndSpanOptions<TType extends AISpanType> {
  /** 出力データ */
  output?: any;

  /** スパンメタデータ */
  metadata?: Record<string, any>;

  /** スパン属性 */
  attributes?: Partial<AISpanTypeMap[TType]>;
}
```


<div id="errorspanoptions">
  ### ErrorSpanOptions
</div>

スパンのエラーを記録するためのオプション。

```typescript
interface ErrorSpanOptions<TType extends AISpanType> {
  /** 問題に関連付けられたエラー */
  error: Error;

  /** true の場合はスパンを終了 */
  endSpan?: boolean;

  /** スパンメタデータ */
  metadata?: Record<string, any>;

  /** スパン属性 */
  attributes?: Partial<AISpanTypeMap[TType]>;
}
```


<div id="context-types">
  ## コンテキストの型
</div>

<div id="tracingcontext">
  ### TracingContext
</div>

ワークフローやエージェントの実行全体を通じて受け渡される、AIトレーシング用のコンテキスト。

```typescript
interface TracingContext {
  /** 子スパンの作成とメタデータ追加用の現在のAIスパン */
  currentSpan?: AnyAISpan;
}
```


<div id="tracingproperties">
  ### TracingProperties
</div>

トレースを外部で扱うためにユーザーに返されるプロパティ。

```typescript
type TracingProperties = {
  /** 実行時に使用されるトレースID（実行がトレースされている場合） */
  traceId?: string;
};
```


<div id="tracingoptions">
  ### TracingOptions
</div>

新しいエージェントまたはワークフローの実行を開始する際に渡すオプション。

```typescript
interface TracingOptions {
  /** ルートトレーススパンに追加するメタデータ */
  metadata?: Record<string, any>;
}
```


<div id="tracingpolicy">
  ### TracingPolicy
</div>

ワークフローまたはエージェントの作成時に適用される、ポリシーレベルのトレース設定。

```typescript
interface TracingPolicy {
  /**
   * ワークフローまたはエージェント実行において、異なるタイプのスパンを
   * Internal として設定するためのビット単位オプション。Internal スパンは
   * エクスポートされたトレースでデフォルトで非表示になります。
   */
  internal?: InternalSpans;
}
```


<div id="configuration-types">
  ## 設定の種類
</div>

<div id="tracingconfig">
  ### TracingConfig
</div>

単一のトレーシングインスタンス用の設定。

```typescript
interface TracingConfig {
  /** AIトレーシングレジストリにおけるこの設定の一意識別子 */
  name: string;

  /** トレーシングのサービス名 */
  serviceName: string;

  /** サンプリング戦略 - トレーシングを収集するかどうかを制御します(デフォルトはALWAYS) */
  sampling?: SamplingStrategy;

  /** カスタムエクスポーター */
  exporters?: AITracingExporter[];

  /** カスタムプロセッサー */
  processors?: AISpanProcessor[];

  /** mastraの内部動作のスパンを表示する場合はtrueに設定してください */
  includeInternalSpans?: boolean;
}
```


<div id="observabilityregistryconfig">
  ### ObservabilityRegistryConfig
</div>

AI トレースのレジストリ設定一式。

```typescript
interface ObservabilityRegistryConfig {
  /** デフォルトのエクスポーターを有効にします。サンプリングは常時実行され、機密データのフィルタリングが適用されます */
  default?: {
    enabled?: boolean;
  };

  /** トレーシングインスタンス名とその設定、または事前インスタンス化されたインスタンスのマップ */
  configs?: Record<string, Omit<TracingConfig, "name"> | AITracing>;

  /** 使用するトレーシングインスタンスを選択するオプションのセレクター関数 */
  configSelector?: ConfigSelector;
}
```


<div id="sampling-types">
  ## サンプリング方式
</div>

<div id="samplingstrategy">
  ### SamplingStrategy
</div>

サンプリング戦略の構成。

```typescript
type SamplingStrategy =
  | { type: "always" }
  | { type: "never" }
  | { type: "ratio"; probability: number }
  | { type: "custom"; sampler: (options?: CustomSamplerOptions) => boolean };
```


<div id="customsampleroptions">
  ### CustomSamplerOptions
</div>

カスタムサンプラー戦略を使用する際に渡すオプション。

```typescript
interface CustomSamplerOptions {
  runtimeContext?: RuntimeContext;
  metadata?: Record<string, any>;
}
```


<div id="config-selector-types">
  ## 設定セレクターの種類
</div>

<div id="configselector">
  ### ConfigSelector
</div>

特定のスパンに対して使用する AI トレーシングインスタンスを選択するための関数。

```typescript
type ConfigSelector = (
  options: ConfigSelectorOptions,
  availableConfigs: ReadonlyMap<string, AITracing>,
) => string | undefined;
```


<div id="configselectoroptions">
  ### ConfigSelectorOptions
</div>

カスタムのトレーシング設定セレクターを使用する際に渡すオプション。

```typescript
interface ConfigSelectorOptions {
  /** ランタイムコンテキスト */
  runtimeContext?: RuntimeContext;
}
```


<div id="internal-spans">
  ## 内部のスパン
</div>

<div id="internalspans">
  ### InternalSpans
</div>

ワークフローやエージェントの実行において、各種スパンを内部扱いに設定するためのビット単位オプション。

```typescript
enum InternalSpans {
  /** スパンは内部としてマークされない */
  NONE = 0,

  /** ワークフロースパンは内部としてマークされる */
  WORKFLOW = 1 << 0,

  /** エージェントスパンは内部としてマークされる */
  AGENT = 1 << 1,

  /** ツールスパンは内部としてマークされる */
  TOOL = 1 << 2,

  /** モデルスパンは内部としてマークされる */
  MODEL = 1 << 3,

  /** すべてのスパンは内部としてマークされる */
  ALL = (1 << 4) - 1,
}
```


<div id="see-also">
  ## 関連項目
</div>

<div id="documentation">
  ### ドキュメント
</div>

- [AI トレーシングの概要](/docs/observability/ai-tracing/overview) - AI トレーシングの完全ガイド
- [子スパンの作成](/docs/observability/ai-tracing/overview#creating-child-spans) - スパンの階層構造を扱う
- [カスタムメタデータの追加](/docs/observability/ai-tracing/overview#adding-custom-metadata) - トレースの情報を充実させる

<div id="reference">
  ### 参考
</div>

- [Configuration](/reference/observability/ai-tracing/configuration) - レジストリと構成
- [AITracing Classes](/reference/observability/ai-tracing/) - コア実装
- [Span Reference](/reference/observability/ai-tracing/span) - Span のライフサイクル メソッド

<div id="examples">
  ### 例
</div>

- [Basic AI Tracing](/examples/observability/basic-ai-tracing) - 実装例