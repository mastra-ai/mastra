---
title: "リファレンス: Amazon S3 Vectors ストア | Vectors | Mastra ドキュメント"
description: Mastra の S3Vectors クラスに関するドキュメント。Amazon S3 Vectors（プレビュー）を利用したベクトル検索を提供します。
---

<div id="amazon-s3-vectors-store">
  # Amazon S3 Vectors ストア
</div>

> ⚠️ Amazon S3 Vectors はプレビューサービスです。
> プレビュー機能は予告なく変更または削除される場合があり、AWS の SLA の対象外です。
> 動作、制限、リージョンでの提供状況はいつでも変更される可能性があります。
> このライブラリは、AWS との整合性を保つために破壊的変更が導入される場合があります。

`S3Vectors` クラスは、[Amazon S3 Vectors（プレビュー）](https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-vectors.html) を用いたベクトル検索を提供します。ベクトルは**ベクトルバケット**に保存され、**ベクトルインデックス**で類似検索が実行され、JSON ベースのメタデータフィルターが使用されます。

<div id="installation">
  ## インストール
</div>

```bash copy
npm install @mastra/s3vectors
```


<div id="usage-example">
  ## 使い方の例
</div>

```typescript copy showLineNumbers
import { S3Vectors } from "@mastra/s3vectors";

const store = new S3Vectors({
  vectorBucketName: process.env.S3_VECTORS_BUCKET_NAME!, // 例: "my-vector-bucket"
  clientConfig: {
    region: process.env.AWS_REGION!, // 認証情報はデフォルトのAWSプロバイダーチェーンを使用
  },
  // オプション: インデックス作成時に大きな/長いテキストフィールドをフィルタリング不可に設定
  nonFilterableMetadataKeys: ["content"],
});

// インデックスを作成(名前は正規化されます: "_" → "-" および小文字化)
await store.createIndex({
  indexName: "my_index",
  dimension: 1536,
  metric: "cosine", // "euclidean"もサポート; "dotproduct"は非サポート
});

// ベクトルをアップサート(IDは省略時に自動生成)。メタデータ内のDate値はエポックミリ秒にシリアライズされます。
const ids = await store.upsert({
  indexName: "my_index",
  vectors: [
    [0.1, 0.2 /* … */],
    [0.3, 0.4 /* … */],
  ],
  metadata: [
    {
      text: "doc1",
      genre: "documentary",
      year: 2023,
      createdAt: new Date("2024-01-01"),
    },
    { text: "doc2", genre: "comedy", year: 2021 },
  ],
});

// メタデータフィルターを使用してクエリを実行(暗黙的なANDは正規化されます)
const results = await store.query({
  indexName: "my-index",
  queryVector: [0.1, 0.2 /* … */],
  topK: 10, // サービス側の制限が適用される場合があります(通常30)
  filter: { genre: { $in: ["documentary", "comedy"] }, year: { $gte: 2020 } },
  includeVector: false, // 生のベクトルを含める場合はtrueに設定(セカンダリフェッチがトリガーされる可能性があります)
});

// リソースをクリーンアップ(基盤となるHTTPハンドラーを閉じます)
await store.disconnect();
```


<div id="constructor-options">
  ## コンストラクターのオプション
</div>

<PropertiesTable
  content={[
    {
      name: "vectorBucketName",
      type: "string",
      description: "対象の S3 Vectors のベクターバケット名。",
    },
    {
      name: "clientConfig",
      type: "S3VectorsClientConfig",
      isOptional: true,
      description: "AWS SDK v3 のクライアントオプション（例: `region`、`credentials`）。",
    },
    {
      name: "nonFilterableMetadataKeys",
      type: "string[]",
      isOptional: true,
      description:
        "フィルタできないようにすべきメタデータキー（作成時にインデックスへ適用）。`content` のような大きなテキストフィールドに使用してください。",
    },
  ]}
/>

<div id="methods">
  ## メソッド
</div>

<div id="createindex">
  ### createIndex()
</div>

設定済みのベクターバケットに新しいベクターインデックスを作成します。インデックスが既に存在する場合は、呼び出し時にスキーマを検証し、処理は行われません（既存のメトリックと次元は保持されます）。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description:
        "論理インデックス名。内部で正規化され、アンダースコアはハイフンに置き換えられ、名前はすべて小文字になります。",
    },
    {
      name: "dimension",
      type: "number",
      description: "ベクトルの次元数（使用する埋め込みモデルと一致している必要があります）",
    },
    {
      name: "metric",
      type: "'cosine' | 'euclidean'",
      isOptional: true,
      defaultValue: "cosine",
      description:
        "類似検索の距離メトリック。`dotproduct` は S3 Vectors ではサポートされていません。",
    },
  ]}
/>

<div id="upsert">
  ### upsert()
</div>

ベクターを追加または置換します（レコード全体の put）。`ids` が指定されていない場合は UUID が生成されます。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "upsert を行うインデックス名",
    },
    {
      name: "vectors",
      type: "number[][]",
      description: "埋め込みベクトルの配列",
    },
    {
      name: "metadata",
      type: "Record<string, any>[]",
      isOptional: true,
      description: "各ベクトルのメタデータ",
    },
    {
      name: "ids",
      type: "string[]",
      isOptional: true,
      description: "ベクトル ID（未指定の場合は自動生成）",
    },
  ]}
/>

<div id="query">
  ### query()
</div>

オプションのメタデータフィルタで最近傍を検索します。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "クエリ対象のインデックス名",
    },
    {
      name: "queryVector",
      type: "number[]",
      description: "類似ベクトルを見つけるためのクエリベクトル",
    },
    {
      name: "topK",
      type: "number",
      isOptional: true,
      defaultValue: "10",
      description: "返す結果数",
    },
    {
      name: "filter",
      type: "S3VectorsFilter",
      isOptional: true,
      description:
        "JSONベースのメタデータフィルタ。`$and`、`$or`、`$eq`、`$ne`、`$gt`、`$gte`、`$lt`、`$lte`、`$in`、`$nin`、`$exists` をサポートします。",
    },
    {
      name: "includeVector",
      type: "boolean",
      isOptional: true,
      defaultValue: "false",
      description: "結果にベクトルを含めるかどうか",
    },
  ]}
/>

> **スコアリング:** 結果には `score = 1/(1 + distance)` が含まれます。これは距離の順位を保ったまま、スコアが高いほど良いことを示します。

<div id="describeindex">
  ### describeIndex()
</div>

インデックスに関する情報を返します。

<PropertiesTable
  content={[
{
  name: "indexName",
  type: "string",
  description: "取得するインデックスの名前。",
},
]}
/>

戻り値:

```typescript copy
interface IndexStats {
  dimension: number;
  count: number; // ListVectorsのページネーション経由で計算 (O(n))
  metric: "cosine" | "euclidean";
}
```


<div id="deleteindex">
  ### deleteIndex()
</div>

インデックスとそのデータを削除します。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "削除するインデックス名。",
    },
  ]}
/>

<div id="listindexes">
  ### listIndexes()
</div>

設定されたベクターバケット内のすべてのインデックスを一覧します。

Returns: `Promise<string[]>`

<div id="updatevector">
  ### updateVector()
</div>

インデックス内の特定のIDに対して、ベクトルまたはメタデータを更新します。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "ベクトルを含むインデックス。",
    },
    {
      name: "id",
      type: "string",
      description: "更新対象のID。",
    },
    {
      name: "update",
      type: "object",
      description: "ベクトルおよび/またはメタデータを含む更新用データ",
    },
    {
      name: "update.vector",
      type: "number[]",
      isOptional: true,
      description: "更新後のベクトルデータ",
    },
    {
      name: "update.metadata",
      type: "Record<string, any>",
      isOptional: true,
      description: "更新後のメタデータ",
    },
  ]}
/>

<div id="deletevector">
  ### deleteVector()
</div>

指定した ID のベクトルを削除します。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "ベクトルを含むインデックス。",
    },
    {
      name: "id",
      type: "string",
      description: "削除する ID。",
    },
  ]}
/>

<div id="disconnect">
  ### disconnect()
</div>

ソケットを解放するために、基礎となる AWS SDK の HTTP ハンドラーをクローズします。

<div id="response-types">
  ## 応答の種類
</div>

クエリ結果は次の形式で返されます。

```typescript copy
interface QueryResult {
  id: string;
  score: number; // 1/(1 + 距離)
  metadata: Record<string, any>;
  vector?: number[]; // includeVectorがtrueの場合のみ含まれます
}
```


<div id="filter-syntax">
  ## フィルター構文
</div>

S3 Vectors は演算子と値型の厳密なサブセットのみをサポートします。Mastra フィルター変換器は以下を行います:

* **暗黙の AND を正規化**: `{a:1,b:2}` → `{ $and: [{a:1},{b:2}] }`。
* **Date 値を正規化**し、数値比較や配列要素のためにエポック ms に変換します。
* 等価比較の位置（`field: value` または `$eq/$ne`）での **Date を不許可**。等価比較の値は **string | number | boolean** のみ。
* 等価比較での null/undefined を**拒否**。**配列の等価比較**は非対応（`$in`/`$nin` を使用）。
* トップレベルの論理演算子として許可されるのは **`$and` / `$or`** のみ。
* 論理演算子は**フィールド条件**を含む必要があります（演算子を直接ネストすることは不可）。

**サポートされる演算子:**

* **論理:** `$and`, `$or`（空でない配列）
* **基本:** `$eq`, `$ne`（string | number | boolean）
* **数値:** `$gt`, `$gte`, `$lt`, `$lte`（number または `Date` → エポック ms）
* **配列:** `$in`, `$nin`（空でない string | number | boolean の配列; `Date` → エポック ms）
* **要素:** `$exists`（boolean）

**未サポート / 不許可（拒否）:** `$not`, `$nor`, `$regex`, `$all`, `$elemMatch`, `$size`, `$text` など。

**例:**

```typescript copy
// 暗黙的なAND
{ genre: { $in: ["documentary", "comedy"] }, year: { $gte: 2020 } }

// 明示的な論理演算子と範囲指定
{
  $and: [
    { price: { $gte: 100, $lte: 1000 } },
    { $or: [{ stock: { $gt: 0 } }, { preorder: true }] }
  ]
}

// 範囲指定の日付（エポックミリ秒に変換）
{ timestamp: { $gt: new Date("2024-01-01T00:00:00Z") } }
```

> **フィルター不可のキー:** インデックス作成時に `nonFilterableMetadataKeys` を設定すると、それらのキーは保存されますが、フィルターで**使用することはできません**。


<div id="error-handling">
  ## エラーハンドリング
</div>

ストアは、キャッチ可能な型付きエラーをスローします。

```typescript copy
try {
  await store.query({
    indexName: "index-name",
    queryVector: queryVector,
  });
} catch (error) {
  if (error instanceof VectorStoreError) {
    console.log(error.code); // 'connection_failed' | 'invalid_dimension' | など
    console.log(error.details); // エラーの詳細情報
  }
}
```


<div id="environment-variables">
  ## 環境変数
</div>

アプリを組み込む際によく使われる環境変数:

- `S3_VECTORS_BUCKET_NAME`: S3 の**ベクターバケット**名（`vectorBucketName` に設定）。
- `AWS_REGION`: S3 Vectors バケットの AWS リージョン。
- **AWS 資格情報**: 標準の AWS SDK プロバイダー・チェーン（`AWS_ACCESS_KEY_ID`、`AWS_SECRET_ACCESS_KEY`、`AWS_PROFILE` など）経由。

<div id="best-practices">
  ## ベストプラクティス
</div>

- 埋め込みモデルに合わせてメトリック（`cosine` または `euclidean`）を選択してください。`dotproduct` はサポートされていません。
- **フィルタ可能**なメタデータは小さく、かつ構造化（string/number/boolean）して保ちましょう。大きなテキスト（例：`content`）は**フィルタ不可**として保存します。
- ネストされたメタデータには**ドット表記**を使い、複雑なロジックには明示的な `$and`/`$or` を用いましょう。
- ホットパスでの `describeIndex()` 呼び出しは避けてください。`count` はページングされた `ListVectors` によって計算されます（**O(n)**）。
- 生のベクトルが必要な場合にのみ `includeVector: true` を使用してください。

<div id="related">
  ## 関連項目
</div>

- [メタデータフィルター](../rag/metadata-filters)