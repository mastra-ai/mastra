---
title: "リファレンス: Upstash Vector Store | ベクター | Mastra ドキュメント"
description: Mastra における UpstashVector クラスのドキュメント。Upstash Vector を使用したベクター検索を提供します。
---

<div id="upstash-vector-store">
  # Upstash Vector Store
</div>

UpstashVector クラスは、メタデータによるフィルタリング機能やハイブリッド検索に対応した、サーバーレスのベクターデータベースサービスである [Upstash Vector](https://upstash.com/vector) を用いてベクター検索を提供します。

<div id="constructor-options">
  ## コンストラクターのオプション
</div>

<PropertiesTable
  content={[
    {
      name: "url",
      type: "string",
      description: "Upstash Vector データベースのURL",
    },
    {
      name: "token",
      type: "string",
      description: "Upstash VectorのAPIトークン",
    },
  ]}
/>

<div id="methods">
  ## メソッド
</div>

<div id="createindex">
  ### createIndex()
</div>

Note: このメソッドは Upstash では実行されません。インデックスは自動的に作成されます。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "作成するインデックス名",
    },
    {
      name: "dimension",
      type: "number",
      description: "ベクトルの次元数（使用する埋め込みモデルに合わせる必要があります）",
    },
    {
      name: "metric",
      type: "'cosine' | 'euclidean' | 'dotproduct'",
      isOptional: true,
      defaultValue: "cosine",
      description: "類似検索に用いる距離指標",
    },
  ]}
/>

<div id="upsert">
  ### upsert()
</div>

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "アップサート先のインデックス名",
    },
    {
      name: "vectors",
      type: "number[][]",
      description: "埋め込みベクトルの配列",
    },
    {
      name: "sparseVectors",
      type: "{ indices: number[], values: number[] }[]",
      isOptional: true,
      description:
        "ハイブリッド検索用のスパースベクトルの配列。各スパースベクトルでは、indices と values の配列が対応している必要があります。",
    },
    {
      name: "metadata",
      type: "Record<string, any>[]",
      isOptional: true,
      description: "各ベクトルのメタデータ",
    },
    {
      name: "ids",
      type: "string[]",
      isOptional: true,
      description: "任意のベクトル ID（未指定の場合は自動生成）",
    },
  ]}
/>

<div id="query">
  ### query()
</div>

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "クエリ対象のインデックス名",
    },
    {
      name: "queryVector",
      type: "number[]",
      description: "類似ベクトルを検索するためのクエリベクトル",
    },
    {
      name: "sparseVector",
      type: "{ indices: number[], values: number[] }",
      isOptional: true,
      description:
        "ハイブリッド検索用のオプションのスパースベクトル。indices と values の配列が対応している必要があります。",
    },
    {
      name: "topK",
      type: "number",
      isOptional: true,
      defaultValue: "10",
      description: "返す結果数",
    },
    {
      name: "filter",
      type: "Record<string, any>",
      isOptional: true,
      description: "クエリのメタデータフィルター",
    },
    {
      name: "includeVector",
      type: "boolean",
      isOptional: true,
      defaultValue: "false",
      description: "結果にベクトルを含めるかどうか",
    },
    {
      name: "fusionAlgorithm",
      type: "FusionAlgorithm",
      isOptional: true,
      description:
        "ハイブリッド検索で dense と sparse の結果を統合するアルゴリズム（例: RRF（Reciprocal Rank Fusion））",
    },
    {
      name: "queryMode",
      type: "QueryMode",
      isOptional: true,
      description:
        "検索モード: 'DENSE' は dense のみ、'SPARSE' は sparse のみ、'HYBRID' は両者を組み合わせた検索",
    },
  ]}
/>

<div id="listindexes">
  ### listIndexes()
</div>

インデックス名（名前空間）を文字列の配列で返します。

<div id="describeindex">
  ### describeIndex()
</div>

<PropertiesTable
  content={[
{
  name: "indexName",
  type: "string",
  description: "説明するインデックスの名前",
},
]}
/>

戻り値:

```typescript copy
interface IndexStats {
  dimension: number;
  count: number;
  metric: "cosine" | "euclidean" | "dotproduct";
}
```


<div id="deleteindex">
  ### deleteIndex()
</div>

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "削除するインデックス（名前空間）の名称",
    },
  ]}
/>

<div id="updatevector">
  ### updateVector()
</div>

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "更新対象のインデックス名",
    },
    {
      name: "id",
      type: "string",
      description: "更新するアイテムの ID",
    },
    {
      name: "update",
      type: "object",
      description:
        "vector、sparse vector、および/または metadata を含む更新オブジェクト",
    },
  ]}
/>

`update` オブジェクトには次のプロパティを指定できます:

- `vector`（任意）: 新しい dense vector を表す数値配列。
- `sparseVector`（任意）: ハイブリッドインデックス向けの `indices` と `values` 配列を持つ sparse vector オブジェクト。
- `metadata`（任意）: メタデータのキー・値ペアのレコード。

<div id="deletevector">
  ### deleteVector()
</div>

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "削除対象のアイテムがあるインデックス名",
    },
    {
      name: "id",
      type: "string",
      description: "削除するアイテムのID",
    },
  ]}
/>

指定したインデックスから、IDを指定してアイテムの削除を試みます。削除に失敗した場合はエラーメッセージをログ出力します。

<div id="hybrid-vector-search">
  ## ハイブリッドベクター検索
</div>

Upstash Vector は、関連性と精度を高めるために、セマンティック検索（密ベクトル）とキーワードベースの検索（疎ベクトル）を組み合わせたハイブリッド検索をサポートしています。

<div id="basic-hybrid-usage">
  ### ハイブリッドの基本的な使い方
</div>

```typescript copy
import { UpstashVector } from "@mastra/upstash";

const vectorStore = new UpstashVector({
  url: process.env.UPSTASH_VECTOR_URL,
  token: process.env.UPSTASH_VECTOR_TOKEN,
});

// 密ベクトルと疎ベクトルの両方を使用してベクトルをアップサート
const denseVectors = [
  [0.1, 0.2, 0.3],
  [0.4, 0.5, 0.6],
];
const sparseVectors = [
  { indices: [1, 5, 10], values: [0.8, 0.6, 0.4] },
  { indices: [2, 6, 11], values: [0.7, 0.5, 0.3] },
];

await vectorStore.upsert({
  indexName: "hybrid-index",
  vectors: denseVectors,
  sparseVectors: sparseVectors,
  metadata: [{ title: "Document 1" }, { title: "Document 2" }],
});

// ハイブリッド検索でクエリ
const results = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3],
  sparseVector: { indices: [1, 5], values: [0.9, 0.7] },
  topK: 10,
});
```


<div id="advanced-hybrid-search-options">
  ### 高度なハイブリッド検索オプション
</div>

```typescript copy
import { FusionAlgorithm, QueryMode } from "@upstash/vector";

// 特定の融合アルゴリズムでクエリを実行
const fusionResults = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3],
  sparseVector: { indices: [1, 5], values: [0.9, 0.7] },
  fusionAlgorithm: FusionAlgorithm.RRF,
  topK: 10,
});

// 密ベクトルのみで検索
const denseResults = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3],
  queryMode: QueryMode.DENSE,
  topK: 10,
});

// 疎ベクトルのみで検索
const sparseResults = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3], // インデックス構造のため引き続き必要
  sparseVector: { indices: [1, 5], values: [0.9, 0.7] },
  queryMode: QueryMode.SPARSE,
  topK: 10,
});
```


<div id="updating-hybrid-vectors">
  ### ハイブリッドベクターの更新
</div>

```typescript copy
// 密ベクトルと疎ベクトルの両方を更新
await vectorStore.updateVector({
  indexName: "hybrid-index",
  id: "vector-id",
  update: {
    vector: [0.2, 0.3, 0.4],
    sparseVector: { indices: [2, 7, 12], values: [0.9, 0.8, 0.6] },
    metadata: { title: "更新されたドキュメント" },
  },
});
```


<div id="response-types">
  ## レスポンスの種類
</div>

クエリ結果は次の形式で返されます：

```typescript copy
interface QueryResult {
  id: string;
  score: number;
  metadata: Record<string, any>;
  vector?: number[]; // includeVectorがtrueの場合のみ含まれる
}
```


<div id="error-handling">
  ## エラーハンドリング
</div>

ストアは型付きエラーをスローし、捕捉できます：

```typescript copy
try {
  await store.query({
    indexName: "index_name",
    queryVector: queryVector,
  });
} catch (error) {
  if (error instanceof VectorStoreError) {
    console.log(error.code); // 'connection_failed' | 'invalid_dimension' | など
    console.log(error.details); // エラーの詳細情報
  }
}
```


<div id="environment-variables">
  ## 環境変数
</div>

必須の環境変数:

- `UPSTASH_VECTOR_URL`: Upstash Vector データベースのURL
- `UPSTASH_VECTOR_TOKEN`: Upstash Vector のAPIトークン

<div id="related">
  ## 関連項目
</div>

- [メタデータフィルター](../rag/metadata-filters)