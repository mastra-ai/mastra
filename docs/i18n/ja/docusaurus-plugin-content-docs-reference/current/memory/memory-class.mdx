---
title: "リファレンス: Memory クラス | Memory | Mastra ドキュメント"
description: "Mastra の `Memory` クラスに関するドキュメント。会話履歴の管理やスレッドベースのメッセージ保存を実現する堅牢なシステムを提供します。"
---

# Memory クラス

`Memory` クラスは、Mastra における会話履歴とスレッド単位のメッセージ保存を管理するための堅牢な仕組みを提供します。これにより、会話の永続化、セマンティック検索、効率的なメッセージの取得が可能になります。会話履歴の保存にはストレージプロバイダーの設定が必要で、セマンティックリコールを有効化する場合は、ベクトルストアとエンベッダーの用意も必要です。

## 使い方の例

```typescript title="src/mastra/agents/test-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";

export const agent = new Agent({
  name: "test-agent",
  instructions: "あなたはメモリ機能を持つエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    options: {
      workingMemory: {
        enabled: true,
      },
    },
  }),
});
```

> エージェントで`workingMemory`を有効化するには、メインの Mastra インスタンスにストレージプロバイダーを設定する必要があります。詳細は[Mastra class](../core/mastra-class)を参照してください。


## コンストラクターのパラメーター

<PropertiesTable
  content={[
    {
      name: "storage",
      type: "MastraStorage",
      description:
        'メモリデータを永続化するためのストレージ実装。指定がない場合は `new DefaultStorage({ config: { url: "file:memory.db" } })` がデフォルトです。',
      isOptional: true,
    },
    {
      name: "vector",
      type: "MastraVector | false",
      description:
        "セマンティック検索機能のためのベクターストア。ベクター機能を無効化するには `false` を設定します。",
      isOptional: true,
    },
    {
      name: "embedder",
      type: "EmbeddingModel<string> | EmbeddingModelV2<string>",
      description:
        "ベクトル埋め込み用のエンベッダーインスタンス。セマンティックリコールが有効な場合は必須です。",
      isOptional: true,
    },
    {
      name: "options",
      type: "MemoryConfig",
      description: "メモリ設定オプション。",
      isOptional: true,
    },
    {
      name: "processors",
      type: "MemoryProcessor[]",
      description:
        "LLM に送信される前にメッセージをフィルタリングまたは変換できるメモリプロセッサの配列。",
      isOptional: true,
    },
  ]}
/>

### オプションパラメーター

<PropertiesTable
  content={[
    {
      name: "lastMessages",
      type: "number | false",
      description:
        "取得する最新メッセージ数。無効化するには false を指定します。",
      isOptional: true,
      defaultValue: "10",
    },
    {
      name: "semanticRecall",
      type: "boolean | { topK: number; messageRange: number | { before: number; after: number }; scope?: 'thread' | 'resource' }",
      description:
        "メッセージ履歴でのセマンティック検索を有効化します。boolean か、設定オプションを含むオブジェクトを指定できます。有効化時は、ベクターストアとエンベッダーの両方の設定が必要です。topK の既定値は 4、messageRange の既定値は {before: 1, after: 1} です。",
      isOptional: true,
      defaultValue: "false",
    },
    {
      name: "workingMemory",
      type: "WorkingMemory",
      description:
        "ワーキングメモリ機能の設定。`{ enabled: boolean; template?: string; schema?: ZodObject<any> | JSONSchema7; scope?: 'thread' | 'resource' }` または `{ enabled: boolean }`（無効化）を指定できます。",
      isOptional: true,
      defaultValue:
        "{ enabled: false, template: '# User Information\\n- **First Name**:\\n- **Last Name**:\\n...' }",
    },
    {
      name: "threads",
      type: "{ generateTitle?: boolean | { model: DynamicArgument<MastraLanguageModel>; instructions?: DynamicArgument<string> } }",
      description:
        "メモリスレッド作成に関する設定。`generateTitle` は、ユーザーの最初のメッセージからスレッドタイトルを自動生成するかどうかを制御します。boolean か、カスタムの model と instructions を含むオブジェクトを指定できます。",
      isOptional: true,
      defaultValue: "{ generateTitle: false }",
    },
  ]}
/>

## 戻り値

<PropertiesTable
  content={[
    {
      name: "memory",
      type: "Memory",
      description: "指定された構成を用いた新しい Memory インスタンス。",
    },
  ]}
/>

## 拡張使用例

```typescript title="src/mastra/agents/test-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { LibSQLStore, LibSQLVector } from "@mastra/libsql";

export const agent = new Agent({
  name: "test-agent",
  instructions: "あなたはメモリ機能を持つエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:./working-memory.db",
    }),
    vector: new LibSQLVector({
      connectionUrl: "file:./vector-memory.db",
    }),
    options: {
      lastMessages: 10,
      semanticRecall: {
        topK: 3,
        messageRange: 2,
        scope: "resource",
      },
      workingMemory: {
        enabled: true,
      },
      threads: {
        generateTitle: true,
      },
    },
  }),
});
```


## インデックス構成付きの PostgreSQL

```typescript title="src/mastra/agents/pg-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { PgStore, PgVector } from "@mastra/pg";

export const agent = new Agent({
  name: "pg-agent",
  instructions: "PostgreSQLメモリを最適化したエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new PgStore({
      connectionString: process.env.DATABASE_URL,
    }),
    vector: new PgVector({
      connectionString: process.env.DATABASE_URL,
    }),
    embedder: openai.embedding("text-embedding-3-small"),
    options: {
      lastMessages: 20,
      semanticRecall: {
        topK: 5,
        messageRange: 3,
        scope: "resource",
        indexConfig: {
          type: "hnsw", // パフォーマンス向上のためHNSWを使用
          metric: "dotproduct", // OpenAI埋め込みに最適
          m: 16, // 双方向リンク数
          efConstruction: 64, // 構築時の候補リストサイズ
        },
      },
      workingMemory: {
        enabled: true,
      },
    },
  }),
});
```


### 関連

- [Memory の概要](/docs/memory/overview)
- [セマンティックリコール](/docs/memory/semantic-recall)
- [ワーキングメモリ](/docs/memory/working-memory)
- [メモリプロセッサ](/docs/memory/memory-processors)
- [createThread](/reference/memory/createThread)
- [query](/reference/memory/query)
- [getThreadById](/reference/memory/getThreadById)
- [getThreadsByResourceId](/reference/memory/getThreadsByResourceId)
- [deleteMessages](/reference/memory/deleteMessages)