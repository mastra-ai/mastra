---
title: "リファレンス: System Prompt Scrubber | プロセッサー | Mastra ドキュメント"
description: "Mastra の SystemPromptScrubber に関するドキュメント。AI の応答からシステムプロンプトを検出してマスクします。"
---

<div id="systempromptscrubber">
  # SystemPromptScrubber
</div>

`SystemPromptScrubber` は、セキュリティ上の脆弱性につながり得るシステムプロンプトや指示、その他の露出情報を検出・処理する **出力プロセッサ** です。このプロセッサは、さまざまな種類のシステムプロンプトを識別し、それらへの対処に柔軟な戦略を提供することでセキュリティの維持に寄与します。これには、機密情報を適切に無害化するための複数の編集（レダクション）手法が含まれます。

<div id="usage-example">
  ## 使用例
</div>

```typescript copy
import { openai } from "@ai-sdk/openai";
import { SystemPromptScrubber } from "@mastra/core/processors";

const processor = new SystemPromptScrubber({
  model: openai("gpt-4.1-nano"),
  strategy: "redact",
  redactionMethod: "mask",
  includeDetections: true
});
```


<div id="constructor-parameters">
  ## コンストラクターのパラメータ
</div>

<PropertiesTable
  content={[
    {
      name: "options",
      type: "Options",
      description: "システムプロンプトの検出および処理に関する設定",
      isOptional: false,
    },
  ]}
/>

<div id="options">
  ### オプション
</div>

<PropertiesTable
  content={[
    {
      name: "model",
      type: "MastraModelConfig",
      description: "検出エージェント用のモデル設定",
      isOptional: false,
    },
    {
      name: "strategy",
      type: "'block' | 'warn' | 'filter' | 'redact'",
      description: "システムプロンプト検出時の対応方針：'block' はエラーで拒否、'warn' は警告を記録して通過を許可、'filter' は該当メッセージを除去、'redact' はマスクした内容に置換",
      isOptional: true,
      default: "'redact'",
    },
    {
      name: "customPatterns",
      type: "string[]",
      description: "システムプロンプトを検出するためのカスタムパターン（正規表現文字列）",
      isOptional: true,
      default: "[]",
    },
    {
      name: "includeDetections",
      type: "boolean",
      description: "警告に検出の詳細を含めるかどうか。デバッグや監視に便利",
      isOptional: true,
      default: "false",
    },
    {
      name: "instructions",
      type: "string",
      description: "検出エージェント向けのカスタム指示。未指定の場合はデフォルトの指示を使用",
      isOptional: true,
      default: "undefined",
    },
    {
      name: "redactionMethod",
      type: "'mask' | 'placeholder' | 'remove'",
      description: "システムプロンプトの編集方法：'mask' はアスタリスクで置換、'placeholder' はプレースホルダーテキストで置換、'remove' は完全に削除",
      isOptional: true,
      default: "'mask'",
    },
    {
      name: "placeholderText",
      type: "string",
      description: "redactionMethod が 'placeholder' の場合に使用するカスタムのプレースホルダーテキスト",
      isOptional: true,
      default: "'[SYSTEM_PROMPT]'",
    },
  ]}
/>

<div id="returns">
  ## 返り値
</div>

<PropertiesTable
  content={[
    {
      name: "name",
      type: "string",
      description: "プロセッサ名。'system-prompt-scrubber' に設定されます",
      isOptional: false,
    },
    {
      name: "processOutputStream",
      type: "(args: { part: ChunkType; streamParts: ChunkType[]; state: Record<string, any>; abort: (reason?: string) => never; tracingContext?: TracingContext }) => Promise<ChunkType | null>",
      description: "ストリーミング中にシステムプロンプトを検出して対処するため、ストリーミング出力のパートを処理します",
      isOptional: false,
    },
    {
      name: "processOutputResult",
      type: "(args: { messages: MastraMessageV2[]; abort: (reason?: string) => never }) => Promise<MastraMessageV2[]>",
      description: "非ストリーミング環境でシステムプロンプトを検出して対処するため、最終的な出力結果を処理します",
      isOptional: false,
    },
  ]}
/>

<div id="extended-usage-example">
  ## 拡張使用例
</div>

`SystemPromptScrubber` を出力プロセッサとして使用する場合は、パフォーマンス最適化のために `BatchPartsProcessor` と組み合わせて使うことを推奨します。`BatchPartsProcessor` は、スクラバーに渡す前にストリームのチャンクをまとめて一括処理し、検出に必要な LLM 呼び出し回数を減らします。

```typescript title="src/mastra/agents/scrubbed-agent.ts" showLineNumbers copy
import { Agent } from "@mastra/core/agent";
import { BatchPartsProcessor, SystemPromptScrubber } from "@mastra/core/processors";

export const agent = new Agent({
  name: "scrubbed-agent",
  instructions: "あなたは役に立つアシスタントです",
  model: "openai/gpt-4o-mini",
  outputProcessors: [
    // LLM呼び出しを削減するため、まずストリームパーツをバッチ処理
    new BatchPartsProcessor({
      batchSize: 10,
    }),
    // 次に、バッチ処理されたコンテンツにシステムプロンプト検出を適用
    new SystemPromptScrubber({
      model: "openai/gpt-4.1-nano",
      strategy: "redact",
      customPatterns: ["システムプロンプト", "内部指示"],
      includeDetections: true,
      redactionMethod: "placeholder",
      placeholderText: "[REDACTED]"
    }),
  ]
});
```


<div id="related">
  ## 関連項目
</div>

- [ガードレール](/docs/agents/guardrails)