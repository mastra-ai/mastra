---
title: "リファレンス: メタデータフィルタ | RAG | Mastra ドキュメント"
description: さまざまなベクトルストアにおけるベクトル検索結果に対して、精密なクエリを可能にする Mastra のメタデータフィルタ機能に関するドキュメント。
---

<div id="metadata-filters">
  # メタデータフィルター
</div>

Mastra は、MongoDB/Sift のクエリ構文に基づく、すべてのベクトルストアで共通のメタデータフィルタリング構文を提供します。各ベクトルストアは、これらのフィルターを自分たちのネイティブ形式に変換します。

<div id="basic-example">
  ## 基本例
</div>

```typescript
import { PgVector } from "@mastra/pg";

const store = new PgVector({ connectionString });

const results = await store.query({
  indexName: "my_index",
  queryVector: queryVector,
  topK: 10,
  filter: {
    category: "electronics", // 単純な等価比較
    price: { $gt: 100 }, // 数値による比較
    tags: { $in: ["sale", "new"] }, // 配列内包含（メンバーシップ）
  },
});
```


<div id="supported-operators">
  ## サポート対象の演算子
</div>

<OperatorsTable
  title="基本比較"
  operators={[
    {
      name: "$eq",
      description: "指定した値と等しい値に一致",
      example: "{ age: { $eq: 25 } }",
      supportedBy: ["Couchbase を除くすべて"],
    },
    {
      name: "$ne",
      description: "等しくない値に一致",
      example: "{ status: { $ne: 'inactive' } }",
      supportedBy: ["Couchbase を除くすべて"],
    },
    {
      name: "$gt",
      description: "より大きい",
      example: "{ price: { $gt: 100 } }",
      supportedBy: ["Couchbase を除くすべて"],
    },
    {
      name: "$gte",
      description: "以上",
      example: "{ rating: { $gte: 4.5 } }",
      supportedBy: ["Couchbase を除くすべて"],
    },
    {
      name: "$lt",
      description: "より小さい",
      example: "{ stock: { $lt: 20 } }",
      supportedBy: ["Couchbase を除くすべて"],
    },
    {
      name: "$lte",
      description: "以下",
      example: "{ priority: { $lte: 3 } }",
      supportedBy: ["Couchbase を除くすべて"],
    },
  ]}
/>

<OperatorsTable
  title="配列演算子"
  operators={[
    {
      name: "$in",
      description: "配列内のいずれかの値に一致",
      example: '{ category: { $in: ["A", "B"] } }',
      supportedBy: ["Couchbase を除くすべて"],
    },
    {
      name: "$nin",
      description: "いずれの値にも一致しない",
      example: '{ status: { $nin: ["deleted", "archived"] } }',
      supportedBy: ["Couchbase を除くすべて"],
    },
    {
      name: "$all",
      description: "すべての要素を含む配列に一致",
      example: '{ tags: { $all: ["urgent", "high"] } }',
      supportedBy: ["Astra", "Pinecone", "Upstash", "MongoDB"],
    },
    {
      name: "$elemMatch",
      description: "条件を満たす配列要素に一致",
      example: "{ scores: { $elemMatch: { $gt: 80 } } }",
      supportedBy: ["LibSQL", "PgVector", "MongoDB"],
    },
  ]}
/>

<OperatorsTable
  title="論理演算子"
  operators={[
    {
      name: "$and",
      description: "論理 AND",
      example: "{ $and: [{ price: { $gt: 100 } }, { stock: { $gt: 0 } }] }",
      supportedBy: ["Vectorize、Couchbase を除くすべて"],
    },
    {
      name: "$or",
      description: "論理 OR",
      example: '{ $or: [{ status: "active" }, { priority: "high" }] }',
      supportedBy: ["Vectorize、Couchbase を除くすべて"],
    },
    {
      name: "$not",
      description: "論理 NOT",
      example: "{ price: { $not: { $lt: 100 } } }",
      supportedBy: [
        "Astra",
        "Qdrant",
        "Upstash",
        "PgVector",
        "LibSQL",
        "MongoDB",
      ],
    },
    {
      name: "$nor",
      description: "論理 NOR",
      example: '{ $nor: [{ status: "deleted" }, { archived: true }] }',
      supportedBy: ["Qdrant", "Upstash", "PgVector", "LibSQL", "MongoDB"],
    },
  ]}
/>

<OperatorsTable
  title="要素演算子"
  operators={[
    {
      name: "$exists",
      description: "フィールドが存在するドキュメントに一致",
      example: "{ rating: { $exists: true } }",
      supportedBy: ["Vectorize、Chroma、Couchbase を除くすべて"],
    },
  ]}
/>

<OperatorsTable
  title="カスタム演算子"
  operators={[
    {
      name: "$contains",
      description: "テキストに指定の文字列が含まれる",
      example: '{ description: { $contains: "sale" } }',
      supportedBy: ["Upstash", "LibSQL", "PgVector"],
    },
    {
      name: "$regex",
      description: "正規表現による一致",
      example: '{ name: { $regex: "^test" } }',
      supportedBy: ["Qdrant", "PgVector", "Upstash", "MongoDB"],
    },
    {
      name: "$size",
      description: "配列長のチェック",
      example: "{ tags: { $size: { $gt: 2 } } }",
      supportedBy: ["Astra", "LibSQL", "PgVector", "MongoDB"],
    },
    {
      name: "$geo",
      description: "ジオスペーシャルクエリ",
      example: '{ location: { $geo: { type: "radius", ... } } }',
      supportedBy: ["Qdrant"],
    },
    {
      name: "$datetime",
      description: "日時範囲のクエリ",
      example: '{ created: { $datetime: { range: { gt: "2024-01-01" } } } }',
      supportedBy: ["Qdrant"],
    },
    {
      name: "$hasId",
      description: "ベクターIDの有無チェック",
      example: '{ $hasId: ["id1", "id2"] }',
      supportedBy: ["Qdrant"],
    },
    {
      name: "$hasVector",
      description: "ベクターの有無チェック",
      example: "{ $hasVector: true }",
      supportedBy: ["Qdrant"],
    },
  ]}
/>

<div id="common-rules-and-restrictions">
  ## 共通のルールと制約
</div>

1. フィールド名について:
   - ネストされたフィールドを参照する場合を除き、ドット (.) を含めない
   - 先頭を $ にしない、または null 文字を含めない
   - 空文字列にしない

2. 値について:
   - 有効な JSON 型（string、number、boolean、object、array）であること
   - undefined でないこと
   - 演算子に適した型であること（例: 数値比較には number）

3. 論理演算子:
   - 有効な条件を含むこと
   - 空にしないこと
   - 適切にネストされていること
   - トップレベル、または他の論理演算子内にネストしてのみ使用できる
   - フィールドレベルでの使用や、フィールド内へのネストは不可
   - 演算子の内部での使用は不可
   - 有効: `{ "$and": [{ "field": { "$gt": 100 } }] }`
   - 有効: `{ "$or": [{ "$and": [{ "field": { "$gt": 100 } }] }] }`
   - 無効: `{ "field": { "$and": [{ "$gt": 100 }] } }`
   - 無効: `{ "field": { "$gt": { "$and": [{...}] } } }`

4. $not 演算子:
   - オブジェクトであること
   - 空にしないこと
   - フィールドレベルまたはトップレベルで使用可能
   - 有効: `{ "$not": { "field": "value" } }`
   - 有効: `{ "field": { "$not": { "$eq": "value" } } }`

5. 演算子のネスト:
   - 論理演算子は直接の演算子ではなく、フィールド条件を含めること
   - 有効: `{ "$and": [{ "field": { "$gt": 100 } }] }`
   - 無効: `{ "$and": [{ "$gt": 100 }] }`

<div id="store-specific-notes">
  ## ストア別の注意事項
</div>

<div id="astra">
  ### Astra
</div>

- ネストされたフィールドのクエリはドット記法でサポートされています
- 配列フィールドはメタデータで明示的に配列として定義する必要があります
- メタデータの値は大文字・小文字を区別します

<div id="chromadb">
  ### ChromaDB
</div>

- フィルターは、メタデータ内に対象フィールドが存在する結果のみを返します
- 空のメタデータフィールドはフィルター結果に含まれません
- 否定条件で一致させるにはメタデータフィールドが存在している必要があります（例：フィールドが欠落しているドキュメントには $ne は一致しません）

<div id="cloudflare-vectorize">
  ### Cloudflare Vectorize
</div>

- フィルタリングを使用する前に、メタデータのインデックス作成が明示的に必要
- フィルタリング対象のフィールドをインデックスするには `createMetadataIndex()` を使用
- Vectorize の各インデックスにつき、メタデータインデックスは最大 10 個
- 文字列値は先頭 64 バイトまでインデックス化（UTF-8 の境界で切り詰め）
- 数値は float64 精度を使用
- フィルター用 JSON は 2048 バイト未満である必要がある
- フィールド名にドット (.) を含めたり、$ で始めたりできない
- フィールド名は最大 512 文字に制限
- 新しいメタデータインデックスを作成した後、フィルタリング結果に含めるにはベクターを再アップサートする必要がある
- 範囲クエリは、非常に大規模なデータセット（約 1,000 万ベクター超）では精度が低下する場合がある

<div id="libsql">
  ### LibSQL
</div>

- ドット記法でネストされたオブジェクトへのクエリをサポート
- 配列フィールドは、有効な JSON 配列であることを検証
- 数値の比較では適切な型処理を維持
- 条件内の空配列を適切に処理
- メタデータは効率的なクエリのために JSONB 列に保存

<div id="pgvector">
  ### PgVector
</div>

- PostgreSQL のネイティブな JSON クエリ機能を完全にサポート
- ネイティブの配列関数による配列操作の高効率な処理
- 数値・文字列・ブール値の適切な型処理
- ネストされたフィールドのクエリは内部的に PostgreSQL の JSON パス構文を使用
- メタデータは効率的なインデックス化のため JSONB 列に保存

<div id="pinecone">
  ### Pinecone
</div>

- メタデータのフィールド名は最大512文字までです
- 数値は±1e38の範囲内である必要があります
- メタデータ内の配列は合計サイズが64KBまでです
- ネストされたオブジェクトはドット表記でフラット化されます
- メタデータの更新はメタデータオブジェクト全体を置き換えます

<div id="qdrant">
  ### Qdrant
</div>

- 入れ子条件を含む高度なフィルタリングをサポート
- フィルタリングには、Payload（メタデータ）フィールドを明示的にインデックス化する必要がある
- 位置情報（ジオスペーシャル）クエリを効率的に処理
- null および空の値を特別に扱う
- ベクトルに特化したフィルタリング機能
- 日時値は RFC 3339 形式である必要がある

<div id="upstash">
  ### Upstash
</div>

- メタデータフィールドのキーは最大512文字まで
- クエリのサイズに制限あり（大きな IN 句は避ける）
- フィルターで null/undefined の値はサポートされない
- 内部的に SQL 風の構文へ変換される
- 文字列比較は大文字・小文字を区別
- メタデータの更新はアトミックに実行される

<div id="mongodb">
  ### MongoDB
</div>

- メタデータフィルタ用の MongoDB/Sift クエリ構文を完全にサポート
- 標準的な比較、配列、論理、要素演算子をすべてサポート
- メタデータ内のネストされたフィールドや配列をサポート
- `filter` と `documentFilter` オプションを使って、`metadata` と元のドキュメント内容の両方にフィルタリングを適用可能
- `filter` はメタデータオブジェクトに、`documentFilter` は元のドキュメントのフィールドに適用
- フィルタのサイズや複雑さに人工的な制限はなし（MongoDB のクエリ制限の範囲内）
- パフォーマンス最適化のため、メタデータフィールドへのインデックス作成を推奨

<div id="couchbase">
  ### Couchbase
</div>

- 現在、メタデータフィルターには対応していません。フィルタリングは、結果取得後にクライアント側で行うか、より複雑なクエリの場合は Couchbase SDK の Search 機能を直接使用して行ってください。

<div id="amazon-s3-vectors">
  ### Amazon S3 ベクター
</div>

- 等値比較の値はプリミティブ（string/number/boolean）でなければなりません。`null`/`undefined`、配列、オブジェクト、Date は等値比較では使用できません。範囲演算子は number または Date を受け付けます（Date はエポック ms に正規化されます）。
- `$in`/`$nin` は非空のプリミティブ配列が必要です。Date 要素は許可され、エポック ms に正規化されます。配列の等値比較はサポートされません。
- 暗黙の AND は正規化されます（`{a:1,b:2}` → `{$and:[{a:1},{b:2}]}`）。論理演算子はフィールド条件を含み、空ではない配列を使用し、ルートまたは他の論理演算子内にのみ出現しなければなりません（フィールド値の内部は不可）。
- インデックス作成時に `nonFilterableMetadataKeys` に指定したキーは保存されますが、フィルタ不可です。この設定は変更できません。
- $exists には boolean 値が必要です。
- undefined/null/空のフィルタは、フィルタなしとして扱われます。
- 各メタデータキー名は 63 文字までです。
- ベクターごとのメタデータ合計: 最大 40 KB（フィルタ可能 + フィルタ不可）
- ベクターごとのメタデータキー総数: 最大 10
- ベクターごとのフィルタ可能メタデータ: 最大 2 KB
- ベクターインデックスごとのフィルタ不可メタデータキー: 最大 10

<div id="related">
  ## 関連項目
</div>

- [Astra](/reference/vectors/astra)
- [Chroma](/reference/vectors/chroma)
- [Cloudflare Vectorize](/reference/vectors/vectorize)
- [LibSQL](/reference/vectors/libsql)
- [MongoDB](/reference/vectors/mongodb)
- [PgStore](/reference/vectors/pg)
- [Pinecone](/reference/vectors/pinecone)
- [Qdrant](/reference/vectors/qdrant)
- [Upstash](/reference/vectors/upstash)
- [Amazon S3 Vectors](/reference/vectors/s3vectors)