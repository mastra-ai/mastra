---
title: "リファレンス: Context Precision Scorer | Scorers | Mastra ドキュメント"
description: Mastra の Context Precision Scorer に関するドキュメント。Mean Average Precision を用いて、期待される出力の生成に向けて取得したコンテキストの関連性と精度を評価します。
---

import PropertiesTable from "@site/src/components/PropertiesTable";


<div id="context-precision-scorer">
  # コンテキスト精度スコアラー
</div>

`createContextPrecisionScorer()` 関数は、期待される出力の生成に対して、取得したコンテキスト断片がどれほど関連性が高く、どの程度うまく配置されているかを評価するスコアラーを作成します。これは、関連するコンテキストをシーケンスの早い位置に配置するシステムを高く評価するために、**Mean Average Precision (MAP)** を用います。

次のユースケースで特に有用です:

**RAG システム評価**

以下のような RAG パイプラインにおける取得コンテキストの評価に最適です:

- モデル性能においてコンテキストの順序が重要である
- 単純な関連性評価を超えた取得品質を測定する必要がある
- 早い段階の関連コンテキストが後段の関連コンテキストよりも価値が高い

**コンテキストウィンドウの最適化**

次のようなコンテキスト選択の最適化に使用します:

- 限られたコンテキストウィンドウ
- トークン予算の制約
- マルチステップの推論タスク

<div id="parameters">
  ## パラメータ
</div>

<PropertiesTable
  content={[
    {
      name: "model",
      type: "MastraModelConfig",
      description: "コンテキストの関連性を評価するために使用する言語モデル",
      required: true,
    },
    {
      name: "options",
      type: "ContextPrecisionMetricOptions",
      description: "スコアラーの構成オプション",
      required: true,
      children: [
        {
          name: "context",
          type: "string[]",
          description: "関連性を評価するコンテキスト片の配列",
          required: false,
        },
        {
          name: "contextExtractor",
          type: "(input, output) => string[]",
          description:
            "実行時の入出力からコンテキストを動的に抽出する関数",
          required: false,
        },
        {
          name: "scale",
          type: "number",
          description: "最終スコアに乗算するスケール係数（既定値: 1）",
          required: false,
        },
      ],
    },
  ]}
/>

**注**: `context` または `contextExtractor` のいずれかを指定する必要があります。両方が指定された場合は、`contextExtractor` が優先されます。

<div id="run-returns">
  ## .run() の戻り値
</div>

<PropertiesTable
  content={[
    {
      name: "score",
      type: "number",
      description:
        "0 から scale（デフォルトは 0〜1）までの範囲の平均適合率（Mean Average Precision）スコア",
    },
    {
      name: "reason",
      type: "string",
      description:
        "コンテキストの精度評価に関する、人間が読みやすい説明",
    },
  ]}
/>

<div id="scoring-details">
  ## スコアの詳細
</div>

<div id="mean-average-precision-map">
  ### 平均適合率（MAP）
</div>

Context Precision は、関連性と順位の両面を評価するために**平均適合率**を用います：

1. **コンテキスト評価**: 各コンテキストを、期待される出力の生成に関連するか否かで分類する
2. **適合率の計算**: 位置 `i` にある関連コンテキストについて、precision = `relevant_items_so_far / (i + 1)`
3. **平均適合率**: 上記の適合率をすべて合計し、関連アイテムの総数で割る
4. **最終スコア**: スケール係数を掛けて、小数点以下2桁に丸める

<div id="scoring-formula">
  ### スコア算定式
</div>

```
MAP = (Σ 適合率@k) / R

定義:
- 適合率@k = (位置 1...k における関連アイテムの数) / k
- R = 関連アイテムの総数
- 関連アイテムが出現する位置でのみ計算
```


<div id="score-interpretation">
  ### スコアの解釈
</div>

- **0.9-1.0**: 精度が非常に高い - 関連するコンテキストがシーケンスの早い段階に揃っている
- **0.7-0.8**: 精度が良好 - 関連するコンテキストの大半が適切に配置されている
- **0.4-0.6**: 精度は中程度 - 関連するコンテキストが無関係な情報と混在している
- **0.1-0.3**: 精度が低い - 関連するコンテキストが少ない、または位置が不適切
- **0.0**: 関連するコンテキストが見つからない

<div id="reason-analysis">
  ### 理由の分析
</div>

reason フィールドでは次の点を説明します:

- どのコンテキスト要素が関連/非関連と判断されたか
- 位置づけが MAP の計算にどのような影響を与えたか
- 評価で用いられた具体的な関連性の基準

<div id="optimization-insights">
  ### 最適化のヒント
</div>

結果を活用して次を行う:

- **検索の取り込みを改善**: ランキング前に無関係なコンテキストを除外する
- **ランキングを最適化**: 関連するコンテキストが早い段階に現れるようにする
- **チャンクサイズを調整**: コンテキストの詳細度と関連性の精度のバランスを取る
- **埋め込みを評価**: より良い検索のために異なる埋め込みモデルを試す

<div id="example-calculation">
  ### 計算例
</div>

与えられたコンテキスト: `[relevant, irrelevant, relevant, irrelevant]`

- 位置 0: 関連あり → 適合率 = 1/1 = 1.0
- 位置 1: スキップ（irrelevant）
- 位置 2: 関連あり → 適合率 = 2/3 = 0.67
- 位置 3: スキップ（irrelevant）

MAP = (1.0 + 0.67) / 2 = 0.835 ≈ **0.83**

<div id="scorer-configuration">
  ## スコアラーの設定
</div>

<div id="dynamic-context-extraction">
  ### 動的コンテキスト抽出
</div>

```typescript
const scorer = createContextPrecisionScorer({
  model: "openai/gpt-4o-mini",
  options: {
    contextExtractor: (input, output) => {
      // クエリに基づいてコンテキストを動的に抽出
      const query = input?.inputMessages?.[0]?.content || "";

      // 例: ベクトルデータベースから取得
      const searchResults = vectorDB.search(query, { limit: 10 });
      return searchResults.map((result) => result.content);
    },
    scale: 1,
  },
});
```


<div id="large-context-evaluation">
  ### 大きな文脈での評価
</div>

```typescript
const scorer = createContextPrecisionScorer({
  model: "openai/gpt-4o-mini",
  options: {
    context: [
      // ベクトルデータベースから取得したドキュメントをシミュレート
      "Document 1: 非常に関連性の高いコンテンツ...",
      "Document 2: やや関連するコンテンツ...",
      "Document 3: 間接的に関連...",
      "Document 4: 関連性なし...",
      "Document 5: 非常に関連性の高いコンテンツ...",
      // ... 数十個のコンテキストまで
    ],
  },
});
```


<div id="examples">
  ## 例
</div>

<div id="high-precision-example">
  ### 高精度の例
</div>

この例は、必要な文脈が冒頭で揃っている、完璧なコンテキスト精度を示しています。

```typescript
import { createContextPrecisionScorer } from "@mastra/evals";

const scorer = createContextPrecisionScorer({
  model: "openai/gpt-4o-mini",
  options: {
    context: [
      "光合成とは、植物が太陽光、二酸化炭素、水をグルコースと酸素に変換するプロセスです。",
      "このプロセスは植物細胞の葉緑体、特にチラコイド内で行われます。",
      "光依存反応はチラコイド膜で起こり、カルビン回路はストロマで起こります。",
    ],
    scale: 1,
  },
});

const result = await scorer.run({
  input: {
    inputMessages: [
      {
        id: "1",
        role: "user",
        content: "植物の光合成はどのように機能しますか?",
      },
    ],
  },
  output: [
    {
      id: "2",
      role: "assistant",
      content:
        "光合成とは、植物が葉緑体を使って太陽光、CO2、水をグルコースと酸素に変換するプロセスです。",
    },
  ],
});

console.log(result);
// Output:
// {
//   score: 1.0,
//   reason: "すべてのコンテキスト要素が光合成の説明に高い関連性を持ち、期待される出力をサポートするために最適な順序で配置されているため、スコアは1.0です。"
// }
```


<div id="mixed-precision-example">
  ### 混合精度の例
</div>

この例は、関連する文脈と無関係な文脈の両方を含む、ほどほどの精度を示しています。

```typescript
import { createContextPrecisionScorer } from "@mastra/evals";

const scorer = createContextPrecisionScorer({
  model: "openai/gpt-4o-mini",
  options: {
    context: [
      "定期的な運動は心筋を強化することで心血管の健康を改善します。",
      "バランスの取れた食事には果物、野菜、全粒穀物を含めるべきです。",
      "身体活動はエンドルフィンを放出し、気分を改善しストレスを軽減します。",
      "平均的な人は1日に8杯の水を飲むべきです。",
      "運動はまた、健康的な体重と筋肉量の維持にも役立ちます。",
    ],
    scale: 1,
  },
});

const result = await scorer.run({
  input: {
    inputMessages: [
      {
        id: "1",
        role: "user",
        content: "運動の精神的および身体的なメリットは何ですか?",
      },
    ],
  },
  output: [
    {
      id: "2",
      role: "assistant",
      content:
        "運動は心血管系にメリットをもたらし、エンドルフィンの放出により気分を改善し、健康的な体組成の維持に役立ちます。",
    },
  ],
});

console.log(result);
// Output:
// {
//   score: 0.72,
//   reason: "スコアが0.72なのは、コンテキスト1、3、5が運動のメリットに関連している一方で、食事と水分補給に関する無関係なコンテキストが精度スコアを低下させているためです。"
// }
```


<div id="low-precision-example">
  ### 低精度の例
</div>

この例は、文脈の大半が無関係で、コンテキスト精度が低いことを示しています。

```typescript
import { createContextPrecisionScorer } from "@mastra/evals";

const scorer = createContextPrecisionScorer({
  model: "openai/gpt-4o-mini",
  options: {
    context: [
      "今週末は晴れの予報です。",
      "コーヒーは世界で最も人気のある飲料の一つです。",
      "機械学習には大量の学習データが必要です。",
      "猫は通常1日12〜16時間眠ります。",
      "フランスの首都はパリです。",
    ],
    scale: 1,
  },
});

const result = await scorer.run({
  input: {
    inputMessages: [
      {
        id: "1",
        role: "user",
        content: "光合成の仕組みを教えてください。",
      },
    ],
  },
  output: [
    {
      id: "2",
      role: "assistant",
      content:
        "光合成は、植物が葉緑素を使って太陽光をエネルギーに変換するプロセスです。",
    },
  ],
});

console.log(result);
// Output:
// {
//   score: 0.0,
//   reason: "取得されたコンテキストのいずれも光合成の説明に関連していないため、スコアは0.0です。"
// }
```


<div id="comparison-with-context-relevance">
  ## コンテキスト関連性との比較
</div>

ニーズに合ったスコアラーを選びましょう:

| ユースケース            | コンテキスト関連性       | コンテキスト精度            |
| ------------------------ | ------------------------ | --------------------------- |
| **RAG 評価**            | 利用状況が重要な場合      | ランキングが重要な場合      |
| **コンテキスト品質**    | きめ細かな段階評価        | 二値の関連性                |
| **欠落検出**            | ✓ 不足を特定              | ✗ 評価対象外                |
| **使用状況の追跡**      | ✓ 利用状況を追跡          | ✗ 対象外                    |
| **位置感度**            | ✗ 位置に非依存            | ✓ 早期の配置を評価          |

<div id="related">
  ## 関連
</div>

- [Answer Relevancy Scorer](/reference/scorers/answer-relevancy) - 回答が質問に適切に対応しているかを評価します
- [Faithfulness Scorer](/reference/scorers/faithfulness) - 回答が文脈に基づいている度合いを測定します
- [Custom Scorers](/docs/scorers/custom-scorers) - 独自の評価指標を作成する方法