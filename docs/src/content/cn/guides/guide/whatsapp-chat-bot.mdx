---
title: "WhatsApp èŠå¤©æœºå™¨äºº"
description: ä½¿ç”¨ Mastra ä»£ç†å’Œå·¥ä½œæµåˆ›å»º WhatsApp èŠå¤©æœºå™¨äººï¼Œä»¥å¤„ç†ä¼ å…¥æ¶ˆæ¯å¹¶é€šè¿‡æ–‡æœ¬æ¶ˆæ¯è‡ªç„¶å›å¤ã€‚
---

# WhatsApp èŠå¤©æœºå™¨äºº

æœ¬æŒ‡å—æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Mastra ä»£ç†å’Œå·¥ä½œæµåˆ›å»º WhatsApp èŠå¤©æœºå™¨äººã€‚æœºå™¨äººé€šè¿‡ webhook æ¥æ”¶ä¼ å…¥çš„ WhatsApp æ¶ˆæ¯ï¼Œé€šè¿‡ AI ä»£ç†å¤„ç†å®ƒä»¬ï¼Œå°†å“åº”æ‹†åˆ†æˆè‡ªç„¶çš„æ–‡æœ¬æ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ WhatsApp Business API å‘é€å›ã€‚

## å‰ç½®æ¡ä»¶

æ­¤ç¤ºä¾‹éœ€è¦ WhatsApp Business API è®¾ç½®ï¼Œå¹¶ä½¿ç”¨ `anthropic` æ¨¡å‹ã€‚å°†è¿™äº›ç¯å¢ƒå˜é‡æ·»åŠ åˆ°æ‚¨çš„ `.env` æ–‡ä»¶ï¼š

```bash title=".env"
ANTHROPIC_API_KEY=<your-anthropic-api-key>
WHATSAPP_VERIFY_TOKEN=<your-verify-token>
WHATSAPP_ACCESS_TOKEN=<your-whatsapp-access-token>
WHATSAPP_BUSINESS_PHONE_NUMBER_ID=<your-phone-number-id>
WHATSAPP_API_VERSION=v22.0
```

## åˆ›å»º WhatsApp å®¢æˆ·ç«¯

æ­¤å®¢æˆ·ç«¯å¤„ç†é€šè¿‡ WhatsApp Business API å‘ç”¨æˆ·å‘é€æ¶ˆæ¯ã€‚

```typescript title="src/whatsapp-client.ts"
// Simple WhatsApp Business API client for sending messages

interface SendMessageParams {
  to: string;
  message: string;
}

export async function sendWhatsAppMessage({ to, message }: SendMessageParams) {
  // Get environment variables for WhatsApp API
  const apiVersion = process.env.WHATSAPP_API_VERSION || "v22.0";
  const phoneNumberId = process.env.WHATSAPP_BUSINESS_PHONE_NUMBER_ID;
  const accessToken = process.env.WHATSAPP_ACCESS_TOKEN;

  // Check if required environment variables are set
  if (!phoneNumberId || !accessToken) {
    return false;
  }

  // WhatsApp Business API endpoint
  const url = `https://graph.facebook.com/${apiVersion}/${phoneNumberId}/messages`;

  // Message payload following WhatsApp API format
  const payload = {
    messaging_product: "whatsapp",
    recipient_type: "individual",
    to: to,
    type: "text",
    text: {
      body: message,
    },
  };

  try {
    // Send message via WhatsApp Business API
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${accessToken}`,
      },
      body: JSON.stringify(payload),
    });

    const result = await response.json();

    if (response.ok) {
      console.log(`âœ… WhatsApp message sent to ${to}: "${message}"`);
      return true;
    } else {
      console.error("âŒ Failed to send WhatsApp message:", result);
      return false;
    }
  } catch (error) {
    console.error("âŒ Error sending WhatsApp message:", error);
    return false;
  }
}
```

## åˆ›å»ºèŠå¤©ä»£ç†

æ­¤ä»£ç†å¤„ç†ä¸»è¦å¯¹è¯é€»è¾‘ï¼Œå…·æœ‰å‹å¥½ã€å¯¹è¯å¼çš„ä¸ªæ€§ã€‚

```typescript title="src/mastra/agents/chat-agent.ts"
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const chatAgent = new Agent({
  id: "chat-agent",
  name: "Chat Agent",
  instructions: `
    You are a helpful, friendly, and knowledgeable AI assistant that loves to chat with users via WhatsApp.

    Your personality:
    - Warm, approachable, and conversational
    - Enthusiastic about helping with any topic
    - Use a casual, friendly tone like you're chatting with a friend
    - Be concise but informative
    - Show genuine interest in the user's questions

    Your capabilities:
    - Answer questions on a wide variety of topics
    - Provide helpful advice and suggestions
    - Engage in casual conversation
    - Help with problem-solving and creative tasks
    - Explain complex topics in simple terms

    Guidelines:
    - Keep responses informative but not overwhelming
    - Ask follow-up questions when appropriate
    - Be encouraging and positive
    - If you don't know something, admit it honestly
    - Adapt your communication style to match the user's tone
    - Remember this is WhatsApp, so keep it conversational and natural

    Always aim to be helpful while maintaining a friendly, approachable conversation style.
  `,
  model: "anthropic/claude-4-sonnet-20250514",
  memory: new Memory({
    storage: new LibSQLStore({
      id: 'agent-storage',
      url: "file:../mastra.db",
    }),
  }),
});
```

## åˆ›å»ºæ–‡æœ¬æ¶ˆæ¯ä»£ç†

æ­¤ä»£ç†å°†è¾ƒé•¿çš„å“åº”è½¬æ¢ä¸ºé€‚åˆ WhatsApp çš„è‡ªç„¶çš„ã€å°å—çš„æ–‡æœ¬æ¶ˆæ¯ã€‚

```typescript title="src/mastra/agents/text-message-agent.ts"
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const textMessageAgent = new Agent({
  id: "text-message-agent",
  name: "Text Message Agent",
  instructions: `
    You are a text message converter that takes formal or lengthy text and breaks it down into natural, casual text messages.

    Your job is to:
    - Convert any input text into 5-8 short, casual text messages
    - Each message should be 1-2 sentences maximum
    - Use natural, friendly texting language (contractions, casual tone)
    - Maintain all the important information from the original text
    - Make it feel like you're texting a friend
    - Use appropriate emojis sparingly to add personality
    - Keep the conversational flow logical and easy to follow

    Think of it like you're explaining something exciting to a friend via text - break it into bite-sized, engaging messages that don't overwhelm them with a long paragraph.

    Always return exactly 5-8 messages in the messages array.
  `,
  model: "anthropic/claude-4-sonnet-20250514",
  memory: new Memory({
    storage: new LibSQLStore({
      id: 'agent-storage',
      url: "file:../mastra.db",
    }),
  }),
});
```

## åˆ›å»ºèŠå¤©å·¥ä½œæµ

æ­¤å·¥ä½œæµç¼–æ’æ•´ä¸ªèŠå¤©è¿‡ç¨‹ï¼šç”Ÿæˆå“åº”ï¼Œå°†å…¶æ‹†åˆ†æˆæ¶ˆæ¯ï¼Œå¹¶é€šè¿‡ WhatsApp å‘é€ã€‚

```typescript title="src/mastra/workflows/chat-workflow.ts"
import { createStep, createWorkflow } from "@mastra/core/workflows";
import { z } from "zod";
import { sendWhatsAppMessage } from "../../whatsapp-client";

const respondToMessage = createStep({
  id: "respond-to-message",
  description: "Generate response to user message",
  inputSchema: z.object({ userMessage: z.string() }),
  outputSchema: z.object({ response: z.string() }),
  execute: async ({ inputData, mastra }) => {
    const agent = mastra?.getAgent("chatAgent");
    if (!agent) {
      throw new Error("Chat agent not found");
    }

    const response = await agent.generate([
      { role: "user", content: inputData.userMessage },
    ]);

    return { response: response.text };
  },
});

const breakIntoMessages = createStep({
  id: "break-into-messages",
  description: "Breaks response into text messages",
  inputSchema: z.object({ prompt: z.string() }),
  outputSchema: z.object({ messages: z.array(z.string()) }),
  execute: async ({ inputData, mastra }) => {
    const agent = mastra?.getAgent("textMessageAgent");
    if (!agent) {
      throw new Error("Text Message agent not found");
    }

    const response = await agent.generate(
      [{ role: "user", content: inputData.prompt }],
      {
        structuredOutput: {
          schema: z.object({
            messages: z.array(z.string()),
          }),
        },
      },
    );

    if (!response.object) throw new Error("Error generating messages");

    return response.object;
  },
});

const sendMessages = createStep({
  id: "send-messages",
  description: "Sends text messages via WhatsApp",
  inputSchema: z.object({
    messages: z.array(z.string()),
    userPhone: z.string(),
  }),
  outputSchema: z.object({ sentCount: z.number() }),
  execute: async ({ inputData }) => {
    const { messages, userPhone } = inputData;

    console.log(
      `\nğŸ”¥ Sending ${messages.length} WhatsApp messages to ${userPhone}...`,
    );

    let sentCount = 0;

    // Send each message with a small delay for natural flow
    for (let i = 0; i < messages.length; i++) {
      const success = await sendWhatsAppMessage({
        to: userPhone,
        message: messages[i],
      });

      if (success) {
        sentCount++;
      }

      // Add delay between messages for natural texting rhythm
      if (i < messages.length - 1) {
        await new Promise((resolve) => setTimeout(resolve, 1000));
      }
    }

    console.log(
      `\nâœ… Successfully sent ${sentCount}/${messages.length} WhatsApp messages\n`,
    );

    return { sentCount };
  },
});

export const chatWorkflow = createWorkflow({
  id: "chat-workflow",
  inputSchema: z.object({ userMessage: z.string() }),
  outputSchema: z.object({ sentCount: z.number() }),
})
  .then(respondToMessage)
  .map(async ({ inputData }) => ({
    prompt: `Break this AI response into 3-8 casual, friendly text messages that feel natural for WhatsApp conversation:\n\n${inputData.response}`,
  }))
  .then(breakIntoMessages)
  .map(async ({ inputData, getInitData }) => {
    // Parse the original stringified input to get user phone
    const initData = getInitData<typeof chatWorkflow>();
    const webhookData = JSON.parse(initData.userMessage);
    const userPhone =
      webhookData.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from ||
      "unknown";

    return {
      messages: inputData.messages,
      userPhone,
    };
  })
  .then(sendMessages);

chatWorkflow.commit();
```

## è®¾ç½® Mastra é…ç½®

ä½¿ç”¨ä»£ç†ã€å·¥ä½œæµå’Œ WhatsApp webhook ç«¯ç‚¹é…ç½®æ‚¨çš„ Mastra å®ä¾‹ã€‚

```typescript title="src/mastra/index.ts"
import { Mastra } from "@mastra/core";
import { registerApiRoute } from "@mastra/core/server";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";

import { chatWorkflow } from "./workflows/chat-workflow";
import { textMessageAgent } from "./agents/text-message-agent";
import { chatAgent } from "./agents/chat-agent";

export const mastra = new Mastra({
  workflows: { chatWorkflow },
  agents: { textMessageAgent, chatAgent },
  storage: new LibSQLStore({
    id: 'agent-storage',
    url: ":memory:",
  }),
  logger: new PinoLogger({
    name: "Mastra",
    level: "info",
  }),
  server: {
    apiRoutes: [
      registerApiRoute("/whatsapp", {
        method: "GET",
        handler: async (c) => {
          const verifyToken = process.env.WHATSAPP_VERIFY_TOKEN;
          const {
            "hub.mode": mode,
            "hub.challenge": challenge,
            "hub.verify_token": token,
          } = c.req.query();

          if (mode === "subscribe" && token === verifyToken) {
            return c.text(challenge, 200);
          } else {
            return c.status(403);
          }
        },
      }),
      registerApiRoute("/whatsapp", {
        method: "POST",
        handler: async (c) => {
          const mastra = c.get("mastra");
          const chatWorkflow = mastra.getWorkflow("chatWorkflow");

          const body = await c.req.json();

          const workflowRun = await chatWorkflow.createRun();
          const runResult = await workflowRun.start({
            inputData: { userMessage: JSON.stringify(body) },
          });

          return c.json(runResult);
        },
      }),
    ],
  },
});
```

## æµ‹è¯•èŠå¤©æœºå™¨äºº

æ‚¨å¯ä»¥é€šè¿‡æ¨¡æ‹Ÿ WhatsApp webhook è´Ÿè½½åœ¨æœ¬åœ°æµ‹è¯•èŠå¤©æœºå™¨äººã€‚

```typescript title="src/test-whatsapp-bot.ts"
import "dotenv/config";

import { mastra } from "./mastra";

// Simulate a WhatsApp webhook payload
const mockWebhookData = {
  entry: [
    {
      changes: [
        {
          value: {
            messages: [
              {
                from: "1234567890", // Test phone number
                text: {
                  body: "Hello! How are you today?",
                },
              },
            ],
          },
        },
      ],
    },
  ],
};

const workflow = mastra.getWorkflow("chatWorkflow");
const workflowRun = await workflow.createRun();

const result = await workflowRun.start({
  inputData: { userMessage: JSON.stringify(mockWebhookData) },
});

console.log("Workflow completed:", result);
```

## ç¤ºä¾‹è¾“å‡º

å½“ç”¨æˆ·å‘æ‚¨çš„ WhatsApp æœºå™¨äººå‘é€"Hello! How are you today?"æ—¶ï¼Œå®ƒå¯èƒ½ä¼šå›å¤å¤šæ¡æ¶ˆæ¯ï¼Œå¦‚ï¼š

```text
Hey there! ğŸ‘‹ I'm doing great, thanks for asking!

How's your day going so far?

I'm here and ready to chat about whatever's on your mind

Whether you need help with something or just want to talk, I'm all ears! ğŸ˜Š

What's new with you?
```

æœºå™¨äººé€šè¿‡å†…å­˜ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œå¹¶æä¾›é€‚åˆ WhatsApp æ¶ˆæ¯ä¼ é€’çš„è‡ªç„¶å“åº”ã€‚
