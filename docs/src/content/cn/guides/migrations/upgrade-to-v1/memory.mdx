---
title: "Memory | v1 迁移指南"
description: "了解在升级到 v1 时如何迁移内存相关的更改。"
---

# 内存

内存配置现在需要显式参数，默认设置已更新以获得更好的性能和可预测性。

## 变更

### 语义回忆和最后消息的默认设置

默认设置已根据使用模式更改为更合理的值。`lastMessages` 默认值从 40 减少到 10，`semanticRecall` 现在默认禁用，线程标题生成默认禁用。这些更改提高了性能并减少了意外的 LLM API 调用。

要迁移，如果您依赖旧的默认值，请显式配置这些设置。

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
+   options: {
+     lastMessages: 40, // 以前是默认值
+     semanticRecall: {
+       topK: 2,
+       messageRange: 2,
+       scope: 'thread',
+     }, // 以前默认启用
+     generateTitle: true, // 以前默认启用
+   },
  });
```

### 默认内存范围从 `thread` 改为 `resource`

工作内存和语义回忆的默认范围已从 `'thread'` 更改为 `'resource'`。此更改与常见的用例一致，即应用程序希望跨对话记住用户信息。当启用语义回忆时，它现在默认跨所有用户对话搜索，而不仅仅是当前线程。

要迁移，如果您想保持内存按对话线程隔离的旧行为，请显式设置 `scope: 'thread'`。

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
      workingMemory: {
        enabled: true,
+       scope: 'thread', // 显式设置为线程作用域
        template: `# User Profile...`,
      },
      semanticRecall: {
        topK: 3,
+       scope: 'thread', // 显式设置为线程作用域
      },
    },
  });
```

### 线程标题生成位置

`generateTitle` 选项已从 `threads.generateTitle` 移至内存选项的顶层。此更改通过将选项移至其逻辑所属的位置来简化 API。

要迁移，将 `generateTitle` 从 `threads` 配置移至选项的顶层。

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
-     threads: {
-       generateTitle: true,
-     },
+     generateTitle: true,
    },
  });
```

### 语义回忆默认设置优化

语义回忆的默认设置已根据 RAG 研究进行了优化。`topK` 从 2 增加到 4，`messageRange` 从 `{ before: 2, after: 2 }` 更改为 `{ before: 1, after: 1 }`。这些更改提供了更好的准确性，同时仅略微增加消息数量。

要迁移，如果您依赖以前的默认值，请显式设置这些值。

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
      semanticRecall: {
+       topK: 2, // 以前是默认值
+       messageRange: { before: 2, after: 2 }, // 以前是默认值
      },
    },
  });
```

### `memory.readOnly` 移至 `memory.options.readOnly`

`readOnly` 属性已从内存选项的顶层移至 `options` 内部。此更改使 `readOnly` 与其他内存配置选项（如 `lastMessages` 和 `semanticRecall`）保持一致。

要迁移，将 `readOnly` 从顶层移至 `options` 内部。

```diff
  agent.stream('Hello', {
    memory: {
      thread: threadId,
      resource: resourceId,
-     readOnly: true,
+     options: {
+       readOnly: true,
+     },
    },
  });
```

:::tip[Codemod]

您可以使用 Mastra 的 codemod CLI 自动更新代码：

```bash
npx @mastra/codemod@latest v1/memory-readonly-to-options .
```

:::

### `Memory.query()` 重命名为 `Memory.recall()`

`Memory.query()` 方法已重命名为 `Memory.recall()`。新方法返回更简单的格式，只有 `{ messages: MastraDBMessage[] }`，而不是多种格式变体。此更改更好地描述了从内存检索消息的操作并简化了 API。

要迁移，将 `query()` 重命名为 `recall()` 并更新期望旧返回格式的代码。

```diff
- const result = await memory.query({ threadId: 'thread-123' });
+ const result = await memory.recall({ threadId: 'thread-123' });
- // result: { messages: CoreMessage[], uiMessages: UIMessageWithMetadata[], messagesV2: MastraMessageV2[] }
+ // result: { messages: MastraDBMessage[] }
+ const messages = result.messages;
```

:::tip[Codemod]

您可以使用 Mastra 的 codemod CLI 自动更新代码：

```bash
npx @mastra/codemod@latest v1/memory-query-to-recall .
```

:::

### `Memory.recall()` 参数更改

`Memory.recall()` 方法现在使用带有分页的 `StorageListMessagesInput` 格式，`vectorMessageSearch` 参数已重命名为 `vectorSearchString`。这些更改使内存 API 与存储分页 API 保持一致，并提供更一致的命名。

要迁移，更新方法名称、查询参数和向量搜索参数。

```diff
- memory.query({
+ memory.recall({
    threadId: 'thread-123',
-   vectorMessageSearch: 'What did we discuss?',
-   selectBy: { ... },
+   vectorSearchString: 'What did we discuss?',
+   page: 0,
+   perPage: 20,
+   orderBy: 'createdAt',
+   filter: { ... },
+   threadConfig: { semanticRecall: true },
  });
```

:::tip[Codemod]

您可以使用 Mastra 的 codemod CLI 自动更新代码：

```bash
npx @mastra/codemod@latest v1/memory-vector-search-param .
```

:::

### `MastraMessageV2` 类型重命名为 `MastraDBMessage`

`MastraMessageV2` 类型已重命名为 `MastraDBMessage` 以提高清晰度。此更改更好地描述了该类型作为数据库消息格式的用途。

要迁移，将所有 `MastraMessageV2` 实例替换为 `MastraDBMessage`。

```diff
- import { MastraMessageV2 } from '@mastra/core';
- function yourCustomFunction(input: MastraMessageV2) {}
+ import { MastraDBMessage } from '@mastra/core';
+ function yourCustomFunction(input: MastraDBMessage) {}
```

:::tip[Codemod]

您可以使用 Mastra 的 codemod CLI 自动更新代码：

```bash
npx @mastra/codemod@latest v1/memory-message-v2-type .
```

:::

## 移除

### 工作内存 `text-stream` 模式

工作内存 `use: "text-stream"` 选项已被移除。仅支持 `tool-call` 模式。此更改通过删除不太可靠的流式模式来简化工作内存 API。

要迁移，移除 `use: "text-stream"` 选项。工作内存将默认为 tool-call 模式。

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
      workingMemory: {
        enabled: true,
-       use: 'text-stream',
        template: '...',
      },
    },
  });
```

### `Memory.rememberMessages()` 方法

`Memory.rememberMessages()` 方法已被移除。此方法执行与 `query()`（现在是 `recall()`）相同的功能，合并为一个方法简化了 API。

要迁移，将 `rememberMessages()` 调用替换为 `recall()`。

```diff
- const { messages } = await memory.rememberMessages({
+ const { messages } = await memory.recall({
    threadId,
    resourceId,
  });
```

### 内存方法中的 `format` 参数

`format` 参数已从所有内存获取方法中移除。`MastraDBMessage` 现在是所有地方的默认返回格式。AI SDK 格式转换已移至 `@mastra/ai-sdk/ui` 中的专用实用函数。此更改通过将特定于 UI 的转换代码移至单独的包来改进摇树优化。

要迁移，移除 `format` 参数并使用 AI SDK 格式的转换函数。

```diff
- const messages = await memory.getMessages({ threadId, format: 'v2' });
- const uiMessages = await memory.getMessages({ threadId, format: 'ui' });

+ const result = await memory.recall({ threadId });
+ const messages = result.messages; // 始终是 MastraDBMessage[]
+
+ // 使用 AI SDK 格式的转换函数
+ import { toAISdkV5Messages } from '@mastra/ai-sdk/ui';
+ const uiMessages = toAISdkV5Messages(messages);
```

### `MastraMessageV3` 类型

`MastraMessageV3` 类型和相关的转换方法已被移除。消息现在直接在 `MastraMessageV2`（现在是 `MastraDBMessage`）和 AI SDK v5 格式之间转换。此更改通过移除中间格式来简化架构。

要迁移，直接使用 `MastraDBMessage` 进行存储或 AI SDK v5 消息格式。

```diff
- import type { MastraMessageV3 } from '@mastra/core/agent';
- const v3Messages = messageList.get.all.v3();

+ // 用于存储
+ const v2Messages = messageList.get.all.v2();
+
+ // 用于 AI SDK v5
+ const uiMessages = messageList.get.all.aiV5.ui();
+ const modelMessages = messageList.get.all.aiV5.model();
```

### Memory 构造函数中的 `processors` 配置

Memory 构造函数中的 `processors` 配置选项已被弃用，现在会抛出错误。处理器应在 Agent 级别配置。此更改提供了更清晰的配置边界和更好的封装。

要迁移，使用 `inputProcessors` 和/或 `outputProcessors` 将处理器配置从 Memory 移至 Agent。

```diff
+ import { TokenLimiter } from '@mastra/core/processors';

  const memory = new Memory({
    storage,
    vector,
    embedder,
-   processors: [/* ... */],
  });

  const agent = new Agent({
    memory,
+   inputProcessors: [
+     new TokenLimiter({ limit: 4000 }), // 限制历史消息以适应上下文窗口
+   ],
  });
```

此外，`@mastra/memory/processors` 导入路径已被移除。请改从 `@mastra/core/processors` 导入处理器。详细信息请参阅[处理器迁移指南](/cn/guides/migrations/upgrade-to-v1/processors#内存处理器导出移至核心)。

有关将处理器与代理一起使用的更多信息，请参阅[处理器文档](/docs/cn/agents/processors)。有关内存的完整示例，请参阅 [TokenLimiter 参考](/cn/reference/processors/token-limiter-processor#扩展使用示例)。
