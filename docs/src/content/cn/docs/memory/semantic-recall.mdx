---
title: "è¯­ä¹‰å›å¿† | å†…å­˜"
description: "äº†è§£å¦‚ä½•åœ¨ Mastra ä¸­ä½¿ç”¨è¯­ä¹‰å›å¿†é€šè¿‡å‘é‡æœç´¢å’ŒåµŒå…¥ä»è¿‡å»çš„å¯¹è¯ä¸­æ£€ç´¢ç›¸å…³æ¶ˆæ¯ã€‚"
packages:
  - "@mastra/core"
  - "@mastra/fastembed"
  - "@mastra/libsql"
  - "@mastra/memory"
  - "@mastra/pg"
---

# è¯­ä¹‰å›å¿†

å¦‚æœæ‚¨é—®æ‚¨çš„æœ‹å‹ä¸Šå‘¨æœ«åšäº†ä»€ä¹ˆï¼Œä»–ä»¬ä¼šåœ¨è®°å¿†ä¸­æœç´¢ä¸"ä¸Šå‘¨æœ«"ç›¸å…³çš„äº‹ä»¶ï¼Œç„¶åå‘Šè¯‰æ‚¨ä»–ä»¬çš„æ‰€ä½œæ‰€ä¸ºã€‚è¿™å°±æ˜¯ Mastra ä¸­è¯­ä¹‰å›å¿†çš„å·¥ä½œæ–¹å¼ã€‚

:::tip[è§‚çœ‹ ğŸ“¹]

ä»€ä¹ˆæ˜¯è¯­ä¹‰å›å¿†ã€å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ä»¥åŠå¦‚ä½•åœ¨ Mastra ä¸­é…ç½®å®ƒ â†’ [YouTubeï¼ˆ5 åˆ†é’Ÿï¼‰](https://youtu.be/UVZtK8cK8xQ)

:::

## è¯­ä¹‰å›å¿†çš„å·¥ä½œåŸç†

è¯­ä¹‰å›å¿†æ˜¯åŸºäº RAG çš„æœç´¢ï¼Œå½“æ¶ˆæ¯ä¸å†åœ¨[æœ€è¿‘æ¶ˆæ¯å†å²è®°å½•](./message-history)èŒƒå›´å†…æ—¶ï¼Œå®ƒå¯ä»¥å¸®åŠ©æ™ºèƒ½ä½“åœ¨æ›´é•¿çš„äº¤äº’ä¸­ä¿æŒä¸Šä¸‹æ–‡ã€‚

å®ƒä½¿ç”¨æ¶ˆæ¯çš„å‘é‡åµŒå…¥è¿›è¡Œç›¸ä¼¼æ€§æœç´¢ï¼Œä¸å„ç§å‘é‡å­˜å‚¨é›†æˆï¼Œå¹¶å¯é…ç½®æ£€ç´¢æ¶ˆæ¯å‘¨å›´çš„ä¸Šä¸‹æ–‡çª—å£ã€‚

![æ˜¾ç¤º Mastra å†…å­˜è¯­ä¹‰å›å¿†çš„å›¾è¡¨](/img/semantic-recall.png)

å¯ç”¨åï¼Œæ–°æ¶ˆæ¯ç”¨äºæŸ¥è¯¢å‘é‡æ•°æ®åº“ä»¥è·å–è¯­ä¹‰ç›¸ä¼¼çš„æ¶ˆæ¯ã€‚

åœ¨ä»å¤§å‹è¯­è¨€æ¨¡å‹è·å¾—å“åº”åï¼Œæ‰€æœ‰æ–°æ¶ˆæ¯ï¼ˆç”¨æˆ·ã€åŠ©æ‰‹å’Œå·¥å…·è°ƒç”¨/ç»“æœï¼‰éƒ½ä¼šè¢«æ’å…¥åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼Œä»¥ä¾¿åœ¨ä»¥åçš„äº¤äº’ä¸­å›å¿†ã€‚

## å¿«é€Ÿå…¥é—¨

è¯­ä¹‰å›å¿†é»˜è®¤å¯ç”¨ï¼Œå› æ­¤å¦‚æœæ‚¨ç»™æ‚¨çš„æ™ºèƒ½ä½“æä¾›è®°å¿†ï¼Œå®ƒä¼šè¢«åŒ…å«ï¼š

```typescript {9}
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";

const agent = new Agent({
  id: "support-agent",
  name: "SupportAgent",
  instructions: "You are a helpful support agent.",
  model: "openai/gpt-5.1",
  memory: new Memory(),
});
```

## ä½¿ç”¨ recall() æ–¹æ³•

è™½ç„¶ `listMessages` é€šè¿‡çº¿ç¨‹ ID å’ŒåŸºæœ¬åˆ†é¡µæ£€ç´¢æ¶ˆæ¯ï¼Œä½† [`recall()`](/reference/memory/recall) æ·»åŠ äº†**è¯­ä¹‰æœç´¢**æ”¯æŒã€‚å½“æ‚¨éœ€è¦æŒ‰å«ä¹‰è€Œä¸æ˜¯ä»…æŒ‰æ—¶é—´é¡ºåºæŸ¥æ‰¾æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨å¸¦æœ‰ `vectorSearchString` çš„ `recall()`ï¼š

```typescript
const memory = await agent.getMemory();

// åŸºæœ¬å›å¿† - ç±»ä¼¼äº listMessages
const { messages } = await memory!.recall({
  threadId: "thread-123",
  perPage: 50,
});

// è¯­ä¹‰å›å¿† - æŒ‰å«ä¹‰æŸ¥æ‰¾æ¶ˆæ¯
const { messages: relevantMessages } = await memory!.recall({
  threadId: "thread-123",
  vectorSearchString: "æˆ‘ä»¬è®¨è®ºäº†å…³äºé¡¹ç›®æˆªæ­¢æ—¥æœŸçš„ä»€ä¹ˆå†…å®¹ï¼Ÿ",
  threadConfig: {
    semanticRecall: true,
  },
});
```

## å­˜å‚¨é…ç½®

è¯­ä¹‰å›å¿†ä¾èµ–[å­˜å‚¨å’Œå‘é‡æ•°æ®åº“](/reference/memory/memory-class)æ¥å­˜å‚¨æ¶ˆæ¯åŠå…¶åµŒå…¥ã€‚

```ts {8-16}
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { LibSQLStore, LibSQLVector } from "@mastra/libsql";

const agent = new Agent({
  memory: new Memory({
    // å¦‚æœçœç•¥ï¼Œè¿™æ˜¯é»˜è®¤çš„å­˜å‚¨æ•°æ®åº“
    storage: new LibSQLStore({
      id: 'agent-storage',
      url: "file:./local.db",
    }),
    // å¦‚æœçœç•¥ï¼Œè¿™æ˜¯é»˜è®¤çš„å‘é‡æ•°æ®åº“
    vector: new LibSQLVector({
      id: 'agent-vector',
      url: "file:./local.db",
    }),
  }),
});
```

æ¯ä¸ªå‘é‡å­˜å‚¨é¡µé¢éƒ½åŒ…å«å®‰è£…è¯´æ˜ã€é…ç½®å‚æ•°å’Œä½¿ç”¨ç¤ºä¾‹ï¼š

- [Astra](/reference/vectors/astra)
- [Chroma](/reference/vectors/chroma)
- [Cloudflare Vectorize](/reference/vectors/vectorize)
- [Convex](/reference/vectors/convex)
- [Couchbase](/reference/vectors/couchbase)
- [DuckDB](/reference/vectors/duckdb)
- [Elasticsearch](/reference/vectors/elasticsearch)
- [LanceDB](/reference/vectors/lance)
- [libSQL](/reference/vectors/libsql)
- [MongoDB](/reference/vectors/mongodb)
- [OpenSearch](/reference/vectors/opensearch)
- [Pinecone](/reference/vectors/pinecone)
- [PostgreSQL](/reference/vectors/pg)
- [Qdrant](/reference/vectors/qdrant)
- [S3 Vectors](/reference/vectors/s3vectors)
- [Turbopuffer](/reference/vectors/turbopuffer)
- [Upstash](/reference/vectors/upstash)

## å›å¿†é…ç½®

æ§åˆ¶è¯­ä¹‰å›å¿†è¡Œä¸ºçš„ä¸‰ä¸ªä¸»è¦å‚æ•°æ˜¯ï¼š

1. **topK**ï¼šæ£€ç´¢å¤šå°‘æ¡è¯­ä¹‰ç›¸ä¼¼çš„æ¶ˆæ¯
2. **messageRange**ï¼šæ¯æ¬¡åŒ¹é…å‘¨å›´åŒ…å«å¤šå°‘ä¸Šä¸‹æ–‡
3. **scope**ï¼šæ˜¯åœ¨å½“å‰çº¿ç¨‹å†…æœç´¢è¿˜æ˜¯åœ¨èµ„æºæ‹¥æœ‰çš„æ‰€æœ‰çº¿ç¨‹ä¸­æœç´¢ï¼ˆé»˜è®¤æ˜¯èµ„æºä½œç”¨åŸŸï¼‰ã€‚

```typescript {5-7}
const agent = new Agent({
  memory: new Memory({
    options: {
      semanticRecall: {
        topK: 3, // æ£€ç´¢ 3 æ¡æœ€ç›¸ä¼¼çš„æ¶ˆæ¯
        messageRange: 2, // æ¯æ¬¡åŒ¹é…å‰ååŒ…å« 2 æ¡æ¶ˆæ¯
        scope: "resource", // æœç´¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰çº¿ç¨‹ï¼ˆå¦‚æœçœç•¥ï¼Œè¿™æ˜¯é»˜è®¤è®¾ç½®ï¼‰
      },
    },
  }),
});
```

## åµŒå…¥æ¨¡å‹é…ç½®

è¯­ä¹‰å›å¿†ä¾èµ–[åµŒå…¥æ¨¡å‹](/reference/memory/memory-class)å°†æ¶ˆæ¯è½¬æ¢ä¸ºåµŒå…¥ã€‚Mastra æ”¯æŒé€šè¿‡ä½¿ç”¨ `provider/model` å­—ç¬¦ä¸²çš„æ¨¡å‹è·¯ç”±å™¨ä½¿ç”¨åµŒå…¥æ¨¡å‹ï¼Œæˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸ AI SDK å…¼å®¹çš„[åµŒå…¥æ¨¡å‹](https://sdk.vercel.ai/docs/cn/ai-sdk-core/embeddings)ã€‚

#### ä½¿ç”¨æ¨¡å‹è·¯ç”±å™¨ï¼ˆæ¨èï¼‰

æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨å¸¦æœ‰è‡ªåŠ¨å®Œæˆæ”¯æŒçš„ `provider/model` å­—ç¬¦ä¸²ï¼š

```ts {7}
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { ModelRouterEmbeddingModel } from "@mastra/core/llm";

const agent = new Agent({
  memory: new Memory({
    embedder: new ModelRouterEmbeddingModel("openai/text-embedding-3-small"),
  }),
});
```

æ”¯æŒçš„åµŒå…¥æ¨¡å‹ï¼š

- **OpenAI**ï¼š`text-embedding-3-small`ã€`text-embedding-3-large`ã€`text-embedding-ada-002`
- **Google**ï¼š`gemini-embedding-001`

æ¨¡å‹è·¯ç”±å™¨è‡ªåŠ¨å¤„ç†ç¯å¢ƒå˜é‡ä¸­çš„ API å¯†é’¥æ£€æµ‹ï¼ˆ`OPENAI_API_KEY`ã€`GOOGLE_GENERATIVE_AI_API_KEY`ï¼‰ã€‚

#### ä½¿ç”¨ AI SDK åŒ…

æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ AI SDK åµŒå…¥æ¨¡å‹ï¼š

```ts {2,7}
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { ModelRouterEmbeddingModel } from "@mastra/core/llm";

const agent = new Agent({
  memory: new Memory({
    embedder: new ModelRouterEmbeddingModel("openai/text-embedding-3-small"),
  }),
});
```

#### ä½¿ç”¨ FastEmbedï¼ˆæœ¬åœ°ï¼‰

è¦ä½¿ç”¨ FastEmbedï¼ˆæœ¬åœ°åµŒå…¥æ¨¡å‹ï¼‰ï¼Œè¯·å®‰è£… `@mastra/fastembed`ï¼š

```bash npm2yarn
npm install @mastra/fastembed@latest
```

ç„¶ååœ¨æ‚¨çš„è®°å¿†ä¸­é…ç½®å®ƒï¼š

```ts {3,7}
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { fastembed } from "@mastra/fastembed";

const agent = new Agent({
  memory: new Memory({
    embedder: fastembed,
  }),
});
```

## PostgreSQL ç´¢å¼•ä¼˜åŒ–

å½“ä½¿ç”¨ PostgreSQL ä½œä¸ºå‘é‡å­˜å‚¨æ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡é…ç½®å‘é‡ç´¢å¼•æ¥ä¼˜åŒ–è¯­ä¹‰å›å¿†æ€§èƒ½ã€‚è¿™å¯¹äºå…·æœ‰æ•°åƒæ¡æ¶ˆæ¯çš„å¤§è§„æ¨¡éƒ¨ç½²å°¤ä¸ºé‡è¦ã€‚

PostgreSQL æ”¯æŒ IVFFlat å’Œ HNSW ç´¢å¼•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒMastra åˆ›å»º IVFFlat ç´¢å¼•ï¼Œä½† HNSW ç´¢å¼•é€šå¸¸æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯å¯¹äºä½¿ç”¨å†…ç§¯è·ç¦»çš„ OpenAI åµŒå…¥ã€‚

```typescript {18-23}
import { Memory } from "@mastra/memory";
import { PgStore, PgVector } from "@mastra/pg";

const agent = new Agent({
  memory: new Memory({
    storage: new PgStore({
      id: 'agent-storage',
      connectionString: process.env.DATABASE_URL,
    }),
    vector: new PgVector({
      id: 'agent-vector',
      connectionString: process.env.DATABASE_URL,
    }),
    options: {
      semanticRecall: {
        topK: 5,
        messageRange: 2,
        indexConfig: {
          type: "hnsw", // ä½¿ç”¨ HNSW ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½
          metric: "dotproduct", // æœ€ä½³ OpenAI åµŒå…¥
          m: 16, // åŒå‘é“¾æ¥æ•°é‡ï¼ˆé»˜è®¤ï¼š16ï¼‰
          efConstruction: 64, // æ„å»ºæœŸé—´çš„å€™é€‰åˆ—è¡¨å¤§å°ï¼ˆé»˜è®¤ï¼š64ï¼‰
        },
      },
    },
  }),
});
```

æœ‰å…³ç´¢å¼•é…ç½®é€‰é¡¹å’Œæ€§èƒ½è°ƒæ•´çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [PgVector é…ç½®æŒ‡å—](/reference/vectors/pg#index-configuration-guide)ã€‚

## ç¦ç”¨

ä½¿ç”¨è¯­ä¹‰å›å¿†ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ã€‚æ–°æ¶ˆæ¯ä¼šè¢«è½¬æ¢ä¸ºåµŒå…¥ï¼Œå¹¶åœ¨å°†æ–°æ¶ˆæ¯å‘é€åˆ°å¤§å‹è¯­è¨€æ¨¡å‹ä¹‹å‰ç”¨äºæŸ¥è¯¢å‘é‡æ•°æ®åº“ã€‚

è¯­ä¹‰å›å¿†é»˜è®¤å¯ç”¨ï¼Œä½†å¯ä»¥åœ¨ä¸éœ€è¦æ—¶ç¦ç”¨ï¼š

```typescript {4}
const agent = new Agent({
  memory: new Memory({
    options: {
      semanticRecall: false,
    },
  }),
});
```

æ‚¨å¯èƒ½å¸Œæœ›åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ç¦ç”¨è¯­ä¹‰å›å¿†ï¼š

- å½“æ¶ˆæ¯å†å²è®°å½•ä¸ºå½“å‰å¯¹è¯æä¾›è¶³å¤Ÿä¸Šä¸‹æ–‡æ—¶ã€‚
- åœ¨æ€§èƒ½æ•æ„Ÿå‹åº”ç”¨ç¨‹åºä¸­ï¼Œå¦‚å®æ—¶åŒå‘éŸ³é¢‘ï¼Œåˆ›å»ºåµŒå…¥å’Œè¿è¡Œå‘é‡æŸ¥è¯¢çš„é¢å¤–å»¶è¿Ÿå¾ˆæ˜æ˜¾ã€‚

## æŸ¥çœ‹å›å¿†çš„æ¶ˆæ¯

å¯ç”¨è·Ÿè¸ªæ—¶ï¼Œé€šè¿‡è¯­ä¹‰å›å¿†æ£€ç´¢çš„ä»»ä½•æ¶ˆæ¯å°†å‡ºç°åœ¨æ™ºèƒ½ä½“çš„è·Ÿè¸ªè¾“å‡ºä¸­ï¼Œä»¥åŠæœ€è¿‘çš„æ¶ˆæ¯å†å²è®°å½•ï¼ˆå¦‚æœå·²é…ç½®ï¼‰ã€‚
