---
title: "MCP 概述 | MCP"
description: 了解模型上下文协议（MCP）、如何通过 MCPClient 使用第三方工具、连接注册表以及如何使用 MCPServer 共享您自己的工具。
packages:
  - "@mastra/core"
  - "@mastra/mcp"
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# MCP 概述

Mastra 支持[模型上下文协议（MCP）](https://modelcontextprotocol.io/introduction)，这是一个将 AI 智能体连接到外部工具和资源的开放标准。它作为一个通用插件系统，使智能体能够调用无论使用何种语言或托管环境的工具。

Mastra 还可以用于编写 MCP 服务器，通过 MCP 接口公开智能体、工具和其他结构化资源。然后，这些资源可以被任何支持该协议的系统或智能体访问。

Mastra 目前支持两个 MCP 类：

1. `MCPClient`：连接到一个或多个 MCP 服务器以访问其工具、资源、提示，并处理引出请求。
2. `MCPServer`：向 MCP 兼容的客户端公开 Mastra 工具、智能体、工作流、提示和资源。

## 入门指南

要使用 MCP，请安装所需的依赖：

```bash npm2yarn
npm install @mastra/mcp@latest
```

## 配置 `MCPClient`

`MCPClient` 将 Mastra 基本元素连接到外部 MCP 服务器，这些服务器可以是本地包（使用 `npx` 调用）或远程 HTTP(S) 端点。根据托管方式的不同，每个服务器必须配置 `command` 或 `url`。

```typescript title="src/mastra/mcp/test-mcp-client.ts"
import { MCPClient } from "@mastra/mcp";

export const testMcpClient = new MCPClient({
  id: "test-mcp-client",
  servers: {
    wikipedia: {
      command: "npx",
      args: ["-y", "wikipedia-mcp"],
    },
    weather: {
      url: new URL(
        `https://server.smithery.ai/@smithery-ai/national-weather-service/mcp?api_key=${process.env.SMITHERY_API_KEY}`,
      ),
    },
  },
});
```

:::info

访问 [MCPClient](/reference/tools/mcp-client) 了解完整的配置选项列表。

:::

:::tip 身份验证

要连接受 OAuth 保护的 MCP 服务器，请参阅 [OAuth 身份验证](/reference/tools/mcp-client#oauth-authentication) 部分。

:::

## 将 `MCPClient` 与智能体一起使用

要在智能体中使用 MCP 服务器的工具，导入您的 `MCPClient` 并在 `tools` 参数中调用 `.listTools()`。这会从定义的 MCP 服务器加载工具，使它们对智能体可用。

```typescript {2,15} title="src/mastra/agents/test-agent.ts"
import { Agent } from "@mastra/core/agent";
import { testMcpClient } from "../mcp/test-mcp-client";

export const testAgent = new Agent({
  id: "test-agent",
  name: "Test Agent",
  description: "You are a helpful AI assistant",
  instructions: `
      您是一位有帮助的助手，可以访问以下 MCP 服务器。
      - Wikipedia MCP 服务器
      - 美国国家气象局服务

      使用 MCP 服务器找到的信息回答问题。`,
  model: "openai/gpt-5.1",
  tools: await testMcpClient.listTools(),
});
```

:::info

访问[智能体类](/reference/agents/agent)了解完整的配置选项列表。

:::

## 配置 `MCPServer`

要通过 HTTP(S) 将 Mastra 应用程序中的智能体、工具和工作流公开给外部系统，请使用 `MCPServer` 类。这使它们可以被任何支持该协议的系统或智能体访问。

```typescript title="src/mastra/mcp/test-mcp-server.ts"
import { MCPServer } from "@mastra/mcp";

import { testAgent } from "../agents/test-agent";
import { testWorkflow } from "../workflows/test-workflow";
import { testTool } from "../tools/test-tool";

export const testMcpServer = new MCPServer({
  id: "test-mcp-server",
  name: "Test Server",
  version: "1.0.0",
  agents: { testAgent },
  tools: { testTool },
  workflows: { testWorkflow },
});
```

:::info

访问 [MCPServer](/reference/tools/mcp-server) 了解完整的配置选项列表。

:::

:::tip 身份验证

要使用 OAuth 保护您的 MCP 服务器，请参阅 [OAuth 保护](/reference/tools/mcp-server#oauth-protection) 部分。

:::

## 注册 `MCPServer`

要使 MCP 服务器对支持该协议的其他系统或智能体可用，请在主 `Mastra` 实例中使用 `mcpServers` 注册它。

```typescript title="src/mastra/index.ts"
import { Mastra } from "@mastra/core/mastra";

import { testMcpServer } from "./mcp/test-mcp-server";

export const mastra = new Mastra({
  mcpServers: { testMcpServer },
});
```

## 静态工具和动态工具

`MCPClient` 提供了两种从连接的服务器检索工具的方法，适用于不同的应用程序架构：

| 功能 | 静态配置（`await mcp.listTools()`） | 动态配置（`await mcp.listToolsets()`） |
| :---------------- | :--------------------------------------------- | :--------------------------------------------------- |
| **用例** | 单用户、静态配置（例如 CLI 工具） | 多用户、动态配置（例如 SaaS 应用程序） |
| **配置** | 在智能体初始化时固定 | 每个请求动态配置 |
| **凭证** | 在所有使用中共享 | 可以因用户/请求而异 |
| **智能体设置** | 工具在 `Agent` 构造函数中添加 | 工具在 `.generate()` 或 `.stream()` 选项中传递 |

### 静态工具

使用 `.listTools()` 方法从所有配置的 MCP 服务器获取工具。当配置（如 API 密钥）在用户或请求之间是静态且一致时，这很合适。调用一次，并在定义智能体时将结果传递给 `tools` 属性。

:::info

访问 [listTools()](/reference/tools/mcp-client#listtools) 了解更多信息。

:::

```typescript {6} title="src/mastra/agents/test-agent.ts"
import { Agent } from "@mastra/core/agent";

import { testMcpClient } from "../mcp/test-mcp-client";

export const testAgent = new Agent({
  id: "test-agent",
  tools: await testMcpClient.listTools(),
});
```

### 动态工具

当工具配置可能因请求或用户而异时（例如在多租户系统中，每个用户提供自己的 API 密钥），请使用 `.listToolsets()` 方法。此方法返回工具集，可以传递给智能体的 `.generate()` 或 `.stream()` 调用中的 `toolsets` 选项。

```typescript {5-16,21}
import { MCPClient } from "@mastra/mcp";
import { mastra } from "./mastra";

async function handleRequest(userPrompt: string, userApiKey: string) {
  const userMcp = new MCPClient({
    servers: {
      weather: {
        url: new URL("http://localhost:8080/mcp"),
        requestInit: {
          headers: {
            Authorization: `Bearer ${userApiKey}`,
          },
        },
      },
    },
  });

  const agent = mastra.getAgent("testAgent");

  const response = await agent.generate(userPrompt, {
    toolsets: await userMcp.listToolsets(),
  });

  await userMcp.disconnect();

  return Response.json({
    data: response.text,
  });
}
```

:::info

访问 [listToolsets()](/reference/tools/mcp-client#listtoolsets) 了解更多信息。

:::

## 连接到 MCP 注册表

MCP 服务器可以通过注册表发现。以下是使用 `MCPClient` 连接一些流行的注册表的方法：

<Tabs>
  <TabItem value="klavis" label="Klavis AI">
    [Klavis AI](https://klavis.ai) 提供托管的、企业级认证的高质量 MCP 服务器。

    ```typescript
    import { MCPClient } from "@mastra/mcp";

    const mcp = new MCPClient({
      servers: {
        salesforce: {
          url: new URL("https://salesforce-mcp-server.klavis.ai/mcp/?instance_id={private-instance-id}"),
        },
        hubspot: {
          url: new URL("https://hubspot-mcp-server.klavis.ai/mcp/?instance_id={private-instance-id}"),
        },
      },
    });
    ```

    Klavis AI 为生产部署提供企业级认证和安全性。

    有关如何将 Mastra 与 Klavis 集成的更多详细信息，请查看他们的[文档](https://docs.klavis.ai/documentation/ai-platform-integration/mastra)。

  </TabItem>
  <TabItem value="mcp-run" label="mcp.run">
    [mcp.run](https://www.mcp.run/) 提供预认证、托管的 MCP 服务器。工具被分组到配置文件中，每个都有唯一的签名 URL。

    ```typescript
    import { MCPClient } from "@mastra/mcp";

    const mcp = new MCPClient({
      servers: {
        marketing: { // 示例配置名称
          url: new URL(process.env.MCP_RUN_SSE_URL!), // 从 mcp.run 配置获取 URL
        },
      },
    });
    ```

    > **重要：** 将 mcp.run SSE URL 视为密码。安全地存储它，例如，在环境变量中。
    > ```bash title=".env"
    > MCP_RUN_SSE_URL=https://www.mcp.run/api/mcp/sse?nonce=...
    > ```

  </TabItem>
  <TabItem value="composio" label="Composio.dev">
    [Composio.dev](https://composio.dev) 提供 [基于 SSE 的 MCP 服务器](https://mcp.composio.dev) 注册表。您可以直接使用为像 Cursor 这样的工具生成的 SSE URL。

    ```typescript
    import { MCPClient } from "@mastra/mcp";

    const mcp = new MCPClient({
      servers: {
        googleSheets: {
          url: new URL("https://mcp.composio.dev/googlesheets/[private-url-path]"),
        },
        gmail: {
          url: new URL("https://mcp.composio.dev/gmail/[private-url-path]"),
        },
      },
    });
    ```

    与 Google Sheets 等服务的身份验证通常通过智能体对话交互式发生。

    *注意：Composio URL 通常绑定到单个用户账户，使其最适合个人自动化而不是多租户应用程序。*

  </TabItem>
  <TabItem value="smithery" label="Smithery.ai">
    [Smithery.ai](https://smithery.ai) 提供可以通过其 CLI 访问的注册表。

    ```typescript
    // Unix/Mac
    import { MCPClient } from "@mastra/mcp";

    const mcp = new MCPClient({
      servers: {
        sequentialThinking: {
          command: "npx",
          args: [
            "-y",
            "@smithery/cli@latest",
            "run",
            "@smithery-ai/server-sequential-thinking",
            "--config",
            "{}",
          ],
        },
      },
    });
    ```

    ```typescript
    // Windows
    import { MCPClient } from "@mastra/mcp";

    const mcp = new MCPClient({
      servers: {
        sequentialThinking: {
          command: "npx",
          args: [
            "-y",
            "@smithery/cli@latest",
            "run",
            "@smithery-ai/server-sequential-thinking",
            "--config",
            "{}",
          ],
        },
      },
    });
    ```

  </TabItem>
  <TabItem value="ampersand" label="Ampersand">

[Ampersand](https://withampersand.com?utm_source=mastra-docs) 提供一个 [MCP 服务器](https://docs.withampersand.com/mcp)，允许您将智能体连接到 150 多种与 Salesforce、Hubspot 和 Zendesk 等 SaaS 产品的集成。

```typescript
// 使用 SSE 传输的 Ampersand MCP 服务器的 MCPClient
export const mcp = new MCPClient({
  servers: {
    "@amp-labs/mcp-server": {
      url: `https://mcp.withampersand.com/v1/sse?${new URLSearchParams({
        apiKey: process.env.AMPERSAND_API_KEY,
        project: process.env.AMPERSAND_PROJECT_ID,
        integrationName: process.env.AMPERSAND_INTEGRATION_NAME,
        groupRef: process.env.AMPERSAND_GROUP_REF,
      })}`,
    },
  },
});
```

```typescript
// 如果您更喜欢在本地运行 MCP 服务器：
import { MCPClient } from "@mastra/mcp";

// 使用 stdio 传输的 Ampersand MCP 服务器的 MCPClient
export const mcp = new MCPClient({
  servers: {
    "@amp-labs/mcp-server": {
      command: "npx",
      args: [
        "-y",
        "@amp-labs/mcp-server@latest",
        "--transport",
        "stdio",
        "--project",
        process.env.AMPERSAND_PROJECT_ID,
        "--integrationName",
        process.env.AMPERSAND_INTEGRATION_NAME,
        "--groupRef",
        process.env.AMPERSAND_GROUP_REF, // 可选
      ],
      env: {
        AMPERSAND_API_KEY: process.env.AMPERSAND_API_KEY,
      },
    },
  },
});
```

作为 MCP 的替代方案，Amperand 的 AI SDK 也有 Mastra 的适配器，因此您可以[直接导入 Ampersand 工具](https://docs.withampersand.com/ai-sdk#use-with-mastra)供您的智能体访问。

  </TabItem>
</Tabs>

## 相关内容

- [使用工具](/docs/cn/agents/using-tools)
- [MCPClient](/reference/tools/mcp-client)
- [MCPServer](/reference/tools/mcp-server)
