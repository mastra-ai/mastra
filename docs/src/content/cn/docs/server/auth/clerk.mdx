---
title: "MastraAuthClerk 类 | 认证"
description: "MastraAuthClerk 类的文档，该类使用 Clerk 身份验证对 Mastra 应用程序进行身份验证。"
packages:
  - "@mastra/auth-clerk"
  - "@mastra/client-js"
  - "@mastra/core"
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# MastraAuthClerk 类

`MastraAuthClerk` 类使用 Clerk 为 Mastra 提供身份验证。它使用 Clerk 的身份验证系统验证传入请求，并使用 `auth` 选项与 Mastra 服务器集成。

## 前置条件

此示例使用 Clerk 身份验证。请确保将您的 Clerk 凭据添加到 `.env` 文件中，并确保您的 Clerk 项目已正确配置。

```env title=".env"
CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_JWKS_URI=https://your-clerk-domain.clerk.accounts.dev/.well-known/jwks.json
```

:::note

您可以在 Clerk 仪表板的"API 密钥"下找到这些密钥。

:::

## 安装

在使用 `MastraAuthClerk` 类之前，您必须安装 `@mastra/auth-clerk` 包。

```bash
npm install @mastra/auth-clerk@latest
```

## 使用示例

```typescript {2,6-10} title="src/mastra/index.ts"
import { Mastra } from "@mastra/core";
import { MastraAuthClerk } from "@mastra/auth-clerk";

export const mastra = new Mastra({
  server: {
    auth: new MastraAuthClerk({
      publishableKey: process.env.CLERK_PUBLISHABLE_KEY,
      secretKey: process.env.CLERK_SECRET_KEY,
      jwksUri: process.env.CLERK_JWKS_URI,
    }),
  },
});
```

:::info

默认的 `authorizeUser` 方法允许所有已身份验证的用户。要自定义用户授权，请在构建提供程序时提供自定义 `authorizeUser` 函数。

访问 [MastraAuthClerk](/reference/auth/clerk) 了解所有可用的配置选项。

:::

## 客户端设置

使用 Clerk 身份验证时，您需要从客户端的 Clerk 检索访问令牌，并将其传递给您的 Mastra 请求。

### 检索访问令牌

使用 Clerk React Hook 对用户进行身份验证并检索他们的访问令牌：

```typescript title="lib/auth.ts"
import { useAuth } from "@clerk/nextjs";

export const useClerkAuth = () => {
  const { getToken } = useAuth();

  const getAccessToken = async () => {
    const token = await getToken();
    return token;
  };

  return { getAccessToken };
};
```

:::info

有关更多信息，请参阅 [Clerk 文档](https://clerk.com/docs)。

:::

## 配置 `MastraClient`

启用 `auth` 后，所有使用 `MastraClient` 发出的请求都必须在 `Authorization` 头中包含有效的 Clerk 访问令牌：

```typescript {6} title="lib/mastra/mastra-client.ts"
import { MastraClient } from "@mastra/client-js";

export const mastraClient = new MastraClient({
  baseUrl: "https://<mastra-api-url>",
  headers: {
    Authorization: `Bearer ${accessToken}`,
  },
});
```

:::info

访问令牌必须在 Authorization 头中以 `Bearer` 为前缀。

访问 [Mastra Client SDK](/docs/cn/server/mastra-client) 了解更多配置选项。

:::

### 发出身份验证请求

一旦 `MastraClient` 配置了 Clerk 访问令牌，您就可以发送身份验证请求：

<Tabs>
  <TabItem value="react" label="React">

    ```tsx title="src/components/test-agent.tsx"
    "use client";

    import { useAuth } from "@clerk/nextjs";
    import { MastraClient } from "@mastra/client-js";

    export const TestAgent = () => {
      const { getToken } = useAuth();

      async function handleClick() {
        const token = await getToken();

        const client = new MastraClient({
          baseUrl: "http://localhost:4111",
          headers: token ? { Authorization: `Bearer ${token}` } : undefined,
        });

        const weatherAgent = client.getAgent("weatherAgent");
        const response = await weatherAgent.generate("What's the weather like in New York");

        console.log({ response });
      }

      return <button onClick={handleClick}>Test Agent</button>;
    };
    ```

  </TabItem>
  <TabItem value="curl" label="cURL">

    ```bash
    curl -X POST http://localhost:4111/api/agents/weatherAgent/generate \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer <your-clerk-access-token>" \
      -d '{
        "messages": "Weather in London"
      }'
    ```

  </TabItem>
</Tabs>
