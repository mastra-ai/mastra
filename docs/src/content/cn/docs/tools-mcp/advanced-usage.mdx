---
title: "高级工具用法 | 工具与 MCP"
description: "本页介绍 Mastra 工具的高级功能，包括中止信号以及与 Vercel AI SDK 工具格式的兼容性。"
packages:
  - "@mastra/core"
---

# 高级工具用法

本页介绍与在 Mastra 中使用工具相关的更高级的技术和功能。

## 中止信号

当您使用 `generate()` 或 `stream()` 启动智能体交互时，可以提供 `AbortSignal`。Mastra 会自动将此信号转发到该交互期间发生的任何工具执行。

这允许您取消工具中的长时间运行操作，例如网络请求或密集计算，如果父智能体调用被中止的话。

您可以在工具 `execute` 函数的第二个参数中访问 `abortSignal`。

```typescript
import { createTool } from "@mastra/core/tools";
import { z } from "zod";

export const longRunningTool = createTool({
  id: "long-computation",
  description: "Performs a potentially long computation",
  inputSchema: z.object({ /* ... */ }),
  execute: async (inputData, context) => {
    // 示例：将信号转发到 fetch
    const response = await fetch("https://api.example.com/data", {
      signal: context?.abortSignal, // 在此处传递信号
    });

    if (context?.abortSignal?.aborted) {
      console.log("Tool execution aborted.");
      throw new Error("Aborted");
    }

    // 示例：在循环期间检查信号
    for (let i = 0; i < 1000000; i++) {
      if (context?.abortSignal?.aborted) {
        console.log("Tool execution aborted during loop.");
        throw new Error("Aborted");
      }
      // ... 执行计算步骤 ...
    }

    const data = await response.json();
    return { result: data };
  },
});
```

要使用此功能，在调用智能体时提供 `AbortController` 的信号：

```typescript
import { Agent } from "@mastra/core/agent";
// 假设 'agent' 是一个配置了 longRunningTool 的智能体实例

const controller = new AbortController();

// 启动智能体调用
const promise = agent.generate("Perform the long computation.", {
  abortSignal: controller.signal,
});

// 稍后，如果需要：
// controller.abort();

try {
  const result = await promise;
  console.log(result.text);
} catch (error) {
  if (error.name === "AbortError") {
    console.log("Agent generation was aborted.");
  } else {
    console.error("An error occurred:", error);
  }
}
```

## AI SDK 工具格式

Mastra 保持与 Vercel AI SDK（`ai` 包）使用的工具格式的兼容性。您可以使用 `ai` 包中的 `tool` 函数定义工具，并直接在您的 Mastra 智能体中与使用 Mastra 的 `createTool` 创建的工具一起使用它们。

首先，确保已安装 `ai` 包：

```bash npm2yarn
npm install ai
```

以下是使用 Vercel AI SDK 格式定义的工具示例：

```typescript title="src/mastra/tools/vercelWeatherTool.ts"
import { tool } from "ai";
import { z } from "zod";

export const vercelWeatherTool = tool({
  description: "Fetches current weather using Vercel AI SDK format",
  parameters: z.object({
    city: z.string().describe("The city to get weather for"),
  }),
  execute: async ({ city }) => {
    console.log(`Fetching weather for ${city} (Vercel format tool)`);
    // 替换为实际 API 调用
    const data = await fetch(`https://api.example.com/weather?city=${city}`);
    return data.json();
  },
});
```

然后，您可以像其他任何工具一样将此工具添加到您的 Mastra 智能体：

```typescript title="src/mastra/agents/mixedToolsAgent.ts"
import { Agent } from "@mastra/core/agent";
import { vercelWeatherTool } from "../tools/vercelWeatherTool"; // Vercel AI SDK 工具
import { mastraTool } from "../tools/mastraTool"; // Mastra createTool 工具

export const mixedToolsAgent = new Agent({
  id: "mixed-tools-agent",
  name: "Mixed Tools Agent",
  instructions: "You can use tools defined in different formats.",
  model: "openai/gpt-5.1",
  tools: {
    weatherVercel: vercelWeatherTool,
    someMastraTool: mastraTool,
  },
});
```

Mastra 支持两种工具格式，允许您根据需要混合和匹配。
