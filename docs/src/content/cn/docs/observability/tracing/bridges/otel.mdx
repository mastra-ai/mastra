---
title: "OpenTelemetry 桥接器 | 跟踪 | 可观察性"
description: "将 Mastra 跟踪与现有 OpenTelemetry 基础设施集成"
packages:
  - "@mastra/core"
  - "@mastra/observability"
  - "@mastra/otel-bridge"
---

# OpenTelemetry 桥接器

:::warning

OpenTelemetry 桥接器目前处于**实验**状态。API 和配置选项可能在未来版本中更改。

:::

OpenTelemetry（OTEL）桥接器实现了 Mastra 跟踪系统与现有 OpenTelemetry 基础设施之间的双向集成。与将跟踪数据发送到外部平台的导出器不同，桥接器创建参与您的分布式跟踪上下文的原生 OTEL 跨度。

:::info 想要在没有现有 OTEL 基础设施的情况下发送跟踪？

如果您没有现有的 OpenTelemetry 检测，[OpenTelemetry 导出器](/docs/cn/observability/tracing/exporters/otel) 可能更简单——它直接发送跟踪，而不需要 OTEL SDK 设置。

:::

## 何时使用桥接器

在以下情况下使用 OtelBridge：

- 在您的应用程序中有现有的 OTEL 检测（HTTP 服务器、数据库客户端等）
- 希望 Mastra 操作作为您现有 OTEL 跟踪的子跨度出现
- 需要在 Mastra 工具内的 OTEL 检测代码保持正确的父子关系
- 正在构建分布式系统，其中跟踪上下文必须跨服务传播

## 工作原理

OtelBridge 提供双向集成：

**从 OTEL 到 Mastra：**
- 自动从 OTEL  ambient 上下文（AsyncLocalStorage）读取
- 从活动的 OTEL 跨度继承跟踪 ID 和父跨度 ID
- 尊重 OTEL 采样决策——如果跟踪未被采样，Mastra 不会为其创建跨度
- 当 OTEL 自动检测活动时无需手动传递跟踪 ID

**从 Mastra 到 OTEL：**
- 为 Mastra 操作（智能体、大型语言模型调用、工具、工作流）创建原生 OTEL 跨度
- 在分布式跟踪中保持正确的父子关系
- 允许 OTEL 检测的代码（HTTP 客户端、数据库调用）在 Mastra 操作内正确嵌套

## 安装

```bash npm2yarn
npm install @mastra/otel-bridge
```

桥接器与您现有的 OpenTelemetry 设置配合使用。根据您的配置，您可能还需要其中一些包：

- `@opentelemetry/sdk-node` - OTEL 的核心 Node.js SDK
- `@opentelemetry/auto-instrumentations-node` - 常见库的自动检测
- `@opentelemetry/exporter-trace-otlp-proto` - OTLP 导出器（Protocol Buffers over HTTP）
- `@opentelemetry/exporter-trace-otlp-http` - OTLP 导出器（JSON over HTTP）
- `@opentelemetry/exporter-trace-otlp-grpc` - OTLP 导出器（gRPC）
- `@opentelemetry/sdk-trace-base` - 基础跟踪 SDK（用于 BatchSpanProcessor 等）
- `@opentelemetry/core` - 核心工具（用于 W3CTraceContextPropagator 等）

## 配置

使用 OtelBridge 需要两个步骤：

1. 在您的应用程序中配置 OpenTelemetry 检测
2. 将 OtelBridge 添加到您的 Mastra 可观察性配置

### 步骤 1：OpenTelemetry 检测

创建一个初始化 OTEL 的检测文件。这必须在您的应用程序代码之前运行：

```typescript title="instrumentation.ts"
import { NodeSDK } from "@opentelemetry/sdk-node";
import { getNodeAutoInstrumentations } from "@opentelemetry/auto-instrumentations-node";
import { OTLPTraceExporter } from "@opentelemetry/exporter-trace-otlp-proto";
import { BatchSpanProcessor } from "@opentelemetry/sdk-trace-base";
import { W3CTraceContextPropagator } from "@opentelemetry/core";

const sdk = new NodeSDK({
  serviceName: "my-service",
  spanProcessors: [
    new BatchSpanProcessor(
      new OTLPTraceExporter({
        url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || "http://localhost:4318/v1/traces",
      })
    ),
  ],
  instrumentations: [getNodeAutoInstrumentations()],
  textMapPropagator: new W3CTraceContextPropagator(),
});

sdk.start();

export { sdk };
```

### 步骤 2：Mastra 配置

将 OtelBridge 添加到您的 Mastra 可观察性配置：

```typescript title="src/mastra/index.ts"
import { Mastra } from "@mastra/core";
import { Observability } from "@mastra/observability";
import { OtelBridge } from "@mastra/otel-bridge";

export const mastra = new Mastra({
  observability: new Observability({
    configs: {
      default: {
        serviceName: "my-service",
        bridge: new OtelBridge(),
      },
    },
  }),
  agents: {
    /* 您的智能体 */
  },
});
```

使用桥接器时不需要 Mastra 导出器——跟踪通过您的 OTEL SDK 配置发送。如果您想将跟踪发送到其他目的地，可以选择添加 Mastra 导出器。

### 运行您的应用程序

使用 `--import` 标志确保检测在您的应用程序之前加载：

```bash
tsx --import ./instrumentation.ts ./src/index.ts
```

## 语义约定

OtelBridge 使用 [OpenTelemetry GenAI 语义约定 v1.38.0](https://github.com/open-telemetry/semantic-conventions/tree/v1.38.0/docs/cn/gen-ai) 导出 Mastra 跨度。这包括标准化的跨度名称（`chat {model}`、`execute_tool {tool_name}` 等）和属性（`gen_ai.usage.input_tokens`、`gen_ai.request.model` 等）。

有关跨度命名和属性的详细信息，请参阅 [OpenTelemetry 导出器语义约定](/docs/cn/observability/tracing/exporters/otel#opentelemetry-semantic-conventions)。

## 跟踪层次结构

使用 OtelBridge，您的跟踪在 OTEL 和 Mastra 边界之间保持正确的层次结构：

```
HTTP POST /api/chat（来自 Hono 中间件）
└── agent.assistant（来自 Mastra via OtelBridge）
    ├── chat gpt-4o（大型语言模型调用）
    ├── tool.execute search（工具执行）
    │   └── HTTP GET api.example.com（来自 OTEL 自动检测）
    └── chat gpt-4o（后续大型语言模型调用）
```

## 多服务分布式跟踪

OtelBridge 启用跨服务边界的跟踪传播。当服务 A 通过 HTTP 调用服务 B 时，跟踪上下文自动传播：

```
服务 A：HTTP POST /api/process
└── HTTP POST service-b/api/analyze（传出调用）

服务 B：HTTP POST /api/analyze（传入调用 - 相同的跟踪！）
└── agent.analyzer（Mastra 智能体继承跟踪上下文）
    └── chat gpt-4o
```

两个服务都必须具有：
1. 配置的 OTEL 检测
2. 启用的 W3C 跟踪上下文传播器
3. 配置了 OtelBridge 的 Mastra

## 使用标签

标签帮助您在 OTEL 后端对跟踪进行分类和过滤。在执行智能体或工作流时添加标签：

```typescript
const result = await agent.generate("Hello", {
  tracingOptions: {
    tags: ["production", "experiment-v2", "user-request"],
  },
});
```

标签作为 JSON 字符串导出在 `mastra.tags` 跨度属性中，以实现广泛的后端兼容性。常见用例包括：

- 环境标签：`"production"`、`"staging"`
- 实验跟踪：`"experiment-v1"`、`"control-group"`
- 优先级级别：`"priority-high"`、`"batch-job"`

## 故障排除

如果跟踪未出现或未按预期连接：

- 验证 OTEL SDK 在 Mastra 之前初始化（使用 `--import` 标志或在入口点顶部导入）
- 确保 OtelBridge 添加到您的可观察性配置
- 检查您的 OTEL 后端正在运行且可访问

## 相关内容

- [跟踪概述](/docs/cn/observability/tracing/overview)
- [OpenTelemetry 导出器](/docs/cn/observability/tracing/exporters/otel) - 用于发送到 OTEL 后端
- [OtelBridge 参考](/reference/observability/tracing/bridges/otel) - API 文档
