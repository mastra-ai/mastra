---
title: "参考：审核处理器 | 处理器"
description: "Mastra 中 ModerationProcessor 的文档，使用 LLM 提供内容审核以检测多个类别中的不当内容。"
packages:
  - "@mastra/core"
---

# ModerationProcessor

`ModerationProcessor` 是一个**混合处理器**，可用于输入和输出处理，使用 LLM 提供内容审核以检测多个类别中的不当内容。此处理器通过根据可配置的审核类别评估消息并提供处理标记内容的灵活策略来帮助保持内容安全。

## 使用示例

```typescript
import { ModerationProcessor } from "@mastra/core/processors";

const processor = new ModerationProcessor({
  model: "openrouter/openai/gpt-oss-safeguard-20b",
  threshold: 0.7,
  strategy: "block",
  categories: ["hate", "harassment", "violence"]
});
```

## 构造函数参数

<PropertiesTable
  content={[
    {
      name: "options",
      type: "Options",
      description: "内容审核的配置选项",
      isOptional: false,
    },
  ]}
/>

### Options

<PropertiesTable
  content={[
    {
      name: "model",
      type: "MastraModelConfig",
      description: "审核代理的模型配置",
      isOptional: false,
    },
    {
      name: "categories",
      type: "string[]",
      description: "要检查的审核类别。如果未指定，使用默认的 OpenAI 类别",
      isOptional: true,
      default: "['hate', 'hate/threatening', 'harassment', 'harassment/threatening', 'self-harm', 'self-harm/intent', 'self-harm/instructions', 'sexual', 'sexual/minors', 'violence', 'violence/graphic']",
    },
    {
      name: "threshold",
      type: "number",
      description: "标记的置信度阈值（0-1）。如果任何类别分数超过此阈值，内容将被标记",
      isOptional: true,
      default: "0.5",
    },
    {
      name: "strategy",
      type: "'block' | 'warn' | 'filter'",
      description: "内容被标记时的策略：'block' 拒绝并报错，'warn' 记录警告但允许通过，'filter' 移除标记的消息",
      isOptional: true,
      default: "'block'",
    },
    {
      name: "instructions",
      type: "string",
      description: "代理的自定义审核说明。如果未提供，使用基于类别的默认说明",
      isOptional: true,
      default: "undefined",
    },
    {
      name: "includeScores",
      type: "boolean",
      description: "是否在日志中包含置信度分数。对于调整阈值和调试很有用",
      isOptional: true,
      default: "false",
    },
    {
      name: "chunkWindow",
      type: "number",
      description: "审核流片段时要包含的先前片段数量以提供上下文。如果设置为 1，则包含前一个片段等。",
      isOptional: true,
      default: "0（无上下文窗口）",
    },
    {
      name: "providerOptions",
      type: "ProviderOptions",
      description: "传递给内部审核代理的提供者特定选项。使用此选项来控制模型行为，如思考模型的推理努力（例如，`{ openai: { reasoningEffort: 'low' } }`）",
      isOptional: true,
      default: "undefined",
    },
  ]}
/>

## 返回值

<PropertiesTable
  content={[
    {
      name: "id",
      type: "string",
      description: "处理器标识符，设置为 'moderation'",
      isOptional: false,
    },
    {
      name: "name",
      type: "string",
      description: "可选的处理器显示名称",
      isOptional: true,
    },
    {
      name: "processInput",
      type: "(args: { messages: MastraDBMessage[]; abort: (reason?: string) => never; tracingContext?: TracingContext }) => Promise<MastraDBMessage[]>",
      description: "在发送到 LLM 之前处理输入消息以审核内容",
      isOptional: false,
    },
    {
      name: "processOutputStream",
      type: "(args: { part: ChunkType; streamParts: ChunkType[]; state: Record<string, any>; abort: (reason?: string) => never; tracingContext?: TracingContext }) => Promise<ChunkType | null | undefined>",
      description: "处理流式输出片段以在流式传输过程中审核内容",
      isOptional: false,
    },
  ]}
/>

## 扩展使用示例

### 输入处理

```typescript title="src/mastra/agents/moderated-agent.ts"
import { Agent } from "@mastra/core/agent";
import { ModerationProcessor } from "@mastra/core/processors";

export const agent = new Agent({
  name: "moderated-agent",
  instructions: "你是一个有用的助手",
  model: "openai/gpt-5.1",
  inputProcessors: [
    new ModerationProcessor({
      model: "openrouter/openai/gpt-oss-safeguard-20b",
      categories: ["hate", "harassment", "violence"],
      threshold: 0.7,
      strategy: "block",
      instructions: "检测并标记用户消息中的不当内容",
      includeScores: true
    })
  ]
});
```

### 带批处理的输出处理

当使用 `ModerationProcessor` 作为输出处理器时，建议将其与 `BatchPartsProcessor` 结合使用以优化性能。`BatchPartsProcessor` 在将流片段传递给审核器之前将它们批量处理，减少审核所需的 LLM 调用次数。

```typescript title="src/mastra/agents/output-moderated-agent.ts"
import { Agent } from "@mastra/core/agent";
import { BatchPartsProcessor, ModerationProcessor } from "@mastra/core/processors";

export const agent = new Agent({
  name: "output-moderated-agent",
  instructions: "你是一个有用的助手",
  model: "openai/gpt-5.1",
  outputProcessors: [
    // 首先批量处理流片段以减少 LLM 调用
    new BatchPartsProcessor({
      batchSize: 10,
    }),
    // 然后对批量内容应用审核
    new ModerationProcessor({
      model: "openrouter/openai/gpt-oss-safeguard-20b",
      strategy: "filter",
      chunkWindow: 1,
    }),
  ]
});
```

## 相关内容

- [护栏](/docs/cn/docs/agents/guardrails)
