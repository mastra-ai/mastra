---
title: "参考文档: Upstash 向量存储 | 向量"
description: Mastra 中 UpstashVector 类的文档，使用 Upstash Vector 提供向量搜索。
packages:
  - "@mastra/core"
  - "@mastra/fastembed"
  - "@mastra/memory"
  - "@mastra/upstash"
---

# Upstash 向量存储

UpstashVector 类使用 [Upstash Vector](https://upstash.com/vector) 提供向量搜索，这是一款无服务器向量数据库服务，提供具有元数据过滤功能和混合搜索支持的向量相似性搜索。

## 构造函数选项

<PropertiesTable
  content={[
    {
      name: "url",
      type: "string",
      description: "Upstash Vector 数据库 URL",
    },
    {
      name: "token",
      type: "string",
      description: "Upstash Vector API 令牌",
    },
  ]}
/>

## 方法

### createIndex()

注意：对于 Upstash，此方法是空操作，因为索引是自动创建的。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要创建的索引名称",
    },
    {
      name: "dimension",
      type: "number",
      description: "向量维度（必须与您的嵌入模型匹配）",
    },
    {
      name: "metric",
      type: "'cosine' | 'euclidean' | 'dotproduct'",
      isOptional: true,
      defaultValue: "cosine",
      description: "用于相似性搜索的距离度量",
    },
  ]}
/>

### upsert()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要 upsert 到的索引名称",
    },
    {
      name: "vectors",
      type: "number[][]",
      description: "嵌入向量数组",
    },
    {
      name: "sparseVectors",
      type: "{ indices: number[], values: number[] }[]",
      isOptional: true,
      description:
        "用于混合搜索的稀疏向量数组。每个稀疏向量必须具有匹配的索引和值数组。",
    },
    {
      name: "metadata",
      type: "Record<string, any>[]",
      isOptional: true,
      description: "每个向量的元数据",
    },
    {
      name: "ids",
      type: "string[]",
      isOptional: true,
      description: "可选的向量 ID（如果未提供则自动生成）",
    },
  ]}
/>

### query()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要查询的索引名称",
    },
    {
      name: "queryVector",
      type: "number[]",
      description: "用于查找相似向量的查询向量",
    },
    {
      name: "sparseVector",
      type: "{ indices: number[], values: number[] }",
      isOptional: true,
      description:
        "用于混合搜索的可选稀疏向量。必须具有匹配的索引和值数组。",
    },
    {
      name: "topK",
      type: "number",
      isOptional: true,
      defaultValue: "10",
      description: "要返回的结果数量",
    },
    {
      name: "filter",
      type: "Record<string, any>",
      isOptional: true,
      description: "查询的元数据过滤器",
    },
    {
      name: "includeVector",
      type: "boolean",
      isOptional: true,
      defaultValue: "false",
      description: "是否在结果中包含向量",
    },
    {
      name: "fusionAlgorithm",
      type: "FusionAlgorithm",
      isOptional: true,
      description:
        "用于在混合搜索中组合密集和稀疏搜索结果的算法（例如 RRF - 倒数排名融合）",
    },
    {
      name: "queryMode",
      type: "QueryMode",
      isOptional: true,
      description:
        "搜索模式：'DENSE' 仅密集搜索，'SPARSE' 仅稀疏搜索，'HYBRID' 组合搜索",
    },
  ]}
/>

### listIndexes()

返回字符串形式的索引名称（命名空间）列表。

### describeIndex()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要描述的索引名称",
    },
  ]}
/>

返回：

```typescript
interface IndexStats {
  dimension: number;
  count: number;
  metric: "cosine" | "euclidean" | "dotproduct";
}
```

### deleteIndex()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要删除的索引（命名空间）名称",
    },
  ]}
/>

### updateVector()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要更新的索引名称",
    },
    {
      name: "id",
      type: "string",
      description: "要更新的项目 ID",
    },
    {
      name: "update",
      type: "object",
      description:
        "包含向量、稀疏向量和/或元数据的更新对象",
    },
  ]}
/>

`update` 对象可以包含以下属性：

- `vector`（可选）：表示新密集向量的数字数组。
- `sparseVector`（可选）：具有 `indices` 和 `values` 数组的稀疏向量对象，用于混合索引。
- `metadata`（可选）：元数据的键值对记录。

### deleteVector()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要从中删除项目的索引名称",
    },
    {
      name: "id",
      type: "string",
      description: "要删除的项目 ID",
    },
  ]}
/>

尝试从指定索引中按 ID 删除项目。如果删除失败，会记录错误消息。

## 混合向量搜索

Upstash Vector 支持混合搜索，结合语义搜索（密集向量）和基于关键字的搜索（稀疏向量）以提高相关性和准确性。

### 基础混合使用

```typescript
import { UpstashVector } from "@mastra/upstash";

const vectorStore = new UpstashVector({
  id: 'upstash-vector',
  url: process.env.UPSTASH_VECTOR_URL,
  token: process.env.UPSTASH_VECTOR_TOKEN,
});

// Upsert 同时包含密集和稀疏成分的向量
const denseVectors = [
  [0.1, 0.2, 0.3],
  [0.4, 0.5, 0.6],
];
const sparseVectors = [
  { indices: [1, 5, 10], values: [0.8, 0.6, 0.4] },
  { indices: [2, 6, 11], values: [0.7, 0.5, 0.3] },
];

await vectorStore.upsert({
  indexName: "hybrid-index",
  vectors: denseVectors,
  sparseVectors: sparseVectors,
  metadata: [{ title: "Document 1" }, { title: "Document 2" }],
});

// 使用混合搜索查询
const results = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3],
  sparseVector: { indices: [1, 5], values: [0.9, 0.7] },
  topK: 10,
});
```

### 高级混合搜索选项

```typescript
import { FusionAlgorithm, QueryMode } from "@upstash/vector";

// 使用特定融合算法查询
const fusionResults = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3],
  sparseVector: { indices: [1, 5], values: [0.9, 0.7] },
  fusionAlgorithm: FusionAlgorithm.RRF,
  topK: 10,
});

// 仅密集搜索
const denseResults = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3],
  queryMode: QueryMode.DENSE,
  topK: 10,
});

// 仅稀疏搜索
const sparseResults = await vectorStore.query({
  indexName: "hybrid-index",
  queryVector: [0.1, 0.2, 0.3], // 仍需要用于索引结构
  sparseVector: { indices: [1, 5], values: [0.9, 0.7] },
  queryMode: QueryMode.SPARSE,
  topK: 10,
});
```

### 更新混合向量

```typescript
// 更新密集和稀疏成分
await vectorStore.updateVector({
  indexName: "hybrid-index",
  id: "vector-id",
  update: {
    vector: [0.2, 0.3, 0.4],
    sparseVector: { indices: [2, 7, 12], values: [0.9, 0.8, 0.6] },
    metadata: { title: "Updated Document" },
  },
});
```

## 响应类型

查询结果按以下格式返回：

```typescript
interface QueryResult {
  id: string;
  score: number;
  metadata: Record<string, any>;
  vector?: number[]; // 仅在 includeVector 为 true 时包含
}
```

## 错误处理

存储会抛出可捕获的类型化错误：

```typescript
try {
  await store.query({
    indexName: "index_name",
    queryVector: queryVector,
  });
} catch (error) {
  if (error instanceof VectorStoreError) {
    console.log(error.code); // 'connection_failed' | 'invalid_dimension' | 等
    console.log(error.details); // 额外的错误上下文
  }
}
```

## 环境变量

必需的环境变量：

- `UPSTASH_VECTOR_URL`：您的 Upstash Vector 数据库 URL
- `UPSTASH_VECTOR_TOKEN`：您的 Upstash Vector API 令牌

## 使用示例

### 使用 fastembed 的本地嵌入

嵌入是内存的 `semanticRecall` 用于按含义（而非关键字）检索相关消息的数字向量。此配置使用 `@mastra/fastembed` 生成向量嵌入。

安装 `fastembed` 开始使用：

```bash npm2yarn
npm install @mastra/fastembed@latest
```

将以下内容添加到您的代理中：

```typescript title="src/mastra/agents/example-upstash-agent.ts"
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { UpstashStore, UpstashVector } from "@mastra/upstash";
import { fastembed } from "@mastra/fastembed";

export const upstashAgent = new Agent({
  id: "upstash-agent",
  name: "Upstash Agent",
  instructions:
    "您是一个能够自动回忆先前交互记忆的 AI 代理。",
  model: "openai/gpt-5.1",
  memory: new Memory({
    storage: new UpstashStore({
      id: 'upstash-agent-storage',
      url: process.env.UPSTASH_REDIS_REST_URL!,
      token: process.env.UPSTASH_REDIS_REST_TOKEN!,
    }),
    vector: new UpstashVector({
      id: 'upstash-agent-vector',
      url: process.env.UPSTASH_VECTOR_REST_URL!,
      token: process.env.UPSTASH_VECTOR_REST_TOKEN!,
    }),
    embedder: fastembed,
    options: {
      lastMessages: 10,
      semanticRecall: {
        topK: 3,
        messageRange: 2,
      },
    },
  }),
});
```

## 相关内容

- [元数据过滤器](../rag/metadata-filters)
