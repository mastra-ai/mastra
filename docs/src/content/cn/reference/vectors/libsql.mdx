---
title: "参考文档：libSQL 向量存储 | 向量"
description: "Mastra 中 LibSQLVector 类的文档，该类使用带有向量扩展的 libSQL 提供向量搜索。"
packages:
  - "@mastra/core"
  - "@mastra/fastembed"
  - "@mastra/libsql"
  - "@mastra/memory"
---

# libSQL 向量存储

libSQL 存储实现提供 SQLite 兼容的向量搜索，它使用带有向量扩展的 [libSQL](https://github.com/tursodatabase/libsql)（SQLite 的一个带有向量扩展的分支）以及带有向量扩展的 [Turso](https://turso.tech/)，提供了一个轻量级且高效的向量数据库解决方案。它是 `@mastra/libsql` 包的一部分，并提供高效的向量相似性搜索和元数据过滤功能。

## 安装

```bash npm2yarn
npm install @mastra/libsql@latest
```

## 使用方法

```typescript
import { LibSQLVector } from "@mastra/libsql";

// 创建新的向量存储实例
const store = new LibSQLVector({
  id: 'libsql-vector',
  url: process.env.DATABASE_URL,
  // 可选：用于 Turso 云数据库
  authToken: process.env.DATABASE_AUTH_TOKEN,
});

// 创建索引
await store.createIndex({
  indexName: "myCollection",
  dimension: 1536,
});

// 添加带元数据的向量
const vectors = [[0.1, 0.2, ...], [0.3, 0.4, ...]];
const metadata = [
  { text: "first document", category: "A" },
  { text: "second document", category: "B" }
];
await store.upsert({
  indexName: "myCollection",
  vectors,
  metadata,
});

// 查询相似向量
const queryVector = [0.1, 0.2, ...];
const results = await store.query({
  indexName: "myCollection",
  queryVector,
  topK: 10, // 返回前 K 个结果
  filter: { category: "A" } // 可选的元数据过滤器
});
```

## 构造函数选项

<PropertiesTable
  content={[
    {
      name: "url",
      type: "string",
      description:
        "libSQL 数据库 URL。使用 ':memory:' 表示内存数据库，'file:dbname.db' 表示本地文件，或使用 libSQL 兼容的连接字符串如 'libsql://your-database.turso.io'。",
    },
    {
      name: "authToken",
      type: "string",
      isOptional: true,
      description: "Turso 云数据库的认证令牌",
    },
    {
      name: "syncUrl",
      type: "string",
      isOptional: true,
      description: "数据库复制的 URL（Turso 特有）",
    },
    {
      name: "syncInterval",
      type: "number",
      isOptional: true,
      description:
        "数据库同步的间隔时间（毫秒）（Turso 特有）",
    },
  ]}
/>

## 方法

### createIndex()

创建新的向量集合。索引名称必须以字母或下划线开头，并且只能包含字母、数字和下划线。维度必须是正整数。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要创建的索引名称",
    },
    {
      name: "dimension",
      type: "number",
      description: "向量维度大小（必须与你的嵌入模型匹配）",
    },
    {
      name: "metric",
      type: "'cosine' | 'euclidean' | 'dotproduct'",
      isOptional: true,
      defaultValue: "cosine",
      description:
        "用于相似性搜索的距离度量。注意：目前 libSQL 仅支持余弦相似度。",
    },
  ]}
/>

### upsert()

在索引中添加或更新向量及其元数据。使用事务确保所有向量原子性插入——如果任何插入失败，整个操作将回滚。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要插入到的索引名称",
    },
    {
      name: "vectors",
      type: "number[][]",
      description: "嵌入向量数组",
    },
    {
      name: "metadata",
      type: "Record<string, any>[]",
      isOptional: true,
      description: "每个向量的元数据",
    },
    {
      name: "ids",
      type: "string[]",
      isOptional: true,
      description: "可选的向量 ID（如果未提供则自动生成）",
    },
  ]}
/>

### query()

搜索相似向量，可选择进行元数据过滤。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要搜索的索引名称",
    },
    {
      name: "queryVector",
      type: "number[]",
      description: "用于查找相似向量的查询向量",
    },
    {
      name: "topK",
      type: "number",
      isOptional: true,
      defaultValue: "10",
      description: "要返回的结果数量",
    },
    {
      name: "filter",
      type: "Filter",
      isOptional: true,
      description: "元数据过滤器",
    },
    {
      name: "includeVector",
      type: "boolean",
      isOptional: true,
      defaultValue: "false",
      description: "是否在结果中包含向量数据",
    },
    {
      name: "minScore",
      type: "number",
      isOptional: true,
      defaultValue: "0",
      description: "最小相似度分数阈值",
    },
  ]}
/>

### describeIndex()

获取索引信息。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要描述的索引名称",
    },
  ]}
/>

返回：

```typescript
interface IndexStats {
  dimension: number;
  count: number;
  metric: "cosine" | "euclidean" | "dotproduct";
}
```

### deleteIndex()

删除索引及其所有数据。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要删除的索引名称",
    },
  ]}
/>

### listIndexes()

列出数据库中的所有向量索引。

返回：`Promise<string[]>`

### truncateIndex()

从索引中移除所有向量，但保留索引结构。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要截断的索引名称",
    },
  ]}
/>

### updateVector()

通过 ID 或元数据过滤器更新单个向量。必须提供 `id` 或 `filter` 之一，但不能同时提供两者。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "包含该向量的索引名称",
    },
    {
      name: "id",
      type: "string",
      isOptional: true,
      description: "要更新的向量条目 ID（与 filter 互斥）",
    },
    {
      name: "filter",
      type: "Record<string, any>",
      isOptional: true,
      description: "用于识别要更新的向量的元数据过滤器（与 id 互斥）",
    },
    {
      name: "update",
      type: "object",
      description: "包含向量和/或元数据的更新数据",
    },
    {
      name: "update.vector",
      type: "number[]",
      isOptional: true,
      description: "要更新的新向量数据",
    },
    {
      name: "update.metadata",
      type: "Record<string, any>",
      isOptional: true,
      description: "要更新的新元数据",
    },
  ]}
/>

### deleteVector()

通过 ID 从索引中删除特定的向量条目。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "包含该向量的索引名称",
    },
    {
      name: "id",
      type: "string",
      description: "要删除的向量条目 ID",
    },
  ]}
/>

### deleteVectors()

通过 ID 或元数据过滤器删除多个向量。必须提供 `ids` 或 `filter` 之一，但不能同时提供两者。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "包含要删除向量的索引名称",
    },
    {
      name: "ids",
      type: "string[]",
      isOptional: true,
      description: "要删除的向量 ID 数组（与 filter 互斥）",
    },
    {
      name: "filter",
      type: "Record<string, any>",
      isOptional: true,
      description: "用于识别要删除的向量的元数据过滤器（与 ids 互斥）",
    },
  ]}
/>

## 响应类型

查询结果按以下格式返回：

```typescript
interface QueryResult {
  id: string;
  score: number;
  metadata: Record<string, any>;
  vector?: number[]; // 仅在 includeVector 为 true 时包含
}
```

## 错误处理

存储会针对不同的失败情况抛出特定错误：

```typescript
try {
  await store.query({
    indexName: "my-collection",
    queryVector: queryVector,
  });
} catch (error) {
  // 处理特定的错误情况
  if (error.message.includes("Invalid index name format")) {
    console.error(
      "索引名称必须以字母/下划线开头，并且只能包含字母数字字符",
    );
  } else if (error.message.includes("Table not found")) {
    console.error("指定的索引不存在");
  } else {
    console.error("向量存储错误：", error.message);
  }
}
```

常见的错误情况包括：

- 无效的索引名称格式
- 无效的向量维度
- 表/索引未找到
- 数据库连接问题
- upsert 期间的事务失败

## 使用示例

### 使用 fastembed 的本地嵌入

嵌入是内存的 `semanticRecall` 用来根据含义（而非关键词）检索相关消息的数值向量。此设置使用 `@mastra/fastembed` 生成向量嵌入。

安装 `fastembed` 开始使用：

```bash npm2yarn
npm install @mastra/fastembed@latest
```

将以下内容添加到你的代理中：

```typescript title="src/mastra/agents/example-libsql-agent.ts"
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { LibSQLStore, LibSQLVector } from "@mastra/libsql";
import { fastembed } from "@mastra/fastembed";

export const libsqlAgent = new Agent({
  id: "libsql-agent",
  name: "libSQL Agent",
  instructions:
    "你是一个能够自动回忆先前交互记忆的 AI 代理。",
  model: "openai/gpt-5.1",
  memory: new Memory({
    storage: new LibSQLStore({
      id: 'libsql-agent-storage',
      url: "file:libsql-agent.db",
    }),
    vector: new LibSQLVector({
      id: 'libsql-agent-vector',
      url: "file:libsql-agent.db",
    }),
    embedder: fastembed,
    options: {
      lastMessages: 10,
      semanticRecall: {
        topK: 3,
        messageRange: 2,
      },
      generateTitle: true, // 显式启用自动标题生成
    },
  }),
});
```

## 相关内容

- [元数据过滤器](../rag/metadata-filters)
