---
title: "参考文档：Lance 向量存储 | 向量"
description: "Mastra 中 LanceVectorStore 类的文档，该类使用基于 Lance 列式格式的嵌入式向量数据库 LanceDB 提供向量搜索。"
packages:
  - "@mastra/lance"
---

# Lance 向量存储

LanceVectorStore 类使用 [LanceDB](https://lancedb.github.io/lancedb/) 提供向量搜索，它是一个基于 Lance 列式格式构建的嵌入式向量数据库。它为本地开发和生产部署提供高效的存储和快速的相似性搜索。

## 工厂方法

LanceVectorStore 使用工厂模式进行创建。你应该使用静态的 `create()` 方法而不是直接使用构造函数。

<PropertiesTable
  content={[
    {
      name: "uri",
      type: "string",
      description: "LanceDB 数据库路径或云部署的 URI",
    },
    {
      name: "options",
      type: "ConnectionOptions",
      description: "LanceDB 的额外连接选项",
      isOptional: true,
    },
  ]}
/>

## 构造函数示例

你可以使用静态 create 方法创建 `LanceVectorStore` 实例：

```ts
import { LanceVectorStore } from "@mastra/lance";

// 连接到本地数据库
const vectorStore = await LanceVectorStore.create("/path/to/db");

// 连接到 LanceDB 云数据库
const cloudStore = await LanceVectorStore.create("db://host:port");

// 连接到云数据库并指定选项
const s3Store = await LanceVectorStore.create("s3://bucket/db", {
  storageOptions: { timeout: "60s" },
});
```

## 方法

### createIndex()

<PropertiesTable
  content={[
    {
      name: "tableName",
      type: "string",
      description: "要创建索引的表名称",
    },
    {
      name: "indexName",
      type: "string",
      description: "要创建的索引名称（列名）",
    },
    {
      name: "dimension",
      type: "number",
      description: "向量维度（必须与你的嵌入模型匹配）",
    },
    {
      name: "metric",
      type: "'cosine' | 'euclidean' | 'dotproduct'",
      isOptional: true,
      defaultValue: "cosine",
      description: "用于相似性搜索的距离度量",
    },
    {
      name: "indexConfig",
      type: "LanceIndexConfig",
      isOptional: true,
      defaultValue: "{ type: 'hnsw' }",
      description: "索引配置",
    },
  ]}
/>

#### LanceIndexConfig

<PropertiesTable
  content={[
    {
      name: "type",
      type: "'ivfflat' | 'hnsw'",
      description: "索引类型",
      defaultValue: "hnsw",
      properties: [
        {
          type: "string",
          parameters: [
            {
              name: "ivfflat",
              type: "ivfflat",
              description:
                "将向量聚类到列表中以进行近似搜索。",
            },
            {
              name: "hnsw",
              type: "hnsw",
              description:
                "基于图的索引，提供快速搜索时间和高召回率。",
            },
          ],
        },
      ],
    },
    {
      name: "numPartitions",
      type: "number",
      isOptional: true,
      defaultValue: "128",
      description: "IVF 索引的分区数量",
    },
    {
      name: "numSubVectors",
      type: "number",
      isOptional: true,
      defaultValue: "16",
      description: "用于乘积量化的子向量数量",
    },
    {
      name: "hnsw",
      type: "HNSWConfig",
      isOptional: true,
      description: "HNSW 配置",
      properties: [
        {
          type: "object",
          parameters: [
            {
              name: "m",
              type: "number",
              description:
                "每个节点的最大连接数（默认值：16）",
              isOptional: true,
            },
            {
              name: "efConstruction",
              type: "number",
              description: "构建时间复杂度（默认值：100）",
              isOptional: true,
            },
          ],
        },
      ],
    },
  ]}
/>

### createTable()

<PropertiesTable
  content={[
    {
      name: "tableName",
      type: "string",
      description: "要创建的表名称",
    },
    {
      name: "data",
      type: "Record<string, unknown>[] | TableLike",
      description: "表的初始数据",
    },
    {
      name: "options",
      type: "Partial<CreateTableOptions>",
      isOptional: true,
      description: "额外的表创建选项",
    },
  ]}
/>

### upsert()

<PropertiesTable
  content={[
    {
      name: "tableName",
      type: "string",
      description: "要插入向量的表名称",
    },
    {
      name: "vectors",
      type: "number[][]",
      description: "嵌入向量数组",
    },
    {
      name: "metadata",
      type: "Record<string, any>[]",
      isOptional: true,
      description: "每个向量的元数据",
    },
    {
      name: "ids",
      type: "string[]",
      isOptional: true,
      description: "可选的向量 ID（如果未提供则自动生成）",
    },
  ]}
/>

### query()

<PropertiesTable
  content={[
    {
      name: "tableName",
      type: "string",
      description: "要查询的表名称",
    },
    {
      name: "queryVector",
      type: "number[]",
      description: "查询向量",
    },
    {
      name: "topK",
      type: "number",
      isOptional: true,
      defaultValue: "10",
      description: "要返回的结果数量",
    },
    {
      name: "filter",
      type: "Record<string, any>",
      isOptional: true,
      description: "元数据过滤器",
    },
    {
      name: "includeVector",
      type: "boolean",
      isOptional: true,
      defaultValue: "false",
      description: "是否在结果中包含向量",
    },
    {
      name: "columns",
      type: "string[]",
      isOptional: true,
      defaultValue: "[]",
      description: "要包含在结果中的特定列",
    },
    {
      name: "includeAllColumns",
      type: "boolean",
      isOptional: true,
      defaultValue: "false",
      description: "是否在结果中包含所有列",
    },
  ]}
/>

### listTables()

返回一个包含表名的字符串数组。

```typescript
const tables = await vectorStore.listTables();
// ['my_vectors', 'embeddings', 'documents']
```

### getTableSchema()

<PropertiesTable
  content={[
    {
      name: "tableName",
      type: "string",
      description: "要描述的表名称",
    },
  ]}
/>

返回指定表的模式。

### deleteTable()

<PropertiesTable
  content={[
    {
      name: "tableName",
      type: "string",
      description: "要删除的表名称",
    },
  ]}
/>

### deleteAllTables()

删除数据库中的所有表。

### listIndexes()

返回一个包含索引名的字符串数组。

### describeIndex()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要描述的索引名称",
    },
  ]}
/>

返回索引的信息：

```typescript
interface IndexStats {
  dimension: number;
  count: number;
  metric: "cosine" | "euclidean" | "dotproduct";
  type: "ivfflat" | "hnsw";
  config: {
    m?: number;
    efConstruction?: number;
    numPartitions?: number;
    numSubVectors?: number;
  };
}
```

### deleteIndex()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "要删除的索引名称",
    },
  ]}
/>

### updateVector()

通过 ID 或元数据过滤器更新单个向量。必须提供 `id` 或 `filter` 之一，但不能同时提供两者。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "包含该向量的索引名称",
    },
    {
      name: "id",
      type: "string",
      isOptional: true,
      description: "要更新的向量 ID（与 filter 互斥）",
    },
    {
      name: "filter",
      type: "Record<string, any>",
      isOptional: true,
      description: "用于识别要更新的向量的元数据过滤器（与 id 互斥）",
    },
    {
      name: "update",
      type: "{ vector?: number[]; metadata?: Record<string, any>; }",
      description: "包含要更新的向量和/或元数据的对象",
    },
  ]}
/>

### deleteVector()

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "包含该向量的索引名称",
    },
    {
      name: "id",
      type: "string",
      description: "要删除的向量 ID",
    },
  ]}
/>

### deleteVectors()

通过 ID 或元数据过滤器删除多个向量。必须提供 `ids` 或 `filter` 之一，但不能同时提供两者。

<PropertiesTable
  content={[
    {
      name: "indexName",
      type: "string",
      description: "包含要删除向量的索引名称",
    },
    {
      name: "ids",
      type: "string[]",
      isOptional: true,
      description: "要删除的向量 ID 数组（与 filter 互斥）",
    },
    {
      name: "filter",
      type: "Record<string, any>",
      isOptional: true,
      description: "用于识别要删除的向量的元数据过滤器（与 ids 互斥）",
    },
  ]}
/>

### close()

关闭数据库连接。

## 响应类型

查询结果按以下格式返回：

```typescript
interface QueryResult {
  id: string;
  score: number;
  metadata: Record<string, any>;
  vector?: number[]; // 仅在 includeVector 为 true 时包含
  document?: string; // 如果有文档文本则包含
}
```

## 错误处理

存储会抛出可捕获的类型化错误：

```typescript
try {
  await store.query({
    tableName: "my_vectors",
    queryVector: queryVector,
  });
} catch (error) {
  if (error instanceof Error) {
    console.log(error.message);
  }
}
```

## 最佳实践

- 根据你的用例选择合适的索引类型：
  - 当内存不受限制时，HNSW 提供更好的召回率和性能
  - 对于大型数据集，IVF 提供更好的内存效率
- 对于大型数据集的最佳性能，考虑调整 `numPartitions` 和 `numSubVectors` 值
- 使用完数据库后，使用 `close()` 方法正确关闭连接
- 使用一致的元数据模式来简化过滤操作

## 相关内容

- [元数据过滤器](../rag/metadata-filters)
