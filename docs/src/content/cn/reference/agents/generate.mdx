---
title: "参考文档：Agent.generate() | 智能体"
description: "Mastra 智能体中 `Agent.generate()` 方法的文档，用于实现具有增强功能的非流式响应生成。"
packages:
  - "@mastra/core"
---

import { MODEL_SETTINGS_OBJECT } from "@site/src/components/ModelSettingsProperties";

# Agent.generate()

`.generate()` 方法实现来自智能体的具有增强功能的非流式响应生成。它接受消息和可选的生成选项。

## 使用示例

```typescript
// 基本用法
const result = await agent.generate("智能体的消息");

// 使用模型设置（例如，限制输出 token）
const limitedResult = await agent.generate("写一首关于编程的短诗", {
  modelSettings: {
    maxOutputTokens: 50,
    temperature: 0.7,
  },
});

// 使用结构化输出
const structuredResult = await agent.generate("提取用户的姓名和年龄", {
  structuredOutput: {
    schema: z.object({
      name: z.string(),
      age: z.number(),
    }),
  },
});

// 使用内存进行对话持久化
const memoryResult = await agent.generate("记住我最喜欢的颜色是蓝色", {
  memory: {
    thread: "user-123-thread",
    resource: "user-123",
  },
});

// 访问响应头
const result = await agent.generate("你好！");
const remainingRequests = result.response?.headers?.["anthropic-ratelimit-requests-remaining"];
const remainingTokens = result.response?.headers?.["x-ratelimit-remaining-tokens"];
console.log(`剩余请求: ${remainingRequests}, 剩余 token: ${remainingTokens}`);
```

:::info

**模型兼容性**：此方法需要 AI SDK v5+ 模型。如果您使用 AI SDK v4 模型，请改用 [`.generateLegacy()`](./generateLegacy) 方法。框架会自动检测您的模型版本，如果不匹配会抛出错误。

:::

## 参数

<PropertiesTable
  content={[
    {
      name: "messages",
      type: "string | string[] | CoreMessage[] | AiMessageType[] | UIMessageWithMetadata[]",
      description:
        "发送给智能体的消息。可以是单个字符串、字符串数组，或结构化消息对象。",
    },
    {
      name: "options",
      type: "AgentExecutionOptions<Output, Format>",
      isOptional: true,
      description: "生成过程的可选配置。",
    },
  ]}
/>

### 选项

<PropertiesTable
  content={[
    {
      name: "maxSteps",
      type: "number",
      isOptional: true,
      description: "执行期间运行的最大步数。",
    },
    {
      name: "stopWhen",
      type: "LoopOptions['stopWhen']",
      isOptional: true,
      description: "停止执行的条件（例如，步数限制、token 限制）。",
    },
    {
      name: "scorers",
      type: "MastraScorers | Record<string, { scorer: MastraScorer['name']; sampling?: ScoringSamplingConfig }>",
      isOptional: true,
      description: "对执行结果运行的评估评分器。",
      properties: [
        {
          parameters: [
            {
              name: "scorer",
              type: "string",
              isOptional: false,
              description: "要使用的评分器名称。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "sampling",
              type: "ScoringSamplingConfig",
              isOptional: true,
              description: "评分器的采样配置。",
              properties: [
                {
                  parameters: [
                    {
                      name: "type",
                      type: "'none' | 'ratio'",
                      isOptional: false,
                      description:
                        "采样策略类型。使用 'none' 禁用采样，或使用 'ratio' 进行基于百分比的采样。",
                    },
                  ],
                },
                {
                  parameters: [
                    {
                      name: "rate",
                      type: "number",
                      isOptional: true,
                      description:
                        "采样率 (0-1)。当 type 为 'ratio' 时为必填。",
                    },
                  ],
                },
              ],
            },
          ],
        },
      ],
    },
    {
      name: "returnScorerData",
      type: "boolean",
      isOptional: true,
      description: "是否在响应中返回详细的评分数据。",
    },
    {
      name: "onChunk",
      type: "(chunk: ChunkType) => Promise<void> | void",
      isOptional: true,
      description: "生成期间为每个块调用的回调函数。",
    },
    {
      name: "onError",
      type: "({ error }: { error: Error | string }) => Promise<void> | void",
      isOptional: true,
      description:
        "生成期间发生错误时调用的回调函数。",
    },
    {
      name: "onAbort",
      type: "(event: any) => Promise<void> | void",
      isOptional: true,
      description: "生成中止时调用的回调函数。",
    },
    {
      name: "activeTools",
      type: "Array<keyof ToolSet> | undefined",
      isOptional: true,
      description:
        "执行期间应处于活动状态的工具名称数组。如果为 undefined，则所有可用工具都处于活动状态。",
    },
    {
      name: "abortSignal",
      type: "AbortSignal",
      isOptional: true,
      description:
        "信号对象，允许您中止智能体的执行。当信号被中止时，所有正在进行的操作都将终止。",
    },
    {
      name: "prepareStep",
      type: "PrepareStepFunction",
      isOptional: true,
      description:
        "多步骤执行之前每个步骤调用的回调函数。",
    },
    {
      name: "requireToolApproval",
      type: "boolean",
      isOptional: true,
      description: "当为 true 时，所有工具调用都需要在执行前明确批准。generate() 方法将返回 `finishReason: 'suspended'` 并包含带有工具调用详细信息（`toolCallId`、`toolName`、`args`）的 `suspendPayload`。使用 `approveToolCallGenerate()` 或 `declineToolCallGenerate()` 继续。详情请参阅[智能体批准](/docs/cn/docs/agents/agent-approval#tool-approval-with-generate)。",
    },
    {
      name: "autoResumeSuspendedTools",
      type: "boolean",
      isOptional: true,
      description: "当为 true 时，当用户在同一个线程上发送新消息时，自动恢复暂停的工具。智能体根据工具的 `resumeSchema` 从用户消息中提取 `resumeData`。需要配置内存。",
    },
    {
      name: "toolCallConcurrency",
      type: "number",
      isOptional: true,
      description: "并发执行的最大工具调用数。当可能需要批准时默认为 1，否则为 10。",
    },
    {
      name: "context",
      type: "ModelMessage[]",
      isOptional: true,
      description: "提供给智能体的附加上下文消息。",
    },
    {
      name: "structuredOutput",
      type: "StructuredOutputOptions<S extends ZodTypeAny = ZodTypeAny>",
      isOptional: true,
      description: "微调结构化输出生成的选项。",
      properties: [
        {
          parameters: [
            {
              name: "schema",
              type: "z.ZodSchema<S>",
              isOptional: false,
              description: "定义预期输出结构的 Zod 模式。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "model",
              type: "MastraLanguageModel",
              isOptional: true,
              description:
                "用于结构化输出生成的语言模型。如果提供，使智能体能够通过工具调用、文本和结构化输出进行多步骤响应",
            },
          ],
        },
        {
          parameters: [
            {
              name: "errorStrategy",
              type: "'strict' | 'warn' | 'fallback'",
              isOptional: true,
              description:
                "处理模式验证错误的策略。'strict' 抛出错误，'warn' 记录警告，'fallback' 使用回退值。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "fallbackValue",
              type: "<S extends ZodTypeAny>",
              isOptional: true,
              description:
                "当模式验证失败且 errorStrategy 为 'fallback' 时使用的回退值。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "instructions",
              type: "string",
              isOptional: true,
              description:
                "结构化输出模型的附加指令。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "jsonPromptInjection",
              type: "boolean",
              isOptional: true,
              description:
                "将系统提示注入主智能体，指示其返回结构化输出，对于本身不支持结构输出的模型很有用。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "logger",
              type: "IMastraLogger",
              isOptional: true,
              description:
                "输出生成期间进行结构化日志记录的可选日志程序实例。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "providerOptions",
              type: "ProviderOptions",
              isOptional: true,
              description:
                "传递给内部结构化智能体的特定提供商选项。使用此功能控制模型行为，如思维模型的推理努力程度（例如，`{ openai: { reasoningEffort: 'low' } }`）。",
            },
          ],
        },
      ],
    },
    {
      name: "outputProcessors",
      type: "OutputProcessorOrWorkflow[]",
      isOptional: true,
      description:
        "此执行使用的输出处理器（覆盖智能体的默认值）。",
    },
    {
      name: "maxProcessorRetries",
      type: "number",
      isOptional: true,
      description:
        "处理器可以触发此生成重试的最大次数。覆盖智能体的默认 maxProcessorRetries。",
    },
    {
      name: "inputProcessors",
      type: "InputProcessorOrWorkflow[]",
      isOptional: true,
      description:
        "此执行使用的输入处理器（覆盖智能体的默认值）。",
    },
    {
      name: "instructions",
      type: "string | string[] | CoreSystemMessage | SystemModelMessage | CoreSystemMessage[] | SystemModelMessage[]",
      isOptional: true,
      description:
        "覆盖此执行的智能体默认指令的自定义指令。可以是单个字符串、消息对象或它们的数组。",
    },
    {
      name: "system",
      type: "string | string[] | CoreSystemMessage | SystemModelMessage | CoreSystemMessage[] | SystemModelMessage[]",
      isOptional: true,
      description:
        "要包含在提示中的自定义系统消息。可以是单个字符串、消息对象或它们的数组。系统消息提供补充智能体主要指令的附加上下文或行为指令。",
    },
    {
      name: "output",
      type: "Zod schema | JsonSchema7",
      isOptional: true,
      description:
        "**已弃用。** 使用不带模型的 structuredOutput 实现相同的效果。定义输出的预期结构。可以是 JSON Schema 对象或 Zod 模式。",
    },
    {
      name: "memory",
      type: "object",
      isOptional: true,
      description:
        "对话持久化和检索的内存配置。",
      properties: [
        {
          parameters: [
            {
              name: "thread",
              type: "string | { id: string; metadata?: Record<string, any>, title?: string }",
              isOptional: false,
              description:
                "对话连续性的线程标识符。可以是字符串 ID 或带有 ID 和可选 metadata/title 的对象。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "resource",
              type: "string",
              isOptional: false,
              description:
                "用于按用户、会话或上下文组织对话的资源标识符。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "options",
              type: "MemoryConfig",
              isOptional: true,
              description:
                "附加内存配置选项，包括 lastMessages、readOnly、semanticRecall 和 workingMemory。",
            },
          ],
        },
      ],
    },
    {
      name: "onFinish",
      type: "LoopConfig['onFinish']",
      isOptional: true,
      description:
        "生成完成时触发的回调。",
    },
    {
      name: "onStepFinish",
      type: "LoopConfig['onStepFinish']",
      isOptional: true,
      description:
        "每个生成步骤之后触发的回调。",
    },
    {
      name: "telemetry",
      type: "TelemetrySettings",
      isOptional: true,
      description:
        "生成期间 OTLP 遥测收集的设置（不是追踪）。",
      properties: [
        {
          parameters: [
            {
              name: "isEnabled",
              type: "boolean",
              isOptional: true,
              description: "是否启用遥测收集。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "recordInputs",
              type: "boolean",
              isOptional: true,
              description: "是否在遥测中记录输入数据。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "recordOutputs",
              type: "boolean",
              isOptional: true,
              description: "是否在遥测中记录输出数据。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "functionId",
              type: "string",
              isOptional: true,
              description: "正在执行的函数的标识符。",
            },
          ],
        },
      ],
    },
    MODEL_SETTINGS_OBJECT,
    {
      name: "toolChoice",
      type: "'auto' | 'none' | 'required' | { type: 'tool'; toolName: string }",
      isOptional: true,
      description: "控制生成期间如何选择工具。",
      properties: [
        {
          parameters: [
            {
              name: "'auto'",
              type: "string",
              isOptional: false,
              description: "让模型决定何时使用工具（默认）。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "'none'",
              type: "string",
              isOptional: false,
              description: "完全禁用工具使用。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "'required'",
              type: "string",
              isOptional: false,
              description: "强制模型使用至少一个工具。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "{ type: 'tool'; toolName: string }",
              type: "object",
              isOptional: false,
              description: "强制模型使用特定工具。",
            },
          ],
        },
      ],
    },
    {
      name: "toolsets",
      type: "ToolsetsInput",
      isOptional: true,
      description: "此执行可以使用的附加工具集。",
    },
    {
      name: "clientTools",
      type: "ToolsInput",
      isOptional: true,
      description: "执行期间可用的客户端工具。",
    },
    {
      name: "savePerStep",
      type: "boolean",
      isOptional: true,
      description:
        "每个生成步骤完成后增量保存消息（默认：false）。",
    },
    {
      name: "providerOptions",
      type: "Record<string, Record<string, JSONValue>>",
      isOptional: true,
      description: "传递给语言模型的特定提供商选项。",
      properties: [
        {
          parameters: [
            {
              name: "openai",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description:
                "OpenAI 特定选项，如 reasoningEffort、responseFormat 等。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "anthropic",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description: "Anthropic 特定选项，如 maxTokens 等。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "google",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description: "Google 特定选项。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "[providerName]",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description: "任何特定提供商的选项。",
            },
          ],
        },
      ],
    },
    {
      name: "runId",
      type: "string",
      isOptional: true,
      description: "此执行运行的唯一标识符。",
    },
    {
      name: "requestContext",
      type: "RequestContext",
      isOptional: true,
      description:
        "包含动态配置和状态的请求上下文。",
    },
    {
      name: "tracingContext",
      type: "TracingContext",
      isOptional: true,
      description:
        "用于创建子跨度并添加元数据的追踪上下文。使用 Mastra 的追踪系统时自动注入。",
      properties: [
        {
          parameters: [
            {
              name: "currentSpan",
              type: "Span",
              isOptional: true,
              description:
                "用于创建子跨度并添加元数据的当前跨度。使用此功能创建自定义子跨度或在执行期间更新跨度属性。",
            },
          ],
        },
      ],
    },
    {
      name: "tracingOptions",
      type: "TracingOptions",
      isOptional: true,
      description: "追踪配置的选项。",
      properties: [
        {
          parameters: [
            {
              name: "metadata",
              type: "Record<string, any>",
              isOptional: true,
              description:
                "要添加到根追踪跨度的元数据。用于添加自定义属性，如用户 ID、会话 ID 或功能标志。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "requestContextKeys",
              type: "string[]",
              isOptional: true,
              description:
                "作为此追踪的元数据提取的附加 RequestContext 键。支持点表示法获取嵌套值（例如，'user.id'）。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "traceId",
              type: "string",
              isOptional: true,
              description:
                "用于此执行的追踪 ID（1-32 个十六进制字符）。如果提供，此追踪将成为指定追踪的一部分。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "parentSpanId",
              type: "string",
              isOptional: true,
              description:
                "用于此执行的父跨度 ID（1-16 个十六进制字符）。如果提供，根跨度将创建为此跨度的子跨度。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "tags",
              type: "string[]",
              isOptional: true,
              description:
                "要应用于此追踪的标签。用于分类和筛选追踪的字符串标签。",
            },
          ],
        },
      ],
    },
    {
      name: "includeRawChunks",
      type: "boolean",
      isOptional: true,
      description:
        "是否在流输出中包含原始块。并非所有模型提供商都支持。",
    },
  ]}
/>

## 返回值

<PropertiesTable
  content={[
    {
      name: "result",
      type: "Awaited<ReturnType<MastraModelOutput<Output>['getFullOutput']>>",
      description:
        "返回生成过程的完整输出，包括文本、对象（如果结构化输出）、工具调用、工具结果、使用统计和步骤信息。",
    },
    {
      name: "text",
      type: "string",
      description:
        "智能体生成的文本响应。",
    },
    {
      name: "object",
      type: "Output | undefined",
      isOptional: true,
      description:
        "如果提供了 structuredOutput，则为结构化输出对象，根据模式验证。",
    },
    {
      name: "toolCalls",
      type: "ToolCall[]",
      description:
        "生成期间进行的工具调用数组。",
    },
    {
      name: "toolResults",
      type: "ToolResult[]",
      description:
        "工具执行结果的数组。",
    },
    {
      name: "usage",
      type: "TokenUsage",
      description:
        "生成的 token 使用统计。",
    },
    {
      name: "steps",
      type: "Step[]",
      description:
        "执行步骤数组，对于调试多步骤生成很有用。",
    },
    {
      name: "finishReason",
      type: "string",
      description:
        "生成完成的原因。值包括 'stop'（正常完成）、'tool-calls'（以工具调用结束）、'suspended'（等待工具批准）或 'error'（发生错误）。",
    },
    {
      name: "response",
      type: "object",
      description:
        "来自模型提供商的响应元数据。用于访问速率限制头和请求 ID。",
      properties: [
        {
          parameters: [
            {
              name: "id",
              type: "string",
              isOptional: true,
              description: "来自模型提供商的响应 ID。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "timestamp",
              type: "Date",
              isOptional: true,
              description: "生成响应时的时间戳。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "modelId",
              type: "string",
              isOptional: true,
              description: "此响应使用的模型标识符。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "headers",
              type: "Record<string, string>",
              isOptional: true,
              description: "来自模型提供商的 HTTP 响应头。包含速率限制信息（例如，`anthropic-ratelimit-requests-remaining`、`x-ratelimit-remaining-tokens`）和其他特定提供商元数据。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "messages",
              type: "ResponseMessage[]",
              isOptional: true,
              description: "模型格式的响应消息。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "uiMessages",
              type: "UIMessage[]",
              isOptional: true,
              description: "UI 格式的响应消息，包括输出处理器添加的任何元数据。",
            },
          ],
        },
      ],
    },
    {
      name: "request",
      type: "object",
      isOptional: true,
      description:
        "发送给模型的请求。",
      properties: [
        {
          parameters: [
            {
              name: "body",
              type: "unknown",
              isOptional: true,
              description: "发送给模型提供商的请求体。",
            },
          ],
        },
      ],
    },
    {
      name: "warnings",
      type: "LanguageModelWarning[]",
      isOptional: true,
      description:
        "生成期间来自模型提供商的任何警告。",
    },
    {
      name: "providerMetadata",
      type: "Record<string, unknown>",
      isOptional: true,
      description:
        "随响应返回的特定提供商元数据。",
    },
    {
      name: "reasoning",
      type: "ReasoningChunk[]",
      isOptional: true,
      description:
        "支持推理的模型的推理详情（例如，OpenAI o1 系列）。",
    },
    {
      name: "reasoningText",
      type: "string",
      isOptional: true,
      description:
        "来自推理模型的组合推理文本。",
    },
    {
      name: "sources",
      type: "SourceChunk[]",
      isOptional: true,
      description:
        "生成期间模型引用的来源。",
    },
    {
      name: "files",
      type: "FileChunk[]",
      isOptional: true,
      description:
        "模型生成的文件。",
    },
    {
      name: "suspendPayload",
      type: "object",
      isOptional: true,
      description:
        "当 `finishReason` 为 'suspended' 时存在。包含批准或拒绝待处理工具调用所需的工具调用详细信息。",
      properties: [
        {
          parameters: [
            {
              name: "toolCallId",
              type: "string",
              description: "待处理工具调用的唯一标识符。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "toolName",
              type: "string",
              description: "需要批准的工具名称。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "args",
              type: "Record<string, any>",
              description: "将传递给工具的参数。",
            },
          ],
        },
      ],
    },
    {
      name: "runId",
      type: "string",
      isOptional: true,
      description:
        "此执行运行的唯一标识符。调用 `approveToolCallGenerate()` 或 `declineToolCallGenerate()` 恢复暂停的执行时需要。",
    },
    {
      name: "traceId",
      type: "string",
      isOptional: true,
      description:
        "启用追踪时与此执行关联的追踪 ID。使用此功能关联日志并调试执行流程。",
    },
    {
      name: "messages",
      type: "MastraDBMessage[]",
      description:
        "此执行的所有消息，包括输入、内存历史和响应。",
    },
    {
      name: "rememberedMessages",
      type: "MastraDBMessage[]",
      description:
        "仅从内存加载的消息（对话历史）。",
    },
    {
      name: "error",
      type: "Error",
      isOptional: true,
      description:
        "如果生成失败则为错误对象。",
    },
    {
      name: "tripwire",
      type: "StepTripwireData",
      isOptional: true,
      description:
        "如果内容被处理器阻止则为保险丝数据。",
    },
    {
      name: "scoringData",
      type: "object",
      isOptional: true,
      description:
        "当 `returnScorerData` 启用时为评估的评分数据。",
    },
  ]}
/>
