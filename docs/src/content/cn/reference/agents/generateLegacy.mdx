---
title: "参考文档：Agent.generateLegacy() (旧版) | 智能体"
description: "Mastra 智能体中旧版 `Agent.generateLegacy()` 方法的文档。此方法已弃用，将在未来版本中移除。"
packages:
  - "@mastra/core"
---

# Agent.generateLegacy() (旧版)

:::warning

**已弃用**：此方法已弃用，仅适用于 V1 模型。对于 V2 模型，请改用新的 [`.generate()`](./generate) 方法。

:::

`.generateLegacy()` 方法是智能体生成 API 的旧版本，用于与 V1 模型智能体交互以生成文本或结构化响应。此方法接受消息和可选的生成选项。

## 使用示例

```typescript
await agent.generateLegacy("message for agent");
```

## 参数

<PropertiesTable
  content={[
    {
      name: "messages",
      type: "string | string[] | CoreMessage[] | AiMessageType[] | UIMessageWithMetadata[]",
      description:
        "发送给智能体的消息。可以是单个字符串、字符串数组，或带有多模态内容（文本、图像等）的结构化消息对象。",
    },
    {
      name: "options",
      type: "AgentGenerateOptions",
      isOptional: true,
      description: "生成过程的可选配置。",
    },
  ]}
/>

### 选项参数

<PropertiesTable
  content={[
    {
      name: "abortSignal",
      type: "AbortSignal",
      isOptional: true,
      description:
        "允许中止智能体执行信号对象。当信号被中止时，所有正在进行的操作都将终止。",
    },
    {
      name: "context",
      type: "CoreMessage[]",
      isOptional: true,
      description: "提供给智能体的额外上下文消息。",
    },
    {
      name: "structuredOutput",
      type: "StructuredOutputOptions<S extends ZodTypeAny = ZodTypeAny>",
      isOptional: true,
      description:
        "启用结构化输出生成，提供更好的开发者体验。内部自动创建和使用 StructuredOutputProcessor。",
      properties: [
        {
          parameters: [
            {
              name: "schema",
              type: "z.ZodSchema<S>",
              isOptional: false,
              description: "用于验证输出的 Zod 模式。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "model",
              type: "MastraLanguageModel",
              isOptional: false,
              description: "用于内部结构化智能体的模型。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "errorStrategy",
              type: "'strict' | 'warn' | 'fallback'",
              isOptional: true,
              description:
                "解析或验证失败时的策略。默认为 'strict'。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "fallbackValue",
              type: "<S extends ZodTypeAny>",
              isOptional: true,
              description: "当 errorStrategy 为 'fallback' 时的回退值。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "instructions",
              type: "string",
              isOptional: true,
              description: "结构化智能体的自定义指令。",
            },
          ],
        },
      ],
    },
    {
      name: "outputProcessors",
      type: "Processor[]",
      isOptional: true,
      description:
        "覆盖智能体上设置的输出处理器。输出处理器可以在返回给用户之前修改或验证来自智能体的消息。必须实现 `processOutputResult` 和/或 `processOutputStream` 函数。",
    },
    {
      name: "inputProcessors",
      type: "Processor[]",
      isOptional: true,
      description:
        "覆盖智能体上设置的输入处理器。输入处理器可以在智能体处理之前修改或验证消息。必须实现 `processInput` 函数。",
    },
    {
      name: "experimental_output",
      type: "Zod schema | JsonSchema7",
      isOptional: true,
      description:
        "注意，首选方法是使用 `structuredOutput` 属性。启用与文本生成和工具调用一起的结构化输出生成。模型将生成符合所提供的模式。",
    },
    {
      name: "instructions",
      type: "string",
      isOptional: true,
      description:
        "覆盖此特定生成的智能体默认指令的自定义指令。用于在不创建新智能体实例的情况下动态修改智能体行为。",
    },
    {
      name: "output",
      type: "Zod schema | JsonSchema7",
      isOptional: true,
      description:
        "定义输出的预期结构。可以是 JSON Schema 对象或 Zod 模式。",
    },
    {
      name: "memory",
      type: "object",
      isOptional: true,
      description:
        "内存配置。这是管理内存的首选方式。",
      properties: [
        {
          parameters: [
            {
              name: "thread",
              type: "string | { id: string; metadata?: Record<string, any>, title?: string }",
              isOptional: false,
              description:
                "对话线程，作为字符串 ID 或带有 `id` 和可选 `metadata` 的对象。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "resource",
              type: "string",
              isOptional: false,
              description:
                "与线程关联的用户或资源的标识符。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "options",
              type: "MemoryConfig",
              isOptional: true,
              description:
                "内存行为的配置，如消息历史和语义召回。参见下面的 `MemoryConfig`。",
            },
          ],
        },
      ],
    },
    {
      name: "maxSteps",
      type: "number",
      isOptional: true,
      defaultValue: "5",
      description: "允许的最大执行步骤数。",
    },
    {
      name: "maxRetries",
      type: "number",
      isOptional: true,
      defaultValue: "2",
      description: "最大重试次数。设置为 0 以禁用重试。",
    },
    {
      name: "onStepFinish",
      type: "GenerateTextOnStepFinishCallback<any> | never",
      isOptional: true,
      description:
        "每个执行步骤完成后调用的回调函数。接收步骤详情作为 JSON 字符串。结构化输出不可用。",
    },
    {
      name: "runId",
      type: "string",
      isOptional: true,
      description:
        "此生成运行的唯一 ID。可用于跟踪和调试目的。",
    },
    {
      name: "telemetry",
      type: "TelemetrySettings",
      isOptional: true,
      description: "生成期间遥测收集的设置。",
      properties: [
        {
          parameters: [
            {
              name: "isEnabled",
              type: "boolean",
              isOptional: true,
              description:
                "启用或禁用遥测。实验性阶段默认禁用。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "recordInputs",
              type: "boolean",
              isOptional: true,
              description:
                "启用或禁用输入记录。默认启用。您可能希望禁用输入记录以避免记录敏感信息。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "recordOutputs",
              type: "boolean",
              isOptional: true,
              description:
                "启用或禁用输出记录。默认启用。您可能希望禁用输出记录以避免记录敏感信息。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "functionId",
              type: "string",
              isOptional: true,
              description:
                "此函数的标识符。用于按函数对遥测数据进行分组。",
            },
          ],
        },
      ],
    },
    {
      name: "temperature",
      type: "number",
      isOptional: true,
      description:
        "控制模型输出的随机性。较高的值（如 0.8）使输出更随机，较低的值（如 0.2）使输出更聚焦和确定性。",
    },
    {
      name: "toolChoice",
      type: "'auto' | 'none' | 'required' | { type: 'tool'; toolName: string }",
      isOptional: true,
      defaultValue: "'auto'",
      description: "控制智能体在生成过程中如何使用工具。",
      properties: [
        {
          parameters: [
            {
              name: "'auto'",
              type: "string",
              description:
                "让模型决定是否使用工具（默认）。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "'none'",
              type: "string",
              description: "不使用任何工具。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "'required'",
              type: "string",
              description: "要求模型使用至少一个工具。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "{ type: 'tool'; toolName: string }",
              type: "object",
              description: "要求模型使用特定名称的工具。",
            },
          ],
        },
      ],
    },
    {
      name: "toolsets",
      type: "ToolsetsInput",
      isOptional: true,
      description:
        "在生成过程中可供智能体使用的额外工具集。",
    },
    {
      name: "clientTools",
      type: "ToolsInput",
      isOptional: true,
      description:
        "在请求的'客户端'端执行的工具。这些工具在定义中没有 execute 函数。",
    },
    {
      name: "savePerStep",
      type: "boolean",
      isOptional: true,
      description:
        "在每个流步骤完成后增量保存消息（默认：false）。",
    },
    {
      name: "providerOptions",
      type: "Record<string, Record<string, JSONValue>>",
      isOptional: true,
      description:
        "传递给底层 LLM 提供商的特定提供商附加选项。结构为 `{ providerName: { optionKey: value } }`。由于 Mastra 扩展了 AI SDK，请参阅 [AI SDK 文档](https://sdk.vercel.ai/docs/cn/docs/providers/ai-sdk-providers) 获取完整的提供商选项。",
      properties: [
        {
          parameters: [
            {
              name: "openai",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description:
                "OpenAI 特定选项。示例：`{ reasoningEffort: 'high' }`",
            },
          ],
        },
        {
          parameters: [
            {
              name: "anthropic",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description:
                "Anthropic 特定选项。示例：`{ maxTokens: 1000 }`",
            },
          ],
        },
        {
          parameters: [
            {
              name: "google",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description:
                "Google 特定选项。示例：`{ safetySettings: [...] }`",
            },
          ],
        },
        {
          parameters: [
            {
              name: "[providerName]",
              type: "Record<string, JSONValue>",
              isOptional: true,
              description:
                "其他特定提供商选项。键是提供商名称，值是特定提供商选项的记录。",
            },
          ],
        },
      ],
    },
    {
      name: "requestContext",
      type: "RequestContext",
      isOptional: true,
      description:
        "用于依赖注入和上下文信息的请求上下文。",
    },
    {
      name: "maxTokens",
      type: "number",
      isOptional: true,
      description: "生成的最大 token 数。",
    },
    {
      name: "topP",
      type: "number",
      isOptional: true,
      description:
        "核采样。这是一个介于 0 和 1 之间的数字。建议设置 `temperature` 或 `topP` 之一，而非两者都设置。",
    },
    {
      name: "topK",
      type: "number",
      isOptional: true,
      description:
        "仅从每个后续 token 的 top K 选项中采样。用于移除'长尾'低概率响应。",
    },
    {
      name: "presencePenalty",
      type: "number",
      isOptional: true,
      description:
        "存在惩罚设置。它影响模型重复提示中已有信息的可能性。介于 -1（增加重复）和 1（最大惩罚，减少重复）之间的数字。",
    },
    {
      name: "frequencyPenalty",
      type: "number",
      isOptional: true,
      description:
        "频率惩罚设置。它影响模型重复使用相同单词或短语的可能性。介于 -1（增加重复）和 1（最大惩罚，减少重复）之间的数字。",
    },
    {
      name: "stopSequences",
      type: "string[]",
      isOptional: true,
      description:
        "停止序列。如果设置，当生成停止序列之一时，模型将停止生成文本。",
    },
    {
      name: "seed",
      type: "number",
      isOptional: true,
      description:
        "用于随机采样的种子（整数）。如果设置且模型支持，调用将生成确定性结果。",
    },
    {
      name: "headers",
      type: "Record<string, string | undefined>",
      isOptional: true,
      description:
        "随请求发送的附加 HTTP 标头。仅适用于基于 HTTP 的提供商。",
    },
  ]}
/>

## 返回值

<PropertiesTable
  content={[
    {
      name: "text",
      type: "string",
      isOptional: true,
      description:
        "生成的文本响应。当输出为 'text'（未提供模式）时存在。",
    },
    {
      name: "object",
      type: "object",
      isOptional: true,
      description:
        "生成的结构化响应。当通过 `output`、`structuredOutput` 或 `experimental_output` 提供模式时存在。",
    },
    {
      name: "toolCalls",
      type: "Array<ToolCall>",
      isOptional: true,
      description:
        "生成过程中进行的工具调用。同时存在于文本和对象模式中。",
      properties: [
        {
          parameters: [
            {
              name: "toolName",
              type: "string",
              required: true,
              description: "调用的工具名称。",
            },
          ],
        },
        {
          parameters: [
            {
              name: "args",
              type: "any",
              required: true,
              description: "传递给工具的参数。",
            },
          ],
        },
      ],
    },
  ]}
/>

## 迁移到新 API

:::info

新的 `.generate()` 方法提供了增强的功能，包括 AI SDK v5+ 兼容性、更结构化输出处理和改进的流式支持。请参阅[迁移指南](/guides/migrations/vnext-to-standard-apis)获取详细的迁移说明。

:::

### 快速迁移示例

#### 之前（旧版）

```typescript
const result = await agent.generateLegacy("message", {
  temperature: 0.7,
  maxSteps: 3,
});
```

#### 之后（新 API）

```typescript
const result = await agent.generate("message", {
  modelSettings: {
    temperature: 0.7,
  },
  maxSteps: 3,
});
```

## 扩展使用示例

```typescript
import { z } from "zod";
import {
  ModerationProcessor,
  TokenLimiterProcessor,
} from "@mastra/core/processors";

await agent.generateLegacy(
  [
    { role: "user", content: "message for agent" },
    {
      role: "user",
      content: [
        {
          type: "text",
          text: "message for agent",
        },
        {
          type: "image",
          imageUrl: "https://example.com/image.jpg",
          mimeType: "image/jpeg",
        },
      ],
    },
  ],
  {
    temperature: 0.7,
    maxSteps: 3,
    memory: {
      thread: "user-123",
      resource: "test-app",
    },
    toolChoice: "auto",
    providerOptions: {
      openai: {
        reasoningEffort: "high",
      },
    },
    // 结构化输出，提供更好的开发者体验
    structuredOutput: {
      schema: z.object({
        sentiment: z.enum(["positive", "negative", "neutral"]),
        confidence: z.number(),
      }),
      model: "openai/gpt-5.1",
      errorStrategy: "warn",
    },
    // 用于响应验证的输出处理器
    outputProcessors: [
      new ModerationProcessor({ model: "openai/gpt-4.1-nano" }),
      new TokenLimiterProcessor({ maxTokens: 1000 }),
    ],
  },
);
```

## 相关内容

- [迁移指南](/guides/migrations/vnext-to-standard-apis)
- [新的 .generate() 方法](./generate)
- [生成响应](/docs/cn/docs/agents/overview#generating-responses)
- [流式响应](/docs/cn/docs/agents/overview#generating-responses)
