---
title: "参考文档：voice.on() | 语音"
description: "语音提供者提供的 on() 方法文档，用于注册语音事件的事件监听器。"
packages:
  - "@mastra/core"
  - "@mastra/node-speaker"
  - "@mastra/voice-openai-realtime"
---

# voice.on()

`on()` 方法为各种语音事件注册事件监听器。这对于实时语音提供者特别重要，事件用于传达转录的文本、音频响应和其他状态变化。

## 使用示例

```typescript
import { OpenAIRealtimeVoice } from "@mastra/voice-openai-realtime";
import Speaker from "@mastra/node-speaker";
import chalk from "chalk";

// 初始化实时语音提供者
const voice = new OpenAIRealtimeVoice({
  realtimeConfig: {
    model: "gpt-5.1-realtime",
    apiKey: process.env.OPENAI_API_KEY,
  },
});

// 连接到实时服务
await voice.connect();

// 注册转录文本的事件监听器
voice.on("writing", (event) => {
  if (event.role === "user") {
    process.stdout.write(chalk.green(event.text));
  } else {
    process.stdout.write(chalk.blue(event.text));
  }
});

// 监听音频数据并播放
const speaker = new Speaker({
  sampleRate: 24100,
  channels: 1,
  bitDepth: 16,
});

voice.on("speaker", (stream) => {
  stream.pipe(speaker);
});

// 注册错误的事件监听器
voice.on("error", ({ message, code, details }) => {
  console.error(`错误 ${code}: ${message}`, details);
});
```

## 参数

<br />
<PropertiesTable
  content={[
    {
      name: "event",
      type: "string",
      description:
        "要监听的事件名称。请参阅[语音事件](./voice.events)文档以获取可用事件列表。",
      isOptional: false,
    },
    {
      name: "callback",
      type: "function",
      description:
        "事件发生时要调用的回调函数。回调签名取决于特定事件。",
      isOptional: false,
    },
  ]}
/>

## 返回值

此方法不返回值。

## 事件

有关事件的完整列表及其有效载荷结构，请参阅[语音事件](./voice.events)文档。

常见事件包括：

- `speaking`：有音频数据时发出
- `speaker`：发出可以管道传输到音频输出的流
- `writing`：文本被转录或生成时发出
- `error`：发生错误时发出
- `tool-call-start`：即将执行工具时发出
- `tool-call-result`：工具执行完成时发出

不同的语音提供者可能支持不同的事件集，具有不同的有效载荷结构。

## 与 CompositeVoice 一起使用

使用 `CompositeVoice` 时，`on()` 方法委托给配置的实时提供者：

```typescript
import { CompositeVoice } from "@mastra/core/voice";
import { OpenAIRealtimeVoice } from "@mastra/voice-openai-realtime";
import Speaker from "@mastra/node-speaker";

const speaker = new Speaker({
  sampleRate: 24100, // 音频采样率（Hz）- MacBook Pro 高品质音频的标准
  channels: 1, // 单声道音频输出（立体声为 2）
  bitDepth: 16, // 音频位深度 - CD 质量标准（16位分辨率）
});

const realtimeVoice = new OpenAIRealtimeVoice();
const voice = new CompositeVoice({
  realtime: realtimeVoice,
});

// 连接到实时服务
await voice.connect;

// 这将向 OpenAIRealtimeVoice 提供者注册事件监听器
voice.on("speaker", (stream) => {
  stream.pipe(speaker);
});
```

## 注意事项

- 此方法主要用于支持基于事件通信的实时语音提供者
- 如果在不支持事件的语音提供者上调用，它会记录警告并什么都不做
- 事件监听器应在调用可能发出事件的方法之前注册
- 要移除事件监听器，请使用具有相同事件名称和回调函数的 [voice.off()](./voice.off) 方法
- 可以为同一事件注册多个监听器
- 回调函数将根据事件类型接收不同的数据（请参阅[语音事件](./voice.events)）
- 为获得最佳性能，考虑在不再需要事件监听器时将其移除
