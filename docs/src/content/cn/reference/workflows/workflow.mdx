---
title: "参考：Workflow 类 | 工作流"
description: "Mastra 中 `Workflow` 类的文档，用于创建具有条件分支和数据验证的复杂操作序列状态机。"
packages:
  - "@mastra/core"
---

# Workflow 类

`Workflow` 类使您能够创建具有条件分支和数据验证的复杂操作序列状态机。

## 使用示例

```typescript title="src/mastra/workflows/test-workflow.ts"
import { createWorkflow } from "@mastra/core/workflows";
import { z } from "zod";

export const workflow = createWorkflow({
  id: "test-workflow",
  inputSchema: z.object({
    value: z.string(),
  }),
  outputSchema: z.object({
    value: z.string(),
  }),
});
```

## 构造函数参数

<PropertiesTable
  content={[
    {
      name: "id",
      type: "string",
      description: "工作流的唯一标识符",
    },
    {
      name: "inputSchema",
      type: "z.ZodType<any>",
      description: "定义工作流输入结构的 Zod 模式",
    },
    {
      name: "outputSchema",
      type: "z.ZodType<any>",
      description: "定义工作流输出结构的 Zod 模式",
    },
    {
      name: "stateSchema",
      type: "z.ZodObject<any>",
      description:
        "工作流状态的可选 Zod 模式。使用 Mastra 的状态系统时自动注入。如果未指定，类型为 'any'。",
      isOptional: true,
    },
    {
      name: "requestContextSchema",
      type: "z.ZodType<any>",
      description:
        "用于验证请求上下文值的 Zod 模式。如果提供，上下文在 run.start() 开始时进行验证，如果验证失败则抛出错误。",
      isOptional: true,
    },
    {
      name: "options",
      type: "WorkflowOptions",
      description: "工作流的可选选项",
      isOptional: true,
    },
  ]}
/>

### WorkflowOptions

<PropertiesTable
  content={[
    {
      name: "tracingPolicy",
      type: "TracingPolicy",
      description: "工作流的可选追踪策略",
      isOptional: true,
    },
    {
      name: "validateInputs",
      type: "boolean",
      description:
        "可选标志，用于确定是否验证工作流输入。这也会在工作流/步骤输入/恢复数据上应用来自 zodSchemas 的默认值。如果 start/resume 时输入/恢复数据验证失败，工作流将不会启动/恢复，而是抛出错误。如果步骤执行时输入数据验证失败，步骤将失败，导致工作流失败并返回错误。",
      isOptional: true,
      defaultValue: "true",
    },
    {
      name: "shouldPersistSnapshot",
      type: "(params: { stepResults: Record<string, StepResult<any, any, any, any>>; workflowStatus: WorkflowRunStatus }) => boolean",
      description:
        "可选标志，用于确定是否持久化工作流快照",
      isOptional: true,
      defaultValue: "() => true",
    },
    {
      name: "onFinish",
      type: "(result: WorkflowFinishCallbackResult) => void | Promise<void>",
      description:
        "工作流完成时调用的回调函数（任何状态：success、failed、suspended、tripwire）。接收工作流结果，包括状态、输出、错误和步骤结果。此回调中抛出的错误会被捕获并记录，不会传播。",
      isOptional: true,
    },
    {
      name: "onError",
      type: "(errorInfo: WorkflowErrorCallbackInfo) => void | Promise<void>",
      description:
        "仅在工作流失败时调用的回调函数（failed 或 tripwire 状态）。接收错误详情和步骤结果。此回调中抛出的错误会被捕获并记录，不会传播。",
      isOptional: true,
    },
  ]}
/>

### WorkflowFinishCallbackResult

传递给 `onFinish` 回调的结果对象。

<PropertiesTable
  content={[
    {
      name: "status",
      type: "WorkflowRunStatus",
      description: "工作流状态：'success'、'failed'、'suspended' 或 'tripwire'",
    },
    {
      name: "result",
      type: "any",
      description: "工作流输出（当状态为 'success' 时）",
      isOptional: true,
    },
    {
      name: "error",
      type: "SerializedError",
      description: "错误详情（当状态为 'failed' 时）",
      isOptional: true,
    },
    {
      name: "steps",
      type: "Record<string, StepResult>",
      description: "包含状态和输出的单个步骤结果",
    },
    {
      name: "tripwire",
      type: "StepTripwireInfo",
      description: "断路器信息（当状态为 'tripwire' 时）",
      isOptional: true,
    },
    {
      name: "runId",
      type: "string",
      description: "此工作流运行的唯一标识符",
    },
    {
      name: "workflowId",
      type: "string",
      description: "工作流的标识符",
    },
    {
      name: "resourceId",
      type: "string",
      description: "可选资源标识符（如果在创建运行时提供）",
      isOptional: true,
    },
    {
      name: "getInitData",
      type: "() => any",
      description: "返回传递给工作流的初始输入数据的函数",
    },
    {
      name: "mastra",
      type: "Mastra",
      description: "Mastra 实例（如果工作流已向 Mastra 注册）",
      isOptional: true,
    },
    {
      name: "requestContext",
      type: "RequestContext",
      description: "请求作用域的上下文数据",
    },
    {
      name: "logger",
      type: "IMastraLogger",
      description: "工作流的日志器实例",
    },
    {
      name: "state",
      type: "Record<string, any>",
      description: "工作流当前的状态对象",
    },
  ]}
/>

### WorkflowErrorCallbackInfo

传递给 `onError` 回调的错误信息对象。

<PropertiesTable
  content={[
    {
      name: "status",
      type: "'failed' | 'tripwire'",
      description: "工作流状态（'failed' 或 'tripwire'）",
    },
    {
      name: "error",
      type: "SerializedError",
      description: "错误详情",
      isOptional: true,
    },
    {
      name: "steps",
      type: "Record<string, StepResult>",
      description: "包含状态和输出的单个步骤结果",
    },
    {
      name: "tripwire",
      type: "StepTripwireInfo",
      description: "断路器信息（当状态为 'tripwire' 时）",
      isOptional: true,
    },
    {
      name: "runId",
      type: "string",
      description: "此工作流运行的唯一标识符",
    },
    {
      name: "workflowId",
      type: "string",
      description: "工作流的标识符",
    },
    {
      name: "resourceId",
      type: "string",
      description: "可选资源标识符（如果在创建运行时提供）",
      isOptional: true,
    },
    {
      name: "getInitData",
      type: "() => any",
      description: "返回传递给工作流的初始输入数据的函数",
    },
    {
      name: "mastra",
      type: "Mastra",
      description: "Mastra 实例（如果工作流已向 Mastra 注册）",
      isOptional: true,
    },
    {
      name: "requestContext",
      type: "RequestContext",
      description: "请求作用域的上下文数据",
    },
    {
      name: "logger",
      type: "IMastraLogger",
      description: "工作流的日志器实例",
    },
    {
      name: "state",
      type: "Record<string, any>",
      description: "工作流当前的状态对象",
    },
  ]}
/>

## 使用初始状态运行

启动工作流运行时，您可以传递 `initialState` 来设置工作流状态的起始值：

```typescript
const run = await workflow.createRun();

const result = await run.start({
  inputData: { value: "hello" },
  initialState: {
    counter: 0,
    items: [],
  },
});
```

`initialState` 对象应该与工作流的 `stateSchema` 中定义的结构匹配。详情请参阅 [工作流状态](/docs/cn/docs/workflows/workflow-state)。

## 工作流状态

工作流的 `status` 表示其当前执行状态。可能的值有：

<PropertiesTable
  content={[
    {
      name: "success",
      type: "string",
      description:
        "所有步骤成功执行完成，输出有效结果",
    },
    {
      name: "failed",
      type: "string",
      description:
        "工作流在执行过程中遇到错误，可获取错误详情",
    },
    {
      name: "suspended",
      type: "string",
      description:
        "工作流执行暂停等待恢复，可获取暂停步骤信息",
    },
    {
      name: "tripwire",
      type: "string",
      description:
        "工作流被处理器断路器终止。当工作流中的代理步骤触发断路器时发生（例如，内容被_guardrail_阻止）。断路器信息可在结果上获取。",
    },
  ]}
/>

### 处理断路器状态

当工作流包含触发断路器的代理步骤时，工作流返回 `status: 'tripwire'` 并包含断路器详情：

```typescript
const run = await workflow.createRun();
const result = await run.start({ inputData: { message: "Hello" } });

if (result.status === "tripwire") {
  console.log("Workflow terminated by tripwire:", result.tripwire?.reason);
  console.log("Processor ID:", result.tripwire?.processorId);
  console.log("Retry requested:", result.tripwire?.retry);
}
```

这与 `status: 'failed'` 不同，后者表示意外错误。断路器状态意味着处理器有意停止执行（例如，出于内容审核原因）。

## 相关内容

- [Step 类](./step)
- [工作流状态](/docs/cn/docs/workflows/workflow-state)
- [控制流](/docs/cn/docs/workflows/control-flow)
