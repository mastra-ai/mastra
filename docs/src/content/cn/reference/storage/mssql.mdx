---
title: "参考文档: MSSQL 存储 | 存储"
description: "Mastra 中 MSSQL 存储实现的文档。"
packages:
  - "@mastra/core"
  - "@mastra/mssql"
---

# MSSQL 存储

MSSQL 存储实现使用 Microsoft SQL Server 数据库提供了生产级存储解决方案。

## 安装

```bash npm2yarn
npm install @mastra/mssql@latest
```

## 使用方法

```typescript
import { MSSQLStore } from "@mastra/mssql";

const storage = new MSSQLStore({
  id: 'mssql-storage',
  connectionString: process.env.DATABASE_URL,
});
```

## 参数

<PropertiesTable
  content={[
    {
      name: "connectionString",
      type: "string",
      description: "MSSQL 连接字符串（例如，Server=localhost,1433;Database=mydb;User Id=sa;Password=password;Encrypt=true;TrustServerCertificate=true）。",
      isOptional: false,
    },
    {
      name: "schemaName",
      type: "string",
      description: "存储要使用的模式名称。如果未提供，将使用默认模式。",
      isOptional: true,
    },
  ]}
/>

## 构造函数示例

你可以通过以下方式实例化 `MSSQLStore`：

```ts
import { MSSQLStore } from "@mastra/mssql";

// 仅使用连接字符串
const store1 = new MSSQLStore({
  id: 'mssql-storage-1',
  connectionString: "Server=localhost,1433;Database=mydb;User Id=sa;Password=password;Encrypt=true;TrustServerCertificate=true",
});

// 使用带自定义模式名称的连接字符串
const store2 = new MSSQLStore({
  id: 'mssql-storage-2',
  connectionString: "Server=localhost,1433;Database=mydb;User Id=sa;Password=password;Encrypt=true;TrustServerCertificate=true",
  schemaName: "custom_schema", // 可选
});

// 使用单独的连接参数
const store4 = new MSSQLStore({
  id: 'mssql-storage-3',
  server: "localhost",
  port: 1433,
  database: "mydb",
  user: "user",
  password: "password",
});

// 单独参数加模式名称
const store5 = new MSSQLStore({
  id: 'mssql-storage-4',
  server: "localhost",
  port: 1433,
  database: "mydb",
  user: "user",
  password: "password",
  schemaName: "custom_schema", // 可选
});
```

## 额外说明

### 模式管理

存储实现自动处理模式的创建和更新。它创建以下表：

- `mastra_workflow_snapshot`：存储工作流状态和执行数据
- `mastra_evals`：存储评估结果和元数据
- `mastra_threads`：存储对话线程
- `mastra_messages`：存储单个消息
- `mastra_traces`：存储遥测和追踪数据
- `mastra_scorers`：存储评分和评估数据
- `mastra_resources`：存储资源工作内存数据

### 初始化

当你将存储传递给 Mastra 类时，`init()` 会自动在任何存储操作之前调用：

```typescript
import { Mastra } from "@mastra/core";
import { MSSQLStore } from "@mastra/mssql";

const storage = new MSSQLStore({
  connectionString: process.env.DATABASE_URL,
});

const mastra = new Mastra({
  storage, // init() 自动调用
});
```

如果你在没有 Mastra 的情况下直接使用存储，必须显式调用 `init()` 来创建表：

```typescript
import { MSSQLStore } from "@mastra/mssql";

const storage = new MSSQLStore({
  id: 'mssql-storage',
  connectionString: process.env.DATABASE_URL,
});

// 直接使用存储时需要
await storage.init();

// 通过 getStore() 访问特定领域的存储
const memoryStore = await storage.getStore('memory');
const thread = await memoryStore?.getThreadById({ threadId: "..." });
```

:::warning
如果未调用 `init()`，表将不会创建，存储操作将静默失败或抛出错误。
:::

### 直接数据库和池访问

`MSSQLStore` 将 mssql 连接池公开为公共字段：

```typescript
store.pool; // mssql 连接池实例
```

这支持直接查询和自定义事务管理。使用这些字段时：

- 你负责正确的连接和事务处理。
- 关闭存储（`store.close()`）将销毁关联的连接池。
- 直接访问会绕过 MSSQLStore 方法提供的任何额外逻辑或验证。

此方法适用于需要低级访问的高级场景。
