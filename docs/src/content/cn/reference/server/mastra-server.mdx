---
title: "参考文档: MastraServer | 服务器"
description: "用于创建服务器适配器的 MastraServer 抽象类的 API 参考。"
packages:
  - "@mastra/core"
  - "@mastra/server"
---

import PropertiesTable from "@site/src/components/PropertiesTable";

# MastraServer

`MastraServer` 抽象类是所有服务器适配器的基类。扩展此类可为 Hono 或 Express 之外的框架创建适配器。

## 导入

```typescript
import { MastraServer } from '@mastra/server/server-adapter';
```

## 类型参数

```typescript
MastraServer<TApp, TRequest, TResponse>
```

| 参数 | 描述 |
|-----------|-------------|
| `TApp` | 框架应用类型（例如 `Hono`、`Application`） |
| `TRequest` | 框架请求类型 |
| `TResponse` | 框架响应/上下文类型 |

## 构造函数

```typescript
constructor(options: MastraServerOptions<TApp>)
```

### 选项

<PropertiesTable
  content={[
    {
      name: "app",
      type: "TApp",
      description: "框架应用实例",
      isOptional: false,
    },
    {
      name: "mastra",
      type: "Mastra",
      description: "Mastra 实例",
      isOptional: false,
    },
    {
      name: "prefix",
      type: "string",
      description: "路由路径前缀（例如 `/api/v2`）",
      isOptional: true,
      defaultValue: "''",
    },
    {
      name: "openapiPath",
      type: "string",
      description: "提供 OpenAPI 规范的路径",
      isOptional: true,
      defaultValue: "''",
    },
    {
      name: "bodyLimitOptions",
      type: "BodyLimitOptions",
      description: "请求体大小限制",
      isOptional: true,
    },
    {
      name: "streamOptions",
      type: "StreamOptions",
      description: "流重写配置",
      isOptional: true,
      defaultValue: "{ redact: true }",
    },
    {
      name: "customRouteAuthConfig",
      type: "Map<string, boolean>",
      description: "按路由的认证覆盖",
      isOptional: true,
    },
    {
      name: "tools",
      type: "Record<string, Tool>",
      description: "服务器可用的工具",
      isOptional: true,
    },
    {
      name: "taskStore",
      type: "InMemoryTaskStore",
      description: "用于 A2A（智能体到智能体）操作的任务存储",
      isOptional: true,
    },
    {
      name: "mcpOptions",
      type: "MCPOptions",
      description: "用于无服务器环境的 MCP 传输选项",
      isOptional: true,
    },
  ]}
/>

## 抽象方法

这些方法必须由适配器实现：

### registerContextMiddleware()

将 Mastra 上下文附加到每个请求。

```typescript
abstract registerContextMiddleware(): void
```

**要附加的上下文：**
- `mastra` - Mastra 实例
- `requestContext` - 请求作用域上下文
- `tools` - 可用工具
- `abortSignal` - 请求取消信号

### registerAuthMiddleware()

注册认证和授权中间件。

```typescript
abstract registerAuthMiddleware(): void
```

### registerRoute()

向框架注册单个路由。

```typescript
abstract registerRoute(
  app: TApp,
  route: ServerRoute,
  options: { prefix?: string }
): Promise<void>
```

### getParams()

从请求中提取参数。

```typescript
abstract getParams(
  route: ServerRoute,
  request: TRequest
): Promise<{
  urlParams: Record<string, string>;
  queryParams: Record<string, string>;
  body: unknown;
}>
```

### sendResponse()

根据路由类型发送响应。

```typescript
abstract sendResponse(
  route: ServerRoute,
  response: TResponse,
  result: unknown
): Promise<unknown>
```

### stream()

处理流式响应。

```typescript
abstract stream(
  route: ServerRoute,
  response: TResponse,
  result: unknown
): Promise<unknown>
```

## 实例方法

### init()

通过注册所有中间件和路由来初始化服务器。

```typescript
async init(): Promise<void>
```

按顺序调用：
1. `registerContextMiddleware()`
2. `registerAuthMiddleware()`
3. `registerRoutes()`

### registerRoutes()

注册所有 Mastra 路由。

```typescript
async registerRoutes(): Promise<void>
```

### getApp()

获取框架应用实例。

```typescript
getApp<T = TApp>(): T
```

### parsePathParams()

使用路由的 Zod 模式验证路径参数。

```typescript
async parsePathParams(
  route: ServerRoute,
  params: Record<string, string>
): Promise<Record<string, unknown>>
```

### parseQueryParams()

使用路由的 Zod 模式验证查询参数。

```typescript
async parseQueryParams(
  route: ServerRoute,
  params: Record<string, string>
): Promise<Record<string, unknown>>
```

### parseBody()

使用路由的 Zod 模式验证请求体。

```typescript
async parseBody(
  route: ServerRoute,
  body: unknown
): Promise<unknown>
```

### registerOpenAPIRoute()

注册提供 OpenAPI 规范的端点。

```typescript
async registerOpenAPIRoute(
  app: TApp,
  config: OpenAPIConfig,
  options: { prefix?: string }
): Promise<void>
```

## 受保护方法

### mergeRequestContext()

从多个来源（查询参数和请求体）合并请求上下文。

```typescript
protected mergeRequestContext(options: {
  paramsRequestContext?: Record<string, any>;
  bodyRequestContext?: Record<string, any>;
}): RequestContext
```

## 类型

### BodyLimitOptions

```typescript
interface BodyLimitOptions {
  maxSize: number;
  onError: (error: unknown) => unknown;
}
```

### StreamOptions

```typescript
interface StreamOptions {
  redact?: boolean;
}
```

### MCPOptions

```typescript
interface MCPOptions {
  serverless?: boolean;
  sessionIdGenerator?: () => string;
}
```

| 属性 | 描述 |
|----------|-------------|
| `serverless` | 当为 `true` 时，在无状态模式下运行 MCP，不进行会话管理。用于 Cloudflare Workers 或 Vercel Edge 等无服务器环境。 |
| `sessionIdGenerator` | 生成会话 ID 的自定义函数。 |

## 示例

```typescript
import { MastraServer, ServerRoute } from '@mastra/server/server-adapter';
import type { Mastra } from '@mastra/core';

export class MyServer extends MastraServer<MyApp, MyRequest, MyResponse> {
  registerContextMiddleware(): void {
    this.app.use('*', (req, res, next) => {
      res.locals.mastra = this.mastra;
      next();
    });
  }

  registerAuthMiddleware(): void {
    const auth = this.mastra.getServer()?.auth;
    if (!auth) return;
    // 实现认证
  }

  async registerRoute(app, route, { prefix }) {
    // 实现路由注册
  }

  async getParams(route, request) {
    return {
      urlParams: request.params,
      queryParams: request.query,
      body: request.body,
    };
  }

  async sendResponse(route, response, result) {
    return response.json(result);
  }

  async stream(route, response, result) {
    // 实现流式处理
  }
}
```

## 相关文档

- [服务器适配器](/docs/cn/docs/server/server-adapters) - 使用适配器
- [自定义适配器](/docs/cn/docs/server/custom-adapters) - 创建自定义适配器
- [createRoute()](/reference/server/create-route) - 创建自定义路由
