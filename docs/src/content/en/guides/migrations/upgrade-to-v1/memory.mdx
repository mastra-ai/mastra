---
title: "Memory | v1 Migration Guide"
description: "Learn how to migrate memory-related changes when upgrading to v1."
---

# Memory

Memory configuration now requires explicit parameters, and default settings have been updated for better performance and predictability.

## Changed

### Required configuration parameters

The Memory constructor now requires `storage`, `vector`, and `embedder` parameters. These parameters no longer have defaults. This change makes dependencies explicit and prevents unexpected behavior from implicit defaults.

To migrate, explicitly provide `storage`, `vector`, and `embedder` when creating a Memory instance.

```diff
  import { Memory } from '@mastra/memory';
+ import { LibSQLStore, LibSQLVector } from '@mastra/libsql';
+ import { fastembed } from '@mastra/fastembed';

  const memory = new Memory({
-   // storage, vector, embedder were optional with defaults
+   storage: new LibSQLStore({ url: 'file:./mastra.db' }),
+   vector: new LibSQLVector({ url: 'file:./mastra.db' }),
+   embedder: fastembed,
  });
```

### Default settings for semantic recall and last messages

Default settings have changed to more reasonable values based on usage patterns. The `lastMessages` default decreased from 40 to 10, `semanticRecall` is now disabled by default, and thread title generation is disabled by default. These changes improve performance and reduce unexpected LLM API calls.

To migrate, if you were relying on the old defaults, explicitly configure these settings.

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
+   options: {
+     lastMessages: 40, // Was default before
+     semanticRecall: {
+       topK: 2,
+       messageRange: 2,
+       scope: 'thread',
+     }, // Was enabled by default before
+     generateTitle: true, // Was enabled by default before
+   },
  });
```

### Default memory scope from `thread` to `resource`

The default scope for both working memory and semantic recall has changed from `'thread'` to `'resource'`. This change aligns with common use cases where applications want to remember user information across conversations. When semantic recall is enabled, it now defaults to searching across all user conversations rather than just the current thread.

To migrate, if you want to maintain the old behavior where memory is isolated per conversation thread, explicitly set `scope: 'thread'`.

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
      workingMemory: {
        enabled: true,
+       scope: 'thread', // Explicitly set to thread-scoped
        template: `# User Profile...`,
      },
      semanticRecall: {
        topK: 3,
+       scope: 'thread', // Explicitly set to thread-scoped
      },
    },
  });
```

### Thread title generation location

The `generateTitle` option has been moved from `threads.generateTitle` to the top-level of memory options. This change simplifies the API by moving the option to where it logically belongs.

To migrate, move `generateTitle` from the `threads` config to the top level of options.

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
-     threads: {
-       generateTitle: true,
-     },
+     generateTitle: true,
    },
  });
```

### Semantic recall default settings optimization

The default settings for semantic recall have been optimized based on RAG research. The `topK` increased from 2 to 4, and `messageRange` changed from `{before: 2, after: 2}` to `{before: 1, after: 1}`. These changes provide better accuracy while only slightly increasing message count.

To migrate, if you were relying on the previous defaults, explicitly set these values.

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
      semanticRecall: {
+       topK: 2, // Was default before
+       messageRange: { before: 2, after: 2 }, // Was default before
      },
    },
  });
```

### `Memory.query()` return format

The `Memory.query()` method now returns a simpler format with just `{ messages: MastraDBMessage[] }` instead of multiple format variations. This change simplifies the API and makes the return type more predictable.

To migrate, update code that expects the old return format to use the new format.

```diff
  const result = await memory.query({ threadId: 'thread-123' });
- // result: { messages: CoreMessage[], uiMessages: UIMessageWithMetadata[], messagesV2: MastraMessageV2[] }
+ // result: { messages: MastraDBMessage[] }
+ const messages = result.messages;
```

### `Memory.query()` parameter format

The `Memory.query()` method now uses `StorageListMessagesInput` format with pagination. This change aligns the memory query API with the storage pagination API.

To migrate, update query parameters to use the new pagination format.

```diff
  memory.query({
    threadId: 'thread-123',
-   selectBy: { ... },
+   page: 0,
+   perPage: 20,
+   orderBy: 'createdAt',
+   filter: { ... },
  });
```

### `MastraMessageV2` type renamed to `MastraDBMessage`

The `MastraMessageV2` type has been renamed to `MastraDBMessage` for clarity. This change better describes the purpose of this type as the database message format.

To migrate, replace all instances of `MastraMessageV2` with `MastraDBMessage`.

```diff
- import { MastraMessageV2 } from '@mastra/core';
- function yourCustomFunction(input: MastraMessageV2) {}
+ import { MastraDBMessage } from '@mastra/core';
+ function yourCustomFunction(input: MastraDBMessage) {}
```

### `rememberMessages` return format

The `rememberMessages` method now returns an object wrapper `{ messages }` for consistency between all memory methods. This change provides a consistent API across all memory operations.

To migrate, destructure the returned messages from the object wrapper.

```diff
- const messages = await memory.rememberMessages({ threadId, resourceId });
+ const { messages } = await memory.rememberMessages({ threadId, resourceId });
```

## Removed

### Working memory `text-stream` mode

Working memory `use: "text-stream"` option has been removed. Only `tool-call` mode is supported. This change simplifies the working memory API by removing the less reliable streaming mode.

To migrate, remove the `use: "text-stream"` option. Working memory will default to tool-call mode.

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
    options: {
      workingMemory: {
        enabled: true,
-       use: 'text-stream',
        template: '...',
      },
    },
  });
```

### `format` parameter from memory methods

The `format` parameter has been removed from all memory get methods. `MastraDBMessage` is now the default return format everywhere. AI SDK format conversion has moved to dedicated utility functions in `@mastra/ai-sdk/ui`. This change improves tree-shaking by moving UI-specific conversion code to a separate package.

To migrate, remove the `format` parameter and use conversion functions for AI SDK formats.

```diff
- const messages = await memory.getMessages({ threadId, format: 'v2' });
- const uiMessages = await memory.getMessages({ threadId, format: 'ui' });

+ const result = await memory.query({ threadId });
+ const messages = result.messages; // Always MastraDBMessage[]
+ 
+ // Use conversion functions for AI SDK formats
+ import { toAISdkV5Messages } from '@mastra/ai-sdk/ui';
+ const uiMessages = toAISdkV5Messages(messages);
```

### `MastraMessageV3` type

The `MastraMessageV3` type and related conversion methods have been removed. Messages now convert directly between `MastraMessageV2` (now `MastraDBMessage`) and AI SDK v5 formats. This change simplifies the architecture by removing an intermediary format.

To migrate, use `MastraDBMessage` for storage or AI SDK v5 message formats directly.

```diff
- import type { MastraMessageV3 } from '@mastra/core/agent';
- const v3Messages = messageList.get.all.v3();

+ // For storage
+ const v2Messages = messageList.get.all.v2();
+ 
+ // For AI SDK v5
+ const uiMessages = messageList.get.all.aiV5.ui();
+ const modelMessages = messageList.get.all.aiV5.model();
```

### `processors` config from Memory constructor

The `processors` config option in the Memory constructor has been deprecated and now throws an error. Processors should be configured at the Agent level instead. This change provides clearer configuration boundaries and better encapsulation.

To migrate, move processor configuration from Memory to Agent.

```diff
  const memory = new Memory({
    storage,
    vector,
    embedder,
-   processors: [/* ... */],
  });
  
  const agent = new Agent({
    memory,
+   processors: [/* ... */],
  });
```
