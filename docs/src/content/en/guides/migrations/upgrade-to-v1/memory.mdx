---
title: "Migration: Upgrade to Memory v1 | Migration Guide"
description: "Learn how to upgrade through breaking changes in pre-v1 versions of Mastra."
---

### Changed: Message Format

An internal intermediary format has been removed. Messages now convert directly between `MastraMessageV2` (storage format) and AI SDK v5 `UIMessage`, simplifying the architecture and improving accuracy.

**Action required only if** you have messages stored in the old `MastraMessageV1` format **and** you:

1. **Directly inspect message metadata** - `__originalContent` is no longer present
2. **Rely on exact V1 message shape preservation** - Shape may differ after conversion (content is still preserved)
3. **Have custom message processing logic** - Verify it works with the new direct conversion flow

The storage format (`MastraMessageV2`) and all public APIs remain unchanged.

### Changed: Message Format Unification

**Breaking Changes:**

1. `MastraMessageV2` type renamed to `MastraDBMessage`
2. `format` parameter removed from all get methods, `MastraDBMessage` is always the returned format, which can then be converted as needed via helper utils in `@mastra/ai-sdk`
3. MessageList `.v2()` methods renamed to `.db()`
4. AI SDK format conversion moved to `@mastra/ai-sdk/ui`

**Why these changes?**

- Provide a consistent and predictable API across all memory methods
- Clarify the purpose of message types with better naming
- Simplify the API by removing unnecessary format parameters
- Enable better tree-shaking by separating UI conversion utilities

**Migration:**

#### 1. Update Type Imports

Replace all instances of `MastraMessageV2` with `MastraDBMessage`:

```typescript
// Before
import { MastraMessageV2 } from "@mastra/core";
function yourCustomFunction(input: MastraMessageV2) {}
// After
import { MastraDBMessage } from "@mastra/core";
function yourCustomFunction(input: MastraDBMessage) {}
```

#### 2. Update Memory Method Return Types

The `rememberMessages` method now returns an object wrapper for consistency between all methods:

```typescript
// Before
const messages = await memory.rememberMessages({ threadId, resourceId });

// After
const { messages } = await memory.rememberMessages({ threadId, resourceId });
```

#### 4. Update AI SDK Format Conversion

Message format conversion for AI SDK compatibility has moved to dedicated utility functions:

```typescript
// Before
import { convertMessages } from '@mastra/core';
const uiMessages = convertMessages(messages).to('AI.V5');

// After
import { toAISdkV5Messages, toAISdkV4Messages } from '@mastra/ai-sdk/ui';

// For AI SDK v5
const v5Messages = toAISdkV5Messages(messages);

// For AI SDK v4
const v4Messages = toAISdkV4Messages(messages);
```

#### 5. Remove Format Parameters

The `format` parameter has been removed from all get methods. `MastraDBMessage` is now the default return format everywhere:

```typescript
// Before
const messages = await memory.getMessages({ threadId, format: "v2" });
const uiMessages = await memory.getMessages({ threadId, format: "ui" });

// After
const result = await memory.query({ threadId });
const messages = result.messages; // Always MastraDBMessage[]

// Use conversion functions for AI SDK formats
import { toAISdkV5Messages } from "@mastra/ai-sdk/ui";
const uiMessages = toAISdkV5Messages(messages);
```

### Changed: Memory Scope Defaults

`@mastra/memory` - `0.16.0`
`@mastra/core` - `0.22.0`

The default memory scope for both **working memory** and **semantic recall** has changed from `'thread'` to `'resource'`.

**Before:**

- Working memory defaulted to `scope: 'thread'` (isolated per conversation)
- Semantic recall defaulted to `scope: 'thread'` (search within current conversation only)

**After:**

- Working memory defaults to `scope: 'resource'` (persists across all user conversations)
- Semantic recall defaults to `scope: 'resource'` (search across all user conversations)

**Why this change?**

1. **Better user experience**: Most applications want to remember user information across conversations, not just within a single thread
2. **More intuitive default**: Users expect AI agents to "remember" them, which requires resource-scoped memory
3. **Alignment with common use cases**: The majority of production applications use resource-scoped memory

**Migration:**

If you want to maintain the old behavior where memory is isolated per conversation thread, explicitly set `scope: 'thread'` in your memory configuration:

```typescript showLineNumbers copy
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

const memory = new Memory({
  storage: new LibSQLStore({ url: "file:local.db" }),
  options: {
    workingMemory: {
      enabled: true,
      scope: "thread", // Explicitly set to thread-scoped
      template: `# User Profile
- **Name**:
- **Interests**:
`,
    },
    semanticRecall: {
      topK: 3,
      scope: "thread", // Explicitly set to thread-scoped
    },
  },
});
```

If you want to adopt the new default behavior, you can optionally remove explicit `scope: 'resource'` declarations as they're now redundant.

### Changed: Thread Title Generation Location and Default

**Breaking Changes:**

1. `generateTitle` has been moved from `threads.generateTitle` to the top-level of memory options
2. The default value has changed from `true` to `false`
3. Using `threads.generateTitle` will now throw an error

**Why these changes?**

- Simplify the API by moving `generateTitle` to the top level where it logically belongs
- Avoid unexpected LLM API calls and associated costs
- Give developers explicit control over when title generation occurs
- Improve predictability of memory behavior

**Migration:**

If your application uses `threads.generateTitle`, you must update it to use the top-level `generateTitle` option:

```typescript
// Before (v0.22 and earlier)
const agent = new Agent({
  memory: new Memory({
    options: {
      threads: {
        generateTitle: true, // ❌ This will now throw an error
      },
    },
  }),
});

// After (v0.23+)
const agent = new Agent({
  memory: new Memory({
    options: {
      generateTitle: true, // ✅ Now at the top level
    },
  }),
});
```

If your application relied on the old default behavior (automatic title generation), explicitly enable it:

```typescript
// Before (implicit true in v0.22)
const agent = new Agent({
  memory: new Memory({
    // generateTitle was true by default
  }),
});

// After (explicit true in v0.23+)
const agent = new Agent({
  memory: new Memory({
    options: {
      generateTitle: true, // Explicitly enable title generation
    },
  }),
});
```

You can also customize the model and instructions used for title generation:

```typescript
const agent = new Agent({
  memory: new Memory({
    options: {
      generateTitle: {
        model: openai("gpt-4o-mini"),
        instructions:
          "Generate a concise title (max 5 words) that summarizes the conversation",
      },
    },
  }),
});
```


### Changed: Memory Default Settings

The default settings for semantic recall have been optimized based on RAG research:

- **`topK`** increased from `2` to `4` - Retrieves 4 most relevant messages instead of 2
- **`messageRange`** changed from `{before: 2, after: 2}` to `{before: 1, after: 1}` - Includes 1 message before and after each retrieved message instead of 2

**Impact:**

When semantic recall is enabled, you'll now retrieve up to 12 messages total (4 × 3) instead of 10 messages (2 × 5). This provides ~8% better accuracy while only increasing message count by 20%.

**Action Required:**

If you were relying on the previous defaults and want to maintain the old behavior, explicitly set these values:

```typescript
const agent = new Agent({
  memory: {
    semanticRecall: {
      topK: 2,
      messageRange: { before: 2, after: 2 },
    },
  },
});
```

If you're not using semantic recall (it's disabled by default), no changes are needed.
