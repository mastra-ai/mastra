---
title: "Migration: AgentNetwork to Supervisor Pattern | Migration Guide"
description: "Learn how to migrate from AgentNetwork primitives to the supervisor pattern using .stream() in Mastra."
---

# Migrate from AgentNetwork to Supervisor Pattern

The `AgentNetwork` and `NewAgentNetwork` primitives can be migrated to the **supervisor pattern**, which uses the familiar `Agent.stream()` and `Agent.generate()` methods with enhanced delegation capabilities for better multi-agent coordination.

:::tip[Why Supervisor Pattern?]

The supervisor pattern provides:
- **Better control** - Delegation hooks, iteration hooks, and completion scoring
- **More flexible** - Modify delegations, filter context, provide feedback
- **Type-safe** - Full TypeScript support for all hooks and callbacks
- **Easier debugging** - Monitor progress with detailed callbacks
- **Memory isolation** - Full context forwarding with scoped memory saves
- **Tool approval** - Proper propagation through delegation chain

:::

## Prerequisites

### Upgrade from AI SDK v4 to v5

Bump all your model provider packages by a major version to ensure they use v5 models.

### Memory is required

Memory is required for the supervisor pattern to track conversation history and enable effective multi-agent coordination.

## Migration from `AgentNetwork`

**Before:**

```typescript
import { AgentNetwork } from "@mastra/core/network";

const agent = new AgentNetwork({
  name: "agent-network",
  agents: [agent1, agent2],
  tools: { tool1, tool2 },
  model: "openai/gpt-5.1",
  instructions:
    "You are a network agent that can help users with a variety of tasks.",
});

await agent.stream("Find me the weather in Tokyo.");
```

**After (Supervisor Pattern):**

```typescript
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";

const memory = new Memory();

// Define your sub-agents with clear, specific descriptions
const agent1 = new Agent({
  id: "weather-specialist",
  name: "Weather Specialist",
  description: "Specializes in retrieving current weather information for any location worldwide.",
  model: "openai/gpt-4o-mini",
  tools: { weatherTool },
});

const agent2 = new Agent({
  id: "travel-advisor",
  name: "Travel Advisor",
  description: "Provides travel recommendations based on weather conditions and user preferences.",
  model: "openai/gpt-4o-mini",
});

// Create supervisor agent
const supervisorAgent = new Agent({
  id: "supervisor",
  name: "Travel Supervisor",
  // Clear, specific instructions help the supervisor make better delegation decisions
  instructions: `You coordinate weather and travel information tasks.

    When users ask about weather, delegate to the weather specialist.
    When users ask about travel recommendations, delegate to the travel advisor.
    For complex requests requiring both, delegate to both agents in sequence.

    Always ensure you have complete information before responding to the user.`,
  model: "openai/gpt-5.1",
  agents: { agent1, agent2 },
  tools: { tool1, tool2 },
  memory,
});

// Use .stream() with supervisor options
const stream = await supervisorAgent.stream("Find me the weather in Tokyo.", {
  maxSteps: 10,

  // Monitor progress
  onIterationComplete: async (context) => {
    console.log(`Iteration ${context.iteration}: ${context.finishReason}`);
    return { continue: true };
  },

  // Control delegations
  delegation: {
    onDelegationStart: async (context) => {
      console.log(`Delegating to: ${context.primitiveId}`);
      return { proceed: true };
    },
  },
});

for await (const chunk of stream.textStream) {
  process.stdout.write(chunk);
}
```

## Migration from `NewAgentNetwork`

**Before:**

```typescript
import { NewAgentNetwork } from "@mastra/core/network/vnext";

const agent = new NewAgentNetwork({
  id: "agent-network",
  name: "agent-network",
  agents: { agent1, agent2 },
  workflows: { workflow1 },
  tools: { tool1, tool2 },
  model: "openai/gpt-5.1",
  instructions:
    "You are a network agent that can help users with a variety of tasks.",
});

await agent.loop("Find me the weather in Tokyo.");
```

**After (Supervisor Pattern):**

```typescript
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";

const memory = new Memory();

const supervisorAgent = new Agent({
  id: "supervisor",
  name: "Task Supervisor",
  // Detailed instructions improve delegation accuracy
  instructions: `You coordinate complex tasks using specialized agents and workflows.

    Available resources:
    - agent1: Handles research and data gathering
    - agent2: Handles analysis and recommendations
    - workflow1: Processes structured data transformations
    - tool1, tool2: Direct API integrations

    Strategy:
    1. Break down user requests into subtasks
    2. Delegate to the most appropriate resource
    3. Synthesize results into a coherent response
    4. Ensure all aspects of the request are addressed before responding`,
  model: "openai/gpt-5.1",
  agents: { agent1, agent2 },
  workflows: { workflow1 },
  tools: { tool1, tool2 },
  memory,
});

const stream = await supervisorAgent.stream("Find me the weather in Tokyo.", {
  maxSteps: 10,

  delegation: {
    // Control what context is shared with sub-agents
    contextFilter: ({ messages }) => {
      // Only pass the last 10 messages
      return messages.slice(-10);
    },
  },
});

for await (const chunk of stream.textStream) {
  process.stdout.write(chunk);
}
```

## The critical role of clear instructions

**Proper prompting and clear instructions are essential for effective supervisor pattern delegation.** The LLM uses your instructions to decide:

1. **When to delegate** - Does this task require a sub-agent?
2. **Which agent to use** - Which sub-agent is best suited for this subtask?
3. **What to pass** - What context and instructions should the sub-agent receive?
4. **When to stop** - Is the task complete, or should it continue iterating?

### Best practices for supervisor instructions

**Be specific about each sub-agent's role:**

```typescript
// ❌ Vague
instructions: "You can use agent1 or agent2 to help users."

// ✅ Specific
instructions: `You coordinate research and writing tasks.

agent1 (Research Agent): Gathers facts, data, and sources on any topic
agent2 (Writing Agent): Transforms research into well-structured articles

When users ask for information:
1. Delegate to agent1 to gather research
2. Delegate to agent2 to write the final response
3. Always ensure the response is complete before responding to the user`
```

**Define clear success criteria:**

```typescript
instructions: `...
Before completing any task:
- Verify all user questions have been answered
- Ensure data is current and accurate
- Check that the response is well-formatted
- If anything is missing or uncertain, continue iterating`
```

**Provide delegation strategy:**

```typescript
instructions: `...
Delegation strategy:
- For weather queries: Use weatherTool directly
- For travel planning: Delegate to travel-agent
- For complex itineraries: Use both weatherTool and travel-agent in sequence
- For budget analysis: Delegate to finance-workflow`
```

### Sub-agent descriptions matter too

Each sub-agent should have a clear `description` that helps the supervisor understand when to use it:

```typescript
const researchAgent = new Agent({
  id: "research-agent",
  name: "Research Agent",
  // Clear description helps supervisor make delegation decisions
  description: `Gathers concise, factual research on any topic.
    Returns bullet-point summaries with key facts and sources.
    Does not write full articles or narratives.`,
  model: "openai/gpt-4o-mini",
});
```

## Advanced features

### Iteration monitoring with feedback

Monitor progress and provide feedback to guide the agent:

```typescript
const stream = await supervisorAgent.stream("Research AI trends", {
  maxSteps: 10,

  onIterationComplete: async (context) => {
    console.log(`Iteration ${context.iteration}/${context.maxIterations}`);

    // Provide feedback to guide the agent
    if (!context.text.includes('recommendations')) {
      return {
        continue: true,
        feedback: 'Please include specific recommendations in your analysis.',
      };
    }

    return { continue: true };
  },
});
```

### Delegation control

Control and modify sub-agent delegations:

```typescript
const stream = await supervisorAgent.stream("Research AI trends", {
  maxSteps: 10,

  delegation: {
    onDelegationStart: async (context) => {
      // Add extra instructions for specific agents
      if (context.primitiveId === 'research-agent') {
        return {
          proceed: true,
          modifiedPrompt: `${context.prompt}\n\nFocus on 2024-2025 data.`,
          modifiedMaxSteps: 5,
        };
      }

      return { proceed: true };
    },

    onDelegationComplete: async (context) => {
      // Bail out on errors
      if (context.error) {
        console.error('Delegation failed:', context.error);
        context.bail();
      }
    },
  },
});
```

### Completion scoring

Automatically validate task completion:

```typescript
import { createScorer } from '@mastra/core/evals';

const taskCompleteScorer = createScorer({
  id: 'task-complete',
  name: 'Task Completeness',
}).generateScore(async (context) => {
  const text = (context.run.output || '').toString();
  return text.includes('recommendation') ? 1 : 0;
});

const stream = await supervisorAgent.stream("Research AI trends", {
  maxSteps: 10,

  completion: {
    scorers: [taskCompleteScorer],
    strategy: 'all',
    onComplete: (result) => {
      console.log('Task complete:', result.complete);
    },
  },
});
```

## Migration checklist

- [ ] Upgrade model provider packages to v5
- [ ] Replace `AgentNetwork` / `NewAgentNetwork` imports with `Agent`
- [ ] Configure memory on the supervisor agent
- [ ] **Write clear, specific instructions for the supervisor agent**
- [ ] **Add descriptive `description` fields to all sub-agents**
- [ ] Replace `.stream()` / `.loop()` calls with `agent.stream()`
- [ ] Add `maxSteps` option to limit iterations
- [ ] (Optional) Add `onIterationComplete` for progress monitoring
- [ ] (Optional) Add `delegation` hooks for sub-agent control
- [ ] (Optional) Add `completion` scorers for automatic validation
- [ ] (Optional) Add `contextFilter` to control context sharing
- [ ] Update event handling from network events to stream chunks
- [ ] **Test delegation behavior with various prompts to refine instructions**

## See also

- [Agent Networks - Supervisor Pattern](/docs/agents/networks#supervisor-pattern-comparison)
- [Agent.stream() Reference](/reference/streaming/agents/stream#supervisor-pattern-with-delegation-and-completion)
- [.network() to Supervisor Pattern Migration](./network-to-supervisor)
- [AgentNetwork to .network() Migration](./agentnetwork)
- [Supervisor Pattern Example](https://github.com/mastra-ai/mastra/tree/main/examples/supervisor-agent)
