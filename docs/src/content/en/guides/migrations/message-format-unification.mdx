---
title: "Migration: Message Format Unification | Migration Guide"
description: "Learn how to migrate to the unified message format in Mastra, including MastraDBMessage usage and API changes."
---

## Overview

As of the latest version, Mastra has unified its message format handling to provide a more consistent and predictable API. This guide will help you migrate your existing code to use the new unified message format.

## Key Changes

### 1. MastraMessageV2 â†’ MastraDBMessage

The `MastraMessageV2` type has been renamed to `MastraDBMessage` to better reflect its purpose as the database message format.

**Before:**
```typescript
import { MastraMessageV2 } from '@mastra/core';

const messages: MastraMessageV2[] = await memory.query({ threadId });
```

**After:**
```typescript
import { MastraDBMessage } from '@mastra/core';

const messages: MastraDBMessage[] = await memory.query({ threadId }).then(r => r.messages);
```

### 2. Standardized Return Types

All memory methods now return consistent object wrappers for better extensibility.

**Before:**
```typescript
// Inconsistent return types
const messages = await memory.rememberMessages({ threadId, resourceId }); // MastraDBMessage[]
const result = await memory.query({ threadId }); // { messages: MastraDBMessage[] }
```

**After:**
```typescript
// Consistent object wrapper
const remembered = await memory.rememberMessages({ threadId, resourceId }); // MastraDBMessage[]
const queried = await memory.query({ threadId }); // { messages: MastraDBMessage[] }
```

### 3. Format Parameter Removal

The `format` parameter has been removed from all get methods. `MastraDBMessage` is now the default return format everywhere.

**Before:**
```typescript
// Format parameter was used to specify return type
const messages = await memory.getMessages({ threadId, format: 'v2' });
const uiMessages = await memory.getMessages({ threadId, format: 'ui' });
```

**After:**
```typescript
// Always returns MastraDBMessage
const messages = await memory.query({ threadId }).then(r => r.messages);

// Use conversion functions for AI SDK formats
import { toAISdkV5Messages } from '@mastra/ai-sdk/ui';
const uiMessages = toAISdkV5Messages(messages);
```

### 4. MessageList API Changes

The MessageList get methods have been renamed from `.v2()` to `.db()` for clarity.

**Before:**
```typescript
const messages = messageList.get.all.v2();
const input = messageList.get.input.v2();
const response = messageList.get.response.v2();
```

**After:**
```typescript
const messages = messageList.get.all.db();
const input = messageList.get.input.db();
const response = messageList.get.response.db();
```

### 5. AI SDK Format Conversion

Message format conversion for AI SDK compatibility has been moved to dedicated utility functions.

**Before:**
```typescript
import { toAISdkFormat } from '@mastra/ai-sdk/v5';

const uiMessages = toAISdkFormat(messages);
```

**After:**
```typescript
import { toAISdkV5Messages, toAISdkV4Messages } from '@mastra/ai-sdk/ui';

// For AI SDK v5
const v5Messages = toAISdkV5Messages(messages);

// For AI SDK v4
const v4Messages = toAISdkV4Messages(messages);
```

## Migration Steps

### Step 1: Update Type Imports

Replace all instances of `MastraMessageV2` with `MastraDBMessage`:

```bash
# Find all occurrences
grep -r "MastraMessageV2" ./src

# Update imports
sed -i 's/MastraMessageV2/MastraDBMessage/g' ./src/**/*.ts
```

### Step 2: Update Memory Method Calls

Update memory method calls to handle the new return types:

```typescript
// Before
const messages = await memory.rememberMessages({ threadId, resourceId });

// After - rememberMessages still returns array directly
const messages = await memory.rememberMessages({ threadId, resourceId });

// Before
const result = await memory.query({ threadId });
const messages = result.messagesV2 || result.uiMessages;

// After - consistent property name
const result = await memory.query({ threadId });
const messages = result.messages;
```

### Step 3: Update MessageList Usage

Replace all `.v2()` calls with `.db()`:

```typescript
// Before
const allMessages = messageList.get.all.v2();
const inputMessages = messageList.get.input.v2();
const responseMessages = messageList.get.response.v2();

// After
const allMessages = messageList.get.all.db();
const inputMessages = messageList.get.input.db();
const responseMessages = messageList.get.response.db();
```

### Step 4: Update Format Conversions

Update any code that converts message formats for AI SDK usage:

```typescript
// Before
import { toAISdkFormat } from '@mastra/ai-sdk/v5';
const uiMessages = toAISdkFormat(messages);

// After
import { toAISdkV5Messages } from '@mastra/ai-sdk/ui';
const uiMessages = toAISdkV5Messages(messages);
```

### Step 5: Remove Format Parameters

Remove any `format` parameters from memory get methods:

```typescript
// Before
const messages = await memory.getMessages({ 
  threadId, 
  format: 'v2' // Remove this
});

// After
const messages = await memory.query({ threadId }).then(r => r.messages);
```

## Working with AI SDK

When integrating with AI SDK (Vercel AI SDK), use the conversion utilities from `@mastra/ai-sdk/ui`:

```typescript
import { toAISdkV5Messages, toAISdkV4Messages } from '@mastra/ai-sdk/ui';
import { MastraDBMessage } from '@mastra/core';

// Get messages from memory (always MastraDBMessage format)
const result = await memory.query({ threadId });
const dbMessages: MastraDBMessage[] = result.messages;

// Convert for AI SDK v5 usage
const v5Messages = toAISdkV5Messages(dbMessages);

// Convert for AI SDK v4 usage (if needed)
const v4Messages = toAISdkV4Messages(dbMessages);
```

## Example: Complete Migration

Here's a complete example showing the migration of a typical memory usage pattern:

**Before:**
```typescript
import { MastraMessageV2 } from '@mastra/core';
import { toAISdkFormat } from '@mastra/ai-sdk/v5';

async function getChatHistory(threadId: string) {
  // Get messages with format parameter
  const messages = await memory.getMessages({ 
    threadId, 
    format: 'v2' 
  }) as MastraMessageV2[];
  
  // Convert for UI
  const uiMessages = toAISdkFormat(messages);
  
  // Use MessageList
  const list = new MessageList();
  const allMessages = list.get.all.v2();
  
  return { messages, uiMessages, allMessages };
}
```

**After:**
```typescript
import { MastraDBMessage } from '@mastra/core';
import { toAISdkV5Messages } from '@mastra/ai-sdk/ui';

async function getChatHistory(threadId: string) {
  // Get messages without format parameter
  const result = await memory.query({ threadId });
  const messages: MastraDBMessage[] = result.messages;
  
  // Convert for UI using new utility
  const uiMessages = toAISdkV5Messages(messages);
  
  // Use MessageList with .db() method
  const list = new MessageList();
  const allMessages = list.get.all.db();
  
  return { messages, uiMessages, allMessages };
}
```

## Benefits of the New System

1. **Consistency**: All methods return predictable formats
2. **Type Safety**: Stronger TypeScript types with `MastraDBMessage`
3. **Clarity**: `.db()` methods clearly indicate database format
4. **Flexibility**: Object wrappers allow future extensibility
5. **Separation of Concerns**: UI format conversion is handled by dedicated utilities

## Troubleshooting

### Type Errors

If you encounter type errors after migration, ensure:
- All imports are updated to use `MastraDBMessage`
- Return types are properly destructured (e.g., `result.messages`)
- Conversion functions are imported from `@mastra/ai-sdk/ui`

### Missing Methods

If methods appear to be missing:
- `.v2()` methods are now `.db()`
- `toAISdkFormat` is now `toAISdkV5Messages` or `toAISdkV4Messages`
- Format parameters should be removed entirely

### Build Errors

If you encounter build errors:
- Ensure all packages are updated to the latest versions
- Clear your build cache: `rm -rf node_modules/.cache`
- Reinstall dependencies: `pnpm install`

## Need Help?

If you encounter any issues during migration, please:
1. Check the [API Reference](/reference/memory) for updated method signatures
2. Review the [examples](/examples) for working code samples
3. Open an issue on [GitHub](https://github.com/mastra-ai/mastra) with details about your migration challenge