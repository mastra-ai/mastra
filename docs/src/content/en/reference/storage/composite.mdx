---
title: "Reference: Storage Composition | Storage"
description: Documentation for combining multiple storage backends in Mastra.
---

# Storage Composition

MastraStorage can compose storage domains from different adapters. Use it when you need different databases for different purposes. For example, use LibSQL for memory and PostgreSQL for workflows.

## Installation

MastraStorage is included in `@mastra/core`:

```bash
npm install @mastra/core@beta
```

You'll also need to install the storage adapters you want to compose:

```bash
npm install @mastra/pg@beta @mastra/libsql@beta
```

## Usage

### Basic composition

Import domain classes directly from each store package and compose them:

```typescript
import { MastraStorage } from "@mastra/core/storage";
import { MemoryPG, WorkflowsPG, ScoresPG } from "@mastra/pg";
import { MemoryLibSQL } from "@mastra/libsql";
import { Mastra } from "@mastra/core";

const mastra = new Mastra({
  storage: new MastraStorage({
    id: "composite",
    domains: {
      memory: new MemoryLibSQL({ url: "file:./local.db" }),
      workflows: new WorkflowsPG({ connectionString: process.env.DATABASE_URL }),
      scores: new ScoresPG({ connectionString: process.env.DATABASE_URL }),
    },
  }),
});
```

### With a default storage

Use `default` to specify a fallback storage, then override specific domains:

```typescript
import { MastraStorage } from "@mastra/core/storage";
import { PostgresStore } from "@mastra/pg";
import { MemoryLibSQL } from "@mastra/libsql";
import { Mastra } from "@mastra/core";

const pgStore = new PostgresStore({
  id: "pg",
  connectionString: process.env.DATABASE_URL,
});

const mastra = new Mastra({
  storage: new MastraStorage({
    id: "composite",
    default: pgStore,
    domains: {
      memory: new MemoryLibSQL({ url: "file:./local.db" }),
    },
  }),
});
```

## Options

<PropertiesTable
  content={[
    {
      name: "id",
      type: "string",
      description: "Unique identifier for this storage instance.",
      isOptional: false,
    },
    {
      name: "default",
      type: "MastraStorage",
      description:
        "Default storage adapter. Domains not explicitly specified in `domains` will use this storage's domains as fallbacks.",
      isOptional: true,
    },
    {
      name: "domains",
      type: "object",
      description:
        "Individual domain overrides. Each domain can come from a different storage adapter. These take precedence over the default storage.",
      isOptional: true,
    },
    {
      name: "domains.memory",
      type: "MemoryStorage",
      description: "Storage for threads, messages, and resources.",
      isOptional: true,
    },
    {
      name: "domains.workflows",
      type: "WorkflowsStorage",
      description: "Storage for workflow snapshots.",
      isOptional: true,
    },
    {
      name: "domains.scores",
      type: "ScoresStorage",
      description: "Storage for evaluation scores.",
      isOptional: true,
    },
    {
      name: "domains.observability",
      type: "ObservabilityStorage",
      description: "Storage for traces and spans.",
      isOptional: true,
    },
    {
      name: "domains.agents",
      type: "AgentsStorage",
      description: "Storage for stored agent configurations.",
      isOptional: true,
    },
    {
      name: "disableInit",
      type: "boolean",
      description:
        "When true, automatic initialization is disabled. You must call init() explicitly.",
      isOptional: true,
    },
  ]}
/>

## Initialization

MastraStorage initializes each configured domain independently. When passed to the Mastra class, `init()` is called automatically:

```typescript
import { MastraStorage } from "@mastra/core/storage";
import { MemoryPG, WorkflowsPG, ScoresPG } from "@mastra/pg";
import { Mastra } from "@mastra/core";

const storage = new MastraStorage({
  id: "composite",
  domains: {
    memory: new MemoryPG({ connectionString: process.env.DATABASE_URL }),
    workflows: new WorkflowsPG({ connectionString: process.env.DATABASE_URL }),
    scores: new ScoresPG({ connectionString: process.env.DATABASE_URL }),
  },
});

const mastra = new Mastra({
  storage, // init() called automatically
});
```

If using storage directly, call `init()` explicitly:

```typescript
const storage = new MastraStorage({
  id: "composite",
  domains: {
    memory: new MemoryPG({ connectionString: process.env.DATABASE_URL }),
  },
});

await storage.init();

// Access domain-specific stores via getStore()
const memoryStore = await storage.getStore("memory");
const thread = await memoryStore?.getThreadById({ threadId: "..." });
```

## Use Cases

### Separate databases for different workloads

Use a local database for development while keeping production data in a managed service:

```typescript
import { MastraStorage } from "@mastra/core/storage";
import { MemoryPG, WorkflowsPG, ScoresPG } from "@mastra/pg";
import { MemoryLibSQL } from "@mastra/libsql";

const storage = new MastraStorage({
  id: "composite",
  domains: {
    // Use local SQLite for development, PostgreSQL for production
    memory:
      process.env.NODE_ENV === "development"
        ? new MemoryLibSQL({ url: "file:./dev.db" })
        : new MemoryPG({ connectionString: process.env.DATABASE_URL }),
    workflows: new WorkflowsPG({ connectionString: process.env.DATABASE_URL }),
    scores: new ScoresPG({ connectionString: process.env.DATABASE_URL }),
  },
});
```

### Specialized storage for observability

Use a time-series database for traces while keeping other data in PostgreSQL:

```typescript
import { MastraStorage } from "@mastra/core/storage";
import { MemoryPG, WorkflowsPG, ScoresPG } from "@mastra/pg";
import { ObservabilityStorageClickhouse } from "@mastra/clickhouse";

const storage = new MastraStorage({
  id: "composite",
  domains: {
    memory: new MemoryPG({ connectionString: process.env.DATABASE_URL }),
    workflows: new WorkflowsPG({ connectionString: process.env.DATABASE_URL }),
    scores: new ScoresPG({ connectionString: process.env.DATABASE_URL }),
    observability: new ObservabilityStorageClickhouse({
      url: process.env.CLICKHOUSE_URL,
    }),
  },
});
```
