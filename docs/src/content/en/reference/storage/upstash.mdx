---
title: "Reference: Upstash Storage | Storage"
description: Documentation for the Upstash storage implementation in Mastra.
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import StorageDomainsNoObservability from "./_storage-domains-no-observability.mdx";
import SchemaManagementNoObservability from "./_schema-management-no-observability.mdx";

# Upstash Storage

The Upstash storage implementation provides a serverless-friendly storage solution using Upstash's Redis-compatible key-value store.

:::warning

**Important:** When using Mastra with Upstash, the pay-as-you-go model can result in unexpectedly high costs due to the high volume of Redis commands generated during agent conversations. We strongly recommend using a **fixed pricing plan** for predictable costs. See [Upstash pricing](https://upstash.com/pricing/redis) for details and [GitHub issue #5850](https://github.com/mastra-ai/mastra/issues/5850) for context.

:::

## Installation

<Tabs>
<TabItem value="npm" label="npm">

```bash copy
npm install @mastra/upstash@beta
```

</TabItem>
<TabItem value="pnpm" label="pnpm">

```bash copy
pnpm add @mastra/upstash@beta
```

</TabItem>
<TabItem value="yarn" label="yarn">

```bash copy
yarn add @mastra/upstash@beta
```

</TabItem>
<TabItem value="bun" label="bun">

```bash copy
bun add @mastra/upstash@beta
```

</TabItem>
</Tabs>

## Usage

```typescript copy showLineNumbers
import { UpstashStore } from "@mastra/upstash";

const storage = new UpstashStore({
  id: 'upstash-storage',
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});
```

## Parameters

<PropertiesTable
  content={[
    {
      name: "id",
      type: "string",
      description: "Unique identifier for this storage instance",
      isOptional: false,
    },
    {
      name: "url",
      type: "string",
      description: "Upstash Redis REST URL",
      isOptional: false,
    },
    {
      name: "token",
      type: "string",
      description: "Upstash Redis REST authentication token",
      isOptional: false,
    },
  ]}
/>

## Storage Domains

Upstash storage supports the following domains:

<StorageDomainsNoObservability />

To access domain-specific operations, use `getStore()`:

```typescript copy
const storage = new UpstashStore({
  id: 'upstash-storage',
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

// Access memory domain for threads and messages
const memoryStore = await storage.getStore('memory');

const threads = await memoryStore.listThreadsByResourceId({
  resourceId: 'user-123',
  page: 0,
  perPage: 20,
});
  
const messages = await memoryStore.listMessages({
  threadId: 'thread-123',
  page: 0,
  perPage: 50,
});

// Access workflows domain for workflow snapshots
const workflowsStore = await storage.getStore('workflows');

const snapshot = await workflowsStore.getWorkflowSnapshot({
  workflowId: 'my-workflow',
  runId: 'run-123',
});

// Access evals domain for scores
const evalsStore = await storage.getStore('evals');

const scores = await evalsStore.listScoresByScorerId({
  scorerId: 'my-scorer',
  pagination: { page: 0, perPage: 50 },
});
```

See the [Storage overview](/docs/v1/server-db/storage) for more information about storage domains and composite storage.

## Key Structure

The Upstash storage implementation uses a structured key-value format based on table names and identifiers:

**Memory Domain:**
- **Threads**: `mastra_threads:id:{threadId}`
  - Example: `mastra_threads:id:thread_123`
- **Messages**: `mastra_messages:threadId:{threadId}:id:{messageId}`
  - Example: `mastra_messages:threadId:thread_123:id:msg_456`
- **Thread Message Index**: `thread:{threadId}:messages`
  - Sorted set used to maintain message order within a thread
  - Example: `thread:thread_123:messages`
- **Resources**: `mastra_resources:id:{resourceId}`
  - Example: `mastra_resources:id:resource_789`

**Evals Domain:**
- **Scores**: `mastra_scorers:runId:{runId}`
  - Example: `mastra_scorers:runId:run_abc123`

**Workflows Domain:**
- **Workflow Snapshots**: `mastra_workflow_snapshot:namespace:workflows:workflow_name:{workflowId}:run_id:{runId}[:resourceId:{resourceId}]`
  - Example: `mastra_workflow_snapshot:namespace:workflows:workflow_name:myWorkflow:run_id:run_xyz`
  - With resourceId: `mastra_workflow_snapshot:namespace:workflows:workflow_name:myWorkflow:run_id:run_xyz:resourceId:res_123`

**Key Format Pattern:**
All keys follow the pattern: `{tableName}:{keyPart1}:{value1}:{keyPart2}:{value2}...`