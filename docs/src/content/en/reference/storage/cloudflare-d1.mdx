---
title: "Reference: Cloudflare D1 Storage | Storage"
description: Documentation for the Cloudflare D1 SQL storage implementation in Mastra.
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import SchemaManagement from "./_schema-management.mdx";

# Cloudflare D1 Storage

The Cloudflare D1 storage implementation provides a serverless SQL database solution using Cloudflare D1, supporting relational operations and transactional consistency.

## Installation

```bash
npm install @mastra/cloudflare-d1@beta
```

## Usage

D1Store can be configured in two ways: using Workers bindings or the REST API.

<Tabs>
<TabItem value="workers" label="Workers Binding (Recommended)">

Use this approach when running in Cloudflare Workers:

```typescript copy showLineNumbers
import { D1Store } from "@mastra/cloudflare-d1";

// In your Cloudflare Worker
export default {
  async fetch(request: Request, env: { D1Database: D1Database }) {
    const storage = new D1Store({
      id: 'd1-storage',
      binding: env.D1Database,
      tablePrefix: "dev_", // Optional: isolate tables per environment
    });
    
    // Use storage...
  },
};
```

</TabItem>
<TabItem value="rest" label="REST API">

Use this approach for Node.js or other non-Workers environments:

```typescript copy showLineNumbers
import { D1Store } from "@mastra/cloudflare-d1";

const storage = new D1Store({
  id: 'd1-storage',
  accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
  databaseId: process.env.CLOUDFLARE_D1_DATABASE_ID!,
  apiToken: process.env.CLOUDFLARE_API_TOKEN!,
  tablePrefix: "dev_", // Optional: isolate tables per environment
});
```

</TabItem>
</Tabs>

And add the following to your `wrangler.toml` or `wrangler.jsonc` file:

```
[[d1_databases]]
binding = "D1Database"
database_name = "db-name"
database_id = "db-id"
```

## Parameters

<PropertiesTable
  content={[
    {
      name: "id",
      type: "string",
      description: "Unique identifier for this storage instance",
      isOptional: false,
    },
    {
      name: "binding",
      type: "D1Database",
      description: "Cloudflare D1 Workers binding (for Workers runtime). Required when using Workers Binding API.",
      isOptional: true,
    },
    {
      name: "accountId",
      type: "string",
      description: "Cloudflare Account ID (for REST API). Required when using REST API.",
      isOptional: true,
    },
    {
      name: "databaseId",
      type: "string",
      description: "Cloudflare D1 Database ID (for REST API). Required when using REST API.",
      isOptional: true,
    },
    {
      name: "apiToken",
      type: "string",
      description: "Cloudflare API Token (for REST API). Required when using REST API.",
      isOptional: true,
    },
    {
      name: "tablePrefix",
      type: "string",
      description:
        "Optional prefix for all table names (useful for environment isolation). Only letters, numbers, and underscores are allowed.",
      isOptional: true,
    },
  ]}
/>

## Storage Domains

D1Store supports the following domains:

- **`memory`** - Threads, messages, and resources
- **`evals`** - Score storage and evaluation data
- **`workflows`** - Workflow run snapshots and state

**Note:** The `observability` domain is not currently supported by D1Store. Use another storage adapter for observability features.

To access domain-specific operations, use `getStore()`:

```typescript copy
const storage = new D1Store({
  id: 'd1-storage',
  binding: env.D1Database, // or use REST API config
});

// Access memory domain for threads and messages
const memoryStore = await storage.getStore('memory');

const threads = await memoryStore.listThreads({
  resourceId: 'user-123',
  page: 0,
  perPage: 20,
});

// Access workflows domain for workflow snapshots
const workflowsStore = await storage.getStore('workflows');

const snapshot = await workflowsStore.getWorkflowSnapshot({
  workflowId: 'my-workflow',
  runId: 'run-123',
});

// Access evals domain for scores
const evalsStore = await storage.getStore('evals');

const scores = await evalsStore.listScoresByScorerId({
  scorerId: 'my-scorer',
  pagination: { page: 0, perPage: 50 },
});
```

See the [Storage overview](/docs/v1/server-db/storage) for more information about storage domains and composite storage.

<SchemaManagement />