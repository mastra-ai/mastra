---
title: "Reference: PostgreSQL Storage | Storage"
description: Documentation for the PostgreSQL storage implementation in Mastra.
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import SchemaManagement from "./_schema-management.mdx";
import UsingStorageDomains from "./_using-storage-domains.mdx";

# PostgreSQL Storage

The PostgreSQL storage implementation provides a production-ready storage solution using PostgreSQL databases.

## Installation

<Tabs>
<TabItem value="npm" label="npm">

```bash copy
npm install @mastra/pg@beta
```

</TabItem>
<TabItem value="pnpm" label="pnpm">

```bash copy
pnpm add @mastra/pg@beta
```

</TabItem>
<TabItem value="yarn" label="yarn">

```bash copy
yarn add @mastra/pg@beta
```

</TabItem>
<TabItem value="bun" label="bun">

```bash copy
bun add @mastra/pg@beta
```

</TabItem>
</Tabs>

## Usage

```typescript copy showLineNumbers
import { PostgresStore } from "@mastra/pg";

const storage = new PostgresStore({
  id: 'pg-storage',
  connectionString: process.env.DATABASE_URL,
});
```

## Parameters

<PropertiesTable
  content={[
    {
      name: "connectionString",
      type: "string",
      description:
        "PostgreSQL connection string (e.g., postgresql://user:pass@host:5432/dbname)",
      isOptional: false,
    },
    {
      name: "schemaName",
      type: "string",
      description:
        "The name of the schema you want the storage to use. Will use the default schema if not provided.",
      isOptional: true,
    },
  ]}
/>

## Instantiation

You can instantiate `PostgresStore` in the following ways:

```ts
import { PostgresStore } from "@mastra/pg";

// Using a connection string only
const store1 = new PostgresStore({
  id: 'pg-storage-1',
  connectionString: "postgresql://user:password@localhost:5432/mydb",
});

// Using a connection string with a custom schema name
const store2 = new PostgresStore({
  id: 'pg-storage-2',
  connectionString: "postgresql://user:password@localhost:5432/mydb",
  schemaName: "custom_schema", // optional
});

// Using individual connection parameters
const store4 = new PostgresStore({
  id: 'pg-storage-3',
  host: "localhost",
  port: 5432,
  database: "mydb",
  user: "user",
  password: "password",
});

// Individual parameters with schemaName
const store5 = new PostgresStore({
  id: 'pg-storage-4',
  host: "localhost",
  port: 5432,
  database: "mydb",
  user: "user",
  password: "password",
  schemaName: "custom_schema", // optional
});
```

<UsingStorageDomains />

<SchemaManagement />

## Index Management

PostgreSQL storage provides comprehensive index management capabilities to optimize query performance. Indexes are created automatically by each domain during initialization through their `createIndexes()` method.

### Automatic Performance Indexes by Domain

Each domain creates its own indexes when initialized:

**Memory Domain** (`memory`):
- `mastra_threads_resourceid_createdat_idx`: (resourceId, createdAt DESC) - Optimizes thread listing by resource
- `mastra_messages_thread_id_createdat_idx`: (thread_id, createdAt DESC) - Optimizes message retrieval by thread

**Evals Domain** (`evals`):
- `mastra_scores_trace_id_span_id_created_at_idx`: (traceId, spanId, createdAt DESC) - Optimizes score queries by trace and span

**Observability Domain** (`observability`):
- `mastra_ai_spans_traceid_startedat_idx`: (traceId, startedAt DESC) - Optimizes span queries by trace
- `mastra_ai_spans_parentspanid_startedat_idx`: (parentSpanId, startedAt DESC) - Optimizes child span queries
- `mastra_ai_spans_name_idx`: (name) - Optimizes span queries by operation name
- `mastra_ai_spans_spantype_startedat_idx`: (spanType, startedAt DESC) - Optimizes span queries by type

**Workflows Domain** (`workflows`):
- No automatic indexes created (workflow snapshots use primary key lookups)

These indexes are created automatically when each domain's `init()` method is called. Index creation failures are logged but don't prevent domain initialization, as indexes are performance optimizations.

### Direct Database and Pool Access

`PostgresStore` exposes both the underlying database object and the pg-promise instance as public fields:

```typescript
store.db; // pg-promise database instance
store.pgp; // pg-promise main instance
```

This enables direct queries and custom transaction management. When using these fields:

- You are responsible for proper connection and transaction handling.
- Closing the store (`store.close()`) will destroy the associated connection pool.
- Direct access bypasses any additional logic or validation provided by PostgresStore methods.

This approach is intended for advanced scenarios where low-level access is required.


### Creating Custom Indexes

Create additional indexes to optimize specific query patterns. The `createIndex` method is available on each domain store.

```typescript copy
import { PostgresStore } from "@mastra/pg";
import { 
  TABLE_THREADS, 
  TABLE_MESSAGES, 
  TABLE_SPANS,
  TABLE_SCORERS,
  TABLE_WORKFLOW_SNAPSHOT 
} from "@mastra/core/storage";

const storage = new PostgresStore({
  id: 'pg-storage',
  connectionString: process.env.DATABASE_URL,
});

// Access domain stores
const memoryStore = await storage.getStore('memory');
const observabilityStore = await storage.getStore('observability');

// Memory domain: Basic index for threads
await memoryStore.createIndex({
  name: "idx_threads_resource",
  table: TABLE_THREADS,
  columns: ["resourceId"],
});

// Memory domain: Composite index with sort order for messages
await memoryStore.createIndex({
  name: "idx_messages_composite",
  table: TABLE_MESSAGES,
  columns: ["thread_id", "createdAt DESC"],
});

// Observability domain: GIN index for JSONB columns (fast JSON queries)
await observabilityStore.createIndex({
  name: "idx_spans_attributes",
  table: TABLE_SPANS,
  columns: ["attributes"],
  method: "gin",
});
```

For more advanced use cases, you can also use:

- `unique: true` for unique constraints
- `where: 'condition'` for partial indexes
- `method: 'brin'` for time-series data
- `storage: { fillfactor: 90 }` for update-heavy tables
- `concurrent: true` for non-blocking creation (default)

When using custom schemas, indexes are automatically prefixed with the schema name:

```typescript copy
import { TABLE_THREADS } from "@mastra/core/storage";

const storage = new PostgresStore({
  id: 'pg-storage',
  connectionString: process.env.DATABASE_URL,
  schemaName: "custom_schema",
});

const memoryStore = await storage.getStore('memory');

// Creates index as: custom_schema_idx_threads_resource
await memoryStore.createIndex({
  name: "idx_threads_resource",
  table: TABLE_THREADS,
  columns: ["resourceId"],
});
```

### Index Options

<PropertiesTable
  content={[
    {
      name: "name",
      type: "string",
      description: "Unique name for the index",
      isOptional: false,
    },
    {
      name: "table",
      type: "TABLE_THREADS | TABLE_MESSAGES | TABLE_RESOURCES | ...",
      description: "Table constant from @mastra/core/storage (e.g., TABLE_THREADS). Type-safe and domain-specific.",
      isOptional: false,
    },
    {
      name: "columns",
      type: "string[]",
      description:
        "Array of column names with optional sort order (e.g., ['id', 'createdAt DESC'])",
      isOptional: false,
    },
    {
      name: "unique",
      type: "boolean",
      description: "Creates a unique constraint index",
      isOptional: true,
    },
    {
      name: "concurrent",
      type: "boolean",
      description: "Creates index without locking table (default: true)",
      isOptional: true,
    },
    {
      name: "where",
      type: "string",
      description: "Partial index condition (PostgreSQL specific)",
      isOptional: true,
    },
    {
      name: "method",
      type: "'btree' | 'hash' | 'gin' | 'gist' | 'spgist' | 'brin'",
      description: "Index method (default: 'btree')",
      isOptional: true,
    },
    {
      name: "opclass",
      type: "string",
      description: "Operator class for GIN/GIST indexes",
      isOptional: true,
    },
    {
      name: "storage",
      type: "Record<string, any>",
      description: "Storage parameters (e.g., { fillfactor: 90 })",
      isOptional: true,
    },
    {
      name: "tablespace",
      type: "string",
      description: "Tablespace name for index placement",
      isOptional: true,
    },
  ]}
/>

### Managing Indexes

List and monitor existing indexes using domain-specific methods:

```typescript copy
import { PostgresStore } from "@mastra/pg";
import { TABLE_THREADS, TABLE_MESSAGES } from "@mastra/core/storage";

const storage = new PostgresStore({
  id: 'pg-storage',
  connectionString: process.env.DATABASE_URL,
});

// Access domain stores
const memoryStore = await storage.getStore('memory');

// List indexes for a specific table (table parameter is required)
const threadIndexes = await memoryStore.listIndexes(TABLE_THREADS);
console.log(threadIndexes);
// [
//   {
//     name: 'mastra_threads_pkey',
//     table: 'mastra_threads',
//     columns: ['id'],
//     unique: true,
//     size: '16 KB',
//     definition: 'CREATE UNIQUE INDEX...'
//   },
//   ...
// ]

// List indexes for messages table
const messageIndexes = await memoryStore.listIndexes(TABLE_MESSAGES);

// Get detailed statistics for an index
const stats = await memoryStore.describeIndex("idx_threads_resource");
console.log(stats);
// {
//   name: 'idx_threads_resource',
//   table: 'mastra_threads',
//   columns: ['resourceId', 'createdAt'],
//   unique: false,
//   size: '128 KB',
//   definition: 'CREATE INDEX idx_threads_resource...',
//   method: 'btree',
//   scans: 1542,           // Number of index scans
//   tuples_read: 45230,    // Tuples read via index
//   tuples_fetched: 12050  // Tuples fetched via index
// }

// Drop an index
await memoryStore.dropIndex("idx_threads_resource");
```

**Note**: When using custom schemas, index names are automatically prefixed with the schema name. Pass the index name without the schema prefix (e.g., `"idx_threads_resource"` instead of `"custom_schema_idx_threads_resource"`).

### Index Types and Use Cases

PostgreSQL offers different index types optimized for specific scenarios:

| Index Type          | Best For                                | Storage    | Speed                      |
| ------------------- | --------------------------------------- | ---------- | -------------------------- |
| **btree** (default) | Range queries, sorting, general purpose | Moderate   | Fast                       |
| **hash**            | Equality comparisons only               | Small      | Very fast for `=`          |
| **gin**             | JSONB, arrays, full-text search         | Large      | Fast for contains          |
| **gist**            | Geometric data, full-text search        | Moderate   | Fast for nearest-neighbor  |
| **spgist**          | Non-balanced data, text patterns        | Small      | Fast for specific patterns |
| **brin**            | Large tables with natural ordering      | Very small | Fast for ranges            |
