import { Callout } from 'nextra/components';
import { Tag } from '@/components/tag';

# Migration Guide: Legacy to Current APIs

<Callout type="info">
  This guide covers the migration from legacy `generateLegacy()` and `streamLegacy()` methods to the current `generateLegacy()` and `streamLegacy()` methods.
</Callout>

## Overview

The legacy `generateLegacy()` and `streamLegacy()` methods in Mastra agents have been replaced by enhanced `generateLegacy()` and `streamLegacy()` methods. These new APIs offer improved capabilities, better performance, and full compatibility with AI SDK v5.

## Key Differences

### 1. Model Version Support

- **Legacy APIs (`generateLegacy`, `streamLegacy`)**: Only support V1 models
- **Current APIs (`generate`, `stream`)**: Only support V2 models

### 2. Output Format Options

- **Legacy APIs**: Limited output formatting
- **Current APIs**: Support both Mastra native format and AI SDK v5 compatibility mode via `format` option

### 3. Return Types

- **Legacy `generateLegacy()`**: Returns `GenerateTextResult` or `GenerateObjectResult`
- **Current `generateLegacy()`**: Returns the full output from `getFullOutput()` method
- **Legacy `streamLegacy()`**: Returns streaming response with callbacks
- **Current `streamLegacy()`**: Returns `MastraModelOutput` or `AISDKV5OutputStream`

## Migration Examples

### Migrating from `generateLegacy()` to `generateLegacy()`

#### Legacy `generateLegacy()` usage:
```typescript
const result = await agent.generate(messages, {
  structuredOutput: {
    schema: z.object({
      name: z.string(),
      age: z.number()
    })
  },
  temperature: 0.7,
  maxSteps: 5
});
```

#### Current `generateLegacy()` equivalent:
```typescript
const result = await agent.generate(messages, {
  structuredOutput: {
    schema: z.object({
      name: z.string(),
      age: z.number()
    })
  },
  modelSettings: {
    temperature: 0.7
  },
  maxSteps: 5
});
```

### Migrating from `streamLegacy()` to `streamLegacy()`

#### Legacy `streamLegacy()` usage:
```typescript
const streamResult = await agent.stream(messages, {
  onFinish: (result) => {
    console.log('Finished:', result);
  },
  temperature: 0.7,
  maxSteps: 5
});
```

#### Current `streamLegacy()` equivalent:
```typescript
const streamResult = await agent.stream(messages, {
  callbacks: {
    onFinish: (result) => {
      console.log('Finished:', result);
    }
  },
  modelSettings: {
    temperature: 0.7
  },
  maxSteps: 5
});
```

## Parameter Mapping

| Legacy Parameter | Current Equivalent | Notes |
|------------------|------------------|-------|
| `temperature` | `modelSettings.temperature` | Moved to nested settings object |
| `maxSteps` | `maxSteps` | Same location |
| `onFinish` | `callbacks.onFinish` | Moved to callbacks object |
| `onStepFinish` | `callbacks.onStepFinish` | Moved to callbacks object |
| `structuredOutput` | `structuredOutput` | Same location but enhanced |
| `memory` | `memory` | Same location |
| `toolChoice` | `toolChoice` | Same location |
| `providerOptions` | `providerOptions` | Same location |

## Enhanced Features in Current APIs

### 1. Format Options
The Current APIs support a `format` option that allows you to choose between Mastra's native format and AI SDK v5 compatibility:

```typescript
// Mastra native format (default)
const result = await agent.stream(messages, {
  format: 'mastra'
});

// AI SDK v5 compatibility
const result = await agent.stream(messages, {
  format: 'aisdk'
});
```

### 2. Improved Callback System
Current APIs provide a more comprehensive callback system:

```typescript
const result = await agent.stream(messages, {
  callbacks: {
    onFinish: (result) => console.log('Finished:', result),
    onStepFinish: (step) => console.log('Step finished:', step),
    onChunk: (chunk) => console.log('Chunk received:', chunk),
    onError: (error) => console.log('Error occurred:', error),
    onAbort: () => console.log('Stream aborted')
  }
});
```

### 3. Better Structured Output Handling
The `structuredOutput` parameter in Current APIs has enhanced capabilities:

```typescript
const result = await agent.generate(messages, {
  structuredOutput: {
    schema: userSchema,
    model: openai('gpt-4o'),
    errorStrategy: 'retry',
    fallbackValue: { name: 'Unknown', age: 0 }
  }
});
```

## Important Notes

1. **Model Version Check**: Current APIs will throw an error if used with V1 models. Ensure your models are V2 compatible.

2. **Return Type Differences**: The return types are different between legacy and Current APIs. Update your code to handle the new return structures.

3. **Callback Organization**: Callbacks are now organized under a `callbacks` object rather than being top-level parameters.

4. **Model Settings**: Model-specific settings like `temperature` are now grouped under `modelSettings`.

5. **Experimental Status**: These APIs are currently experimental and may change before becoming the default implementation.

## Migration Checklist

- [ ] Update model references to V2 compatible models
- [ ] Move model settings to `modelSettings` object
- [ ] Move callbacks to `callbacks` object
- [ ] Test return type handling in your application
- [ ] Update any type definitions or interfaces
- [ ] Verify structured output usage with new schema options
- [ ] Check memory configuration compatibility
- [ ] Update provider-specific options if needed

By following this guide, you should be able to smoothly transition your code from the legacy APIs to the new Current APIs.