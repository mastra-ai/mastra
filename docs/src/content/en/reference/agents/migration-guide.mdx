import { Callout } from 'nextra/components';
import { Tag } from '@/components/tag';

# Migration Guide: VNext to Standard APIs

<Callout type="info">
  This guide covers the migration from the original `generate()` and `stream()` methods (now renamed to `generateLegacy()` and `streamLegacy()`) to the new standard `generate()` and `stream()` methods (formerly `generateVNext()` and `streamVNext()`).
</Callout>

<Callout type="warning">
  **Important Naming Clarification**: 
  - The `streamVNext()` and `generateVNext()` methods have been renamed to `stream()` and `generate()` respectively. These are now the primary APIs for V2 models.
  - The original `stream()` and `generate()` methods have been renamed to `streamLegacy()` and `generateLegacy()` to maintain backward compatibility with V1 models.
  - If your code currently uses `agent.stream()` and you're getting an error about needing AI SDK v5 models, it means you need to use `agent.streamLegacy()` instead to continue using V1 models.
  - Similarly, if your code uses `agent.generate()` and encounters the same error, you should use `agent.generateLegacy()` for V1 model compatibility.
</Callout>

## Overview

The `streamVNext()` and `generateVNext()` methods in Mastra agents have been renamed to `stream()` and `generate()` respectively. These are now the standard APIs for V2 models with full AI SDK v5 compatibility. The original `stream()` and `generate()` methods have been renamed to `streamLegacy()` and `generateLegacy()` to maintain backward compatibility with V1 models.

**Deprecation Notice**: The legacy methods will be deprecated on September 23rd, 2025.

## Key Differences

### 1. Model Version Support

- **Legacy APIs (`generateLegacy`, `streamLegacy`)**: Only support V1 models
- **Current APIs (`generate`, `stream`)**: Only support V2 models

### 2. Output Format Options

- **Legacy APIs**: Limited output formatting
- **Current APIs**: Support both Mastra native format and AI SDK v5 compatibility mode via `format` option

### 3. Return Types

- **Legacy `generateLegacy()`**: Returns `GenerateTextResult` or `GenerateObjectResult`
- **Current `generate()`**: Returns the full output from `getFullOutput()` method
- **Legacy `streamLegacy()`**: Returns streaming response with callbacks
- **Current `stream()`**: Returns `MastraModelOutput` or `AISDKV5OutputStream`

## Migration Examples

### Migrating from Legacy to Standard APIs

#### Before (using legacy API):
```typescript
const result = await agent.generateLegacy(messages, {
  structuredOutput: {
    schema: z.object({
      name: z.string(),
      age: z.number()
    })
  },
  temperature: 0.7,
  maxSteps: 5
});
```

#### After (using standard API):
```typescript
const result = await agent.generate(messages, {
  structuredOutput: {
    schema: z.object({
      name: z.string(),
      age: z.number()
    })
  },
  modelSettings: {
    temperature: 0.7
  },
  maxSteps: 5
});
```

#### Before (using legacy API):
```typescript
const streamResult = await agent.streamLegacy(messages, {
  onFinish: (result) => {
    console.log('Finished:', result);
  },
  temperature: 0.7,
  maxSteps: 5
});
```

#### After (using standard API):
```typescript
const streamResult = await agent.stream(messages, {
  callbacks: {
    onFinish: (result) => {
      console.log('Finished:', result);
    }
  },
  modelSettings: {
    temperature: 0.7
  },
  maxSteps: 5
});
```

## Parameter Mapping

| Legacy Parameter | Standard Equivalent | Notes |
|------------------|------------------|-------|
| `temperature` | `modelSettings.temperature` | Moved to nested settings object |
| `maxSteps` | `maxSteps` | Same location |
| `onFinish` | `callbacks.onFinish` | Moved to callbacks object |
| `onStepFinish` | `callbacks.onStepFinish` | Moved to callbacks object |
| `structuredOutput` | `structuredOutput` | Same location but enhanced |
| `memory` | `memory` | Same location |
| `toolChoice` | `toolChoice` | Same location |
| `providerOptions` | `providerOptions` | Same location |

## Enhanced Features in Standard APIs

### 1. Format Options
The current APIs support a `format` option that allows you to choose between Mastra's native format and AI SDK v5 compatibility:

```typescript
// Mastra native format (default)
const result = await agent.stream(messages, {
  format: 'mastra'
});

// AI SDK v5 compatibility
const result = await agent.stream(messages, {
  format: 'aisdk'
});
```

### 2. Callback System
Current APIs organize callbacks in a dedicated object:

```typescript
const result = await agent.stream(messages, {
  callbacks: {
    onFinish: (result) => console.log('Finished:', result),
    onStepFinish: (step) => console.log('Step finished:', step),
    onChunk: (chunk) => console.log('Chunk received:', chunk),
    onError: (error) => console.log('Error occurred:', error),
    onAbort: () => console.log('Stream aborted')
  }
});
```

### 3. Structured Output Configuration
The `structuredOutput` parameter in current APIs includes additional options:

```typescript
const result = await agent.generate(messages, {
  structuredOutput: {
    schema: userSchema,
    model: openai('gpt-4o'),
    errorStrategy: 'retry',
    fallbackValue: { name: 'Unknown', age: 0 }
  }
});
```

## Important Notes

1. **Model Version Check**: Current APIs will throw an error if used with V1 models. Ensure your models are V2 compatible.

2. **Return Type Differences**: The return types are different between legacy and current APIs. Update your code to handle the new return structures.

3. **Callback Organization**: Callbacks are now organized under a `callbacks` object rather than being top-level parameters.

4. **Model Settings**: Model-specific settings like `temperature` are now grouped under `modelSettings`.

5. **API Status**: These APIs are now the default implementation in Mastra.

## Common Migration Scenarios

### Scenario 1: Simple Chat Application
If your application uses basic chat functionality:

```typescript
// Before
const response = await agent.generateLegacy(messages);

// After  
const response = await agent.generate(messages);
```

### Scenario 2: Application with Temperature Control
If you customize model parameters:

```typescript
// Before
const response = await agent.generateLegacy(messages, {
  temperature: 0.3
});

// After
const response = await agent.generate(messages, {
  modelSettings: {
    temperature: 0.3
  }
});
```

### Scenario 3: Streaming with Callbacks
If you use streaming with event handlers:

```typescript
// Before
const stream = await agent.streamLegacy(messages, {
  onFinish: handleFinish,
  onStepFinish: handleStep
});

// After
const stream = await agent.stream(messages, {
  callbacks: {
    onFinish: handleFinish,
    onStepFinish: handleStep
  }
});
```

## Migration Checklist

- [ ] Identify which models you're using (V1 or V2)
- [ ] Update method calls (`generate` â†’ `generateLegacy` or use new `generate` with V2 models)
- [ ] Move model settings to `modelSettings` object
- [ ] Move callbacks to `callbacks` object
- [ ] Test return type handling in your application
- [ ] Update any TypeScript type definitions or interfaces
- [ ] Verify structured output usage with new schema options
- [ ] Check memory configuration compatibility
- [ ] Update provider-specific options if needed
