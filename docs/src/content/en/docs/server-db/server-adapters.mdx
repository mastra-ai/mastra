---
title: "Server Adapters | Server & DB"
description: "Manually configure a Mastra server using Hono or Express adapters."
---

import PropertiesTable from "@site/src/components/PropertiesTable";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Server Adapters

Server adapters let you run Mastra with your own HTTP server instead of using `mastra build`. While `mastra build` generates a standalone server for you, adapters give you full control over the server setup, letting you integrate Mastra into any Node.js application.

Use adapters when you need to:

- **Integrate Mastra into an existing application** - Add Mastra endpoints to an Express or Hono app you already have running
- **Control middleware ordering** - Insert your own middleware before or after Mastra's authentication and routing
- **Deploy to platforms requiring specific server setup** - Some platforms like Cloudflare Workers or custom Docker setups need direct access to the server instance
- **Use Express instead of Hono** - `mastra build` uses Hono internally, but you may prefer Express for its ecosystem or team familiarity

:::info

For simple deployments without custom server requirements, use `mastra build` instead. It handles server setup, middleware, and deployment configuration automatically. See [Server Configuration](/docs/v1/server-db/mastra-server).

:::

## Available adapters

- **[@mastra/hono](/reference/v1/server/hono-adapter)** - Hono framework adapter
- **[@mastra/express](/reference/v1/server/express-adapter)** - Express framework adapter

## Basic setup

Both adapters follow the same pattern. The adapter wraps your framework's app instance and registers Mastra's routes and middleware onto it.

1. **Create your framework's app instance** - Initialize Hono or Express as you normally would
2. **Create a `MastraServer`** - Pass your app and Mastra instance to the adapter
3. **Call `init()`** - This registers context middleware, authentication, and all API routes

After `init()`, your app has all the Mastra endpoints (`/api/agents`, `/api/workflows`, etc.) and you can add your own routes before or after.

See the [Hono Adapter](/reference/v1/server/hono-adapter) or [Express Adapter](/reference/v1/server/express-adapter) docs for framework-specific setup and code examples.

## Constructor options

Both adapters accept the same options:

<PropertiesTable
  content={[
    {
      name: "app",
      type: "Hono | Application",
      description: "Framework app instance",
      isOptional: false,
    },
    {
      name: "mastra",
      type: "Mastra",
      description: "Mastra instance",
      isOptional: false,
    },
    {
      name: "prefix",
      type: "string",
      description: "Route path prefix (e.g., `/api/v2`)",
      isOptional: true,
      defaultValue: "''",
    },
    {
      name: "openapiPath",
      type: "string",
      description: "Path to serve OpenAPI spec (e.g., `/openapi.json`)",
      isOptional: true,
    },
    {
      name: "bodyLimitOptions",
      type: "{ maxSize: number, onError: (err) => unknown }",
      description: "Request body size limits",
      isOptional: true,
    },
    {
      name: "streamOptions",
      type: "{ redact?: boolean }",
      description: "Stream redaction config. When true, redacts sensitive data from streams.",
      isOptional: true,
      defaultValue: "{ redact: true }",
    },
    {
      name: "customRouteAuthConfig",
      type: "Map<string, boolean>",
      description: "Per-route auth overrides. Keys are `METHOD:PATH` (e.g., `GET:/api/health`). Value `false` makes route public, `true` requires auth.",
      isOptional: true,
    },
  ]}
/>

## Initialization flow

Calling `init()` runs three steps in order. Understanding this flow helps when you need to insert your own middleware at specific points.

1. **`registerContextMiddleware()`** - Attaches the Mastra instance, request context, tools, and abort signal to every request. This makes Mastra available to all subsequent middleware and route handlers.
2. **`registerAuthMiddleware()`** - Adds authentication and authorization middleware, but only if `server.auth` is configured in your Mastra instance. Skipped entirely if no auth is configured.
3. **`registerRoutes()`** - Registers all Mastra API routes for agents, workflows, and other features. Also registers MCP routes if MCP servers are configured.

### Manual initialization

For custom middleware ordering, call each method separately instead of `init()`. This is useful when you need middleware that runs before Mastra's context is set up, or when you need to insert logic between the initialization steps.

```typescript title="server.ts" copy showLineNumbers
const server = new MastraServer({ app, mastra });

// Your middleware first
app.use(loggingMiddleware);

server.registerContextMiddleware();

// Middleware that needs Mastra context
app.use(customMiddleware);

server.registerAuthMiddleware();
await server.registerRoutes();

// Routes after Mastra
app.get('/health', ...);
```

:::tip

Use manual initialization when you need middleware that runs before Mastra's context is available, or when you need to insert middleware between the context and auth steps.

:::

## Adding custom routes

You can add your own routes to the app alongside Mastra's routes. Routes added after `init()` have access to the Mastra context (the Mastra instance, request context, authenticated user, etc.) through framework-specific mechanisms.

The timing matters: routes added before `init()` won't have Mastra context available, while routes added after `init()` will. See the framework-specific docs for syntax and examples:

- [Hono: Adding custom routes](/reference/v1/server/hono-adapter#adding-custom-routes)
- [Express: Adding custom routes](/reference/v1/server/express-adapter#adding-custom-routes)

## Route prefixes

By default, Mastra routes are registered at `/api/agents`, `/api/workflows`, etc. Use the `prefix` option to change this, which is useful for API versioning or when integrating with an existing app that has its own `/api` routes.

```typescript copy showLineNumbers
const server = new MastraServer({
  app,
  mastra,
  prefix: '/api/v2',
});
```

With this prefix, Mastra routes become `/api/v2/agents`, `/api/v2/workflows`, etc. Custom routes you add directly to the app are not affected by this prefix.

## OpenAPI spec

Mastra can generate an OpenAPI specification for all registered routes. This is useful for documentation, client generation, or integration with API tools. Enable it by setting the `openapiPath` option:

```typescript copy showLineNumbers
const server = new MastraServer({
  app,
  mastra,
  openapiPath: '/openapi.json',
});
```

The spec is generated from the Zod schemas defined on each route and served at the specified path. It includes all Mastra routes as well as any custom routes created with `createRoute()`.

## Stream data redaction

When streaming agent responses over HTTP, Mastra automatically redacts sensitive information from stream chunks before sending them to clients. This prevents accidental exposure of:

- System prompts and agent instructions
- Tool definitions and their parameters
- API keys and other credentials in request bodies
- Internal configuration data

This redaction happens at the HTTP boundary, so internal callbacks like `onStepFinish` still have access to the full request data for debugging and observability purposes.

By default, redaction is enabled. Configure this behavior via `streamOptions`:

```typescript copy showLineNumbers
const server = new MastraServer({
  app,
  mastra,
  streamOptions: {
    redact: true, // Default
  },
});
```

Set `redact: false` only for internal services or debugging scenarios where you need access to the full request data in stream responses.

## Per-route auth overrides

When authentication is configured on your Mastra instance, all routes require authentication by default. Sometimes you need exceptions: public health check endpoints, webhook receivers, or admin routes that need stricter controls.

Use `customRouteAuthConfig` to override authentication behavior for specific routes:

```typescript copy showLineNumbers
const server = new MastraServer({
  app,
  mastra,
  customRouteAuthConfig: new Map([
    ['GET:/api/health', false],       // Public health check
    ['GET:/api/openapi.json', false], // Public API spec
    ['POST:/api/webhooks/*', false],  // Public webhook endpoints
    ['POST:/api/admin/reset', true],  // Require auth even if globally disabled
    ['ALL:/api/internal/*', true],    // Protect all methods on internal routes
  ]),
});
```

Keys follow the format `METHOD:PATH` where method is `GET`, `POST`, `PUT`, `DELETE`, or `ALL`. Paths support wildcards (`*`) for matching multiple routes. Setting a value to `false` makes the route public, while `true` requires authentication.

## Accessing the app

After creating the adapter, you may need to access the underlying framework app instanceâ€”for example, to pass it to a platform's serve function or to add routes programmatically from another module.

```typescript copy showLineNumbers
// Via the MastraServer instance
const app = server.getApp();

// Via the Mastra instance (available after adapter construction)
const app = mastra.getServerApp();
```

Both methods return the same app instance. Use whichever is more convenient based on what's in scope.

## Server config vs adapter options

When using server adapters, configuration comes from two places: the Mastra `server` config (passed to the `Mastra` constructor) and the adapter constructor options. Understanding which options come from where helps avoid confusion when settings don't seem to take effect.

### Used by adapters

The adapter reads these settings from `mastra.getServer()`:

| Option | Description |
|--------|-------------|
| `auth` | Authentication config, used by `registerAuthMiddleware()`. |
| `bodySizeLimit` | Default body size limit in bytes. Can be overridden per-adapter via `bodyLimitOptions`. |

### Adapter constructor only

These options are passed directly to the adapter constructor and are not read from the Mastra config:

| Option | Description |
|--------|-------------|
| `prefix` | Route path prefix |
| `openapiPath` | OpenAPI spec endpoint |
| `bodyLimitOptions` | Body size limit with custom error handler |
| `streamOptions` | Stream redaction settings |
| `customRouteAuthConfig` | Per-route auth overrides |

### Not used by adapters

These `server` config options are only used by `mastra build` and have no effect when using adapters directly:

| Option | Used by |
|--------|---------|
| `port`, `host` | `mastra dev`, `mastra build` |
| `cors` | `mastra build` adds CORS middleware |
| `timeout` | `mastra build` |
| `apiRoutes` | `registerApiRoute()` for `mastra build` |
| `middleware` | Middleware config for `mastra build` |

When using adapters, configure these features directly with your framework. For example, add CORS middleware using Hono's or Express's built-in CORS packages, and set the port when calling your framework's listen function.

## MCP support

Server adapters automatically register MCP (Model Context Protocol) routes when MCP servers are configured in your Mastra instance. MCP allows external tools and services to connect to your Mastra server and interact with your agents.

The adapter registers routes for both HTTP and SSE (Server-Sent Events) transports, enabling different client connection patterns. These routes are registered during `registerRoutes()` if MCP servers are detected in your Mastra configuration.

See [MCP](/docs/v1/mcp/overview) for configuration details and how to set up MCP servers.

## Related

- [Hono Adapter](/reference/v1/server/hono-adapter) - Hono-specific setup
- [Express Adapter](/reference/v1/server/express-adapter) - Express-specific setup
- [Custom Adapters](/docs/v1/server-db/custom-adapters) - Building adapters for other frameworks
- [Server Configuration](/docs/v1/server-db/mastra-server) - Using `mastra build` instead
- [Authentication](/docs/v1/auth) - Configuring auth for your server
- [MastraServer Reference](/reference/v1/server/mastra-server) - Full API reference
- [createRoute() Reference](/reference/v1/server/create-route) - Creating type-safe custom routes
