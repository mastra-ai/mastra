---
title: "Using with CopilotKit"
description: "Learn how Mastra leverages the CopilotKit's AGUI library and how you can leverage it to build user experiences"
---

import { Tabs } from "nextra/components";
import Image from "next/image";

# Using with CopilotKit in React

CopilotKit provides React components to quickly integrate customizable AI copilots into your application.
Combined with Mastra, you can build sophisticated AI apps featuring bidirectional state synchronization and interactive UIs.

## React Frontend Setup

Set up a CopilotKit component in your React frontend

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
</Tabs>

```tsx filename="components/CopilotKitComponent.tsx" showLineNumbers copy
'use client';
import { CopilotChat } from "@copilotkit/react-ui";
import { CopilotKit } from "@copilotkit/react-core";
import "@copilotkit/react-ui/styles.css";

export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
  return (
    <CopilotKit
      runtimeUrl={runtimeUrl}
      agent="weatherAgent"
    >
      <CopilotChat
        labels={{
          title: "Your Assistant",
          initial: "Hi! ðŸ‘‹ How can I assist you today?",
        }}
      />
    </CopilotKit>
  );
}
```

## Mastra Server Integration

This approach registers CopilotKit directly on your Mastra server, making it React framework-agnostic for your frontend.

Create Mastra project.

<Tabs items={["npx", "npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npx create-mastra@latest
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm create mastra mastra-server
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn create mastra mastra-server
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm create mastra mastra-server
    ```
  </Tabs.Tab>
</Tabs>

Install additional packages.

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
</Tabs>

Configure your Mastra instance to include CopilotKit's runtime endpoint with an optional typed runtime context:

```typescript filename="src/mastra/index.ts" showLineNumbers copy {7-12,23-41}
import { Mastra } from "@mastra/core/mastra";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";
import { registerCopilotKit } from "@ag-ui/mastra";
import { weatherAgent } from "./agents/weather-agent";

// Define your runtime context type
// This is optional, but adds typesafety
type WeatherRuntimeContext = {
  "user-id": string;
  "temperature-scale": "celsius" | "fahrenheit";
};

export const mastra = new Mastra({
  agents: { weatherAgent },
  storage: new LibSQLStore({
    url: ":memory:"
  }),
  logger: new PinoLogger({
    name: "Mastra",
    level: "info"
  }),
  server: {
    // calling from a seperate frontend app, allow CORS
    cors: {
      origin: "*",
      allowMethods: ["*"],
      allowHeaders: ["*"]
    },
    apiRoutes: [
      // optional type parameter if using a runtime context type
      registerCopilotKit<WeatherRuntimeContext>({
        path: "/copilotkit",
        resourceId: "weatherAgent",
        setContext: (c, runtimeContext) => {
          runtimeContext.set("user-id", c.req.header("X-User-ID") || "anonymous");
          runtimeContext.set("temperature-scale", "celsius");
        }
      })
    ]
  }
});
```

Start your Mastra server:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm run dev
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn dev
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm dev
    ```
  </Tabs.Tab>
</Tabs>

In your React app, use the component with your Mastra server URL:

```tsx filename="App.tsx" showLineNumbers copy {5}
import { CopilotKitComponent } from "./components/CopilotKitComponent";

function App() {
  return (
    <CopilotKitComponent runtimeUrl="http://localhost:4111/copilotkit" />
  );
}

export default App;
```

Start building the future!
<br />

<Image
  className="rounded-lg"
  src="/image/copilotkit/cpkoutput.jpg"
  alt="CopilotKit output"
  width={700}
  height={700}
/>

## An Alternative to using the Mastra Server

You can still leverage AGUI without going through the Mastra server.

### Next.js with Direct Access to Mastra Instance

This approach embeds the CopilotKit runtime in your Next.js API routes with direct access to your Mastra instance.

Install Additional Dependencies:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
</Tabs>

Create API Route:

```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,16-19,21-31}
import { mastra } from "@/mastra";
import {
  CopilotRuntime,
  ExperimentalEmptyAdapter,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { MastraAgent } from "@ag-ui/mastra";
import { NextRequest } from "next/server";

export const POST = async (req: NextRequest) => {
  // clone req if necessary
  // e.g obtaining a value from the request body
  // clone req if necessary
  // e.g obtaining a value from the request body
  // const clonedReq = req.clone();
  // const body = await clonedReq.json();

  const mastraAgents = MastraAgent.getLocalAgents({
    mastra,
    agentId: "weatherAgent",
  });

  const runtime = new CopilotRuntime({
    agents: mastraAgents,
  });

  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    serviceAdapter: new ExperimentalEmptyAdapter(),
    endpoint: "/api/copilotkit",
  });

  return handleRequest(req);
};
```

### Next.js with Remote Mastra Server and Mastra Client SDK

This approach connects to a separate Mastra server using the Mastra client SDK.

Install Additional Dependencies:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
</Tabs>

Create API Route:

```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,12-26}
import { MastraClient } from "@mastra/client-js";
import {
  CopilotRuntime,
  ExperimentalEmptyAdapter,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { MastraAgent } from "@ag-ui/mastra";
import { NextRequest } from "next/server";

export const POST = async (req: NextRequest) => {
  const baseUrl = process.env.MASTRA_BASE_URL || "http://localhost:4111";
  const mastraClient = new MastraClient({ baseUrl });

  const mastraAgents = await MastraAgent.getRemoteAgents({ mastraClient });

  const runtime = new CopilotRuntime({
    agents: mastraAgents,
  });

  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    serviceAdapter: new ExperimentalEmptyAdapter(),
    endpoint: "/api/copilotkit",
  });

  return handleRequest(req);
};
```

### Use the Component

Use the same CopilotKit component from the [React Frontend Setup](#react-frontend-setup) section, but with the local API endpoint:

```tsx filename="App.tsx" showLineNumbers copy {5}
import { CopilotKitComponent } from "./components/CopilotKitComponent";

function App() {
  return (
      <CopilotKitComponent runtimeUrl="/api/copilotkit" />
  );
}

export default App;
```

## Next Steps

- [CopilotKit Documentation](https://docs.copilotkit.ai) - Complete CopilotKit reference
- [React Hooks with CopilotKit](https://docs.copilotkit.ai/reference/hooks/useCoAgent) - Advanced React integration patterns
