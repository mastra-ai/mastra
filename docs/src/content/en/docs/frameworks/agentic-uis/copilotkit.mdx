---
title: "Using with CopilotKit"
description: "Learn how Mastra leverages the CopilotKit's AGUI library and how you can leverage it to build user experiences"
---

import { Tabs } from "nextra/components";
import Image from "next/image";

# Using with CopilotKit in React

CopilotKit provides React components to quickly integrate customizable AI copilots into your application.
Combined with Mastra, you can build sophisticated AI apps featuring bidirectional state synchronization and interactive UIs.

Visit the [CopilotKit documentation](https://docs.copilotkit.ai/) to learn more about CopilotKit.

## Core Concepts

### What is a Copilot?

A **copilot** is an AI assistant that works directly within your application, understanding your app's context and collaborating with users in real-time. Unlike traditional chatbots that operate in isolation, copilots are deeply integrated into your workflow, able to read your application state, take actions on behalf of users, and provide contextual assistance based on what's happening in your app.

### CopilotKit's Pre-built UI Components

CopilotKit provides a comprehensive suite of **ready-to-use React components** that eliminate the complexity of building AI interfaces from scratch:

- [**CopilotChat**](https://docs.copilotkit.ai/reference/components/chat/CopilotChat) - A flexible chat interface that can be embedded anywhere in your app
- [**CopilotPopup**](https://docs.copilotkit.ai/reference/components/chat/CopilotPopup) - A floating chat interface with toggle functionality  
- [**CopilotSidebar**](https://docs.copilotkit.ai/reference/components/chat/CopilotSidebar) - A collapsible sidebar chat experience
- [**CopilotTextarea**](https://docs.copilotkit.ai/reference/components/CopilotTextarea) - An AI-powered textarea with intelligent autosuggestions
- [**Headless UI hooks**](https://docs.copilotkit.ai/guides/custom-look-and-feel/customize-built-in-ui-components) - Complete customization with `useCopilotChat` and other hooks

These components handle the entire user experience, from message rendering to loading states, while remaining fully customizable to match your application's design.

### App-Integrated Actions and Context

CopilotKit copilots don't just chatâ€”they **actively participate in your application**:

- **Read Application State**: Copilots can access real-time data from your app using `useCopilotReadable`
- **Execute Actions**: Copilots can trigger functions and update your app using `useCopilotAction`
- **Frontend Actions**: Let the AI directly manipulate UI elements, update forms, or navigate between pages
- **Bidirectional State Sync**: Changes made by the copilot are immediately reflected in your UI, and vice versa

### The CopilotKit Runtime

The **CopilotKit Runtime** is the orchestration engine that powers your copilot experiences. It acts as an intelligent middleware layer that:

- **Manages Agent Communication**: Handles requests to your agent with streaming, error handling, and retries
- **Coordinates Actions**: Routes and executes both frontend and backend actions triggered by the copilot
- **Real-time Synchronization**: Ensures your UI and AI agent state stay perfectly synchronized

## Integration Approaches

This guide covers three flexible approaches to integrate CopilotKit with Mastra, each suited for different architectural needs. The difference between the three approaches is how the CopilotKit Runtime is set up:

### 1. Direct Mastra Server Integration (Recommended)

The primary approach registers CopilotKit directly on your Mastra server, creating a unified backend that serves both your AI workflows and copilot runtime. This method:

- Makes your setup **framework-agnostic** for any React frontend.
- Provides **direct access** to all Mastra agents, workflows, and context
- Offers the **simplest deployment** with a single backend service
- Enables **centralized configuration** of runtime context, workflow and agent routing

### 2. Next.js API Route with Direct Mastra Access

Perfect for **full-stack Next.js applications** where you want to embed the CopilotKit runtime directly in your API routes while maintaining direct access to your Mastra instance. This approach:

- Keeps everything in a **single Next.js codebase**
- Provides **direct access** to your Mastra configuration
- Ideal for **rapid prototyping** and **monolithic architectures**

### 3. Next.js API Route with Mastra Client SDK

Best for **distributed architectures** where your Next.js frontend connects to a separate Mastra server using the client SDK. This approach:

- Enables **a flexible architecture** with separate frontend and backend deployments
- Provides **network isolation** between your frontend and Mastra server
- Allows **multiple frontends** to connect to the same Mastra backend
- Supports **independent scaling** of frontend and backend services

We'll start with setting up the React frontend components, then walk through the Mastra server integration, followed by the Next.js alternatives for different architectural preferences.

## React Frontend Setup

Set up a CopilotKit component in your React frontend. Start with installing the required packages in your React frontend.

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
</Tabs>

We then create a `CopilotKitComponent` which takes in a `runtimeUrl` prop. This is will be the address pointing to where the CopilotKit Runtime is running.

```tsx filename="components/CopilotKitComponent.tsx" showLineNumbers copy
'use client';
import { CopilotChat } from "@copilotkit/react-ui";
import { CopilotKit } from "@copilotkit/react-core";
import "@copilotkit/react-ui/styles.css";

export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
  return (
    <CopilotKit
      runtimeUrl={runtimeUrl}
      agent="weatherAgent"
    >
      <CopilotChat
        labels={{
          title: "Your Assistant",
          initial: "Hi! ðŸ‘‹ How can I assist you today?",
        }}
      />
    </CopilotKit>
  );
}
```

## Mastra Server Integration

This approach registers CopilotKit directly on your Mastra server, making it React framework-agnostic for your frontend.

Create Mastra project.

<Tabs items={["npx", "npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npx create-mastra@latest
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm create mastra mastra-server
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn create mastra mastra-server
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm create mastra mastra-server
    ```
  </Tabs.Tab>
</Tabs>

Install additional packages.

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
</Tabs>

Configure your Mastra instance to include CopilotKit's runtime endpoint with an optional typed runtime context:

```typescript filename="src/mastra/index.ts" showLineNumbers copy {7-12,23-41}
import { Mastra } from "@mastra/core/mastra";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";
import { registerCopilotKit } from "@ag-ui/mastra";
import { weatherAgent } from "./agents/weather-agent";

// Define your runtime context type
// This is optional, but adds typesafety
type WeatherRuntimeContext = {
  "user-id": string;
  "temperature-scale": "celsius" | "fahrenheit";
};

export const mastra = new Mastra({
  agents: { weatherAgent },
  storage: new LibSQLStore({
    url: ":memory:"
  }),
  logger: new PinoLogger({
    name: "Mastra",
    level: "info"
  }),
  server: {
    // calling from a seperate frontend app, allow CORS
    cors: {
      origin: "*",
      allowMethods: ["*"],
      allowHeaders: ["*"]
    },
    apiRoutes: [
      // optional type parameter if using a runtime context type
      registerCopilotKit<WeatherRuntimeContext>({
        path: "/copilotkit",
        resourceId: "weatherAgent",
        setContext: (c, runtimeContext) => {
          runtimeContext.set("user-id", c.req.header("X-User-ID") || "anonymous");
          runtimeContext.set("temperature-scale", "celsius");
        }
      })
    ]
  }
});
```

Start your Mastra server:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm run dev
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn dev
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm dev
    ```
  </Tabs.Tab>
</Tabs>

In your React app, use the component with your Mastra server URL:

```tsx filename="App.tsx" showLineNumbers copy {5}
import { CopilotKitComponent } from "./components/CopilotKitComponent";

function App() {
  return (
    <CopilotKitComponent runtimeUrl="http://localhost:4111/copilotkit" />
  );
}

export default App;
```

Start building the future!
<br />

<Image
  className="rounded-lg"
  src="/image/copilotkit/cpkoutput.jpg"
  alt="CopilotKit output"
  width={700}
  height={700}
/>

## An Alternative to using the Mastra Server

You can still leverage AGUI without going through the Mastra server.

### Next.js with Direct Access to Mastra Instance

This approach embeds the CopilotKit runtime in your Next.js API routes with direct access to your Mastra instance.

Install Additional Dependencies:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
</Tabs>

Create API Route:

```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,16-19,21-31}
import { mastra } from "@/mastra";
import {
  CopilotRuntime,
  ExperimentalEmptyAdapter,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { MastraAgent } from "@ag-ui/mastra";
import { NextRequest } from "next/server";

export const POST = async (req: NextRequest) => {
  // clone req if necessary
  // e.g obtaining a value from the request body
  // const clonedReq = req.clone();
  // const body = await clonedReq.json();

  const mastraAgents = MastraAgent.getLocalAgents({
    mastra,
    agentId: "weatherAgent",
  });

  const runtime = new CopilotRuntime({
    agents: mastraAgents,
  });

  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    serviceAdapter: new ExperimentalEmptyAdapter(),
    endpoint: "/api/copilotkit",
  });

  return handleRequest(req);
};
```

For a full guide on how to integrate Mastra into your full-stack Next.js app, read the [Next.js integration documentation here](/docs/frameworks/web-frameworks/next-js)

### Next.js with Remote Mastra Server and Mastra Client SDK

This approach connects to a separate Mastra server using the Mastra client SDK.

Install Additional Dependencies:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
</Tabs>

Create API Route:

```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,12-26}
import { MastraClient } from "@mastra/client-js";
import {
  CopilotRuntime,
  ExperimentalEmptyAdapter,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { MastraAgent } from "@ag-ui/mastra";
import { NextRequest } from "next/server";

export const POST = async (req: NextRequest) => {
  const baseUrl = process.env.MASTRA_BASE_URL || "http://localhost:4111";
  const mastraClient = new MastraClient({ baseUrl });

  const mastraAgents = await MastraAgent.getRemoteAgents({ mastraClient });

  const runtime = new CopilotRuntime({
    agents: mastraAgents,
  });

  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    serviceAdapter: new ExperimentalEmptyAdapter(),
    endpoint: "/api/copilotkit",
  });

  return handleRequest(req);
};
```

### Use the Component

Use the same CopilotKit component from the [React Frontend Setup](#react-frontend-setup) section, but with the local API endpoint:

```tsx filename="App.tsx" showLineNumbers copy {5}
import { CopilotKitComponent } from "./components/CopilotKitComponent";

function App() {
  return (
      <CopilotKitComponent runtimeUrl="/api/copilotkit" />
  );
}

export default App;
```

## Next Steps

- [CopilotKit Documentation](https://docs.copilotkit.ai) - Complete CopilotKit reference
- [React Hooks with CopilotKit](https://docs.copilotkit.ai/reference/hooks/useCoAgent) - Advanced React integration patterns
