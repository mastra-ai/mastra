---
title: "Using with CopilotKit"
description: "Learn how Mastra leverages the CopilotKit's AGUI library and how you can leverage it to build user experiences"
---

import { Tabs, Steps } from "nextra/components";
import Image from "next/image";

# Integrate CopilotKit with Mastra

CopilotKit provides React components to quickly integrate customizable AI copilots into your application. Combined with Mastra, you can build sophisticated AI apps featuring bidirectional state synchronization and interactive UIs.

Visit the [CopilotKit documentation](https://docs.copilotkit.ai/) to learn more about CopilotKit concepts, components, and advanced usage patterns.

This guide shows three distinct integration approaches:

1. Integrate CopilotKit in your Mastra server with a separate React frontend.
2. Full-stack Next.js app with Mastra and CopilotKit integrated in an API route.
3. Next.js app with CopilotKit integrated in an API route with a remote Mastra server.

<Tabs items={["Mastra Server", "Next.js Direct", "Next.js Remote"]}>
  <Tabs.Tab>

  <Steps>
## Install React Dependencies

In your React frontend, install the required CopilotKit packages:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/react-core @copilotkit/react-ui
    ```
  </Tabs.Tab>
</Tabs>

## Create CopilotKit Component

Create a CopilotKit component in your React frontend:

```tsx filename="components/CopilotKitComponent.tsx" showLineNumbers copy
'use client';
import { CopilotChat } from "@copilotkit/react-ui";
import { CopilotKit } from "@copilotkit/react-core";
import "@copilotkit/react-ui/styles.css";

export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
  return (
    <CopilotKit
      runtimeUrl={runtimeUrl}
      agent="weatherAgent"
    >
      <CopilotChat
        labels={{
          title: "Your Assistant",
          initial: "Hi! ðŸ‘‹ How can I assist you today?",
        }}
      />
    </CopilotKit>
  );
}
```

## Install Required Dependencies in your Mastra Server

If you have not yet set up your Mastra server, follow the [getting started guide](/docs/getting-started/installation) to set up a new Mastra project.

In your Mastra server, install additional packages for CopilotKit integration:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
</Tabs>

## Configure Mastra Server

Configure your Mastra instance to include CopilotKit's runtime endpoint:

```typescript filename="src/mastra/index.ts" showLineNumbers copy {7-10,21-37}
import { Mastra } from "@mastra/core/mastra";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";
import { registerCopilotKit } from "@ag-ui/mastra";
import { weatherAgent } from "./agents/weather-agent";

type WeatherRuntimeContext = {
  "user-id": string;
  "temperature-scale": "celsius" | "fahrenheit";
};

export const mastra = new Mastra({
  agents: { weatherAgent },
  storage: new LibSQLStore({
    url: ":memory:"
  }),
  logger: new PinoLogger({
    name: "Mastra",
    level: "info"
  }),
  server: {
    cors: {
      origin: "*",
      allowMethods: ["*"],
      allowHeaders: ["*"]
    },
    apiRoutes: [
      registerCopilotKit<WeatherRuntimeContext>({
        path: "/copilotkit",
        resourceId: "weatherAgent",
        setContext: (c, runtimeContext) => {
          runtimeContext.set("user-id", c.req.header("X-User-ID") || "anonymous");
          runtimeContext.set("temperature-scale", "celsius");
        }
      })
    ]
  }
});
```

## Use Component in React App

Use the component in your React app with your Mastra server URL:

```tsx filename="App.tsx" showLineNumbers copy {5}
import { CopilotKitComponent } from "./components/CopilotKitComponent";

function App() {
  return (
    <CopilotKitComponent runtimeUrl="http://localhost:4111/copilotkit" />
  );
}

export default App;
```

  </Steps>
  </Tabs.Tab>
  
  <Tabs.Tab>

  <Steps>
  ## Install Dependencies

In your Next.js app, install the required packages:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
    ```
  </Tabs.Tab>
</Tabs>

## Create CopilotKit Component [#full-stack-nextjs-create-copilotkit-component]

Create a CopilotKit component:

```tsx filename="components/CopilotKitComponent.tsx" showLineNumbers copy
'use client';
import { CopilotChat } from "@copilotkit/react-ui";
import { CopilotKit } from "@copilotkit/react-core";
import "@copilotkit/react-ui/styles.css";

export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
  return (
    <CopilotKit
      runtimeUrl={runtimeUrl}
      agent="weatherAgent"
    >
      <CopilotChat
        labels={{
          title: "Your Assistant",
          initial: "Hi! ðŸ‘‹ How can I assist you today?",
        }}
      />
    </CopilotKit>
  );
}
```

## Create API Route

Create an API route with direct access to your Mastra instance:

```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,11-26}
import { mastra } from "@/mastra";
import {
  CopilotRuntime,
  ExperimentalEmptyAdapter,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { MastraAgent } from "@ag-ui/mastra";
import { NextRequest } from "next/server";

export const POST = async (req: NextRequest) => {
  const mastraAgents = MastraAgent.getLocalAgents({
    mastra,
    agentId: "weatherAgent",
  });

  const runtime = new CopilotRuntime({
    agents: mastraAgents,
  });

  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    serviceAdapter: new ExperimentalEmptyAdapter(),
    endpoint: "/api/copilotkit",
  });

  return handleRequest(req);
};
```

## Use Component

Use the component with the local API endpoint:

```tsx filename="App.tsx" showLineNumbers copy {5}
import { CopilotKitComponent } from "./components/CopilotKitComponent";

function App() {
  return (
    <CopilotKitComponent runtimeUrl="/api/copilotkit" />
  );
}

export default App;
```

  </Steps>
  </Tabs.Tab>
  
  <Tabs.Tab>

  <Steps>
  ## Install Dependencies

Install the required CopilotKit packages in your Next.js frontend:

<Tabs items={["npm", "yarn", "pnpm"]}>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    npm install @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    yarn add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```bash copy filename="terminal"
    pnpm add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra @mastra/client-js
    ```
  </Tabs.Tab>
</Tabs>

## Create CopilotKit Component [#next-js-remote-mastra-create-copilotkit-component]

Create a CopilotKit component in your Next.js app:

```tsx filename="components/CopilotKitComponent.tsx" showLineNumbers copy
'use client';
import { CopilotChat } from "@copilotkit/react-ui";
import { CopilotKit } from "@copilotkit/react-core";
import "@copilotkit/react-ui/styles.css";

export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
  return (
    <CopilotKit
      runtimeUrl={runtimeUrl}
      agent="weatherAgent"
    >
      <CopilotChat
        labels={{
          title: "Your Assistant",
          initial: "Hi! ðŸ‘‹ How can I assist you today?",
        }}
      />
    </CopilotKit>
  );
}
```

## Create API Route [#next-js-remote-mastra-create-api-route]

Create an API route that connects to a remote Mastra server:

```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,12-26}
import { MastraClient } from "@mastra/client-js";
import {
  CopilotRuntime,
  ExperimentalEmptyAdapter,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { MastraAgent } from "@ag-ui/mastra";
import { NextRequest } from "next/server";

export const POST = async (req: NextRequest) => {
  const baseUrl = process.env.MASTRA_BASE_URL || "http://localhost:4111";
  const mastraClient = new MastraClient({ baseUrl });

  const mastraAgents = await MastraAgent.getRemoteAgents({ mastraClient });

  const runtime = new CopilotRuntime({
    agents: mastraAgents,
  });

  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    serviceAdapter: new ExperimentalEmptyAdapter(),
    endpoint: "/api/copilotkit",
  });

  return handleRequest(req);
};
```

## Use Component [#next-js-remote-mastra-use-component]

Use the component with the local API endpoint:

```tsx filename="App.tsx" showLineNumbers copy {5}
import { CopilotKitComponent } from "./components/CopilotKitComponent";

function App() {
  return (
    <CopilotKitComponent runtimeUrl="/api/copilotkit" />
  );
}

export default App;
```

  </Steps>
  </Tabs.Tab>
</Tabs>

Start building the future!

<br />

<Image
  className="rounded-lg"
  src="/image/copilotkit/cpkoutput.jpg"
  alt="CopilotKit output"
  width={700}
  height={700}
/>

## Next Steps

- [CopilotKit Documentation](https://docs.copilotkit.ai) - Complete CopilotKit reference
- [React Hooks with CopilotKit](https://docs.copilotkit.ai/reference/hooks/useCoAgent) - Advanced React integration patterns
- [Next.js Integration with Mastra](/docs/frameworks/web-frameworks/next-js) - Full-stack Next.js setup guide
