---
title: "Agent Memory | Agents | Mastra Docs"
description: Learn how to add memory to agents to store conversation history and maintain context across interactions.
---

import { Callout } from "nextra/components";

# Agent Memory

Agents can use memory to store conversation history, recall relevant information, and maintain context across interactions. This enables more natural, stateful conversations throughout a user’s session.

## When to use memory

Use memory when an agent needs to retain information across multiple user interactions. This includes recalling user-specific details, facts, or tool calls and their results. Without memory, the agent handles each request in isolation, with no awareness of previous messages or responses.

For more information about the different ways memory works in Mastra see the following pages.

- [Working Memory](../memory/working-memory.mdx)
- [Semantic Recall](../memory/semantic-recall.mdx)

## Prerequisites

Memory requires a storage provider to persist conversation history, including user messages and agent responses. You can use **shared storage** to define a single provider for all agents, or **dedicated storage** to configure separate providers for individual agents.

Install `@mastra/memory` and a storage provider.

```bash npm2yarn copy
npm install @mastra/memory@latest @mastra/libsql@latest
```

### Storage providers

Mastra supports multiple storage providers. Popular options include:

- [LibSQL](../../reference/storage/libsql.mdx)
- [PostgreSQL](../../reference/storage/postgresql.mdx)
- [Cloudflare D1](../../reference/storage/cloudflare-d1.mdx)

<Callout type="warning">
`LibSQLStore` works well for local development and when deploying to [Mastra Cloud](../mastra-cloud/overview.mdx), but may not be supported by some [serverless platforms](../deployment/serverless-platforms) or [cloud providers](../deployment/cloud-providers).
</Callout>

### Shared storage

Use shared storage for a simple, centralized setup across agents. Add the storage adapter to your main Mastra instance to make it available to all agents by default.

```typescript {6-8} filename="src/mastra/index.ts" showLineNumbers copy
import { Mastra } from "@mastra/core/mastra";
import { LibSQLStore } from "@mastra/libsql";

export const mastra = new Mastra({
  // ..
  storage: new LibSQLStore({
    url: ":memory:"
  }),
});
```

### Dedicated storage

Use dedicated storage when agents need to keep data separate, use different providers, or tailor storage requirements for specific users. Add the storage adapter directly to the agent’s `memory` configuration option.

```typescript {7-10} filename="src/mastra/agents/memory-agent.ts" showLineNumbers copy
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const memoryAgent = new Agent({
  // ...
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:../../memory-agent.db"
    })
  })
});
```

## Memory in agent calls

When calling `.generate()` or `.stream()`, include a `memory` object with both `resource` and `thread` to enable memory.

- `resource`: A stable identifier for the user or entity.
- `thread`: An ID that isolates a specific conversation or session.

These fields tell the agent where to store and retrieve context, enabling persistent, thread-aware memory across interactions.

```typescript {3-4}
const response = await memoryAgent.generate("Remember my favorite color is blue.", {
  memory: {
    thread: "user-123",
    resource: "test-123"
  }
});
```

To recall information stored in memory, call the agent with the same `resource` and `thread` values used in the original interaction.

```typescript {3-4}
const response = await memoryAgent.generate("What's my favorite color?", {
  memory: {
    thread: "user-123",
    resource: "test-123"
  }
});
```

## Using `RuntimeContext`

Use `RuntimeContext` to access request-specific values. This lets you conditionally select different memory or storage configurations based on the context of the request.

```typescript filename="src/mastra/agents/memory-agent.ts" showLineNumbers
export type UserTier = {
  "user-tier": "enterprise" | "pro";
};

const premiumMemory = new Memory({
 // ...
});

const standardMemory = new Memory({
  // ...
});

export const memoryAgent = new Agent({
  // ...
  memory: ({ runtimeContext }) => {
    const userTier = runtimeContext.get("user-tier") as UserTier["user-tier"];

    return userTier === "enterprise"
      ? premiumMemory
      : standardMemory;
  }
});
```

## Related

- [Working Memory](../memory/working-memory.mdx)
- [Semantic Recall](../memory/semantic-recall.mdx)
- [Threads and Resources](../memory/threads-and-resources.mdx)
- [Runtime Context](../server-db/runtime-context.mdx)
