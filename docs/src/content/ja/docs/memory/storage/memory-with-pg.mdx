---
title: "例: PostgreSQL を使ったメモリ | Memory | Mastra ドキュメント"
description: Mastra のメモリシステムを、PostgreSQL のストレージとベクター機能で利用する方法の例。
---

# PostgreSQL を使ったメモリ

この例では、Mastra のメモリシステムで PostgreSQL をストレージのバックエンドとして使用する方法を紹介します。

## 前提条件

この例では `openai` モデルを使用し、`pgvector` 拡張機能を有効にした PostgreSQL データベースが必要です。`.env` ファイルに次の内容を追加してください:

```bash filename=".env" copy
OPENAI_API_KEY=<your-api-key>
DATABASE_URL=<your-connection-string>
```

次のパッケージをインストールします：

```bash copy
npm install @mastra/pg
```


## エージェントにメモリを追加する

エージェントに PostgreSQL メモリを追加するには、`Memory` クラスを使用し、`PostgresStore` で新しい `storage` キーを作成します。`connectionString` にはリモートの接続先またはローカルのデータベース接続を指定できます。

```typescript filename="src/mastra/agents/example-pg-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { PostgresStore } from "@mastra/pg";

export const pgAgent = new Agent({
  name: "pg-agent",
  instructions: "あなたは過去のやり取りから記憶を自動的に呼び出すことができるAIエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new PostgresStore({
      connectionString: process.env.DATABASE_URL!
    }),
    options: {
      generateTitle: true  // 自動タイトル生成を明示的に有効にする
    }
  })
});
```


## fastembed を使ったローカル埋め込み

埋め込みは、memory の `semanticRecall` がキーワードではなく意味に基づいて関連メッセージを検索する際に用いられる数値ベクトルです。このセットアップでは、ベクトル埋め込みを生成するために `@mastra/fastembed` を使用します。

まずは `fastembed` をインストールしましょう:

```bash copy
npm install @mastra/fastembed
```

次の内容をエージェントに追加してください:

```typescript filename="src/mastra/agents/example-pg-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { PostgresStore, PgVector } from "@mastra/pg";
import { fastembed } from "@mastra/fastembed";

export const pgAgent = new Agent({
  name: "pg-agent",
  instructions: "あなたは過去のやり取りから記憶を自動的に呼び出すことができるAIエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new PostgresStore({
      connectionString: process.env.DATABASE_URL!
    }),
    vector: new PgVector({
      connectionString: process.env.DATABASE_URL!
    }),
    embedder: fastembed,
    options: {
      lastMessages: 10,
      semanticRecall: {
        topK: 3,
        messageRange: 2
      }
    }
  })
});
```


## 使用例

このリクエストでのリコール範囲を設定するには `memoryOptions` を使用します。`lastMessages: 5` を指定して新しさに基づくリコールを制限し、`semanticRecall` を使って、各一致の前後関係として `messageRange: 2` 件の隣接メッセージを含めながら、最も関連性の高い `topK: 3` 件のメッセージを取得します。

```typescript filename="src/test-pg-agent.ts" showLineNumbers copy
import "dotenv/config";

import { mastra } from "./mastra";

const threadId = "123";
const resourceId = "user-456";

const agent = mastra.getAgent("pgAgent");

const message = await agent.stream("私の名前はMastraです", {
  memory: {
    thread: threadId,
    resource: resourceId
  }
});

await message.textStream.pipeTo(new WritableStream());

const stream = await agent.stream("私の名前は何ですか?", {
  memory: {
    thread: threadId,
    resource: resourceId
  },
  memoryOptions: {
    lastMessages: 5,
    semanticRecall: {
      topK: 3,
      messageRange: 2
    }
  }
});

for await (const chunk of stream.textStream) {
  process.stdout.write(chunk);
}
```


## 関連項目

- [エージェントの呼び出し](../agents/calling-agents.mdx)