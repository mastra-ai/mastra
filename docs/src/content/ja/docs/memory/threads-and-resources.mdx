---
title: "メモリのスレッドとリソース | メモリ | Mastra ドキュメント"
description: "Mastra のメモリシステムが、作業メモリ、会話履歴、セマンティックリコールによってどのように機能するかを解説します。"
---

import { Callout } from "nextra/components";


# メモリのスレッドとリソース

Mastra はメモリをスレッドとして整理します。スレッドは関連するやり取りをまとめた記録で、次の2つの識別子を使用します。

1. **`thread`**: 会話を表すグローバルに一意な ID（例: `support_123`）。すべてのリソースをまたいで一意である必要があります。
2. **`resource`**: スレッドの所有者であるユーザーまたはエンティティ（例: `user_123`, `org_456`）。

`resource` は特に[リソーススコープのメモリ](./working-memory.mdx#resource-scoped-memory)において重要で、同じユーザーまたはエンティティに関連するすべてのスレッド間でメモリを永続化できます。

```typescript {4} showLineNumbers
const stream = await agent.stream("エージェントへのメッセージ", {
  memory: {
    thread: "user-123",
    resource: "test-123"
  }
});
```

<Callout type="warning">
  メモリを設定していても、`thread` と `resource` の両方が指定されない限り、エージェントは情報を保存したり参照したりしません。
</Callout>

> Mastra Playground は `thread` と `resource` の ID を自動で設定します。独自のアプリケーションでは、各 `.generate()` または `.stream()` 呼び出しで手動指定する必要があります。


### スレッドタイトルの生成

Mastra は、ユーザーの最初のメッセージに基づいてわかりやすいスレッドタイトルを自動生成できます。この機能は初期設定では無効です。`generateTitle` を `true` に設定して有効にしてください。これにより整理がしやすくなり、UI 上で会話を表示しやすくなります。

```typescript {3-7} showLineNumbers
export const testAgent = new Agent({
  memory: new Memory({
    options: {
      generateTitle: true,  // 自動タイトル生成を明示的に有効にする
    },
  })
});
```

> タイトル生成はエージェントの応答後に非同期で実行され、応答時間には影響しません。詳細や例については、[設定の完全なリファレンス](../../reference/memory/Memory.mdx#thread-title-generation)を参照してください。


#### タイトル生成の最適化

タイトルは既定でエージェントのモデルを使って生成されます。コストや振る舞いを最適化するには、より小さい `model` とカスタムの `instructions` を指定してください。これにより、タイトル生成をメインの会話ロジックと切り離せます。

```typescript {5-9} showLineNumbers
export const testAgent = new Agent({
  // ...
  memory: new Memory({
    options: {
      threads: {
        generateTitle: {
          model: openai("gpt-4.1-nano"),
          instructions: "ユーザーの最初のメッセージに基づいて簡潔なタイトルを生成してください",
        },
      },
    }
  })
});
```


#### 動的なモデル選択と指示

`model` と `instructions` に関数を渡すことで、スレッドタイトルの生成を動的に設定できます。これらの関数は `runtimeContext` オブジェクトを受け取り、ユーザー固有の値に応じてタイトル生成を調整できます。

```typescript {7-16} showLineNumbers
export const testAgent = new Agent({
  // ...
  memory: new Memory({
    options: {
      threads: {
        generateTitle: {
          model: ({ runtimeContext }) => {
            const userTier = runtimeContext.get("userTier");
            return userTier === "premium" ? openai("gpt-4.1") : openai("gpt-4.1-nano");
          },
          instructions: ({ runtimeContext }) => {
            const language = runtimeContext.get("userLanguage") || "日本語";
            return `ユーザーの最初のメッセージに基づいて、${language}で簡潔で魅力的なタイトルを生成してください。`;
          }
        }
      }
    }
  })
});
```
