---
title: "Inngest ワークフロー | Workflows | Mastra Docs"
description: "Inngest のワークフローで Mastra のワークフローを実行できます"
---

# Inngest ワークフロー

[Inngest](https://www.inngest.com/docs) は、インフラの管理なしにバックグラウンドワークフローを構築し、実行できる開発者向けプラットフォームです。

## Inngest と Mastra が連携する仕組み

Inngest と Mastra は、ワークフローのモデルをそろえる形で統合されています。Inngest はロジックをステップで構成された関数として整理し、Mastra のワークフローは `createWorkflow` と `createStep` で定義され、このパラダイムにそのまま対応します。各 Mastra ワークフローは固有の識別子を持つ Inngest の関数となり、ワークフロー内の各ステップは Inngest のステップに対応づけられます。

`serve` 関数は、Mastra のワークフローを Inngest の関数として登録し、実行と監視に必要なイベントハンドラを設定することで、両システムをつなぎます。

イベントによってワークフローが起動されると、Inngest はステップごとに実行し、各ステップの結果をメモ化します。つまり、ワークフローが再試行または再開された場合は、完了済みのステップをスキップし、効率的かつ信頼性の高い実行を実現します。Mastra の制御フローのプリミティブ（ループ、条件分岐、ネストしたワークフローなど）は、Inngest の関数/ステップモデルにシームレスに変換され、合成、分岐、一時停止といった高度なワークフロー機能が保たれます。

リアルタイム監視、サスペンド/レジューム、ステップ単位のオブザーバビリティは、Inngest の publish-subscribe システムとダッシュボードによって実現されます。各ステップの実行時には、その状態と出力が Mastra のストレージで追跡され、必要に応じて再開できます。

## セットアップ

```sh
npm install @mastra/inngest @mastra/core @mastra/deployer
```


## Inngest ワークフローの構築

このガイドでは、Inngest と Mastra を使ってワークフローを作成する方法を、値が 10 に達するまでカウントを増やすカウンターアプリの例で紹介します。

### Inngest の初期化

Inngest 連携を初期化して、Mastra 互換のワークフロー用ヘルパーを取得します。createWorkflow と createStep 関数は、Mastra および Inngest と互換性のあるワークフローとステップのオブジェクトを作成するために使用します。

開発中

```ts showLineNumbers copy filename="src/mastra/inngest/index.ts"
import { Inngest } from "inngest";
import { realtimeMiddleware } from "@inngest/realtime";

export const inngest = new Inngest({
  id: "mastra",
  baseUrl:"http://localhost:8288",
  isDev: true,
  middleware: [realtimeMiddleware()],
});
```

本番環境で稼働中

```ts showLineNumbers copy filename="src/mastra/inngest/index.ts"
import { Inngest } from "inngest";
import { realtimeMiddleware } from "@inngest/realtime";

export const inngest = new Inngest({
  id: "mastra",
  middleware: [realtimeMiddleware()],
});
```


### ステップの作成

ワークフローを構成する各ステップを定義します。

```ts showLineNumbers copy filename="src/mastra/workflows/index.ts"
import { z } from "zod";
import { inngest } from "../inngest";
import { init } from "@mastra/inngest";

// Mastra と併用して Inngest を初期化し、ローカルの Inngest サーバーを参照するように設定します
const { createWorkflow, createStep } = init(inngest);

// ステップ: カウンターの値を1増やす
const incrementStep = createStep({
  id: "increment",
  inputSchema: z.object({
    value: z.number(),
  }),
  outputSchema: z.object({
    value: z.number(),
  }),
  execute: async ({ inputData }) => {
    return { value: inputData.value + 1 };
  },
});
```


### ワークフローの作成

`dountil` ループパターンを使って、手順をワークフローに組み立てます。createWorkflow 関数は、Inngest サーバー上で呼び出せる関数を作成します。

```ts showLineNumbers copy filename="src/mastra/workflows/index.ts"
// Inngest サーバー上で関数として登録されるワークフロー
const workflow = createWorkflow({
  id: "increment-workflow",
  inputSchema: z.object({
    value: z.number(),
  }),
  outputSchema: z.object({
    value: z.number(),
  }),
}).then(incrementStep);

workflow.commit();

export { workflow as incrementWorkflow };
```


### Mastra インスタンスの設定とワークフローの実行

ワークフローを Mastra に登録し、Inngest の API エンドポイントを設定します：

```ts showLineNumbers copy filename="src/mastra/index.ts"
import { Mastra } from "@mastra/core/mastra";
import { serve as inngestServe } from "@mastra/inngest";
import { incrementWorkflow } from "./workflows";
import { inngest } from "./inngest";
import { PinoLogger } from "@mastra/loggers";

// ワークフローと Inngest の API エンドポイントを使って Mastra を設定します
export const mastra = new Mastra({
  workflows: {
    incrementWorkflow,
  },
  server: {
    // サーバー設定は、ローカルの Docker コンテナが mastra サーバーに接続できるようにするために必須です
    host: "0.0.0.0",
    apiRoutes: [
      // この API ルートは、inngest サーバー上に Mastra のワークフロー（inngest 関数）を登録するために使用されます
      {
        path: "/api/inngest",
        method: "ALL",
        createHandler: async ({ mastra }) => inngestServe({ mastra, inngest }),
        // inngestServe 関数は、以下の方法で Mastra のワークフローを Inngest と統合します:
        // 1. 各ワークフローに対し、固有の ID（workflow.${workflowId}）を持つ Inngest 関数を作成する
        // 2. 次の処理を行うイベントハンドラーを設定する:
        //    - 各ワークフロー実行ごとに固有の実行 ID を生成する
        //    - ステップ実行を管理する InngestExecutionEngine を作成する
        //    - ワークフローの状態の永続化とリアルタイム更新を処理する
        // 3. リアルタイム監視のための publish–subscribe システムを確立する
        //    workflow:${workflowId}:${runId} チャンネル経由で
        //
        // 任意: ワークフローと併せて提供する追加の Inngest 関数を渡すこともできます:
        // createHandler: async ({ mastra }) => inngestServe({
        //   mastra,
        //   inngest,
        //   functions: [customFunction1, customFunction2] // ユーザー定義の Inngest 関数
        // }),
      },
    ],
  },
  logger: new PinoLogger({
    name: "Mastra",
    level: "info",
  }),
});
```


### ワークフローをローカルで実行する

> **前提条件:**
>
> * Docker がインストールされ、起動していること
> * Mastra プロジェクトがセットアップ済みであること
> * 依存関係がインストール済みであること（`npm install`）

1. `npx mastra dev` を実行して、ローカルで Mastra サーバーを起動し、ポート 4111 で待ち受けます。
2. Inngest Dev Server を起動（Docker 経由）
   新しいターミナルで次を実行します:

```sh
docker run --rm -p 8288:8288 \
  inngest/inngest \
  inngest dev -u http://host.docker.internal:4111/api/inngest
```

> 注意: `-u` の後ろの URL は、Inngest の開発サーバーに Mastra の `/api/inngest` エンドポイントの場所を指示します。

3. Inngest ダッシュボードを開く

* ブラウザで [http://localhost:8288](http://localhost:8288) にアクセスします。
* サイドバーの **Apps** セクションに移動します。
* Mastra のワークフローが登録されているはずです。
  ![Inngest Dashboard](/inngest-apps-dashboard.png)

4. ワークフローを実行する

* サイドバーの **Functions** セクションに移動します。
* Mastra のワークフローを選択します。
* **Invoke** をクリックし、次の入力を使用します。

```json
{
  "data": {
    "inputData": {
      "value": 5
    }
  }
}
```

![Inngest Function](/inngest-function-dashboard.png)

5. **ワークフローの実行を監視する**

* サイドバーの**Runs**タブを開きます。
* 最新の実行をクリックして、各ステップの進行状況を確認します。
  ![Inngest Function Run](/inngest-runs-dashboard.png)


### 本番環境でワークフローを実行する

> **前提条件:**
>
> * Vercel アカウントと Vercel CLI がインストールされていること（`npm i -g vercel`）
> * Inngest アカウント
> * Vercel トークン（推奨: 環境変数として設定）

1. Mastra インスタンスに Vercel Deployer を追加する

```ts showLineNumbers copy filename="src/mastra/index.ts"
import { VercelDeployer } from "@mastra/deployer-vercel";

export const mastra = new Mastra({
  // ...その他の設定
  deployer: new VercelDeployer({
    teamSlug: "your_team_slug",
    projectName: "your_project_name",
    // 右上のユーザーアイコンをクリックし、「Account Settings」を開いて左サイドバーの「Tokens」を選ぶと、Vercel トークンを取得できます
    // その後に「Account Settings」をクリックし、左サイドバーの「Tokens」をクリックします。
    token: "your_vercel_token",
  }),
});
```

> **注記:** 環境に Vercel のトークンを設定します:
>
> ```sh
> export VERCEL_TOKEN=your_vercel_token
> ```

2. mastra インスタンスをビルドする

```sh
npx mastra build
```

3. Vercel へデプロイする

```sh
cd .mastra/output
vercel --prod
```

> ヒント: まだの場合は、`vercel login` で Vercel CLI にログインしてください。

4. Inngest ダッシュボードと同期する

* [Inngest ダッシュボード](https://app.inngest.com/env/production/apps) に移動します。
* **Sync new app with Vercel** をクリックし、指示に従います。
* Mastra のワークフローがアプリとして登録されていることを確認できます。
  ![Inngest Dashboard](/inngest-apps-dashboard-prod.png)

5. ワークフローを実行する

* **Functions** セクションで `workflow.increment-workflow` を選択します。
* 右上の **All actions** &gt; **Invoke** をクリックします。
* 次の入力を指定します:

```json
{
  "data": {
    "inputData": {
      "value": 5
    }
  }
}
```

![Inngest Function Run](/inngest-function-dashboard-prod.png)

6. 実行状況の監視

* **Runs** タブに移動します。
* 最新の実行をクリックして、各ステップの進行状況を確認します。
  ![Inngest Function Run](/inngest-runs-dashboard-prod.png)


## 高度な使い方: カスタム Inngest 関数の追加

`inngestServe` の任意パラメータである `functions` を使用すると、Mastra のワークフローと並行して追加の Inngest 関数を提供できます。

### カスタム関数の作成

まず、カスタムの Inngest 関数を作成します。

```ts showLineNumbers copy filename="src/inngest/custom-functions.ts"
import { inngest } from "./inngest";

// カスタム Inngest 関数の定義
export const customEmailFunction = inngest.createFunction(
  { id: 'send-welcome-email' },
  { event: 'user/registered' },
  async ({ event }) => {
    // メール送信のカスタムロジック
    console.log(`歓迎メールを送信: ${event.data.email}`);
    return { status: 'email_sent' };
  }
);

export const customWebhookFunction = inngest.createFunction(
  { id: 'process-webhook' },
  { event: 'webhook/received' },
  async ({ event }) => {
    // Webhook 処理のカスタムロジック
    console.log(`Webhook を処理: ${event.data.type}`);
    return { processed: true };
  }
);
```


### ワークフローでカスタム関数を提供する

Mastra の設定を更新して、カスタム関数を含めます：

```ts showLineNumbers copy filename="src/mastra/index.ts"
import { Mastra } from "@mastra/core/mastra";
import { serve as inngestServe } from "@mastra/inngest";
import { incrementWorkflow } from "./workflows";
import { inngest } from "./inngest";
import { customEmailFunction, customWebhookFunction } from "./inngest/custom-functions";

export const mastra = new Mastra({
  workflows: {
    incrementWorkflow,
  },
  server: {
    host: "0.0.0.0",
    apiRoutes: [
      {
        path: "/api/inngest",
        method: "ALL",
        createHandler: async ({ mastra }) => inngestServe({
          mastra,
          inngest,
          functions: [customEmailFunction, customWebhookFunction] // カスタム関数を追加する
        }),
      },
    ],
  },
});
```


### 関数の登録

カスタム関数を含める場合:

1. **Mastra のワークフロー**は自動的に `workflow.${workflowId}` のような ID を持つ Inngest の関数に変換されます
2. **カスタム関数**は指定した ID（例: `send-welcome-email`、`process-webhook`）をそのまま保持します
3. **すべての関数**は同じ `/api/inngest` エンドポイントでまとめて提供されます

これにより、Mastra のワークフローオーケストレーションを既存の Inngest 関数とシームレスに統合できます。