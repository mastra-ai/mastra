---
title: "ワークフローの一時停止と再開 | Human-in-the-Loop | Mastra ドキュメント"
description: "Mastra のワークフローでは、一時停止と再開により、外部からの入力やリソースを待つ間、実行を一時停止できます。"
---

# 一時停止と再開

ワークフローは任意のステップで一時停止でき、現在の状態はストレージに[スナップショット](./snapshots.mdx)として保存（永続化）されます。準備が整ったら、この保存済みスナップショットから実行を再開できます。スナップショットを永続化しておくことで、セッション、デプロイ、サーバー再起動をまたいでもワークフローの状態が維持されます。これは、外部の入力やリソースを待つ間に一時停止したままになる可能性があるワークフローに不可欠です。

ワークフローを一時停止する一般的なケースには次のようなものがあります:

- 人による承認や入力を待つ
- 外部 API リソースが利用可能になるまで待機する
- 後続ステップに必要な追加データを収集する
- コストの高い処理に対するレート制限やスロットリングを行う
- 外部トリガーによるイベント駆動プロセスを処理する

> 一時停止と再開が初めてですか？公式の動画チュートリアルをご覧ください:
>
> - [Suspend & Resume で Human-in-the-Loop を極める](https://youtu.be/aORuNG8Tq_k) - ワークフローの一時停止とユーザー入力の受け付け方を学ぶ
> - [React でマルチターンのチャットインターフェースを構築](https://youtu.be/UMVm8YZwlxc) - React のチャットインターフェースで人が関与するマルチターンのやり取りを実装する

## ワークフローのステータスタイプ

ワークフローを実行すると、`status` は次のいずれかになります:

- `running` - ワークフローは現在実行中
- `suspended` - ワークフローは一時停止中
- `success` - ワークフローは完了
- `failed` - ワークフローは失敗

## `suspend()` を使ってワークフローを一時停止する

特定のステップでユーザー入力が得られるまで実行を一時停止するには、`⁠suspend` 関数でワークフローを一時的に停止し、必要なデータが提供されたときだけ再開するようにします。

![suspend() を使ってワークフローを一時停止する](/image/workflows/workflows-suspend-resume-suspend.jpg)

```typescript {16} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
const step1 = createStep({
  id: "step-1",
  inputSchema: z.object({
    input: z.string()
  }),
  outputSchema: z.object({
    output: z.string()
  }),
  resumeSchema: z.object({
    city: z.string()
  }),
  execute: async ({ resumeData, suspend }) => {
    const { city } = resumeData ?? {};

    if (!city) {
      return await suspend({});
    }

    return { output: "" };
  }
});

export const testWorkflow = createWorkflow({
  // ...
})
  .then(step1)
  .commit();
```

> 詳細は、[Suspend workflow の例](../../examples/workflows/human-in-the-loop.mdx#suspend-workflow)を参照してください。


### 一時停止中のステップの特定

一時停止中のワークフローを再開するには、結果の `suspended` 配列を確認して、どのステップに入力が必要かを特定します:

```typescript {15} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
import { mastra } from "./mastra";

const run = await mastra.getWorkflow("testWorkflow").createRunAsync();

const result = await run.start({
  inputData: {
    city: "ロンドン"
  }
});

console.log(JSON.stringify(result, null, 2));

if (result.status === "suspended") {
  const resumedResult = await run.resume({
    step: result.suspended[0],
    resumeData: {
      city: "ベルリン"
    }
  });
}
```

この場合、ロジックは`suspended`配列に記載された最初のステップから再開されます。`step`はその`id`で定義することもでき、例えば「step-1」のように指定します。

```json
{
  "status": "一時停止",
  "steps": {
    // ...
    "step-1": {
      // ...
      "status": "一時停止",
    }
  },
  "suspended": [
    [
      "step-1"
    ]
  ]
}
```

> 詳細は[「Run Workflow Results」](./overview.mdx#run-workflow-results)をご参照ください。


## suspend を用いたユーザーフィードバックの提供

ワークフローが一時停止された場合、`suspendSchema` を通じてユーザーにフィードバックを表示できます。ワークフローが一時停止した理由を伝えるため、`suspend` のペイロードに理由を含めてください。

```typescript {13,23} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
import { createWorkflow, createStep } from "@mastra/core/workflows";
import { z } from "zod";

const step1 = createStep({
  id: "step-1",
  inputSchema: z.object({
    value: z.string()
  }),
  resumeSchema: z.object({
    confirm: z.boolean()
  }),
  suspendSchema: z.object({
    reason: z.string()
  }),
  outputSchema: z.object({
    value: z.string()
  }),
  execute: async ({ resumeData, suspend }) => {
    const { confirm } = resumeData ?? {};

    if (!confirm) {
      return await suspend({
        reason: "続行するには確認が必要です"
      });
    }

    return { value: "" };
  }
});

export const testWorkflow = createWorkflow({
  // ...
})
  .then(step1)
  .commit();

```

この場合、その理由には、続行するにはユーザーの確認が必要であると記されています。

```json
{
  "step-1": {
    // ...
    "status": "一時停止",
    "suspendPayload": {
      "reason": "続行するには確認が必要です"
    },
  }
}
```

> 詳細は [Run Workflow Results](./overview.mdx#run-workflow-results) を参照してください。


## `resume()` を使ってワークフローを再開する

`resume` を呼び出して必要な `resumeData` を渡すことで、ワークフローを再開できます。再開するステップを明示的に指定してもよいですし、停止中のステップがちょうど1つだけの場合は `step` パラメータを省略すると、そのステップが自動的に再開されます。

```typescript {16-18} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
import { mastra } from "./mastra";

const run = await mastra.getWorkflow("testWorkflow").createRunAsync();

const result = await run.start({
   inputData: {
    city: "London"
  }
});

console.log(JSON.stringify(result, null, 2));

if (result.status === "suspended") {
  const resumedResult = await run.resume({
    step: 'step-1',
    resumeData: {
      city: "Berlin"
    }
  });

  console.log(JSON.stringify(resumedResult, null, 2));
}
```

中断されているステップが1つだけの場合は、`step` パラメータを省略できます：

```typescript {5} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
const resumedResult = await run.resume({
  resumeData: {
    city: "Berlin"
  },
  // step パラメータは省略 - 中断された単一のステップが自動的に再開されます
});
```

`start` と `resume` の両方のコマンドに、引数として `runtimeContext` を渡すことができます。

```typescript filename="src/mastra/workflows/test-workflow.ts"
import { RuntimeContext } from "@mastra/core/runtime-context";

const runtimeContext = new RuntimeContext();

const result = await run.start({
  step: 'step-1',
  inputData: {
    city: "ロンドン"
  },
  runtimeContext
});

const resumedResult = await run.resume({
  step: 'step-1',
  resumeData: {
    city: "ニューヨーク"
  },
  runtimeContext
});
```

> 詳細は [Runtime Context](../server-db/runtime-context.mdx) をご覧ください。


### ネストされたワークフローの再開

一時停止中のネストされたワークフローを再開するには、ワークフロー インスタンスを `resume` 関数の `step` パラメーターに渡します。

```typescript {33-34} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
const dowhileWorkflow = createWorkflow({
  id: 'dowhile-workflow',
  inputSchema: z.object({ value: z.number() }),
  outputSchema: z.object({ value: z.number() }),
})
  .dountil(
    createWorkflow({
      id: 'simple-resume-workflow',
      inputSchema: z.object({ value: z.number() }),
      outputSchema: z.object({ value: z.number() }),
      steps: [incrementStep, resumeStep],
    })
      .then(incrementStep)
      .then(resumeStep)
      .commit(),
    async ({ inputData }) => inputData.value >= 10,
  )
  .then(
    createStep({
      id: 'final',
      inputSchema: z.object({ value: z.number() }),
      outputSchema: z.object({ value: z.number() }),
      execute: async ({ inputData }) => ({ value: inputData.value }),
    }),
  )
  .commit();

const run = await dowhileWorkflow.createRunAsync();
const result = await run.start({ inputData: { value: 0 } });

if (result.status === "suspended") {
  const resumedResult = await run.resume({
    resumeData: { value: 2 },
    step: ['simple-resume-workflow', 'resume'],
  });

  console.log(JSON.stringify(resumedResult, null, 2));
}
```


## Sleep と Events

Workflows は、一定時間の遅延や外部イベントに合わせて実行を一時停止することもできます。これらのメソッドは、ワークフローのステータスを `suspended` ではなく `waiting` に設定し、ポーリング、遅延リトライ、イベント駆動の処理に役立ちます。

**利用可能なメソッド:**

- [`.sleep()`](../../reference/workflows/workflow-methods/sleep.mdx): 指定したミリ秒間一時停止する
- [`.sleepUntil()`](../../reference/workflows/workflow-methods/sleepUntil.mdx): 指定した日時まで一時停止する
- [`.waitForEvent()`](../../reference/workflows/workflow-methods/waitForEvent.mdx): 外部イベントを受信するまで一時停止する
- [`.sendEvent()`](../../reference/workflows/workflow-methods/sendEvent.mdx): 待機中のワークフローを再開するためのイベントを送信する