---
title: "複雑な LLM 処理の扱い方 | Workflows | Mastra"
description: "Mastra の Workflows は、分岐、並列実行、リソースのサスペンドなどの機能により、複雑なタスクの流れを効率的にオーケストレーションできます。"
---

import { Steps, Callout, Tabs } from "nextra/components";


# Workflows の概要

Workflows を使うと、単一のエージェントの推論に頼るのではなく、明確で構造化されたステップで複雑な一連のタスクを定義できます。これにより、タスクの分割方法、タスク間のデータの流れ、いつ何を実行するかを完全に制御できます。

![Workflows の概要](/image/workflows/workflows-overview.jpg)

## ワークフローを使うべき場面

ワークフローは、あらかじめ明確に定義され、特定の実行順序で複数のステップを踏むタスクに適しています。ステップ間でのデータの流れや変換、各段階でどのプリミティブを呼び出すかを、きめ細かく制御できます。

> **📹 視聴**: → ワークフローの概要とエージェントとの比較 [YouTube（7分）](https://youtu.be/0jg2g3sNvgw)

## 中核原則

Mastra のワークフローは次の原則で動作します:

- `createStep` で**ステップ**を定義し、入出力スキーマとビジネスロジックを指定する。
- `createWorkflow` で**ステップ**を組み合わせ、実行フローを定義する。
- **ワークフロー**を実行して処理全体を動かし、一時停止・再開・ストリーミング結果を標準でサポートする。

## ワークフローのステップを作成する

ステップはワークフローの基本的な構成要素です。受け取るデータと返すデータを定義するために、`inputSchema` と `outputSchema` を指定して `createStep()` でステップを作成します。

`execute` 関数はステップが行う処理を定義します。これを使って、コードベース内の関数、外部 API、エージェント、あるいはツールを呼び出します。

```typescript {6,9,15} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
import { createStep } from "@mastra/core/workflows";

const step1 = createStep({
  id: "step-1",
  inputSchema: z.object({
    message: z.string()
  }),
  outputSchema: z.object({
    formatted: z.string()
  }),
  execute: async ({ inputData }) => {
    const { message } = inputData;

    return {
      formatted: message.toUpperCase()
    };
  }
});
```

> 設定オプションの全一覧は、[Step クラス](../../reference/workflows/step.mdx)を参照してください。


### エージェントとツールの使用

ワークフローのステップでは、登録済みのエージェントを呼び出したり、ツールを直接インポートして実行したりすることもできます。詳細は [Agents and Tools](./agents-and-tools.mdx) ページをご覧ください。

## ワークフローの作成

`createWorkflow()` に `inputSchema` と `outputSchema` を指定して、受け渡しするデータを定義し、ワークフローを作成します。`.then()` でステップを追加し、最後に `.commit()` でワークフローを確定します。

```typescript {9,12,15,16} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
import { createWorkflow, createStep } from "@mastra/core/workflows";
import { z } from "zod";

const step1 = createStep({...});

export const testWorkflow = createWorkflow({
  id: "test-workflow",
  inputSchema: z.object({
    message: z.string()
  }),
  outputSchema: z.object({
    output: z.string()
  })
})
  .then(step1)
  .commit();

```

> 設定オプションの全一覧は、[Workflow Class](../../reference/workflows/workflow.mdx) を参照してください。


### 制御フローを理解する

ワークフローは、さまざまな方法で構成できます。どの方法を選ぶかによって、各ステップのスキーマの構造が変わります。詳しくは [Control Flow](./control-flow.mdx) ページをご覧ください。

#### ワークフローのステップ構成

`.then()` を使用すると、ステップは順番に実行されます。各ステップの `inputSchema` は直前のステップの `outputSchema` と一致している必要があります。最後のステップの `outputSchema` はワークフローの `outputSchema` と一致させ、エンドツーエンドでの型安全性を確保してください。

```typescript {4,7,14,17,24,27} filename="src/mastra/workflows/test-workflow.ts" showLineNumbers copy
const step1 = createStep({
  //...
  inputSchema: z.object({
    message: z.string()
  }),
  outputSchema: z.object({
    formatted: z.string()
  })
});

const step2 = createStep({
  // ...
  inputSchema: z.object({
    formatted: z.string()
  }),
  outputSchema: z.object({
    emphasized: z.string()
  })
});

export const testWorkflow = createWorkflow({
  // ...
  inputSchema: z.object({
    message: z.string()
  }),
  outputSchema: z.object({
    emphasized: z.string()
  })
})
  .then(step1)
  .then(step2)
  .commit();
```


### ワークフローの登録

Mastra インスタンスにワークフローを登録すると、アプリケーション全体で利用できるようになります。登録後はエージェントやツールから呼び出せるようになり、ログやオブザーバビリティ機能などの共有リソースにもアクセスできます。

```typescript {6} filename="src/mastra/index.ts" showLineNumbers copy
import { Mastra } from "@mastra/core/mastra";
import { testWorkflow } from "./workflows/test-workflow";

export const mastra = new Mastra({
  // ...
  workflows: { testWorkflow },
});
```


## ワークフローの参照

ワークフローはエージェント、ツール、Mastra Client、またはコマンドラインから実行できます。セットアップに応じて、`mastra` または `mastraClient` のインスタンスで `.getWorkflow()` を呼び出して参照を取得します。

```typescript showLineNumbers copy
const testWorkflow = mastra.getWorkflow("testWorkflow");
```

<Callout type="info">
  <p>
    `mastra.getWorkflow()` の使用が、直接インポートよりも推奨されます。Mastra インスタンスの設定（logger、telemetry、storage、登録済みエージェント、ベクターストア）にアクセスできるためです。
  </p>
</Callout>

> 詳細は [Running Workflows](../../examples/workflows/running-workflows.mdx) を参照してください。


## ワークフローの実行

ワークフローは2つのモードで実行できます。start はすべてのステップが完了するまで待ってから結果を返し、stream は実行中にイベントを発行します。ユースケースに合わせて選択してください。最終結果だけが必要な場合は start、進捗の監視や各ステップ完了時にアクションをトリガーしたい場合は stream を使います。

<Tabs items={["Start", "Stream"]}>
  <Tabs.Tab>
`createRunAsync()` でワークフローの実行インスタンスを作成し、ワークフローの `inputSchema` に適合する `inputData` を指定して `.start()` を呼び出します。ワークフローはすべてのステップを実行し、最終結果を返します。

```typescript showLineNumbers copy
const run = await testWorkflow.createRunAsync();

const result = await run.start({
  inputData: {
    message: "Hello world"
  }
});

console.log(result);
```
  </Tabs.Tab>
  <Tabs.Tab>
`.createRunAsync()` でワークフローの実行インスタンスを作成し、ワークフローの `inputSchema` に適合する `inputData` を指定して `.stream()` を呼び出します。ワークフローは各ステップの実行に伴いイベントを発行し、それを反復処理して進捗を追跡できます。

```typescript showLineNumbers copy
const run = await testWorkflow.createRunAsync();

const result = await run.stream({
  inputData: {
    message: "Hello world"
  }
});

for await (const chunk of result.stream) {
  console.log(chunk);
}
```
  </Tabs.Tab>
</Tabs>

## ワークフローの出力

ワークフローの出力には、各ステップの入力と出力を示す実行ライフサイクル全体が含まれます。各ステップのステータス、ワークフロー全体のステータス、最終的な結果も含まれます。これにより、データがワークフロー内をどのように流れたか、各ステップが何を生成したか、そしてワークフローがどのように完了したかを明確に把握できます。

```json
{
  "status": "success",
  "steps": {
    // ...
    "step-1": {
      "status": "success",
      "payload": {
        "message": "こんにちは、世界"
      },
      "output": {
        "formatted": "HELLO WORLD"
      },
    },
    "step-2": {
      "status": "success",
      "payload": {
        "formatted": "HELLO WORLD"
      },
      "output": {
        "emphasized": "HELLO WORLD!!!"
      },
    }
  },
  "input": {
    "message": "こんにちは、世界"
  },
  "result": {
    "emphasized": "HELLO WORLD!!!"
  }
}
```


## `RuntimeContext` の使用

[RuntimeContext](../server-db/runtime-context.mdx) を使って、リクエストごとの値にアクセスします。これにより、リクエストの文脈に応じて挙動を条件付きで調整できます。

```typescript filename="src/mastra/workflows/test-workflow.ts" showLineNumbers
export type UserTier = {
  "user-tier": "enterprise" | "pro";
};

const step1 = createStep({
  // ...
  execute: async ({ runtimeContext }) => {
    const userTier = runtimeContext.get("user-tier") as UserTier["user-tier"];

    const maxResults = userTier === "enterprise"
      ? 1000
      : 50;

    return { maxResults };
  }
});
```

> 詳細は [Runtime Context](../server-db/runtime-context.mdx) を参照してください。


## Mastra Playground でのテスト

Mastra の[Playground](../server-db/local-dev-playground.mdx)を使うと、さまざまな入力でワークフローを手軽に実行し、実行ライフサイクルを可視化し、各ステップの入出力を確認し、ワークフローの各要素をより詳しく検証できます。

## 関連

ワークフローの詳細は、実践的な例を通じて中核概念を解説する[Workflow Guide](../../guides/guide/ai-recruiter.mdx)をご覧ください。

- [Parallel Steps ワークフローの例](../../examples/workflows/parallel-steps.mdx)
- [Conditional Branching ワークフローの例](../../examples/workflows/conditional-branching.mdx)
- [Inngest ワークフローの例](../../examples/workflows/inngest-workflow.mdx)
- [Suspend and Resume ワークフローの例](../../examples/workflows/human-in-the-loop.mdx)

## ワークフロー（レガシー）

レガシーなワークフローに関するドキュメントは、[Workflows (Legacy)](../workflows-legacy/overview.mdx) を参照してください。