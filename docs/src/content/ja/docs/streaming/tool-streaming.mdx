---
title: "ツールストリーミング | ストリーミング | Mastra"
description: "Mastra におけるツールストリーミングの使い方を、ストリーミング中のツール呼び出し、ツール結果、ツール実行イベントの扱いを含めて学びます。"
---

import { Callout } from "nextra/components";


# ツールのストリーミング

Mastra のツール・ストリーミングを使うと、実行完了を待たずに、ツールが動作中の段階的な結果を送信できます。これにより、部分的な進捗や中間状態、進行中のデータを、ユーザーや上流のエージェント／ワークフローに直接提示できます。

ストリームに書き込む方法は主に次の2つです:

- **ツール内から**: すべてのツールは `writer` 引数を受け取ります。これは実行に伴って更新をプッシュできる書き込み可能なストリームです。
- **エージェントのストリームから**: エージェントの `stream` 出力をツールの `writer` に直接パイプできるため、余計なグルーコードなしでエージェントの応答をツールの結果へ簡単に連結できます。

書き込み可能なツール・ストリームとエージェントのストリーミングを組み合わせることで、中間結果がシステム内を経由してユーザー体験へ届くまでの流れをきめ細かく制御できます。

## ツールを利用するエージェント

エージェントのストリーミングはツール呼び出しと組み合わせられ、ツールの出力をエージェントのストリーミング応答に直接反映できます。これにより、全体のインタラクションの一部としてツールの動作を可視化できます。

```typescript {4,10} showLineNumbers copy
import { openai } from "@ai-sdk/openai";
import { Agent } from "@mastra/core/agent";

import { testTool } from "../tools/test-tool";

export const testAgent = new Agent({
  name: "test-agent",
  instructions: "あなたは天気に関するエージェントです。",
  model: openai("gpt-4o-mini"),
  tools: { testTool }
});
```


### `writer` 引数の使用

`writer` 引数はツールの `execute` 関数に渡され、アクティブなストリームへカスタムイベントやデータ、値を送出するために使用できます。これにより、実行中であってもツールは中間結果や進捗状況の更新を提供できます。

<Callout type="warning">
  `writer.write(...)` の呼び出しは必ず `await` してください。そうしないとストリームがロックされ、`WritableStream is locked` エラーが発生します。
</Callout>

```typescript {5,8,15} showLineNumbers copy
import { createTool } from "@mastra/core/tools";

export const testTool = createTool({
  // ...
  execute: async ({ context, writer }) => {
    const { value } = context;

   await writer?.write({
      type: "custom-event",
      status: "pending"
    });

    const response = await fetch(...);

   await writer?.write({
      type: "custom-event",
      status: "success"
    });

    return {
      value: ""
    };
  }
});
```

UI フレームワークと統合する際にトップレベルのストリームチャンクを出力したい場合は、`writer.custom` も使用できます。これはそのようなケースで特に有用です。

```typescript {5,8,15} showLineNumbers copy
import { createTool } from "@mastra/core/tools";

export const testTool = createTool({
  // ...
  execute: async ({ context, writer }) => {
    const { value } = context;

   await writer?.custom({
      type: "data-tool-progress",
      status: "pending"
    });

    const response = await fetch(...);

   await writer?.custom({
      type: "data-tool-progress",
      status: "success"
    });

    return {
      value: ""
    };
  }
});
```


### ストリームのペイロードを確認する

ストリームに書き込まれたイベントは、出力されるチャンクに含まれます。これらのチャンクを確認することで、イベントタイプや中間値、ツール固有のデータなどのカスタムフィールドにアクセスできます。

```typescript showLineNumbers copy
const stream = await testAgent.stream([
  "ロンドンの天気はどうですか？",
  "testToolを使用してください"
]);

for await (const chunk of stream) {
  if (chunk.payload.output?.type === "custom-event") {
    console.log(JSON.stringify(chunk, null, 2));
  }
}
```


## エージェントを用いるツール

エージェントの `textStream` をツールの `writer` にパイプします。これにより部分出力がストリーミングされ、Mastra がエージェントの使用状況を自動的にツールの実行に集約します。

```typescript showLineNumbers copy
import { createTool } from "@mastra/core/tools";
import { z } from "zod";

export const testTool = createTool({
  // ...
  execute: async ({ context, mastra, writer }) => {
    const { city } = context;

    const testAgent = mastra?.getAgent("testAgent");
    const stream = await testAgent?.stream(`${city}の天気はどうですか？`);

    await stream!.textStream.pipeTo(writer!);

    return {
      value: await stream!.text
    };
  }
});
```
