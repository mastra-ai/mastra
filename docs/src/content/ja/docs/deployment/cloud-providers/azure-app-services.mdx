---
title: "Azure App Services"
description: "Mastra アプリを Azure App Services にデプロイする"
---

import { Callout, Steps } from "nextra/components";


# Azure App Services

Mastra アプリケーションを Azure App Services にデプロイします。

<Callout>
  このガイドは、Mastra アプリケーションが既定の
  `npx create-mastra@latest` コマンドで作成されていることを前提としています。
  新しい Mastra アプリケーションの作成方法については、
  [クイックスタート](/docs/getting-started/installation) を参照してください。
</Callout>

## 前提条件

- 有効なサブスクリプションがある [Azure アカウント](https://azure.microsoft.com/)
- Mastra アプリケーションを含む [GitHub リポジトリ](https://github.com/)
- Mastra アプリケーションが `npx create-mastra@latest` で作成されていること

## デプロイ手順

<Steps>

### 新しい App Service を作成する

- [Azure Portal](https://portal.azure.com) にサインインする
- **[App Services](https://docs.microsoft.com/en-us/azure/app-service/)** に移動するか、上部の検索バーで検索する
- **Create** をクリックして新しい App Service を作成する
- ドロップダウンで **Web App** を選択する

### App Service の設定を行う

- **Subscription**: 使用する Azure サブスクリプションを選択する
- **Resource Group**: 新規作成するか既存のものを選択する
- **Instance name**: アプリの一意の名前を入力する（URL の一部になります）
- **Publish**: **Code** を選択する
- **Runtime stack**: **Node 22 LTS** を選択する
- **Operating System**: **Linux** を選択する
- **Region**: ユーザーに近いリージョンを選択する
- **Linux Plan**: 選択したリージョンによってはプランを選べるため、要件に合ったものを選択する
- **Review + Create** をクリックする
- 検証完了後、**Create** をクリックする

### デプロイを待つ

- デプロイが完了するまで待機する
- 完了したら、「次の手順」セクションの **Go to resource** をクリックする

### 環境変数を設定する

デプロイ設定の前に、環境変数を設定します:

- 左側メニューの **Settings** > **Environment variables** に移動する
- 次のような必要な環境変数を追加する:
  - モデルプロバイダーの API キー（例: `OPENAI_API_KEY`）
  - データベース接続文字列
  - Mastra アプリケーションに必要なその他の設定値
- **Apply** をクリックして保存する

### GitHub デプロイを設定する

- 左側メニューの **Deployment Center** に移動する
- ソースとして **GitHub** を選択する
- まだ Azure に対して認証していない場合は GitHub にサインインする
- この例ではプロバイダーとして [GitHub Actions](https://docs.github.com/en/actions) を使用する
- 組織、リポジトリ、ブランチを選択する
- Azure が GitHub のワークフローファイルを生成し、進む前にプレビューできる
- **Save** をクリックする（保存ボタンはページ上部にあります）

### GitHub ワークフローを修正する

<Callout type="warning">
Azure が生成するデフォルトのワークフローは Mastra アプリケーションでは失敗するため、修正が必要です。
</Callout>

Azure がワークフローを作成すると、GitHub Actions の実行がトリガーされ、ワークフローファイルがブランチにマージされます。必要な修正がないと失敗するため、**この初回の実行はキャンセルしてください**。

最新の変更をローカルリポジトリにプルし、生成されたワークフローファイル（`.github/workflows/main_<your-app-name>.yml`）を修正します:

1. **ビルド手順を更新**: "npm install, build, and test" という名前のステップを見つけ、次を実施する:
   - ステップ名を "npm install and build" に変更する
   - Mastra アプリケーションで適切なテストを用意していない場合は、デフォルトのテストスクリプトが失敗してデプロイに支障をきたすため、run セクションから `npm test` コマンドを削除する。テストが機能している場合は、そのままでもよい。

2. **zip アーティファクトのステップを更新**: "Zip artifact for deployment" ステップを見つけ、zip コマンドを次の内容に置き換える:

   ```yaml
   run: (cd .mastra/output && zip ../../release.zip -r .)
   ```

   これにより、`.mastra/output` のビルド出力のみがデプロイパッケージに含まれます。

### 変更をデプロイする

- ワークフローの修正をコミットしてプッシュする
- ビルドは Azure ダッシュボードの **Deployment Center** で自動的にトリガーされる
- 正常に完了するまでデプロイの進行状況を監視する

### アプリケーションにアクセスする

- ビルドが成功したら、アプリケーションが起動するまで少し待つ
- Azure ポータルの **Overview** タブに表示されるデフォルトの URL からデプロイ済みアプリケーションにアクセスする
- アプリケーションは `https://<your-app-name>.azurewebsites.net` で利用可能です

</Steps>

## Mastra サーバーに接続する

`@mastra/client-js` パッケージの `MastraClient` を使うと、クライアントアプリケーションから Mastra サーバーに接続できます。

詳しくは、[`MastraClient` のドキュメント](/docs/client-js/overview)をご覧ください。

```typescript copy showLineNumbers
import { MastraClient } from "@mastra/client-js";

const mastraClient = new MastraClient({
  baseUrl: "https://<your-app-name>.azurewebsites.net",
});
```

<Callout>
  一部の料金プランでは、Azure App Services は一時的なファイルシステムを使用します。
  本番環境のアプリケーションでは、ローカルファイルシステムに依存する Mastra のストレージプロバイダー（例：ファイル URL を用いた `LibSQLStore`）の使用は避けてください。
  代わりに、クラウドベースのストレージを検討してください。
</Callout>


## 次のステップ

- [Mastra クライアント SDK](/docs/client-js/overview)
- [カスタム ドメインの設定](https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-custom-domain)
- [HTTPS の有効化](https://docs.microsoft.com/en-us/azure/app-service/configure-ssl-bindings)
- [Azure App Service のドキュメント](https://docs.microsoft.com/en-us/azure/app-service/)