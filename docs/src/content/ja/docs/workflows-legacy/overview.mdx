---
title: "複雑な LLM 処理の扱い方 | Workflows（レガシー） | Mastra"
description: "Mastra の Workflows は、分岐、並列実行、リソースの一時停止などの機能により、複雑な一連の処理を効率よくオーケストレーションできます。"
---

# ワークフローで複雑な LLM 処理を扱う（レガシー）

レガシー版ワークフローのドキュメントは以下のリンクからご覧いただけます。

- [Steps](/docs/workflows-legacy/steps.mdx)
- [Control Flow](/docs/workflows-legacy/control-flow.mdx)
- [Variables](/docs/workflows-legacy/variables.mdx)
- [Suspend & Resume](/docs/workflows-legacy/suspend-and-resume.mdx)
- [Dynamic Workflows](/docs/workflows-legacy/dynamic-workflows.mdx)
- [Error Handling](/docs/workflows-legacy/error-handling.mdx)
- [Nested Workflows](/docs/workflows-legacy/nested-workflows.mdx)
- [Runtime/Dynamic Variables](/docs/workflows-legacy/runtime-variables.mdx)

Mastra のワークフローは、分岐、並列実行、処理の一時停止などの機能により、複雑な処理の流れをオーケストレーションするのに役立ちます。

## ワークフローを使うタイミング

ほとんどの AI アプリケーションは、言語モデルへの単一の呼び出しだけでは足りません。複数のステップを実行したり、条件に応じて特定の経路をスキップしたり、ユーザー入力を受け取るまで実行を一時停止したい場合があります。エージェントによるツール呼び出しの精度が十分でないこともあります。

Mastra のワークフローシステムは次のことを提供します:

- ステップを定義して相互に連結するための標準化された方法
- 単純（直列）な経路と、高度（分岐・並列）な経路の両方への対応
- 各ワークフロー実行を追跡するためのデバッグ機能と可観測性

## 例

ワークフローを作成するには、1つ以上のステップを定義して相互に関連付け、開始前にワークフローをコミットします。

### ワークフローの内訳（レガシー）

ワークフロー作成プロセスの各要素を見ていきましょう。

#### 1. ワークフローの作成

Mastra でワークフローを定義する方法は次のとおりです。`name` フィールドはワークフローの API エンドポイント（`/workflows/$NAME/`）を決定し、`triggerSchema` はワークフローのトリガー データの構造を定義します。

```ts filename="src/mastra/workflow/index.ts"
import { LegacyStep, LegacyWorkflow } from "@mastra/core/workflows/legacy";

const myWorkflow = new LegacyWorkflow({
  name: "my-workflow",
  triggerSchema: z.object({
    inputValue: z.number(),
  }),
});
```


#### 2. ステップの定義

ここでは、ワークフローのステップを定義します。各ステップには独自の入力スキーマと出力スキーマを設定できます。ここでは、`stepOne` は入力値を2倍にし、`stepTwo` は `stepOne` が成功していればその結果を1増やします。（話を簡単にするため、この例では LLM の呼び出しは行っていません）:

```ts filename="src/mastra/workflow/index.ts"
const stepOne = new LegacyStep({
  id: "stepOne",
  outputSchema: z.object({
    doubledValue: z.number(),
  }),
  execute: async ({ context }) => {
    const doubledValue = context.triggerData.inputValue * 2;
    return { doubledValue };
  },
});

const stepTwo = new LegacyStep({
  id: "stepTwo",
  execute: async ({ context }) => {
    const doubledValue = context.getStepResult(stepOne)?.doubledValue;
    if (!doubledValue) {
      return { incrementedValue: 0 };
    }
    return {
      incrementedValue: doubledValue + 1,
    };
  },
});
```


#### 3. ステップのリンク

では、制御フローを作成し、「commit」（ワークフローの確定）しましょう。今回は、まず `stepOne` が実行され、続いて `stepTwo` が実行されます。

```ts filename="src/mastra/workflow/index.ts"
myWorkflow.step(stepOne).then(stepTwo).commit();
```


### ワークフローを登録する

Mastra にワークフローを登録して、ログ出力とテレメトリーを有効化します。

```ts showLineNumbers filename="src/mastra/index.ts"
import { Mastra } from "@mastra/core";

export const mastra = new Mastra({
  legacy_workflows: { myWorkflow },
});
```

動的なワークフローを作成する必要がある場合、ワークフローでは mastra インスタンスをコンテキストに注入することもできます。

```ts filename="src/mastra/workflow/index.ts"
import { Mastra } from "@mastra/core";
import { LegacyWorkflow } from "@mastra/core/workflows/legacy";

const mastra = new Mastra();

const myWorkflow = new LegacyWorkflow({
  name: "my-workflow",
  mastra,
});
```


### ワークフローの実行

ワークフローはプログラムから、または API 経由で実行できます。

```ts showLineNumbers filename="src/mastra/run-workflow.ts" copy
import { mastra } from "./index";

// ワークフローを取得する
const myWorkflow = mastra.legacy_getWorkflow("myWorkflow");
const { runId, start } = myWorkflow.createRun();

// ワークフローの実行を開始する
await start({ triggerData: { inputValue: 45 } });
```

または API を使用します（`mastra dev` の実行が必要）:

// ワークフロー実行を作成

```bash
curl --location 'http://localhost:4111/api/workflows/myWorkflow/start-async' \
     --header 'Content-Type: application/json' \
     --data '{
       "inputValue": 45
     }'
```

この例は要点を示しています。ワークフローを定義し、ステップを追加し、ワークフローをコミットしてから実行します。


## ステップの定義

ワークフローの基本的な構成要素[はステップです](./steps.mdx)。ステップは入力と出力のスキーマで定義され、前のステップの結果を参照できます。

## 制御フロー

Workflows を使うと、並列ステップや分岐などを含むステップの連結用の[制御フロー](./control-flow.mdx)を定義できます。

## ワークフロー変数

ステップ間でデータをマッピングしたり、動的なデータフローを作成する必要がある場合、[ワークフロー変数](./variables.mdx)は、あるステップから次のステップへ情報を受け渡し、ステップの出力内にあるネストされたプロパティへアクセスするための強力な仕組みを提供します。

## 一時停止と再開

外部データやユーザー入力、非同期イベントのために実行を一時停止する必要がある場合、Mastra は[任意のステップでの一時停止](./suspend-and-resume.mdx)に対応しており、ワークフローの状態を保存して後から再開できます。

## 可観測性とデバッグ

Mastra のワークフローは、ワークフロー実行内の各ステップの入出力を自動的に[ログに記録](../../reference/observability/otel-config.mdx)し、このデータをお好みのログ、テレメトリー、または可観測性ツールへ送信できるようにします。

できること:

- 各ステップのステータス（例: `success`、`error`、`suspended`）を追跡する
- 実行ごとのメタデータを保存して分析する
- ログを転送して、Datadog や New Relic などのサードパーティ製可観測性プラットフォームと統合する

## 参考情報

- [逐次ステップのワークフロー例](../../examples/workflows_legacy/sequential-steps.mdx)
- [並列ステップのワークフロー例](../../examples/workflows_legacy/parallel-steps.mdx)
- [分岐パスのワークフロー例](../../examples/workflows_legacy/branching-paths.mdx)
- [ワークフロー変数の例](../../examples/workflows_legacy/workflow-variables.mdx)
- [循環依存関係のワークフロー例](../../examples/workflows_legacy/cyclical-dependencies.mdx)
- [一時停止と再開のワークフロー例](../../examples/workflows_legacy/suspend-and-resume.mdx)