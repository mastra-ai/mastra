---
title: "Mastra と Astro の始め方 | Mastra ガイド"
description: Mastra を Astro に統合するためのステップバイステップガイド。
---

import { Callout, Steps, Tabs } from "nextra/components";


# Astro プロジェクトに Mastra を統合する

Mastra は Astro と統合されており、次のことを簡単に行えます:

- AI 機能を提供する柔軟な API の構築
- フロントエンドとバックエンドを単一のコードベースでまとめ、デプロイを簡素化
- Astro の組み込みの [Actions](https://docs.astro.build/en/guides/actions/) や [Server Endpoints](https://docs.astro.build/en/guides/endpoints/#server-endpoints-api-routes) を活用して、効率的なサーバーとクライアント間のワークフローを実現

このガイドを参照して、Astro プロジェクトに Mastra をセットアップして統合してください。

<Tabs items={["Actions", "Server Endpoints"]}>
  <Tabs.Tab>
    <Callout type="warning">
      このガイドは、Astro の Actions を React と Vercel アダプターと併用していることを前提としています。
    </Callout>

    <Steps>
      ## Mastraのインストール

      必要なMastraパッケージをインストールする:

      {/*
              LLM コンテキスト: この Tabs コンポーネントは、各種パッケージマネージャーで新しい Mastra のバックエンドプロジェクトを統合するためのコマンドを表示します。
              各タブには、そのパッケージマネージャー用の、統合済みの Mastra バックエンドサービスを作成するコマンドが表示されます。
              これは Astro プロジェクトにおける「統合型バックエンド・インテグレーション」手法の一部です。
              すべてのコマンドは同じ Mastra プロジェクトを作成しますが、パッケージマネージャーごとに記法が異なります。
              */}

      <Tabs items={["npm", "yarn", "pnpm", "bun"]}>
        <Tabs.Tab>
          ```bash copy
          npm install mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          bun add mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>
      </Tabs>

      ## Mastraの統合

      Mastraをプロジェクトに統合するには、2つのオプションがあります:

      ### 1. ワンライナーを使用する

      以下のコマンドを実行して、適切なデフォルト設定を持つWeatherエージェントを素早く構築します:

      ```bash copy
      npx mastra@latest init --default
      ```

      > 詳しくは、[mastra init](/reference/cli/init) を参照してください。

      ### 2. インタラクティブCLIを使用する

      セットアップをカスタマイズする場合は、`init`コマンドを実行し、プロンプトが表示されたら選択肢から選んでください:

      ```bash copy
      npx mastra@latest init
      ```

      `package.json`に`dev`と`build`スクリプトを追加します:

      ```json filename="package.json"
      {
        "scripts": {
          ...
          "dev:mastra": "mastra dev",
          "build:mastra": "mastra build"
        }
      }
      ```

      ## TypeScriptを設定する

      プロジェクトルートの `tsconfig.json` ファイルを変更します:

      ```json filename="tsconfig.json"
      {
        ...
        "exclude": ["dist", ".mastra"]
      }
      ```

      ## APIキーの設定

      ```bash filename=".env" copy
      OPENAI_API_KEY=<your-api-key>
      ```

      ## .gitignore を更新する

      `.mastra` と `.vercel` を `.gitignore` ファイルに追加します:

      ```bash filename=".gitignore" copy
      .mastra
      .vercel
      ```

      ## Mastraエージェントを更新する

      Astroは`process.env`ではなく`import.meta.env`を介して環境変数にアクセスするViteを使用しています。そのため、モデルコンストラクタは次のようにVite環境から`apiKey`を明示的に受け取る必要があります:

      ```diff filename="src/mastra/agents/weather-agent.ts"
      - import { openai } from "@ai-sdk/openai";
      + import { createOpenAI } from "@ai-sdk/openai";

      + const openai = createOpenAI({
      +   apiKey: import.meta.env?.OPENAI_API_KEY,
      +   compatibility: "strict"
      + });
      ```

      > 詳細な設定については AI SDK のドキュメントをご覧ください。詳しくは [Provider Instance](https://ai-sdk.dev/providers/ai-sdk-providers/openai#provider-instance) を参照してください。

      ## Mastra開発サーバーを起動する

      Mastra Dev Serverを起動して、エージェントをRESTエンドポイントとして公開します:

      <Tabs items={["npm", "CLI"]}>
        <Tabs.Tab>
          ```bash copy
          # 開発モードで起動
          npm run dev:mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          # 開発モードで起動
          mastra dev:mastra
          ```
        </Tabs.Tab>
      </Tabs>

      > 実行を開始すると、エージェントはローカルで利用できるようになります。詳しくは [ローカル開発環境](/docs/server-db/local-dev-playground) を参照してください。

      ## Astro開発サーバーを起動する

      Mastra Dev Serverを起動した状態で、通常通りAstroサイトを起動できます。

      ## Actionsディレクトリを作成する

      ```bash copy
      mkdir src/actions
      ```

      ### テストアクションを作成

      新しいアクションを作成し、サンプルコードを追加します:

      ```bash copy
      touch src/actions/index.ts
      ```

      ```typescript filename="src/actions/index.ts" showLineNumbers copy
      import { defineAction } from "astro:actions";
      import { z } from "astro:schema";

      import { mastra } from "../mastra";

      export const server = {
        getWeatherInfo: defineAction({
          input: z.object({
            city: z.string()
          }),
          handler: async (input) => {
            const city = input.city;
            const agent = mastra.getAgent("weatherAgent");

            const result = await agent.generate(`${city}の天気はどうですか?`);

            return result.text;
          }
        })
      };
      ```

      ### テストフォームを作成

      新しいFormコンポーネントを作成し、サンプルコードを追加します:

      ```bash copy
      touch src/components/form.tsx
      ```

      ```typescript filename="src/components/form.tsx" showLineNumbers copy
      import { actions } from "astro:actions";
      import { useState } from "react";

      export const Form = () => {
        const [result, setResult] = useState<string | null>(null);

        async function handleSubmit(formData: FormData) {
          const city = formData.get("city")!.toString();
          const { data } = await actions.getWeatherInfo({ city });

          setResult(data || null);
        }

        return (
          <>
            <form action={handleSubmit}>
              <input name="city" placeholder="都市名を入力してください" required />
              <button type="submit">天気を取得</button>
            </form>
            {result && <pre>{result}</pre>}
          </>
        );
      };
      ```

      ### テストページを作成

      新しいページを作成し、サンプルコードを追加します:

      ```bash copy
      touch src/pages/test.astro
      ```

      ```astro filename="src/pages/test.astro" showLineNumbers copy
      ---
      import { Form } from '../components/form'
      ---

      <h1>テスト</h1>
      <Form client:load />
      ```

      > ブラウザで `/test` にアクセスして試してみてください。

      都市として**London**を送信すると、以下のような結果が返されます:

      ```plaintext
      エージェントの応答: ロンドンの現在の天気は以下の通りです:

      - **気温:** 12.9°C (体感温度 9.7°C)
      - **湿度:** 63%
      - **風速:** 14.7 km/h
      - **突風:** 32.4 km/h
      - **天候:** 曇り

      さらに情報が必要な場合はお知らせください!
      ```
    </Steps>
  </Tabs.Tab>

  <Tabs.Tab>
    <Callout type="warning">
      このガイドは、Astro のエンドポイントを React と Vercel アダプターと併用し、出力が server に設定されていることを前提としています。
    </Callout>

    ## 前提条件

    続行する前に、Astroプロジェクトが以下のように設定されていることを確認してください：

    * Astro の React 統合: [@astrojs/react](https://docs.astro.build/en/guides/integrations-guide/react/)
    * Vercel アダプタ: [@astrojs/vercel](https://docs.astro.build/en/guides/integrations-guide/vercel/)
    * `astro.config.mjs` で `output: "server"` が設定されています

    <Steps>
      ## Mastraのインストール

      必要なMastraパッケージをインストールする:

      {/*
              LLM CONTEXT: この Tabs コンポーネントは、各種パッケージマネージャーを使って新しい Mastra のバックエンドプロジェクトを統合するためのコマンドを表示します。
              各タブには、そのパッケージマネージャー向けに、統合済みの Mastra バックエンドサービスを作成するコマンドが表示されます。
              これは Astro プロジェクトにおける「統合型バックエンド統合」手法の一部です。
              どのコマンドも同じ Mastra プロジェクトを作成しますが、パッケージマネージャーごとに構文が異なります。
              */}

      <Tabs items={["npm", "yarn", "pnpm", "bun"]}>
        <Tabs.Tab>
          ```bash copy
          npm install mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          bun add mastra@latest @mastra/core@latest @mastra/libsql@latest
          ```
        </Tabs.Tab>
      </Tabs>

      ## Mastraの統合

      Mastraをプロジェクトに統合するには、2つのオプションがあります:

      ### 1. ワンライナーを使用する

      以下のコマンドを実行して、適切なデフォルト設定を持つWeatherエージェントを素早く構築します:

      ```bash copy
      npx mastra@latest init --default
      ```

      > 詳細は [mastra init](/reference/cli/init) をご覧ください。

      ### 2. インタラクティブCLIを使用する

      セットアップをカスタマイズする場合は、`init`コマンドを実行し、プロンプトが表示されたら選択肢から選んでください:

      ```bash copy
      npx mastra@latest init
      ```

      `package.json`に`dev`と`build`スクリプトを追加します:

      ```json filename="package.json"
      {
        "scripts": {
          ...
          "dev:mastra": "mastra dev",
          "build:mastra": "mastra build"
        }
      }
      ```

      ## TypeScriptを設定する

      プロジェクトルートの `tsconfig.json` ファイルを変更します:

      ```json filename="tsconfig.json"
      {
        ...
        "exclude": ["dist", ".mastra"]
      }
      ```

      ## APIキーの設定

      ```bash filename=".env" copy
      OPENAI_API_KEY=<your-api-key>
      ```

      ## .gitignore を更新する

      `.mastra` を `.gitignore` ファイルに追加します:

      ```bash filename=".gitignore" copy
      .mastra
      .vercel
      ```

      ## Mastraエージェントを更新する

      Astroは`process.env`ではなく`import.meta.env`を介して環境変数にアクセスするViteを使用しています。そのため、モデルコンストラクタは次のようにVite環境から`apiKey`を明示的に受け取る必要があります:

      ```diff filename="src/mastra/agents/weather-agent.ts"
      - import { openai } from "@ai-sdk/openai";
      + import { createOpenAI } from "@ai-sdk/openai";

      + const openai = createOpenAI({
      +   apiKey: import.meta.env?.OPENAI_API_KEY,
      +   compatibility: "strict"
      + });
      ```

      > 詳細な設定については AI SDK のドキュメントをご覧ください。詳しくは [Provider Instance](https://ai-sdk.dev/providers/ai-sdk-providers/openai#provider-instance) を参照してください。

      ## Mastra開発サーバーを起動する

      Mastra Dev Serverを起動して、エージェントをRESTエンドポイントとして公開します:

      <Tabs items={["npm", "CLI"]}>
        <Tabs.Tab>
          ```bash copy
          npm run dev:mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          mastra dev:mastra
          ```
        </Tabs.Tab>
      </Tabs>

      > 起動すると、エージェントはローカルで利用可能になります。詳細は[ローカル開発環境](/docs/server-db/local-dev-playground)をご覧ください。

      ## Astro開発サーバーを起動する

      Mastra Dev Serverを起動した状態で、通常通りAstroサイトを起動できます。

      ## APIディレクトリを作成する

      ```bash copy
      mkdir src/pages/api
      ```

      ### テストエンドポイントを作成する

      新しいエンドポイントを作成し、サンプルコードを追加します:

      ```bash copy
      touch src/pages/api/test.ts
      ```

      ```typescript filename="src/pages/api/test.ts" showLineNumbers copy
      import type { APIRoute } from "astro";

      import { mastra } from "../../mastra";

      export const POST: APIRoute = async ({ request }) => {
        const { city } = await new Response(request.body).json();
        const agent = mastra.getAgent("weatherAgent");

        const result = await agent.generate(`${city}の天気はどうですか?`);

        return new Response(JSON.stringify(result.text));
      };
      ```

      ### テストフォームを作成

      新しいFormコンポーネントを作成し、サンプルコードを追加します:

      ```bash copy
      touch src/components/form.tsx
      ```

      ```typescript filename="src/components/form.tsx" showLineNumbers copy
      import { useState } from "react";

      export const Form = () => {
        const [result, setResult] = useState<string | null>(null);

        async function handleSubmit(event: React.FormEvent<HTMLFormElement>) {
          event.preventDefault();

          const formData = new FormData(event.currentTarget);
          const city = formData.get("city")?.toString();

          const response = await fetch("/api/test", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ city })
          });

          const text = await response.json();
          setResult(text);
        }

        return (
          <>
            <form onSubmit={handleSubmit}>
              <input name="city" placeholder="都市名を入力してください" required />
              <button type="submit">天気を取得</button>
            </form>
            {result && <pre>{result}</pre>}
          </>
        );
      };
      ```

      ### テストページを作成

      新しいページを作成し、サンプルコードを追加します:

      ```bash copy
      touch src/pages/test.astro
      ```

      ```astro filename="src/pages/test.astro" showLineNumbers copy
      ---
      import { Form } from '../components/form'
      ---

      <h1>テスト</h1>
      <Form client:load />
      ```

      > ブラウザで`/test`にアクセスして試せるようになりました。

      都市として**London**を送信すると、以下のような結果が返されます:

      ```plaintext
      エージェントの応答: ロンドンの現在の天気は以下の通りです:

      - **気温:** 12.9°C (体感温度 9.7°C)
      - **湿度:** 63%
      - **風速:** 14.7 km/h
      - **突風:** 32.4 km/h
      - **天候:** 曇り

      さらに情報が必要な場合はお知らせください!
      ```
    </Steps>
  </Tabs.Tab>
</Tabs>

## 次のステップ

- [デプロイ | Vercel 上での Astro](/docs/deployment/web-framework#with-astro-on-vercel)
- [モノレポのデプロイ](../../deployment/monorepo.mdx)