---
title: "OpenRouter を利用する"
description: "Mastra と OpenRouter の連携方法を学ぶ"
---

import { Steps } from 'nextra/components'


# Mastra で OpenRouter を使う

OpenRouter で利用可能な多数のモデルを活用するため、Mastra と OpenRouter を統合します。

<Steps>
## Mastra プロジェクトを初期化する

Mastra を始める最も簡単な方法は、`mastra` CLI を使って新しいプロジェクトを初期化することです:

```bash copy
npx create-mastra@latest
```

プロジェクトのセットアップ用のプロンプトが表示されます。この例では次を選択します:
- プロジェクト名: my-mastra-openrouter-app
- コンポーネント: Agents（推奨）
- 既定のプロバイダーは OpenAI（推奨）を選択 — OpenRouter は後で手動で設定します
- サンプルコードを任意で含める

## OpenRouter を設定する

`create-mastra` でプロジェクトを作成した後、プロジェクトのルートに `.env` ファイルが作成されています。
セットアップ時に OpenAI を選択したため、OpenRouter は手動で設定します:

```bash filename=".env" copy
OPENROUTER_API_KEY=
```

プロジェクトから `@ai-sdk/openai` パッケージを削除します:

```bash copy
npm uninstall @ai-sdk/openai
```

続いて、`@openrouter/ai-sdk-provider` パッケージをインストールします:

```bash copy
npm install @openrouter/ai-sdk-provider
```

## エージェントを OpenRouter 利用に設定する

エージェントが OpenRouter を使うように設定します。

```typescript filename="src/mastra/agents/assistant.ts" copy showLineNumbers {4-6,11}
import { Agent } from "@mastra/core/agent";
import { createOpenRouter } from "@openrouter/ai-sdk-provider";

const openrouter = createOpenRouter({
    apiKey: process.env.OPENROUTER_API_KEY,
})

export const assistant = new Agent({
    name: "assistant",
    instructions: "You are a helpful assistant.",
    model: openrouter("anthropic/claude-sonnet-4"),
})
```

エージェントを Mastra インスタンスに登録することを忘れないでください:

```typescript filename="src/mastra/index.ts" copy showLineNumbers {4}
import { assistant } from "./agents/assistant";

export const mastra = new Mastra({
    agents: { assistant }
})
```

## エージェントを実行してテストする

```bash copy
npm run dev
```

Mastra の開発サーバーが起動します。

プレイグラウンドは [http://localhost:4111](http://localhost:4111)、Mastra API は [http://localhost:4111/api/agents/assistant/stream](http://localhost:4111/api/agents/assistant/stream) からエージェントをテストできます。

</Steps>

## 高度な設定

OpenRouter へのリクエストをより柔軟に制御するために、追加の設定オプションを指定できます。

### プロバイダー共通のオプション:

OpenRouter プロバイダーには、プロバイダー共通のオプションを渡せます:

```typescript filename="src/mastra/agents/assistant.ts" {6-10} copy showLineNumbers
import { Agent } from "@mastra/core/agent";
import { createOpenRouter } from "@openrouter/ai-sdk-provider";

const openrouter = createOpenRouter({
    apiKey: process.env.OPENROUTER_API_KEY,
    extraBody: {
        reasoning: {
            max_tokens: 10,
        }
    }
})

export const assistant = new Agent({
    name: "assistant",
    instructions: "あなたは頼りになるアシスタントです。",
    model: openrouter("anthropic/claude-sonnet-4"),
})
```


### モデル固有のオプション：

OpenRouter プロバイダーにモデル固有のオプションを渡せます。

```typescript filename="src/mastra/agents/assistant.ts" {11-17} copy showLineNumbers
import { Agent } from "@mastra/core/agent";
import { createOpenRouter } from "@openrouter/ai-sdk-provider";

const openrouter = createOpenRouter({
    apiKey: process.env.OPENROUTER_API_KEY,
})

export const assistant = new Agent({
    name: "assistant",
    instructions: "あなたは頼りになるアシスタントです。",
    model: openrouter("anthropic/claude-sonnet-4", {
        extraBody: {
            reasoning: {
                max_tokens: 10,
            }
        }
    }),
})
```


### プロバイダー固有のオプション:

OpenRouter のプロバイダーに固有のオプションを渡すことができます。

```typescript copy showLineNumbers {7-12}
// プロバイダー固有のオプションで応答を取得する
const response = await assistant.generate([
  {
    role: 'system',
    content:
      'あなたはシェフのミシェルで、ケトジェニック（ケト）ダイエットを専門とする料理のエキスパートです...',
    providerOptions: {
      // プロバイダー固有のオプション - キーは「anthropic」または「openrouter」にできます
      anthropic: {
        cacheControl: { type: 'ephemeral' },
      },
    },
  },
  {
    role: 'user',
    content: 'ケト向けの朝食を提案してもらえますか？',
  },
]);
```
