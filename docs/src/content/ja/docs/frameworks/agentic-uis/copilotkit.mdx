---
title: "CopilotKit と一緒に使う"
description: "Mastra が CopilotKit の AGUI ライブラリをどのように活用しているか、またそれを使ってユーザー体験を構築する方法を学びましょう"
---

import { Tabs, Steps } from "nextra/components";
import Image from "next/image";


# Mastra と CopilotKit を統合する

CopilotKit は、アプリケーションにカスタマイズ可能な AI コパイロットを手早く組み込むための React コンポーネントを提供します。Mastra と組み合わせることで、双方向の状態同期やインタラクティブな UI を備えた高度な AI アプリを構築できます。

CopilotKit のコンセプト、コンポーネント、発展的な活用パターンについては、[CopilotKit ドキュメント](https://docs.copilotkit.ai/)をご覧ください。

このガイドでは、次の 2 つの統合方法を紹介します。

1. Mastra サーバーに CopilotKit を統合し、フロントエンドは別の React として構築する
2. Next.js アプリに CopilotKit を統合する

<Tabs items={["Mastra Server", "Next.js" ]}>
  <Tabs.Tab>
    <Steps>
      ## React の依存関係をインストール

      React フロントエンドで、必要な CopilotKit パッケージをインストールします:

      <Tabs items={["npm", "yarn", "pnpm"]}>
        <Tabs.Tab>
          ```bash copy
          npm install @copilotkit/react-core @copilotkit/react-ui
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add @copilotkit/react-core @copilotkit/react-ui
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add @copilotkit/react-core @copilotkit/react-ui
          ```
        </Tabs.Tab>
      </Tabs>

      ## CopilotKit コンポーネントを作成

      React フロントエンドに CopilotKit コンポーネントを作成します:

      ```tsx filename="components/copilotkit-component.tsx" copy
      import { CopilotChat } from "@copilotkit/react-ui";
      import { CopilotKit } from "@copilotkit/react-core";
      import "@copilotkit/react-ui/styles.css";

      export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
        return (
          <CopilotKit
            runtimeUrl={runtimeUrl}
            agent="weatherAgent"
          >
            <CopilotChat
              labels={{
                title: "Your Assistant",
                initial: "Hi! 👋 How can I assist you today?",
              }}
            />
          </CopilotKit>
        );
      }
      ```

      ## 依存関係をインストール

      まだ Mastra サーバーをセットアップしていない場合は、[クイックスタートガイド](/docs/getting-started/installation)に従って新しい Mastra プロジェクトを作成してください。

      Mastra サーバー側で、CopilotKit 連携用の追加パッケージをインストールします:

      <Tabs items={["npm", "yarn", "pnpm"]}>
        <Tabs.Tab>
          ```bash copy
          npm install @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>
      </Tabs>

      ## Mastra サーバーを構成

      CopilotKit のランタイムエンドポイントを含めるように Mastra インスタンスを構成します:

      ```typescript filename="src/mastra/index.ts" copy {2,5-8,12-28}
      import { Mastra } from "@mastra/core/mastra";
      import { registerCopilotKit } from "@ag-ui/mastra/copilotkit";
      import { weatherAgent } from "./agents/weather-agent";

      type WeatherRuntimeContext = {
        "user-id": string;
        "temperature-scale": "celsius" | "fahrenheit";
      };

      export const mastra = new Mastra({
        agents: { weatherAgent },
        server: {
          cors: {
            origin: "*",
            allowMethods: ["*"],
            allowHeaders: ["*"]
          },
          apiRoutes: [
            registerCopilotKit<WeatherRuntimeContext>({
              path: "/copilotkit",
              resourceId: "weatherAgent",
              setContext: (c, runtimeContext) => {
                runtimeContext.set("user-id", c.req.header("X-User-ID") || "anonymous");
                runtimeContext.set("temperature-scale", "celsius");
              }
            })
          ]
        }
      });
      ```

      ## React アプリでの使用

      Mastra サーバーの URL を指定して、React アプリでこのコンポーネントを使用します:

      ```tsx filename="App.tsx" copy {5}
      import { CopilotKitComponent } from "./components/copilotkit-component";

      function App() {
        return (
          <CopilotKitComponent runtimeUrl="http://localhost:4111/copilotkit" />
        );
      }

      export default App;
      ```

      これで、Mastra サーバーとフロントエンドの両方を起動してください。
    </Steps>
  </Tabs.Tab>

  <Tabs.Tab>
    <Steps>
      ## 依存関係のインストール

      Next.jsアプリに、必要なパッケージをインストールします:

      <Tabs items={["npm", "yarn", "pnpm"]}>
        <Tabs.Tab>
          ```bash copy
          npm install @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>
      </Tabs>

      ## CopilotKitコンポーネントの作成 [#full-stack-nextjs-create-copilotkit-component]

      CopilotKitコンポーネントを作成する:

      ```tsx filename="components/copilotkit-component.tsx" copy
      'use client';
      import { CopilotChat } from "@copilotkit/react-ui";
      import { CopilotKit } from "@copilotkit/react-core";
      import "@copilotkit/react-ui/styles.css";

      export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
        return (                                                       y
          <CopilotKit
            runtimeUrl={runtimeUrl}
            agent="weatherAgent"
          >
            <CopilotChat
              labels={{
                title: "アシスタント",
                initial: "こんにちは!👋 今日はどうされましたか?",
              }}
            />
          </CopilotKit>
        );
      }
      ```

      ## APIルートを作成する

      Next.jsアプリケーションへのMastraの統合方法に応じて、APIルートには2つのアプローチがあります。

      1. アプリに Mastra のインスタンスが統合されたフルスタックの Next.js アプリ向け。
      2. 別個の Mastra サーバーと Mastra Client SDK を利用する Next.js アプリの場合。

      <Tabs items={["With a Mastra instance", "With the Mastra Client SDK"]}>
        <Tabs.Tab>
          ローカルの Mastra エージェントに接続する API ルートを作成します。

          ```typescript filename="app/api/copilotkit/route.ts" copy {1-7,11-26}
          import { mastra } from "../../mastra";
          import {
            CopilotRuntime,
            ExperimentalEmptyAdapter,
            copilotRuntimeNextJSAppRouterEndpoint,
          } from "@copilotkit/runtime";
          import { MastraAgent } from "@ag-ui/mastra";
          import { NextRequest } from "next/server";

          export const POST = async (req: NextRequest) => {
            const mastraAgents = MastraAgent.getLocalAgents({
              mastra,
              agentId: "weatherAgent",
            });

            const runtime = new CopilotRuntime({
              agents: mastraAgents,
            });

            const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
              runtime,
              serviceAdapter: new ExperimentalEmptyAdapter(),
              endpoint: "/api/copilotkit",
            });

            return handleRequest(req);
          };
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ## Mastra Client SDK をインストール

          Mastra Client SDK をインストールします。

          <Tabs items={["npm", "yarn", "pnpm"]}>
            <Tabs.Tab>
              ```bash copy
              npm install @mastra/client-js
              ```
            </Tabs.Tab>

            <Tabs.Tab>
              ```bash copy
              yarn add @mastra/client-js
              ```
            </Tabs.Tab>

            <Tabs.Tab>
              ```bash copy
               pnpm add @mastra/client-js
              ```
            </Tabs.Tab>
          </Tabs>

          リモートの Mastra エージェントに接続する API ルートを作成します。

          ```typescript filename="app/api/copilotkit/route.ts" copy {1-7,12-26}
          import { MastraClient } from "@mastra/client-js";
          import {
            CopilotRuntime,
            ExperimentalEmptyAdapter,
            copilotRuntimeNextJSAppRouterEndpoint,
          } from "@copilotkit/runtime";
          import { MastraAgent } from "@ag-ui/mastra";
          import { NextRequest } from "next/server";

          export const POST = async (req: NextRequest) => {
            const baseUrl = process.env.MASTRA_BASE_URL || "http://localhost:4111";
            const mastraClient = new MastraClient({ baseUrl });

            const mastraAgents = await MastraAgent.getRemoteAgents({ mastraClient });

            const runtime = new CopilotRuntime({
              agents: mastraAgents,
            });

            const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
              runtime,
              serviceAdapter: new ExperimentalEmptyAdapter(),
              endpoint: "/api/copilotkit",
            });

            return handleRequest(req);
          };
          ```
        </Tabs.Tab>
      </Tabs>

      ## コンポーネントを使用する

      ローカルAPIエンドポイントでコンポーネントを使用する:

      ```tsx filename="App.tsx" copy {5}
      import { CopilotKitComponent } from "./components/copilotkit-component";

      function App() {
        return (
          <CopilotKitComponent runtimeUrl="/api/copilotkit" />
        );
      }

      export default App;
      ```
    </Steps>
  </Tabs.Tab>
</Tabs>

未来を築き始めよう！

<br />

<Image
  className="rounded-lg"
  src="/image/copilotkit/cpkoutput.jpg"
  alt="CopilotKitの出力"
  width={700}
  height={700}
/>

## 次のステップ

- [CopilotKit Documentation](https://docs.copilotkit.ai) - CopilotKit の包括的なリファレンス
- [React Hooks with CopilotKit](https://docs.copilotkit.ai/reference/hooks/useCoAgent) - React の高度な統合パターン
- [Next.js Integration with Mastra](/docs/frameworks/web-frameworks/next-js) - フルスタックの Next.js セットアップガイド