---
title: "エージェント概要 | エージェント ドキュメント | Mastra"
description: Mastra におけるエージェントの概要。エージェントの機能や、ツール、ワークフロー、外部システムとの連携方法について解説します。
---

import { Steps } from "nextra/components";



# エージェントの使用

エージェントを使用すると、言語モデルを活用して意思決定を行い、アクションを実行できるインテリジェントなアシスタントを構築できます。各エージェントには必須の指示とLLMがあり、オプションでツールとメモリを持ちます。

エージェントは会話を調整し、必要に応じてツールを呼び出し、メモリを通じてコンテキストを維持し、やり取りに応じた応答を生成します。エージェントは単独で動作することも、より大きなワークフローの一部として機能することもできます。

![Agents overview](/image/agents/agents-overview.jpg)

エージェントを作成するには：

- `Agent`クラスで**指示**を定義し、使用する**LLM**を設定します。
- オプションで**ツール**と**メモリ**を設定して機能を拡張します。
- エージェントを実行して応答を生成します。ストリーミング、構造化出力、動的設定をサポートしています。

このアプローチは型安全性とランタイム検証を提供し、すべてのエージェントのやり取りにおいて信頼性の高い動作を保証します。

> **📹 視聴**：  → エージェントの紹介とワークフローとの比較 [YouTube（7分）](https://youtu.be/0jg2g3sNvgw)



## はじめに

エージェントを使用するには、必要な依存関係をインストールします：

```bash
npm install @mastra/core @ai-sdk/openai
```

> MastraはすべてのAI SDKプロバイダーに対応しています。詳細については[モデルプロバイダー](../getting-started/model-providers.mdx)をご覧ください。

エージェントモジュールから必要なクラスとLLMプロバイダーをインポートします：

```typescript filename="src/mastra/agents/test-agent.ts" showLineNumbers copy
import { openai } from "@ai-sdk/openai";
import { Agent } from "@mastra/core/agent";
```
### LLMプロバイダー

各LLMプロバイダーには、プロバイダーの識別子を使用して命名された専用のAPIキーが必要です：

```bash filename=".env" copy
OPENAI_API_KEY=<your-api-key>
```

> Vercel AI SDKドキュメントの[AI SDKプロバイダー](https://ai-sdk.dev/providers/ai-sdk-providers)をご覧ください。

### エージェントの作成

Mastraでエージェントを作成するには、`Agent`クラスを使用します。すべてのエージェントには、動作を定義する`instructions`と、LLMプロバイダーとモデルを指定する`model`パラメータが必要です：

```typescript filename="src/mastra/agents/test-agent.ts" showLineNumbers copy
import { openai } from "@ai-sdk/openai";
import { Agent } from "@mastra/core/agent";

export const testAgent = new Agent({
  name: "test-agent",
  instructions: "You are a helpful assistant.",
  model: openai("gpt-4o-mini")
});
```

> 詳細については[エージェント](../../reference/agents/agent.mdx)をご覧ください。


### エージェントの登録

Mastraインスタンスにエージェントを登録します：

```typescript showLineNumbers filename="src/mastra/index.ts" copy
import { Mastra } from "@mastra/core/mastra";
import { testAgent } from './agents/test-agent';

export const mastra = new Mastra({
  // ...
  agents: { testAgent },
});
```



## エージェントの参照

ワークフローステップ、ツール、Mastraクライアント、またはコマンドラインからエージェントを呼び出すことができます。セットアップに応じて、`mastra`または`mastraClient`インスタンスの`.getAgent()`を呼び出して参照を取得します：

```typescript showLineNumbers copy
const testAgent = mastra.getAgent("testAgent");
```

> 詳細については、[エージェントの呼び出し](../../examples/agents/calling-agents.mdx)を参照してください。



## レスポンスの生成

エージェントからレスポンスを取得するには`.generate()`を使用します。シンプルなプロンプトには単一の文字列を、複数のコンテキストを提供する場合は文字列の配列を、ロールと会話フローを正確に制御する場合は`role`と`content`を含むメッセージオブジェクトの配列を渡します。

> 詳細については[.generate()](../../reference/agents/generate.mdx)を参照してください。

### テキストの生成

`role`と`content`を含むメッセージオブジェクトの配列を使用して`.generate()`を呼び出します：

```typescript showLineNumbers copy
const response = await testAgent.generate([
  { role: "user", content: "一日のスケジュールを整理するのを手伝って" },
  { role: "user", content: "私の一日は午前9時に始まり、午後5時30分に終わります" },
  { role: "user", content: "昼食は12時30分から13時30分の間に取ります" },
  { role: "user", content: "月曜日から金曜日まで10時30分から11時30分の間に会議があります" }
]);

console.log(response.text);
```



## ストリーミングレスポンス

リアルタイムレスポンスには`.stream()`を使用します。シンプルなプロンプトには単一の文字列を、複数のコンテキストを提供する場合は文字列の配列を、ロールと会話フローを正確に制御する場合は`role`と`content`を含むメッセージオブジェクトの配列を渡します。

> 詳細については[.stream()](../../reference/agents/stream.mdx)を参照してください。

### テキストのストリーミング

`role`と`content`を含むメッセージオブジェクトの配列で`.stream()`を呼び出します：

```typescript showLineNumbers copy
const stream = await testAgent.stream([
  { role: "user", content: "Help me organize my day" },
  { role: "user", content: "My day starts at 9am and finishes at 5.30pm" },
  { role: "user", content: "I take lunch between 12:30 and 13:30" },
  { role: "user", content: "I have meetings Monday to Friday between 10:30 and 11:30" }
]);

for await (const chunk of stream.textStream) {
  process.stdout.write(chunk);
}
```

### `onFinish()`を使用した完了処理

ストリーミングレスポンス使用時、`onFinish()`コールバックはLLMがレスポンスの生成を完了し、すべてのツール実行が完了した後に実行されます。
最終的な`text`、実行`steps`、`finishReason`、トークン`usage`統計、およびモニタリングやログ記録に有用なその他のメタデータが提供されます。

```typescript showLineNumbers copy
const stream = await testAgent.stream("Help me organize my day", {
  onFinish: ({ steps, text, finishReason, usage }) => {
    console.log({ steps, text, finishReason, usage });
  }
});

for await (const chunk of stream.textStream) {
  process.stdout.write(chunk);
}
```



## 構造化出力

エージェントは、[Zod](https://zod.dev/) または [JSON Schema](https://json-schema.org/) で期待される出力を定義することで、型安全な構造化データを返すことができます。いずれの場合も、パース済みの結果は `response.object` に格納されており、検証済みかつ型情報付きのデータを直接扱えます。

### Zod の使用

[Zod](https://zod.dev/) を使って `output` のスキーマを定義します:

```typescript showLineNumbers copy
import { z } from "zod";

const response = await testAgent.generate(
  [
    {
      role: "system",
      content: "Provide a summary and keywords for the following text:"
    },
    {
      role: "user",
      content: "Monkey, Ice Cream, Boat"
    }
  ],
  {
    output: z.object({
      summary: z.string(),
      keywords: z.array(z.string())
    })
  }
);

console.log(response.object);
```

#### ツールを使うエージェント

ツールを使用するエージェントで構造化出力を生成するには、`experimental_output` プロパティを使用します:

```typescript {6} showLineNumbers copy
import { z } from "zod";

const response = await testAgent.generate(
  // ...
  {
    experimental_output: z.object({
      summary: z.string(),
      keywords: z.array(z.string())
    })
  }
);

console.log(response.object);
```



## 画像の説明

エージェントは、視覚的なコンテンツとその中に含まれるテキストの両方を処理することで、画像を分析し説明することができます。画像分析を有効にするには、`content`配列内で`type: 'image'`と画像URLを含むオブジェクトを渡します。画像コンテンツをテキストプロンプトと組み合わせることで、エージェントの分析を誘導することができます。

```typescript showLineNumbers copy
const response = await testAgent.generate([
  {
    role: "user",
    content: [
      {
        type: "image",
        image: "https://placebear.com/cache/395-205.jpg",
        mimeType: "image/jpeg"
      },
      {
        type: "text",
        text: "画像を詳細に説明し、画像内のすべてのテキストを抽出してください。"
      }
    ]
  }
]);

console.log(response.text);
```



## マルチステップツール使用

エージェントはツールによって機能を拡張できます。ツールとは、テキスト生成を超えてエージェントの能力を拡張する関数です。ツールを使用することで、エージェントは計算の実行、外部システムへのアクセス、データ処理が可能になります。エージェントは与えられたツールを呼び出すかどうかを判断するだけでなく、そのツールに渡すパラメータも決定します。

ツールの作成と設定に関する詳細なガイドについては、[ツール概要](../tools-mcp/overview.mdx)ページを参照してください。

### `maxSteps`の使用

`maxSteps`パラメータは、エージェントが実行できる連続したLLM呼び出しの最大数を制御します。これは特にツール呼び出しを使用する際に重要です。デフォルトでは、設定ミスのツールによる無限ループを防ぐために1に設定されています：

```typescript showLineNumbers copy
const response = await testAgent.generate("Help me organize my day", {
  maxSteps: 5
});

console.log(response.text);
```

### `onStepFinish`の使用

`onStepFinish`コールバックを使用して、マルチステップ操作の進行状況を監視できます。これはデバッグやユーザーへの進行状況更新に役立ちます。

`onStepFinish`は、ストリーミング時または構造化出力なしでテキストを生成する際にのみ利用可能です。

```typescript showLineNumbers copy
const response = await testAgent.generate("Help me organize my day", {
  onStepFinish: ({ text, toolCalls, toolResults, finishReason, usage }) => {
    console.log({ text, toolCalls, toolResults, finishReason, usage });
  }
});
```



## エージェントをローカルでテストする
エージェントを実行・テストする方法は2つあります。

<Steps>

### Mastra Playground

Mastra Dev Server を起動した状態で、ブラウザで [http://localhost:4111/agents](http://localhost:4111/agents) にアクセスすると、Mastra Playground からエージェントをテストできます。

> くわしくは、[Local Dev Playground](/docs/server-db/local-dev-playground) のドキュメントをご覧ください。

### コマンドライン

`.generate()` または `.stream()` を使ってエージェントのレスポンスを生成します。

```typescript {7} filename="src/test-agent.ts" showLineNumbers copy
import "dotenv/config";

import { mastra } from "./mastra";

const agent = mastra.getAgent("testAgent");

const response = await agent.generate("Help me organize my day");

console.log(response.text);
```

> くわしくは [.generate()](../../reference/agents/generate.mdx) または [.stream()](../../reference/agents/stream.mdx) を参照してください。

このエージェントをテストするには、次を実行します:

```bash copy
npx tsx src/test-agent.ts
```

</Steps>



## 関連項目

- [エージェントメモリ](./agent-memory.mdx)
- [ダイナミックエージェント](./dynamic-agents.mdx)
- [エージェントツールとMCP](./using-tools-and-mcp.mdx)
- [エージェントの呼び出し](../../examples/agents/calling-agents.mdx)
