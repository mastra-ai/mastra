---
title: "Agent Memory | Agents | Mastra ドキュメント"
description: エージェントにメモリを追加して会話履歴を保存し、やり取り全体でコンテキストを維持する方法を学びます。
---

import { Steps } from "nextra/components";


## エージェントのメモリ

エージェントは、インタラクション間のコンテキストを維持するためにメモリを使用します。LLMはステートレスで呼び出し間の情報を保持しないため、エージェントには会話履歴を追跡し、関連情報を想起するためのメモリが必要です。

Mastra のエージェントは会話履歴を保存するよう構成でき、直近のコンテキストを維持するためのオプションの[作業メモリ](../memory/working-memory)や、意味に基づいて過去のメッセージを検索・取得する[セマンティックリコール](../memory/semantic-recall)を利用できます。

## メモリを使用するタイミング

エージェントが、過去のやり取りを参照するマルチターンの会話を維持したり、同一セッション内で以前に示されたユーザーの好みや事実を想起したり、会話スレッドの中で時間をかけて文脈を構築したりする必要がある場合は、メモリを使用します。各やり取りが独立している単発（シングルターン）のリクエストでは、メモリは使用しないでください。

## メモリの設定

Mastraでメモリを有効化するには、ストレージプロバイダーとあわせて `@mastra/memory` パッケージをインストールします。

```bash npm2yarn copy
npm install @mastra/memory@latest @mastra/libsql@latest
```


## ストレージプロバイダー

Memory は、ユーザーのメッセージやエージェントの応答を含む会話履歴を保存するために、ストレージプロバイダーを必要とします。利用可能なプロバイダーや Mastra におけるストレージの仕組みについての詳細は、[Storage](../server-db/storage.mdx) ドキュメントをご参照ください。

## メモリの設定

<Steps>
  ### エージェントのメモリ

  `Memory` インスタンスを作成し、エージェントの `memory` オプションに渡してメモリを有効にします。

  ```typescript {6-9} filename="src/mastra/agents/memory-agent.ts" showLineNumbers copy
  import { Agent } from "@mastra/core/agent";
  import { Memory } from "@mastra/memory";

  export const memoryAgent = new Agent({
    // ...
    memory: new Memory({
      options: {
        lastMessages: 20
      }
    })
  });
  ```

  > すべての設定オプションについては [Memory クラス](../../reference/memory/Memory.mdx) を参照してください。

  ### Mastra のストレージ

  すべての設定済みエージェントでメモリを有効にするには、メインの Mastra インスタンスにストレージプロバイダーを追加します。

  ```typescript {6-8} filename="src/mastra/index.ts" showLineNumbers copy
  import { Mastra } from "@mastra/core/mastra";
  import { LibSQLStore } from "@mastra/libsql";

  export const mastra = new Mastra({
    // ..
    storage: new LibSQLStore({
      url: ":memory:"
    }),
  });
  ```

  > すべての設定オプションについては [LibSQL ストレージ](../../reference/storage/libsql.mdx) を参照してください。
</Steps>

または、データを分離したい場合やエージェントごとに異なるプロバイダーを使いたい場合は、ストレージをエージェントのメモリに直接追加します。

```typescript {7-10} filename="src/mastra/agents/memory-agent.ts" showLineNumbers copy
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const memoryAgent = new Agent({
  // ...
  memory: new Memory({
    storage: new LibSQLStore({
      url: ":memory:"
    })
  })
});
```


## 会話履歴

エージェントの呼び出し中に会話履歴を追跡するため、`resource` と `thread` の両方を含む `memory` オブジェクトを含めてください。

* `resource`: ユーザーまたはエンティティを表す安定した識別子。
* `thread`: 特定の会話やセッションを分離するための ID。

これらのフィールドは、エージェントがコンテキストを保存・取得する場所を示し、会話全体で持続しスレッドを認識したメモリを実現します。

```typescript {3-4}
const response = await memoryAgent.generate("私の好きな色は青です。覚えておいてください。", {
  memory: {
    thread: "user-123",
    resource: "test-123"
  }
});
```

メモリに保存された情報を再取得するには、元の会話で使用したのと同じ `resource` と `thread` の値でエージェントを呼び出してください。

```typescript {3-4}
const response = await memoryAgent.generate("私の好きな色は何ですか?", {
  memory: {
    thread: "user-123",
    resource: "test-123"
  }
});
```

詳しくは、[Memory](../memory/overview.mdx) のドキュメントをご覧ください。


## `RuntimeContext` の使用

[RuntimeContext](../server-db/runtime-context.mdx) を使うと、リクエストごとの値にアクセスできます。これにより、リクエストの状況に応じて、メモリやストレージの構成を条件付きで選択できます。

```typescript filename="src/mastra/agents/memory-agent.ts" showLineNumbers
export type UserTier = {
  "user-tier": "enterprise" | "pro";
};

const premiumMemory = new Memory({
 // ...
});

const standardMemory = new Memory({
  // ...
});

export const memoryAgent = new Agent({
  // ...
  memory: ({ runtimeContext }) => {
    const userTier = runtimeContext.get("user-tier") as UserTier["user-tier"];

    return userTier === "enterprise"
      ? premiumMemory
      : standardMemory;
  }
});
```

> 詳しくは[Runtime Context](../server-db/runtime-context.mdx)をご覧ください。


## 関連項目

- [ワーキングメモリ](../memory/working-memory.mdx)
- [セマンティックリコール](../memory/semantic-recall.mdx)
- [スレッドとリソース](../memory/threads-and-resources.mdx)
- [ランタイムコンテキスト](../server-db/runtime-context.mdx)