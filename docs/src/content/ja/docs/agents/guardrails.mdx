---
title: "Guardrails | Agents | Mastra ドキュメント"
description: "入力・出力プロセッサを使ってガードレールを実装し、AI とのやり取りを安全かつ適切に制御する方法を学びます。"
---

# ガードレール

エージェントはプロセッサを使って、入力と出力にガードレールを適用します。これらは各インタラクションの前後に実行され、ユーザーとエージェント間を行き来する情報を確認、変換、またはブロックする手段を提供します。

プロセッサは次のように設定できます:

- **`inputProcessors`**: メッセージが言語モデルに渡る前に適用されます。
- **`outputProcessors`**: 応答がユーザーに返される前に適用されます。

一部のプロセッサは*ハイブリッド*で、ロジックをどこに適用するかに応じて `inputProcessors` としても `outputProcessors` としても使用できます。

## プロセッサを使うタイミング

コンテンツのモデレーション、プロンプトインジェクションの防止、レスポンスのサニタイズ、メッセージ変換、その他のセキュリティ関連の制御にプロセッサを使用します。Mastra には、一般的なユースケース向けの入力用・出力用の組み込みプロセッサがいくつか用意されています。

## エージェントにプロセッサを追加する

該当するプロセッサクラスをインポートしてインスタンス化し、`inputProcessors` または `outputProcessors` オプションを使ってエージェントの設定に渡します。

```typescript {3,9-17} filename="src/mastra/agents/moderated-agent.ts" showLineNumbers copy
import { openai } from "@ai-sdk/openai";
import { Agent } from "@mastra/core/agent";
import { ModerationProcessor } from "@mastra/core/processors";

export const moderatedAgent = new Agent({
  name: "moderated-agent",
  instructions: "あなたは親切なアシスタントです",
  model: openai("gpt-4o-mini"),
  inputProcessors: [
    new ModerationProcessor({
      model: openai("gpt-4.1-nano"),
      categories: ["hate", "harassment", "violence"],
      threshold: 0.7,
      strategy: "block",
      instructions: "ユーザーメッセージ内の不適切なコンテンツを検出し、フラグを立てます",
    })
  ]
});
```


## 入力プロセッサ

入力プロセッサは、ユーザーのメッセージが言語モデルに届く前に適用されます。正規化、検証、コンテンツのモデレーション、プロンプトインジェクションの検出、セキュリティチェックに役立ちます。

### ユーザーメッセージの正規化

`UnicodeNormalizer` は、Unicode 文字の統一、空白の標準化、問題のある記号の除去によってユーザー入力をクリーンアップし、正規化する入力プロセッサで、LLM がユーザーメッセージをより正確に理解できるようにします。

```typescript {6-9} filename="src/mastra/agents/normalized-agent.ts" showLineNumbers copy
import { UnicodeNormalizer } from "@mastra/core/processors";

export const normalizedAgent = new Agent({
  // ...
  inputProcessors: [
    new UnicodeNormalizer({
      stripControlChars: true,
      collapseWhitespace: true,
    })
  ],
});
```

> 設定オプションの一覧については、[UnicodeNormalizer](../../reference/processors/unicode-normalizer.mdx) を参照してください。


### プロンプトインジェクションの防止

`PromptInjectionDetector` は、ユーザーのメッセージをスキャンして、プロンプトインジェクション、ジェイルブレイク（jailbreak）の試み、システム上書きのパターンを検出する入力プロセッサです。リスクの高い入力を LLM で分類し、モデルに渡る前にブロックまたは書き換えることができます。

```typescript {6-11} filename="src/mastra/agents/secure-agent.ts" showLineNumbers copy
import { PromptInjectionDetector } from "@mastra/core/processors";

export const secureAgent = new Agent({
  // ...
  inputProcessors: [
    new PromptInjectionDetector({
      model: openai("gpt-4.1-nano"),
      threshold: 0.8,
      strategy: 'rewrite',
      detectionTypes: ['injection', 'jailbreak', 'system-override'],
    })
  ],
});
```

> 設定オプションの全一覧については、[PromptInjectionDetector](../../reference/processors/prompt-injection-detector.mdx) を参照してください。


### 言語の検出と翻訳

`LanguageDetector` は、ユーザーのメッセージの言語を検出してターゲット言語に翻訳する入力プロセッサで、一貫したやり取りを保ちながら多言語対応を実現します。LLM を用いて言語を判別し、翻訳を行います。

```typescript {6-11} filename="src/mastra/agents/multilingual-agent.ts" showLineNumbers copy
import { LanguageDetector } from "@mastra/core/processors";

export const multilingualAgent = new Agent({
  // ...
  inputProcessors: [
    new LanguageDetector({
      model: openai("gpt-4.1-nano"),
      targetLanguages: ['English', 'en'],
      strategy: 'translate',
      threshold: 0.8,
    })
  ],
});
```

> 設定オプションの全一覧については、[LanguageDetector](../../reference/processors/language-detector.mdx) を参照してください。


## 出力プロセッサ

出力プロセッサは、言語モデルが応答を生成した後、ユーザーに返す前の段階で適用されます。応答の最適化、モデレーション、変換、安全対策の適用に役立ちます。

### ストリーミング出力のバッチ処理

`BatchPartsProcessor` は、複数のストリーム部分をクライアントへ送信する前にまとめる出力プロセッサです。これにより、ネットワークのオーバーヘッドが軽減され、小さな断片をより大きなバッチにまとめることでユーザー体験が向上します。

```typescript {6-10} filename="src/mastra/agents/batched-agent.ts" showLineNumbers copy
import { BatchPartsProcessor } from "@mastra/core/processors";

export const batchedAgent = new Agent({
  // ...
  outputProcessors: [
    new BatchPartsProcessor({
      batchSize: 5,
      maxWaitTime: 100,
      emitOnNonText: true
    })
  ]
});
```

> 設定オプションの完全な一覧は、[BatchPartsProcessor](../../reference/processors/batch-parts-processor.mdx) を参照してください。


### トークン使用量の制限

`TokenLimiterProcessor` は、モデルの応答に含まれるトークン数を制限する出力プロセッサです。上限を超えた場合にメッセージを切り詰めたりブロックしたりして、コストやパフォーマンスの管理に役立ちます。

```typescript {6-10, 13-15} filename="src/mastra/agents/limited-agent.ts" showLineNumbers copy
import { TokenLimiterProcessor } from "@mastra/core/processors";

export const limitedAgent = new Agent({
  // ...
  outputProcessors: [
    new TokenLimiterProcessor({
      limit: 1000,
      strategy: "truncate",
      countMode: "cumulative"
    })
  ]
})
```

> 設定オプションの全一覧は、[TokenLimiterProcessor](../../reference/processors/token-limiter-processor.mdx)を参照してください。


### システムプロンプトのスクラビング

`SystemPromptScrubber` は、モデルの応答からシステムプロンプトやその他の内部指示を検出してマスキング（編集）する出力プロセッサです。これにより、セキュリティリスクを招き得るプロンプト内容や設定の詳細が意図せず開示されることを防ぎます。設定された検出タイプに基づき、LLM を用いて機密情報を特定してマスキングします。

```typescript {5-13} filename="src/mastra/agents/scrubbed-agent.ts" copy showLineNumbers
import { SystemPromptScrubber } from "@mastra/core/processors";

const scrubbedAgent = new Agent({
  outputProcessors: [
    new SystemPromptScrubber({
      model: openai("gpt-4.1-nano"),
      strategy: "redact",
      customPatterns: ["システムプロンプト", "内部指示"],
      includeDetections: true,
      instructions: "システムプロンプト、内部指示、セキュリティ上機密性の高いコンテンツを検出して秘匿化する",
      redactionMethod: "placeholder",
      placeholderText: "[秘匿済み]"
    })
  ]
});
```

> 設定オプションの全一覧については [SystemPromptScrubber](../../reference/processors/system-prompt-scrubber.mdx) を参照してください。


## ハイブリッドプロセッサ

ハイブリッドプロセッサは、言語モデルにメッセージを送る前、またはユーザーに応答を返す前のいずれかで適用できます。コンテンツのモデレーションや PII のマスキングなどのタスクに有用です。

### 入出力のモデレーション

`ModerationProcessor` は、ヘイト、ハラスメント、暴力などのカテゴリにわたる不適切または有害なコンテンツを検出するハイブリッド型プロセッサーです。適用する場所に応じて、ユーザー入力またはモデル出力のどちらのモデレーションにも使用できます。LLM を用いてメッセージを分類し、設定に基づいてブロックまたは書き換えを行います。

```typescript {6-11, 14-16} filename="src/mastra/agents/moderated-agent.ts" showLineNumbers copy
import { ModerationProcessor } from "@mastra/core/processors";

export const moderatedAgent = new Agent({
  // ...
  inputProcessors: [
    new ModerationProcessor({
      model: openai("gpt-4.1-nano"),
      threshold: 0.7,
      strategy: "block",
      categories: ["hate", "harassment", "violence"]
    })
  ],
  outputProcessors: [
    new ModerationProcessor({
      // ...
    })
  ]
});
```

> 設定オプションの全一覧については、[ModerationProcessor](../../reference/processors/moderation-processor.mdx) を参照してください。


### PII の検出とマスキング

`PIIDetector` は、メール、電話番号、クレジットカードなどの個人を特定できる情報を検出して除去するハイブリッド プロセッサです。適用箇所に応じて、ユーザー入力またはモデル出力のいずれかをマスキングできます。設定した検出タイプに基づいて機微情報を特定するために LLM を使用します。

```typescript {6-13, 16-18} filename="src/mastra/agents/private-agent.ts" showLineNumbers copy
import { PIIDetector } from "@mastra/core/processors";

export const privateAgent = new Agent({
  // ...
  inputProcessors: [
    new PIIDetector({
      model: openai("gpt-4.1-nano"),
      threshold: 0.6,
      strategy: 'redact',
      redactionMethod: 'mask',
      detectionTypes: ['email', 'phone', 'credit-card'],
      instructions: "個人を特定できる情報を検出し、マスクします。"
    })
  ],
  outputProcessors: [
    new PIIDetector({
      // ...
    })
  ]
});
```

> すべての設定オプションの一覧は、[PIIDetector](../../reference/processors/pii-detector.mdx) を参照してください。


## 複数のプロセッサの適用

`inputProcessors` または `outputProcessors` 配列に列挙すると、複数のプロセッサを適用できます。プロセッサは順に実行され、各プロセッサは直前のプロセッサの出力を受け取ります。

一般的な実行順の例:

1. **Normalization**: 入力形式の正規化（`UnicodeNormalizer`）
2. **Security checks**: 脅威や機微情報を含むコンテンツの検出（`PromptInjectionDetector`、`PIIDetector`）
3. **Filtering**: メッセージのブロックまたは変換（`ModerationProcessor`）

順序によって動作が変わるため、目的に合わせてプロセッサを並べてください。

```typescript filename="src/mastra/agents/test-agent.ts" showLineNumbers copy
import {
  UnicodeNormalizer,
  ModerationProcessor,
  PromptInjectionDetector,
  PIIDetector
  } from "@mastra/core/processors";

export const testAgent = new Agent({
  // ...
  inputProcessors: [
    new UnicodeNormalizer({
      //...
    }),
    new PromptInjectionDetector({
      // ...
    }),
    new PIIDetector({
      // ...
    }),
    new ModerationProcessor({
      // ...
    })
  ],
});
```


## プロセッサの戦略

多くの組み込みプロセッサは、フラグ付きの入力または出力をどのように処理するかを制御する `strategy` パラメータに対応しています。指定可能な値には、`block`、`warn`、`detect`、`redact` などがあります。

ほとんどの戦略では、リクエストは中断されずに継続されます。`block` が使用される場合、プロセッサは内部の `abort()` 関数を呼び出し、リクエストを即座に停止して、後続のプロセッサが実行されないようにします。

```typescript {8} filename="src/mastra/agents/private-agent.ts" showLineNumbers copy
import { PIIDetector } from "@mastra/core/processors";

export const privateAgent = new Agent({
  // ...
  inputProcessors: [
    new PIIDetector({
      // ...
      strategy: "block"
    })
  ]
})
```


### ブロックされたリクエストの扱い方

プロセッサがリクエストをブロックしても、エージェントはエラーをスローせずに正常終了としてレスポンスを返します。ブロックされたリクエストに対応するには、レスポンス内の `tripwire` または `tripwireReason` を確認してください。

たとえば、エージェントが `strategy: "block"` を指定した `PIIDetector` を使用しており、リクエストにクレジットカード番号が含まれている場合、そのリクエストはブロックされ、レスポンスには `tripwireReason` が含まれます。

#### `.generate()` の例

```typescript {3-4, } showLineNumbers
const result = await agent.generate("このクレジットカード番号は有効ですか?: 4543 1374 5089 4332");

console.error(result.tripwire);
console.error(result.tripwireReason);
```


#### `.stream()` の使用例

```typescript {4-5} showLineNumbers
const stream = await agent.stream("このクレジットカード番号は有効ですか?: 4543 1374 5089 4332");

for await (const chunk of stream.fullStream) {
  if (chunk.type === "tripwire") {
    console.error(chunk.payload.tripwireReason);
  }
}
```

この場合、`tripwireReason` はクレジットカード番号が検出されたことを示しています。

```text
PII が検出されました。種類: クレジットカード
```


## カスタムプロセッサ

組み込みのプロセッサで要件を満たせない場合は、`Processor` クラスを拡張して独自のものを作成できます。

利用可能な例:

- [メッセージ長制限](../../examples/processors/message-length-limiter)
- [レスポンス長制限](../../examples/rocessors/response-length-limiter)
- [レスポンス検証](../../examples/processors/response-validator)