---
title: "Cloudflare D1 ストレージ | ストレージシステム | Mastra Core"
description: Mastra における Cloudflare D1 SQL ストレージ実装のドキュメントです。
---

# Cloudflare D1 ストレージ

Cloudflare D1 ストレージの実装は、Cloudflare D1 を用いたサーバーレスの SQL データベースソリューションを提供し、リレーショナルな操作とトランザクション整合性をサポートします。

## インストール

```bash
npm install @mastra/cloudflare-d1@latest
```


## 使い方

```typescript copy showLineNumbers
import { D1Store } from "@mastra/cloudflare-d1";

type Env = {
  // ここにバインディングを追加します。例: Workers KV、D1、Workers AI など
  D1Database: D1Database;
};

// --- Example 1: Using Workers Binding ---
const storageWorkers = new D1Store({
  binding: D1Database, // Workers ランタイムで提供される D1Database バインディング
  tablePrefix: "dev_", // 任意: 環境ごとにテーブルを分離
});

// --- 例 2: REST API を使用 ---
const storageRest = new D1Store({
  accountId: process.env.CLOUDFLARE_ACCOUNT_ID!, // Cloudflare アカウント ID
  databaseId: process.env.CLOUDFLARE_D1_DATABASE_ID!, // D1 データベース ID
  apiToken: process.env.CLOUDFLARE_API_TOKEN!, // Cloudflare API トークン
  tablePrefix: "dev_", // 任意: 環境ごとにテーブルを分離
});
```

次の内容を `wrangler.toml` または `wrangler.jsonc` ファイルに追加してください:

```
[[d1_databases]]
binding = "D1Database"
database_name = "db-name"
database_id = "db-id"
```


## パラメータ

<PropertiesTable
  content={[
    {
      name: "binding",
      type: "D1Database",
      description: "Cloudflare D1 の Workers バインディング（Workers ランタイム用）",
      isOptional: true,
    },
    {
      name: "accountId",
      type: "string",
      description: "Cloudflare アカウント ID（REST API 用）",
      isOptional: true,
    },
    {
      name: "databaseId",
      type: "string",
      description: "Cloudflare D1 データベース ID（REST API 用）",
      isOptional: true,
    },
    {
      name: "apiToken",
      type: "string",
      description: "Cloudflare API トークン（REST API 用）",
      isOptional: true,
    },
    {
      name: "tablePrefix",
      type: "string",
      description:
        "すべてのテーブル名に付与する任意の接頭辞（環境分離に便利）",
      isOptional: true,
    },
  ]}
/>

## 追記

### スキーマ管理

ストレージ実装はスキーマの作成と更新を自動的に行います。以下のテーブルを作成します:

- `threads`: 会話スレッドを保存
- `messages`: 個々のメッセージを保存
- `metadata`: スレッドとメッセージに関する追加のメタデータを保存

### トランザクションと一貫性

Cloudflare D1 は、単一行の操作に対してトランザクションの保証を提供します。これは、複数の操作を「すべて成功するか、すべて失敗するか」という不可分の作業単位として実行できることを意味します。

### テーブル作成とマイグレーション

テーブルはストレージの初期化時に自動的に作成されます（`tablePrefix` オプションを使えば、環境ごとに分離できます）。ただし、列の追加、データ型の変更、インデックスの変更といった高度なスキーマ変更には、データ損失を避けるための慎重な計画と手動でのマイグレーションが必要です。