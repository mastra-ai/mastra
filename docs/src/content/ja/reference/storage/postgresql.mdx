---
title: "PostgreSQL ストレージ | ストレージ システム | Mastra Core"
description: Mastra における PostgreSQL ストレージ実装のドキュメントです。
---

# PostgreSQL ストレージ

PostgreSQL のストレージ実装は、PostgreSQL データベースを用いた本番運用向けのストレージソリューションを提供します。

## インストール

```bash copy
npm install @mastra/pg@latest
```


## 使い方

```typescript copy showLineNumbers
import { PostgresStore } from "@mastra/pg";

const storage = new PostgresStore({
  connectionString: process.env.DATABASE_URL,
});
```


## パラメータ

<PropertiesTable
  content={[
    {
      name: "connectionString",
      type: "string",
      description:
        "PostgreSQL の接続文字列（例：postgresql://user:pass@host:5432/dbname）",
      isOptional: false,
    },
    {
      name: "schemaName",
      type: "string",
      description:
        "ストレージで使用するスキーマ名。指定しない場合は既定のスキーマが使用されます。",
      isOptional: true,
    },
  ]}
/>

## コンストラクターの例

`PostgresStore` は次の方法でインスタンス化できます。

```ts
import { PostgresStore } from "@mastra/pg";

// 接続文字列のみを使用
const store1 = new PostgresStore({
  connectionString: "postgresql://user:password@localhost:5432/mydb",
});

// カスタムスキーマ名を指定した接続文字列を使用
const store2 = new PostgresStore({
  connectionString: "postgresql://user:password@localhost:5432/mydb",
  schemaName: "custom_schema", // 省略可
});

// 個別の接続パラメーターを使用
const store4 = new PostgresStore({
  host: "localhost",
  port: 5432,
  database: "mydb",
  user: "user",
  password: "password",
});

// schemaName を指定した個別パラメーター
const store5 = new PostgresStore({
  host: "localhost",
  port: 5432,
  database: "mydb",
  user: "user",
  password: "password",
  schemaName: "custom_schema", // 省略可
});
```


## 追記

### スキーマ管理

ストレージの実装は、スキーマの作成と更新を自動的に行います。次のテーブルを作成します:

- `mastra_workflow_snapshot`: ワークフローの状態と実行データを保存
- `mastra_evals`: 評価結果とメタデータを保存  
- `mastra_threads`: 会話スレッドを保存
- `mastra_messages`: 個々のメッセージを保存
- `mastra_traces`: テレメトリおよびトレースデータを保存
- `mastra_scorers`: スコアリングおよび評価データを保存
- `mastra_resources`: リソースのワーキングメモリデータを保存

### データベースおよびプールへの直接アクセス

`PostgresStore` は、基盤となるデータベースオブジェクトと pg-promise インスタンスの両方をパブリックフィールドとして公開します。

```typescript
store.db  // pg-promise のデータベース インスタンス
store.pgp // pg-promise のメイン インスタンス
```

これにより、直接クエリの実行とカスタムなトランザクション管理が可能になります。これらのフィールドを使用する場合は次の点に注意してください:

* 接続およびトランザクションの適切な取り扱いは利用者の責任です。
* ストアを閉じる（`store.close()`）と、対応する接続プールが破棄されます。
* 直接アクセスすると、PostgresStore のメソッドが提供する追加のロジックや検証を迂回します。

この方法は、低レベルなアクセスが必要となる上級者向けのシナリオを想定しています。


## インデックス管理

PostgreSQL のストレージは、クエリ性能を最適化するための充実したインデックス管理機能を提供します。

### 自動パフォーマンスインデックス

PostgreSQL ストレージは、一般的なクエリパターンに合わせて、初期化時に複合インデックスを自動で作成します:

- `mastra_threads_resourceid_createdat_idx`: (resourceId, createdAt DESC)
- `mastra_messages_thread_id_createdat_idx`: (thread_id, createdAt DESC)  
- `mastra_traces_name_starttime_idx`: (name, startTime DESC)
- `mastra_evals_agent_name_created_at_idx`: (agent_name, created_at DESC)

これらのインデックスは、ソートを伴うフィルタ済みクエリの性能を大幅に向上させます。

### カスタムインデックスの作成

特定のクエリパターンを最適化するために、追加のインデックスを作成します。

```typescript copy
// 一般的なクエリ向けの基本インデックス
await storage.createIndex({
  name: 'idx_threads_resource',
  table: 'mastra_threads',
  columns: ['resourceId']
});

// フィルタと並び替えのためのソート順付き複合インデックス
await storage.createIndex({
  name: 'idx_messages_composite',
  table: 'mastra_messages',
  columns: ['thread_id', 'createdAt DESC']
});

// JSONB 列向けの GIN インデックス（JSON クエリを高速化）
await storage.createIndex({
  name: 'idx_traces_attributes',
  table: 'mastra_traces',
  columns: ['attributes'],
  method: 'gin'
});
```

より高度なユースケースでは、次のように指定できます:

* `unique: true` 一意制約の指定
* `where: 'condition'` 部分インデックスの指定
* `method: 'brin'` 時系列データ向けの指定
* `storage: { fillfactor: 90 }` 更新が多いテーブル向けの指定
* `concurrent: true` ブロックしない作成（デフォルト）


### インデックスのオプション

<PropertiesTable
  content={[
    {
      name: "name",
      type: "string",
      description: "インデックスの一意名",
      isOptional: false,
    },
    {
      name: "table",
      type: "string",
      description: "テーブル名（例: 'mastra_threads'）",
      isOptional: false,
    },
    {
      name: "columns",
      type: "string[]",
      description: "（任意のソート順付きの）列名の配列（例: ['id', 'createdAt DESC']）",
      isOptional: false,
    },
    {
      name: "unique",
      type: "boolean",
      description: "一意制約付きインデックスを作成",
      isOptional: true,
    },
    {
      name: "concurrent",
      type: "boolean",
      description: "テーブルをロックせずにインデックスを作成（デフォルト: true）",
      isOptional: true,
    },
    {
      name: "where",
      type: "string",
      description: "部分インデックスの条件（PostgreSQL 固有）",
      isOptional: true,
    },
    {
      name: "method",
      type: "'btree' | 'hash' | 'gin' | 'gist' | 'spgist' | 'brin'",
      description: "インデックス方式（デフォルト: 'btree'）",
      isOptional: true,
    },
    {
      name: "opclass",
      type: "string",
      description: "GIN/GIST インデックスの演算子クラス",
      isOptional: true,
    },
    {
      name: "storage",
      type: "Record<string, any>",
      description: "ストレージパラメータ（例: { fillfactor: 90 }）",
      isOptional: true,
    },
    {
      name: "tablespace",
      type: "string",
      description: "インデックス配置先のテーブルスペース名",
      isOptional: true,
    }
  ]}
/>

### インデックスの管理

既存のインデックスを一覧表示して監視する:

```typescript copy
// すべてのインデックスを一覧
const allIndexes = await storage.listIndexes();
console.log(allIndexes);
// [
//   {
//     name: 'mastra_threads_pkey',
//     table: 'mastra_threads',
//     columns: ['id'],
//     unique: true,
//     size: '16 KB',
//     definition: 'CREATE UNIQUE INDEX...'
//   },
//   ...
// ]

// 特定のテーブルのインデックスを一覧
const threadIndexes = await storage.listIndexes('mastra_threads');

// インデックスの詳細統計を取得
const stats = await storage.describeIndex('idx_threads_resource');
console.log(stats);
// {
//   name: 'idx_threads_resource',
//   table: 'mastra_threads',
//   columns: ['resourceId', 'createdAt'],
//   unique: false,
//   size: '128 KB',
//   definition: 'CREATE INDEX idx_threads_resource...',
//   method: 'btree',
//   scans: 1542,           // インデックススキャン回数
//   tuples_read: 45230,    // インデックス経由で読み込まれたタプル数
//   tuples_fetched: 12050  // インデックス経由で取得されたタプル数
// }

// インデックスをドロップ
await storage.dropIndex('idx_threads_status');
```


### スキーマ特有のインデックス

カスタムスキーマを使用する場合、インデックスはスキーマのプレフィックス付きで作成されます。

```typescript copy
const storage = new PostgresStore({
  connectionString: process.env.DATABASE_URL,
  schemaName: 'custom_schema'
});

// インデックスは次のように作成されます: custom_schema_idx_threads_status
await storage.createIndex({
  name: 'idx_threads_status',
  table: 'mastra_threads',
  columns: ['status']
});
```


### インデックスの種類とユースケース

PostgreSQL には、特定の用途に最適化されたさまざまなインデックス型があります:

| インデックス種別 | 適した用途 | ストレージ | 速度 |
|------------|----------|---------|-------|
| **btree** (デフォルト) | 範囲検索、並べ替え、汎用 | 中程度 | 高速 |
| **hash** | 等価比較のみ | 小 | `=` に対して非常に高速 |
| **gin** | JSONB、配列、全文検索 | 大 | 包含クエリに高速 |
| **gist** | 幾何データ、全文検索 | 中程度 | 最近傍検索に高速 |
| **spgist** | 不均衡データ、テキストパターン | 小 | 特定のパターンに高速 |
| **brin** | 自然な順序を持つ大規模テーブル | 非常に小 | 範囲クエリに高速 |