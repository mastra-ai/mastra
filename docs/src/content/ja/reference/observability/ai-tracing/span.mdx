---
title: "Span | AI トレーシング | リファレンス"
description: Span のインターフェース、メソッド、ライフサイクルイベント
---

import { PropertiesTable } from "@/components/properties-table";


# span

## BaseSpan

すべてのスパン型に共通する基本インターフェース。

```typescript
interface BaseSpan<TType extends AISpanType> {
  /** 一意のスパン識別子 */
  id: string;
  
  /** OpenTelemetry互換のトレースID（32文字の16進数） */
  traceId: string;
  
  /** スパンの名前 */
  name: string;
  
  /** スパンのタイプ */
  type: TType;
  
  /** スパンの開始時刻 */
  startTime: Date;
  
  /** スパンの終了時刻 */
  endTime?: Date;
  
  /** タイプ固有の属性 */
  attributes?: AISpanTypeMap[TType];
  
  /** ユーザー定義のメタデータ */
  metadata?: Record<string, any>;
  
  /** スパンの開始時に渡される入力 */
  input?: any;
  
  /** スパンの終了時に生成される出力 */
  output?: any;
  
  /** スパンが失敗した場合のエラー情報 */
  errorInfo?: {
    message: string;
    id?: string;
    domain?: string;
    category?: string;
    details?: Record<string, any>;
  };
  
  /** イベントスパンかどうか（startTimeで発生し、endTimeを持たない） */
  isEvent: boolean;
}
```


## AISpan

トレース目的で内部的に使用される AI Span インターフェース。ライフサイクルに関するメソッドとプロパティを備えた BaseSpan を拡張します。

```typescript
interface AISpan<TType extends AISpanType> extends BaseSpan<TType> {
  /** 内部スパンか？（mastraの動作内部のスパン） */
  isInternal: boolean;
  
  /** 親スパンの参照（ルートスパンの場合はundefined） */
  parent?: AnyAISpan;
  
  /** AITracingインスタンスへのポインタ */
  aiTracing: AITracing;
}
```


### プロパティ

```typescript
/** スパンがトレースのルートスパンの場合、TRUEを返します */
get isRootSpan(): boolean

/** スパンが有効なスパン（NO-OPスパンでない）の場合、TRUEを返します */
get isValid(): boolean

/** 内部スパンでない最も近い親spanIdを取得します */
getParentSpanId(includeInternalSpans?: boolean): string | undefined

/** エクスポート用の軽量スパンを返します */
exportSpan(includeInternalSpans?: boolean): ExportedAISpan<TType> | undefined
```


### メソッド

#### 終了

```typescript
end(options?: EndSpanOptions<TType>): void
```

スパンを終了し、設定済みのエクスポーターへのエクスポートを実行します。`endTime` を設定し、必要に応じて `output`、`metadata`、`attributes` を更新します。

<PropertiesTable
  props={[
{
  name: "output",
  type: "any",
  description: "この操作の最終出力データ",
  required: false,
},
{
  name: "metadata",
  type: "Record<string, any>",
  description: "マージする追加メタデータ",
  required: false,
},
{
  name: "attributes",
  type: "Partial<AISpanTypeMap[TType]>",
  description: "更新対象の型固有属性",
  required: false,
},
]}
/>


#### エラー

```typescript
error(options: ErrorSpanOptions<TType>): void
```

スパンにエラーを記録します。`errorInfo` フィールドを設定し、必要に応じてスパンを終了します。

<PropertiesTable
  props={[
{
  name: "error",
  type: "Error",
  description: "発生したエラー",
  required: true,
},
{
  name: "endSpan",
  type: "boolean",
  description: "エラーを記録した後にスパンを終了するかどうか",
  required: false,
},
{
  name: "metadata",
  type: "Record<string, any>",
  description: "追加のエラーコンテキスト用メタデータ",
  required: false,
},
{
  name: "attributes",
  type: "Partial<AISpanTypeMap[TType]>",
  description: "タイプ固有の属性の更新内容",
  required: false,
},
]}
/>


#### 更新

```typescript
update(options: UpdateSpanOptions<TType>): void
```

スパンがアクティブな間にデータを更新します。`input`、`output`、`metadata`、`attributes` を変更できます。

<PropertiesTable
  props={[
{
  name: "input",
  type: "any",
  description: "入力データを更新または設定します",
  required: false,
},
{
  name: "output",
  type: "any",
  description: "出力データを更新または設定します",
  required: false,
},
{
  name: "metadata",
  type: "Record<string, any>",
  description: "既存のメタデータにマージするデータ",
  required: false,
},
{
  name: "attributes",
  type: "Partial<AISpanTypeMap[TType]>",
  description: "タイプ固有の属性を更新します",
  required: false,
},
]}
/>


#### createChildSpan

```typescript
createChildSpan<TChildType extends AISpanType>(
  options: ChildSpanOptions<TChildType>
): AISpan<TChildType>
```

このスパンの配下に子スパンを作成します。子スパンはサブ操作を追跡し、トレースコンテキストを継承します。

<PropertiesTable
  props={[
{
  name: "type",
  type: "TChildType",
  description: "子スパンの種類",
  required: true,
},
{
  name: "name",
  type: "string",
  description: "子スパン名",
  required: true,
},
{
  name: "attributes",
  type: "AISpanTypeMap[TChildType]",
  description: "種類固有の属性",
  required: false,
},
{
  name: "metadata",
  type: "Record<string, any>",
  description: "初期メタデータ",
  required: false,
},
{
  name: "input",
  type: "any",
  description: "初期入力データ",
  required: false,
},
]}
/>


#### createEventSpan

```typescript
createEventSpan<TChildType extends AISpanType>(
  options: ChildEventOptions<TChildType>
): AISpan<TChildType>
```

このスパンの下にイベントスパンを作成します。イベントスパンは、継続時間を持たない一点の出来事を表します。

<PropertiesTable
  props={[
{
  name: "type",
  type: "TChildType",
  description: "イベントスパンのタイプ",
  required: true,
},
{
  name: "name",
  type: "string",
  description: "イベント名",
  required: true,
},
{
  name: "attributes",
  type: "AISpanTypeMap[TChildType]",
  description: "タイプ固有の属性",
  required: false,
},
{
  name: "metadata",
  type: "Record<string, any>",
  description: "イベントのメタデータ",
  required: false,
},
{
  name: "input",
  type: "any",
  description: "イベントの入力データ",
  required: false,
},
{
  name: "output",
  type: "any",
  description: "イベントの出力データ",
  required: false,
},
]}
/>


## ExportedAISpan

エクスポーターのトレーシングに使用される Exported AI Span インターフェース。メソッドや循環参照を持たない AISpan の軽量版です。

```typescript
interface ExportedAISpan<TType extends AISpanType> extends BaseSpan<TType> {
  /** 親スパンIDの参照（ルートスパンの場合はundefined） */
  parentSpanId?: string;
  
  /** スパンがトレースのルートスパンの場合はtrue */
  isRootSpan: boolean;
}
```


## スパンのライフサイクルイベント

スパンのライフサイクル中に発生するイベント。

### AITracingEventType

```typescript
enum AITracingEventType {
  /** スパンが作成・開始された際に発行される */
  SPAN_STARTED = 'span_started',
  
  /** update()によってスパンが更新された際に発行される */
  SPAN_UPDATED = 'span_updated',
  
  /** end()またはerror()によってスパンが終了した際に発行される */
  SPAN_ENDED = 'span_ended',
}
```


### AITracingEvent

```typescript
type AITracingEvent =
  | { type: 'span_started'; exportedSpan: AnyExportedAISpan }
  | { type: 'span_updated'; exportedSpan: AnyExportedAISpan }
  | { type: 'span_ended'; exportedSpan: AnyExportedAISpan };
```

エクスポーターは、これらのイベントを受け取り、トレースデータを処理してオブザーバビリティ・プラットフォームに送信します。


## 共用体型

### AnyAISpan

```typescript
type AnyAISpan = AISpan<keyof AISpanTypeMap>;
```

あらゆるスパン型を扱う必要がある場合のためのユニオン型。


### AnyExportedAISpan

```typescript
type AnyExportedAISpan = ExportedAISpan<keyof AISpanTypeMap>;
```

エクスポートされた任意の span 型を扱う必要がある場合のためのユニオン型。


## 関連項目

### ドキュメント

- [AI トレーシングの概要](/docs/observability/ai-tracing/overview) - 概念と使い方
- [子スパンの作成](/docs/observability/ai-tracing/overview#creating-child-spans) - 実用例
- [トレース ID の取得](/docs/observability/ai-tracing/overview#retrieving-trace-ids) - トレース ID の活用

### リファレンス

- [AITracing Classes](/reference/observability/ai-tracing/ai-tracing) - トレーシングの中核クラス
- [Interfaces](/reference/observability/ai-tracing/interfaces) - 型の完全なリファレンス
- [Configuration](/reference/observability/ai-tracing/configuration) - 設定項目

### 例

- [Basic AI Tracing](/examples/observability/basic-ai-tracing) - スパンの取り扱い