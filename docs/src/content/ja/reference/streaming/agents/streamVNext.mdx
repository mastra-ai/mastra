---
title: "リファレンス: Agent.streamVNext()（実験的） | Agents | Mastra ドキュメント"
description: "Mastra のエージェントにおける `Agent.streamVNext()` メソッドのドキュメント。拡張機能により、応答のリアルタイムストリーミングを実現します。"
---

import { StreamVNextCallout } from "@/components/streamVNext-callout.tsx"


# Agent.streamVNext() (Experimental)

<StreamVNextCallout />

`.streamVNext()` メソッドは、強化された機能と柔軟なフォーマットにより、エージェントからの応答をリアルタイムでストリーミングできます。このメソッドはメッセージと任意のストリーミングオプションを受け取り、Mastra のネイティブ形式と AI SDK v5 との互換性を両立した次世代のストリーミング体験を提供します。

## 使用例

```typescript copy
// Mastra のデフォルト形式
const mastraStream = await agent.streamVNext("message for agent");

// AI SDK v5 と互換の形式
const aiSdkStream = await agent.streamVNext("message for agent", {
  format: 'aisdk'
});
```

## パラメーター

<PropertiesTable
  content={[
    {
      name: "messages",
      type: "string | string[] | CoreMessage[] | AiMessageType[] | UIMessageWithMetadata[]",
      description: "エージェントに送信するメッセージ。単一の文字列、文字列配列、または構造化メッセージオブジェクトを指定できます。",
    },
    {
      name: "options",
      type: "AgentExecutionOptions<Output, StructuredOutput, Format>",
      isOptional: true,
      description: "ストリーミング処理に関する任意の設定。",
    },
  ]}
/>

### オプション

<PropertiesTable
  content={[
  {
    name: 'format',
    type: "'mastra' | 'aisdk'",
    isOptional: true,
    defaultValue: "'mastra'",
    description:
      "出力ストリーム形式を指定します。Mastra のネイティブ形式（デフォルト）には 'mastra' を、AI SDK v5 との互換性には 'aisdk' を使用します。",
  },
  {
    name: 'maxSteps',
    type: 'number',
    isOptional: true,
    description: '実行時に行う最大ステップ数。',
  },
  {
    name: 'scorers',
    type: "MastraScorers | Record<string, { scorer: MastraScorer['name']; sampling?: ScoringSamplingConfig }>",
    isOptional: true,
    description: '実行結果に対して動かす評価スコアラー。',
    properties: [
      {
        parameters: [
          {
            name: 'scorer',
            type: 'string',
            isOptional: false,
            description: '使用するスコアラー名。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'sampling',
            type: 'ScoringSamplingConfig',
            isOptional: true,
            description: 'スコアラー用のサンプリング設定。',
            properties: [
              {
                parameters: [
                  {
                    name: 'type',
                    type: "'none' | 'ratio'",
                    isOptional: false,
                    description:
                      "サンプリング戦略の種類。サンプリングを無効にするには 'none'、割合ベースのサンプリングには 'ratio' を使用します。",
                  },
                ],
              },
              {
                parameters: [
                  {
                    name: 'rate',
                    type: 'number',
                    isOptional: true,
                    description:
                      "サンプリング率（0〜1）。type が 'ratio' の場合は必須です。",
                  },
                ],
              },
            ],
          },
        ],
      },
    ],
  },
  {
    name: 'tracingContext',
    type: 'TracingContext',
    isOptional: true,
    description: 'スパン階層とメタデータのための AI トレーシングコンテキスト。',
  },
  {
    name: 'returnScorerData',
    type: 'boolean',
    isOptional: true,
    description: 'レスポンスに詳細なスコアリングデータを含めて返すかどうか。',
  },
  {
    name: 'onChunk',
    type: '(chunk: ChunkType) => Promise<void> | void',
    isOptional: true,
    description: 'ストリーミング中の各チャンクごとに呼び出されるコールバック関数。',
  },
  {
    name: 'onError',
    type: '({ error }: { error: Error | string }) => Promise<void> | void',
    isOptional: true,
    description:
      'ストリーミング中にエラーが発生した際に呼び出されるコールバック関数。',
  },
  {
    name: 'onAbort',
    type: '(event: any) => Promise<void> | void',
    isOptional: true,
    description: 'ストリームが中断されたときに呼び出されるコールバック関数。',
  },
  {
    name: 'abortSignal',
    type: 'AbortSignal',
    isOptional: true,
    description:
      "エージェントの実行を中断できる Signal オブジェクト。シグナルが中断されると、進行中のすべての操作が終了します。",
  },
  {
    name: 'activeTools',
    type: 'Array<keyof ToolSet> | undefined',
    isOptional: true,
    description:
      '実行中に使用可能な有効なツール名の配列。',
  },
  {
    name: 'prepareStep',
    type: 'PrepareStepFunction<any>',
    isOptional: true,
    description:
      'マルチステップ実行の各ステップの前に呼び出されるコールバック関数。',
  },
  {
    name: 'context',
    type: 'ModelMessage[]',
    isOptional: true,
    description: 'エージェントに与える追加のコンテキストメッセージ。',
  },
  {
    name: 'structuredOutput',
    type: 'StructuredOutputOptions<S extends ZodTypeAny = ZodTypeAny>',
    isOptional: true,
    description:
      'より良い開発者体験のために構造化出力生成を有効化します。内部で StructuredOutputProcessor を自動作成して使用します。',
    properties: [
      {
        parameters: [
          {
            name: 'schema',
            type: 'z.ZodSchema<S>',
            isOptional: false,
            description: '出力を検証するための Zod スキーマ。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'model',
            type: 'MastraLanguageModel',
            isOptional: true,
            description:
              "内部の構造化エージェントに使用するモデル。指定しない場合はエージェントのモデルが使用されます。",
          },
        ],
      },
      {
        parameters: [
          {
            name: 'errorStrategy',
            type: "'strict' | 'warn' | 'fallback'",
            isOptional: true,
            description:
              "パースまたは検証に失敗した場合の方針。デフォルトは 'strict' です。",
          },
        ],
      },
      {
        parameters: [
          {
            name: 'fallbackValue',
            type: '<S extends ZodTypeAny>',
            isOptional: true,
            description: "errorStrategy が 'fallback' の場合のフォールバック値。",
          },
        ],
      },
      {
        parameters: [
          {
            name: 'instructions',
            type: 'string',
            isOptional: true,
            description: '構造化エージェントへのカスタム指示。',
          },
        ],
      },
    ],
  },
  {
    name: 'outputProcessors',
    type: 'Processor[]',
    isOptional: true,
    description:
      'エージェントに設定された出力プロセッサを上書きします。ユーザーに返す前にエージェントからのメッセージを変更または検証できる出力プロセッサです。`processOutputResult` と `processOutputStream` のいずれか（または両方）を実装する必要があります。',
  },
  {
    name: 'inputProcessors',
    type: 'Processor[]',
    isOptional: true,
    description:
      'エージェントに設定された入力プロセッサを上書きします。エージェントで処理される前にメッセージを変更または検証できる入力プロセッサです。`processInput` 関数を実装する必要があります。',
  },
  {
    name: 'instructions',
    type: 'string',
    isOptional: true,
    description:
      "この生成に限りエージェントのデフォルト指示を上書きするカスタム指示。新しいエージェントインスタンスを作成せずに挙動を動的に変更するのに有用です。",
  },
  {
    name: 'system',
    type: 'string | string[] | CoreSystemMessage | SystemModelMessage | CoreSystemMessage[] | SystemModelMessage[]',
    isOptional: true,
    description:
      "プロンプトに含めるカスタムのシステムメッセージ。単一の文字列、メッセージオブジェクト、またはいずれかの配列を指定できます。システムメッセージは、エージェントの主指示を補完する追加のコンテキストや挙動指示を提供します。",
  },
  {
    name: 'output',
    type: 'Zod schema | JsonSchema7',
    isOptional: true,
    description:
      '**非推奨。** 同様の目的には structuredOutput と maxSteps:1 を使用してください。期待される出力構造を定義します。JSON Schema オブジェクトまたは Zod スキーマを指定できます。',
  },
  {
    name: 'memory',
    type: 'object',
    isOptional: true,
    description:
      'メモリの設定。メモリ管理の推奨手段です。',
    properties: [
      {
        parameters: [
          {
            name: 'thread',
            type: 'string | { id: string; metadata?: Record<string, any>, title?: string }',
            isOptional: false,
            description:
              '会話スレッド。文字列 ID、または `id` と任意の `metadata` を持つオブジェクトとして指定します。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'resource',
            type: 'string',
            isOptional: false,
            description:
              'スレッドに関連付けられたユーザーまたはリソースの識別子。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'options',
            type: 'MemoryConfig',
            isOptional: true,
            description:
              'メモリ動作の設定（メッセージ履歴やセマンティックリコールなど）。',
          },
        ],
      },
    ],
  },
  {
    name: 'onFinish',
    type: 'StreamTextOnFinishCallback<any> | StreamObjectOnFinishCallback<OUTPUT>',
    isOptional: true,
    description:
      'ストリーミング完了時に呼び出されるコールバック関数。最終結果を受け取ります。',
  },
  {
    name: 'onStepFinish',
    type: 'StreamTextOnStepFinishCallback<any> | never',
    isOptional: true,
    description:
      '各実行ステップ後に呼び出されるコールバック関数。ステップの詳細を JSON 文字列で受け取ります。構造化出力では利用できません',
  },
  {
    name: 'resourceId',
    type: 'string',
    isOptional: true,
    description:
      '**非推奨。** 代わりに `memory.resource` を使用してください。エージェントと対話するユーザーまたはリソースの識別子。threadId が指定されている場合は必須です。',
  },
  {
    name: 'telemetry',
    type: 'TelemetrySettings',
    isOptional: true,
    description: 'ストリーミング中のテレメトリー収集の設定。',
    properties: [
      {
        parameters: [
          {
            name: 'isEnabled',
            type: 'boolean',
            isOptional: true,
            description:
              'テレメトリーを有効または無効にします。実験段階ではデフォルトで無効です。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'recordInputs',
            type: 'boolean',
            isOptional: true,
            description:
              '入力の記録を有効または無効にします。デフォルトで有効です。機密情報の記録を避けるために入力記録を無効化する場合があります。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'recordOutputs',
            type: 'boolean',
            isOptional: true,
            description:
              '出力の記録を有効または無効にします。デフォルトで有効です。機密情報の記録を避けるために出力記録を無効化する場合があります。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'functionId',
            type: 'string',
            isOptional: true,
            description:
              'この関数の識別子。関数単位でテレメトリーデータをグルーピングするために使用されます。',
          },
        ],
      },
    ],
  },
  {
    name: 'modelSettings',
    type: 'CallSettings',
    isOptional: true,
    description:
      'temperature、maxTokens、topP などのモデル固有の設定。基盤の言語モデルに渡されます。',
    properties: [
      {
        parameters: [
          {
            name: 'temperature',
            type: 'number',
            isOptional: true,
            description:
              "モデル出力のランダム性を制御します。値が高い（例: 0.8）ほど出力はランダムに、低い（例: 0.2）ほど出力は焦点が定まり決定的になります。",
          },
        ],
      },
      {
        parameters: [
          {
            name: 'maxRetries',
            type: 'number',
            isOptional: true,
            description: '失敗したリクエストの最大再試行回数。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'topP',
            type: 'number',
            isOptional: true,
            description:
              'Nucleus サンプリング。0〜1 の数値です。temperature か topP のどちらか一方の設定を推奨します（両方は非推奨）。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'topK',
            type: 'number',
            isOptional: true,
            description:
              "各後続トークンで上位 K 個の選択肢からのみサンプリングします。確率の低い「ロングテール」の応答を除外するために使用します。",
          },
        ],
      },
      {
        parameters: [
          {
            name: 'presencePenalty',
            type: 'number',
            isOptional: true,
            description:
              'Presence penalty の設定。プロンプト内の既存情報をモデルが繰り返す可能性に影響します。-1（反復を増やす）から 1（最大のペナルティ、反復を減らす）までの数値です。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'frequencyPenalty',
            type: 'number',
            isOptional: true,
            description:
              'Frequency penalty の設定。同じ語やフレーズを繰り返し使用する可能性に影響します。-1（反復を増やす）から 1（最大のペナルティ、反復を減らす）までの数値です。',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'stopSequences',
            type: 'string[]',
            isOptional: true,
            description:
              'ストップシーケンス。設定すると、いずれかのストップシーケンスが生成された時点でモデルはテキスト生成を停止します。',
          },
        ],
      },
    ],
  },
  {
    name: 'threadId',
    type: 'string',
    isOptional: true,
    description:
      '**非推奨。** 代わりに `memory.thread` を使用してください。会話スレッドの識別子。複数の対話にわたりコンテキストを維持できます。resourceId が指定されている場合は必須です。',
  },
  {
    name: 'toolChoice',
    type: "'auto' | 'none' | 'required' | { type: 'tool'; toolName: string }",
    isOptional: true,
    defaultValue: "'auto'",
    description: 'ストリーミング中にエージェントがツールをどのように使用するかを制御します。',
    properties: [
      {
        parameters: [
          {
            name: "'auto'",
            type: 'string',
            description: 'ツールを使用するかどうかをモデルに任せます（デフォルト）。',
          },
        ],
      },
      {
        parameters: [
          {
            name: "'none'",
            type: 'string',
            description: 'いかなるツールも使用しない。',
          },
        ],
      },
      {
        parameters: [
          {
            name: "'required'",
            type: 'string',
            description: '少なくとも 1 つのツールを使用するようモデルに要求します。',
          },
        ],
      },
      {
        parameters: [
          {
            name: "{ type: 'tool'; toolName: string }",
            type: 'object',
            description: '特定の名前のツールを使用するようモデルに要求します。',
          },
        ],
      },
    ],
  },
  {
    name: 'toolsets',
    type: 'ToolsetsInput',
    isOptional: true,
    description:
      'ストリーミング中にエージェントが利用できる追加のツールセット。',
  },
  {
    name: 'clientTools',
    type: 'ToolsInput',
    isOptional: true,
    description:
      "リクエストの「クライアント」側で実行されるツール。これらのツールは定義内に execute 関数を持ちません。",
  },
  {
    name: 'savePerStep',
    type: 'boolean',
    isOptional: true,
    description:
      '各ストリームステップ完了後にメッセージを段階的に保存します（デフォルト: false）。',
  },
  {
    name: 'providerOptions',
    type: 'Record<string, Record<string, JSONValue>>',
    isOptional: true,
    description:
      "基盤の LLM プロバイダーに透過的に渡される追加のプロバイダー固有オプション。構造は `{ providerName: { optionKey: value } }` です。例: `{ openai: { reasoningEffort: 'high' }, anthropic: { maxTokens: 1000 } }`。",
    properties: [
      {
        parameters: [
          {
            name: 'openai',
            type: 'Record<string, JSONValue>',
            isOptional: true,
            description:
              "OpenAI 固有のオプション。例: `{ reasoningEffort: 'high' }`",
          },
        ],
      },
      {
        parameters: [
          {
            name: 'anthropic',
            type: 'Record<string, JSONValue>',
            isOptional: true,
            description:
              'Anthropic 固有のオプション。例: `{ maxTokens: 1000 }`',
          },
        ],
      },
      {
        parameters: [
          {
            name: 'google',
            type: 'Record<string, JSONValue>',
            isOptional: true,
            description:
              'Google 固有のオプション。例: `{ safetySettings: [...] }`',
          },
        ],
      },
      {
        parameters: [
          {
            name: '[providerName]',
            type: 'Record<string, JSONValue>',
            isOptional: true,
            description:
              'その他のプロバイダー固有オプション。キーはプロバイダー名で、値はプロバイダー固有オプションのレコードです。',
          },
        ],
      },
    ],
  },
  {
    name: 'runId',
    type: 'string',
    isOptional: true,
    description:
      'この生成実行の一意の ID。追跡やデバッグに有用です。',
  },
  {
    name: 'runtimeContext',
    type: 'RuntimeContext',
    isOptional: true,
    description:
      '依存性注入とコンテキスト情報のためのランタイムコンテキスト。',
  },
  {
    name: 'stopWhen',
    type: 'StopCondition | StopCondition[]',
    isOptional: true,
    description:
      "エージェントの実行を停止する条件。単一の条件または条件の配列を指定できます。",
  },
]}
/>

## 返り値

<PropertiesTable
  content={[
    {
      name: "stream",
      type: "MastraModelOutput<Output> | AISDKV5OutputStream<Output>",
      description: "format パラメータに応じたストリーミングインターフェースを返します。format が 'mastra'（デフォルト）の場合は MastraModelOutput を、'aisdk' の場合は AI SDK v5 互換の AISDKV5OutputStream を返します。",
    },
  ]}
/>

## 追加の使用例

### Mastra フォーマット（デフォルト）

```typescript showLineNumbers copy
import { stepCountIs } from 'ai-v5';

const stream = await agent.streamVNext("Tell me a story", {
  stopWhen: stepCountIs(3), // 3ステップで停止
  modelSettings: {
    temperature: 0.7,
  },
});

// テキストストリームにアクセス
for await (const chunk of stream.textStream) {
  console.log(chunk);
}

// ストリーミング完了後に全文を取得
const fullText = await stream.text;
```

### AI SDK v5 の形式

```typescript showLineNumbers copy
import { stepCountIs } from 'ai-v5';

const stream = await agent.streamVNext("物語を聞かせて", {
  format: 'aisdk',
  stopWhen: stepCountIs(3), // 3ステップで停止
  modelSettings: {
    temperature: 0.7,
  },
});

// AI SDK v5 互換のインターフェースで使用
for await (const part of stream.fullStream) {
  if (part.type === 'text-delta') {
    console.log(part.text);
  }
}

// フロントエンド連携用の API ルート内で
return stream.toUIMessageStreamResponse();
```

### コールバックの使用

すべてのコールバック関数がトップレベルのプロパティとして利用できるようになり、よりシンプルで使いやすいAPIになりました。

```typescript showLineNumbers copy
const stream = await agent.streamVNext("Tell me a story", {
  onFinish: (result) => {
    console.log('Streaming finished:', result);
  },
  onStepFinish: (step) => {
    console.log('Step completed:', step);
  },
  onChunk: (chunk) => {
    console.log('Received chunk:', chunk);
  },
  onError: ({ error }) => {
    console.error('Streaming error:', error);
  },
  onAbort: (event) => {
    console.log('Stream aborted:', event);
  },
});

// ストリームを処理する
for await (const chunk of stream.textStream) {
  console.log(chunk);
}
```

### オプションを使用した高度な例

```typescript 行番号を表示
import { z } from "zod";
import { stepCountIs } from 'ai-v5';

await agent.streamVNext("エージェントへのメッセージ", {
  format: 'aisdk', // AI SDK v5 との互換性を有効化
  stopWhen: stepCountIs(3), // 3ステップで停止
  modelSettings: {
    temperature: 0.7,
  },
  memory: {
    thread: "user-123",
    resource: "test-app"
  },
  toolChoice: "auto",
  // より良いDXのための構造化出力
  structuredOutput: {
    schema: z.object({
      sentiment: z.enum(['positive', 'negative', 'neutral']),
      confidence: z.number(),
    }),
    model: openai("gpt-4o-mini"),
    errorStrategy: 'warn',
  },
  // ストリーミング応答検証用の出力プロセッサ
  outputProcessors: [
    new ModerationProcessor({ model: openai("gpt-4.1-nano") }),
    new BatchPartsProcessor({ maxBatchSize: 3, maxWaitTime: 100 }),
  ],
});
```
