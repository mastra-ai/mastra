---
title: "リファレンス: Memory.query() | Memory | Mastra Docs"
description: "Mastra の `Memory.query()` メソッドに関するドキュメント。ページネーション、フィルター、セマンティック検索に対応し、特定のスレッドからメッセージを取得します。"
---

# Memory.query()

`.query()` メソッドは、ページネーション、フィルタリング、セマンティック検索に対応し、特定のスレッドからメッセージを取得します。

## 使い方の例

```typescript copy
await memory?.query({ threadId: "user-123" });
```


## パラメータ

<PropertiesTable
  content={[
    {
      name: "threadId",
      type: "string",
      description: "メッセージを取得する対象スレッドの一意の識別子",
      isOptional: false,
    },
    {
      name: "resourceId",
      type: "string",
      description: "そのスレッドを所有するリソースの任意指定ID。指定された場合、スレッドの所有者であることを検証します",
      isOptional: true,
    },
    {
      name: "selectBy",
      type: "object",
      description: "メッセージのフィルタリングおよび選択用オプション",
      isOptional: true,
    },
    {
      name: "threadConfig",
      type: "MemoryConfig",
      description: "メッセージ取得およびセマンティック検索のための設定オプション",
      isOptional: true,
    },
    {
      name: "format",
      type: "'v1' | 'v2'",
      description: "返すメッセージ形式。現在の形式には 'v2' がデフォルト、後方互換性には 'v1' を使用します",
      isOptional: true,
    },
  ]}
/>

### selectBy パラメーター

<PropertiesTable
  content={[
    {
      name: "vectorSearchString",
      type: "string",
      description: "意味的に類似するメッセージを探すための検索文字列。threadConfig で semantic recall を有効化しておく必要があります。",
      isOptional: true,
    },
    {
      name: "last",
      type: "number | false",
      description: "取得する最新メッセージ数。上限を無効にするには false を指定します。注: threadConfig.lastMessages（既定: 10）がより小さい場合は、そちらが優先されます。",
      isOptional: true,
    },
    {
      name: "include",
      type: "{ id: string; threadId?: string; withPreviousMessages?: number; withNextMessages?: number }[]",
      description: "必要に応じて前後のコンテキストを付けて含める特定のメッセージ ID の配列。各要素には必須の `id`、任意の `threadId`（省略時はメインの threadId）、`withPreviousMessages`（前に含めるメッセージ数。ベクトル検索時は既定 2、それ以外は 0）、`withNextMessages`（後に含めるメッセージ数。ベクトル検索時は既定 2、それ以外は 0）が含まれます。",
      isOptional: true,
    },
    {
      name: "pagination",
      type: "{ dateRange?: { start?: Date; end?: Date }; page?: number; perPage?: number }",
      description: "メッセージを分割して取得するためのページネーション設定。`dateRange`（日付範囲でのフィルタ）、`page`（0 始まりのページ番号）、`perPage`（1 ページあたりの件数）を含みます。",
      isOptional: true,
    },
  ]}
/>

### threadConfig のパラメータ

<PropertiesTable
  content={[
    {
      name: "lastMessages",
      type: "number | false",
      description: "取得する直近メッセージ数。無効にする場合は false を指定します。",
      isOptional: true,
      defaultValue: "10",
    },
    {
      name: "semanticRecall",
      type: "boolean | { topK: number; messageRange: number | { before: number; after: number }; scope?: 'thread' | 'resource' }",
      description: "メッセージ履歴に対するセマンティック検索を有効化します。boolean か、設定オプションを含むオブジェクトを指定できます。有効化には vector store と embedder の両方の設定が必要です。",
      isOptional: true,
      defaultValue: "false",
    },
    {
      name: "workingMemory",
      type: "WorkingMemory",
      description: "ワーキングメモリ機能の設定。`{ enabled: boolean; template?: string; schema?: ZodObject<any> | JSONSchema7; scope?: 'thread' | 'resource' }` または無効化用の `{ enabled: boolean }` を指定できます。",
      isOptional: true,
      defaultValue: "{ enabled: false, template: '# User Information\\n- **First Name**:\\n- **Last Name**:\\n...' }",
    },
    {
      name: "threads",
      type: "{ generateTitle?: boolean | { model: DynamicArgument<MastraLanguageModel>; instructions?: DynamicArgument<string> } }",
      description: "メモリスレッド作成に関する設定。`generateTitle` は、ユーザーの最初のメッセージからスレッドタイトルを自動生成するかどうかを制御します。boolean か、カスタムの model と instructions を持つオブジェクトを指定できます。",
      isOptional: true,
      defaultValue: "{ generateTitle: false }",
    },
  ]}
/>

## 返り値

<PropertiesTable
  content={[
    {
      name: "messages",
      type: "CoreMessage[]",
      description: "コア形式で取得されたメッセージの配列",
    },
    {
      name: "uiMessages",
      type: "UIMessageWithMetadata[]",
      description: "ツール呼び出しと結果の適切なスレッド化を含む、UI表示向けに整形されたメッセージの配列",
    },
  ]}
/>

## 拡張的な使用例

```typescript filename="src/test-memory.ts" showLineNumbers copy
import { mastra } from "./mastra";

const agent = mastra.getAgent("agent");
const memory = await agent.getMemory();

const { messages, uiMessages } = await memory!.query({
  threadId: "thread-123",
  selectBy: {
    last: 50,
    vectorSearchString: "どんなメッセージがある？",
    include: [
      {
        id: "msg-123"
      },
      {
        id: "msg-456",
        withPreviousMessages: 3,
        withNextMessages: 1
      }
    ]
  },
  threadConfig: {
    semanticRecall: true
  }
});

console.log(messages);
console.log(uiMessages);
```


### 関連項目

- [Memory クラス リファレンス](/reference/memory/Memory.mdx)
- [Memory の概要](/docs/memory/overview.mdx)
- [セマンティックリコール](/docs/memory/semantic-recall.mdx)
- [createThread](/reference/memory/createThread.mdx)