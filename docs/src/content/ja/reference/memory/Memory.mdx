---
title: "リファレンス: Memory クラス | Memory | Mastra ドキュメント"
description: "Mastra の `Memory` クラスに関するドキュメント。会話履歴の管理やスレッドベースのメッセージ保存に対応する堅牢なシステムを提供します。"
---

# Memory クラス

`Memory` クラスは、Mastra における会話履歴とスレッドベースのメッセージ保存を管理するための堅牢なシステムを提供します。これにより、会話の永続保存、セマンティック検索機能、効率的なメッセージ取得が可能になります。会話履歴にはストレージプロバイダーの設定が必須で、セマンティックリコールを有効にする場合は、ベクターストアとエンベッダーも用意する必要があります。

## 使い方の例

```typescript filename="src/mastra/agents/test-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";

export const agent = new Agent({
  name: "test-agent",
  instructions: "あなたは記憶機能を備えたエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    options: {
      workingMemory: {
        enabled: true
      }
    }
  })
});
```

> エージェントで `workingMemory` を有効化するには、メインの Mastra インスタンスでストレージプロバイダーを設定する必要があります。詳しくは [Mastra クラス](../core/mastra-class.mdx) をご覧ください。


## コンストラクターのパラメータ

<PropertiesTable
  content={[
    {
      name: "storage",
      type: "MastraStorage",
      description: "メモリデータを永続化するためのストレージ実装。指定しない場合は `new DefaultStorage({ config: { url: \"file:memory.db\" } })` がデフォルトです。",
      isOptional: true,
    },
    {
      name: "vector",
      type: "MastraVector | false",
      description: "セマンティック検索のためのベクトルストア。ベクトル処理を無効化するには `false` を指定します。",
      isOptional: true,
    },
    {
      name: "embedder",
      type: "EmbeddingModel<string> | EmbeddingModelV2<string>",
      description: "ベクトル埋め込み用のエンベッダーインスタンス。セマンティックリコールを有効にする場合は必須です。",
      isOptional: true,
    },
    {
      name: "options",
      type: "MemoryConfig",
      description: "メモリの設定オプション。",
      isOptional: true,
    },
    {
      name: "processors",
      type: "MemoryProcessor[]",
      description: "LLM に送信する前にメッセージをフィルタリングまたは変換できるメモリプロセッサの配列。",
      isOptional: true,
    },
  ]}
/>

### オプションパラメーター

<PropertiesTable
  content={[
    {
      name: "lastMessages",
      type: "number | false",
      description: "取得する直近のメッセージ数。無効化する場合は false を指定します。",
      isOptional: true,
      defaultValue: "10",
    },
    {
      name: "semanticRecall",
      type: "boolean | { topK: number; messageRange: number | { before: number; after: number }; scope?: 'thread' | 'resource' }",
      description: "メッセージ履歴に対するセマンティック検索を有効にします。boolean または設定用オブジェクトを指定できます。有効時は vector store と embedder の両方の設定が必要です。topK のデフォルトは 4、messageRange のデフォルトは {before: 1, after: 1} です。",
      isOptional: true,
      defaultValue: "false",
    },
    {
      name: "workingMemory",
      type: "WorkingMemory",
      description: "ワーキングメモリ機能の設定。`{ enabled: boolean; template?: string; schema?: ZodObject<any> | JSONSchema7; scope?: 'thread' | 'resource' }` または `{ enabled: boolean }`（無効化用）を指定できます。",
      isOptional: true,
      defaultValue: "{ enabled: false, template: '# User Information\\n- **First Name**:\\n- **Last Name**:\\n...' }",
    },
    {
      name: "threads",
      type: "{ generateTitle?: boolean | { model: DynamicArgument<MastraLanguageModel>; instructions?: DynamicArgument<string> } }",
      description: "メモリのスレッド作成に関する設定。`generateTitle` はユーザーの最初のメッセージからスレッドタイトルを自動生成するかを制御します。boolean またはカスタムの model と instructions を持つオブジェクトを指定できます。",
      isOptional: true,
      defaultValue: "{ generateTitle: false }",
    },
  ]}
/>

## 戻り値

<PropertiesTable
  content={[
    {
      name: "memory",
      type: "Memory",
      description: "指定した構成を備えた新しい Memory インスタンス。",
    },
  ]}
/>

## 拡張された使用例

```typescript filename="src/mastra/agents/test-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { LibSQLStore, LibSQLVector } from "@mastra/libsql";

export const agent = new Agent({
  name: "test-agent",
  instructions: "あなたはメモリを備えたエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:./working-memory.db"
    }),
    vector: new LibSQLVector({
      connectionUrl: "file:./vector-memory.db"
    }),
    options: {
      lastMessages: 10,
      semanticRecall: {
        topK: 3,
        messageRange: 2,
        scope: 'resource'
      },
      workingMemory: {
        enabled: true
      },
      threads: {
        generateTitle: true
      }
    }
  })
});
```


## インデックス設定付きの PostgreSQL

```typescript filename="src/mastra/agents/pg-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { PgStore, PgVector } from "@mastra/pg";

export const agent = new Agent({
  name: "pg-agent",
  instructions: "あなたはPostgreSQLメモリが最適化されたエージェントです。",
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new PgStore({
      connectionString: process.env.DATABASE_URL
    }),
    vector: new PgVector({
      connectionString: process.env.DATABASE_URL
    }),
    embedder: openai.embedding("text-embedding-3-small"),
    options: {
      lastMessages: 20,
      semanticRecall: {
        topK: 5,
        messageRange: 3,
        scope: 'resource',
        indexConfig: {
          type: 'hnsw',              // パフォーマンス向上のためHNSWを使用
          metric: 'dotproduct',      // OpenAI埋め込みに最適
          m: 16,                     // 双方向リンク数
          efConstruction: 64         // 構築時候補リストサイズ
        }
      },
      workingMemory: {
        enabled: true
      }
    }
  })
});
```


### 関連

- [Memory の始め方](/docs/memory/overview.mdx)
- [セマンティックリコール](/docs/memory/semantic-recall.mdx)
- [ワーキングメモリ](/docs/memory/working-memory.mdx)
- [メモリプロセッサ](/docs/memory/memory-processors.mdx)
- [createThread](/reference/memory/createThread.mdx)
- [query](/reference/memory/query.mdx)
- [getThreadById](/reference/memory/getThreadById.mdx)
- [getThreadsByResourceId](/reference/memory/getThreadsByResourceId.mdx)
- [deleteMessages](/reference/memory/deleteMessages.mdx)