---
title: "リファレンス: カスタムスコアラーの作成 | Scorers | Mastra ドキュメント"
description: Mastra でカスタムスコアラーを作成するためのドキュメント。JavaScript 関数または LLM ベースのプロンプトを用いて、独自の評価ロジックを定義できます。
---

# createScorer

Mastra には、入出力ペアの評価に使うカスタムスコアラーを定義できる統一的な `createScorer` ファクトリがあります。各評価ステップでは、ネイティブな JavaScript 関数または LLM ベースのプロンプトオブジェクトのどちらも使用できます。カスタムスコアラーは、Agent や Workflow のステップに追加できます。

## カスタムスコアラーの作成方法

`createScorer` ファクトリを使って、名称、説明、必要に応じた judge の設定を指定し、スコアラーを定義します。続いて、ステップメソッドをチェーンして評価パイプラインを構築します。少なくとも `generateScore` ステップは必須です。

```typescript
const scorer = createScorer({
  name: "マイカスタムスコアラー",
  description: "カスタム基準に基づいて応答を評価します",
  type: "agent", // オプション: 自動型付けによるエージェント評価用
  judge: {
    model: myModel,
    instructions: "あなたは専門の評価者です..."
  }
})
.preprocess({ /* ステップ設定 */ })
.analyze({ /* ステップ設定 */ })
.generateScore(({ run, results }) => {
  // 数値を返す
})
.generateReason({ /* ステップ設定 */ });
```


## createScorer のオプション

<PropertiesTable
  content={[
    {
      name: "name",
      type: "string",
      required: true,
      description: "スコアラーの名前。",
    },
    {
      name: "description",
      type: "string",
      required: true,
      description: "スコアラーの機能の説明。",
    },
    {
      name: "judge",
      type: "object",
      required: false,
      description: "LLM ベースのステップ向けの任意の judge 設定。下記の Judge Object セクションを参照。",
    },
    {
      name: "type",
      type: "string",
      required: false,
      description: "入出力の型指定。自動エージェント型には 'agent' を使用します。カスタム型の場合は汎用アプローチを使用してください。",
    },
  ]}
/>

この関数は、ステップメソッドをチェーンできるスコアラー・ビルダーを返します。`.run()` メソッドとその入出力の詳細は、[MastraScorer リファレンス](./mastra-scorer)を参照してください。

## Judge オブジェクト

<PropertiesTable
  content={[
    {
      name: "model",
      type: "LanguageModel",
      required: true,
      description: "評価に使用する LLM のモデルインスタンス。",
    },
    {
      name: "instructions",
      type: "string",
      required: true,
      description: "LLM 用のシステムプロンプト／指示。",
    },
  ]}
/>

## 型安全性

スコアラーを作成する際に入出力の型を指定すると、型推論や IntelliSense のサポートが向上します：

### エージェントタイプのショートカット

エージェントを評価する際は、`type: 'agent'` を指定すると、エージェントの入出力に適切な型が自動的に設定されます。

```typescript
import { createScorer } from '@mastra/core/scorers';

// 自動型付けによるエージェントスコアラー
const agentScorer = createScorer({
  name: 'エージェント応答品質',
  description: 'エージェントの応答を評価します',
  type: 'agent' // ScorerRunInputForAgent/ScorerRunOutputForAgentを自動提供
})
.preprocess(({ run }) => {
  // run.inputはScorerRunInputForAgentとして自動型付けされます
  const userMessage = run.input.inputMessages[0]?.content;
  return { userMessage };
})
.generateScore(({ run, results }) => {
  // run.outputはScorerRunOutputForAgentとして自動型付けされます
  const response = run.output[0]?.content;
  return response.length > 10 ? 1.0 : 0.5;
});
```


### ジェネリクスを使ったカスタム型

カスタムの入出力型には、ジェネリクス方式を使用します。

```typescript
import { createScorer } from '@mastra/core/scorers';

type CustomInput = { query: string; context: string[] };
type CustomOutput = { answer: string; confidence: number };

const customScorer = createScorer<CustomInput, CustomOutput>({
  name: 'カスタムスコアラー',
  description: 'カスタムデータを評価します'
})
.generateScore(({ run }) => {
  // run.inputはCustomInput型です
  // run.outputはCustomOutput型です
  return run.output.confidence;
});
```


### ビルトインのエージェント型

- **`ScorerRunInputForAgent`** - エージェント評価用の `inputMessages`、`rememberedMessages`、`systemMessages`、`taggedSystemMessages` を含む
- **`ScorerRunOutputForAgent`** - エージェントの応答メッセージの配列

これらの型を使うと、オートコンプリート、コンパイル時検証、およびスコアリングロジックのドキュメント化が向上します。

## エージェントタイプでのトレーススコアリング

`type: 'agent'` を使用すると、スコアラーはエージェントへの直接追加と、エージェントのやり取りから得たトレースのスコアリングの両方に対応します。スコアラーはトレースデータを、適切なエージェントの入出力形式に自動変換します。

```typescript
const agentTraceScorer = createScorer({
  name: 'エージェントトレース長',
  description: 'エージェントレスポンスの長さを評価',
  type: 'agent'
})
.generateScore(({ run }) => {
  // トレースデータは自動的にエージェント形式に変換される
  const userMessages = run.input.inputMessages;
  const agentResponse = run.output[0]?.content;
  
  // レスポンス長に基づいてスコアを算出
  return agentResponse?.length > 50 ? 0 : 1;
});

// トレーススコアリング用にMastraに登録
const mastra = new Mastra({
  scorers: {
    agentTraceScorer
  }
});
```


## ステップ メソッドのシグネチャ

### preprocess

分析前にデータを抽出または変換できる任意の前処理ステップ。

**関数モード:**
Function: `({ run, results }) => any`

<PropertiesTable
  content={[
    {
      name: "run.input",
      type: "any",
      required: true,
      description: "スコアラーに渡される入力レコード。スコアラーがエージェントに追加されている場合はユーザーのメッセージ配列（例: `[{ role: 'user', content: 'hello world' }]`）。スコアラーがワークフローで使用される場合はワークフローの入力になります。",
    },
    {
      name: "run.output",
      type: "any",
      required: true,
      description: "スコアラーに渡される出力レコード。エージェントの場合は通常エージェントの応答、ワークフローの場合はワークフローの出力です。",
    },
    {
      name: "run.runId",
      type: "string",
      required: true,
      description: "このスコアリング実行の一意の識別子。",
    },
    {
      name: "run.runtimeContext",
      type: "object",
      required: false,
      description: "評価対象のエージェントまたはワークフローのステップからのランタイムコンテキスト（任意）。",
    },
    {
      name: "results",
      type: "object",
      required: true,
      description: "空オブジェクト（前段のステップなし）。",
    },
  ]}
/>

Returns: `any`  
このメソッドは任意の値を返せます。返された値は後続ステップで `preprocessStepResult` として利用可能になります。

**プロンプトオブジェクトモード:**

<PropertiesTable
  content={[
    {
      name: "description",
      type: "string",
      required: true,
      description: "この前処理ステップの内容の説明。",
    },
    {
      name: "outputSchema",
      type: "ZodSchema",
      required: true,
      description: "preprocess ステップの想定出力に対する Zod スキーマ。",
    },
    {
      name: "createPrompt",
      type: "function",
      required: true,
      description: "Function: ({ run, results }) => string. LLM へのプロンプトを返します。",
    },
    {
      name: "judge",
      type: "object",
      required: false,
      description: "（任意）このステップ用の LLM ジャッジ（メインのジャッジを上書き可能）。Judge Object セクションを参照。",
    },
  ]}
/>

### analyze

入力/出力および任意の前処理済みデータを扱うオプションの分析ステップ。

**関数モード:**
関数: `({ run, results }) => any`

<PropertiesTable
  content={[
    {
      name: "run.input",
      type: "any",
      required: true,
      description: "スコアラーに渡される入力レコード。スコアラーがエージェントに追加されている場合はユーザーメッセージの配列（例: `[{ role: 'user', content: 'hello world' }]`）。スコアラーがワークフローで使用される場合はワークフローの入力になります。",
    },
    {
      name: "run.output",
      type: "any",
      required: true,
      description: "スコアラーに渡される出力レコード。エージェントの場合は通常エージェントの応答、ワークフローの場合はワークフローの出力です。",
    },
    {
      name: "run.runId",
      type: "string",
      required: true,
      description: "このスコアリング実行の一意の識別子。",
    },
    {
      name: "run.runtimeContext",
      type: "object",
      required: false,
      description: "評価対象のエージェントまたはワークフローステップから提供されるランタイムコンテキスト（任意）。",
    },
    {
      name: "results.preprocessStepResult",
      type: "any",
      required: false,
      description: "前処理ステップが定義されている場合のその結果（任意）。",
    },
  ]}
/>

戻り値: `any`  
このメソッドは任意の値を返せます。返された値は後続のステップで `analyzeStepResult` として利用可能になります。

**プロンプトオブジェクトモード:**

<PropertiesTable
  content={[
    {
      name: "description",
      type: "string",
      required: true,
      description: "この分析ステップの内容の説明。",
    },
    {
      name: "outputSchema",
      type: "ZodSchema",
      required: true,
      description: "analyze ステップの想定出力を表す Zod スキーマ。",
    },
    {
      name: "createPrompt",
      type: "function",
      required: true,
      description: "関数: ({ run, results }) => string。LLM 用のプロンプトを返します。",
    },
    {
      name: "judge",
      type: "object",
      required: false,
      description: "（任意）このステップ用の LLM ジャッジ（メインのジャッジを上書き可能）。Judge Object セクションを参照。",
    },
  ]}
/>

### generateScore

最終的な数値スコアを算出する必須ステップ。

**Function モード:**
Function: `({ run, results }) => number`

<PropertiesTable
  content={[
    {
      name: "run.input",
      type: "any",
      required: true,
      description: "スコアラーに渡される入力レコード。スコアラーがエージェントに追加されている場合はユーザーのメッセージ配列（例: `[{ role: 'user', content: 'hello world' }]`）。ワークフローで使用される場合は、そのワークフローの入力になります。",
    },
    {
      name: "run.output",
      type: "any",
      required: true,
      description: "スコアラーに渡される出力レコード。エージェントの場合は通常エージェントの応答、ワークフローの場合はワークフローの出力です。",
    },
    {
      name: "run.runId",
      type: "string",
      required: true,
      description: "このスコアリング実行の一意の識別子。",
    },
    {
      name: "run.runtimeContext",
      type: "object",
      required: false,
      description: "評価対象のエージェントまたはワークフローステップのランタイムコンテキスト（任意）。",
    },
    {
      name: "results.preprocessStepResult",
      type: "any",
      required: false,
      description: "preprocess ステップの結果（定義されている場合、任意）。",
    },
    {
      name: "results.analyzeStepResult",
      type: "any",
      required: false,
      description: "analyze ステップの結果（定義されている場合、任意）。",
    },
  ]}
/>

Returns: `number`  
このメソッドは数値スコアを返す必要があります。

**Prompt Object モード:**

<PropertiesTable
  content={[
    {
      name: "description",
      type: "string",
      required: true,
      description: "このスコアリングステップの説明。",
    },
    {
      name: "outputSchema",
      type: "ZodSchema",
      required: true,
      description: "generateScore ステップの期待される出力に対する Zod スキーマ。",
    },
    {
      name: "createPrompt",
      type: "function",
      required: true,
      description: "Function: ({ run, results }) => string。LLM に渡すプロンプトを返します。",
    },
    {
      name: "judge",
      type: "object",
      required: false,
      description: "（任意）このステップ用の LLM ジャッジ（メインのジャッジを上書き可能）。Judge Object セクションを参照してください。",
    },
  ]}
/>

Prompt Object モードを使用する場合は、LLM の出力を数値スコアに変換する `calculateScore` 関数も提供する必要があります:

<PropertiesTable
  content={[
    {
      name: "calculateScore",
      type: "function",
      required: true,
      description: "Function: ({ run, results, analyzeStepResult }) => number。LLM の構造化出力を数値スコアに変換します。",
    },
  ]}
/>

### generateReason

スコアの根拠を説明する任意のステップ。

**関数モード:**
Function: `({ run, results, score }) => string`

<PropertiesTable
  content={[
    {
      name: "run.input",
      type: "any",
      required: true,
      description: "スコアラーに渡された入力レコード。スコアラーがエージェントに追加されている場合は、ユーザーメッセージの配列（例: `[{ role: 'user', content: 'hello world' }]`）。ワークフローで使用されている場合は、そのワークフローの入力になります。",
    },
    {
      name: "run.output",
      type: "any",
      required: true,
      description: "スコアラーに渡された出力レコード。エージェントの場合は通常、エージェントの応答。ワークフローの場合は、ワークフローの出力。",
    },
    {
      name: "run.runId",
      type: "string",
      required: true,
      description: "このスコアリング実行の一意の識別子。",
    },
    {
      name: "run.runtimeContext",
      type: "object",
      required: false,
      description: "評価対象のエージェントまたはワークフローステップ由来のランタイムコンテキスト（任意）。",
    },
    {
      name: "results.preprocessStepResult",
      type: "any",
      required: false,
      description: "preprocess ステップの結果（定義されている場合、任意）。",
    },
    {
      name: "results.analyzeStepResult",
      type: "any",
      required: false,
      description: "analyze ステップの結果（定義されている場合、任意）。",
    },
    {
      name: "score",
      type: "number",
      required: true,
      description: "generateScore ステップで算出されたスコア。",
    },
  ]}
/>

戻り値: `string`  
このメソッドは、スコアの根拠を説明する文字列を返す必要があります。

**プロンプトオブジェクトモード:**

<PropertiesTable
  content={[
    {
      name: "description",
      type: "string",
      required: true,
      description: "この推論ステップが行う処理の説明。",
    },
    {
      name: "createPrompt",
      type: "function",
      required: true,
      description: "Function: ({ run, results, score }) => string。LLM に渡すプロンプトを返します。",
    },
    {
      name: "judge",
      type: "object",
      required: false,
      description: "（任意）このステップ用の LLM ジャッジ（メインのジャッジを上書き可能）。Judge Object のセクションを参照。",
    },
  ]}
/>

すべてのステップ関数は非同期にできます。