---
title: "リファレンス: コンテキスト関連性 | Evals | Mastra ドキュメント"
description: RAG パイプラインで取得されたコンテキストの関連度を評価する「コンテキスト関連性」指標のドキュメント。
---

import { ScorerCallout } from '@/components/scorer-callout'


# ContextRelevancyMetric

<ScorerCallout />

`ContextRelevancyMetric` クラスは、取得されたコンテキストが入力クエリにどれほど関連しているかを測定することで、RAG（Retrieval-Augmented Generation）パイプラインにおけるリトリーバーの品質を評価します。LLMベースの評価手法を用い、まずコンテキストから文（ステートメント）を抽出し、その後それらが入力にどれだけ関連するかを判定します。

## 基本的な使い方

```typescript
import { openai } from "@ai-sdk/openai";
import { ContextRelevancyMetric } from "@mastra/evals/llm";

// 評価用にモデルを設定する
const model = openai("gpt-4o-mini");

const metric = new ContextRelevancyMetric(model, {
  context: [
    "すべてのデータは保存時および転送時に暗号化されています",
    "二要素認証は必須です",
    "このプラットフォームは多言語対応です",
    "当社のオフィスはサンフランシスコにあります",
  ],
});

const result = await metric.measure(
  "当社製品のセキュリティ機能は何ですか？",
  "当社製品は暗号化を採用し、2FAを必須としています。",
);

console.log(result.score); // スコア（0〜1）
console.log(result.info.reason); // 関連性評価の説明
```


## コンストラクターのパラメータ

<PropertiesTable
  content={[
    {
      name: "model",
      type: "LanguageModel",
      description:
        "コンテキストの妥当性を評価するために使用するモデルの設定",
      isOptional: false,
    },
    {
      name: "options",
      type: "ContextRelevancyMetricOptions",
      description: "メトリクスの設定オプション",
      isOptional: false,
    },
  ]}
/>

### ContextRelevancyMetricOptions

<PropertiesTable
  content={[
    {
      name: "scale",
      type: "number",
      description: "スコアの最大値",
      isOptional: true,
      defaultValue: "1",
    },
    {
      name: "context",
      type: "string[]",
      description:
        "応答の生成に用いる、検索で取得したコンテキスト文書の配列",
      isOptional: false,
    },
  ]}
/>

## measure() のパラメータ

<PropertiesTable
  content={[
    {
      name: "input",
      type: "string",
      description: "元のクエリまたはプロンプト",
      isOptional: false,
    },
    {
      name: "output",
      type: "string",
      description: "評価対象の LLM の回答",
      isOptional: false,
    },
  ]}
/>

## 戻り値

<PropertiesTable
  content={[
    {
      name: "score",
      type: "number",
      description: "コンテキスト関連度スコア（0 からのスケール、既定は 0〜1）",
    },
    {
      name: "info",
      type: "object",
      description: "スコアの理由を含むオブジェクト",
      properties: [
        {
          type: "string",
          parameters: [
            {
              name: "reason",
              type: "string",
              description: "関連度評価の詳細な説明",
            },
          ],
        },
      ],
    },
  ]}
/>

## スコアリングの詳細

この指標は、取得したコンテキストがクエリにどれほど適合しているかを、二値の関連性分類で評価します。

### スコアリング手順

1. コンテキストから文を抽出:

   - コンテキストを意味のある単位に分割
   - 意味関係を保持

2. 文の関連性を評価:
   - 各文をクエリに対して評価
   - 関連する文を数える
   - 関連度の比率を算出

最終スコア: `(relevant_statements / total_statements) * scale`

### スコアの解釈

（スケールは0から、既定は0〜1）

- 1.0: 完全に関連 - 取得されたコンテキストはすべて関連している
- 0.7〜0.9: 高い関連性 - ほとんどのコンテキストが関連しており、無関係な部分は少ない
- 0.4〜0.6: 中程度の関連性 - 関連・無関係のコンテキストが混在
- 0.1〜0.3: 低い関連性 - ほとんどが無関係なコンテキスト
- 0.0: 関連なし - 完全に無関係なコンテキスト

## カスタム設定の例

```typescript
import { openai } from "@ai-sdk/openai";
import { ContextRelevancyMetric } from "@mastra/evals/llm";

// 評価のためにモデルを設定する
const model = openai("gpt-4o-mini");

const metric = new ContextRelevancyMetric(model, {
  scale: 100, // 0〜1 ではなく 0〜100 のスケールを使用
  context: [
    "ベーシックプランは月額 $10 です",
    "プロプランは月額 $30 で高度な機能を含みます",
    "エンタープライズプランはカスタム料金です",
    "当社は 2020 年に設立されました",
    "当社は世界各地にオフィスがあります",
  ],
});

const result = await metric.measure(
  "当社の料金プランは何ですか？",
  "ベーシック、プロ、エンタープライズの各プランをご用意しています。",
);

// 出力例:
// {
//   score: 60,
//   info: {
//     reason: "5 つの記述のうち 3 つが料金プランに関連しています。会社の設立とオフィスの所在地に関する記述は、料金に関する質問とは関連しません。"
//           company founding and office locations are not relevant to the pricing query."
//   }
// }
```


## 関連

- [コンテキスト リコール指標](./contextual-recall)
- [コンテキスト精度指標](./context-precision)
- [コンテキスト位置指標](./context-position)