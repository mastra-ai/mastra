---
title: "例: 分岐パス | ワークフロー（レガシー） | Mastra ドキュメント"
description: 中間結果に応じて分岐するレガシーなワークフローを Mastra で作成する例。
---

import { GithubLink } from "@/components/github-link";


# 分岐するパス

データを処理する際には、中間結果に応じて異なる処理を行う必要がよくあります。この例では、レガシーなワークフローを作成し、複数のパスに分岐させる方法を示します。各パスでは、直前のステップの出力に基づいて異なる手順を実行します。

## 制御フロー図

この例では、前のステップの出力に基づいて各パスが異なるステップを実行する、分岐して別々の経路に進む従来型ワークフローの作成方法を示します。

制御フロー図は次のとおりです。

<img
  src="/subscribed-chains.png"
  alt="分岐経路を持つワークフローを示す図"
/>

## ステップの作成

まずは、ステップを作成してワークフローを初期化しましょう。

{/* prettier-ignore */}

```ts showLineNumbers copy
import { LegacyStep, LegacyWorkflow } from "@mastra/core/workflows/legacy";
import { z } from "zod"

const stepOne = new LegacyStep({
  id: "stepOne",
  execute: async ({ context }) => ({
    doubledValue: context.triggerData.inputValue * 2
  })
});

const stepTwo = new LegacyStep({
  id: "stepTwo",
  execute: async ({ context }) => {
    const stepOneResult = context.getStepResult<{ doubledValue: number }>("stepOne");
    if (!stepOneResult) {
      return { isDivisibleByFive: false }
    }

    return { isDivisibleByFive: stepOneResult.doubledValue % 5 === 0 }
  }
});


const stepThree = new LegacyStep({
  id: "stepThree",
  execute: async ({ context }) =>{
    const stepOneResult = context.getStepResult<{ doubledValue: number }>("stepOne");
    if (!stepOneResult) {
      return { incrementedValue: 0 }
    }

    return { incrementedValue: stepOneResult.doubledValue + 1 }
  }
});

const stepFour = new LegacyStep({
  id: "stepFour",
  execute: async ({ context }) => {
    const stepThreeResult = context.getStepResult<{ incrementedValue: number }>("stepThree");
    if (!stepThreeResult) {
      return { isDivisibleByThree: false }
    }

    return { isDivisibleByThree: stepThreeResult.incrementedValue % 3 === 0 }
  }
});

// 両方の分岐に依存する新しいステップ
const finalStep = new LegacyStep({
  id: "finalStep",
  execute: async ({ context }) => {
    // getStepResult を使って両方の分岐の結果を取得
    const stepTwoResult = context.getStepResult<{ isDivisibleByFive: boolean }>("stepTwo");
    const stepFourResult = context.getStepResult<{ isDivisibleByThree: boolean }>("stepFour");

    const isDivisibleByFive = stepTwoResult?.isDivisibleByFive || false;
    const isDivisibleByThree = stepFourResult?.isDivisibleByThree || false;

    return {
      summary: `数値 ${context.triggerData.inputValue} は、2倍にすると5で${isDivisibleByFive ? '割り切れ' : '割り切れ'}ず、2倍にして1を加えると3で${isDivisibleByThree ? '割り切れ' : '割り切れ'}ない。`,
      isDivisibleByFive,
      isDivisibleByThree
    }
  }
});

// ワークフローを構築する
const myWorkflow = new LegacyWorkflow({
  name: "my-workflow",
  triggerSchema: z.object({
    inputValue: z.number(),
  }),
});
```


## 分岐パスとステップの連結

それでは、分岐パスを持つレガシーなワークフローを設定し、複合的な `.after([])` 構文でそれらをマージしていきましょう。

```ts showLineNumbers copy
// 2 つの並行ブランチを作成する
myWorkflow
  // 1 つ目のブランチ
  .step(stepOne)
  .then(stepTwo)

  // 2 つ目のブランチ
  .after(stepOne)
  .step(stepThree)
  .then(stepFour)

  // 複合的な after 構文で両ブランチをマージする
  .after([stepTwo, stepFour])
  .step(finalStep)
  .commit();

const { start } = myWorkflow.createRun();

const result = await start({ triggerData: { inputValue: 3 } });
console.log(result.steps.finalStep.output.summary);
// 出力: "数値 3 は 2 倍にすると 5 で割り切れず、2 倍にして 1 を足すと 3 で割り切れます。"
```


## 高度なブランチとマージ

複数のブランチやマージポイントを使って、より複雑なワークフローを作成できます。

```ts showLineNumbers copy
const complexWorkflow = new LegacyWorkflow({
  name: "complex-workflow",
  triggerSchema: z.object({
    inputValue: z.number(),
  }),
});

// Create multiple branches with different merge points
complexWorkflow
  // メインステップ
  .step(stepOne)

  // 第1ブランチ
  .then(stepTwo)

  // 第2ブランチ
  .after(stepOne)
  .step(stepThree)
  .then(stepFour)

  // 第3ブランチ（stepOne からの別ルート）
  .after(stepOne)
  .step(
    new LegacyStep({
      id: "alternativePath",
      execute: async ({ context }) => {
        const stepOneResult = context.getStepResult<{ doubledValue: number }>(
          "stepOne",
        );
        return {
          result: (stepOneResult?.doubledValue || 0) * 3,
        };
      },
    }),
  )

  // 第1・第2ブランチをマージ
  .after([stepTwo, stepFour])
  .step(
    new LegacyStep({
      id: "partialMerge",
      execute: async ({ context }) => {
        const stepTwoResult = context.getStepResult<{
          isDivisibleByFive: boolean;
        }>("stepTwo");
        const stepFourResult = context.getStepResult<{
          isDivisibleByThree: boolean;
        }>("stepFour");

        return {
          intermediateResult: "最初の2つのブランチを処理済み",
          branchResults: {
            branch1: stepTwoResult?.isDivisibleByFive,
            branch2: stepFourResult?.isDivisibleByThree,
          },
        };
      },
    }),
  )

  // すべてのブランチを最終的にマージ
  .after(["partialMerge", "alternativePath"])
  .step(
    new LegacyStep({
      id: "finalMerge",
      execute: async ({ context }) => {
        const partialMergeResult = context.getStepResult<{
          intermediateResult: string;
          branchResults: { branch1: boolean; branch2: boolean };
        }>("partialMerge");

        const alternativePathResult = context.getStepResult<{ result: number }>(
          "alternativePath",
        );

        return {
          finalResult: "すべてのブランチを処理完了",
          combinedData: {
            fromPartialMerge: partialMergeResult?.branchResults,
            fromAlternativePath: alternativePathResult?.result,
          },
        };
      },
    }),
  )
  .commit();
```

<br />

<br />

<hr className="dark:border-[#404040] border-gray-300" />

<br />

<br />

<GithubLink
  link={
"https://github.com/mastra-ai/mastra/blob/main/examples/basics/workflows-legacy/workflow-with-branching-paths"
}
/>

`


## ワークフロー（レガシー）

以下のリンクでは、レガシー版ワークフローのサンプルドキュメントを参照できます。

- [シンプルなワークフローの作成（レガシー）](/examples/workflows_legacy/creating-a-workflow)
- [順次ステップのワークフロー（レガシー）](/examples/workflows_legacy/sequential-steps)
- [ステップによる並列実行（レガシー）](/examples/workflows_legacy/parallel-steps)
- [条件分岐付きワークフロー（レガシー・実験的）](/examples/workflows_legacy/conditional-branching)
- [ワークフロー（レガシー）からエージェントを呼び出す](/examples/workflows_legacy/calling-agent)
- [ツールをワークフローのステップとして使用（レガシー）](/examples/workflows_legacy/using-a-tool-as-a-step)
- [循環依存のあるワークフロー（レガシー）](/examples/workflows_legacy/cyclical-dependencies)
- [ワークフロー変数によるデータマッピング（レガシー）](/examples/workflows_legacy/workflow-variables)
- [Human-in-the-Loop ワークフロー（レガシー）](/examples/workflows_legacy/human-in-the-loop)
- [一時停止と再開が可能なワークフロー（レガシー）](/examples/workflows_legacy/suspend-and-resume)