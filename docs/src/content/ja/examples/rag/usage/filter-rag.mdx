---
title: "例: エージェント駆動のメタデータフィルタリング | Retrieval | RAG | Mastra Docs"
description: RAG システムで Mastra エージェントを用いて、ドキュメント検索向けのメタデータフィルタを作成・適用する例。
---

import { GithubLink } from "@/components/github-link";


# エージェント主導のメタデータフィルタリング

この例では、Mastra、OpenAI の埋め込み表現、そしてベクトルストレージとしての PGVector を用いて、Retrieval-Augmented Generation（RAG）システムを実装する方法を示します。
このシステムでは、エージェントがユーザーのクエリからメタデータフィルタを生成し、ベクトルストア内で関連するチャンクを検索することで、返却される結果を絞り込みます。

## 概要

このシステムは、Mastra と OpenAI を用いてメタデータのフィルタリングを実装しています。主な処理は次のとおりです:

1. クエリの意図を理解しフィルタ要件を特定するため、gpt-4o-mini を用いた Mastra エージェントをセットアップする
2. メタデータのフィルタリングとセマンティック検索に対応するベクトルクエリツールを作成する
3. ドキュメントをメタデータと埋め込み付きのチャンクに分割・処理する
4. 効率的な検索のために、ベクトルとメタデータを PGVector に保存する
5. メタデータフィルタとセマンティック検索を組み合わせてクエリを処理する

ユーザーが質問したとき:

- エージェントがクエリを分析して意図を把握する
- 適切なメタデータフィルタ（例: トピック、日付、カテゴリ）を構築する
- ベクトルクエリツールを用いて最も関連性の高い情報を見つける
- フィルタ後の結果に基づいて文脈に沿った応答を生成する

## セットアップ

### 環境設定

環境変数を設定していることを確認してください:

```bash filename=".env"
OPENAI_API_KEY=ここにOpenAIのAPIキーを入力してください
POSTGRES_CONNECTION_STRING=ここに接続文字列を入力してください
```


### 依存関係

次に、必要な依存関係をインポートします。

```typescript copy showLineNumbers filename="index.ts"
import { openai } from "@ai-sdk/openai";
import { Mastra } from "@mastra/core";
import { Agent } from "@mastra/core/agent";
import { PgVector, PGVECTOR_PROMPT } from "@mastra/pg";
import { createVectorQueryTool, MDocument } from "@mastra/rag";
import { embedMany } from "ai";
```


## ベクタークエリツールの作成

@mastra/rag からインポートした createVectorQueryTool を使うと、メタデータでのフィルタリングに対応したツールを作成できます。各ベクターストアには、サポートするフィルター演算子と構文を定義する独自のプロンプトがあります。

```typescript copy showLineNumbers{9} filename="index.ts"
const vectorQueryTool = createVectorQueryTool({
  id: "vectorQueryTool",
  vectorStoreName: "pgVector",
  indexName: "embeddings",
  model: openai.embedding("text-embedding-3-small"),
  フィルタを有効にする: true,
});
```

各プロンプトには以下が含まれます：

* サポートされる演算子（比較、配列、論理、要素）
* 各演算子の使用例
* ストア固有の制約およびルール
* 複雑なクエリの例


## ドキュメント処理

ドキュメントを作成し、メタデータ付きのチャンクに分割して処理します：

```typescript copy showLineNumbers{17} filename="index.ts"
const doc = MDocument.fromText(
  `気候変動が世界の農業に及ぼす影響…`,
);

const chunks = await doc.chunk({
  strategy: "recursive",
  size: 512,
  overlap: 50,
  separator: "\n",
  extract: {
    keywords: true, // 各チャンクからキーワードを抽出
  },
});
```


### チャンクをメタデータに変換する

チャンクを、フィルタリング可能なメタデータへ変換します:

```typescript copy showLineNumbers{31} filename="index.ts"
const chunkMetadata = chunks?.map((chunk: any, index: number) => ({
  text: chunk.text,
  ...chunk.metadata,
  nested: {
    keywords: chunk.metadata.excerptKeywords
      .replace("KEYWORDS:", "")
      .split(",")
      .map((k) => k.trim()),
    id: index,
  },
}));
```


## エージェントの設定

エージェントはユーザーのクエリを理解し、適切なメタデータフィルターに変換できるように設定されています。

エージェントには、ベクタークエリツールと、次の内容を含むシステムプロンプトの両方が必要です：

* 利用可能なフィルターフィールドのメタデータ構造
* フィルター操作および構文に関するベクターストア向けプロンプト

```typescript copy showLineNumbers{43} filename="index.ts"
export const ragAgent = new Agent({
  name: "RAGエージェント",
  model: openai("gpt-4o-mini"),
  instructions: `
  あなたは、提供されたコンテキストに基づいて質問に答える有用なアシスタントです。回答は簡潔かつ関連性の高いものにしてください。

  メタデータを検索してコンテキストを絞り込んでください。
  
  メタデータの構造は次のとおりです:

  {
    text: string,
    excerptKeywords: string,
    nested: {
      keywords: string[],
      id: number,
    },
  }

  ${PGVECTOR_PROMPT}

  重要: 質問に回答するときは、ツールで提供されたコンテキストのみに基づいて回答してください。
  質問に完全に回答するのに十分な情報がコンテキストに含まれていない場合は、その旨を明確に述べてください。
  `,
  tools: { vectorQueryTool },
});
```

エージェントの指示は次のことを目的としています:

* フィルター要件を特定するためにユーザーからの問い合わせを処理する
* 関連情報を見つけるためにメタデータ構造を活用する
* vectorQueryTool と提供されているベクターストア用プロンプトを使って適切なフィルターを適用する
* フィルター後のコンテキストに基づいて応答を生成する

> 注: ベクターストアごとに固有のプロンプトが用意されています。詳細は [Vector Store Prompts](/docs/rag/retrieval#vector-store-prompts) を参照してください。


## PgVector と Mastra のインスタンス化

次のコンポーネントで PgVector と Mastra を初期化します：

```typescript copy showLineNumbers{69} filename="index.ts"
const pgVector = new PgVector({
  connectionString: process.env.POSTGRES_CONNECTION_STRING!,
});

export const mastra = new Mastra({
  agents: { ragAgent },
  vectors: { pgVector },
});
const agent = mastra.getAgent("ragAgent");
```


## 埋め込みの作成と保存

埋め込みを生成し、メタデータと一緒に保存します:

```typescript copy showLineNumbers{78} filename="index.ts"
const { embeddings } = await embedMany({
  model: openai.embedding("text-embedding-3-small"),
  values: chunks.map((chunk) => chunk.text),
});

const vectorStore = mastra.getVector("pgVector");
await vectorStore.createIndex({
  indexName: "embeddings",
  dimension: 1536,
});

// 埋め込みとメタデータをまとめて保存する
await vectorStore.upsert({
  indexName: "embeddings",
  vectors: embeddings,
  metadata: chunkMetadata,
});
```

`upsert` 操作はベクトル埋め込みとそれに対応するメタデータの両方を保存し、セマンティック検索とメタデータによるフィルタリングを組み合わせた機能を実現します。


## メタデータベースのクエリ

メタデータのフィルターを使って、さまざまなクエリを試してみましょう：

```typescript copy showLineNumbers{96} filename="index.ts"
const queryOne = "言及されている適応戦略は何ですか？";
const answerOne = await agent.generate(queryOne);
console.log("\nクエリ:", queryOne);
console.log("レスポンス:", answerOne.text);

const queryTwo =
  '最近のセクションを表示してください。"nested.id" フィールドを確認し、2より大きい値を返してください。';
const answerTwo = await agent.generate(queryTwo);
console.log("\nクエリ:", queryTwo);
console.log("レスポンス:", answerTwo.text);

const queryThree =
  '"text" フィールドを正規表現演算子で検索し、「temperature」を含むセクションを見つけてください。';
const answerThree = await agent.generate(queryThree);
console.log("\nクエリ:", queryThree);
console.log("レスポンス:", answerThree.text);
```

<br />

<br />

<hr className="dark:border-[#404040] border-gray-300" />

<br />

<br />

<GithubLink
  link={
"https://github.com/mastra-ai/mastra/blob/main/examples/basics/rag/filter-rag"
}
/>
