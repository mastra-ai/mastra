---
title: "例: Chain-of-Thought プロンプティング | RAG | Mastra ドキュメント"
description: OpenAI と PGVector を用いて、Mastra で Chain-of-Thought 推論を活用する RAG システムを実装する例。
---

import { GithubLink } from "@/components/github-link";


# 連鎖思考プロンプティング

この例では、Mastra、OpenAI の埋め込み、そしてベクトルストアとしての PGVector を用いて、連鎖思考型の推論に重点を置いた Retrieval-Augmented Generation（RAG）システムの実装方法を示します。

## 概要

このシステムは、Mastra と OpenAI を用いて、Chain-of-Thought プロンプティングによる RAG を実装しています。主な処理は次のとおりです。

1. 応答生成のために gpt-4o-mini を用いる Mastra エージェントをセットアップ
2. ベクトルストアとのやり取りを管理するためのベクトルクエリツールを作成
3. テキストドキュメントを小さなチャンクに分割
4. これらのチャンクに対して埋め込みを作成
5. PostgreSQL のベクトルデータベースに保存
6. ベクトルクエリツールでクエリに基づき関連チャンクを取得
7. Chain-of-Thought 推論を用いて文脈に即した応答を生成

## セットアップ

### 環境のセットアップ

環境変数が設定されていることを確認してください:

```bash filename=".env"
OPENAI_API_KEY=あなたの_openai_api_key_をここに入力
POSTGRES_CONNECTION_STRING=あなたの接続文字列をここに入力
```


### 依存関係

次に、必要な依存関係をインポートします。

```typescript copy showLineNumbers filename="index.ts"
import { openai } from "@ai-sdk/openai";
import { Mastra } from "@mastra/core";
import { Agent } from "@mastra/core/agent";
import { PgVector } from "@mastra/pg";
import { createVectorQueryTool, MDocument } from "@mastra/rag";
import { embedMany } from "ai";
```


## ベクタークエリツールの作成

@mastra/rag からインポートした createVectorQueryTool を使うと、ベクターデータベースに対してクエリを実行するツールを作成できます。

```typescript copy showLineNumbers{8} filename="index.ts"
const vectorQueryTool = createVectorQueryTool({
  vectorStoreName: "pgVector",
  indexName: "embeddings",
  model: openai.embedding("text-embedding-3-small"),
});
```


## エージェントの設定

Mastra エージェントを chain-of-thought によるプロンプト指示で設定します：

```typescript copy showLineNumbers{14} filename="index.ts"
export const ragAgent = new Agent({
  name: "RAG Agent",
  instructions: `あなたは、提供されたコンテキストに基づいて質問に回答する有用なアシスタントです。
各回答では、次の手順に従ってください:

1. まず、取得したコンテキストのチャンクを注意深く分析し、重要な情報を特定する。
2. 取得情報が問い合わせにどう関係するかについて、考え方のプロセスを分解する。
3. 取得したチャンクの異なる要素同士をどう結び付けているかを説明する。
4. 取得コンテキスト中の証拠のみに基づいて結論を導く。
5. 取得したチャンクに十分な情報がない場合は、何が不足しているかを明確に述べる。

回答の形式:
思考プロセス:
- ステップ1: [取得したチャンクの初期分析]
- ステップ2: [チャンク間の関連付け]
- ステップ3: [チャンクに基づく推論]

最終回答:
[取得したコンテキストに基づく簡潔な回答]

重要: 質問に答える際は、ツールで提供されたコンテキストのみに基づいて回答してください。
コンテキストに質問へ完全に回答するのに十分な情報が含まれていない場合は、その旨を明確に述べてください。
注意: 結論に至るまでに、取得情報をどのように活用したかを説明してください。
`,
  model: openai("gpt-4o-mini"),
  tools: { vectorQueryTool },
});
```


## PgVector と Mastra のインスタンス化

すべてのコンポーネントを含めて、PgVector と Mastra をインスタンス化します。

```typescript copy showLineNumbers{36} filename="index.ts"
const pgVector = new PgVector({
  connectionString: process.env.POSTGRES_CONNECTION_STRING!,
});

export const mastra = new Mastra({
  agents: { ragAgent },
  vectors: { pgVector },
});
const agent = mastra.getAgent("ragAgent");
```


## ドキュメント処理

ドキュメントを作成し、チャンクに分割して処理します：

```typescript copy showLineNumbers{44} filename="index.ts"
const doc = MDocument.fromText(
  `気候変動が世界の農業に及ぼす影響...`,
);

const chunks = await doc.chunk({
  strategy: "recursive",
  size: 512,
  overlap: 50,
  separator: "\n",
});
```


## 埋め込みの作成と保存

チャンクの埋め込みを生成し、ベクター データベースに保存します。

```typescript copy showLineNumbers{55} filename="index.ts"
const { embeddings } = await embedMany({
  values: chunks.map((chunk) => chunk.text),
  model: openai.embedding("text-embedding-3-small"),
});

const vectorStore = mastra.getVector("pgVector");
await vectorStore.createIndex({
  indexName: "embeddings",
  dimension: 1536,
});
await vectorStore.upsert({
  indexName: "embeddings",
  vectors: embeddings,
  metadata: chunks?.map((chunk: any) => ({ text: chunk.text })),
});
```


## Chain-of-Thought クエリ

エージェントがどのように思考過程を分解するかを確認するため、さまざまなクエリを試してみてください。

```typescript copy showLineNumbers{83} filename="index.ts"
const answerOne = await agent.generate(
  "農業者の主な適応戦略は何ですか？",
);
console.log("\nクエリ:", "農業者の主な適応戦略は何ですか？");
console.log("回答:", answerOne.text);

const answerTwo = await agent.generate(
  "気温が作物収量に与える影響を分析してください。",
);
console.log("\nクエリ:", "気温が作物収量に与える影響を分析してください。");
console.log("回答:", answerTwo.text);

const answerThree = await agent.generate(
  "気候変動と食料安全保障にはどのような関係がありますか？",
);
console.log(
  "\nクエリ:",
  "気候変動と食料安全保障にはどのような関係がありますか？",
);
console.log("回答:", answerThree.text);
```

<br />

<br />

<hr className="dark:border-[#404040] border-gray-300" />

<br />

<br />

<GithubLink
  link={
"https://github.com/mastra-ai/mastra/blob/main/examples/basics/rag/cot-rag"
}
/>
