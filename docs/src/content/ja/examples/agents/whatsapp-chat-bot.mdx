---
title: "例: WhatsApp チャットボット | エージェント | Mastra ドキュメント"
description: Mastra のエージェントとワークフローを用いて、受信メッセージを処理し、テキストメッセージで自然に応答する WhatsApp チャットボットを作成する例。
---

# WhatsApp チャットボット

この例では、Mastra のエージェントとワークフローを使って WhatsApp チャットボットを作成する方法を紹介します。ボットは webhook で受信した WhatsApp メッセージを AI エージェントで処理し、応答を自然な複数のテキストメッセージに分割して、WhatsApp Business API 経由で送信します。

## 前提条件

この例を実行するには、WhatsApp Business API のセットアップが必要で、`anthropic` モデルを使用します。以下の環境変数を `.env` ファイルに追加してください:

```bash filename=".env" copy
ANTHROPIC_API_KEY=<your-anthropic-api-key>
WHATSAPP_VERIFY_TOKEN=<your-verify-token>
WHATSAPP_ACCESS_TOKEN=<your-whatsapp-access-token>
WHATSAPP_BUSINESS_PHONE_NUMBER_ID=<your-phone-number-id>
WHATSAPP_API_VERSION=v22.0
```


## WhatsApp クライアントの作成

このクライアントは、WhatsApp Business API を使用してユーザーにメッセージを送信します。

```typescript filename="src/whatsapp-client.ts" showLineNumbers copy
// メッセージ送信用のシンプルなWhatsApp Business APIクライアント

interface SendMessageParams {
  to: string;
  message: string;
}

export async function sendWhatsAppMessage({ to, message }: SendMessageParams) {
  // WhatsApp APIの環境変数を取得
  const apiVersion = process.env.WHATSAPP_API_VERSION || "v22.0";
  const phoneNumberId = process.env.WHATSAPP_BUSINESS_PHONE_NUMBER_ID;
  const accessToken = process.env.WHATSAPP_ACCESS_TOKEN;

  // 必須の環境変数が設定されているか確認
  if (!phoneNumberId || !accessToken) {
    return false;
  }

  // WhatsApp Business APIのエンドポイント
  const url =
    `https://graph.facebook.com/${apiVersion}/${phoneNumberId}/messages`;

  // WhatsApp API形式に従ったメッセージペイロード
  const payload = {
    messaging_product: "whatsapp",
    recipient_type: "individual",
    to: to,
    type: "text",
    text: {
      body: message,
    },
  };

  try {
    // WhatsApp Business API経由でメッセージを送信
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${accessToken}`,
      },
      body: JSON.stringify(payload),
    });

    const result = await response.json();

    if (response.ok) {
      console.log(`✅ WhatsAppメッセージを${to}に送信しました:「${message}」`);
      return true;
    } else {
      console.error("❌ WhatsAppメッセージの送信に失敗しました:", result);
      return false;
    }
  } catch (error) {
    console.error("❌ WhatsAppメッセージの送信中にエラーが発生しました:", error);
    return false;
  }
}
```


## チャットエージェントの作成

このエージェントは、フレンドリーで会話的な人格を持ち、主要な対話ロジックを担います。

```typescript filename="src/mastra/agents/chat-agent.ts" showLineNumbers copy
import { anthropic } from "@ai-sdk/anthropic";
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const chatAgent = new Agent({
  name: "チャットエージェント",
  instructions: `
    あなたはWhatsAppでユーザーとチャットするのが大好きな、親切でフレンドリーかつ知識豊富なAIアシスタントです。

    あなたの性格:
    - 温かく、親しみやすく、会話的である
    - どんなトピックでも喜んで手助けする
    - 友達とチャットしているようなカジュアルでフレンドリーな口調を使う
    - 簡潔でありながら情報量が豊富である
    - ユーザーの質問に真摯な関心を示す

    あなたの能力:
    - 幅広いトピックに関する質問に答える
    - 役立つアドバイスや提案を提供する
    - カジュアルな会話を楽しむ
    - 問題解決や創造的なタスクをサポートする
    - 複雑なトピックをわかりやすく説明する

    ガイドライン:
    - 情報量は豊富にしつつも、圧倒的にならないようにする
    - 適切な場合はフォローアップの質問をする
    - 励ましとポジティブな姿勢を持つ
    - わからないことがあれば正直に認める
    - ユーザーの口調に合わせてコミュニケーションスタイルを調整する
    - これはWhatsAppでのやり取りなので、会話的で自然な雰囲気を保つ

    常に親しみやすく会話的なスタイルを維持しながら、役立つことを目指してください。
  `,
  model: anthropic("claude-4-sonnet-20250514"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:../mastra.db",
    }),
  }),
});
```


## テキストメッセージ用エージェントの作成

このエージェントは、長文の回答を、WhatsAppに適した自然で短いテキストメッセージに分割して変換します。

```typescript filename="src/mastra/agents/text-message-agent.ts" showLineNumbers copy
import { anthropic } from "@ai-sdk/anthropic";
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

export const textMessageAgent = new Agent({
  name: "テキストメッセージエージェント",
  instructions: `
    あなたは、フォーマルな文章や長文を自然でカジュアルなテキストメッセージに変換するコンバーターです。

    あなたの役割:
    - 入力されたテキストを5〜8個の短くカジュアルなメッセージに変換する
    - 各メッセージは最大1〜2文にする
    - 自然でフレンドリーなメッセージの言葉遣いを使う(短縮形、カジュアルな口調)
    - 元のテキストの重要な情報はすべて保持する
    - 友達にメッセージを送っているような雰囲気にする
    - 個性を出すために絵文字を適度に使う
    - 会話の流れを論理的でわかりやすく保つ

    友達にメッセージで何かワクワクすることを説明するイメージで - 長い文章で圧倒せず、読みやすく魅力的なメッセージに分割してください。

    必ずmessages配列に5〜8個のメッセージを返してください。
  `,
  model: anthropic("claude-4-sonnet-20250514"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:../mastra.db",
    }),
  }),
});
```


## チャットワークフローの作成

このワークフローは、応答の生成、メッセージへの分割、そして WhatsApp 経由での送信まで、チャット全体の処理を統括します。

```typescript filename="src/mastra/workflows/chat-workflow.ts" showLineNumbers copy
import { createStep, createWorkflow } from "@mastra/core/workflows";
import { z } from "zod";
import { sendWhatsAppMessage } from "../../whatsapp-client";

const respondToMessage = createStep({
  id: "respond-to-message",
  description: "ユーザーメッセージへの応答を生成",
  inputSchema: z.object({ userMessage: z.string() }),
  outputSchema: z.object({ response: z.string() }),
  execute: async ({ inputData, mastra }) => {
    const agent = mastra?.getAgent("chatAgent");
    if (!agent) {
      throw new Error("チャットエージェントが見つかりません");
    }

    const response = await agent.generate(
      [{ role: "user", content: inputData.userMessage }],
    );

    return { response: response.text };
  },
});

const breakIntoMessages = createStep({
  id: "break-into-messages",
  description: "応答をテキストメッセージに分割",
  inputSchema: z.object({ prompt: z.string() }),
  outputSchema: z.object({ messages: z.array(z.string()) }),
  execute: async ({ inputData, mastra }) => {
    const agent = mastra?.getAgent("textMessageAgent");
    if (!agent) {
      throw new Error("テキストメッセージエージェントが見つかりません");
    }

    const response = await agent.generate(
      [{ role: "user", content: inputData.prompt }],
      {
        structuredOutput: {
          schema: z.object({
            messages: z.array(z.string()),
          }),
        },
      },
    );

    if (!response.object) throw new Error("メッセージの生成エラー");

    return response.object;
  },
});

const sendMessages = createStep({
  id: "send-messages",
  description: "WhatsApp経由でテキストメッセージを送信",
  inputSchema: z.object({
    messages: z.array(z.string()),
    userPhone: z.string(),
  }),
  outputSchema: z.object({ sentCount: z.number() }),
  execute: async ({ inputData }) => {
    const { messages, userPhone } = inputData;

    console.log(
      `\n🔥 ${userPhone}に${messages.length}件のWhatsAppメッセージを送信中...`,
    );

    let sentCount = 0;

    // 自然な流れのため、各メッセージ間に短い遅延を入れる
    for (let i = 0; i < messages.length; i++) {
      const success = await sendWhatsAppMessage({
        to: userPhone,
        message: messages[i],
      });

      if (success) {
        sentCount++;
      }

      // 自然なテキストのリズムのため、メッセージ間に遅延を追加
      if (i < messages.length - 1) {
        await new Promise((resolve) => setTimeout(resolve, 1000));
      }
    }

    console.log(
      `\n✅ WhatsAppメッセージを${sentCount}/${messages.length}件送信しました\n`,
    );

    return { sentCount };
  },
});

export const chatWorkflow = createWorkflow({
  id: "chat-workflow",
  inputSchema: z.object({ userMessage: z.string() }),
  outputSchema: z.object({ sentCount: z.number() }),
})
  .then(respondToMessage)
  .map(async ({ inputData }) => ({
    prompt:
      `このAI応答を、WhatsApp会話で自然に感じられる3〜8件のカジュアルでフレンドリーなテキストメッセージに分割してください:\n\n${inputData.response}`,
  }))
  .then(breakIntoMessages)
  .map(async ({ inputData, getInitData }) => {
    // 元の文字列化された入力を解析してユーザーの電話番号を取得
    const initData = getInitData();
    const webhookData = JSON.parse(initData.userMessage);
    const userPhone =
      webhookData.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from ||
      "unknown";

    return {
      messages: inputData.messages,
      userPhone,
    };
  })
  .then(sendMessages);

chatWorkflow.commit();
```


## Mastra の設定

Mastra インスタンスにエージェント、ワークフロー、WhatsApp の Webhook エンドポイントを設定します。

```typescript filename="src/mastra/index.ts" showLineNumbers copy
import { Mastra } from "@mastra/core/mastra";
import { registerApiRoute } from "@mastra/core/server";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";

import { chatWorkflow } from "./workflows/chat-workflow";
import { textMessageAgent } from "./agents/text-message-agent";
import { chatAgent } from "./agents/chat-agent";

export const mastra = new Mastra({
  workflows: { chatWorkflow },
  agents: { textMessageAgent, chatAgent },
  storage: new LibSQLStore({
    url: ":memory:",
  }),
  logger: new PinoLogger({
    name: "Mastra",
    level: "info",
  }),
  server: {
    apiRoutes: [
      registerApiRoute("/whatsapp", {
        method: "GET",
        handler: async (c) => {
          const verifyToken = process.env.WHATSAPP_VERIFY_TOKEN;
          const {
            "hub.mode": mode,
            "hub.challenge": challenge,
            "hub.verify_token": token,
          } = c.req.query();

          if (mode === "subscribe" && token === verifyToken) {
            return c.text(challenge, 200);
          } else {
            return c.status(403);
          }
        },
      }),
      registerApiRoute("/whatsapp", {
        method: "POST",
        handler: async (c) => {
          const mastra = c.get("mastra");
          const chatWorkflow = mastra.getWorkflow("chatWorkflow");

          const body = await c.req.json();

          const workflowRun = await chatWorkflow.createRunAsync();
          const runResult = await workflowRun.start({
            inputData: { userMessage: JSON.stringify(body) },
          });

          return c.json(runResult);
        },
      }),
    ],
  },
});
```


## チャットボットのテスト

WhatsApp の Webhook ペイロードをシミュレートして、ローカル環境でチャットボットをテストできます。

```typescript filename="src/test-whatsapp-bot.ts" showLineNumbers copy
import "dotenv/config";

import { mastra } from "./mastra";

// WhatsApp Webhookペイロードをシミュレート
const mockWebhookData = {
  entry: [
    {
      changes: [
        {
          value: {
            messages: [
              {
                from: "1234567890", // テスト用電話番号
                text: {
                  body: "こんにちは!今日は元気ですか?"
                }
              }
            ]
          }
        }
      ]
    }
  ]
};

const workflow = mastra.getWorkflow("chatWorkflow");
const workflowRun = await workflow.createRunAsync();

const result = await workflowRun.start({
  inputData: { userMessage: JSON.stringify(mockWebhookData) }
});

console.log("ワークフロー完了:", result);
```


## 出力例

ユーザーがあなたの WhatsApp ボットに「Hello! How are you today?」と送信すると、次のように複数のメッセージで応答することがあります。

```text
やあ!👋 元気だよ、聞いてくれてありがとう!

今日はどんな感じ?

何でも話したいことがあれば、ここにいるよ

何か手伝いが必要でも、ただ話したいだけでも、いつでも聞くよ!😊

最近どう?
```

ボットは会話のコンテキストを記憶に保持し、WhatsAppでのやり取りに自然になじむ応答を返します。
