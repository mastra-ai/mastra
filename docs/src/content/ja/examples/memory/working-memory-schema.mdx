---
title: "例: スキーマを用いたワーキングメモリ | Memory | Mastra Docs"
description: Zod スキーマを使ってワーキングメモリのデータを構造化・検証する方法を示す例。
---

# スキーマを用いたワーキングメモリ

ワーキングメモリに保存する情報の構造を定義するために Zod スキーマを使用します。スキーマは、エージェントが会話をまたいで抽出・保持するデータに対して型安全性とバリデーションを提供します。

これは `.stream()` によるストリーミング応答と `.generate()` による生成応答の両方で動作し、セッション間でデータを保持するには PostgreSQL、LibSQL、Redis などのストレージプロバイダが必要です。

この例では、ワーキングメモリ用スキーマを使って ToDo リストを管理する方法を示します。

## 前提条件

この例では `openai` モデルを使用します。`.env` ファイルに `OPENAI_API_KEY` を追加してください。

```bash filename=".env" copy
OPENAI_API_KEY=<あなたのAPIキー>
```

次のパッケージをインストールします：

```bash copy
npm install @mastra/libsql
```


## エージェントにメモリを追加する

エージェントに LibSQL のメモリを追加するには、`Memory` クラスを使用し、`LibSQLStore` を用いて `storage` インスタンスを渡します。`url` はリモートの場所またはローカルファイルを指すことができます。

### `schema` を用いたワーキングメモリ

`workingMemory.enabled` を `true` に設定してワーキングメモリを有効にします。これにより、エージェントはやり取りの間で構造化された情報を記憶できるようになります。

`schema` を指定すると、エージェントが情報を記憶する際の形式を定義できます。この例では、タスクをアクティブと完了のリストに分けています。

スレッドは関連するメッセージを会話としてまとめます。`generateTitle` を有効にすると、各スレッドには内容に基づいた説明的な名前が自動的に付けられます。

```typescript filename="src/mastra/agents/example-working-memory-schema-agent.ts" showLineNumbers copy
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { LibSQLStore } from "@mastra/libsql";
import { z } from "zod";

export const workingMemorySchemaAgent = new Agent({
  name: "working-memory-schema-agent",
  instructions: `
    あなたはToDoリストAIエージェントです。
    会話開始時には、必ず現在のリストを表示してください。
    各タスクには、インデックス番号付きのタイトル、期限、説明、ステータス、推定時間を含めてください。
    各フィールドには絵文字を使用してください。
    サブタスクは箇条書きで対応してください。
    タイムボクシングに役立てるため、時間の見積もりを尋ねてください。
  `,
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:working-memory-schema.db"
    }),
    options: {
      workingMemory: {
        enabled: true,
        schema: z.object({
          items: z.array(
            z.object({
              title: z.string(),
              due: z.string().optional(),
              description: z.string(),
              status: z.enum(["active", "completed"]).default("active"),
              estimatedTime: z.string().optional(),
            })
          )
        })
      },
      threads: {
        generateTitle: true  // 自動タイトル生成を明示的に有効化
      }
    }
  })
});
```


## 使用例

この例では、構造化情報を管理するためにワーキングメモリのスキーマを用いるエージェントとのやり取り方法を示します。エージェントは、同一スレッド内での複数回の対話にわたり、ToDo リストを更新し、永続化します。

### `.stream()` を使ったレスポンスのストリーミング

この例では、新しいタスクを含むメッセージをエージェントに送信します。レスポンスはストリーミングされ、更新された ToDo リストが含まれます。

```typescript filename="src/test-working-memory-schema-agent.ts" showLineNumbers copy
import "dotenv/config";

import { mastra } from "./mastra";

const threadId = "123";
const resourceId = "user-456";

const agent = mastra.getAgent("workingMemorySchemaAgent");

const stream = await agent.stream("タスクを追加: 当社のアプリに新機能を構築してください。所要時間は約2時間で、締切は次の金曜日までです。", {
  memory: {
    thread: threadId,
    resource: resourceId
  }
});

for await (const chunk of stream.textStream) {
  process.stdout.write(chunk);
}
```


### `.generate()` を使って応答を生成する

この例では、新しいタスクを指示するメッセージをエージェントに送信します。応答は単一のメッセージとして返され、更新後のToDoリストが含まれます。

```typescript filename="src/test-working-memory-schema-agent.ts" showLineNumbers copy
import "dotenv/config";

import { mastra } from "./mastra";

const threadId = "123";
const resourceId = "user-456";

const agent = mastra.getAgent("workingMemorySchemaAgent");

const response = await agent.generate("タスクを追加：当社のアプリに新機能を実装してください。作業時間は約2時間で、締め切りは来週の金曜日です。", {
  memory: {
    thread: threadId,
    resource: resourceId
  }
});

console.log(response.text);
```


## 出力例

この出力は、zod スキーマで定義された構造に従って、エージェントが更新済みの todo リストをどのように整形して返すかを示しています。

```text
# タスクリスト
## 進行中の項目
1. 🛠️ **タスク:** アプリの新機能を実装する
   - 📅 **期限:** 来週の金曜日
   - 📝 **説明:** 既存のアプリケーションに新機能を開発して統合する。
   - ⏳ **ステータス:** 未着手
   - ⏲️ **見積時間:** 2時間

## 完了済みの項目
- まだありません
```


## ストレージオブジェクトの例

Working memory はデータを `.json` 形式で保存します。見た目は次のようになります。

```json
{
  // ...
  "toolInvocations": [
    {
      // ...
      "args": {
        "memory": {
          "items": [
            {
              "title": "アプリの新機能を開発する",
              "due": "来週の金曜日",
              "description": "",
              "status": "進行中",
              "estimatedTime": "2時間"
            }
          ]
        }
      },
    }
  ],
}
```


## 関連項目

- [エージェントの呼び出し](../agents/calling-agents.mdx#from-the-command-line)
- [エージェントのメモリ](../../docs/agents/agent-memory.mdx)
- [サーバーレスデプロイ](../../docs/deployment/server-deployment.mdx#libsqlstore)