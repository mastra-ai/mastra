---
title: "AIトレーシングの基本 | 例 | 可観測性 | Mastra ドキュメント"
description: Mastra アプリケーションで AI トレーシングを始めましょう
---

import { Callout } from "nextra/components";


# AI トレーシングの基本例

この例では、Mastra アプリケーションで、エージェントやワークフローを自動計測しながら AI トレーシングを基本的に設定する方法を紹介します。

## 前提条件

- Mastra v0.14.0 以上
- Node.js 18 以上
- 設定済みのストレージ・バックエンド（libsql または memory）

## セットアップ

### 1. 依存関係のインストール

```bash npm2yarn
npm install @mastra/core
```

Mastra Cloudでトレースを表示するには、アクセス トークンを含む `.env` ファイルを作成してください：

```bash
export MASTRA_CLOUD_ACCESS_TOKEN=your_token_here
```


### 2. 既定のトレースで Mastra を設定する

AI トレースを有効にした Mastra の設定を作成します:

```typescript filename="src/mastra/index.ts" showLineNumbers copy
import { Mastra } from "@mastra/core";
import { LibSQLStorage } from "@mastra/libsql";

export const mastra = new Mastra({
  // ストレージの設定（DefaultExporterに必要）
  storage: new LibSQLStorage({
    url: 'file:local.db'
  }),

  // デフォルト設定でAIトレースを有効化
  observability: {
    default: { enabled: true }
  }
});
```

このデフォルト構成には自動的に次が含まれます：

* **[DefaultExporter](/docs/observability/ai-tracing/exporters/default)** - トレースをストレージに永続化します
* **[CloudExporter](/docs/observability/ai-tracing/exporters/cloud)** - Mastra Cloud に送信します（トークンが設定されている場合）
* **[SensitiveDataFilter](/docs/observability/ai-tracing/processors/sensitive-data-filter)** - 機密フィールドをマスクします
* **[100% sampling](/docs/observability/ai-tracing/overview#always-sample)** - すべてのトレースを収集します


### 3. 自動トレースを有効にしたエージェントを作成する

```typescript filename="src/mastra/agents/example-agent.ts" showLineNumbers copy
import { Agent } from "@mastra/core/agent";
import { createTool } from "@mastra/core/tools";
import { openai } from "@ai-sdk/openai";

// createToolを使ってツールを作成
const getCurrentTime = createTool({
  name: "getCurrentTime",
  description: "現在時刻を取得",
  input: {},
  execute: async () => {
    // ツール呼び出しは自動的にトレースされます
    return { time: new Date().toISOString() };
  }
});

export const exampleAgent = new Agent({
  name: "example-agent",
  instructions: "あなたは親切なAIアシスタントです。",
  model: openai("gpt-4"),
  tools: {
    getCurrentTime
  }
});
```


### 4. 実行してトレースを確認する

```typescript filename="src/example.ts" showLineNumbers copy
import { mastra } from "./mastra";

async function main() {
  // エージェントを取得
  const agent = mastra.getAgent("example-agent");

  // エージェントを実行 - 自動的にトレースを作成
  const result = await agent.generate("今何時ですか？");

  console.log("エージェントの応答:", result.text);
  console.log("トレースID:", result.traceId);
  console.log("トレースを表示: http://localhost:3000/traces/" + result.traceId);
}

main().catch(console.error);
```


## 何がトレースされるのか

この例を実行すると、Mastraは自動的に次のスパンを作成します：

1. **AGENT&#95;RUN** - エージェントの全体実行
2. **MODEL&#95;GENERATION** - エージェント内でのモデル実行
3. **TOOL&#95;CALL** - ツール実行

トレース階層の例：

```
AGENT_RUN (example-agent)
├── MODEL_GENERATION (gpt-4) - モデル入出力
├── TOOL_CALL (getCurrentTime) - ツール実行
```


## トレースの表示

Playground または Mastra Cloud で Observability ページに移動し、Trace をクリックします。個々の span をクリックすると、input、output、attributes、metadata を確認できます。

## カスタムメタデータの追加

トレースにカスタムメタデータを付与して充実させましょう。

```typescript filename="src/example-with-metadata.ts" showLineNumbers copy
const result = await agent.generate(
  "今は何時ですか？",
  {
    // トレースにカスタムメタデータを追加する
    metadata: {
      userId: "user_123",
      sessionId: "session_abc",
      feature: "時刻照会",
      environment: "開発"
    }
  }
);
```


## 関連情報

### ドキュメント

- [AI トレーシング概要](/docs/observability/ai-tracing/overview) - トレーシングの完全ガイド
- [機密データフィルター](/docs/observability/ai-tracing/processors/sensitive-data-filter) - 機密情報のマスキング
- [構成パターン](/docs/observability/ai-tracing/overview#common-configuration-patterns--troubleshooting) - ベストプラクティス

### 参考

- [Configuration](/reference/observability/ai-tracing/configuration) - ObservabilityConfig API
- [Exporters](/reference/observability/ai-tracing/exporters/default-exporter) - DefaultExporter の詳細
- [Span Types](/reference/observability/ai-tracing/span) - Span のインターフェースとメソッド
- [AITracing Classes](/reference/observability/ai-tracing/ai-tracing) - トレーシングのコアクラス