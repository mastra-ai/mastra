---
title: "例: Text to Speech（テキスト読み上げ） | Voice | Mastra ドキュメント"
description: Mastra を使ってテキスト読み上げアプリケーションを作成する例。
---

import { GithubLink } from "@/components/github-link";


# インタラクティブ・ストーリージェネレーター

以下のコードスニペットは、Mastra を独立したバックエンド統合として用いた Next.js 製のインタラクティブ・ストーリージェネレーターアプリでの Text-to-Speech（TTS）機能の実装例です。この例では、Mastra の client-js SDK を使用して Mastra バックエンドに接続する方法を示します。Next.js と Mastra の連携について詳しくは、[Integrate with Next.js](/docs/frameworks/next-js) のドキュメントをご参照ください。

## TTS 機能を備えたエージェントの作成

次の例では、バックエンドで TTS 機能を持つ物語生成エージェントを設定する方法を示します。

```typescript filename="src/mastra/agents/index.ts"
import { openai } from "@ai-sdk/openai";
import { Agent } from "@mastra/core/agent";
import { OpenAIVoice } from "@mastra/voice-openai";
import { Memory } from "@mastra/memory";

const instructions = `
    あなたはインタラクティブなストーリーテラーのエージェントです。あなたの役割は、魅力的で、
    ユーザーの選択が物語に影響する短編ストーリーを作成することです。 // 簡潔にするため一部省略
`;

export const storyTellerAgent = new Agent({
  name: "ストーリーテラー・エージェント",
  instructions: instructions,
  model: openai("gpt-4o"),
  voice: new OpenAIVoice(),
});
```


## Mastra へのエージェント登録

このスニペットは、Mastra インスタンスにエージェントを登録する方法を示します。

```typescript filename="src/mastra/index.ts"
import { PinoLogger } from "@mastra/loggers";
import { Mastra } from "@mastra/core/mastra";
import { storyTellerAgent } from "./agents";

export const mastra = new Mastra({
  agents: { storyTellerAgent },
  logger: new PinoLogger({
    name: "Mastra",
    level: "info",
  }),
});
```


## フロントエンドから Mastra に接続する

ここでは Mastra Client SDK を使用して、Mastra サーバーと通信します。Mastra Client SDK の詳細については、[ドキュメント](../../docs/server-db/mastra-client.mdx)をご覧ください。

```typescript filename="src/app/page.tsx"
import { MastraClient } from "@mastra/client-js";

export const mastraClient = new MastraClient({
  baseUrl: "http://localhost:4111", // Mastra のバックエンドのURLに置き換えてください
});
```


## ストーリー内容の生成と音声化

この例では、Mastra エージェントへの参照を取得し、ユーザー入力にもとづいてストーリー内容を生成し、その内容を音声に変換する方法を示します。

```typescript filename="/app/components/StoryManager.tsx"
const handleInitialSubmit = async (formData: FormData) => {
  setIsLoading(true);
  try {
    const agent = mastraClient.getAgent("storyTellerAgent");
    const message = `現在のフェーズ: BEGINNING。物語のジャンル: ${formData.genre}、主人公の名前: ${formData.protagonistDetails.name}、主人公の年齢: ${formData.protagonistDetails.age}、主人公の性別: ${formData.protagonistDetails.gender}、主人公の職業: ${formData.protagonistDetails.occupation}、物語の設定: ${formData.setting}`;
    const storyResponse = await agent.generate({
      messages: [{ role: "user", content: message }],
      threadId: storyState.threadId,
      resourceId: storyState.resourceId,
    });

    const storyText = storyResponse.text;

    const audioResponse = await agent.voice.speak(storyText);

    if (!audioResponse.body) {
      throw new Error("音声ストリームを受信できませんでした");
    }

    const audio = await readStream(audioResponse.body);

    setStoryState((prev) => ({
      phase: "beginning",
      threadId: prev.threadId,
      resourceId: prev.resourceId,
      content: {
        ...prev.content,
        beginning: storyText,
      },
    }));

    setAudioBlob(audio);
    return audio;
  } catch (error) {
    console.error("物語の冒頭を生成中にエラーが発生しました:", error);
  } finally {
    setIsLoading(false);
  }
};
```


## オーディオの再生

このスニペットは、新しい音声データを監視し、テキスト読み上げの音声を再生する方法を示します。音声を受信すると、コードは音声のBlobからブラウザーで再生可能なURLを作成し、それをaudio要素に設定して、自動再生を試みます。

```typescript filename="/app/components/StoryManager.tsx"
useEffect(() => {
  if (!audioRef.current || !audioData) return;

  // HTML の audio 要素への参照を保持する
  const currentAudio = audioRef.current;

  // Mastra の Blob/File 音声データを、ブラウザで再生可能な URL に変換する
  const url = URL.createObjectURL(audioData);

  const playAudio = async () => {
    try {
      currentAudio.src = url;
      await currentAudio.load();
      await currentAudio.play();
      setIsPlaying(true);
    } catch (error) {
      console.error("自動再生に失敗しました:", error);
    }
  };

  playAudio();

  return () => {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.src = "";
      URL.revokeObjectURL(url);
    }
  };
}, [audioData]);
```

インタラクティブ・ストーリー・ジェネレーターの完全な実装は、私たちのGitHubリポジトリでご覧いただけます。

<br />

<br />

<hr className="dark:border-[#404040] border-gray-300" />

<br />

<br />

<GithubLink
  link={
"https://github.com/mastra-ai/voice-examples/tree/main/text-to-speech/interactive-story"
}
/>
