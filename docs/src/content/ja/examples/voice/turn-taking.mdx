---
title: 発話の順番
description: Mastra を使って、順番に発話する会話フローを備えたマルチエージェントのディベートを作成する例。
---

import { GithubLink } from "@/components/github-link";


# ターン制のAIディベート

以下のコードスニペットは、Mastra を使ってターン制のマルチエージェント会話システムを実装する方法を示します。この例では、2体のAIエージェント（楽観主義者と懐疑論者）が、ユーザー提供のトピックについて議論し、互いの主張に順番に応答していくディベートを行います。

## 音声機能を備えたエージェントの作成

まず、異なる個性と音声機能を持つ2体のエージェントを作成します。

```typescript filename="src/mastra/agents/index.ts"
import { openai } from "@ai-sdk/openai";
import { Agent } from "@mastra/core/agent";
import { OpenAIVoice } from "@mastra/voice-openai";

export const optimistAgent = new Agent({
  name: "Optimist",
  instructions:
    "あなたは、どんな話題でも良い面を見いだす楽観的な討論者です。返答は簡潔で惹きつける内容にし、2〜3文程度に収めてください。",
  model: openai("gpt-4o"),
  voice: new OpenAIVoice({
    speaker: "alloy",
  }),
});

export const skepticAgent = new Agent({
  name: "Skeptic",
  instructions:
    "あなたは、前提を疑い潜在的な問題点を指摘する、ぶっきらぼうで失礼な懐疑的な討論者です。返答は簡潔で惹きつける内容にし、2〜3文程度に収めてください。",
  model: openai("gpt-4o"),
  voice: new OpenAIVoice({
    speaker: "echo",
  }),
});
```


## Mastra へのエージェント登録

次に、両方のエージェントを Mastra インスタンスに登録します。

```typescript filename="src/mastra/index.ts"
import { PinoLogger } from "@mastra/loggers";
import { Mastra } from "@mastra/core/mastra";
import { optimistAgent, skepticAgent } from "./agents";

export const mastra = new Mastra({
  agents: {
    optimistAgent,
    skepticAgent,
  },
  logger: new PinoLogger({
    name: "Mastra",
    level: "info",
  }),
});
```


## 討論における発言順の管理

この例では、エージェント間の発言のやり取りを管理し、各エージェントが直前のエージェントの発言に応答するようにする方法を示します。

```typescript filename="src/debate/turn-taking.ts"
import { mastra } from "../../mastra";
import { playAudio, Recorder } from "@mastra/node-audio";
import * as p from "@clack/prompts";

// テキストを行幅で折り返して整形するヘルパー関数
function formatText(text: string, maxWidth: number): string {
  const words = text.split(" ");
  let result = "";
  let currentLine = "";

  for (const word of words) {
    if (currentLine.length + word.length + 1 <= maxWidth) {
      currentLine += (currentLine ? " " : "") + word;
    } else {
      result += (result ? "\n" : "") + currentLine;
      currentLine = word;
    }
  }

  if (currentLine) {
    result += (result ? "\n" : "") + currentLine;
  }

  return result;
}

// 音声レコーダーを初期化
const recorder = new Recorder({
  outputPath: "./debate.mp3",
});

// 会話の1ターンを処理
async function processTurn(
  agentName: "optimistAgent" | "skepticAgent",
  otherAgentName: string,
  topic: string,
  previousResponse: string = "",
) {
  const agent = mastra.getAgent(agentName);
  const spinner = p.spinner();
  spinner.start(`${agent.name} が思考中...`);

  let prompt;
  if (!previousResponse) {
    // 初回ターン
    prompt = `このトピックについて議論してください: ${topic}。あなたの立場を述べてください。`;
  } else {
    // 相手エージェントへの応答
    prompt = `トピックは ${topic} です。${otherAgentName} は次のように述べました: "${previousResponse}"。その指摘に答えてください。`;
  }

  // テキストの応答を生成
  const { text } = await agent.generate(prompt, {
    temperature: 0.9,
  });

  spinner.message(`${agent.name} が発言中...`);

  // 音声に変換して再生
  const audioStream = await agent.voice.speak(text, {
    speed: 1.2,
    responseFormat: "wav", // 任意: 応答フォーマットを指定
  });

  if (audioStream) {
    audioStream.on("data", (chunk) => {
      recorder.write(chunk);
    });
  }

  spinner.stop(`${agent.name} の発言:`);

  // 見やすくするため、80文字で改行されるようにテキストを整形
  const formattedText = formatText(text, 80);
  p.note(formattedText, agent.name);

  if (audioStream) {
    const speaker = playAudio(audioStream);

    await new Promise<void>((resolve) => {
      speaker.once("close", () => {
        resolve();
      });
    });
  }

  return text;
}

// 討論を実行するメイン関数
export async function runDebate(topic: string, turns: number = 3) {
  recorder.start();

  p.intro("AIディベート - 2人のエージェントがトピックを議論");
  p.log.info(`次のトピックで討論を開始します: ${topic}`);
  p.log.info(
    `討論は各自 ${turns} ターン行います。いつでも Ctrl+C で終了できます。`,
  );

  let optimistResponse = "";
  let skepticResponse = "";
  const responses = [];

  for (let turn = 1; turn <= turns; turn++) {
    p.log.step(`Turn ${turn}`);

    // 楽観派のターン
    optimistResponse = await processTurn(
      "optimistAgent",
      "Skeptic",
      topic,
      skepticResponse,
    );

    responses.push({
      agent: "Optimist",
      text: optimistResponse,
    });

    // 懐疑派のターン
    skepticResponse = await processTurn(
      "skepticAgent",
      "Optimist",
      topic,
      optimistResponse,
    );

    responses.push({
      agent: "Skeptic",
      text: skepticResponse,
    });
  }

  recorder.end();
  p.outro("討論は終了しました。音声全体は debate.mp3 に保存されました。");

  return responses;
}
```


## コマンドラインからディベートを実行する

コマンドラインからディベートを実行するための簡単なスクリプトは次のとおりです。

```typescript filename="src/index.ts"
import { runDebate } from "./debate/turn-taking";
import * as p from "@clack/prompts";

async function main() {
  // Get the topic from the user
  const topic = await p.text({
    message: "エージェントが議論するトピックを入力してください：",
    placeholder: "気候変動",
    validate(value) {
      if (!value) return "トピックを入力してください",
      return;
    },
  });

  // キャンセルされた場合は終了
  if (p.isCancel(topic)) {
    p.cancel("操作をキャンセルしました。"),
    process.exit(0);
  }

  // ターン数を取得
  const turnsInput = await p.text({
    message: "各エージェントは何ターンにしますか？",
    placeholder: "3",
    initialValue: "3",
    validate(value) {
      const num = parseInt(value);
      if (isNaN(num) || num < 1) return "正の数値を入力してください",
      return;
    },
  });

  // キャンセルされた場合は終了
  if (p.isCancel(turnsInput)) {
    p.cancel("操作をキャンセルしました。"),
    process.exit(0);
  }

  const turns = parseInt(turnsInput as string);

  // ディベートを実行
  await runDebate(topic as string, turns);
}

main().catch((error) => {
  p.log.error("エラーが発生しました：")
  console.error(error);
  process.exit(1);
});
```


## 討論用のWebインターフェースを作成する

Webアプリ向けに、ユーザーが討論を開始し、エージェントの応答を聞けるシンプルな Next.js コンポーネントを作成できます。

```tsx filename="app/components/DebateInterface.tsx"
"use client";

import { useState, useRef } from "react";
import { MastraClient } from "@mastra/client-js";

const mastraClient = new MastraClient({
  baseUrl: process.env.NEXT_PUBLIC_MASTRA_URL || "http://localhost:4111",
});

export default function DebateInterface() {
  const [topic, setTopic] = useState("");
  const [turns, setTurns] = useState(3);
  const [isDebating, setIsDebating] = useState(false);
  const [responses, setResponses] = useState<any[]>([]);
  const [isPlaying, setIsPlaying] = useState(false);
  const audioRef = useRef<HTMLAudioElement>(null);

  // 討論を開始する関数
  const startDebate = async () => {
    if (!topic) return;

    setIsDebating(true);
    setResponses([]);

    try {
      const optimist = mastraClient.getAgent("optimistAgent");
      const skeptic = mastraClient.getAgent("skepticAgent");

      const newResponses = [];
      let optimistResponse = "";
      let skepticResponse = "";

      for (let turn = 1; turn <= turns; turn++) {
        // 楽観主義者の番
        let prompt;
        if (turn === 1) {
          prompt = `このテーマについて議論してください: ${topic}。あなたの立場を述べてください。`;
        } else {
          prompt = `テーマは: ${topic}。懐疑派はこう述べました: "${skepticResponse}"。その指摘に反論・応答してください。`;
        }

        const optimistResult = await optimist.generate({
          messages: [{ role: "user", content: prompt }],
        });

        optimistResponse = optimistResult.text;
        newResponses.push({
          agent: "Optimist",
          text: optimistResponse,
        });

        // 応答のたびにUIを更新
        setResponses([...newResponses]);

        // 懐疑派の番
        prompt = `テーマは: ${topic}。楽観派はこう述べました: "${optimistResponse}"。その指摘に反論・応答してください。`;

        const skepticResult = await skeptic.generate({
          messages: [{ role: "user", content: prompt }],
        });

        skepticResponse = skepticResult.text;
        newResponses.push({
          agent: "Skeptic",
          text: skepticResponse,
        });

        // 応答のたびにUIを更新
        setResponses([...newResponses]);
      }
    } catch (error) {
      console.error("討論の開始中にエラーが発生しました:", error);
    } finally {
      setIsDebating(false);
    }
  };

  // 指定した応答の音声を再生する関数
  const playAudio = async (text: string, agent: string) => {
    if (isPlaying) return;

    try {
      setIsPlaying(true);
      const agentClient = mastraClient.getAgent(
        agent === "Optimist" ? "optimistAgent" : "skepticAgent",
      );

      const audioResponse = await agentClient.voice.speak(text);

      if (!audioResponse.body) {
        throw new Error("音声ストリームを受信できませんでした");
      }

      // Convert stream to blob
      const reader = audioResponse.body.getReader();
      const chunks = [];

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
      }

      const blob = new Blob(chunks, { type: "audio/mpeg" });
      const url = URL.createObjectURL(blob);

      if (audioRef.current) {
        audioRef.current.src = url;
        audioRef.current.onended = () => {
          setIsPlaying(false);
          URL.revokeObjectURL(url);
        };
        audioRef.current.play();
      }
    } catch (error) {
      console.error("音声再生中にエラーが発生しました:", error);
      setIsPlaying(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">交互発言のAI討論</h1>

      <div className="mb-6">
        <label className="block mb-2">討論テーマ:</label>
        <input
          type="text"
          value={topic}
          onChange={(e) => setTopic(e.target.value)}
          className="w-full p-2 border rounded"
          placeholder="例: 気候変動、AI倫理、宇宙探査"
        />
      </div>

      <div className="mb-6">
        <label className="block mb-2">ターン数（各エージェント）:</label>
        <input
          type="number"
          value={turns}
          onChange={(e) => setTurns(parseInt(e.target.value))}
          min={1}
          max={10}
          className="w-full p-2 border rounded"
        />
      </div>

      <button
        onClick={startDebate}
        disabled={isDebating || !topic}
        className="px-4 py-2 bg-blue-500 text-white rounded disabled:bg-gray-300"
      >
        {isDebating ? "討論を進行中..." : "討論を開始"}
      </button>

      <audio ref={audioRef} className="hidden" />

      {responses.length > 0 && (
        <div className="mt-8">
          <h2 className="text-xl font-semibold mb-4">討論の書き起こし</h2>

          <div className="space-y-4">
            {responses.map((response, index) => (
              <div
                key={index}
                className={`p-4 rounded ${
                  response.agent === "Optimist" ? "bg-blue-100" : "bg-gray-100"
                }`}
              >
                <div className="flex justify-between items-center">
                  <div className="font-bold">{response.agent}:</div>
                  <button
                    onClick={() => playAudio(response.text, response.agent)}
                    disabled={isPlaying}
                    className="text-sm px-2 py-1 bg-blue-500 text-white rounded disabled:bg-gray-300"
                  >
                    {isPlaying ? "再生中..." : "再生"}
                  </button>
                </div>
                <p className="mt-2">{response.text}</p>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
```

この例では、Mastra を使って、順番に発話するターン制のマルチエージェント会話システムを構築する方法を紹介します。エージェントはユーザーが選んだテーマについて議論し、各エージェントが直前のエージェントの発言に応答します。さらに、各エージェントの応答を音声に変換し、臨場感のあるディベート体験を提供します。

ターン制を用いた AI ディベートの完全な実装は、GitHub リポジトリでご覧いただけます。

<br />

<br />

<hr className="dark:border-[#404040] border-gray-300" />

<br />

<br />

<GithubLink
  link={
    "https://github.com/mastra-ai/voice-examples/tree/main/text-to-speech/turn-taking"
  }
/>