---
title: "MCPサーバー: ノート管理用 MCP サーバーの構築 | Mastra ガイド"
description: "Mastra フレームワークでノートを管理できる、フル機能の MCP（Model Context Protocol）サーバーを構築するためのステップバイステップガイド。"
---

import { FileTree, Steps } from "nextra/components";


# Notes MCP サーバーの構築

このガイドでは、ゼロから完全な MCP（Model Context Protocol）サーバーを構築する方法を学びます。このサーバーは Markdown ノートのコレクションを管理し、次の機能を備えています：

1. **ノートの一覧と閲覧**: クライアントがサーバーに保存された Markdown ファイルを参照・閲覧できるようにします
2. **ノートの作成**: ノートを新規作成または更新するためのツールを提供します
3. **スマートプロンプトの提供**: 日次ノートのテンプレート作成や既存コンテンツの要約など、文脈に応じたプロンプトを生成します

## 前提条件

- Node.js `v20.0` 以降がインストールされていること
- サポート対象の[モデルプロバイダー](/models)の API キー
- 既存の Mastra プロジェクト（新規プロジェクトのセットアップは[インストールガイド](/docs/getting-started/installation)を参照）

## 必要な依存関係とファイルの追加

MCP サーバーを作成する前に、追加の依存関係をインストールし、ボイラープレートのフォルダ構成を用意する必要があります。

<Steps>

### `@mastra/mcp` をインストール

`@mastra/mcp` をプロジェクトに追加します：

```bash copy
npm install @mastra/mcp
```

### デフォルトのプロジェクトをクリーンアップ

デフォルトの[インストールガイド](/docs/getting-started/installation)に従うと、このガイドには不要なファイルがプロジェクトに含まれます。次のファイルは安全に削除できます：

```bash copy
rm -rf src/mastra/agents src/mastra/workflows src/mastra/tools/weather-tool.ts
```

また、`src/mastra/index.ts` ファイルを次のように変更してください：

```ts copy filename="src/mastra/index.ts"
import { Mastra } from "@mastra/core/mastra";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";

export const mastra = new Mastra({
  storage: new LibSQLStore({
    // テレメトリや評価などをメモリストレージに保存します。永続化が必要な場合は file:../mastra.db に変更してください
    url: ":memory:",
  }),
  logger: new PinoLogger({
    name: "Mastra",
    level: "info",
  }),
});
```

### ディレクトリ構成を用意する

MCP サーバーのロジック用の専用ディレクトリと、メモ用の `notes` ディレクトリを作成します：

```bash copy
mkdir notes src/mastra/mcp
```

次のファイルを作成します：

```bash copy
touch src/mastra/mcp/{server,resources,prompts}.ts
```

- `server.ts`: MCP サーバーのメイン設定を記述
- `resources.ts`: ノートファイルの一覧取得と読み取りを担当
- `prompts.ts`: スマートプロンプトのロジックを記述

最終的なディレクトリ構成は次のとおりです：

<FileTree>
  <FileTree.Folder name="<your-project-name>" defaultOpen>
    <FileTree.Folder name="notes" defaultOpen />
    <FileTree.Folder name="src" defaultOpen>
      <FileTree.Folder name="mastra" defaultOpen>
        <FileTree.File name="index.ts" />
        <FileTree.Folder name="mcp" defaultOpen>
          <FileTree.File name="server.ts" />
          <FileTree.File name="resources.ts" />
          <FileTree.File name="prompts.ts" />
        </FileTree.Folder>
        <FileTree.Folder name="tools" defaultOpen />
      </FileTree.Folder>
    </FileTree.Folder>
  </FileTree.Folder>
</FileTree>

</Steps>

## MCPサーバーの作成

MCPサーバーを追加しましょう！

<Steps>
  ### MCP サーバーの作成と登録

  `src/mastra/mcp/server.ts` で MCP サーバーインスタンスを定義します:

  ```typescript copy filename="src/mastra/mcp/server.ts"
  import { MCPServer } from "@mastra/mcp";

  export const notes = new MCPServer({
    name: "notes",
    version: "0.1.0",
    tools: {},
  });
  ```

  `src/mastra/index.ts` で、この MCP サーバーを Mastra インスタンスに登録します。キー `notes` は、この MCP サーバーの公開識別子です。

  ```typescript copy filename="src/mastra/index.ts" {4, 15-17}
  import { Mastra } from "@mastra/core";
  import { PinoLogger } from "@mastra/loggers";
  import { LibSQLStore } from "@mastra/libsql";
  import { notes } from "./mcp/server";

  export const mastra = new Mastra({
    storage: new LibSQLStore({
      // テレメトリーや評価などをメモリストレージに保存します。永続化が必要な場合は file:../mastra.db に変更してください
      url: ":memory:",
    }),
    logger: new PinoLogger({
      name: "Mastra",
      level: "info",
    }),
    mcpServers: {
      notes,
    },
  });
  ```

  ### リソースハンドラを実装して登録する

  リソースハンドラーは、クライアントがサーバーで管理するコンテンツを探索・閲覧できるようにします。`notes` ディレクトリ内の Markdown ファイルを扱うハンドラーを実装してください。`src/mastra/mcp/resources.ts` ファイルに以下を追加します:

  ```typescript copy filename="src/mastra/mcp/resources.ts"
  import fs from "fs/promises";
  import path from "path";
  import { fileURLToPath } from "url";
  import type { MCPServerResources, Resource } from "@mastra/mcp";

  const __filename = fileURLToPath(import.meta.url);
  const __dirname = path.dirname(__filename);
  const NOTES_DIR = path.resolve(__dirname, "../../notes"); // 既定の出力ディレクトリからの相対

  const listNoteFiles = async (): Promise<Resource[]> => {
    try {
      await fs.mkdir(NOTES_DIR, { recursive: true });
      const files = await fs.readdir(NOTES_DIR);
      return files
        .filter((file) => file.endsWith(".md"))
        .map((file) => {
          const title = file.replace(".md", "");
          return {
            uri: `notes://${title}`,
            name: title,
            description: `「${title}」に関するノート`,
            mime_type: "text/markdown",
          };
        });
    } catch (error) {
      console.error("ノートのリソース一覧の取得中にエラーが発生しました:", error);
      return [];
    }
  };

  const readNoteFile = async (uri: string): Promise<string | null> => {
    const title = uri.replace("notes://", "");
    const notePath = path.join(NOTES_DIR, `${title}.md`);
    try {
      return await fs.readFile(notePath, "utf-8");
    } catch (error) {
      if ((error as NodeJS.ErrnoException).code !== "ENOENT") {
        console.error(`リソース ${uri} の読み込み中にエラーが発生しました:`, error);
      }
      return null;
    }
  };

  export const resourceHandlers: MCPServerResources = {
    listResources: listNoteFiles,
    getResourceContent: async ({ uri }: { uri: string }) => {
      const content = await readNoteFile(uri);
      if (content === null) return { text: "" };
      return { text: content };
    },
  };
  ```

  `src/mastra/mcp/server.ts` にこれらのリソースハンドラーを登録する:

  ```typescript copy filename="src/mastra/mcp/server.ts" {2, 8}
  import { MCPServer } from "@mastra/mcp";
  import { resourceHandlers } from "./resources";

  export const notes = new MCPServer({
    name: "notes",
    version: "0.1.0",
    tools: {},
    resources: resourceHandlers,
  });
  ```

  ### ツールの実装と登録

  ツールとは、サーバーが実行できるアクションのことです。`write` ツールを作成しましょう。
  まずは `src/mastra/tools/write-note.ts` でツールを定義します：

  ```typescript copy filename="src/mastra/tools/write-note.ts"
  import { createTool } from "@mastra/core/tools";
  import { z } from "zod";
  import { fileURLToPath } from "url";
  import path from "node:path";
  import fs from "fs/promises";

  const __filename = fileURLToPath(import.meta.url);
  const __dirname = path.dirname(__filename);
  const NOTES_DIR = path.resolve(__dirname, "../../../notes");

  export const writeNoteTool = createTool({
    id: "write",
    description: "新しいノートを作成するか、既存のノートを上書きします。",
    inputSchema: z.object({
      title: z
        .string()
        .nonempty()
        .describe("ノートのタイトル。ファイル名になります。"),
      content: z
        .string()
        .nonempty()
        .describe("ノートのMarkdown形式の内容。"),
    }),
    outputSchema: z.string().nonempty(),
    execute: async ({ context }) => {
      try {
        const { title, content } = context;
        const filePath = path.join(NOTES_DIR, `${title}.md`);
        await fs.mkdir(NOTES_DIR, { recursive: true });
        await fs.writeFile(filePath, content, "utf-8");
        return `ノート「${title}」に正常に書き込みました。`;
      } catch (error: any) {
        return `ノートの書き込み中にエラーが発生しました: ${error.message}`;
      }
    },
  });
  ```

  このツールを `src/mastra/mcp/server.ts` に登録します:

  ```typescript copy filename="src/mastra/mcp/server.ts"
  import { MCPServer } from "@mastra/mcp";
  import { resourceHandlers } from "./resources";
  import { writeNoteTool } from "../tools/write-note";

  export const notes = new MCPServer({
    name: "notes",
    version: "0.1.0",
    resources: resourceHandlers,
    tools: {
      write: writeNoteTool,
    },
  });
  ```

  ### プロンプトを実装して登録する

  プロンプトハンドラーは、クライアントがすぐに使えるプロンプトを提供します。次の3つを追加します：

  * デイリーノート
  * メモを要約する
  * アイデアを出し合う

  これには、いくつかの Markdown パーサー用ライブラリをインストールする必要があります。

  ```bash copy
  npm install unified remark-parse gray-matter @types/unist
  ```

  `src/mastra/mcp/prompts.ts` のプロンプトを実装してください:

  ```typescript copy filename="src/mastra/mcp/prompts.ts"
  import type { MCPServerPrompts } from "@mastra/mcp";
  import { unified } from "unified";
  import remarkParse from "remark-parse";
  import matter from "gray-matter";
  import type { Node } from "unist";

  const prompts = [
    {
      name: "new_daily_note",
      description: "新しい日次ノートを作成します。",
      version: "1.0.0",
    },
    {
      name: "summarize_note",
      description: "ノートの要点（TL;DR）を教えてください。",
      version: "1.0.0",
    },
    {
      name: "brainstorm_ideas",
      description: "ノートに基づいて新しいアイデアを発想してください。",
      version: "1.0.0",
    },
  ];

  function stringifyNode(node: Node): string {
    if ("value" in node && typeof node.value === "string") return node.value;
    if ("children" in node && Array.isArray(node.children))
      return node.children.map(stringifyNode).join("");
    return "";
  }

  export async function analyzeMarkdown(md: string) {
    const { content } = matter(md);
    const tree = unified().use(remarkParse).parse(content);
    const headings: string[] = [];
    const wordCounts: Record<string, number> = {};
    let currentHeading = "無題";
    wordCounts[currentHeading] = 0;
    tree.children.forEach((node) => {
      if (node.type === "heading" && node.depth === 2) {
        currentHeading = stringifyNode(node);
        headings.push(currentHeading);
        wordCounts[currentHeading] = 0;
      } else {
        const textContent = stringifyNode(node);
        if (textContent.trim()) {
          wordCounts[currentHeading] =
            (wordCounts[currentHeading] || 0) + textContent.split(/\\s+/).length;
        }
      }
    });
    return { headings, wordCounts };
  }

  const getPromptMessages: MCPServerPrompts["getPromptMessages"] = async ({
    name,
    args,
  }) => {
    switch (name) {
      case "new_daily_note":
        const today = new Date().toISOString().split("T")[0];
        return [
          {
            role: "user",
            content: {
              type: "text",
              text: `タイトルを「${today}」とし、「## Tasks」「## Meetings」「## Notes」の各セクションを含む新しいノートを作成してください。`,
            },
          },
        ];
      case "summarize_note":
        if (!args?.noteContent) throw new Error("コンテンツが指定されていません");
        const metaSum = await analyzeMarkdown(args.noteContent as string);
        return [
          {
            role: "user",
            content: {
              type: "text",
              text: `各セクションを3項目以内の箇条書きで要約してください。\\n\\n### アウトライン\\n${metaSum.headings.map((h) => `- ${h}（${metaSum.wordCounts[h] || 0}語）`).join("\\n")}`.trim(),
            },
          },
        ];
      case "brainstorm_ideas":
        if (!args?.noteContent) throw new Error("コンテンツが指定されていません");
        const metaBrain = await analyzeMarkdown(args.noteContent as string);
        return [
          {
            role: "user",
            content: {
              type: "text",
              text: `以下の不足しているセクションについて、${args?.topic ? `「${args.topic}」に関して` : ""}アイデアを3つ挙げてください。\\n\\n不足しているセクション:\\n${metaBrain.headings.length ? metaBrain.headings.map((h) => `- ${h}`).join("\\n") : "- （なし。任意に選んでください）"}`,
            },
          },
        ];
      default:
        throw new Error(`プロンプト「${name}」が見つかりません`),
    }
  };

  export const promptHandlers: MCPServerPrompts = {
    listPrompts: async () => prompts,
    getPromptMessages,
  };
  ```

  これらのプロンプトハンドラーを `src/mastra/mcp/server.ts` に登録します：

  ```typescript copy filename="src/mastra/mcp/server.ts"
  import { MCPServer } from "@mastra/mcp";
  import { resourceHandlers } from "./resources";
  import { writeNoteTool } from "../tools/write-note";
  import { promptHandlers } from "./prompts";

  export const notes = new MCPServer({
    name: "notes",
    version: "0.1.0",
    resources: resourceHandlers,
    prompts: promptHandlers,
    tools: {
      write: writeNoteTool,
    },
  });
  ```
</Steps>

## サーバーを起動する

やりました！最初の MCP サーバーを作成できました。次は、[playground](../../docs/server-db/local-dev-playground.mdx) を起動して試してみましょう。

```bash copy
npm run dev
```

ブラウザで [`http://localhost:4111`](http://localhost:4111) を開きます。左側のサイドバーで **MCP Servers** を選択し、**notes** MCP サーバーを選びます。

IDE に MCP サーバーを追加する手順が表示されます。この MCP サーバーは任意の MCP クライアントで利用できます。右側の **Available Tools** の下で **write** ツールを選択することもできます。

**write** ツールで、名前に `test`、Markdown コンテンツに `this is a test` を入力して試してください。**Submit** をクリックすると、`notes` 内に新しい `test.md` ファイルが作成されます。
