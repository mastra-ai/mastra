---
title: "Mastra v1 へのアップグレード | 移行ガイド"
description: "Mastra の v1 以前のバージョンでの破壊的変更に対応してアップグレードする方法を学びます。"
---

import { Callout } from "nextra/components";


# Mastra v1 へのアップグレード

このガイドでは、Mastra の v1 以前のバージョンに存在する破壊的変更をまたいでアップグレードする方法を解説します。Mastra v1 への移行にも役立ちます。

パッケージマネージャーを使って、プロジェクトの各パッケージを更新してください。Mastra のパッケージは**すべて**同時に更新するようにしてください。

<Callout type="info">

見出しで記載しているバージョンは `@mastra/core` パッケージを指します。必要に応じて、他の Mastra パッケージのバージョンについては、本文の詳細で個別に言及します。

すべての Mastra パッケージは `@mastra/core` に対して peer dependency を持っているため、パッケージマネージャーが互換性について通知できます。

</Callout>

## v0.23 への移行（未リリース）

<Callout>

このバージョンはまだリリースされていませんが、作業に合わせて変更点を随時追加していきます。

</Callout>

### 変更: スレッドタイトルの生成位置とデフォルト設定

**破壊的変更:**

1. `generateTitle` は `threads.generateTitle` から memory オプションのトップレベルに移動しました
2. デフォルト値は `true` から `false` に変更されました
3. `threads.generateTitle` を使用するとエラーがスローされるようになりました

**変更理由**

* `generateTitle` を論理的に属するトップレベルへ移し、API を簡素化するため
* 想定外の LLM API 呼び出しと関連コストを回避するため
* タイトル生成の実行タイミングを開発者が明示的に制御できるようにするため
* メモリ動作の予測可能性を高めるため

**移行手順:**

アプリケーションで `threads.generateTitle` を使用している場合は、トップレベルの `generateTitle` オプションを使用するよう更新してください:

```typescript
// 変更前 (v0.22 以前)
const agent = new Agent({
  memory: new Memory({
    options: {
      threads: {
        generateTitle: true  // ❌ これはエラーになります
      }
    }
  })
});

// 変更後 (v0.23+)
const agent = new Agent({
  memory: new Memory({
    options: {
      generateTitle: true  // ✅ トップレベルに配置
    }
  })
});
```

アプリケーションが従来のデフォルト動作（タイトルの自動生成）に依存している場合は、明示的に有効にしてください。

```typescript
// 変更前 (v0.22では暗黙的にtrue)
const agent = new Agent({
  memory: new Memory({
    // generateTitleはデフォルトでtrueでした
  })
});

// 変更後 (v0.23+では明示的にtrue)
const agent = new Agent({
  memory: new Memory({
    options: {
      generateTitle: true  // タイトル生成を明示的に有効化
    }
  })
});
```

タイトル生成に使用するモデルや指示は、カスタマイズすることもできます。

```typescript
const agent = new Agent({
  memory: new Memory({
    options: {
      generateTitle: {
        model: openai("gpt-4o-mini"),
        instructions: "会話を要約する簡潔なタイトルを生成してください(最大5語)"
      }
    }
  })
});
```


### 変更: メモリのデフォルト設定

RAG の研究に基づき、semantic recall のデフォルト設定を最適化しました:

* **`topK`** を `2` から `4` に引き上げ — 最も関連性の高いメッセージを 2 件ではなく 4 件取得
* **`messageRange`** を `{before: 2, after: 2}` から `{before: 1, after: 1}` に変更 — 取得した各メッセージの前後に含めるメッセージ数を 2 件ではなく 1 件に

**影響:**

semantic recall が有効な場合、これまでの 10 件 (2 × 5) ではなく、最大で合計 12 件 (4 × 3) のメッセージを取得します。これにより、メッセージ数の増加を 20% に抑えつつ、約 8% の精度向上が見込めます。

**必要な対応:**

以前のデフォルトに依存しており、従来の動作を維持したい場合は、以下の値を明示的に設定してください:

```typescript
const agent = new Agent({
  memory: {
    semanticRecall: {
      topK: 2,
      messageRange: { before: 2, after: 2 }
    }
  }
});
```

セマンティックリコールを使用していない場合（既定では無効）、変更は不要です。


### 削除: 非推奨API

#### エージェントの実行メソッド

- `generateVNext()` メソッドを削除しました。代わりに `generate()` を使用してください。
- `streamVNext()` メソッドを削除しました。代わりに `stream()` を使用してください。

#### エージェントのデフォルトオプションのメソッド

レガシー API と現行 API のどちら向けかを明確にするため、メソッド名が変更されました:

- `getDefaultGenerateOptions()` → `getDefaultGenerateOptionsLegacy()`
- `getDefaultStreamOptions()` → `getDefaultStreamOptionsLegacy()`
- `getDefaultVNextStreamOptions()` → `getDefaultStreamOptions()`

#### 出力オプション

* `generate()`/`stream()` のオプションから非推奨の `output` フィールドを削除しました。代わりに `structuredOutput.schema` を使用してください:

```typescript
// Before
const result = await agent.generate(messages, {
  output: z.object({
    answer: z.string()
  })
});

// After
const result = await agent.generate(messages, {
  structuredOutput: {
    schema: z.object({
      answer: z.string()
    })
  }
});
```


#### Abort Signal

* `modelSettings.abortSignal` を削除しました。代わりにトップレベルの `abortSignal` オプションを使用してください:

```typescript
// Before
const result = await agent.stream(messages, {
  modelSettings: {
    abortSignal: controller.signal,
    temperature: 0.7
  }
});

// After
const result = await agent.stream(messages, {
  abortSignal: controller.signal,
  modelSettings: {
    temperature: 0.7
  }
});
```


#### MCP ツール

* トップレベルの引数から `elicitation` と `extra` を削除しました。代わりに `mcp` プロパティを使用してください。

```typescript
export const accountBalance = createTool({
  id: 'account-balance',
  description: '指定されたアカウントの現在の残高を取得します',
  inputSchema: z.object({
    accountId: z.string(),
  }),
  outputSchema: z.object({
    balance: z.number(),
  }),
  execute: async ({ context, mcp }) => {    
    if (mcp) {
      await checkAuth(mcp.extra.authInfo)

      const result = await mcp.elicitation.sendRequest({
        message: `アカウント ${context.accountId} の残高を取得してもよろしいですか?`,
        requestedSchema: {
          type: 'object',
          properties: {
            confirm: { type: 'boolean' },
          },
          required: ['confirm'],
        }
      });

      if (result.action === 'accept') {
        return {
          balance: getAccountBalance(context.accountId),
        };
      }
    }
  }
})
```


#### 入力プロセッサ

- `@mastra/core/agent/input-processors` のエクスポートは削除されました。現在は `@mastra/core/processors` から利用できます。
- `InputProcessor` 型は廃止され、`processInput` 関数を実装する `Processor` に置き換えられました。

## v0.22 へのアップグレード

### 変更: メモリスコープのデフォルト

`@mastra/memory` - `0.16.0`\
`@mastra/core` - `0.22.0`

**working memory** と **semantic recall** のデフォルトのメモリスコープが「&#39;thread&#39;」から「&#39;resource&#39;」に変更されました。

**変更前:**

* Working memory のデフォルトは `scope: 'thread'`（会話ごとに分離）
* Semantic recall のデフォルトは `scope: 'thread'`（現在の会話内のみ検索）

**変更後:**

* Working memory のデフォルトは `scope: 'resource'`（すべてのユーザーとの会話をまたいで保持）
* Semantic recall のデフォルトは `scope: 'resource'`（すべてのユーザーとの会話を横断して検索）

**なぜこの変更を行ったのか？**

1. **より良いユーザー体験**: 多くのアプリケーションは、単一のスレッド内だけでなく会話をまたいでユーザー情報を保持したい
2. **より直感的なデフォルト**: ユーザーは AI エージェントが自分を「記憶」することを期待しており、そのためには resource スコープのメモリが必要
3. **一般的なユースケースとの整合**: 多くの本番アプリケーションが resource スコープのメモリを使用

**移行:**

メモリを会話スレッドごとに分離する従来の挙動を維持したい場合は、メモリ設定で明示的に `scope: 'thread'` を設定してください。

```typescript showLineNumbers copy
import { Memory } from '@mastra/memory';
import { LibSQLStore } from '@mastra/libsql';

const memory = new Memory({
  storage: new LibSQLStore({ url: 'file:local.db' }),
  options: {
    workingMemory: {
      enabled: true,
      scope: 'thread', // スレッドスコープに明示的に設定
      template: `# ユーザープロフィール
- **名前**: 
- **関心事**: 
`,
    },
    semanticRecall: {
      topK: 3,
      scope: 'thread', // スレッドスコープに明示的に設定
    },
  },
});
```

新しいデフォルトの動作を採用する場合は、明示的な `scope: 'resource'` の宣言は不要になったため、任意で削除できます。


### 非推奨: `format: "aisdk"`

`stream()`/`generate()` メソッドの `format: "aisdk"` オプションは非推奨です。代わりに `@mastra/ai-sdk` パッケージを使用してください。詳細は [Vercel AI SDK の使用方法に関するドキュメント](../../docs/frameworks/agentic-uis/ai-sdk.mdx) を参照してください。

### 削除: MCP クラス

`@mastra/mcp` - `0.14.0`

- `MastraMCPClient` クラスを削除しました。代わりに [`MCPClient`](../../reference/tools/mcp-client.mdx) クラスを使用してください。
- `MCPConfigurationOptions` 型を削除しました。代わりに [`MCPClientOptions`](../../reference/tools/mcp-client.mdx#mcpclientoptions) 型を使用してください。API は同一です。
- `MCPConfiguration` クラスを削除しました。代わりに [`MCPClient`](../../reference/tools/mcp-client.mdx) クラスを使用してください。

### 変更点: CLI フラグおよびコマンドの削除

`mastra` - `0.17.0`

- `mastra deploy` CLI コマンドを削除しました。各プラットフォームのデプロイ手順に従ってください。
- `mastra build` コマンドから `--env` フラグを削除しました。ビルド成果物をカスタム環境で起動する場合は、代わりに `mastra start --env <env>` を使用してください。
- `mastra dev` から `--port` フラグを削除しました。代わりに `new Mastra()` クラスで `server.port` を設定してください。

## v0.21 への移行

変更は不要です。

## v0.20 への移行

- [VNext から Standard API へ](./vnext-to-standard-apis.mdx)
- [AgentNetwork から .network() へ](./agentnetwork.mdx)