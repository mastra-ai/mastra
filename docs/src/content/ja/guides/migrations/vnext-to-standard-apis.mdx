---
title: "VNext から標準 API へ | 移行ガイド"
description: "Mastra で VNext メソッドから新しい標準エージェント API へ移行する方法を学びましょう。"
---

## 概要

`@mastra/core` の `v0.20.0` 以降、以下の変更が適用されます。

## レガシー API（AI SDK v4）

元のメソッドは名称が変更されましたが、**AI SDK v4** および `v1` モデルとの後方互換性は維持されています。

- `.stream()` → `.streamLegacy()`
- `.generate()` → `.generateLegacy()`

## 標準 API（AI SDK v5）

これらは現在の API で、**AI SDK v5** および `v2` モデルと完全互換です。

- `.streamVNext()` → `.stream()`
- `.generateVNext()` → `.generate()`

## 移行パス

すでに `.streamVNext()` と `.generateVNext()` を使用している場合は、検索と置換でそれぞれ `.stream()` と `.generate()` に変更してください。

旧来の `.stream()` と `.generate()` を使用している場合は、アップグレードするかどうかを検討してください。アップグレードしない場合は、検索と置換で `.streamLegacy()` と `.generateLegacy()` に変更してください。

ニーズに合った移行パスを選択してください:

### AI SDK v4 モデルを引き続き使用する

- すべての `.stream()` および `.generate()` の呼び出しを、それぞれ `.streamLegacy()` および `.generateLegacy()` にリネームしてください。

> それ以外の変更は必要ありません。

### AI SDK v5 のモデルを引き続き使用する

- すべての `.streamVNext()` と `.generateVNext()` の呼び出しを、それぞれ `.stream()` と `.generate()` にリネームしてください。

> それ以外の変更は必要ありません。

### AI SDK v4 から v5 へのアップグレード

- すべてのモデルプロバイダー用パッケージをメジャーバージョンに上げてください。

> これにより、すべてが v5 のモデルになります。以下のガイドで主な違いを確認し、それに合わせてコードを更新してください。

## 主要な相違点

更新された `.stream()` と `.generate()` メソッドは、従来のメソッドに比べ、動作、互換性、戻り値の型、利用可能なオプションが異なります。本セクションでは、移行にあたって理解しておくべき最も重要な変更点を取り上げます。

### モデルバージョンのサポート

**レガシー API**

- `.generateLegacy()`
- `.streamLegacy()`

**AI SDK v4** のモデル（`specificationVersion: 'v1'`）のみをサポートします

**標準 API**

- `.generate()`
- `.stream()`

**AI SDK v5** のモデル（`specificationVersion: 'v2'`）のみをサポートします

> 実行時に明確なエラーメッセージとともに強制されます。

### 戻り値の型

**レガシー API**

- `.generateLegacy()`
  戻り値: `GenerateTextResult` または `GenerateObjectResult`

- `.streamLegacy()`
  戻り値: `StreamTextResult` または `StreamObjectResult`

詳しくは次の API リファレンスを参照してください:

- [Agent.generateLegacy()](../../reference/agents/generateLegacy.mdx)
- [Agent.streamLegacy()](../../reference/streaming/agents/streamLegacy.mdx)

**標準 API**

- `.generate()`
  - `format: 'mastra'`（デフォルト）: `MastraModelOutput.getFullOutput()` を返します
  - `format: 'aisdk'`: `AISDKV5OutputStream.getFullOutput()` を返します
  - 内部的に `.stream()` を呼び出し、`.getFullOutput()` の完了を待機します

- `.stream()`
  - `format: 'mastra'`（デフォルト）: `MastraModelOutput<OUTPUT>` を返します
  - `format: 'aisdk'`: `AISDKV5OutputStream<OUTPUT>` を返します

詳しくは次の API リファレンスを参照してください:

- [Agent.generate()](../../reference/agents/generate.mdx)
- [Agent.stream()](../../reference/streaming/agents/stream.mdx)

### フォーマット制御

**レガシー API**

`format` オプションなし: 常に AI SDK v4 の型を返す

```typescript showLineNumbers copy
// Mastra ネイティブ形式（デフォルト）
const result = await agent.stream(messages);
```

**標準 API**

出力形式を選ぶには `format` オプションを使用します:

* `'mastra'`（デフォルト）
* `'aisdk'`（AI SDK v5 互換）

```typescript showLineNumbers copy
// AI SDK v5 互換性
const result = await agent.stream(messages, {
  format: 'aisdk'
});
```


### 標準APIの新オプション

次のオプションは、標準の`.stream()`および`generate()`で利用できますが、レガシー版では利用できません。

- `format` - 出力形式を 'mastra' または 'aisdk' から選択:

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      format: 'aisdk' // or 'mastra' (default)
    });
    ```
- `system` - カスタムのシステムメッセージ（instructions とは別）。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      system: 'You are a helpful assistant'
    });
    ```

- `structuredOutput` - モデルの上書きやカスタムオプションに対応した強化版の構造化出力。
  - `jsonPromptInjection` - response_format をモデルに渡すデフォルト動作を上書きします。プロンプトにコンテキストを注入し、モデルに構造化出力を返すよう促します。
  - `model` - モデルを指定すると、メインエージェントの応答を構造化するサブエージェントを作成します。メインエージェントはツールの呼び出しとテキストの返却を行い、サブエージェントは提供したスキーマに準拠するオブジェクトを返します。これは `experimental_output` の代替です。
  - `errorStrategy` - 出力がスキーマに一致しない場合の動作:
      - 'warn' - 警告をログ出力
      - 'error' - エラーをスロー
      - 'fallback' - 指定したフォールバック値を返す

    ```typescript showLineNumbers copy
    const result = await agent.generate(messages, {
      structuredOutput: {
        schema: z.object({
          name: z.string(),
          age: z.number()
        }),
        model: "openai/gpt-4o-mini", // Optional model override for structuring
        errorStrategy: 'fallback',
        fallbackValue: { name: 'unknown', age: 0 },
        instructions: 'Extract user information' // Override default structuring instructions
      }
    });
    ```

- `stopWhen` - 柔軟な停止条件（ステップ数、トークン上限など）。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      stopWhen: ({ steps, totalTokens }) => steps >= 5 || totalTokens >= 10000
    });
    ```

- `providerOptions` - プロバイダー固有のオプション（例: OpenAI の設定）

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      providerOptions: {
        openai: {
          store: true,
          metadata: { userId: '123' }
        }
      }
    });
    ```

- `onChunk` - ストリーミングの各チャンクに対するコールバック。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      onChunk: (chunk) => {
        console.log('Received chunk:', chunk);
      }
    });
    ```

- `onError` - エラー時のコールバック。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      onError: (error) => {
        console.error('Stream error:', error);
      }
    });
    ```

- `onAbort` - 中断時のコールバック。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      onAbort: () => {
        console.log('Stream aborted');
      }
    });
    ```

- `activeTools` - この実行で有効にするツールを指定。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      activeTools: ['search', 'calculator'] // Only these tools will be available
    });
    ```

- `abortSignal` - キャンセル用の AbortSignal。

    ```typescript showLineNumbers copy
    const controller = new AbortController();
    const result = await agent.stream(messages, {
      abortSignal: controller.signal
    });

    // Later: controller.abort();
    ```

- `prepareStep` - マルチステップ実行における各ステップ直前のコールバック。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      prepareStep: ({ step, state }) => {
        console.log('About to execute step:', step);
        return { /* modified state */ };
      }
    });
    ```

- `requireToolApproval` - すべてのツール呼び出しに承認を必須化。

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      requireToolApproval: true
    });
    ```

### 移行されたレガシーオプション

- `temperature` およびその他の `modelSettings`

    `modelSettings` に統合されました

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      modelSettings: {
        temperature: 0.7,
        maxTokens: 1000,
        topP: 0.9
      }
    });
    ```

- `resourceId` と `threadId`

    memory オブジェクトに移動されました

    ```typescript showLineNumbers copy
    const result = await agent.stream(messages, {
      memory: {
        resource: 'user-123',
        thread: 'thread-456'
      }
    });
    ```

### 非推奨または削除されたオプション

- `experimental_output`

    ツール呼び出しとオブジェクトの返却を可能にするため、代わりに `structuredOutput` を使用してください。

    ```typescript showLineNumbers copy
    const result = await agent.generate(messages, {
      structuredOutput: {
        schema: z.object({
          summary: z.string(),
        }),
        model: "openai/gpt-4o"
      }
    });
    ```

- `output`

    `output` プロパティは `structuredOutput` を推奨するため非推奨となりました。同等の結果を得るには、model を省略して `structuredOutput.schema` のみを渡してください。モデルが `response_format` をネイティブにサポートしていない場合は、必要に応じて `jsonPromptInjection: true` を追加してください。

    ```typescript showLineNumbers copy
    const result = await agent.generate(messages, {
      structuredOutput: {
        schema: {
          z.object({
            name: z.string()
          })
        }
      },
    });
    ```

- `memoryOptions`

    代わりに `memory` を使用してください。

    ```typescript showLineNumbers copy
    const result = await agent.generate(messages, {
      memory: {
        // ...
      }
    });
    ```

### 型の変更

**レガシー API**

- `CoreMessage[]`

詳細は次の API リファレンスをご覧ください：

- [Agent.generateLegacy()](../../reference/agents/generateLegacy.mdx)
- [Agent.streamLegacy()](../../reference/streaming/agents/streamLegacy.mdx)

**標準 API**

- `ModelMessage[]`

    `toolChoice` は AI SDK v5 の `ToolChoice` 型を使用します。

    ```typescript showLineNumbers copy
    type ToolChoice<TOOLS extends Record<string, unknown>> = 'auto' | 'none' | 'required' | {
        type: 'tool';
        toolName: Extract<keyof TOOLS, string>;
    };
    ```

詳細は次の API リファレンスをご覧ください：

- [Agent.generate()](../../reference/agents/generate.mdx)
- [Agent.stream()](../../reference/streaming/agents/stream.mdx)