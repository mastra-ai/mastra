# Mastra Memory Architecture

Mastra provides a comprehensive memory system with two key aspects: how it processes requests and what components make it work.

## Memory Request Flow

Here's how the memory system processes a typical user request to assemble the context window for the LLM:

```text
        ┌─────────────────┐
        │  User Message   │
        └────────┬────────┘
                 ▼
        ┌─────────────────┐
        │ Mastra Agent    │
        └────────┬────────┘
                 │ invokes with
                 │ resourceId + threadId
                 ▼
    ┌───────────────────────────┐
    │   Memory System           │
    │   (Retrieval Logic)       │
    └───────────┬───────────────┘
                │ determines context from...
   ┌────────────┼────────────────┬───────────────┐
   │            │                │               │
   ▼            ▼                ▼               ▼
┌─────────┐ ┌───────────┐ ┌─────────────────┐ ┌───────────┐
│ Storage │ │ Vector    │ │ Working Memory  │ │ System    │
│ Backend │ │ Store     │ │ Store           │ │ Prompt    │
│ (Recent │ │ (Semantic │ │ (Relevant Data) │ │           │
│ History)│ │ Recall)   │ │                 │ │           │
└─────────┘ └───────────┘ └─────────────────┘ └───────────┘
      │            │                │               │
      └────────────┼────────────────┴───────────────┘
                   │ assembles raw data
                   ▼
      ┌───────────────────────────┐
      │ Memory Processors         │
      │ ----------------------    │
      │ • Token Limiting          │
      │ • Tool Call Filtering     │
      │ • Custom Transformations  │
      └───────────┬───────────────┘
                  │ filters and optimizes
                  ▼
     ┌───────────────────────────┐
     │ Final Context Window      │
     │ ------------------------- │
     │ - System Prompt           │
     │ - Working Memory Data     │
     │ - Semantic Search Results │
     │ - Recent Message History  │
     │ - Current User Message    │
     └───────────┬───────────────┘
                 │ sent to
                 ▼
        ┌─────────────────┐
        │ LLM Provider    │
        └────────┬────────┘
                 │ returns response
                 ▼
        ┌─────────────────┐
        │ Mastra Agent    │
        └────────┬────────┘
                 │ 1. Sends response to user
                 │ 2. Triggers memory update
        ┌────────┴────────┐
        ▼                 ▼
┌─────────────────────┐   ┌───────────────────────┐
│ User Interface      │   │ Memory System         │
│ (Displays Responses)│   │ (Updates Logic)       │
└─────────────────────┘   │ ---------------       │
                          │ Store User Message    │
                          │ Store Agent Response  │
                          │ Update Working Memory │
                          │ (if any)              │
                          └───────────────────────┘
```

## Architecture Components

Mastra's memory system consists of several components working together:

```text
┌───────────────────────────────────────────────────────────────────────┐
│                        MASTRA MEMORY SYSTEM                           │
└───────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
          ┌─────────────────────────────────────────────┐
          │              Memory Instance                 │
          └─────────────────────────────────────────────┘
                │                 │                │
                ▼                 ▼                ▼
┌────────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  Storage Backend   │  │   Vector Store   │  │    Embedder      │
│  ----------------  │  │  --------------  │  │  --------------  │
│  • LibSQL          │  │  • PgVector      │  │  • FastEmbed     │
│  • PostgreSQL      │  │  • LibSQLVector  │  │  • OpenAI        │
│  • Upstash Redis   │  │  • Pinecone      │  │  • Cohere        │
│  • + more          │  │  • + more        │  │  • + more        │
└────────────────────┘  └──────────────────┘  └──────────────────┘
        │                        │                      │
        └────────────┬───────────┴──────────┬───────────┘
                     │                      │
        ┌────────────▼──────────┐  ┌────────▼────────────┐
        │  Message Management   │  │ Semantic Processing │
        │  ------------------   │  │ ------------------  │
        │  • Thread Storage     │  │  • Vector Indexing  │
        │  • Message Storage    │  │  • Similarity Search│
        │  • Working Memory     │  │  • Query Processing │
        └─────────────────────┬─┘  └─────────────────────┘
                            │
            ┌───────────────┴───────────────┐
            ▼                               ▼
┌─────────────────────────┐      ┌──────────────────────────┐
│      Context Window     │      │    Response Generation   │
│      --------------     │      │    ------------------    │
│  • Last Messages        │      │  • Text Stream           │
│  • Semantic Results     │◄────►│  • Working Memory Update │
│  • Working Memory       │      │  • Message Storage       │
└─────────────────────────┘      └──────────────────────────┘
```

- **Memory Instance**: Central configuration point for all memory components. Memory is segmented by resourceId (user) and threadId (conversation), ensuring proper isolation between different users and chats.
- **Storage Backend**: Persists conversation data in your chosen database (LibSQL, PostgreSQL, Upstash)
- **Vector Store**: Specialized database for semantic search capabilities
- **Embedder**: Converts text to vector representations for similarity search
- **Message Management**: Handles conversation persistence (`Thread Storage`, `Message Storage`) and manages dynamic contextual data (`Working Memory`)
- **Semantic Processing**: Creates searchable representations of messages (`Vector Indexing`) and retrieves relevant information based on queries (`Similarity Search`, `Query Processing`)
- **Context Window**: Assembles relevant information for the agent
- **Response Generation**: Produces agent responses and updates memory

This architecture allows for flexibility in:

- Storage backends (LibSQL, PostgreSQL, Upstash)
- Embedding models (FastEmbed by default, OpenAI, etc.)
- Memory retrieval strategies (recency, semantic similarity)

## Related Topics

- [Memory Overview](./overview.mdx)
- [Getting Started with Memory](./getting-started.mdx)
- [Configuring Memory](./configuring-memory.mdx)
- [Memory FAQ](./faq.mdx) 