---
title: Storage as Memory | Mastra Docs
description: Technical guide on using storage systems for memory management in Mastra, including configuration and optimization.
---

# Storage as Memory

Mastra's memory system provides persistent storage for conversation history and contextual information. This guide shows you how to configure and optimize memory storage for your application.

## Overview

Mastra's memory system manages three types of data:

1. **Messages**: Conversation entries with metadata and ordering
2. **Threads**: Organized message groups with shared context
3. **Vectors**: Semantic embeddings for similarity search

Key features:
- Unified storage interface
- Multiple backend support
- Process isolation
- Automatic cleanup

## Quick Start

```ts showLineNumbers copy
import { Memory } from '@mastra/core/memory';

// Initialize memory with default settings
const memory = new Memory({
  name: 'my-memory',
  options: {
    // Message retention
    lastMessages: 40,
    
    // Enable semantic search
    semanticRecall: true,
  },
});

// Start using memory
const thread = await memory.saveThread({
  thread: {
    resourceId: 'user-123',
    title: 'First Chat',
  },
});

await memory.saveMessages({
  messages: [{
    threadId: thread.id,
    role: 'user',
    content: 'Hello!',
  }],
});

## Storage Configuration

### 1. Default Storage
```ts showLineNumbers copy
// Uses LibSQL with sensible defaults
const memory = new Memory({
  name: 'my-memory',
  options: {
    // Optional: Override storage settings
    storage: {
      url: 'file:memory.db',  // Default: ':memory:'
      tableName: 'messages',   // Default: 'mastra_messages'
    },
  },
});
```

### 2. Custom Storage
```ts showLineNumbers copy
import { Memory } from '@mastra/core/memory';
import { DefaultStorage } from '@mastra/core/storage';

// Configure custom storage backend
const storage = new DefaultStorage({
  name: 'custom-storage',
  config: {
    url: 'file:memory.db',
    pool: {
      min: 2,
      max: 10,
    },
  },
});

// Use custom storage with memory
const memory = new Memory({
  name: 'my-memory',
  storage,
  options: {
    lastMessages: 40,
    semanticRecall: true,
  },
});
```

## Core Operations

### 1. Message Management

```ts showLineNumbers copy
// Save messages to a thread
await memory.saveMessages({
  messages: [{
    threadId: 'thread-123',
    role: 'user',
    content: 'Hello Mastra!',
    metadata: {
      source: 'chat',
      language: 'en',
      priority: 'high',
    },
  }],
});

// Retrieve messages with filters
const messages = await memory.getMessages({
  threadId: 'thread-123',
  selectBy: {
    // Basic filters
    limit: 40,
    before: new Date(),
    
    // Advanced filters
    filter: {
      role: ['user', 'assistant'],
      metadata: {
        priority: 'high',
      },
    },
  },
});

// Messages include:
// - Chronological order
// - Full metadata
// - Similarity scores
// - Thread context

### 2. Thread Operations

```ts showLineNumbers copy
// Create a new thread
const thread = await memory.saveThread({
  thread: {
    resourceId: 'user-123',
    title: 'Support Chat',
    metadata: {
      category: 'support',
      priority: 'high',
    },
  },
});

// Update thread details
await memory.updateThread({
  id: thread.id,
  title: 'Resolved: Support Chat',
  metadata: {
    status: 'resolved',
    resolvedAt: new Date(),
  },
});

// Thread features:
// - Unique identification
// - Custom metadata
// - Status tracking
// - Message grouping
```

## Storage Types

### 1. In-Memory Storage

```ts showLineNumbers copy
// Test environment
const testMemory = new Memory({
  name: 'test-memory',
  options: {
    storage: { url: ':memory:' },
  },
});

// Development server
const devMemory = new Memory({
  name: 'dev-memory',
  options: {
    storage: { url: ':memory:' },
  },
});

// Benefits:
// - Clean test state
// - Fast setup/teardown
// - Process isolation
// - No cleanup needed
```

### 2. File Storage

```ts showLineNumbers copy
// Local development
const fileMemory = new Memory({
  name: 'file-memory',
  options: {
    storage: { url: 'file:memory.db' },
  },
});

// Benefits:
// - Data persistence
// - Easy backups
// - Cross-process sharing
// - Simple debugging
```

### 3. Production Storage

```ts showLineNumbers copy
// Production setup
const prodMemory = new Memory({
  name: 'prod-memory',
  options: {
    storage: {
      url: process.env.DATABASE_URL,
      pool: {
        min: 2,
        max: 10,
      },
    },
  },
});

// Benefits:
// - High availability
// - Connection pooling
// - Cloud deployment
// - Monitoring support

## Performance Tuning

### 1. Connection Pooling
```ts showLineNumbers copy
// Configure connection pool for high throughput
const memory = new Memory({
  name: 'optimized-memory',
  options: {
    storage: {
      pool: {
        min: 5,     // Minimum connections
        max: 20,    // Maximum connections
        timeout: 30000,  // Connection timeout (ms)
      },
    },
  },
});
```

### 2. Batch Operations
```ts showLineNumbers copy
// Use batch operations for better performance
await memory.saveMessages({
  messages: messages,  // Array of messages
  options: {
    batchSize: 1000,   // Messages per batch
    ordered: false,    // Allow parallel processing
  },
});
```

### 3. Index Optimization
```ts showLineNumbers copy
// Configure vector index for memory system
const memory = new Memory({
  name: 'vector-memory',
  options: {
    semanticRecall: {
      enabled: true,
      indexConfig: {
        m: 16,              // Max connections per node
        efConstruction: 200, // Build-time search depth
        efSearch: 100,      // Query-time search depth
      },
    },
  },
});
```

## Backend Features

### 1. LibSQL (Default)
```ts showLineNumbers copy
// In-memory SQLite for development
const memory = new Memory({
  name: 'libsql-memory',
  options: {
    storage: { url: ':memory:' },
  },
});

// Features:
// - Zero-dependency setup
// - Automatic schema management
// - JSON column support
// - Prepared statements
```

### 2. PostgreSQL
```ts showLineNumbers copy
// Production-ready PostgreSQL setup
import { PgStorage } from '@mastra/pg';

const memory = new Memory({
  name: 'pg-memory',
  storage: new PgStorage({
    url: process.env.DATABASE_URL,
    pool: {
      min: 2,
      max: 10,
    },
  }),
});

// Features:
// - ACID compliance
// - Advanced querying
// - Cloud deployment
// - High availability
```

### 3. Upstash Redis
```ts showLineNumbers copy
// Real-time Redis storage
import { UpstashStorage } from '@mastra/upstash';

const memory = new Memory({
  name: 'redis-memory',
  storage: new UpstashStorage({
    url: process.env.UPSTASH_URL,
    token: process.env.UPSTASH_TOKEN,
  }),
});

// Features:
// - High performance
// - JSON data types
// - Atomic operations
// - Real-time support
```

## Error Handling

### 1. Connection Errors
```ts showLineNumbers copy
try {
  const memory = new Memory({
    name: 'my-memory',
    options: {
      storage: { url: process.env.DATABASE_URL },
    },
  });
} catch (error) {
  if (error instanceof StorageConnectionError) {
    console.error('Failed to connect:', error.message);
    // Handle connection failure
  }
}
```

### 2. Operation Errors
```ts showLineNumbers copy
try {
  await memory.saveMessages({
    messages: messages,
    options: { ordered: true },
  });
} catch (error) {
  if (error instanceof StorageOperationError) {
    // Handle specific errors
    switch (error.code) {
      case 'CONSTRAINT_ERROR':
        // Handle constraint violation
        break;
      case 'TIMEOUT_ERROR':
        // Handle operation timeout
        break;
      default:
        // Handle other errors
    }
  }
}
```

## Configuration Reference

### Basic Settings

```ts showLineNumbers copy
const memory = new Memory({
  storage,
  options: {
    // Recent message handling
    lastMessages: 40,
    
    // Semantic search configuration
    semanticRecall: {
      topK: 5,
      messageRange: 2,
    },
    
    // Thread options
    threads: {
      generateTitle: true,
    },
  },
});
```

### Use Case Configurations

```ts showLineNumbers copy
// Chat support - minimal context
const supportMemory = new Memory({
  storage,
  options: {
    lastMessages: 10,
    semanticRecall: false,
  },
});

// Project management - extensive context
const projectMemory = new Memory({
  storage,
  options: {
    lastMessages: 50,
    semanticRecall: {
      topK: 10,
      messageRange: 3,
    },
  },
});
```

## Next Steps

- Learn about [Vector Storage](./vector-storage.mdx)
- Configure [Storage Telemetry](./storage-telemetry.mdx)
- See [Memory Examples](../../examples/memory/)