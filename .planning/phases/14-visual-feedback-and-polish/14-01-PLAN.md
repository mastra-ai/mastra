---
phase: 14-visual-feedback-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/playground-ui/tailwind.config.ts
  - packages/playground-ui/src/domains/agents/hooks/use-click-ripple.ts
  - packages/playground-ui/src/domains/agents/components/browser-view/click-ripple-overlay.tsx
  - packages/playground-ui/src/domains/agents/components/browser-view/browser-view-frame.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking in the live view produces a visible ripple animation at the click position"
    - "Ripple appears instantly on mousedown, not waiting for remote browser frame update"
    - "Ripple positions correctly accounting for letterbox/pillarbox offset from object-contain scaling"
    - "Clicking in letterbox dead zone (black bars) produces no ripple"
    - "Ripple elements do not intercept mouse events (pointer-events-none)"
    - "VIS-01 already satisfied by Phase 13 interactive mode indicator (ring-2 ring-accent1 + cursor changes)"
  artifacts:
    - path: "packages/playground-ui/tailwind.config.ts"
      provides: "click-ripple keyframe and animation utility"
      contains: "click-ripple"
    - path: "packages/playground-ui/src/domains/agents/hooks/use-click-ripple.ts"
      provides: "Ripple state management hook"
      exports: ["useClickRipple"]
    - path: "packages/playground-ui/src/domains/agents/components/browser-view/click-ripple-overlay.tsx"
      provides: "Ripple rendering component"
      exports: ["ClickRippleOverlay"]
    - path: "packages/playground-ui/src/domains/agents/components/browser-view/browser-view-frame.tsx"
      provides: "Integration of ripple overlay into frame container"
      contains: "ClickRippleOverlay"
  key_links:
    - from: "browser-view-frame.tsx"
      to: "click-ripple-overlay.tsx"
      via: "renders ClickRippleOverlay inside container div"
      pattern: "<ClickRippleOverlay"
    - from: "browser-view-frame.tsx"
      to: "use-click-ripple.ts"
      via: "calls useClickRipple hook for ripple state"
      pattern: "useClickRipple"
    - from: "use-click-ripple.ts"
      to: "coordinate-mapping.ts"
      via: "uses letterbox math to compute display-space position"
      pattern: "mapClientToViewport|ElementRect|ViewportDimensions"
---

<objective>
Add click ripple visual feedback to the browser live view frame so users see immediate confirmation when clicking, bridging the latency gap before the remote browser's screencast frame updates.

Purpose: VIS-02 requires instant visual feedback for clicks. The remote browser frame takes 100-300ms to update after a click. Without feedback, users cannot tell if their click registered. A CSS ripple animation at the click position provides that confirmation.

Note: VIS-01 (interactive mode indicator) was already delivered in Phase 13 via `ring-2 ring-accent1` border + cursor changes. No further work needed for VIS-01.

Output: Custom Tailwind keyframe, useClickRipple hook, ClickRippleOverlay component, and integration into BrowserViewFrame.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@packages/playground-ui/tailwind.config.ts
@packages/playground-ui/src/domains/agents/components/browser-view/browser-view-frame.tsx
@packages/playground-ui/src/domains/agents/utils/coordinate-mapping.ts
@packages/playground-ui/src/domains/agents/hooks/use-mouse-interaction.ts
@packages/playground-ui/src/ds/tokens/colors.ts

Phase 14 research and context:
@.planning/phases/14-visual-feedback-and-polish/14-CONTEXT.md
@.planning/phases/14-visual-feedback-and-polish/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tailwind keyframe, useClickRipple hook, and ClickRippleOverlay component</name>
  <files>
    packages/playground-ui/tailwind.config.ts
    packages/playground-ui/src/domains/agents/hooks/use-click-ripple.ts
    packages/playground-ui/src/domains/agents/components/browser-view/click-ripple-overlay.tsx
  </files>
  <action>
    **1a. Add click-ripple keyframe to tailwind.config.ts**

    In `theme.extend.keyframes` (alongside existing `shimmer`), add:
    ```
    'click-ripple': {
      '0%': { transform: 'scale(0)', opacity: '0.5' },
      '100%': { transform: 'scale(1)', opacity: '0' },
    }
    ```

    In `theme.extend` add an `animation` key:
    ```
    animation: {
      'click-ripple': 'click-ripple 300ms ease-out forwards',
    }
    ```

    This adds `animate-click-ripple` as a Tailwind utility class.

    **1b. Create useClickRipple hook**

    Create `packages/playground-ui/src/domains/agents/hooks/use-click-ripple.ts`.

    Interface:
    ```typescript
    interface Ripple {
      id: number;
      x: number;  // CSS px relative to container
      y: number;  // CSS px relative to container
    }

    interface UseClickRippleOptions {
      imgRef: React.RefObject<HTMLImageElement | null>;
      viewport: { width: number; height: number } | null;
      enabled: boolean;  // only when status === 'streaming' and hasFrame
    }

    interface UseClickRippleReturn {
      ripples: Ripple[];
      removeRipple: (id: number) => void;
    }
    ```

    Implementation:
    - Maintain `ripples` state as `Ripple[]` and an `idRef` counter via `useRef(0)`.
    - Store viewport in a ref (same pattern as use-mouse-interaction.ts) to avoid listener re-attachment.
    - Attach a `mousedown` listener to `imgRef.current` (same lifecycle pattern as use-mouse-interaction).
    - On mousedown, compute display-space position using the SAME letterbox math from coordinate-mapping.ts. Specifically:
      - Get `imgElement.getBoundingClientRect()` for the element rect
      - Compute `relX = clientX - rect.left`, `relY = clientY - rect.top`
      - Compute `scale = Math.min(rect.width / viewport.width, rect.height / viewport.height)`
      - Compute `renderedWidth = viewport.width * scale`, `renderedHeight = viewport.height * scale`
      - Compute `offsetX = (rect.width - renderedWidth) / 2`, `offsetY = (rect.height - renderedHeight) / 2`
      - Compute `imageX = relX - offsetX`, `imageY = relY - offsetY`
      - If `imageX < 0 || imageY < 0 || imageX > renderedWidth || imageY > renderedHeight`, return (letterbox click, no ripple)
      - Use `relX` and `relY` as the ripple position (container-relative CSS px, NOT viewport-space CDP coordinates)
    - Left-click only: check `e.button === 0` before creating ripple. Right-click has different semantics.
    - Safety cap: if `ripples.length >= 10`, skip adding new ones (MAX_RIPPLES = 10 constant).
    - Export `useClickRipple` as named export.

    IMPORTANT: The ripple position is in DISPLAY space (CSS pixels relative to container), NOT viewport space. The existing `mapClientToViewport` returns viewport coordinates for CDP. For ripple positioning we need the intermediate container-relative values (`relX`, `relY`). Either inline the letterbox boundary check or create a small helper like `isInsideRenderedImage` that reuses the same math but returns the container-relative position. Do NOT use `mapClientToViewport` output for ripple positioning -- those are CDP viewport coordinates.

    **1c. Create ClickRippleOverlay component**

    Create `packages/playground-ui/src/domains/agents/components/browser-view/click-ripple-overlay.tsx`.

    Props:
    ```typescript
    interface ClickRippleOverlayProps {
      ripples: Ripple[];
      onAnimationEnd: (id: number) => void;
    }
    ```

    Implementation:
    - Render a fragment containing absolutely-positioned `<span>` elements for each ripple.
    - Each span:
      - `key={ripple.id}`
      - `className="absolute rounded-full pointer-events-none animate-click-ripple bg-accent1/40"`
      - `style={{ left: ripple.x - RIPPLE_RADIUS, top: ripple.y - RIPPLE_RADIUS, width: RIPPLE_SIZE, height: RIPPLE_SIZE }}`
      - `onAnimationEnd={() => onAnimationEnd(ripple.id)}`
    - Constants: `RIPPLE_SIZE = 32`, `RIPPLE_RADIUS = RIPPLE_SIZE / 2` (16px).
    - Use `bg-accent1/40` for the ripple color (accent1 = #1AFB6F at 40% opacity). Do NOT hardcode rgba values.
    - Every ripple span MUST have `pointer-events-none` to avoid intercepting mouse events.
    - Export `ClickRippleOverlay` as named export. Also export the `Ripple` interface from this file (or from the hook -- pick one canonical location).
  </action>
  <verify>
    Run `cd /Users/abhiramaiyer/.superset/worktrees/mastra/ab-tools/packages/playground-ui && npx tsc --noEmit` -- no type errors in the new files.
    Confirm `animate-click-ripple` is defined in tailwind config by searching for `click-ripple` in tailwind.config.ts.
    Confirm `useClickRipple` exports from the hook file.
    Confirm `ClickRippleOverlay` exports from the component file.
  </verify>
  <done>
    - tailwind.config.ts has `click-ripple` keyframe and `animate-click-ripple` animation utility
    - useClickRipple hook manages ripple state array, creates ripples on left-click mousedown with letterbox boundary check, uses container-relative display coordinates
    - ClickRippleOverlay renders ripple spans with CSS animation, pointer-events-none, accent1/40 color, onAnimationEnd cleanup
    - All files pass TypeScript type checking
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ClickRippleOverlay into BrowserViewFrame</name>
  <files>
    packages/playground-ui/src/domains/agents/components/browser-view/browser-view-frame.tsx
  </files>
  <action>
    Integrate the click ripple system into the existing BrowserViewFrame component.

    **2a. Add imports**

    Add imports for `useClickRipple` and `ClickRippleOverlay`:
    ```typescript
    import { useClickRipple } from '../../hooks/use-click-ripple';
    import { ClickRippleOverlay } from './click-ripple-overlay';
    ```

    **2b. Call useClickRipple hook**

    After the existing `useKeyboardInteraction` call, add:
    ```typescript
    const { ripples, removeRipple } = useClickRipple({
      imgRef,
      viewport,
      enabled: status === 'streaming' && hasFrame,
    });
    ```

    The `enabled` condition ensures ripples only appear when the stream is active and at least one frame has been received (prevents ripple rendering before container has dimensions).

    **2c. Render ClickRippleOverlay inside container div**

    Inside the container `<div ref={containerRef} ...>`, add the overlay AFTER the `<img>` element and BEFORE the loading skeleton. The overlay renders inside the same relatively-positioned container, so absolute positioning works correctly:

    ```tsx
    {/* Click ripple feedback overlay */}
    <ClickRippleOverlay ripples={ripples} onAnimationEnd={removeRipple} />
    ```

    Place it after the `<img>` tag so ripples render on top of the frame image.

    **2d. No other changes needed**

    The container div already has `relative` and `overflow-hidden` classes, which are exactly what the ripple overlay needs for positioning and boundary clipping. Do not add or remove any classes from the container.
  </action>
  <verify>
    Run `cd /Users/abhiramaiyer/.superset/worktrees/mastra/ab-tools/packages/playground-ui && npx tsc --noEmit` -- no type errors.
    Run `cd /Users/abhiramaiyer/.superset/worktrees/mastra/ab-tools && pnpm build:cli` -- build succeeds (playground-ui is a dependency of CLI).
    Grep browser-view-frame.tsx for `ClickRippleOverlay` and `useClickRipple` to confirm integration.
  </verify>
  <done>
    - BrowserViewFrame imports and calls useClickRipple with imgRef, viewport, and enabled guard
    - ClickRippleOverlay rendered inside the container div after the img element
    - Full build passes with no errors
    - Click ripple system is fully wired: mousedown on img -> useClickRipple creates ripple with display-space coordinates -> ClickRippleOverlay renders animated span -> onAnimationEnd removes ripple from state
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `cd packages/playground-ui && npx tsc --noEmit` passes
2. Build: `pnpm build:cli` succeeds from repo root
3. Tailwind config: `click-ripple` keyframe exists in theme.extend.keyframes
4. Hook: useClickRipple creates ripples only for left-click (button === 0) inside rendered image area
5. Component: ClickRippleOverlay spans all have `pointer-events-none` and `animate-click-ripple`
6. Integration: BrowserViewFrame renders ClickRippleOverlay inside container div
7. Coordinate space: Ripple uses container-relative CSS pixels (display space), not CDP viewport coordinates
8. Color: Uses `bg-accent1/40` Tailwind class, not hardcoded rgba
9. Safety: MAX_RIPPLES cap prevents unbounded state growth
10. Cleanup: onAnimationEnd removes ripples from state (no memory leak)
</verification>

<success_criteria>
- VIS-01: Already complete from Phase 13 (ring-2 ring-accent1 + cursor changes). No work needed.
- VIS-02: Click ripple effect appears immediately at click position with accent1 color, 300ms animation, correct letterbox-aware positioning, and automatic cleanup via onAnimationEnd.
- Full TypeScript and build pass with zero errors.
</success_criteria>

<output>
After completion, create `.planning/phases/14-visual-feedback-and-polish/14-01-SUMMARY.md`
</output>
