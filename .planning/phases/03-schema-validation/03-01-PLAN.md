---
phase: 03-schema-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/utils.ts
autonomous: true

must_haves:
  truths:
    - "Default values from inputSchema are applied to workflow input"
    - "Default values from step inputSchema are applied to step input"
    - "Default values from resumeSchema are applied when resuming"
    - "Invalid workflow input throws validation error with correct message"
    - "Invalid step input fails the step with validation error"
    - "Invalid resume data throws error and workflow remains suspended"
    - "ZodError is preserved as cause in validation errors"
    - "Validation works correctly with .map() after .foreach()"
    - "Steps can have subset input schema of previous step output"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "12 schema validation tests in Schema Validation describe block"
      contains: "should use default value from inputSchema"
    - path: "packages/core/src/workflows/utils.ts"
      provides: "Step input validation with defaults"
      exports: ["validateStepInput"]
  key_links:
    - from: "packages/core/src/workflows/evented/step-executor.ts"
      to: "packages/core/src/workflows/utils.ts:validateStepInput"
      via: "import and call"
      pattern: "validateStepInput"
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "packages/core/src/workflows/workflow.ts:_validateInput"
      via: "inheritance"
      pattern: "_validateInput"
---

<objective>
Port 12 schema validation tests from default runtime to evented runtime and fix any validation gaps.

Purpose: Achieve test parity for schema validation including default values, validation errors, and complex scenarios.
Output: 12 passing tests in evented-workflow.test.ts Schema Validation describe block.
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-schema-validation/03-RESEARCH.md
@.planning/phases/01-state-object-support/01-SUMMARY.md
@.planning/phases/02-lifecycle-callbacks/02-01-SUMMARY.md
@packages/core/src/workflows/workflow.test.ts (lines 8640-9690 for reference tests)
@packages/core/src/workflows/evented/evented-workflow.test.ts (target file)
@packages/core/src/workflows/utils.ts (validateStepInput, lines 22-60)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 12 schema validation tests to evented runtime</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Replace the existing skipped test in the "Schema Validation" describe block (around line 5443) with 12 tests ported from the default runtime.

**Test categories to port:**

1. **Default Values (3 tests):**
   - `should use default value from inputSchema` - Workflow input with `.optional().default({ value: 1 })`
   - `should use default value from inputSchema for step input` - Step2 has `.optional().default('test')`, uses `.map()` to pass undefined
   - `should use default value from resumeSchema when resuming a workflow` - Resume with `{}`, verify default 21 is applied

2. **Validation Errors (5 tests):**
   - `should throw error if trigger data is invalid` - Pass nested.value as string instead of number
   - `should throw error if inputData is invalid` - Step2 expects `{ start: string }` but receives `{ result: string }` from step1
   - `should throw error if inputData is invalid in workflow with .map()` - Step2 expects string, gets number after `.map()`
   - `should throw error if inputData is invalid in nested workflows` - Nested workflow step validation fails, error propagates
   - `should throw error when you try to resume a workflow step with invalid resume data` - Resume with `{ number: 2 }` instead of `{ value: number }`

3. **Error Details (1 test):**
   - `should preserve ZodError as cause when input validation fails` - Verify `result.error.cause.issues` is array with >= 2 items

4. **Complex Scenarios (2 tests):**
   - `should properly validate input schema when .map is used after .foreach` - Bug #11313 regression test, foreach + map chain
   - `should allow a steps input schema to be a subset of the previous step output schema` - Test equal, missing required, missing optional, extra optional key scenarios

**Evented runtime adaptations required:**
- Add `pubsub: new EventEmitterPubSub()` to Mastra config
- Add `await mastra.startEventEngine()` before test
- Add `await mastra.stopEventEngine()` in afterEach or after test
- Use workflow IDs with `-evented` suffix to avoid conflicts
- Reference tests are in workflow.test.ts lines 8640-9690 - copy test logic, adapt for evented patterns

**Structure:**
```typescript
describe('Schema Validation', () => {
  describe('Default Values', () => {
    it('should use default value from inputSchema', async () => { ... });
    it('should use default value from inputSchema for step input', async () => { ... });
    it('should use default value from resumeSchema when resuming a workflow', async () => { ... });
  });

  describe('Validation Errors', () => {
    it('should throw error if trigger data is invalid', async () => { ... });
    it('should throw error if inputData is invalid', async () => { ... });
    it('should throw error if inputData is invalid in workflow with .map()', async () => { ... });
    it('should throw error if inputData is invalid in nested workflows', async () => { ... });
    it('should throw error when you try to resume a workflow step with invalid resume data', async () => { ... });
  });

  describe('Error Details', () => {
    it('should preserve ZodError as cause when input validation fails', async () => { ... });
  });

  describe('Complex Scenarios', () => {
    it('should properly validate input schema when .map is used after .foreach', async () => { ... });
    it('should allow a steps input schema to be a subset of the previous step output schema', async () => { ... });
  });
});
```
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "Schema Validation"` and observe test results.
Note which tests pass and which fail. Failures will guide Task 2.
  </verify>
  <done>
12 schema validation tests exist in evented-workflow.test.ts. Some may fail - that's expected as RED phase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix validation issues to make all tests pass</name>
  <files>packages/core/src/workflows/utils.ts, packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Based on Task 1 test results, fix any failing tests.

**Likely fix: isEmpty() check in validateStepInput (utils.ts lines 54-55)**

The current code:
```typescript
const isEmptyData = isEmpty(validatedInput.data);
inputData = isEmptyData ? prevOutput : validatedInput.data;
```

This may prevent defaults from being applied when validatedInput.data is `{}` but should contain defaults.

**Fix approach:**
1. If tests for default values fail, investigate whether isEmpty() is stripping defaults
2. The fix may be to always use `validatedInput.data` when validation succeeds:
   ```typescript
   inputData = validatedInput.data;
   ```
   Or to check if defaults were applied before using isEmpty():
   ```typescript
   // Only fall back to prevOutput if data is empty AND schema has no defaults
   const hasDefaults = validatedInput.data !== prevOutput;
   inputData = hasDefaults ? validatedInput.data : prevOutput;
   ```

**Other potential issues:**
- Nested workflow validation errors not propagating - check step-executor.ts error handling
- Resume data validation not using validated data - check workflow.ts _validateResumeData call

**Debug steps:**
1. Add console.log to validateStepInput to see what's happening with defaults
2. Check if schema.parse() vs schema.safeParseAsync() behaves differently
3. Verify MastraError preserves ZodError as cause

If all 12 tests pass after Task 1, this task requires no changes - just verification.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "Schema Validation"`.
All 12 tests must pass.
  </verify>
  <done>
All 12 schema validation tests pass. No regressions in other tests.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify no regressions and commit</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
1. Run full test suite for evented workflow: `cd packages/core && pnpm test evented-workflow.test.ts`
2. Verify previous test count (146) + new tests (12) = 158 passing
3. Verify 6 tests still skipped (streaming vNext)
4. Run typecheck: `pnpm typecheck` from repo root
5. If any regressions, fix them before committing

**Commit the changes:**
- If only tests added (no source fixes): `git add . && git commit -m "test(03-01): port 12 schema validation tests to evented runtime"`
- If source fixes required: First commit tests, then commit fixes separately
  </action>
  <verify>
`cd packages/core && pnpm test evented-workflow.test.ts` shows:
- 158 passing tests (or 146 + 12 = 158)
- 6 skipped tests
- No failures

`pnpm typecheck` passes with no errors in modified files.
  </verify>
  <done>
158 tests passing, no regressions, changes committed.
  </done>
</task>

</tasks>

<verification>
1. All 12 schema validation tests pass in evented runtime
2. Default values are correctly applied from inputSchema, step inputSchema, and resumeSchema
3. Validation errors include correct messages and preserve ZodError as cause
4. Complex scenarios (.map after .foreach, subset schemas) work correctly
5. No regressions in existing 146 tests
6. TypeScript compiles without errors
</verification>

<success_criteria>
- 12 new schema validation tests added to evented-workflow.test.ts
- All 12 tests pass
- Total test count: 158 passing (146 existing + 12 new)
- 6 tests remain skipped (streaming vNext - Phase 5)
- No type errors
- Changes committed with appropriate message
</success_criteria>

<output>
After completion, create `.planning/phases/03-schema-validation/03-01-SUMMARY.md` following the summary template.
</output>
