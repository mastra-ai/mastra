---
phase: 01-storage-foundation
plan: 04
type: execute
wave: 4
depends_on: [01-03]
files_modified:
  - packages/core/src/storage/domains/datasets/__tests__/datasets.test.ts
autonomous: true

must_haves:
  truths:
    - "Tests pass for both in-memory and LibSQL backends"
    - "CRUD operations verified for datasets and items"
    - "Auto-versioning behavior confirmed on item mutations"
    - "Version query semantics validated (snapshot behavior)"
  artifacts:
    - path: "packages/core/src/storage/domains/datasets/__tests__/datasets.test.ts"
      provides: "Shared test suite for DatasetsStorage"
      min_lines: 150
  key_links:
    - from: "packages/core/src/storage/domains/datasets/__tests__/datasets.test.ts"
      to: "packages/core/src/storage/domains/datasets/inmemory.ts"
      via: "instantiates DatasetsInMemory"
      pattern: "new DatasetsInMemory"
---

<objective>
Create test suite validating DatasetsStorage contract for both in-memory and LibSQL backends.

Purpose: Verify all CRUD operations, auto-versioning behavior, and version query semantics work correctly across both storage backends.
Output: Passing test suite that catches contract mismatches between implementations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-storage-foundation/01-RESEARCH.md

# Implementation to test
@packages/core/src/storage/domains/datasets/base.ts
@packages/core/src/storage/domains/datasets/inmemory.ts

# Existing test patterns
@packages/core/src/storage/domains/scores/__tests__/scores.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DatasetsStorage test suite</name>
  <files>packages/core/src/storage/domains/datasets/__tests__/datasets.test.ts</files>
  <action>
Create test file following existing scores test pattern. Use `describe.each` to run same tests against both backends.

Structure:
```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { DatasetsInMemory } from '../inmemory';
import { InMemoryDB } from '../../inmemory-db';
import type { DatasetsStorage } from '../base';

// Factory for each backend
const backends: Array<{ name: string; createStorage: () => DatasetsStorage }> = [
  {
    name: 'InMemory',
    createStorage: () => new DatasetsInMemory({ db: new InMemoryDB() }),
  },
  // LibSQL can be added when integration tests are set up
];

describe.each(backends)('DatasetsStorage ($name)', ({ createStorage }) => {
  let storage: DatasetsStorage;

  beforeEach(() => {
    storage = createStorage();
  });

  // Test groups below
});
```

**Test groups to include:**

1. **Dataset CRUD**
   - createDataset: creates with name, description, metadata, version starts at 1
   - getDatasetById: returns dataset or null
   - updateDataset: updates fields, updatedAt changes
   - deleteDataset: removes dataset
   - listDatasets: pagination works, filters by name if supported

2. **Item CRUD**
   - addItem: creates item with input, expectedOutput, context (all JSON types)
   - updateItem: modifies item fields
   - deleteItem: removes item
   - listItems: pagination, filters by datasetId

3. **Auto-versioning (CRITICAL)**
   - addItem increments dataset.version
   - updateItem increments dataset.version
   - deleteItem increments dataset.version
   - Multiple items added = multiple version increments
   - Item stores version it was added/modified at

4. **Version query semantics**
   - getItemsByVersion returns items at or before that version
   - listItems with version filter uses snapshot semantics
   - Items added after version N not returned for version N query

5. **Edge cases**
   - getDatasetById with non-existent ID returns null
   - deleteDataset with non-existent ID (behavior: no-op or error)
   - addItem to non-existent dataset throws
   - JSON input/expectedOutput with nested objects, arrays, null values

**Assertions:**
- Use `expect(dataset.version).toBe(expectedVersion)` for versioning
- Verify timestamps are Date objects
- Verify JSON roundtrip (input stored = input retrieved)
  </action>
  <verify>
Run tests:
```bash
cd packages/core && pnpm test src/storage/domains/datasets
```
All tests pass.
  </verify>
  <done>
Test suite covers all CRUD operations, auto-versioning behavior, and version query semantics. Tests pass for in-memory backend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify auto-versioning behavior specifically</name>
  <files>packages/core/src/storage/domains/datasets/__tests__/datasets.test.ts</files>
  <action>
Add dedicated auto-versioning test block if not already comprehensive:

```typescript
describe('auto-versioning', () => {
  it('increments version on addItem', async () => {
    const dataset = await storage.createDataset({ name: 'test' });
    expect(dataset.version).toBe(1);

    await storage.addItem({ datasetId: dataset.id, input: { prompt: 'hello' } });
    const updated = await storage.getDatasetById({ id: dataset.id });
    expect(updated?.version).toBe(2);
  });

  it('increments version on updateItem', async () => {
    const dataset = await storage.createDataset({ name: 'test' });
    const item = await storage.addItem({ datasetId: dataset.id, input: { a: 1 } });

    await storage.updateItem({ id: item.id, datasetId: dataset.id, input: { a: 2 } });
    const updated = await storage.getDatasetById({ id: dataset.id });
    expect(updated?.version).toBe(3); // 1 (create) + 1 (add) + 1 (update)
  });

  it('increments version on deleteItem', async () => {
    const dataset = await storage.createDataset({ name: 'test' });
    const item = await storage.addItem({ datasetId: dataset.id, input: {} });

    await storage.deleteItem({ id: item.id, datasetId: dataset.id });
    const updated = await storage.getDatasetById({ id: dataset.id });
    expect(updated?.version).toBe(3); // 1 (create) + 1 (add) + 1 (delete)
  });

  it('item stores version when added', async () => {
    const dataset = await storage.createDataset({ name: 'test' });
    // Version is 1 after create

    const item1 = await storage.addItem({ datasetId: dataset.id, input: { n: 1 } });
    expect(item1.version).toBe(2); // Added at version 2

    const item2 = await storage.addItem({ datasetId: dataset.id, input: { n: 2 } });
    expect(item2.version).toBe(3); // Added at version 3
  });

  it('getItemsByVersion returns snapshot', async () => {
    const dataset = await storage.createDataset({ name: 'test' });
    const item1 = await storage.addItem({ datasetId: dataset.id, input: { n: 1 } }); // v2
    const item2 = await storage.addItem({ datasetId: dataset.id, input: { n: 2 } }); // v3

    // Query at version 2 should only return item1
    const itemsAtV2 = await storage.getItemsByVersion({ datasetId: dataset.id, version: 2 });
    expect(itemsAtV2).toHaveLength(1);
    expect(itemsAtV2[0].id).toBe(item1.id);

    // Query at version 3 should return both
    const itemsAtV3 = await storage.getItemsByVersion({ datasetId: dataset.id, version: 3 });
    expect(itemsAtV3).toHaveLength(2);
  });
});
```

Run and ensure all versioning tests pass.
  </action>
  <verify>
```bash
cd packages/core && pnpm test src/storage/domains/datasets --grep "auto-versioning"
```
All auto-versioning tests pass.
  </verify>
  <done>
Auto-versioning behavior is thoroughly tested: addItem, updateItem, deleteItem all increment version, items track their version, and snapshot queries work correctly.
  </done>
</task>

</tasks>

<verification>
- [ ] Test file created at correct path
- [ ] Tests cover Dataset CRUD (create, get, update, delete, list)
- [ ] Tests cover Item CRUD (add, update, delete, list)
- [ ] Tests verify auto-versioning on all item mutations
- [ ] Tests verify version query semantics (snapshot behavior)
- [ ] Tests verify JSON handling for input/expectedOutput/context
- [ ] All tests pass with `pnpm test`
</verification>

<success_criteria>
- Test suite exists and runs
- All tests pass for in-memory backend
- Auto-versioning behavior verified (the critical feature of Phase 1)
- Version query snapshot semantics verified
- JSON roundtrip for flexible input types verified
</success_criteria>

<output>
After completion, create `.planning/phases/01-storage-foundation/01-04-SUMMARY.md`
</output>
