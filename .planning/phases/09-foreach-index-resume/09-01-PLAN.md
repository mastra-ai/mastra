---
phase: 09-foreach-index-resume
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/workflow.ts
  - packages/core/src/workflows/evented/execution-engine.ts
  - packages/core/src/workflows/evented/step-executor.ts
  - packages/core/src/workflows/evented/workflow-event-processor/index.ts
  - packages/core/src/workflows/evented/workflow-event-processor/loop.ts
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "EventedRun.resume() accepts optional forEachIndex parameter"
    - "Resume with forEachIndex targets specific iteration without re-executing previous iterations"
    - "Resume without forEachIndex continues default behavior (resume all suspended)"
    - "foreachIndex is stored in __workflow_meta.foreachIndex when step suspends inside foreach"
  artifacts:
    - path: "packages/core/src/workflows/evented/workflow.ts"
      provides: "forEachIndex parameter in resume() signature"
      contains: "forEachIndex?: number"
    - path: "packages/core/src/workflows/evented/execution-engine.ts"
      provides: "forEachIndex in resume type and pubsub event data"
      contains: "forEachIndex"
    - path: "packages/core/src/workflows/evented/step-executor.ts"
      provides: "foreachIndex stored in __workflow_meta on suspend"
      contains: "foreachIndex: params.foreachIdx"
    - path: "packages/core/src/workflows/evented/workflow-event-processor/index.ts"
      provides: "forEachIndex in ProcessorArgs type"
      contains: "forEachIndex?: number"
    - path: "packages/core/src/workflows/evented/workflow-event-processor/loop.ts"
      provides: "forEachIndex-aware iteration skip logic"
      contains: "forEachIndex"
  key_links:
    - from: "evented/workflow.ts resume()"
      to: "executionEngine.execute()"
      via: "resume object with forEachIndex"
      pattern: "forEachIndex: params\\.forEachIndex"
    - from: "evented/execution-engine.ts execute()"
      to: "pubsub.publish('workflows', { type: 'workflow.resume' })"
      via: "forEachIndex in event data"
      pattern: "forEachIndex.*data\\.forEachIndex|data.*forEachIndex"
    - from: "workflow-event-processor/index.ts ProcessorArgs"
      to: "processWorkflowForEach()"
      via: "ProcessorArgs destructuring"
      pattern: "forEachIndex.*ProcessorArgs"
    - from: "step-executor.ts suspend()"
      to: "__workflow_meta object"
      via: "foreachIndex field"
      pattern: "foreachIndex: params\\.foreachIdx"
---

<objective>
Implement forEachIndex parameter support in evented runtime resume() to enable targeted foreach iteration resume.

Purpose: Complete v1.1 milestone by achieving foreach suspend/resume parity with default runtime. Users can resume specific foreach iterations by index rather than resuming all suspended iterations at once.

Output:
- forEachIndex parameter added to EventedRun.resume()
- foreachIndex stored in __workflow_meta during suspend (FOREACH-03)
- ProcessorArgs extended with forEachIndex field
- processWorkflowForEach modified to skip non-targeted iterations
- 6 foreach suspend/resume tests unskipped and passing
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-foreach-index-resume/09-RESEARCH.md

# Reference implementation in default runtime
@packages/core/src/workflows/workflow.ts (lines 3088-3104 for forEachIndex in resume, 3445-3451 for passing to execute)
@packages/core/src/workflows/handlers/control-flow.ts (lines 859-873 for iteration skip logic, 977-981 for __workflow_meta.foreachIndex storage)
@packages/core/src/workflows/handlers/step.ts (lines 339-345 for foreachIndex in resumeLabels)

# Files to modify
@packages/core/src/workflows/evented/workflow.ts (lines 1622-1790 for resume())
@packages/core/src/workflows/evented/execution-engine.ts (lines 56-105 for resume type and pubsub event)
@packages/core/src/workflows/evented/step-executor.ts (lines 148-156 for __workflow_meta in suspend)
@packages/core/src/workflows/evented/workflow-event-processor/index.ts (lines 24-48 for ProcessorArgs)
@packages/core/src/workflows/evented/workflow-event-processor/loop.ts (lines 145-310 for processWorkflowForEach)

# Tests to unskip
@packages/core/src/workflows/evented/evented-workflow.test.ts (lines 18912-19519)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add forEachIndex parameter threading through evented runtime</name>
  <files>
    packages/core/src/workflows/evented/workflow.ts
    packages/core/src/workflows/evented/execution-engine.ts
    packages/core/src/workflows/evented/step-executor.ts
    packages/core/src/workflows/evented/workflow-event-processor/index.ts
  </files>
  <action>
**The evented runtime event flow for forEachIndex:**
```
resume(forEachIndex)
  -> executionEngine.execute({ resume: { forEachIndex } })
  -> pubsub.publish('workflows', { type: 'workflow.resume', data: { forEachIndex } })
  -> WorkflowEventProcessor.process() receives event
  -> processWorkflowStepRun() called with ProcessorArgs containing forEachIndex
  -> processWorkflowForEach() receives forEachIndex via ProcessorArgs
```

**Implementation steps:**

1. **evented/workflow.ts resume() method (line 1622):**
   - Add `forEachIndex?: number` to the params type definition:
     ```typescript
     async resume<TResumeSchema>(params: {
       resumeData?: TResumeSchema;
       step?: ...;
       label?: string;
       forEachIndex?: number;  // ADD THIS
       requestContext?: RequestContext;
       perStep?: boolean;
     })
     ```
   - Pass forEachIndex to executionEngine.execute() in the resume object (around line 1768):
     ```typescript
     resume: {
       steps,
       stepResults: snapshot?.context as any,
       resumePayload: resumeDataToUse,
       resumePath,
       forEachIndex: params.forEachIndex ?? snapshotResumeLabel?.foreachIndex,
     },
     ```

2. **evented/execution-engine.ts (line 56-61):**
   - Add forEachIndex to the resume type in the execute() params:
     ```typescript
     resume?: {
       steps: string[];
       stepResults: Record<string, StepResult<any, any, any, any>>;
       resumePayload: any;
       resumePath: number[];
       forEachIndex?: number;  // ADD THIS
     };
     ```
   - Include forEachIndex in the pubsub event data (line 87-105):
     ```typescript
     await pubsub.publish('workflows', {
       type: 'workflow.resume',
       runId: params.runId,
       data: {
         // ... existing fields ...
         forEachIndex: params.resume.forEachIndex,  // ADD THIS
       },
     });
     ```

3. **step-executor.ts (line 148-156) - FOREACH-03 requirement:**
   - Add foreachIndex to the __workflow_meta object when suspending:
     ```typescript
     suspended = {
       payload: {
         ...suspendData,
         __workflow_meta: {
           runId,
           path: [step.id],
           foreachIndex: params.foreachIdx,  // ADD THIS - stores current iteration index
           resumeLabels: Object.keys(resumeLabels).length > 0 ? resumeLabels : undefined,
         },
       },
     };
     ```
   - This matches default runtime behavior in control-flow.ts line 981

4. **workflow-event-processor/index.ts ProcessorArgs type (line 24-48):**
   - Add `forEachIndex?: number` field to the ProcessorArgs type:
     ```typescript
     export type ProcessorArgs = {
       // ... existing fields ...
       forEachIndex?: number;  // ADD THIS
     };
     ```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd packages/core && pnpm tsc --noEmit
```
  </verify>
  <done>
- forEachIndex parameter accepted in EventedRun.resume() method
- forEachIndex passed through executionEngine.execute() resume object
- forEachIndex included in 'workflow.resume' pubsub event data
- foreachIndex stored in __workflow_meta during step suspend (FOREACH-03)
- ProcessorArgs type includes forEachIndex field
- TypeScript compilation passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement foreach iteration skip logic and unskip tests</name>
  <files>
    packages/core/src/workflows/evented/workflow-event-processor/loop.ts
    packages/core/src/workflows/evented/evented-workflow.test.ts
  </files>
  <action>
**1. In loop.ts processWorkflowForEach function:**

The function signature is at line 145. Add forEachIndex to the destructured ProcessorArgs:
```typescript
export async function processWorkflowForEach(
  {
    workflowId,
    prevResult,
    runId,
    executionPath,
    stepResults,
    activeSteps,
    resumeSteps,
    timeTravel,
    resumeData,
    parentWorkflow,
    requestContext,
    perStep,
    state,
    outputOptions,
    forEachIndex,  // ADD THIS
  }: ProcessorArgs,
  // ... rest unchanged
)
```

**Iteration skip logic location - AFTER line 178 (the idx/targetLen calculation):**

The evented foreach tracks progress using:
- `currentResult.output` array (null placeholders for pending iterations)
- `executionPath[1]` is the current iteration index being processed

Insert skip logic after the existing length checks (around line 181, before the completion check):

```typescript
const idx = currentResult?.output?.length ?? 0;
const targetLen = (prevResult as any)?.output?.length ?? 0;

// NEW: forEachIndex-aware skip logic for resume
// When resuming with forEachIndex, check each iteration's status:
// - If iteration already succeeded, skip it
// - If iteration is suspended and NOT the target forEachIndex, skip it
// - Only process the targeted forEachIndex iteration with resumeData
if (forEachIndex !== undefined && resumeSteps?.length > 0) {
  const currentIterationIdx = executionPath[1];
  if (currentIterationIdx !== undefined) {
    const iterationResult = currentResult?.output?.[currentIterationIdx];

    // Skip already-completed iterations
    if (iterationResult !== null && iterationResult?.status === 'success') {
      // This iteration completed, don't re-run it
      return;
    }

    // Skip non-targeted suspended iterations
    if (currentIterationIdx !== forEachIndex) {
      // Not our target, skip this iteration on resume
      return;
    }
  }
}

// Only pass resumeData to the targeted forEachIndex iteration
const resumeDataToUse = (forEachIndex === undefined || executionPath[1] === forEachIndex)
  ? resumeData
  : undefined;
```

Then update all pubsub.publish calls in the function to pass `resumeData: resumeDataToUse` instead of `resumeData`.

**Key insight:** The evented foreach processes iterations via separate pubsub events. Each iteration triggers a 'workflow.step.run' event with its own executionPath[1] index. The skip logic needs to return early (not publish next step event) for iterations that shouldn't be re-processed.

**2. In evented-workflow.test.ts:**

Remove `.skip` from these 6 test names:
- Line 18925: `it.skip('should suspend and resume when running a single item concurrency (default) for loop'`
- Line 19024: `it.skip('should suspend and resume when running all items concurrency for loop'`
- Line 19117: `it.skip('should suspend and resume provided index when running all items concurrency for loop'`
- Line 19219: `it.skip('should suspend and resume provided label when running all items concurrency for loop'`
- Line 19326: `it.skip('should suspend and resume when running a partial item concurrency for loop'`
- Line 19417: `it.skip('should suspend and resume provided index when running a partial item concurrency for loop'`

Remove `as any` type casts on forEachIndex parameters (lines 19182, 19186, 19190, etc.) since the type now exists.

**Test verification notes:**
- Tests 19117 and 19417 are the primary forEachIndex tests
- Tests 19219 uses labels which internally resolve to foreachIndex
- If tests 18925 and 19024 fail, there may be a pre-existing issue with basic foreach suspend/resume that needs fixing first
  </action>
  <verify>
Run the foreach suspend/resume tests:
```bash
cd packages/core && pnpm vitest run -t "foreach" --reporter=verbose 2>&1 | tail -50
```

All 6 previously-skipped tests should pass. Check test output for:
- "should suspend and resume when running a single item concurrency (default) for loop"
- "should suspend and resume when running all items concurrency for loop"
- "should suspend and resume provided index when running all items concurrency for loop"
- "should suspend and resume provided label when running all items concurrency for loop"
- "should suspend and resume when running a partial item concurrency for loop"
- "should suspend and resume provided index when running a partial item concurrency for loop"
  </verify>
  <done>
- processWorkflowForEach extracts forEachIndex from ProcessorArgs
- Skip logic inserted after line 178 (idx/targetLen calculation)
- Non-targeted iterations skip processing, targeted iteration receives resumeData
- 6 foreach suspend/resume tests unskipped
- All 6 tests pass
- Total evented workflow tests: ~197 passing (was 195)
  </done>
</task>

</tasks>

<verification>
Run full evented workflow test suite to ensure no regressions:
```bash
cd packages/core && pnpm vitest run evented-workflow.test.ts --reporter=verbose 2>&1 | tail -30
```

Expected: 197+ tests passing, 26 or fewer skipped (was 32 skipped, now 6 unskipped)

Verify test counts match expectation:
```bash
cd packages/core && pnpm vitest run evented-workflow.test.ts 2>&1 | grep -E "(Tests|passed|failed|skipped)"
```

Verify FOREACH-03 (foreachIndex in __workflow_meta):
```bash
cd packages/core && pnpm vitest run -t "provided index" --reporter=verbose 2>&1 | grep -A5 "suspendPayload"
```
Test assertions should show `__workflow_meta: { foreachIndex: ... }` in the suspendPayload.
</verification>

<success_criteria>
Requirements coverage:
- FOREACH-01: forEachIndex parameter accepted in EventedRun.resume() - VERIFIED by TypeScript compilation and test usage
- FOREACH-02: forEachIndex targets specific iteration on resume - VERIFIED by tests 19117 and 19417 passing
- FOREACH-03: foreachIndex stored in __workflow_meta on suspend - VERIFIED by step-executor.ts change and test assertions checking suspendPayload.__workflow_meta.foreachIndex

Test metrics:
- 6 previously-skipped foreach tests now passing
- No regressions in existing 195 passing tests
- Total: 197+ passing, ~26 skipped
</success_criteria>

<output>
After completion, create `.planning/phases/09-foreach-index-resume/09-01-SUMMARY.md`
</output>
