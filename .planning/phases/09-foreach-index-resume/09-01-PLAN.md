---
phase: 09-foreach-index-resume
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/workflow.ts
  - packages/core/src/workflows/evented/workflow-event-processor/index.ts
  - packages/core/src/workflows/evented/workflow-event-processor/loop.ts
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "EventedRun.resume() accepts optional forEachIndex parameter"
    - "Resume with forEachIndex targets specific iteration without re-executing previous iterations"
    - "Resume without forEachIndex continues default behavior (resume all suspended)"
    - "forEachIndex is validated within valid range (0 to array length - 1)"
  artifacts:
    - path: "packages/core/src/workflows/evented/workflow.ts"
      provides: "forEachIndex parameter in resume() signature"
      contains: "forEachIndex?: number"
    - path: "packages/core/src/workflows/evented/workflow-event-processor/index.ts"
      provides: "forEachIndex in ProcessorArgs type"
      contains: "forEachIndex?: number"
    - path: "packages/core/src/workflows/evented/workflow-event-processor/loop.ts"
      provides: "forEachIndex-aware iteration skip logic"
      contains: "forEachIndex"
  key_links:
    - from: "evented/workflow.ts resume()"
      to: "executionEngine.execute()"
      via: "resume object with forEachIndex"
      pattern: "forEachIndex.*params\\.forEachIndex"
    - from: "workflow-event-processor/index.ts"
      to: "processWorkflowForEach()"
      via: "ProcessorArgs passing"
      pattern: "ProcessorArgs.*forEachIndex"
---

<objective>
Implement forEachIndex parameter support in evented runtime resume() to enable targeted foreach iteration resume.

Purpose: Complete v1.1 milestone by achieving foreach suspend/resume parity with default runtime. Users can resume specific foreach iterations by index rather than resuming all suspended iterations at once.

Output:
- forEachIndex parameter added to EventedRun.resume()
- ProcessorArgs extended with forEachIndex field
- processWorkflowForEach modified to skip non-targeted iterations
- 6 foreach suspend/resume tests unskipped and passing
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-foreach-index-resume/09-RESEARCH.md

# Reference implementation in default runtime
@packages/core/src/workflows/workflow.ts (lines 3088-3104 for forEachIndex in resume, 3445-3451 for passing to execute)
@packages/core/src/workflows/handlers/control-flow.ts (lines 859-873 for iteration skip logic)

# Files to modify
@packages/core/src/workflows/evented/workflow.ts (lines 1622-1790 for resume())
@packages/core/src/workflows/evented/workflow-event-processor/index.ts (lines 24-48 for ProcessorArgs)
@packages/core/src/workflows/evented/workflow-event-processor/loop.ts (lines 145-310 for processWorkflowForEach)

# Tests to unskip
@packages/core/src/workflows/evented/evented-workflow.test.ts (lines 18912-19519)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add forEachIndex parameter threading</name>
  <files>
    packages/core/src/workflows/evented/workflow.ts
    packages/core/src/workflows/evented/workflow-event-processor/index.ts
  </files>
  <action>
1. In `evented/workflow.ts` resume() method (around line 1622):
   - Add `forEachIndex?: number` to the params type definition
   - Pass forEachIndex through to executionEngine.execute() in the resume object (around line 1768)
   - Follow the exact pattern from default runtime workflow.ts line 3451:
     ```typescript
     resume: {
       steps,
       stepResults: snapshot?.context as any,
       resumePayload: resumeDataToUse,
       resumePath,
       forEachIndex: params.forEachIndex,  // Add this line
     },
     ```
   - Also check if label provides foreachIndex (like default runtime does):
     ```typescript
     forEachIndex: params.forEachIndex ?? snapshotResumeLabel?.foreachIndex,
     ```

2. In `workflow-event-processor/index.ts` ProcessorArgs type (around line 24):
   - Add `forEachIndex?: number` field to the ProcessorArgs type definition
   - This ensures the parameter can be passed through the event processor chain

Note: The evented runtime uses a different execution model than default runtime. The forEachIndex flows:
- EventedRun.resume() -> executionEngine.execute() -> pubsub events -> WorkflowEventProcessor -> processWorkflowForEach()

The ProcessorArgs type is used for event data, so adding forEachIndex there enables it to reach the foreach processor.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd packages/core && pnpm tsc --noEmit
```
  </verify>
  <done>
- forEachIndex parameter accepted in EventedRun.resume() method
- forEachIndex passed to executionEngine.execute() resume object
- ProcessorArgs type includes forEachIndex field
- TypeScript compilation passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement foreach iteration targeting and unskip tests</name>
  <files>
    packages/core/src/workflows/evented/workflow-event-processor/loop.ts
    packages/core/src/workflows/evented/evented-workflow.test.ts
  </files>
  <action>
1. In `loop.ts` processWorkflowForEach function (starting line 145):
   - Extract forEachIndex from the ProcessorArgs (it arrives via event data)
   - The evented runtime tracks iteration progress differently - it uses currentResult.output array with null placeholders
   - When forEachIndex is specified in a resume, the iteration at that index should be re-executed with resumeData while other completed/suspended iterations are skipped

   The key insight from default runtime (control-flow.ts lines 859-873):
   ```typescript
   // For each iteration, check if we should skip it
   if (
     prevItemResult?.status === 'success' ||
     (prevItemResult?.status === 'suspended' && resume?.forEachIndex !== k && resume?.forEachIndex !== undefined)
   ) {
     return prevItemResult;  // Skip this iteration
   }
   // Only provide resumeData to the targeted iteration
   if (resume?.forEachIndex !== undefined) {
     resumeToUse = resume.forEachIndex === k ? resume : undefined;
   }
   ```

   For evented runtime, modify the foreach processing to:
   a. When forEachIndex is provided in the resume context, only allow that specific index to process with resumeData
   b. Other iterations should retain their current status (completed stays completed, other suspended stays suspended)
   c. The iteration completion check should account for forEachIndex targeting

   Implementation approach for evented foreach:
   - The foreach in evented uses executionPath[1] as the current iteration index
   - When resuming with forEachIndex, check if current iteration index matches forEachIndex
   - If it doesn't match and iteration is already suspended/completed, skip re-processing
   - Only pass resumeData to the matching forEachIndex iteration

2. In `evented-workflow.test.ts`:
   - Remove `.skip` from the 6 foreach suspend/resume tests (lines 18925, 19024, 19117, 19219, 19326, 19417)
   - Remove the `as any` type assertions on forEachIndex parameters (e.g., line 19182)
   - The tests verify:
     a. Single item concurrency foreach suspend/resume (line 18925)
     b. All items concurrency foreach suspend/resume (line 19024)
     c. All items concurrency with forEachIndex targeting (line 19117)
     d. All items concurrency with label targeting (line 19219)
     e. Partial concurrency foreach suspend/resume (line 19326)
     f. Partial concurrency with forEachIndex targeting (line 19417)

Note: The first two tests (18925, 19024) test basic foreach suspend/resume WITHOUT forEachIndex. They should already work if the evented runtime's foreach suspend/resume is functional. If they fail, there may be an existing bug in foreach suspend/resume that needs addressing first.

The tests with forEachIndex (19117, 19417) are the key tests for this phase.
  </action>
  <verify>
Run the foreach suspend/resume tests:
```bash
cd packages/core && pnpm vitest run -t "foreach" --reporter=verbose 2>&1 | tail -50
```

All 6 previously-skipped tests should pass. Check test output for:
- "should suspend and resume when running a single item concurrency (default) for loop"
- "should suspend and resume when running all items concurrency for loop"
- "should suspend and resume provided index when running all items concurrency for loop"
- "should suspend and resume provided label when running all items concurrency for loop"
- "should suspend and resume when running a partial item concurrency for loop"
- "should suspend and resume provided index when running a partial item concurrency for loop"
  </verify>
  <done>
- processWorkflowForEach respects forEachIndex parameter
- Targeted iteration receives resumeData, others are skipped
- 6 foreach suspend/resume tests unskipped
- All 6 tests pass
- Total evented workflow tests: ~197 passing (was 195)
  </done>
</task>

</tasks>

<verification>
Run full evented workflow test suite to ensure no regressions:
```bash
cd packages/core && pnpm vitest run evented-workflow.test.ts --reporter=verbose 2>&1 | tail -30
```

Expected: 197+ tests passing, 26 or fewer skipped (was 32 skipped, now 6 unskipped)

Verify test counts match expectation:
```bash
cd packages/core && pnpm vitest run evented-workflow.test.ts 2>&1 | grep -E "(Tests|passed|failed|skipped)"
```
</verification>

<success_criteria>
Requirements coverage:
- FOREACH-01: forEachIndex parameter accepted in EventedRun.resume() - VERIFIED by TypeScript compilation and test usage
- FOREACH-02: forEachIndex targets specific iteration on resume - VERIFIED by tests 19117 and 19417 passing
- FOREACH-03: forEachIndex stored in __workflow_meta on suspend - VERIFIED by test assertions checking suspendPayload.__workflow_meta

Test metrics:
- 6 previously-skipped foreach tests now passing
- No regressions in existing 195 passing tests
- Total: 197+ passing, ~26 skipped
</success_criteria>

<output>
After completion, create `.planning/phases/09-foreach-index-resume/09-01-SUMMARY.md`
</output>
