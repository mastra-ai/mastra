---
phase: 08-writer-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/step-executor.ts
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Step context exposes writer property as ToolStream instance"
    - "Writer.write() emits custom chunks during step execution"
    - "Writer.custom() emits typed custom events with arbitrary payloads"
    - "Writer events stream to workflow consumers via pub/sub transport"
    - "Writer events maintain correct sequence ordering during step execution"
  artifacts:
    - path: "packages/core/src/workflows/evented/step-executor.ts"
      provides: "ToolStream instances in all 4 context-creating methods"
      contains: "new ToolStream"
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "Verified writer API functionality"
      contains: "it('should handle custom event emission using writer"
  key_links:
    - from: "packages/core/src/workflows/evented/step-executor.ts"
      to: "packages/core/src/tools/stream.ts"
      via: "ToolStream import and instantiation"
      pattern: "import.*ToolStream.*from.*tools/stream"
    - from: "step-executor.ts writer"
      to: "workflow.events.v2.{runId}"
      via: "OutputWriter callback publishes to pubsub"
      pattern: "workflow\\.events\\.v2\\."
---

<objective>
Implement Writer API in evented runtime step context

Purpose: Enable steps to emit custom events during execution via context.writer, achieving parity with default runtime writer functionality. This completes AGENT-05, AGENT-06, AGENT-07 requirements.
Output: Working writer API in StepExecutor that publishes events to pubsub, 2 writer tests passing
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-writer-api/08-RESEARCH.md

# Source files
@packages/core/src/tools/stream.ts
@packages/core/src/workflows/evented/step-executor.ts
@packages/core/src/workflows/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ToolStream writer in all StepExecutor methods</name>
  <files>packages/core/src/workflows/evented/step-executor.ts</files>
  <action>
Add ToolStream writer instances to all 4 context-creating methods in StepExecutor. Each TODO at lines 150, 340, 415, 490 needs replacement with a working ToolStream.

**Imports to add at top of file:**
```typescript
import { randomUUID } from 'node:crypto';
import { ToolStream } from '../../tools/stream';
```

**Pattern for each method (execute, evaluateCondition, resolveSleep, resolveSleepUntil):**

1. Generate unique callId: `const callId = randomUUID();`

2. Create OutputWriter callback that publishes to pubsub:
```typescript
const outputWriter = async (chunk: any) => {
  if (this.mastra?.pubsub) {
    await this.mastra.pubsub.publish(`workflow.events.v2.${runId}`, {
      type: 'watch',
      runId,
      data: chunk,
    });
  }
};
```

3. Create ToolStream instance with metadata:
```typescript
writer: new ToolStream(
  {
    prefix: 'workflow-step',
    callId,
    name: step.id,  // For execute/evaluate, use the step id
    runId,
  },
  outputWriter,
),
```

**Method-specific notes:**

- **execute()** (line 150): runId from params, step.id available, generate callId at start of method
- **evaluateCondition()** (line 340): runId from params, no step.id - use 'condition' as name, generate callId
- **resolveSleep()** (line 415): runId from params, step.id available via params.step.id, generate callId
- **resolveSleepUntil()** (line 490): runId from params, step.id available via params.step.id, generate callId

**What NOT to do:**
- Don't use `undefined as any` - that's what we're replacing
- Don't publish to the generic 'workflows' channel - must use `workflow.events.v2.${runId}`
- Don't skip any of the 4 methods - all need writer implementation
  </action>
  <verify>
Run `cd packages/core && pnpm typecheck` - no type errors related to writer parameter.
Verify by grep: `grep -n "writer: undefined" packages/core/src/workflows/evented/step-executor.ts` should return empty (no undefined writers left).
  </verify>
  <done>
All 4 `writer: undefined as any` TODOs replaced with ToolStream instances. Each method creates:
1. Unique callId via randomUUID()
2. OutputWriter callback publishing to `workflow.events.v2.${runId}`
3. ToolStream with prefix='workflow-step', callId, name, runId
  </done>
</task>

<task type="auto">
  <name>Task 2: Unskip and verify writer tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Unskip the 2 writer-related tests and verify they pass.

**Tests to unskip:**

1. Line 1851: `it.skip('should handle custom event emission using writer - evented runtime does not expose writer in step context'`
   - Change `it.skip` to `it`
   - This test uses `writer.write()` to emit custom events and verifies they appear in the stream

2. Line 1938: `it.skip('should handle writer.custom during resume operations - evented runtime does not expose writer in step context'`
   - Change `it.skip` to `it`
   - This test uses `writer.custom()` to emit typed events during suspend/resume

**Run tests to verify:**
```bash
cd packages/core && pnpm test -- --testNamePattern="should handle custom event emission using writer|should handle writer.custom during resume" --run
```

**If tests fail, check:**
1. Events are being published to correct channel (`workflow.events.v2.${runId}`)
2. ToolStream is receiving the OutputWriter callback
3. Pubsub is available (this.mastra?.pubsub check passes)

**What NOT to do:**
- Don't modify test assertions - the tests define expected behavior
- Don't add new tests - just unskip existing ones
  </action>
  <verify>
Run: `cd packages/core && pnpm test -- --testNamePattern="should handle custom event emission using writer|should handle writer.custom during resume" --run`
Both tests should pass.
  </verify>
  <done>
2 writer tests unskipped and passing. Tests verify:
1. writer.write() emits events visible in fullStream
2. writer.custom() emits typed events during suspend/resume operations
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Type check passes:**
   ```bash
   cd packages/core && pnpm typecheck
   ```

2. **No undefined writers remain:**
   ```bash
   grep -n "writer: undefined" packages/core/src/workflows/evented/step-executor.ts
   ```
   Should return empty.

3. **Writer tests pass:**
   ```bash
   cd packages/core && pnpm test -- --testNamePattern="should handle custom event emission using writer|should handle writer.custom during resume" --run
   ```
   Both tests should pass.

4. **No regressions in evented workflow tests:**
   ```bash
   cd packages/core && pnpm test -- --testPathPattern="evented-workflow.test" --run
   ```
   All previously passing tests still pass.
</verification>

<success_criteria>
- [ ] ToolStream import added to step-executor.ts
- [ ] randomUUID import added to step-executor.ts
- [ ] execute() method has working writer (replaces line 150 TODO)
- [ ] evaluateCondition() method has working writer (replaces line 340 TODO)
- [ ] resolveSleep() method has working writer (replaces line 415 TODO)
- [ ] resolveSleepUntil() method has working writer (replaces line 490 TODO)
- [ ] Test "should handle custom event emission using writer" passes
- [ ] Test "should handle writer.custom during resume operations" passes
- [ ] No type errors in step-executor.ts
- [ ] No regressions in existing evented workflow tests
</success_criteria>

<output>
After completion, create `.planning/phases/08-writer-api/08-01-SUMMARY.md`
</output>
