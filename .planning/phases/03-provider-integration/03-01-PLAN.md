---
phase: 03-provider-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - auth/cloud/package.json
  - auth/cloud/src/client.ts
  - auth/cloud/src/index.ts
autonomous: true

must_haves:
  truths:
    - "CloudUser type includes required sessionToken field"
    - "handleCallback() decodes JWT locally and returns user with sessionToken"
    - "getPermissions() extracts role from JWT and resolves via resolvePermissions()"
    - "createSession() throws CloudApiError with 501 status"
    - "TypeScript compiles without errors"
  artifacts:
    - path: "auth/cloud/package.json"
      provides: "jose dependency"
      contains: '"jose"'
    - path: "auth/cloud/src/client.ts"
      provides: "CloudUser with sessionToken"
      contains: "sessionToken: string"
    - path: "auth/cloud/src/index.ts"
      provides: "JWT-based provider methods"
      exports: ["MastraCloudAuth"]
  key_links:
    - from: "auth/cloud/src/index.ts"
      to: "jose.decodeJwt"
      via: "import"
      pattern: "import.*decodeJwt.*from 'jose'"
    - from: "auth/cloud/src/index.ts"
      to: "@mastra/core/ee/defaults/roles"
      via: "import"
      pattern: "import.*resolvePermissions.*from '@mastra/core"
---

<objective>
Wire MastraCloudAuth provider to use local JWT decoding for sessionToken flow.

Purpose: Eliminate API calls for permissions â€” decode JWT locally, resolve roles via core
Output: Updated provider with handleCallback, getPermissions, createSession methods using JWT
</objective>

<execution_context>
@/Users/yj/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-provider-integration/03-CONTEXT.md
@.planning/phases/03-provider-integration/03-RESEARCH.md
@auth/cloud/src/client.ts
@auth/cloud/src/index.ts
@packages/core/src/ee/defaults/roles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add jose dependency and update CloudUser type</name>
  <files>
    auth/cloud/package.json
    auth/cloud/src/client.ts
  </files>
  <action>
1. Add `jose` to dependencies in package.json:
   ```json
   "dependencies": {
     "jose": "^5.9.6"
   }
   ```

2. Update CloudUser interface in client.ts:
   - Add REQUIRED `sessionToken: string` field
   - Remove `roles: string[]` field (role comes from JWT now)
   - Keep: id, email, name?, avatarUrl?, createdAt, metadata?

3. Add JWTClaims interface in client.ts (for type safety):
   ```typescript
   interface JWTClaims {
     sub: string;           // user id
     email: string;
     role: string;          // "owner", "admin", "member", "viewer"
     name?: string;
     avatar?: string;
     exp: number;
     iat: number;
   }
   ```

4. Update parseUser() in client.ts:
   - Accept optional jwt parameter
   - When jwt provided, store it as sessionToken
   - When no jwt, use empty string for sessionToken (legacy API responses)

5. Run `pnpm install` in auth/cloud to install jose
  </action>
  <verify>
    - `grep -q '"jose"' auth/cloud/package.json` returns 0
    - `grep -q 'sessionToken: string' auth/cloud/src/client.ts` returns 0
    - `pnpm typecheck --filter @mastra/auth-cloud` passes (or shows only index.ts errors)
  </verify>
  <done>
    - jose is in dependencies
    - CloudUser has required sessionToken field
    - JWTClaims interface exists
    - parseUser() handles sessionToken
  </done>
</task>

<task type="auto">
  <name>Task 2: Update provider methods for JWT-based flow</name>
  <files>
    auth/cloud/src/index.ts
  </files>
  <action>
1. Add imports at top of index.ts:
   ```typescript
   import { decodeJwt } from 'jose';
   import { resolvePermissions, DEFAULT_ROLES } from '@mastra/core/ee/defaults/roles';
   ```

2. Update handleCallback():
   - Call client.exchangeCode() to get JWT (assume it returns { jwt: string })
   - Decode JWT locally with decodeJwt()
   - Construct CloudUser from claims:
     ```typescript
     const claims = decodeJwt(jwt);
     const user: CloudUser = {
       id: claims.sub as string,
       email: claims.email as string,
       sessionToken: jwt,
       name: claims.name as string | undefined,
       avatarUrl: claims.avatar as string | undefined,
       createdAt: new Date(),  // JWT doesn't have this, use now
     };
     ```
   - Return SSOCallbackResult with user and tokens

3. Update getPermissions(user: CloudUser):
   - Remove token parameter (token is on user.sessionToken)
   - Decode JWT from user.sessionToken
   - Extract role claim
   - If no role, log warning and return []
   - Call resolvePermissions([role], DEFAULT_ROLES)
   - Wrap in try/catch, throw CloudApiError on decode failure

4. Update createSession():
   - Throw CloudApiError with 501 status:
     ```typescript
     throw new CloudApiError(
       'MastraCloudAuth does not support createSession(). Use SSO flow via handleCallback() instead.',
       501,
       'not_implemented'
     );
     ```

5. Update hasPermission, hasAllPermissions, hasAnyPermission:
   - Remove token parameter from calls to getPermissions()
   - Just pass user directly

6. Update getCurrentUser() if needed:
   - Ensure it constructs CloudUser with sessionToken from cookie

7. Update client.exchangeCode() call:
   - Check if client needs update to return JWT
   - If client returns { user, session }, may need to add jwt field
   - Or decode the session.id as JWT if that's the token
  </action>
  <verify>
    - `pnpm typecheck --filter @mastra/auth-cloud` passes
    - `grep -q "decodeJwt" auth/cloud/src/index.ts` returns 0
    - `grep -q "resolvePermissions" auth/cloud/src/index.ts` returns 0
    - `grep -q "501" auth/cloud/src/index.ts` returns 0
  </verify>
  <done>
    - handleCallback() decodes JWT locally
    - getPermissions() uses resolvePermissions from core
    - createSession() throws 501 CloudApiError
    - All permission methods work without token parameter
    - TypeScript compiles
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm typecheck --filter @mastra/auth-cloud`
2. Dependency check: `cat auth/cloud/package.json | grep jose`
3. Pattern verification:
   - `grep "sessionToken: string" auth/cloud/src/client.ts`
   - `grep "decodeJwt" auth/cloud/src/index.ts`
   - `grep "resolvePermissions" auth/cloud/src/index.ts`
   - `grep "501" auth/cloud/src/index.ts`
</verification>

<success_criteria>
- jose dependency added to package.json
- CloudUser.sessionToken is required string
- handleCallback() decodes JWT, returns CloudUser with sessionToken
- getPermissions() decodes JWT, calls resolvePermissions()
- createSession() throws CloudApiError(501)
- `pnpm typecheck --filter @mastra/auth-cloud` passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-provider-integration/03-01-SUMMARY.md`
</output>
