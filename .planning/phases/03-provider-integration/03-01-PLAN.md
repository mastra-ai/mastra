---
phase: 03-provider-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - auth/cloud/package.json
  - auth/cloud/src/client.ts
  - auth/cloud/src/index.ts
autonomous: true

must_haves:
  truths:
    - "CloudUser type includes required sessionToken field"
    - "handleCallback() decodes JWT locally and returns user with sessionToken"
    - "getPermissions() extracts role from JWT and resolves via resolvePermissions()"
    - "getCurrentUser() passes sessionToken from cookie to client.getUser()"
    - "createSession() throws CloudApiError with 501 status"
    - "TypeScript compiles without errors"
  artifacts:
    - path: "auth/cloud/package.json"
      provides: "jose dependency"
      contains: '"jose"'
    - path: "auth/cloud/src/client.ts"
      provides: "CloudUser with sessionToken, exchangeCode returns jwt"
      contains: "sessionToken: string"
    - path: "auth/cloud/src/index.ts"
      provides: "JWT-based provider methods"
      exports: ["MastraCloudAuth"]
  key_links:
    - from: "auth/cloud/src/index.ts"
      to: "jose.decodeJwt"
      via: "import"
      pattern: "import.*decodeJwt.*from 'jose'"
    - from: "auth/cloud/src/index.ts"
      to: "@mastra/core/ee/defaults/roles"
      via: "import"
      pattern: "import.*resolvePermissions.*from '@mastra/core"
    - from: "auth/cloud/src/index.ts:getCurrentUser"
      to: "auth/cloud/src/client.ts:getUser"
      via: "passes sessionToken as token param"
      pattern: "client\\.getUser\\(.*token:.*sessionToken"
    - from: "auth/cloud/src/client.ts:exchangeCode"
      to: "handleCallback"
      via: "returns jwt field for sessionToken"
      pattern: "jwt:\\s*\\w+"
---

<objective>
Wire MastraCloudAuth provider to use local JWT decoding for sessionToken flow.

Purpose: Eliminate API calls for permissions — decode JWT locally, resolve roles via core
Output: Updated provider with handleCallback, getPermissions, createSession, getCurrentUser methods using JWT
</objective>

<execution_context>
@/Users/yj/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-provider-integration/03-CONTEXT.md
@.planning/phases/03-provider-integration/03-RESEARCH.md
@auth/cloud/src/client.ts
@auth/cloud/src/index.ts
@packages/core/src/ee/defaults/roles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add jose dependency, update CloudUser type, update exchangeCode to return JWT</name>
  <files>
    auth/cloud/package.json
    auth/cloud/src/client.ts
  </files>
  <action>
1. Add `jose` to dependencies in package.json:
   ```json
   "dependencies": {
     "jose": "^5.9.6"
   }
   ```

2. Update CloudUser interface in client.ts:
   - Add REQUIRED `sessionToken: string` field (per 03-CONTEXT.md: sessionToken is required, not optional)
   - Remove `roles: string[]` field (role comes from JWT now)
   - Keep: id, email, name?, avatarUrl?, createdAt, metadata?

3. Add JWTClaims interface in client.ts (for type safety):
   ```typescript
   interface JWTClaims {
     sub: string;           // user id
     email: string;
     role: string;          // "owner", "admin", "member", "viewer"
     name?: string;
     avatar?: string;
     exp: number;
     iat: number;
   }
   ```

4. Update exchangeCode() return type and implementation:
   - Change return type to `Promise<{ user: CloudUser; session: CloudSession; jwt: string }>`
   - Cloud API callback endpoint returns JWT in response (per CONTEXT.md: "Cloud returns JWT only after OAuth")
   - Extract jwt from response: `data.jwt` or `data.token` (Cloud sends JWT as top-level field)
   - Pass jwt to parseUser so sessionToken gets populated
   - Return { user, session, jwt }

5. Update parseUser() signature and implementation:
   - Change signature to: `parseUser(data: Record<string, unknown>, jwt?: string): CloudUser`
   - When jwt provided, use it as sessionToken
   - When no jwt, use empty string for sessionToken (legacy API responses)
   - Remove roles from return (no longer part of CloudUser)

6. Run `pnpm install` in auth/cloud to install jose
  </action>
  <verify>
    - `grep -q '"jose"' auth/cloud/package.json` returns 0
    - `grep -q 'sessionToken: string' auth/cloud/src/client.ts` returns 0
    - `grep -q 'jwt: string' auth/cloud/src/client.ts` returns 0 (in exchangeCode return type)
    - `pnpm typecheck --filter @mastra/auth-cloud` passes (or shows only index.ts errors expected to be fixed in Task 2)
  </verify>
  <done>
    - jose is in dependencies
    - CloudUser has required sessionToken field (not optional)
    - CloudUser does NOT have roles field
    - JWTClaims interface exists
    - exchangeCode() returns { user, session, jwt }
    - parseUser() accepts optional jwt param and populates sessionToken
  </done>
</task>

<task type="auto">
  <name>Task 2: Update provider methods for JWT-based flow</name>
  <files>
    auth/cloud/src/index.ts
  </files>
  <action>
1. Add imports at top of index.ts:
   ```typescript
   import { decodeJwt } from 'jose';
   import { resolvePermissions, DEFAULT_ROLES } from '@mastra/core/ee/defaults/roles';
   ```

2. Update handleCallback():
   - Call client.exchangeCode() — now returns { user, session, jwt }
   - Decode JWT locally with decodeJwt(jwt) to validate structure
   - User already has sessionToken populated from Task 1's parseUser changes
   - Return SSOCallbackResult with user and tokens:
     ```typescript
     const { user, session, jwt } = await this.client.exchangeCode({ code });
     // Validate JWT is decodable (throws if malformed)
     decodeJwt(jwt);
     return {
       user,
       tokens: {
         accessToken: jwt,
         expiresAt: session.expiresAt,
       },
     };
     ```

3. Update getPermissions(user: CloudUser):
   - Remove token parameter (token is on user.sessionToken)
   - Decode JWT from user.sessionToken using decodeJwt()
   - Extract role claim: `const claims = decodeJwt(user.sessionToken); const role = claims.role as string;`
   - If no role claim, log warning and return empty array []
   - Call resolvePermissions([role], DEFAULT_ROLES) to get permission strings
   - Wrap in try/catch, throw CloudApiError on decode failure:
     ```typescript
     try {
       const claims = decodeJwt(user.sessionToken);
       const role = claims.role as string;
       if (!role) {
         console.warn('MastraCloudAuth: JWT missing role claim');
         return [];
       }
       return resolvePermissions([role], DEFAULT_ROLES);
     } catch (error) {
       throw new CloudApiError(
         `Failed to decode session token: ${error instanceof Error ? error.message : 'unknown error'}`,
         401,
         'invalid_token'
       );
     }
     ```

4. Update createSession():
   - Throw CloudApiError with 501 status (not generic Error):
     ```typescript
     throw new CloudApiError(
       'MastraCloudAuth does not support createSession(). Use SSO flow via handleCallback() instead.',
       501,
       'not_implemented'
     );
     ```
   - Add import for CloudApiError from './client' if not already imported

5. Update hasPermission, hasAllPermissions, hasAnyPermission:
   - Remove token parameter from calls to getPermissions()
   - Just pass user directly: `const permissions = await this.getPermissions(user);`

6. Update getCurrentUser(request: Request):
   - Extract sessionToken from cookie (already done via extractSessionToken)
   - Validate session still valid via client.validateSession()
   - Call client.getUser() passing the sessionToken as the token param:
     ```typescript
     async getCurrentUser(request: Request): Promise<CloudUser | null> {
       const sessionToken = this.extractSessionToken(request);
       if (!sessionToken) return null;

       const session = await this.client.validateSession({ sessionToken });
       if (!session) return null;

       // Pass sessionToken to getUser - it's the JWT that authenticates the request
       return this.client.getUser({ userId: session.userId, token: sessionToken });
     }
     ```
   - This is the key fix: sessionToken IS the token that authenticates the getUser request

7. Update getRoles(user: CloudUser):
   - Decode JWT from user.sessionToken
   - Return [claims.role] as single-element array (or empty if no role)

8. Update hasRole(user: CloudUser, role: string):
   - Decode JWT and compare claims.role === role
  </action>
  <verify>
    - `pnpm typecheck --filter @mastra/auth-cloud` passes
    - `grep -q "decodeJwt" auth/cloud/src/index.ts` returns 0
    - `grep -q "resolvePermissions" auth/cloud/src/index.ts` returns 0
    - `grep -q "501" auth/cloud/src/index.ts` returns 0
    - `grep "getCurrentUser" -A 10 auth/cloud/src/index.ts | grep -q "token: sessionToken"` returns 0
  </verify>
  <done>
    - handleCallback() uses jwt from exchangeCode(), validates with decodeJwt()
    - getPermissions() decodes JWT from user.sessionToken, calls resolvePermissions()
    - createSession() throws CloudApiError(501)
    - hasPermission/hasAllPermissions/hasAnyPermission call getPermissions(user) without token param
    - getCurrentUser() passes sessionToken to client.getUser() as token param
    - getRoles() and hasRole() decode JWT to get role
    - TypeScript compiles
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm typecheck --filter @mastra/auth-cloud`
2. Dependency check: `cat auth/cloud/package.json | grep jose`
3. Pattern verification:
   - `grep "sessionToken: string" auth/cloud/src/client.ts`
   - `grep "jwt: string" auth/cloud/src/client.ts`
   - `grep "decodeJwt" auth/cloud/src/index.ts`
   - `grep "resolvePermissions" auth/cloud/src/index.ts`
   - `grep "501" auth/cloud/src/index.ts`
   - `grep "token: sessionToken" auth/cloud/src/index.ts`
</verification>

<success_criteria>
- jose dependency added to package.json
- CloudUser.sessionToken is required string (not optional)
- CloudUser does NOT have roles field
- exchangeCode() returns { user, session, jwt }
- handleCallback() uses jwt from exchangeCode, returns CloudUser with sessionToken
- getPermissions() decodes JWT from user.sessionToken, calls resolvePermissions()
- getCurrentUser() passes sessionToken to client.getUser() as token param
- createSession() throws CloudApiError(501)
- `pnpm typecheck --filter @mastra/auth-cloud` passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-provider-integration/03-01-SUMMARY.md`
</output>
