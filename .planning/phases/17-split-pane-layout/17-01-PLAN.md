---
phase: 17-split-pane-layout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/playground-ui/src/domains/agents/components/agent-layout.tsx
  - packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
  - packages/playground-ui/src/lib/ai-ui/thread.tsx
  - packages/playground/src/pages/agents/agent/index.tsx
autonomous: true

must_haves:
  truths:
    - "Browser panel renders as a collapsible side-by-side panel to the right of chat, not as a floating overlay"
    - "When no browser session is active, chat occupies the full width with no visible browser panel or separator"
    - "User can drag the separator handle between chat and browser panel to resize"
    - "BrowserViewFrame never unmounts during the panel's lifetime (WebSocket connection preserved)"
  artifacts:
    - path: "packages/playground-ui/src/domains/agents/components/agent-layout.tsx"
      provides: "AgentLayout with browserSlot prop and 4th collapsible panel"
      contains: "browserSlot"
    - path: "packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx"
      provides: "BrowserViewPanel adapted for flex layout (no absolute positioning)"
    - path: "packages/playground-ui/src/lib/ai-ui/thread.tsx"
      provides: "Thread without BrowserViewPanel rendering"
    - path: "packages/playground/src/pages/agents/agent/index.tsx"
      provides: "Agent page passing BrowserViewPanel as browserSlot to AgentLayout"
  key_links:
    - from: "packages/playground/src/pages/agents/agent/index.tsx"
      to: "AgentLayout browserSlot prop"
      via: "BrowserViewPanel passed as browserSlot={<BrowserViewPanel agentId={agentId!} />}"
      pattern: "browserSlot=.*BrowserViewPanel"
    - from: "packages/playground-ui/src/domains/agents/components/agent-layout.tsx"
      to: "react-resizable-panels Panel"
      via: "Collapsible browser panel with collapsedSize={0}"
      pattern: "collapsedSize.*0"
    - from: "agent-layout.tsx browser panel"
      to: "BrowserViewPanel"
      via: "browserSlot renders inside Panel with collapsedSize={0}"
      pattern: "id=\"browser-slot\""
---

<objective>
Add a `browserSlot` prop to AgentLayout that renders a 4th collapsible panel (collapsedSize=0) between the main content and right sidebar. Extract BrowserViewPanel from Thread into this new slot. Adapt BrowserViewPanel's positioning from absolute overlay to flex layout.

Purpose: This is the structural migration that moves the browser view from a floating overlay inside the chat viewport to a proper side-by-side resizable panel in the layout grid. The collapsedSize=0 approach keeps BrowserViewFrame mounted (preserving WebSocket) while making it visually hidden when collapsed.

Output: AgentLayout with 4-panel structure, BrowserViewPanel in the browser slot, Thread simplified without browser rendering.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-context-infrastructure/16-01-SUMMARY.md

Key source files:
@packages/playground-ui/src/domains/agents/components/agent-layout.tsx
@packages/playground-ui/src/lib/resize/collapsible-panel.tsx
@packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
@packages/playground-ui/src/lib/ai-ui/thread.tsx
@packages/playground/src/pages/agents/agent/index.tsx
@packages/playground-ui/src/domains/agents/context/browser-session-context.tsx
@packages/playground-ui/src/lib/resize/separator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add browserSlot to AgentLayout with collapsible panel</name>
  <files>
    packages/playground-ui/src/domains/agents/components/agent-layout.tsx
  </files>
  <action>
Modify AgentLayout to accept a new `browserSlot?: React.ReactNode` prop in AgentLayoutProps.

Add a 4th panel between the main-slot Panel and the rightSlot section. This browser panel:

1. **Always renders** when browserSlot is provided (not conditionally based on isActive). The panel uses `collapsedSize={0}` + `collapsible={true}` so children stay mounted even when panel is collapsed to zero width. This preserves the BrowserViewFrame WebSocket connection.

2. Uses a raw `Panel` from react-resizable-panels (NOT the existing `CollapsiblePanel` component, because that component conditionally renders children vs a button when collapsed -- we need children to ALWAYS render to keep WebSocket alive).

3. Panel configuration:
   - `id="browser-slot"`
   - `collapsible={true}`
   - `collapsedSize={0}` (in pixels via the library's pixel-based API)
   - `defaultSize={0}` (starts collapsed -- Plan 17-02 adds auto-expand logic)
   - `minSize={300}` (when expanded, never narrower than 300px)
   - `maxSize="50%"` (never wider than half the layout)
   - `className="overflow-hidden"` (hides content at zero width)

4. Use `usePanelRef()` to create a `browserPanelRef` and attach it via `panelRef={browserPanelRef}`. Export this ref via a new React context OR pass it via a callback prop. The simplest approach: add an `onBrowserPanelRef?: (ref: PanelImperativeHandle) => void` callback prop to AgentLayoutProps. However, since Phase 17-02 needs the ref from BrowserSessionContext, the cleaner approach is:
   - Import `useBrowserSession` from the browser session context
   - The AgentLayout is already a descendant of BrowserSessionProvider (confirmed in Phase 16)
   - We will NOT use the context for the ref in this plan. Instead, just create the panel with `usePanelRef()` and store the ref locally. Plan 17-02 will wire the expand/collapse logic.

5. Add a `PanelSeparator` between main-slot and browser-slot. This separator only renders when browserSlot is provided.

6. Change the `useDefaultLayout` id from `agent-layout-${agentId}` to `agent-layout-v2-${agentId}` to avoid storage key collision with old 3-panel layout sizes.

The resulting panel order is: [leftSlot?] [separator?] [main-slot] [separator?] [browser-slot?] [separator?] [right-slot?]

Note: `PanelImperativeHandle` is already imported but unused in agent-layout.tsx (added during Phase 16 anticipating this work). Keep it -- it will be used by the panelRef.
  </action>
  <verify>
Run `cd /Users/abhiramaiyer/.superset/worktrees/mastra/ab-tools && pnpm build:cli` and confirm zero type errors. Open the agent page in a browser -- the layout should look identical to before (browser panel starts at 0 width, invisible).
  </verify>
  <done>
AgentLayout accepts browserSlot prop, renders a 4th collapsible panel with collapsedSize=0 between main and right slots, PanelSeparator added, layout storage key updated to v2. Build passes with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract BrowserViewPanel from Thread, adapt positioning, wire into Agent page</name>
  <files>
    packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
    packages/playground-ui/src/lib/ai-ui/thread.tsx
    packages/playground/src/pages/agents/agent/index.tsx
  </files>
  <action>
Three coordinated changes:

**A) Thread (thread.tsx) -- Remove BrowserViewPanel rendering:**
- Remove the import of `BrowserViewPanel` from `@/domains/agents/components/browser-view`
- Remove the `{agentId && <BrowserViewPanel agentId={agentId} />}` line and its wrapping comment
- Remove the outer `<div className="relative h-full overflow-hidden">` wrapper that was added to contain the absolute-positioned panel. The ThreadPrimitive.Viewport becomes the direct child of ThreadWrapper's grid row.
- Keep everything else (Viewport, messages, Composer) unchanged.

**B) BrowserViewPanel (browser-view-panel.tsx) -- Adapt from overlay to flex layout:**
- Remove the absolute/fixed positioning logic from the outer div. Currently it toggles between:
  - `'absolute top-4 left-0 z-10 max-w-3xl w-full px-4'` (when active)
  - `'fixed -left-[9999px] -top-[9999px] w-0 h-0 overflow-hidden'` (when inactive)
- Replace with a simple flex container that fills its parent panel:
  - Outer div: `className="flex flex-col h-full w-full overflow-hidden"` (always the same classes, no conditional)
  - Remove the `aria-hidden` attribute (the panel's collapsedSize=0 handles visibility)
- The inner content div keeps its existing styles: `flex flex-col bg-surface2 rounded-lg border border-border1 overflow-hidden`
- BUT change it to `className="flex flex-col bg-surface2 h-full overflow-hidden"` -- remove rounded-lg and border since the panel itself is the container now.
- The frame wrapper div: change from `isActive && !isCollapsed ? 'p-2' : 'hidden'` to just `className="flex-1 min-h-0 p-2"` -- the panel's collapsedSize=0 handles hiding, not CSS display:none. Using `flex-1 min-h-0` lets the frame fill available vertical space.
- BrowserToolCallHistory: always render (remove the `isActive && !isCollapsed &&` conditional). It will be naturally hidden when panel is at 0 width.
- BrowserViewHeader: always render (remove the `isActive &&` conditional). Always show the header so the user sees the URL bar and close button whenever the panel is open.
- Keep `isClosing` and `isCollapsed` local state for now (isCollapsed will be repurposed in Plan 17-02 but keep it here for header collapse toggle).

**C) Agent page (index.tsx) -- Pass BrowserViewPanel as browserSlot:**
- Import `BrowserViewPanel` from `@mastra/playground-ui` (it's already exported via the barrel chain: browser-view/index.ts -> agents/index.tsx -> playground-ui/src/index.ts)
- Add `browserSlot={<BrowserViewPanel agentId={agentId!} />}` prop to the `<AgentLayout>` component
- The BrowserViewPanel is inside both BrowserToolCallsProvider and BrowserSessionProvider (Agent page wraps everything in these), so context access is maintained.
  </action>
  <verify>
Run `cd /Users/abhiramaiyer/.superset/worktrees/mastra/ab-tools && pnpm build:cli` and confirm zero type errors. The BrowserViewPanel is now rendered inside the collapsible layout panel instead of inside Thread. Since the panel starts collapsed (defaultSize=0), visual behavior is unchanged -- no browser panel visible until expand logic is added in Plan 17-02.
  </verify>
  <done>
BrowserViewPanel removed from Thread, adapted to flex layout positioning, and passed as browserSlot to AgentLayout from Agent page. Thread is simplified (no browser rendering). Build passes with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build:cli` passes with zero TypeScript errors in both playground-ui and playground packages
2. Thread component no longer imports or renders BrowserViewPanel
3. AgentLayout has a 4th panel with id="browser-slot" using collapsedSize={0}
4. BrowserViewPanel no longer uses absolute/fixed positioning
5. Agent page passes BrowserViewPanel as browserSlot to AgentLayout
6. Layout storage key is `agent-layout-v2-${agentId}`
</verification>

<success_criteria>
- AgentLayout renders browser panel as a collapsible side-by-side pane (currently collapsed at 0 width)
- BrowserViewPanel lives in the layout panel, not inside Thread
- All builds pass cleanly
- No visual regression (panel starts collapsed, so layout looks the same as before)
</success_criteria>

<output>
After completion, create `.planning/phases/17-split-pane-layout/17-01-SUMMARY.md`
</output>
