---
phase: 02-core-actions
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - integrations/agent-browser/src/tools/scroll.ts
  - integrations/agent-browser/src/types.ts
  - integrations/agent-browser/src/toolset.ts
  - integrations/agent-browser/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent can scroll the page viewport in any direction"
    - "All four tools (snapshot, click, type, scroll) are registered in BrowserToolset"
    - "Package builds successfully with all tools exported"
  artifacts:
    - path: "integrations/agent-browser/src/tools/scroll.ts"
      provides: "Scroll tool implementation"
      exports: ["createScrollTool"]
    - path: "integrations/agent-browser/src/toolset.ts"
      provides: "Updated BrowserToolset with all tools"
      contains: "browser_snapshot"
  key_links:
    - from: "integrations/agent-browser/src/toolset.ts"
      to: "all tool factory functions"
      via: "createTool imports and registration"
      pattern: "create(Snapshot|Click|Type|Scroll)Tool"
    - from: "integrations/agent-browser/src/index.ts"
      to: "types.ts exports"
      via: "re-export"
      pattern: "export .* from './types"
---

<objective>
Create scroll tool and wire all Phase 2 tools into the BrowserToolset.

Purpose: Complete the core actions phase by adding scroll capability and registering all tools (snapshot, click, type, scroll) in the toolset for agent use.

Output: scroll.ts with working scroll tool; updated toolset.ts with all four new tools registered; updated types.ts with new Zod schemas; updated index.ts with new exports.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-actions/02-CONTEXT.md
@.planning/phases/02-core-actions/02-RESEARCH.md
@integrations/agent-browser/src/toolset.ts
@integrations/agent-browser/src/types.ts
@integrations/agent-browser/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scroll tool</name>
  <files>integrations/agent-browser/src/tools/scroll.ts</files>
  <action>
Create scroll.ts implementing the browser_scroll tool per REQ-06:

1. Imports:
   - createTool from @mastra/core/tools
   - z from zod
   - BrowserManager type from agent-browser/dist/browser.js
   - createError from ../errors.js

2. Define input schema:
   - direction: z.enum(['up', 'down', 'left', 'right']).describe('Scroll direction')
   - amount: z.union([z.enum(['page', 'half']), z.number().describe('Pixels to scroll')]).optional().default('page')
   - ref: z.string().optional().describe('Element ref to scroll within (omit for viewport scroll)')

3. Define output schema:
   - success: z.boolean()
   - position: z.object({ x: z.number(), y: z.number() }).describe('New scroll position')

4. Create createScrollTool factory:
   - Takes getBrowser: () => Promise<BrowserManager>
   - Returns createTool with id 'browser_scroll'
   - Description: 'Scroll the page viewport or an element in a direction.'

5. Execute implementation:
   - Get browser, page, viewport size
   - Calculate pixels:
     - If typeof amount === 'number': pixels = amount
     - If amount === 'half': pixels = Math.floor(viewport.height / 2)
     - Else (page): pixels = viewport.height
   - Calculate deltaX, deltaY based on direction:
     - up: deltaY = -pixels
     - down: deltaY = pixels
     - left: deltaX = -pixels
     - right: deltaX = pixels
   - If ref provided:
     - Get locator, scroll element: locator.evaluate((el, { dx, dy }) => el.scrollBy(dx, dy), { dx: deltaX, dy: deltaY })
   - Else:
     - Scroll viewport: page.evaluate(`window.scrollBy(${deltaX}, ${deltaY})`)
   - Get new position: page.evaluate(() => ({ x: window.scrollX, y: window.scrollY }))
   - Return { success: true, position }

6. Error handling:
   - If ref provided but locator not found: createError('stale_ref', ...)
   - Default errors: createError('browser_error', ...)

7. Export createScrollTool function.
  </action>
  <verify>
Run: `cd integrations/agent-browser && pnpm tsc --noEmit`
TypeScript compiles without errors.
  </verify>
  <done>scroll.ts exports createScrollTool that scrolls viewport or element by direction and amount, returns new position.</done>
</task>

<task type="auto">
  <name>Task 2: Update types with new schemas</name>
  <files>integrations/agent-browser/src/types.ts</files>
  <action>
Update types.ts to add Zod schemas and TypeScript types for new tools:

1. Add after existing navigateOutputSchema:

```typescript
// Snapshot tool schemas
export const snapshotInputSchema = z.object({
  interactiveOnly: z.boolean().optional().default(true)
    .describe('Only show interactive elements (buttons, links, inputs)'),
  maxElements: z.number().optional().default(50)
    .describe('Maximum elements to return'),
});

export const snapshotOutputSchema = z.object({
  tree: z.string().describe('Formatted accessibility tree with refs'),
  elementCount: z.number(),
  truncated: z.boolean(),
});

export type SnapshotInput = z.infer<typeof snapshotInputSchema>;
export type SnapshotOutput = z.infer<typeof snapshotOutputSchema>;

// Click tool schemas
export const clickInputSchema = z.object({
  ref: z.string().describe('Element ref from snapshot (e.g., @e5)'),
  button: z.enum(['left', 'right', 'middle']).optional().default('left'),
});

export const clickOutputSchema = z.object({
  success: z.boolean(),
});

export type ClickInput = z.infer<typeof clickInputSchema>;
export type ClickOutput = z.infer<typeof clickOutputSchema>;

// Type tool schemas
export const typeInputSchema = z.object({
  ref: z.string().describe('Element ref from snapshot (e.g., @e3)'),
  text: z.string().describe('Text to type'),
  clearFirst: z.boolean().optional().default(false)
    .describe('Clear existing content before typing'),
});

export const typeOutputSchema = z.object({
  success: z.boolean(),
  value: z.string().optional().describe('Current field value after typing'),
});

export type TypeInput = z.infer<typeof typeInputSchema>;
export type TypeOutput = z.infer<typeof typeOutputSchema>;

// Scroll tool schemas
export const scrollInputSchema = z.object({
  direction: z.enum(['up', 'down', 'left', 'right']).describe('Scroll direction'),
  amount: z.union([
    z.enum(['page', 'half']),
    z.number().describe('Pixels to scroll'),
  ]).optional().default('page'),
  ref: z.string().optional().describe('Element ref to scroll within (omit for viewport)'),
});

export const scrollOutputSchema = z.object({
  success: z.boolean(),
  position: z.object({
    x: z.number(),
    y: z.number(),
  }).describe('New scroll position'),
});

export type ScrollInput = z.infer<typeof scrollInputSchema>;
export type ScrollOutput = z.infer<typeof scrollOutputSchema>;
```

2. Keep existing BrowserToolsetConfig, navigateInputSchema, navigateOutputSchema, BrowserError.
  </action>
  <verify>
Run: `cd integrations/agent-browser && pnpm tsc --noEmit`
TypeScript compiles without errors.
  </verify>
  <done>types.ts exports all input/output schemas and types for snapshot, click, type, and scroll tools.</done>
</task>

<task type="auto">
  <name>Task 3: Register all tools in toolset and update exports</name>
  <files>integrations/agent-browser/src/toolset.ts, integrations/agent-browser/src/index.ts</files>
  <action>
Update toolset.ts:

1. Add imports for new tool factories:
   - createSnapshotTool from ./tools/snapshot.js
   - createClickTool from ./tools/click.js
   - createTypeTool from ./tools/type.js
   - createScrollTool from ./tools/scroll.js

2. In constructor, add new tools to this.tools object:
   - browser_snapshot: createSnapshotTool(() => this.getBrowser())
   - browser_click: createClickTool(() => this.getBrowser(), this.config.timeout)
   - browser_type: createTypeTool(() => this.getBrowser(), this.config.timeout)
   - browser_scroll: createScrollTool(() => this.getBrowser())

Note: Click and type need timeout, scroll and snapshot don't need timeout parameter.

Update index.ts:

1. Add export for errors.ts:
   - export * from './errors.js';

2. Existing exports (types.ts, BrowserToolset) should remain.

Verify all exports work with pnpm build.
  </action>
  <verify>
Run: `cd integrations/agent-browser && pnpm build`
Build succeeds without errors.
Check dist/ contains all compiled files.
  </verify>
  <done>BrowserToolset registers all five tools (navigate, snapshot, click, type, scroll). Package builds and exports correctly.</done>
</task>

</tasks>

<verification>
1. `cd integrations/agent-browser && pnpm build` succeeds
2. toolset.ts registers all 5 tools: browser_navigate, browser_snapshot, browser_click, browser_type, browser_scroll
3. types.ts exports all schemas: snapshotInputSchema, clickInputSchema, typeInputSchema, scrollInputSchema
4. index.ts re-exports from errors.ts
5. dist/ contains compiled JavaScript and type declarations
</verification>

<success_criteria>
- Scroll tool handles viewport and element scrolling
- Scroll returns position object { x, y }
- All four Phase 2 tools registered in BrowserToolset.tools
- Package builds without errors
- All types and schemas exported from package
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-actions/02-03-SUMMARY.md`
</output>
