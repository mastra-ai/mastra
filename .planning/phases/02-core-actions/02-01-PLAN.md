---
phase: 02-core-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - integrations/agent-browser/src/errors.ts
  - integrations/agent-browser/src/tools/snapshot.ts
autonomous: true

must_haves:
  truths:
    - "Agent can capture accessibility snapshot with element refs (@e1, @e2, etc.)"
    - "Snapshot includes page context (URL, title, element count)"
    - "Error responses have code, message, recoveryHint, and canRetry fields"
  artifacts:
    - path: "integrations/agent-browser/src/errors.ts"
      provides: "Unified error types and factory function"
      exports: ["BrowserToolError", "ErrorCode", "createError"]
    - path: "integrations/agent-browser/src/tools/snapshot.ts"
      provides: "Snapshot tool implementation"
      exports: ["createSnapshotTool"]
  key_links:
    - from: "integrations/agent-browser/src/tools/snapshot.ts"
      to: "agent-browser BrowserManager.getSnapshot()"
      via: "getBrowser() -> browser.getSnapshot()"
      pattern: "getSnapshot\\("
---

<objective>
Create the error handling foundation and snapshot tool for page perception.

Purpose: Establish unified error structure for LLM-friendly responses and implement the snapshot tool that enables agents to perceive page structure with element refs.

Output: errors.ts with BrowserToolError type and createError factory; snapshot.ts with working snapshot tool that returns formatted accessibility tree with @e1, @e2 refs.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-actions/02-CONTEXT.md
@.planning/phases/02-core-actions/02-RESEARCH.md
@integrations/agent-browser/src/toolset.ts
@integrations/agent-browser/src/types.ts
@integrations/agent-browser/src/tools/navigate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified error handling module</name>
  <files>integrations/agent-browser/src/errors.ts</files>
  <action>
Create errors.ts with:

1. ErrorCode type union:
   - 'stale_ref' - Ref no longer valid after page change
   - 'element_not_found' - Element doesn't exist
   - 'element_blocked' - Element covered by overlay
   - 'element_not_visible' - Element hidden
   - 'not_focusable' - Can't type into element
   - 'timeout' - Operation timed out
   - 'browser_error' - Generic browser error

2. BrowserToolError interface:
   - success: false (literal)
   - code: ErrorCode
   - message: string (LLM-friendly description)
   - recoveryHint?: string (only when actionable)
   - canRetry: boolean

3. createError factory function:
   - Takes (code, message, hint?)
   - Sets canRetry based on code: true for 'timeout', 'element_blocked'
   - Returns typed BrowserToolError

4. Export all types and the factory function.

Do NOT include any Zod schemas in this file - keep it pure TypeScript types.
  </action>
  <verify>
Run: `cd integrations/agent-browser && pnpm tsc --noEmit`
TypeScript compiles without errors.
  </verify>
  <done>errors.ts exports BrowserToolError interface, ErrorCode type, and createError factory function.</done>
</task>

<task type="auto">
  <name>Task 2: Create snapshot tool with custom formatting</name>
  <files>integrations/agent-browser/src/tools/snapshot.ts</files>
  <action>
Create snapshot.ts implementing the browser_snapshot tool:

1. Import createTool from @mastra/core/tools, z from zod
2. Import BrowserManager type from agent-browser/dist/browser.js
3. Import createError from ../errors.js

4. Define input schema with z.object():
   - interactiveOnly: z.boolean().optional().default(true).describe('Only show interactive elements')
   - maxElements: z.number().optional().default(50).describe('Maximum elements to return')

5. Define output schema with z.object():
   - tree: z.string().describe('Formatted accessibility tree with refs')
   - elementCount: z.number()
   - truncated: z.boolean()

6. Create createSnapshotTool factory function:
   - Takes getBrowser: () => Promise<BrowserManager>
   - Returns createTool with id 'browser_snapshot'
   - Description: 'Capture accessibility snapshot of the page. Returns element refs (@e1, @e2) for use with click and type tools.'

7. Execute implementation:
   - Get browser via getBrowser()
   - Get page via browser.getPage()
   - Call browser.getSnapshot({ interactive: input.interactiveOnly, compact: true })
   - Get URL and title from page
   - Count refs from snapshot result

8. Format output per CONTEXT.md decisions:
   - Build header: "Page: {title}\nURL: {url}\nInteractive elements: {count}"
   - If truncated, add "(showing first {maxElements})"
   - Transform tree refs from [ref=e1] format to @e1 format using regex replace
   - Return { tree: header + formattedTree, elementCount, truncated }

9. Wrap in try/catch, return createError on failure with 'browser_error' code.

10. Export createSnapshotTool function.

Key patterns from Phase 1 navigate.ts:
- Use same import path for BrowserManager type
- Use same error handling pattern with createError
  </action>
  <verify>
Run: `cd integrations/agent-browser && pnpm tsc --noEmit`
TypeScript compiles without errors.
Verify snapshot.ts exports createSnapshotTool.
  </verify>
  <done>snapshot.ts exports createSnapshotTool that returns accessibility tree with @e1 refs, page context header, and element count.</done>
</task>

</tasks>

<verification>
1. `cd integrations/agent-browser && pnpm tsc --noEmit` passes
2. errors.ts exports: BrowserToolError, ErrorCode, createError
3. snapshot.ts exports: createSnapshotTool
4. Snapshot tool transforms refs to @e1 format
5. Error structure matches REQ-08 requirements
</verification>

<success_criteria>
- errors.ts provides unified error structure for all browser tools
- createSnapshotTool factory creates a valid Mastra tool
- Snapshot output includes page context header
- Refs formatted as @e1, @e2 (not [ref=e1])
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-actions/02-01-SUMMARY.md`
</output>
