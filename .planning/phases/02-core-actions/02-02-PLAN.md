---
phase: 02-core-actions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - integrations/agent-browser/src/tools/click.ts
  - integrations/agent-browser/src/tools/type.ts
autonomous: true

must_haves:
  truths:
    - "Agent can click on elements using ref identifiers from snapshot"
    - "Agent can type text into form fields using ref identifiers"
    - "Click and type return appropriate error with recovery hint when element not found"
  artifacts:
    - path: "integrations/agent-browser/src/tools/click.ts"
      provides: "Click tool implementation"
      exports: ["createClickTool"]
    - path: "integrations/agent-browser/src/tools/type.ts"
      provides: "Type tool implementation"
      exports: ["createTypeTool"]
  key_links:
    - from: "integrations/agent-browser/src/tools/click.ts"
      to: "agent-browser BrowserManager.getLocatorFromRef()"
      via: "browser.getLocatorFromRef(ref)"
      pattern: "getLocatorFromRef\\("
    - from: "integrations/agent-browser/src/tools/type.ts"
      to: "Playwright Locator.fill()"
      via: "locator.fill(text)"
      pattern: "\\.fill\\("
---

<objective>
Create click and type tools for element interaction using refs.

Purpose: Enable agents to interact with page elements by clicking and typing, using the ref identifiers (@e1, @e2) obtained from snapshots.

Output: click.ts with click tool supporting left/right/middle button; type.ts with type tool supporting text input with optional clear-first.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-actions/02-CONTEXT.md
@.planning/phases/02-core-actions/02-RESEARCH.md
@integrations/agent-browser/src/tools/navigate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create click tool</name>
  <files>integrations/agent-browser/src/tools/click.ts</files>
  <action>
Create click.ts implementing the browser_click tool:

1. Imports:
   - createTool from @mastra/core/tools
   - z from zod
   - BrowserManager type from agent-browser/dist/browser.js
   - BrowserToolError, createError from ../errors.js

2. Define input schema:
   - ref: z.string().describe('Element ref from snapshot (e.g., @e5)')
   - button: z.enum(['left', 'right', 'middle']).optional().default('left')

3. Define output schema:
   - success: z.boolean()

4. Create createClickTool factory:
   - Takes getBrowser: () => Promise<BrowserManager>, defaultTimeout: number
   - Returns createTool with id 'browser_click'
   - Description: 'Click on an element using its ref from the snapshot.'

5. Execute implementation:
   - Get browser via getBrowser()
   - Get locator via browser.getLocatorFromRef(input.ref)
   - If locator is null/undefined:
     - Return createError('stale_ref', `Ref ${input.ref} not found. The page may have changed.`, 'Take a new snapshot to get current element refs.')
   - Try locator.click({ button: input.button, timeout: defaultTimeout })
   - On success: return { success: true }

6. Error handling in catch block:
   - Check error.message for 'intercepts pointer events' -> createError('element_blocked', ..., 'Dismiss any modals or overlays...')
   - Check for 'Timeout' -> createError('timeout', ..., 'Element may be loading. Wait and try again.')
   - Default: createError('browser_error', `Click failed: ${message}`)

7. Export createClickTool function.

Use 5000ms (5s) as the timeout per REQ-04.
  </action>
  <verify>
Run: `cd integrations/agent-browser && pnpm tsc --noEmit`
TypeScript compiles without errors.
  </verify>
  <done>click.ts exports createClickTool that clicks elements by ref with error handling for stale refs and blocked elements.</done>
</task>

<task type="auto">
  <name>Task 2: Create type tool</name>
  <files>integrations/agent-browser/src/tools/type.ts</files>
  <action>
Create type.ts implementing the browser_type tool:

1. Imports:
   - createTool from @mastra/core/tools
   - z from zod
   - BrowserManager type from agent-browser/dist/browser.js
   - BrowserToolError, createError from ../errors.js

2. Define input schema per REQ-05:
   - ref: z.string().describe('Element ref from snapshot (e.g., @e3)')
   - text: z.string().describe('Text to type')
   - clearFirst: z.boolean().optional().default(false).describe('Clear existing content before typing')

3. Define output schema:
   - success: z.boolean()
   - value: z.string().optional().describe('Current field value after typing')

4. Create createTypeTool factory:
   - Takes getBrowser: () => Promise<BrowserManager>, defaultTimeout: number
   - Returns createTool with id 'browser_type'
   - Description: 'Type text into an input field using its ref.'

5. Execute implementation:
   - Get browser, then locator via getLocatorFromRef(input.ref)
   - If no locator: return createError('stale_ref', ...)
   - Focus element first: await locator.focus({ timeout: defaultTimeout })
   - If clearFirst: await locator.fill('', { timeout: defaultTimeout })
   - Type using fill() (NOT deprecated type()): await locator.fill(input.text, { timeout: defaultTimeout })
   - Get current value: const value = await locator.inputValue({ timeout: 1000 })
   - Return { success: true, value }

6. Error handling:
   - Check for 'not an input' or 'Cannot type' or 'not focusable' -> createError('not_focusable', `Element ${input.ref} cannot receive text input.`, 'Only textbox and searchbox elements can be typed into.')
   - Default: createError('browser_error', `Type failed: ${message}`)

7. Export createTypeTool function.

IMPORTANT: Use Playwright's fill() method, NOT the deprecated type() method. fill() clears and sets value instantly.
  </action>
  <verify>
Run: `cd integrations/agent-browser && pnpm tsc --noEmit`
TypeScript compiles without errors.
  </verify>
  <done>type.ts exports createTypeTool that types text into form fields by ref, returns current value after typing, handles non-input elements gracefully.</done>
</task>

</tasks>

<verification>
1. `cd integrations/agent-browser && pnpm tsc --noEmit` passes
2. click.ts exports createClickTool
3. type.ts exports createTypeTool
4. Both tools use getLocatorFromRef for ref resolution
5. Both return structured errors with recovery hints
6. Type tool uses fill() not deprecated type()
</verification>

<success_criteria>
- Click tool works with left/right/middle button options
- Type tool has clearFirst option and returns current value
- Both handle stale refs with clear error message
- Both handle blocked/non-focusable elements appropriately
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-actions/02-02-SUMMARY.md`
</output>
