---
phase: 02-lifecycle-callbacks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/evented/execution-engine.ts
autonomous: true

must_haves:
  truths:
    - "onFinish callback receives mastra, logger, runId, workflowId, resourceId"
    - "onFinish callback receives requestContext and getInitData function"
    - "onError callback receives mastra, logger, runId, workflowId, resourceId"
    - "onError callback receives requestContext and getInitData function"
    - "Async onError callbacks are properly awaited"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "15 new callback context tests"
      contains: "should provide mastra instance in onFinish callback"
    - path: "packages/core/src/workflows/evented/execution-engine.ts"
      provides: "resourceId propagation fix"
      contains: "resourceId:"
  key_links:
    - from: "execution-engine.ts"
      to: "invokeLifecycleCallbacks"
      via: "resourceId parameter"
      pattern: "resourceId:\\s*[^u]"
---

<objective>
Port 15 lifecycle callback context tests and fix resourceId propagation

Purpose: Achieve test parity for all callback context properties (mastra, logger, runId, workflowId, resourceId, requestContext, getInitData) in evented runtime
Output: 15 new passing tests, resourceId bug fixed
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lifecycle-callbacks/02-RESEARCH.md

Reference files:
@packages/core/src/workflows/workflow.test.ts (lines 21034-21560, callback tests)
@packages/core/src/workflows/evented/evented-workflow.test.ts (existing callback tests around line 12000+)
@packages/core/src/workflows/evented/execution-engine.ts (invokeLifecycleCallbacks call at line 220-235)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 15 callback context tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 15 callback context tests from default runtime to evented runtime. These tests verify that specific context properties are passed to onFinish/onError callbacks.

**Tests to port (add to "Lifecycle callbacks" describe block):**

1. should provide mastra instance in onFinish callback
2. should provide mastra instance in onError callback
3. should provide logger in onFinish callback
4. should provide logger in onError callback
5. should provide runId in onFinish callback
6. should provide runId in onError callback
7. should provide workflowId in onFinish callback
8. should provide workflowId in onError callback
9. should provide resourceId in onFinish callback when provided
10. should provide resourceId in onError callback when provided
11. should provide requestContext in onFinish callback
12. should provide requestContext in onError callback
13. should provide getInitData function in onFinish callback
14. should provide getInitData function in onError callback
15. should support async onError callback

**Evented test pattern (differs from default):**
- MUST include `pubsub: new EventEmitterPubSub()` in Mastra config
- MUST call `await mastra.startEventEngine()` before running workflow
- MUST call `await mastra.stopEventEngine()` after test completes
- Use unique workflow IDs per test (e.g., 'test-mastra-onFinish-workflow-evented')

**Copy test structure from default runtime** (workflow.test.ts lines 21034-21560), adapting for evented:

```typescript
it('should provide [property] in onFinish callback', async () => {
  let received: Type | undefined = undefined;

  const step1 = createStep({
    id: 'step1',
    execute: vi.fn().mockResolvedValue({ result: 'success' }),
    inputSchema: z.object({}),
    outputSchema: z.object({ result: z.string() }),
  });

  const workflow = createWorkflow({
    id: 'test-[property]-onFinish-workflow-evented',
    inputSchema: z.object({}),
    outputSchema: z.object({ result: z.string() }),
    steps: [step1],
    options: {
      onFinish: result => {
        received = result.[property];
      },
    },
  });
  workflow.then(step1).commit();

  const mastra = new Mastra({
    workflows: { 'test-[property]-onFinish-workflow-evented': workflow },
    storage: testStorage,
    pubsub: new EventEmitterPubSub(),  // REQUIRED for evented
  });
  await mastra.startEventEngine();  // REQUIRED for evented

  const run = await mastra.getWorkflow('test-[property]-onFinish-workflow-evented').createRun();
  await run.start({ inputData: {} });

  expect(received).toBe(expectedValue);

  await mastra.stopEventEngine();  // REQUIRED for evented
});
```

**For onError tests:** Use failing step with `execute: vi.fn().mockRejectedValue(new Error('...'))`

**For resourceId tests:** Use `createRun({ resourceId: '...' })` pattern

**For requestContext tests:** Use `run.start({ inputData: {}, requestContext: new RequestContext([...]) })`

**For getInitData tests:** Pass input data and verify `result.getInitData()` returns it
  </action>
  <verify>
Run: `cd /Users/tonykovanen/.superset/worktrees/mastra/evented-workflows-progress/packages/core && pnpm test evented-workflow.test.ts`

Check that:
- At least 13 of the 15 new tests pass (tests 1-8, 11-15 should pass with existing code)
- Tests 9-10 (resourceId) may fail initially - that's expected and fixed in Task 2
  </verify>
  <done>
15 callback context tests exist in evented-workflow.test.ts
At least 13 tests pass (excluding resourceId tests which may need code fix)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix resourceId propagation in execution engine</name>
  <files>packages/core/src/workflows/evented/execution-engine.ts</files>
  <action>
Fix the resourceId bug in EventedExecutionEngine.execute().

**Current code (line ~230):**
```typescript
await this.invokeLifecycleCallbacks({
  ...
  resourceId: undefined,  // BUG
  ...
});
```

**Problem:** The `resourceId` is available on the Run instance but not passed through the execute params to the callback invocation.

**Investigation needed:**
1. Check if `resourceId` is passed in the `params` object to `execute()`
2. If not in params, check if it can be obtained from storage via `runId`
3. The simplest fix is to add `resourceId` to the execute params signature

**Likely fix approach:**

1. Add `resourceId?: string` to the execute method params type
2. Pass `resourceId: params.resourceId` to `invokeLifecycleCallbacks`

**Alternative if resourceId not in params:**
Check how default runtime gets resourceId - it likely passes it through the execution path. The evented Run class stores `this.resourceId` and should pass it when calling execute.

Look at:
- packages/core/src/workflows/evented/run.ts - how it calls execute
- packages/core/src/workflows/run.ts - how default runtime passes resourceId
  </action>
  <verify>
Run: `cd /Users/tonykovanen/.superset/worktrees/mastra/evented-workflows-progress/packages/core && pnpm test evented-workflow.test.ts -- --grep "resourceId"`

Both resourceId tests should pass:
- should provide resourceId in onFinish callback when provided
- should provide resourceId in onError callback when provided
  </verify>
  <done>
resourceId is correctly passed to invokeLifecycleCallbacks
Both resourceId callback tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all 15 tests pass and no regressions</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Run the full evented workflow test suite and verify:

1. All 15 new callback context tests pass
2. No regressions in existing tests (131 tests should still pass)
3. Total passing should be ~146 tests (131 existing + 15 new)

If any tests fail:
- Check test setup (startEventEngine/stopEventEngine calls)
- Verify workflow IDs are unique across tests
- Check that Mastra config includes pubsub
- Verify callback property assertions match what base class provides

Fix any failures before completing.
  </action>
  <verify>
Run: `cd /Users/tonykovanen/.superset/worktrees/mastra/evented-workflows-progress/packages/core && pnpm test evented-workflow.test.ts`

Expected output:
- ~146 tests passing (131 + 15)
- 6 tests skipped (streaming vNext)
- 0 tests failing
  </verify>
  <done>
All 15 callback context tests pass
No regressions (existing tests still pass)
Total: ~146 passing, 6 skipped, 0 failing
  </done>
</task>

</tasks>

<verification>
Overall phase verification:

1. Run full test suite:
   ```bash
   cd /Users/tonykovanen/.superset/worktrees/mastra/evented-workflows-progress/packages/core
   pnpm test evented-workflow.test.ts
   ```

2. Verify specific callback tests:
   ```bash
   pnpm test evented-workflow.test.ts -- --grep "should provide.*in on(Finish|Error)"
   ```

3. Check no type errors:
   ```bash
   cd /Users/tonykovanen/.superset/worktrees/mastra/evented-workflows-progress
   pnpm typecheck
   ```
</verification>

<success_criteria>
1. All 15 callback context tests ported and passing:
   - mastra instance (2 tests)
   - logger (2 tests)
   - runId (2 tests)
   - workflowId (2 tests)
   - resourceId (2 tests)
   - requestContext (2 tests)
   - getInitData (2 tests)
   - async onError (1 test)

2. resourceId correctly propagated through execution path

3. No regressions - all 131 existing tests still pass

4. Total: ~146 tests passing, 6 skipped (streaming vNext)
</success_criteria>

<output>
After completion, create `.planning/phases/02-lifecycle-callbacks/02-01-SUMMARY.md`
</output>
