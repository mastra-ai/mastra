---
phase: 05-schema-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - integrations/agent-browser/src/types.ts
  - integrations/agent-browser/src/tools/snapshot.ts
  - integrations/agent-browser/src/tools/click.ts
  - integrations/agent-browser/src/tools/type.ts
  - integrations/agent-browser/src/tools/scroll.ts
  - integrations/agent-browser/src/tools/screenshot.ts
autonomous: true

must_haves:
  truths:
    - "snapshot.ts imports inputSchema and outputSchema from types.ts"
    - "click.ts imports inputSchema and outputSchema from types.ts"
    - "type.ts imports inputSchema and outputSchema from types.ts"
    - "scroll.ts imports inputSchema and outputSchema from types.ts"
    - "screenshot.ts imports inputSchema and outputSchema from types.ts"
    - "No local Zod schema definitions in any of the 5 tool files"
    - "All schema exports from types.ts remain intact"
  artifacts:
    - path: "integrations/agent-browser/src/types.ts"
      provides: "Single source of truth for all tool schemas"
      exports: ["snapshotInputSchema", "snapshotOutputSchema", "clickInputSchema", "clickOutputSchema", "typeInputSchema", "typeOutputSchema", "scrollInputSchema", "scrollOutputSchema", "screenshotInputSchema", "screenshotOutputSchema"]
  key_links:
    - from: "integrations/agent-browser/src/tools/snapshot.ts"
      to: "integrations/agent-browser/src/types.ts"
      via: "import snapshotInputSchema, snapshotOutputSchema"
      pattern: "import.*snapshotInputSchema.*from.*types"
    - from: "integrations/agent-browser/src/tools/click.ts"
      to: "integrations/agent-browser/src/types.ts"
      via: "import clickInputSchema, clickOutputSchema"
      pattern: "import.*clickInputSchema.*from.*types"
---

<objective>
Consolidate Zod schemas to types.ts as single source of truth

Purpose: Eliminate schema duplication across 5 tool files to prevent drift and ensure maintainability.

Output: All 5 tool files import schemas from types.ts instead of defining them locally.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/v1-MILESTONE-AUDIT.md

**Gap being closed:**
5 tools define Zod schemas locally AND export duplicates from types.ts. The local schemas have evolved (added success/error fields) while types.ts schemas are out of date.

**Current state:**
- Local schemas in tools (snapshot, click, type, scroll, screenshot) include error handling fields
- types.ts has outdated versions without error handling fields
- This violates Single Source of Truth principle

**Strategy:**
1. Update types.ts schemas to include success/error union patterns (matching local evolved versions)
2. Remove local schemas from 5 tool files
3. Import schemas from types.ts instead
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types.ts output schemas with error handling</name>
  <files>integrations/agent-browser/src/types.ts</files>
  <action>
Update the 5 output schemas in types.ts to include success/error union patterns matching the local tool versions:

1. **snapshotOutputSchema** (lines 92-96): Add success field, error handling fields (code, message, recoveryHint, canRetry)
```typescript
export const snapshotOutputSchema = z.object({
  success: z.boolean().optional().describe('Whether the snapshot succeeded'),
  tree: z.string().optional().describe('Formatted accessibility tree with refs'),
  elementCount: z.number().optional().describe('Number of interactive elements found'),
  truncated: z.boolean().optional().describe('Whether output was truncated due to maxElements'),
  code: z.string().optional().describe('Error code if snapshot failed'),
  message: z.string().optional().describe('Error message if snapshot failed'),
  recoveryHint: z.string().optional().describe('Recovery hint for the agent'),
  canRetry: z.boolean().optional().describe('Whether the operation can be retried'),
});
```

2. **clickOutputSchema** (lines 129-131): Add url, hint, error fields
```typescript
export const clickOutputSchema = z.object({
  success: z.boolean().describe('Whether the click succeeded'),
  url: z.string().optional().describe('Current page URL after click'),
  hint: z.string().optional().describe('Hint for next action'),
  code: z.string().optional().describe('Error code if click failed'),
  message: z.string().optional().describe('Error message if click failed'),
  recoveryHint: z.string().optional().describe('Recovery hint for the agent'),
  canRetry: z.boolean().optional().describe('Whether the operation can be retried'),
});
```

3. **typeOutputSchema** (lines 167-170): Add error fields
```typescript
export const typeOutputSchema = z.object({
  success: z.boolean().describe('Whether the type operation succeeded'),
  value: z.string().optional().describe('Current field value after typing'),
  code: z.string().optional().describe('Error code if type failed'),
  message: z.string().optional().describe('Error message if type failed'),
  recoveryHint: z.string().optional().describe('Recovery hint for the agent'),
  canRetry: z.boolean().optional().describe('Whether the operation can be retried'),
});
```

4. **scrollOutputSchema** (lines 206-214): Add success optional pattern, error fields
```typescript
export const scrollOutputSchema = z.object({
  success: z.boolean().describe('Whether the scroll operation succeeded'),
  position: z
    .object({
      x: z.number().describe('Horizontal scroll position in pixels'),
      y: z.number().describe('Vertical scroll position in pixels'),
    })
    .optional()
    .describe('New scroll position after scrolling'),
  code: z.string().optional().describe('Error code if scroll failed'),
  message: z.string().optional().describe('Error message if scroll failed'),
  recoveryHint: z.string().optional().describe('Recovery hint for the agent'),
  canRetry: z.boolean().optional().describe('Whether the operation can be retried'),
});
```

5. **screenshotOutputSchema** (lines 264-281): Add success field, error fields
```typescript
export const screenshotOutputSchema = z.object({
  success: z.boolean().optional().describe('Whether the screenshot succeeded'),
  base64: z.string().optional().describe('Base64-encoded image data'),
  mimeType: z.enum(['image/png', 'image/jpeg']).optional().describe('Image MIME type'),
  dimensions: z
    .object({
      width: z.number().describe('Image width in pixels'),
      height: z.number().describe('Image height in pixels'),
    })
    .optional()
    .describe('Image dimensions'),
  fileSize: z.number().optional().describe('Image file size in bytes'),
  timestamp: z.string().optional().describe('ISO timestamp when screenshot was captured'),
  url: z.string().optional().describe('Page URL at capture time'),
  title: z.string().optional().describe('Page title at capture time'),
  warning: z.string().optional().describe('Warning message if image dimensions exceed recommended limits'),
  code: z.string().optional().describe('Error code if screenshot failed'),
  message: z.string().optional().describe('Error message if screenshot failed'),
  recoveryHint: z.string().optional().describe('Recovery hint for the agent'),
  canRetry: z.boolean().optional().describe('Whether the operation can be retried'),
});
```
  </action>
  <verify>
Build succeeds: `cd integrations/agent-browser && pnpm build`
Types exported correctly
  </verify>
  <done>types.ts has all output schemas with success/error union patterns</done>
</task>

<task type="auto">
  <name>Task 2: Update snapshot.ts to import from types.ts</name>
  <files>integrations/agent-browser/src/tools/snapshot.ts</files>
  <action>
1. Remove local schema definitions (lines 16-38)
2. Remove `import { z } from 'zod';` (line 3)
3. Add import from types.ts:
   ```typescript
   import { snapshotInputSchema, snapshotOutputSchema } from '../types.js';
   ```
4. Keep the rest of the file unchanged (createSnapshotTool function uses the imported schemas)
  </action>
  <verify>
Build succeeds: `cd integrations/agent-browser && pnpm build`
No local schema definitions in snapshot.ts
  </verify>
  <done>snapshot.ts imports schemas from types.ts</done>
</task>

<task type="auto">
  <name>Task 3: Update click.ts to import from types.ts</name>
  <files>integrations/agent-browser/src/tools/click.ts</files>
  <action>
1. Remove local schema definitions (lines 10-31)
2. Remove `import { z } from 'zod';` (line 2)
3. Remove local type exports (ClickInput, ClickOutput - lines 36-41) since they're in types.ts
4. Add import from types.ts:
   ```typescript
   import { clickInputSchema, clickOutputSchema, type ClickOutput } from '../types.js';
   ```
5. Keep the rest of the file unchanged
  </action>
  <verify>
Build succeeds: `cd integrations/agent-browser && pnpm build`
No local schema definitions in click.ts
  </verify>
  <done>click.ts imports schemas from types.ts</done>
</task>

</tasks>

<verification>
1. Build passes: `cd integrations/agent-browser && pnpm build`
2. No local schemas: `grep -l "z.object" integrations/agent-browser/src/tools/*.ts` returns only navigate.ts
3. Schema imports: `grep "from '../types.js'" integrations/agent-browser/src/tools/*.ts` shows all 5 tools
4. Package exports work: types.ts still exports all schemas
</verification>

<success_criteria>
- types.ts has all 5 output schemas with error handling fields
- snapshot.ts imports schemas from types.ts
- click.ts imports schemas from types.ts
- No local Zod schema definitions in consolidated tool files
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-schema-consolidation/05-01-SUMMARY.md`
</output>
