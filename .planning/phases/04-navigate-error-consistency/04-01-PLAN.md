---
phase: 04-navigate-error-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - integrations/agent-browser/src/tools/navigate.ts
  - integrations/agent-browser/src/types.ts
autonomous: true

must_haves:
  truths:
    - "Navigate errors include 'code' field matching ErrorCode type"
    - "Navigate errors include 'canRetry' boolean field"
    - "Navigate errors use 'recoveryHint' field (not legacy 'hint')"
    - "Navigate error structure matches other 5 tools"
  artifacts:
    - path: "integrations/agent-browser/src/tools/navigate.ts"
      provides: "Navigate tool with unified error handling"
      contains: "createError"
  key_links:
    - from: "integrations/agent-browser/src/tools/navigate.ts"
      to: "integrations/agent-browser/src/errors.ts"
      via: "import createError"
      pattern: "import.*createError.*from.*errors"
---

<objective>
Update navigate tool to use unified BrowserToolError format from errors.ts

Purpose: Ensure consistent error handling across all 6 browser tools, enabling reliable agent error recovery logic.

Output: Navigate tool returns errors with code, canRetry, and recoveryHint fields matching snapshot/click/type/scroll/screenshot tools.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/v1-MILESTONE-AUDIT.md

**Gap being closed:**
Navigate tool uses legacy `BrowserError` interface (`{ success, error, hint }`) instead of unified `BrowserToolError` (`{ success, code, message, recoveryHint, canRetry }`).

**Evidence from audit:**
- `tools/navigate.ts:4` - Imports `BrowserError` from types.ts
- `tools/navigate.ts:75-79` - Returns `{ success: false, error, hint }` instead of `createError()`

**Reference implementation (how other tools do it):**
```typescript
import { createError, type BrowserToolError } from '../errors.js';
// ...
return createError('timeout', 'Element click timed out', 'Retry or take a new snapshot');
```

**Error code mapping for navigation failures:**
- Timeout/abort → `'timeout'` (canRetry: true)
- Browser not launched → `'browser_error'` (canRetry: false)
- Invalid URL/unreachable → `'browser_error'` (canRetry: false)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update navigate.ts to use createError</name>
  <files>integrations/agent-browser/src/tools/navigate.ts</files>
  <action>
1. Replace import: Change `type BrowserError` from `../types.js` to `createError, type BrowserToolError` from `../errors.js`

2. Update function return type: Change `Promise<NavigateOutput | BrowserError>` to `Promise<NavigateOutput | BrowserToolError>`

3. Replace error handling block (lines 60-80):
   - Timeout/abort errors → `createError('timeout', 'Navigation timed out', 'Try a different URL or increase timeout')`
   - Browser not launched → `createError('browser_error', 'Browser was not initialized', 'This is an internal error - please try again')`
   - Other errors → `createError('browser_error', \`Navigation failed: \${errorMessage}\`, 'Check that the URL is valid and the site is accessible')`

Keep the existing error detection logic (checking for 'timeout', 'aborted', 'not launched' in message).
  </action>
  <verify>
Build succeeds: `cd integrations/agent-browser && pnpm build`
Check output types: The tool should import from errors.ts, not types.ts for error handling
  </verify>
  <done>Navigate tool uses createError() factory and returns BrowserToolError with code/canRetry/recoveryHint fields</done>
</task>

<task type="auto">
  <name>Task 2: Update navigateOutputSchema in types.ts</name>
  <files>integrations/agent-browser/src/types.ts</files>
  <action>
Update `navigateOutputSchema` (lines 42-48) to include the unified error fields:

Replace the current schema with a discriminated union that handles both success and error cases:
```typescript
export const navigateOutputSchema = z.discriminatedUnion('success', [
  // Success case
  z.object({
    success: z.literal(true),
    url: z.string().describe('The final URL after navigation (may differ due to redirects)'),
    title: z.string().describe('The page title'),
  }),
  // Error case - matches BrowserToolError from errors.ts
  z.object({
    success: z.literal(false),
    code: z.string().describe('Error classification code'),
    message: z.string().describe('LLM-friendly error description'),
    recoveryHint: z.string().optional().describe('Suggested recovery action'),
    canRetry: z.boolean().describe('Whether the operation can be retried'),
  }),
]);
```

Also remove the `BrowserError` interface at the bottom of the file (lines 288-300) - it's now unused as we use `BrowserToolError` from errors.ts.
  </action>
  <verify>
Build succeeds: `cd integrations/agent-browser && pnpm build`
TypeScript compiles without errors
  </verify>
  <done>Navigate output schema uses discriminated union matching BrowserToolError structure; legacy BrowserError removed</done>
</task>

</tasks>

<verification>
1. Build passes: `cd integrations/agent-browser && pnpm build`
2. Grep confirms import: `grep "createError" integrations/agent-browser/src/tools/navigate.ts`
3. Grep confirms no legacy import: `grep "BrowserError" integrations/agent-browser/src/tools/navigate.ts` returns empty
4. Schema exports correct fields: `grep -A5 "navigateOutputSchema" integrations/agent-browser/src/types.ts` shows code/canRetry fields
</verification>

<success_criteria>
- Navigate tool imports createError from errors.ts
- Navigate errors include code field (timeout or browser_error)
- Navigate errors include canRetry boolean field
- Navigate errors use recoveryHint (not hint)
- navigateOutputSchema matches BrowserToolError structure
- Legacy BrowserError interface removed from types.ts
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-navigate-error-consistency/04-01-SUMMARY.md`
</output>
