---
phase: 01-state-object-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - '12 state-related tests exist in evented-workflow.test.ts'
    - 'Tests fail because state is not implemented (expected RED state)'
  artifacts:
    - path: 'packages/core/src/workflows/evented/evented-workflow.test.ts'
      provides: 'State-related test cases ported from default runtime'
      contains: 'with state'
  key_links:
    - from: 'evented-workflow.test.ts'
      to: 'workflow.test.ts'
      via: 'test parity'
      pattern: 'should.*with state'
---

<objective>
Port all 12 state-related tests from the default workflow runtime test suite to the evented workflow test suite.

Purpose: Create the RED phase of TDD - establish failing tests that define the expected state behavior. These tests serve as the specification for what we need to implement.

Output: 12 new test cases in evented-workflow.test.ts that currently fail due to missing state implementation.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-state-object-support/01-CONTEXT.md

@packages/core/src/workflows/workflow.test.ts (reference - contains state tests to port)
@packages/core/src/workflows/evented/evented-workflow.test.ts (target - add tests here)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port core state tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the following 6 core state tests from workflow.test.ts to evented-workflow.test.ts:

1. `should execute a single step workflow successfully with state` (line ~3475)
2. `should execute multiple steps in parallel with state` (line ~4265)
3. `should follow conditional chains with state` (line ~5584)
4. `should properly update state when executing multiple steps in parallel` (line ~4446)
5. `should update state after each concurrent batch in foreach step` (line ~4324)
6. `should preserve state across suspend and resume cycles` (search for this test)

When porting:

- Use `createWorkflow` and `createStep` from the evented workflow module (imported at top)
- Keep the same test structure and assertions
- Use `describe('State', () => { ... })` block within the existing test structure
- Tests should use the same workflow/step configurations as the default tests
- Import necessary schemas (z.object patterns match default tests)

Each test should:

- Define steps with `stateSchema` property
- Call `setState` within step execute functions
- Access `state` within step execute functions
- Assert final `result.state` matches expected values

Note: These tests WILL FAIL currently - that is expected (RED phase of TDD).
</action>
<verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -t "State"` - tests should exist and fail with state-related errors (not import errors or syntax errors).
</verify>
<done>
6 core state tests exist in evented-workflow.test.ts within a "State" describe block. Tests fail because state is not yet implemented.
</done>
</task>

<task type="auto">
  <name>Task 2: Port nested workflow and callback state tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the remaining 6 state tests from workflow.test.ts to evented-workflow.test.ts:

1. `should execute a single step nested workflow successfully with state` (line ~3644)
2. `should execute a single step nested workflow successfully with state being set by the nested workflow` (line ~3705)
3. `should provide state in onFinish callback` (line ~21364)
4. `should provide state in onError callback` (line ~21530)
5. `should generate a stream for a single step workflow successfully with state` (line ~1690)
6. `should handle basic suspend and resume flow with async await syntax with state` (line ~11423)

When porting:

- Add to the same "State" describe block created in Task 1
- For callback tests (onFinish/onError), note these may need to be placed in existing callback test sections or a new subsection
- For streaming test, adapt to evented runtime's streaming approach (may use different streaming API)
- For suspend/resume test, ensure the resume logic matches evented runtime patterns

Special considerations:

- onFinish/onError callbacks: These tests verify state is passed to lifecycle callbacks. Port the test logic but note the evented runtime may handle callbacks differently.
- Nested workflow state: The nested workflow should inherit parent state and be able to modify it.
- Streaming with state: May need adjustment based on evented runtime's streaming implementation.

Note: Some tests may need minor adaptation for evented runtime patterns, but the core assertions about state behavior should remain identical.
</action>
<verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -t "state"` - should show 12 total state-related tests, all failing with state implementation errors.
</verify>
<done>
All 12 state-related tests exist in evented-workflow.test.ts. Tests fail because state support is not implemented in the evented runtime.
</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run full evented test suite: `cd packages/core && pnpm test evented-workflow.test.ts`
2. Verify existing 119 tests still pass (no regressions)
3. Verify 12 new state tests exist and fail appropriately
4. Count should show: 119 passing + 12 failing (state tests) + 6 skipped (streaming vNext)
</verification>

<success_criteria>

- 12 state-related tests ported from default runtime to evented runtime
- Tests are syntactically correct (no import/parse errors)
- Tests fail due to missing state implementation (not other errors)
- Existing 119 tests continue to pass (no regressions introduced)
- Tests match the behavior specification from default runtime
  </success_criteria>

<output>
After completion, create `.planning/phases/01-state-object-support/01-01-SUMMARY.md`
</output>
