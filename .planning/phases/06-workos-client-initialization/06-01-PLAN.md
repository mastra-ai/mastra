---
phase: 06-workos-client-initialization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - auth/workos/src/types.ts
  - auth/workos/src/rbac-provider.ts
  - auth/workos/src/index.ts
autonomous: true

must_haves:
  truths:
    - "MastraRBACWorkos constructor accepts apiKey and clientId options"
    - "MastraRBACWorkos constructor reads WORKOS_API_KEY and WORKOS_CLIENT_ID env vars as fallback"
    - "WorkOS client is created internally in MastraRBACWorkos"
    - "TypeScript compiles without errors"
  artifacts:
    - path: "auth/workos/src/types.ts"
      provides: "MastraRBACWorkosOptions with apiKey/clientId fields"
      contains: "apiKey?: string"
    - path: "auth/workos/src/rbac-provider.ts"
      provides: "Internal WorkOS initialization"
      contains: "new WorkOS(apiKey"
    - path: "auth/workos/src/index.ts"
      provides: "Updated package example"
      contains: "apiKey:"
  key_links:
    - from: "auth/workos/src/rbac-provider.ts"
      to: "auth/workos/src/types.ts"
      via: "MastraRBACWorkosOptions import"
      pattern: "MastraRBACWorkosOptions"
    - from: "auth/workos/src/rbac-provider.ts"
      to: "@workos-inc/node"
      via: "WorkOS constructor"
      pattern: "new WorkOS\\(apiKey"
---

<objective>
Make MastraRBACWorkos initialize WorkOS client internally, matching MastraAuthWorkos pattern.

Purpose: API consistency - both classes accept the same config options
Output: Updated types, constructor, and package documentation
</objective>

<execution_context>
@/Users/yj/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-workos-client-initialization/06-RESEARCH.md

# Source files to modify
@auth/workos/src/types.ts
@auth/workos/src/rbac-provider.ts
@auth/workos/src/index.ts

# Reference implementation
@auth/workos/src/auth-provider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types and constructor for internal WorkOS init</name>
  <files>auth/workos/src/types.ts, auth/workos/src/rbac-provider.ts</files>
  <action>
  1. In `auth/workos/src/types.ts`:
     - Add to `MastraRBACWorkosOptions` interface:
       ```typescript
       /** WorkOS API key (defaults to WORKOS_API_KEY env var) */
       apiKey?: string;
       /** WorkOS Client ID (defaults to WORKOS_CLIENT_ID env var) */
       clientId?: string;
       ```

  2. In `auth/workos/src/rbac-provider.ts`:
     - Remove the `MastraRBACWorkosFullOptions` interface entirely (lines 18-23)
     - Add WorkOS import: `import { WorkOS } from '@workos-inc/node';`
     - Update constructor parameter from `MastraRBACWorkosFullOptions` to `MastraRBACWorkosOptions`
     - Replace `this.workos = options.workos;` with WorkOS initialization logic copied from MastraAuthWorkos:
       ```typescript
       const apiKey = options.apiKey ?? process.env.WORKOS_API_KEY;
       const clientId = options.clientId ?? process.env.WORKOS_CLIENT_ID;

       if (!apiKey || !clientId) {
         throw new Error(
           'WorkOS API key and client ID are required. ' +
             'Provide them in the options or set WORKOS_API_KEY and WORKOS_CLIENT_ID environment variables.',
         );
       }

       this.workos = new WorkOS(apiKey, { clientId });
       ```
     - Remove the `workos: WorkOS` type annotation from class since WorkOS is now directly imported

  AVOID: Do not keep backward compatibility for passing WorkOS instance - clean break per research recommendation.
  </action>
  <verify>
  ```bash
  cd auth/workos && pnpm build && pnpm typecheck
  ```
  TypeScript compiles without errors.
  </verify>
  <done>
  - MastraRBACWorkosOptions has apiKey and clientId optional fields
  - MastraRBACWorkosFullOptions interface removed
  - MastraRBACWorkos constructor initializes WorkOS internally
  - Error message matches MastraAuthWorkos exactly
  </done>
</task>

<task type="auto">
  <name>Task 2: Update package example documentation</name>
  <files>auth/workos/src/index.ts</files>
  <action>
  Update the example in the doc comment at the top of `auth/workos/src/index.ts` to show the new simpler API:

  Change from (current):
  ```typescript
  const workosAuth = new MastraAuthWorkos({
    apiKey: process.env.WORKOS_API_KEY,
    clientId: process.env.WORKOS_CLIENT_ID,
  });

  const mastra = new Mastra({
    server: {
      auth: workosAuth,
      rbac: new MastraRBACWorkos({
        workos: workosAuth.getWorkOS(),
        roleMapping: { ... },
      }),
    },
  });
  ```

  To (new):
  ```typescript
  const mastra = new Mastra({
    server: {
      auth: new MastraAuthWorkos({
        apiKey: process.env.WORKOS_API_KEY,
        clientId: process.env.WORKOS_CLIENT_ID,
      }),
      rbac: new MastraRBACWorkos({
        apiKey: process.env.WORKOS_API_KEY,
        clientId: process.env.WORKOS_CLIENT_ID,
        roleMapping: {
          'admin': ['*'],
          'member': ['agents:read', 'workflows:*'],
          '_default': [],
        },
      }),
    },
  });
  ```

  Also update the example in `auth/workos/src/rbac-provider.ts` class JSDoc (lines 32-58) to show new pattern without `workos:` option.
  </action>
  <verify>
  ```bash
  cd auth/workos && pnpm build
  ```
  Build succeeds, no doc errors.
  </verify>
  <done>
  - index.ts example shows new API pattern (no getWorkOS() sharing)
  - rbac-provider.ts class example updated
  - Examples demonstrate apiKey/clientId direct config
  </done>
</task>

</tasks>

<verification>
```bash
# Full verification
cd auth/workos && pnpm build && pnpm typecheck

# Grep verification
grep -q "apiKey?: string" auth/workos/src/types.ts && echo "apiKey in types: OK"
grep -q "new WorkOS(apiKey" auth/workos/src/rbac-provider.ts && echo "WorkOS init: OK"
! grep -q "MastraRBACWorkosFullOptions" auth/workos/src/rbac-provider.ts && echo "FullOptions removed: OK"
```
</verification>

<success_criteria>
1. MastraRBACWorkosOptions has apiKey and clientId optional fields
2. MastraRBACWorkosFullOptions interface no longer exists
3. MastraRBACWorkos constructor creates WorkOS client internally
4. Error message for missing credentials matches MastraAuthWorkos
5. Package examples show new simpler API pattern
6. `pnpm build` and `pnpm typecheck` pass in auth/workos
</success_criteria>

<output>
After completion, create `.planning/phases/06-workos-client-initialization/06-01-SUMMARY.md`
</output>
