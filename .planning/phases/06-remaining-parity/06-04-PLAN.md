---
phase: 06-remaining-parity
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Nested workflow result includes step information"
    - "Parallel workflows complete correctly when no steps suspend"
    - "ResourceId persists through workflow lifecycle"
    - "Foreach bail stops execution when called"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "12 ported nested, parallel, and misc tests"
      contains: "nested workflow steps information"
  key_links:
    - from: "evented-workflow.test.ts"
      to: "workflow.ts:getWorkflowRunById"
      via: "nested workflow result retrieval"
      pattern: "nestedWorkflowSteps"
---

<objective>
Port remaining tests: nested workflow info, parallel execution, resourceId, and miscellaneous.

Purpose: Close final test gaps for full parity with default runtime.
Output: ~12 ported tests covering remaining functionality.
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-remaining-parity/06-RESEARCH.md
@packages/core/src/workflows/workflow.test.ts (reference)
@packages/core/src/workflows/evented/evented-workflow.test.ts (target)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port Nested Workflow and Parallel tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 4 nested workflow and parallel execution tests.

**Tests to port (line numbers from workflow.test.ts):**

1. `should return workflow run execution result with nested workflow steps information` (line 6202)
2. `should exclude nested workflow steps when withNestedWorkflows is false` (line 6362)
3. `should complete parallel workflow when steps do not suspend` (line 20088)
4. `should properly update snapshot when executing multiple steps in parallel` (line 4020)

**Porting approach:**
- Find existing nested workflow tests in evented file
- Copy tests, replace Workflow with EventedWorkflow
- Nested workflow result info depends on getWorkflowRunById options

**Considerations:**
- Nested workflow info test: Validates `withNestedWorkflows` option returns nested step details
- Exclude nested test: Validates `withNestedWorkflows: false` excludes them
- Parallel completion: Tests that parallel steps without suspend complete correctly
- Parallel snapshot: Tests snapshot state during parallel execution

Some nested workflow tests were skipped in Phase 4 due to architecture differences. Check if these are the same tests or different.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "nested\|parallel"` (case insensitive).
Check for test results.
  </verify>
  <done>
4 nested/parallel tests ported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Port ResourceId and Miscellaneous tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 8 remaining tests for resourceId preservation and misc functionality.

**ResourceId tests (line numbers from workflow.test.ts):**

1. `should persist resourceId when creating workflow runs` (line 16711)
2. `should preserve resourceId when resuming a suspended workflow` (line 16772)

**Miscellaneous tests:**

3. `should automatically commit uncommitted workflow when registering in mastra instance` (line 3399)
4. `should bail foreach execution when called in a concurrent batch` (line 4402)
5. `should not show removed requestContext values in subsequent steps` (line 19684)
6. `should only update workflow status to success after all steps have run successfully` (line 6145)
7. `should provide full TypeScript support for tracingContext` (line 20211)
8. `should resolve dynamic mappings via .map() with custom step id` (line 4969)

**Porting approach:**
- Copy tests, replace Workflow with EventedWorkflow
- Some tests may be TypeScript-only checks (compile tests)

**Considerations:**
- resourceId tests: Phase 2 fixed resourceId propagation to callbacks, should work
- auto-commit test: Validates mastra.registerWorkflow auto-commits
- foreach bail: Tests bail() function in concurrent iteration
- requestContext: Tests that removed values don't persist
- workflow status: Tests final status only set when all complete
- tracingContext: TypeScript type test, no runtime
- dynamic .map(): Tests custom step id in mapping

For TypeScript-only tests like tracingContext, just include them to verify compilation.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "resourceId\|bail\|requestContext\|commit"` (case insensitive).
Check for test results.
  </verify>
  <done>
8 misc tests ported.
  </done>
</task>

<task type="auto">
  <name>Task 3: Final test suite run and phase completion</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Run full evented test suite for final verification.

1. Run: `cd packages/core && pnpm test evented-workflow.test.ts`
2. Record final test counts:
   - Starting: 172 passing, 18 skipped
   - Target: 200+ passing

3. For failing tests, add `it.skip` with reason

4. Run typecheck: `pnpm typecheck` from repo root

5. Commit changes:
```bash
git add packages/core/src/workflows/evented/evented-workflow.test.ts
git commit -m "test(06-04): port nested, parallel, and misc tests

- Port 4 nested workflow and parallel tests
- Port 8 resourceId and miscellaneous tests
- Phase 6 complete: evented runtime test parity achieved

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

6. Document final state:
   - Total tests ported in Phase 6
   - Final passing count
   - Final skipped count
   - Any tests that couldn't be ported with reasons
  </action>
  <verify>
`cd packages/core && pnpm test evented-workflow.test.ts` shows:
- Final passing count (target: 200+)
- Skipped tests have documented reasons
- No unexpected regressions

`pnpm typecheck` passes.
  </verify>
  <done>
Phase 6 complete. Final test counts documented. All actionable tests ported.
  </done>
</task>

</tasks>

<verification>
1. 4 nested/parallel tests ported
2. 8 resourceId/misc tests ported
3. All tests pass or have documented skip reasons
4. TypeScript compiles without errors
5. Final test count is 200+ or documented reasons for shortfall
</verification>

<success_criteria>
- 12 tests ported
- At least 8 tests passing
- Final evented test count documented
- Phase 6 complete
- Changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/06-remaining-parity/06-04-SUMMARY.md` following the summary template.

Update `.planning/STATE.md` with:
- Current Position: Phase 6 COMPLETE
- Final test counts
- Project status: COMPLETE or remaining gaps

Update `.planning/ROADMAP.md`:
- Mark Phase 6 as Complete
- Update Progress table with final counts
</output>
