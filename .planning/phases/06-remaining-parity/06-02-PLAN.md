---
phase: 06-remaining-parity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Agent steps work with v1 model configuration"
    - "Tripwire from agent propagates to workflow result"
    - "Writer custom events work in evented runtime"
    - "Streaming preserves error details from agent.stream()"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "10 ported agent and streaming tests"
      contains: "agent with v1 model"
  key_links:
    - from: "evented-workflow.test.ts"
      to: "workflow.ts:stream()"
      via: "agent step streaming"
      pattern: "agent.*stream"
---

<objective>
Port 10 agent and streaming edge case tests from default to evented runtime.

Purpose: Validate agent step features (v1 model, tripwire, agentOptions, structured output) and streaming writer functionality.
Output: 10 ported tests validating agent and streaming parity.
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-remaining-parity/06-RESEARCH.md
@packages/core/src/workflows/workflow.test.ts (reference)
@packages/core/src/workflows/evented/evented-workflow.test.ts (target)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port Agent Step tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 5 agent-related tests from workflow.test.ts to evented-workflow.test.ts.

**Tests to port (line numbers from workflow.test.ts):**

1. `should be able to use an agent with v1 model as a step` (line 2484)
2. `should bubble up tripwire from agent input processor to workflow result` (line 20357)
3. `should handle tripwire from output stream processor in agent within workflow` (line 20527)
4. `should pass agentOptions when wrapping agent with createStep` (line 2782)
5. `should pass structured output from agent step to next step with correct types` (line 20608)

**Porting approach:**
- Find existing agent tests in evented file (look for `describe('Agent'` or agent-related tests)
- Copy tests, change Workflow to EventedWorkflow
- Agent mocking patterns should work the same
- Check if tripwire propagation is implemented in evented runtime

**Considerations:**
- v1 model test: Check if v1 model config syntax is supported
- tripwire tests: These validate error boundary behavior with agents
- agentOptions test: Validates options are passed through createStep wrapper
- structured output: Validates TypeScript types flow correctly

Evented runtime may handle agent streaming differently. Document any behavioral differences.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "agent"` (case insensitive).
Check for new agent tests and their pass/fail status.
  </verify>
  <done>
5 agent tests ported. Document which pass/fail.
  </done>
</task>

<task type="auto">
  <name>Task 2: Port Streaming and Writer tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 5 streaming edge case tests from workflow.test.ts to evented-workflow.test.ts.

**Tests to port (line numbers from workflow.test.ts):**

1. `should continue streaming current run on subsequent stream calls` (line 457)
2. `should handle custom event emission using writer` (line 2064)
3. `should handle writer.custom during resume operations` (line 11896)
4. `should handle errors from agent.stream() with full error details` (line 7169)
5. `should preserve error details in streaming workflow` (line 7238)

**Total for this task:** 5 tests (combined with Task 1's 5 agent tests = 10 tests for this plan)

**Porting approach:**
- Find the Streaming describe block (was unskipped in Phase 5)
- Add these tests to that block
- Replace Workflow with EventedWorkflow

**Key considerations:**
- `continue streaming` test: Tests calling stream() multiple times on same run
- `writer.custom` tests: Writer functionality may need implementation in evented
- `error details` tests: Error serialization in streams

**Writer in evented runtime:**
The evented runtime may not have writer support. If tests fail because writer is undefined:
1. Check if writer is passed to step context
2. If not, add skip comment: "evented runtime does not expose writer in step context"

Stream() was implemented in Phase 5, so basic streaming should work.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "stream"` (case insensitive).
Check for new streaming tests and their pass/fail status.
  </verify>
  <done>
5 streaming tests ported. Document writer support status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and commit</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Run full evented test suite to verify no regressions.

1. Run: `cd packages/core && pnpm test evented-workflow.test.ts`
2. Record test counts

3. For failing tests, add `it.skip` with reason:
   - `it.skip('should handle writer.custom - evented runtime does not support writer API', ...)`
   - `it.skip('should continue streaming - evented pubsub differs from default', ...)`

4. Commit changes:
```bash
git add packages/core/src/workflows/evented/evented-workflow.test.ts
git commit -m "test(06-02): port agent and streaming edge case tests

- Port 5 agent step tests (v1 model, tripwire, agentOptions)
- Port 5-6 streaming tests (writer, error details)
- Document evented-specific behaviors and limitations

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
`cd packages/core && pnpm test evented-workflow.test.ts` shows:
- Test count increased
- No regressions
- Skipped tests have documented reasons
  </verify>
  <done>
10 tests ported. Counts documented. Changes committed.
  </done>
</task>

</tasks>

<verification>
1. 5 agent tests ported
2. 5 streaming tests ported
3. Tests pass or have documented skip reasons
4. No regressions in existing tests
</verification>

<success_criteria>
- 10 tests ported (5 agent + 5 streaming)
- At least 6 tests passing
- Failed tests have skip with documented reason
- Test count increased
- Changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/06-remaining-parity/06-02-SUMMARY.md` following the summary template.
</output>
