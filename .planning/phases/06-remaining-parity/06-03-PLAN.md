---
phase: 06-remaining-parity
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/evented/step-executor.ts
autonomous: true

must_haves:
  truths:
    - "Sleep step with fn parameter works in evented runtime"
    - "Schema default values apply correctly on resume"
    - "Invalid trigger data throws validation error"
    - "Invalid resume data throws validation error"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "6 ported schema and sleep tests"
      contains: "sleep.*fn parameter"
  key_links:
    - from: "evented-workflow.test.ts"
      to: "step-executor.ts:executeSleepStep"
      via: "sleep step execution"
      pattern: "executeSleepStep"
---

<objective>
Port 6 schema validation and sleep step tests from default to evented runtime.

Purpose: Validate schema defaults on resume and sleep step fn parameter functionality.
Output: 6 ported tests covering schema and sleep edge cases.
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-remaining-parity/06-RESEARCH.md
@packages/core/src/workflows/workflow.test.ts (reference)
@packages/core/src/workflows/evented/evented-workflow.test.ts (target)
@packages/core/src/workflows/evented/step-executor.ts (sleep step implementation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port Schema Validation tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 3 schema validation tests from workflow.test.ts to evented-workflow.test.ts.

**Tests to port (line numbers from workflow.test.ts):**

1. `should use default value from resumeSchema when resuming a workflow` (line 9288 or 10300)
2. `should throw error if trigger data is invalid` (line 8640 or 9753)
3. `should throw error when you try to resume a workflow step with invalid resume data` (line 9206 or 10208)

**Note:** These tests appear twice in workflow.test.ts (once in default describe, once in stream describe). Port the non-streaming versions.

**Porting approach:**
- Find existing schema validation tests in evented file
- Copy tests, replace Workflow with EventedWorkflow
- Schema validation should work the same in evented runtime

**Considerations:**
- resumeSchema defaults: Test that default values from zod schema are applied when resuming
- trigger validation: Test that triggerData is validated against inputSchema
- resume validation: Test that resumeData is validated against step's resumeSchema

Phase 3 already ported 12 schema tests, so some of these may already exist. Check for duplicates before adding.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "schema\|resume.*default\|trigger.*invalid"` (case insensitive).
Check for new and existing schema tests.
  </verify>
  <done>
3 schema tests ported (or documented as already existing).
  </done>
</task>

<task type="auto">
  <name>Task 2: Port Sleep Step with fn Parameter tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts, packages/core/src/workflows/evented/step-executor.ts</files>
  <action>
Port 3 sleep step tests with fn parameter from workflow.test.ts to evented-workflow.test.ts.

**Tests to port (line numbers from workflow.test.ts):**

1. `should execute a sleep step with fn parameter` (line 5930)
2. `should execute a sleep until step with fn parameter` (line 6046)
3. `should handle sleep waiting flow with fn parameter` (line 1200 or 3046)

**Porting approach:**
- Find existing sleep tests in evented file
- Copy tests, replace Workflow with EventedWorkflow

**Sleep with fn parameter:**
Sleep steps can have a `fn` parameter that returns the duration dynamically:
```typescript
.sleep('dynamic-sleep', {
  fn: ({ inputData }) => inputData.delayMs,
})
```

**Check if evented supports this:**
1. Look at step-executor.ts for sleep step handling
2. Check if fn parameter is called to get duration
3. If not implemented, may need to add support or skip tests

**If implementation needed:**
In step-executor.ts `executeSleepStep` function:
- Check if step has `fn` property
- If so, call `fn(context)` to get duration
- Use returned duration instead of static value

This is a small change - implement if straightforward, skip with comment if complex.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "sleep"` (case insensitive).
Check for sleep tests and whether fn parameter tests pass.
  </verify>
  <done>
3 sleep tests ported. Document if fn parameter is supported or needs implementation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and commit</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Run full evented test suite to verify no regressions.

1. Run: `cd packages/core && pnpm test evented-workflow.test.ts`
2. Record test counts

3. For failing tests, add `it.skip` with reason:
   - `it.skip('should execute sleep with fn - evented runtime does not support dynamic sleep fn', ...)`

4. Commit changes:
```bash
git add packages/core/src/workflows/evented/evented-workflow.test.ts
git commit -m "test(06-03): port schema validation and sleep fn tests

- Port 3 schema validation tests (resumeSchema defaults, validation errors)
- Port 3 sleep step tests with fn parameter
- Document any implementation gaps

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

If step-executor.ts was modified:
```bash
git add packages/core/src/workflows/evented/step-executor.ts packages/core/src/workflows/evented/evented-workflow.test.ts
git commit -m "feat(06-03): support sleep fn parameter in evented runtime

- Add fn parameter support to sleep step execution
- Port 6 schema and sleep tests

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
`cd packages/core && pnpm test evented-workflow.test.ts` shows:
- Test count increased
- No regressions
- Skipped tests have documented reasons
  </verify>
  <done>
6 tests ported. Counts documented. Changes committed.
  </done>
</task>

</tasks>

<verification>
1. 3 schema validation tests ported
2. 3 sleep step fn tests ported
3. Tests pass or have documented skip reasons
4. No regressions in existing tests
</verification>

<success_criteria>
- 6 tests ported
- At least 4 tests passing
- Failed tests have skip with documented reason
- Test count increased
- Changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/06-remaining-parity/06-03-SUMMARY.md` following the summary template.
</output>
