---
phase: 06-remaining-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Storage API tests validate run persistence and retrieval"
    - "Error serialization preserves error properties and cause chains"
    - "runCount exists and equals zero for first run"
    - "shouldPersistSnapshot option controls when snapshots are saved"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "12 ported storage and error tests"
      contains: "runCount should exist"
  key_links:
    - from: "evented-workflow.test.ts"
      to: "workflow.ts:getWorkflowRunById"
      via: "storage API calls"
      pattern: "getWorkflowRunById"
---

<objective>
Port 12 storage and error handling tests from default to evented runtime.

Purpose: Validate storage API (getWorkflowRunById, deleteWorkflowRunById) and error serialization work correctly in evented runtime.
Output: 12 ported tests, most passing (some may need implementation fixes).
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-remaining-parity/06-RESEARCH.md
@packages/core/src/workflows/workflow.test.ts (reference for test patterns)
@packages/core/src/workflows/evented/evented-workflow.test.ts (target)
@packages/core/src/workflows/evented/workflow.ts (EventedWorkflow implementation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port Storage API tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 7 storage-related tests from workflow.test.ts to evented-workflow.test.ts.

Find a suitable location in the evented test file (near other storage tests if they exist, or create a new describe block "Storage Operations").

**Tests to port (line numbers are from workflow.test.ts):**

1. `runCount should exist and equal zero for the first run` (line 19964)
2. `should get and delete workflow run by id from storage` (line 16656)
3. `should load serialized error from storage via getWorkflowRunById` (line 7285)
4. `should return correct status from storage when creating run with existing runId from different workflow instance` (line 10895)
5. `should return only requested fields when fields option is specified` (line 6310)
6. `should update run status from storage snapshot when run exists in memory map` (line 10970)
7. `should use shouldPersistSnapshot option` (line 16592)

**Porting approach:**
- Copy each test from workflow.test.ts
- Replace `new Workflow()` with `new EventedWorkflow()`
- Replace `type: 'default'` with `type: 'evented'` if present in registrations
- Ensure mastra instance is created per test (pattern from existing evented tests)
- Use `{ runtime: 'evented' }` if needed in workflow config

**Test-by-test considerations:**
- runCount test: Should work as-is, just change Workflow to EventedWorkflow
- get/delete test: Storage API should be identical
- load serialized error: Error serialization may need verification
- existing runId status: Test creates second instance with same runId
- requested fields: fields option may need implementation check
- update run status: Memory map behavior may differ
- shouldPersistSnapshot: Callback option may need implementation check

If a test fails, document the reason in a skip comment and move on. Goal is to identify gaps, not block on fixes.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "Storage"` if tests are in a Storage describe block.
If tests are scattered, run full test suite and check for new test names.
  </verify>
  <done>
7 storage tests ported. Document how many pass vs fail.
  </done>
</task>

<task type="auto">
  <name>Task 2: Port Error Handling tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port 5 error handling tests from workflow.test.ts to evented-workflow.test.ts.

**Tests to port (line numbers from workflow.test.ts):**

1. `should persist error message without stack trace in snapshot` (line 6750)
2. `should persist MastraError message without stack trace in snapshot` (line 6811)
3. `should preserve custom error properties when step throws error with extra fields` (line 7002)
4. `should propagate step error to workflow-level error` (line 7062)
5. `should preserve error.cause chain in result.error` (line 7112)

**Note:** Test at line 3531 in evented tests already covers some error preservation. Check for overlap.

**Porting approach:**
- Find existing error handling tests in evented file
- Add these tests in same describe block
- Replace Workflow with EventedWorkflow
- Error serialization in evented may differ - document any differences

**Key checks:**
- Stack traces should NOT be persisted in snapshots (security/size)
- Custom error properties (like statusCode) should be preserved
- error.cause chain should be maintained
- MastraError should serialize correctly
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts -- --grep "error"` (case insensitive).
Check output for new test names and pass/fail status.
  </verify>
  <done>
5 error tests ported. Document overlap with existing tests. Count pass/fail.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and document results</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Run full evented test suite to verify no regressions and count new passing tests.

1. Run: `cd packages/core && pnpm test evented-workflow.test.ts`
2. Record:
   - Total passing tests (was 172)
   - Total skipped tests (was 18)
   - Any new failures

3. For any ported tests that fail:
   - Add `it.skip` with reason comment
   - Example: `it.skip('should use shouldPersistSnapshot option - evented runtime does not support this option', ...)`

4. Commit changes:
```bash
git add packages/core/src/workflows/evented/evented-workflow.test.ts
git commit -m "test(06-01): port 12 storage and error handling tests

- Port 7 storage API tests (runCount, get/delete, fields option)
- Port 5 error serialization tests (stack trace, cause chain)
- Document any evented-specific behaviors

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
`cd packages/core && pnpm test evented-workflow.test.ts` shows:
- Passing count increased from 172
- No unexpected regressions (existing tests still pass)
- Skipped tests documented with reasons
  </verify>
  <done>
12 tests ported. Test counts documented. Changes committed.
  </done>
</task>

</tasks>

<verification>
1. 7 storage tests ported from default to evented
2. 5 error handling tests ported from default to evented
3. Tests pass or have documented skip reasons
4. No regressions in existing 172 tests
5. TypeScript compiles without errors
</verification>

<success_criteria>
- 12 tests ported
- At least 8 of 12 tests passing
- Failed tests have skip with documented reason
- Test count increased from 172
- Changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/06-remaining-parity/06-01-SUMMARY.md` following the summary template.
</output>
