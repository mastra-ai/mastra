---
phase: 03-screenshot
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - integrations/agent-browser/src/tools/screenshot.ts
  - integrations/agent-browser/src/types.ts
  - integrations/agent-browser/src/toolset.ts
  - integrations/agent-browser/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent can capture screenshot of current viewport"
    - "Agent can capture full-page screenshot"
    - "Agent can capture screenshot of specific element by ref"
    - "Screenshot returns base64 data with dimensions for multimodal use"
    - "PNG is default format, JPEG supported with quality parameter"
    - "Large images (>8000px) include warning but still return data"
  artifacts:
    - path: "integrations/agent-browser/src/tools/screenshot.ts"
      provides: "Screenshot tool implementation"
      exports: ["createScreenshotTool"]
    - path: "integrations/agent-browser/src/types.ts"
      provides: "Screenshot Zod schemas"
      contains: "screenshotInputSchema"
    - path: "integrations/agent-browser/src/toolset.ts"
      provides: "BrowserToolset with screenshot"
      contains: "browser_screenshot"
    - path: "integrations/agent-browser/src/index.ts"
      provides: "Package exports"
      contains: "ScreenshotInput"
  key_links:
    - from: "integrations/agent-browser/src/tools/screenshot.ts"
      to: "BrowserManager.getPage()"
      via: "getBrowser closure"
      pattern: "browser\\.getPage\\(\\)"
    - from: "integrations/agent-browser/src/tools/screenshot.ts"
      to: "BrowserManager.getLocatorFromRef()"
      via: "element screenshot"
      pattern: "browser\\.getLocatorFromRef"
    - from: "integrations/agent-browser/src/toolset.ts"
      to: "screenshot.ts"
      via: "tool registration"
      pattern: "browser_screenshot.*createScreenshotTool"
---

<objective>
Implement the browser_screenshot tool with viewport, full-page, and element capture modes.

Purpose: Agents need visual screenshots for debugging and verification. Screenshots enable multimodal analysis of page state.
Output: Working screenshot tool returning base64 data with metadata (dimensions, mimeType, fileSize, etc.)
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context - decisions and research
@.planning/phases/03-screenshot/03-CONTEXT.md
@.planning/phases/03-screenshot/03-RESEARCH.md

# Prior phase patterns (Phase 2 established tool patterns)
@integrations/agent-browser/src/tools/click.ts
@integrations/agent-browser/src/errors.ts
@integrations/agent-browser/src/types.ts
@integrations/agent-browser/src/toolset.ts
@integrations/agent-browser/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create screenshot tool</name>
  <files>integrations/agent-browser/src/tools/screenshot.ts</files>
  <action>
Create screenshot tool following the established tool factory pattern from click.ts.

**Schema definitions (define locally in file, re-export from types.ts later):**

Input schema:
- `fullPage` (boolean, optional, default false): Capture entire scrollable page
- `format` (enum 'png'|'jpeg', optional, default 'png'): Image format
- `quality` (number 0-100, optional, default 80): JPEG quality (ignored for PNG)
- `ref` (string, optional): Element ref from snapshot to capture specific element

Output schema:
- `base64` (string): Base64-encoded image data (raw, not data URL)
- `mimeType` (string): 'image/png' or 'image/jpeg'
- `dimensions` (object): { width: number, height: number }
- `fileSize` (number): Image size in bytes
- `timestamp` (string): ISO timestamp of capture
- `url` (string): Page URL at capture time
- `title` (string): Page title at capture time
- `warning` (string, optional): Warning if image exceeds 8000px

**Implementation:**

```typescript
export function createScreenshotTool(getBrowser: () => Promise<BrowserManager>, defaultTimeout: number)
```

Three capture modes:
1. **Viewport (default):** `page.screenshot({ type, quality, timeout: 30_000 })`
2. **Full-page:** `page.screenshot({ fullPage: true, type, quality, timeout: 30_000 })`
3. **Element by ref:** `locator.screenshot({ type, timeout: 30_000 })`

For element mode:
- Check `browser.getLocatorFromRef(input.ref)` returns non-null
- Return `stale_ref` error with hint if null
- Use `locator.boundingBox()` for dimensions (round to integers)

For full-page dimensions:
```typescript
const dimensions = await page.evaluate(() => ({
  width: document.documentElement.scrollWidth,
  height: document.documentElement.scrollHeight,
}));
```

**Large image warning (8000px threshold):**
```typescript
const MAX_DIMENSION = 8000;
const isOversized = dimensions.width > MAX_DIMENSION || dimensions.height > MAX_DIMENSION;
// Add warning field if oversized, but still return full image
```

**Error handling:**
- Timeout: Return `createError('timeout', 'Screenshot capture timed out after 30 seconds.', 'Try viewport only or a specific element.')`
- Stale ref: Return `createError('stale_ref', ...)`
- Generic errors: Return `createError('browser_error', ...)`

**Critical:** Ensure mimeType matches actual format - if `type: 'png'`, return `mimeType: 'image/png'`.

Use 30_000ms timeout (30 seconds) as specified in CONTEXT.md.
  </action>
  <verify>
File exists at `integrations/agent-browser/src/tools/screenshot.ts`
File exports `createScreenshotTool` function
File has proper JSDoc comments
TypeScript compiles without errors: `cd integrations/agent-browser && npx tsc --noEmit`
  </verify>
  <done>
createScreenshotTool function implemented with viewport, full-page, and element capture modes.
Returns proper metadata (base64, mimeType, dimensions, fileSize, timestamp, url, title).
Large image warning included for >8000px dimensions.
Error handling consistent with other tools.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add screenshot schemas to types.ts</name>
  <files>integrations/agent-browser/src/types.ts</files>
  <action>
Add screenshot tool Zod schemas to types.ts following the established pattern.

Add a new section after the Scroll Tool Schemas section:

```typescript
// ============================================================================
// Screenshot Tool Schemas
// ============================================================================

/**
 * Zod schema for the screenshot tool input parameters.
 *
 * Supports viewport, full-page, and element capture modes.
 */
export const screenshotInputSchema = z.object({
  fullPage: z
    .boolean()
    .optional()
    .default(false)
    .describe('Capture the entire scrollable page instead of just the viewport'),
  format: z
    .enum(['png', 'jpeg'])
    .optional()
    .default('png')
    .describe('Image format. PNG is lossless, JPEG is smaller.'),
  quality: z
    .number()
    .min(0)
    .max(100)
    .optional()
    .default(80)
    .describe('JPEG quality (0-100). Ignored for PNG.'),
  ref: z
    .string()
    .optional()
    .describe('Element ref from snapshot to capture specific element (e.g., @e5)'),
});

/**
 * Zod schema for the screenshot tool output.
 *
 * Returns base64 image data with metadata for multimodal consumption.
 */
export const screenshotOutputSchema = z.object({
  base64: z.string().describe('Base64-encoded image data'),
  mimeType: z.enum(['image/png', 'image/jpeg']).describe('Image MIME type'),
  dimensions: z
    .object({
      width: z.number().describe('Image width in pixels'),
      height: z.number().describe('Image height in pixels'),
    })
    .describe('Image dimensions'),
  fileSize: z.number().describe('Image file size in bytes'),
  timestamp: z.string().describe('ISO timestamp when screenshot was captured'),
  url: z.string().describe('Page URL at capture time'),
  title: z.string().describe('Page title at capture time'),
  warning: z
    .string()
    .optional()
    .describe('Warning message if image dimensions exceed recommended limits'),
});

/**
 * Input type for the screenshot tool.
 */
export type ScreenshotInput = z.infer<typeof screenshotInputSchema>;

/**
 * Output type for the screenshot tool.
 */
export type ScreenshotOutput = z.infer<typeof screenshotOutputSchema>;
```
  </action>
  <verify>
File has Screenshot Tool Schemas section
Exports screenshotInputSchema, screenshotOutputSchema, ScreenshotInput, ScreenshotOutput
TypeScript compiles: `cd integrations/agent-browser && npx tsc --noEmit`
  </verify>
  <done>
Screenshot Zod schemas added to types.ts with proper JSDoc comments.
Input schema supports fullPage, format, quality, and ref parameters.
Output schema includes all metadata fields (base64, mimeType, dimensions, fileSize, timestamp, url, title, warning).
  </done>
</task>

<task type="auto">
  <name>Task 3: Register screenshot tool in toolset and update exports</name>
  <files>
integrations/agent-browser/src/toolset.ts
integrations/agent-browser/src/index.ts
  </files>
  <action>
**Update toolset.ts:**

1. Add import for screenshot tool:
```typescript
import { createScreenshotTool } from './tools/screenshot.js';
```

2. Register browser_screenshot in the tools object (after browser_scroll):
```typescript
this.tools = {
  browser_navigate: createNavigateTool(() => this.getBrowser(), this.config.timeout),
  browser_snapshot: createSnapshotTool(() => this.getBrowser()),
  browser_click: createClickTool(() => this.getBrowser(), this.config.timeout),
  browser_type: createTypeTool(() => this.getBrowser(), this.config.timeout),
  browser_scroll: createScrollTool(() => this.getBrowser()),
  browser_screenshot: createScreenshotTool(() => this.getBrowser(), 30_000),  // 30s timeout
};
```

Note: Screenshot uses fixed 30_000ms timeout (not config.timeout which is 10s) because full-page screenshots can take longer.

**Update index.ts:**

1. Add ScreenshotInput and ScreenshotOutput to type exports:
```typescript
export type {
  BrowserToolsetConfig,
  NavigateInput,
  NavigateOutput,
  SnapshotInput,
  SnapshotOutput,
  ClickInput,
  ClickOutput,
  TypeInput,
  TypeOutput,
  ScrollInput,
  ScrollOutput,
  ScreenshotInput,  // Add
  ScreenshotOutput, // Add
  BrowserError,
} from './types.js';
```

2. Add schema exports:
```typescript
export {
  navigateInputSchema,
  navigateOutputSchema,
  snapshotInputSchema,
  snapshotOutputSchema,
  clickInputSchema,
  clickOutputSchema,
  typeInputSchema,
  typeOutputSchema,
  scrollInputSchema,
  scrollOutputSchema,
  screenshotInputSchema,  // Add
  screenshotOutputSchema, // Add
} from './types.js';
```
  </action>
  <verify>
toolset.ts imports createScreenshotTool
toolset.ts registers browser_screenshot in tools object
index.ts exports ScreenshotInput, ScreenshotOutput types
index.ts exports screenshotInputSchema, screenshotOutputSchema
TypeScript compiles: `cd integrations/agent-browser && npx tsc --noEmit`
Build succeeds: `cd integrations/agent-browser && pnpm build`
  </verify>
  <done>
browser_screenshot tool registered in BrowserToolset with 30s timeout.
All screenshot types and schemas exported from package.
Package builds successfully.
Complete BrowserToolset now has 6 tools: navigate, snapshot, click, type, scroll, screenshot.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type check:** `cd integrations/agent-browser && npx tsc --noEmit`
2. **Build:** `cd integrations/agent-browser && pnpm build`
3. **Verify exports:** Check dist/index.d.ts includes screenshot types and schemas
4. **Code review:**
   - screenshot.ts follows click.ts pattern
   - mimeType matches format parameter
   - 30s timeout used consistently
   - Large image warning threshold is 8000px
   - Error handling uses createError from errors.ts
</verification>

<success_criteria>
- [ ] browser_screenshot tool captures viewport by default
- [ ] browser_screenshot tool captures full page when fullPage: true
- [ ] browser_screenshot tool captures element when ref provided
- [ ] Screenshot returns base64 string (not data URL)
- [ ] Screenshot returns correct mimeType matching format
- [ ] Screenshot returns dimensions, fileSize, timestamp, url, title
- [ ] Screenshot includes warning for >8000px images
- [ ] Package builds and exports all types
</success_criteria>

<output>
After completion, create `.planning/phases/03-screenshot/03-01-SUMMARY.md`
</output>
