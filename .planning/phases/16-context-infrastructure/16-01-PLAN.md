---
phase: 16-context-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/playground-ui/src/domains/agents/context/browser-session-context.tsx
  - packages/playground-ui/src/domains/agents/context/browser-tool-calls-context.tsx
  - packages/playground-ui/src/domains/agents/context/index.tsx
  - packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
  - packages/playground-ui/src/lib/ai-ui/thread.tsx
  - packages/playground/src/pages/agents/agent/index.tsx
autonomous: true

must_haves:
  truths:
    - "BrowserSessionContext provides isActive, status, currentUrl, show(), hide(), setStatus(), and setCurrentUrl() to any descendant component"
    - "BrowserToolCallsProvider wraps both Thread (inside AgentChat) and BrowserViewPanel (inside Thread) from the Agent page level"
    - "All existing behavior is preserved with zero visual changes -- the overlay still renders as before"
    - "useBrowserToolCalls hook works in both ToolFallback (inside messages) and BrowserToolCallHistory (inside browser panel)"
  artifacts:
    - path: "packages/playground-ui/src/domains/agents/context/browser-session-context.tsx"
      provides: "BrowserSessionContext with provider and consumer hooks"
      exports: ["BrowserSessionProvider", "useBrowserSession"]
    - path: "packages/playground-ui/src/domains/agents/context/index.tsx"
      provides: "Re-exports browser-session-context and browser-tool-calls-context"
      contains: "browser-session-context"
    - path: "packages/playground/src/pages/agents/agent/index.tsx"
      provides: "Agent page with BrowserToolCallsProvider and BrowserSessionProvider wrapping AgentLayout"
      contains: "BrowserToolCallsProvider"
  key_links:
    - from: "packages/playground/src/pages/agents/agent/index.tsx"
      to: "packages/playground-ui/src/domains/agents/context/browser-tool-calls-context.tsx"
      via: "import BrowserToolCallsProvider from @mastra/playground-ui"
      pattern: "BrowserToolCallsProvider"
    - from: "packages/playground/src/pages/agents/agent/index.tsx"
      to: "packages/playground-ui/src/domains/agents/context/browser-session-context.tsx"
      via: "import BrowserSessionProvider from @mastra/playground-ui"
      pattern: "BrowserSessionProvider"
    - from: "packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx"
      to: "packages/playground-ui/src/domains/agents/context/browser-session-context.tsx"
      via: "useBrowserSession() hook consumption"
      pattern: "useBrowserSession"
    - from: "packages/playground-ui/src/lib/ai-ui/thread.tsx"
      to: "packages/playground/src/pages/agents/agent/index.tsx"
      via: "BrowserToolCallsProvider removed from Thread, hoisted to Agent page"
      pattern: "no BrowserToolCallsProvider import in thread.tsx"
---

<objective>
Create BrowserSessionContext for layout-level session state sharing and hoist BrowserToolCallsProvider from Thread to Agent page level.

Purpose: Establishes the context infrastructure that Phase 17 needs to coordinate browser panel auto-expand/collapse from AgentLayout. By moving state up without changing rendering, this phase is a pure state migration with zero visual risk.

Output: Two context providers (BrowserSessionContext, BrowserToolCallsProvider) wrapped around AgentLayout at the Agent page level, with BrowserViewPanel consuming BrowserSessionContext instead of local useState.
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@packages/playground-ui/src/domains/agents/context/browser-tool-calls-context.tsx
@packages/playground-ui/src/domains/agents/context/index.tsx
@packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
@packages/playground-ui/src/lib/ai-ui/thread.tsx
@packages/playground/src/pages/agents/agent/index.tsx
@packages/playground-ui/src/domains/agents/components/agent-layout.tsx
@packages/playground-ui/src/domains/agents/components/agent-chat.tsx
@packages/playground-ui/src/domains/agents/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrowserSessionContext and wire into BrowserViewPanel</name>
  <files>
    packages/playground-ui/src/domains/agents/context/browser-session-context.tsx
    packages/playground-ui/src/domains/agents/context/index.tsx
    packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
  </files>
  <action>
    **Create `browser-session-context.tsx`** in the context directory following the exact pattern of `browser-tool-calls-context.tsx`:

    1. Create a `BrowserSessionContextValue` interface with these fields:
       - `isActive: boolean` — true when browser panel should be visible (replaces `isVisible` local state)
       - `status: StreamStatus` — current stream status (import `StreamStatus` from `../../hooks/use-browser-stream`)
       - `currentUrl: string | null` — current browser URL
       - `show: () => void` — sets isActive to true (called when streaming starts)
       - `hide: () => void` — sets isActive to false (called on close button)
       - `setStatus: (status: StreamStatus) => void` — updates status
       - `setCurrentUrl: (url: string | null) => void` — updates URL

    2. Create `BrowserSessionProvider` component:
       - Use `useState` for `isActive` (default: false), `status` (default: 'idle'), `currentUrl` (default: null)
       - Implement `show` and `hide` as `useCallback` functions that set `isActive`
       - Implement `setStatus` and `setCurrentUrl` as `useCallback` functions
       - Memoize the context value object with `useMemo` containing all fields
       - Render `<BrowserSessionContext.Provider value={value}>{children}</BrowserSessionContext.Provider>`

    3. Create `useBrowserSession()` consumer hook:
       - Reads context, throws if null (same pattern as `useBrowserToolCalls`)
       - Error message: `'useBrowserSession must be used within a BrowserSessionProvider'`

    **Update `context/index.tsx`** — add two export lines:
    - `export * from './browser-session-context';`
    - `export * from './browser-tool-calls-context';`

    **Update `browser-view-panel.tsx`** to consume context instead of local state:
    - Import `useBrowserSession` from `@/domains/agents/context/browser-session-context`
    - Replace the local `useState` calls for `status`, `currentUrl`, `isVisible` with destructured values from `useBrowserSession()`:
      ```
      const { isActive, status, currentUrl, show, hide, setStatus, setCurrentUrl } = useBrowserSession();
      ```
    - Keep `isClosing` and `isCollapsed` as local state (these are panel-internal UI concerns, not shared)
    - Replace `handleStatusChange` callback: call `setStatus(newStatus)` and conditionally call `show()` when `newStatus === 'streaming'` (same logic, now via context)
    - Replace `handleUrlChange` callback: call `setCurrentUrl(url)`
    - Replace `handleClose` logic: call `hide()` instead of `setIsVisible(false)`, rest of close logic stays the same
    - Replace all `isVisible` references with `isActive`

    IMPORTANT: Do NOT change ANY class names, DOM structure, or rendering logic. The only change is where state lives (context vs local). The component renders identically.
  </action>
  <verify>
    Run `cd packages/playground-ui && pnpm build` — must succeed with zero type errors.
    Grep for `useState.*isVisible` in browser-view-panel.tsx — should find zero matches (state moved to context).
    Grep for `useBrowserSession` in browser-view-panel.tsx — should find one match (the hook call).
    Grep for `BrowserSessionProvider` in context/index.tsx — should find one match (the re-export).
  </verify>
  <done>
    BrowserSessionContext exists with all 7 fields (isActive, status, currentUrl, show, hide, setStatus, setCurrentUrl). BrowserViewPanel consumes context instead of local state. Context re-exported from agents context barrel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Hoist BrowserToolCallsProvider and BrowserSessionProvider to Agent page level</name>
  <files>
    packages/playground-ui/src/lib/ai-ui/thread.tsx
    packages/playground/src/pages/agents/agent/index.tsx
  </files>
  <action>
    **Update `thread.tsx`** — remove BrowserToolCallsProvider wrapping:
    - Remove the import line: `import { BrowserToolCallsProvider } from '@/domains/agents/context/browser-tool-calls-context';`
    - In the `Thread` component, remove the conditional wrapping at lines 69-73. The component should always return `threadContent` directly — no conditional `if (agentId)` wrapper. The entire function body becomes:
      ```tsx
      return (
        <ThreadWrapper>
          <div className="relative h-full overflow-hidden">
            <ThreadPrimitive.Viewport ref={areaRef} autoScroll={false} className="overflow-y-scroll scroll-smooth h-full">
              <ThreadWelcome agentName={agentName} />
              <div className="max-w-3xl w-full mx-auto px-4 pb-7">
                <ThreadPrimitive.Messages components={{...}} />
              </div>
              <ThreadPrimitive.If empty={false}>
                <div />
              </ThreadPrimitive.If>
            </ThreadPrimitive.Viewport>
            {agentId && <BrowserViewPanel agentId={agentId} />}
          </div>
          <Composer hasMemory={hasMemory} agentId={agentId} />
        </ThreadWrapper>
      );
      ```
    - Keep the `BrowserViewPanel` import — the panel still renders inside Thread for now (Phase 17 extracts it)

    **Update Agent page `index.tsx`** in packages/playground:
    - Add import: `import { BrowserToolCallsProvider, BrowserSessionProvider } from '@mastra/playground-ui';`
      (These are re-exported via context/index.tsx -> agents/index.tsx -> playground-ui/src/index.ts)
    - Wrap the existing `<ThreadInputProvider>` block with both providers. The new nesting inside the `<WorkingMemoryProvider>` should be:
      ```tsx
      <BrowserToolCallsProvider>
        <BrowserSessionProvider>
          <ThreadInputProvider>
            <AgentLayout ...>
              <AgentChat key={threadId} ... />
            </AgentLayout>
          </ThreadInputProvider>
        </BrowserSessionProvider>
      </BrowserToolCallsProvider>
      ```
    - BrowserToolCallsProvider outermost because it has no dependency on BrowserSessionProvider
    - BrowserSessionProvider wraps ThreadInputProvider so both AgentLayout and AgentChat are descendants
    - The key={threadId} on AgentChat stays — Thread remounts on thread switch but providers above it persist (this is by design; tool call history persisting across threads is acceptable for now per research gap analysis)

    IMPORTANT: Do NOT change any other imports, props, or component structure. Only add the two provider wrappers and remove the wrapping from Thread.
  </action>
  <verify>
    Run `cd packages/playground-ui && pnpm build` — must succeed with zero type errors.
    Run `cd packages/playground && pnpm build` — must succeed with zero type errors.
    Grep for `BrowserToolCallsProvider` in thread.tsx — should find zero matches (removed).
    Grep for `BrowserToolCallsProvider` in packages/playground/src/pages/agents/agent/index.tsx — should find one match (the new wrapper).
    Grep for `BrowserSessionProvider` in packages/playground/src/pages/agents/agent/index.tsx — should find one match (the new wrapper).
  </verify>
  <done>
    BrowserToolCallsProvider no longer wraps Thread content. Both BrowserToolCallsProvider and BrowserSessionProvider wrap AgentLayout from the Agent page level. useBrowserToolCalls hook still works inside both ToolFallback (in messages) and BrowserToolCallHistory (in browser panel) because both are descendants of the hoisted provider.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/playground-ui && pnpm build` succeeds with zero errors
2. `cd packages/playground && pnpm build` succeeds with zero errors
3. No visual changes — BrowserViewPanel still renders as an absolute-positioned overlay inside Thread
4. Grep confirmation:
   - `BrowserToolCallsProvider` appears in Agent page index.tsx (1 match) and NOT in thread.tsx (0 matches)
   - `BrowserSessionProvider` appears in Agent page index.tsx (1 match)
   - `useBrowserSession` appears in browser-view-panel.tsx (1 match)
   - `useState.*isVisible` does NOT appear in browser-view-panel.tsx (0 matches — state moved to context)
5. Context barrel file (context/index.tsx) exports both browser-session-context and browser-tool-calls-context
</verification>

<success_criteria>
- BrowserSessionContext provides all 7 fields (isActive, status, currentUrl, show, hide, setStatus, setCurrentUrl)
- BrowserViewPanel consumes BrowserSessionContext instead of local state for visibility and status
- BrowserToolCallsProvider wraps AgentLayout from Agent page level (not inside Thread)
- BrowserSessionProvider wraps AgentLayout from Agent page level
- Both packages build without type errors
- Zero visual or behavioral changes from user perspective
</success_criteria>

<output>
After completion, create `.planning/phases/16-context-infrastructure/16-01-SUMMARY.md`
</output>
