---
phase: 04-testing-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - auth/cloud/vitest.config.ts
  - auth/cloud/src/client.test.ts
  - auth/cloud/src/index.test.ts
autonomous: true

must_haves:
  truths:
    - 'pnpm typecheck passes for auth/cloud package'
    - 'Transport layer tests pass (request, unwrap, CloudApiError)'
    - 'Provider layer tests pass (getCurrentUser, getPermissions, createSession 501)'
    - 'Error paths throw CloudApiError with correct status/code'
  artifacts:
    - path: 'auth/cloud/vitest.config.ts'
      provides: 'Vitest test configuration'
      contains: 'defineConfig'
    - path: 'auth/cloud/src/client.test.ts'
      provides: 'Transport layer unit tests'
      contains: 'MastraCloudClient'
      min_lines: 50
    - path: 'auth/cloud/src/index.test.ts'
      provides: 'Provider layer unit tests'
      contains: 'MastraCloudAuth'
      min_lines: 80
  key_links:
    - from: 'auth/cloud/src/client.test.ts'
      to: "vi.stubGlobal('fetch')"
      via: 'fetch mocking'
      pattern: "vi\\.stubGlobal"
    - from: 'auth/cloud/src/index.test.ts'
      to: "vi.mock('jose')"
      via: 'JWT decode mocking'
      pattern: "vi\\.mock.*jose"
---

<objective>
Validate auth/cloud implementation with unit tests covering transport and provider layers.

Purpose: Prove Phases 1-3 implementation works correctly against mocked Cloud API
Output: Passing test suite with vitest configuration
</objective>

<execution_context>
@/Users/yj/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-testing-validation/04-CONTEXT.md
@.planning/phases/04-testing-validation/04-RESEARCH.md
@auth/cloud/src/client.ts
@auth/cloud/src/index.ts
@auth/auth0/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vitest configuration</name>
  <files>auth/cloud/vitest.config.ts</files>
  <action>
Create vitest.config.ts matching auth/auth0 pattern:
- Import defineConfig from vitest/config
- Set globals: true
- Include pattern: src/**/*.test.ts

Note: package.json already has "test": "vitest run" script and vitest in devDeps.
</action>
<verify>File exists and matches auth/auth0/vitest.config.ts structure</verify>
<done>vitest.config.ts exists with correct include pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create transport layer tests</name>
  <files>auth/cloud/src/client.test.ts</files>
  <action>
Create client.test.ts with vi.stubGlobal('fetch') pattern from RESEARCH.md.

Test cases required:

1. **verifyToken** - valid token returns CloudUser, invalid returns null
2. **getUser** - returns user on success, null on failure
3. **getUserPermissions** - returns permissions array, empty on failure
4. **getLoginUrl** - constructs URL with /auth/oss path, project_id, redirect_uri, state
5. **exchangeCode** - returns user, session, jwt on success
6. **validateSession** - returns session on success, null on failure
7. **destroySession** - makes correct request with token
8. **CloudApiError** - thrown on API failure with correct status/code
9. **request() Authorization header** - Bearer token sent when token provided
10. **response.ok vs json.ok** - handles 200 with ok:false (throws CloudApiError)

Setup pattern:

- beforeEach: save originalFetch, stubGlobal fetch
- afterEach: restoreAllMocks, restore originalFetch

Mock responses must include `{ ok: true, data: {...} }` envelope structure.
</action>
<verify>`cd auth/cloud && pnpm test` passes all client.test.ts tests</verify>
<done>Transport layer: verifyToken, getUser, getLoginUrl, exchangeCode, error paths all tested</done>
</task>

<task type="auto">
  <name>Task 3: Create provider layer tests</name>
  <files>auth/cloud/src/index.test.ts</files>
  <action>
Create index.test.ts with vi.mock('jose') pattern from RESEARCH.md.

Test cases required:

1. **getCurrentUser** - extracts user from JWT in cookie, returns null when no cookie
2. **getUser** - delegates to client with token
3. **createSession** - throws CloudApiError with status 501, code 'not_implemented'
4. **validateSession** - delegates to client
5. **destroySession** - delegates to client
6. **getLoginUrl** - returns correct SSO URL
7. **handleCallback** - exchanges code and returns SSOCallbackResult
8. **getRoles** - extracts role from JWT claims
9. **hasRole** - checks role match
10. **getPermissions** - uses resolvePermissions with role from JWT
11. **hasPermission** - checks permission in resolved list
12. **extractSessionToken** - parses cookie header correctly (edge cases: no cookie, malformed)

Mock jose.decodeJwt to return controlled claims:

```typescript
vi.mock('jose', () => ({
  decodeJwt: vi.fn(),
}));
```

For client method tests, also mock fetch (some provider methods delegate to client).
</action>
<verify>`cd auth/cloud && pnpm test` passes all index.test.ts tests</verify>
<done>Provider layer: all IUserProvider, ISessionProvider, ISSOProvider, IRBACProvider methods tested</done>
</task>

</tasks>

<verification>
1. `cd auth/cloud && pnpm typecheck` - TypeScript compiles without errors
2. `cd auth/cloud && pnpm test` - All tests pass
3. Test output shows both client.test.ts and index.test.ts executed
4. CloudApiError instanceof check works in error tests
</verification>

<success_criteria>

- [ ] vitest.config.ts exists with correct configuration
- [ ] client.test.ts covers transport layer (10+ test cases)
- [ ] index.test.ts covers provider layer (12+ test cases)
- [ ] `pnpm typecheck` passes
- [ ] `pnpm test` passes (all tests green)
- [ ] Error paths throw CloudApiError (not swallowed)
      </success_criteria>

<output>
After completion, create `.planning/phases/04-testing-validation/04-01-SUMMARY.md`
</output>
