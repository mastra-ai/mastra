---
phase: 11-dataset-schema-validation
plan: 06
type: execute
wave: 4
depends_on: ['11-04', '11-05']
files_modified:
  - packages/playground-ui/src/domains/datasets/components/add-item-dialog.tsx
  - packages/playground-ui/src/domains/datasets/components/item-detail-panel.tsx
  - packages/playground-ui/src/domains/datasets/components/csv-import/csv-import-dialog.tsx
autonomous: true

must_haves:
  truths:
    - 'Add item dialog shows field-level validation errors from schema'
    - 'Edit item shows field-level validation errors from schema'
    - 'CSV import confirmation shows validation report with skip count'
    - "Validation errors indicate which field and what's wrong"
  artifacts:
    - path: 'packages/playground-ui/src/domains/datasets/components/add-item-dialog.tsx'
      provides: 'Add item dialog with schema validation error display'
      contains: 'SchemaValidationError'
    - path: 'packages/playground-ui/src/domains/datasets/components/item-detail-panel.tsx'
      provides: 'Item edit with validation error display'
      contains: 'validation'
  key_links:
    - from: 'packages/playground-ui/src/domains/datasets/components/add-item-dialog.tsx'
      to: 'API response'
      via: 'catch block handles 400 with validation errors'
      pattern: 'errors.*path'
---

<objective>
Surface schema validation errors in UI for add item, edit item, and CSV import flows.

Purpose: Clear user feedback when data fails validation.
Output: Field-level error display in all data entry points.
</objective>

<execution_context>
@/Users/yj/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-dataset-schema-validation/11-RESEARCH.md
@.planning/phases/11-dataset-schema-validation/11-04-SUMMARY.md
@.planning/phases/11-dataset-schema-validation/11-05-SUMMARY.md
@packages/playground-ui/src/domains/datasets/components
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation error display to add/edit item dialogs</name>
  <files>
    packages/playground-ui/src/domains/datasets/components/add-item-dialog.tsx
    packages/playground-ui/src/domains/datasets/components/dataset-detail/item-detail-panel.tsx
  </files>
  <action>
1. First, read the existing add-item-dialog.tsx and item-detail-panel.tsx to understand current structure.

2. Create a reusable ValidationErrors component (or inline in each file):

   ```typescript
   interface ValidationError {
     path: string;
     message: string;
   }

   interface ValidationErrorsProps {
     field: 'input' | 'expectedOutput';
     errors: ValidationError[];
   }

   function ValidationErrors({ field, errors }: ValidationErrorsProps) {
     if (!errors.length) return null;

     return (
       <div className="mt-2 space-y-1">
         {errors.map((err, idx) => (
           <p key={idx} className="text-xs text-destructive">
             <code className="bg-destructive/10 px-1 rounded">
               {field}{err.path !== '/' ? err.path : ''}
             </code>
             : {err.message}
           </p>
         ))}
       </div>
     );
   }
   ```

3. Update add-item-dialog.tsx:
   - Add state for validation errors:

     ```typescript
     const [validationErrors, setValidationErrors] = useState<{
       field: 'input' | 'expectedOutput';
       errors: Array<{ path: string; message: string }>;
     } | null>(null);
     ```

   - In submit handler, catch validation errors:

     ```typescript
     try {
       await addItem.mutateAsync({ datasetId, input, expectedOutput, context });
       // success handling...
       setValidationErrors(null);
     } catch (err: any) {
       // Check for schema validation error response
       if (err?.cause?.field && err?.cause?.errors) {
         setValidationErrors({
           field: err.cause.field,
           errors: err.cause.errors,
         });
       } else {
         // Generic error handling
         toast.error(err.message || 'Failed to add item');
       }
     }
     ```

   - Display errors near the relevant field:

     ```typescript
     // After input CodeEditor:
     {validationErrors?.field === 'input' && (
       <ValidationErrors field="input" errors={validationErrors.errors} />
     )}

     // After expectedOutput CodeEditor:
     {validationErrors?.field === 'expectedOutput' && (
       <ValidationErrors field="expectedOutput" errors={validationErrors.errors} />
     )}
     ```

   - Clear errors when input changes:
     ```typescript
     const handleInputChange = (value: string) => {
       setInput(value);
       if (validationErrors?.field === 'input') {
         setValidationErrors(null);
       }
     };
     ```

4. Update item-detail-panel.tsx (edit mode):
   - Similar pattern: add validation error state
   - Catch errors in update handler
   - Display field-level errors
   - Clear errors on input change
     </action>
     <verify>
   - `pnpm typecheck` passes
   - Adding invalid item shows error under relevant field
   - Editing with invalid data shows error under relevant field
   - Errors clear when user starts editing
     </verify>
     <done>Add and edit item dialogs display field-level schema validation errors</done>
     </task>

<task type="auto">
  <name>Task 2: Enhance CSV import confirmation with validation summary</name>
  <files>
    packages/playground-ui/src/domains/datasets/components/csv-import/csv-import-dialog.tsx
  </files>
  <action>
1. Read the existing csv-import-dialog.tsx to understand the current flow.

2. Update the confirmation step to prominently show validation results:
   - If validation was run and has invalid rows:

     ```typescript
     // In confirmation step JSX:
     {validationResult && (
       <div className="space-y-4">
         {/* Summary banner */}
         {validationResult.invalidCount > 0 ? (
           <div className="p-3 bg-warning/10 border border-warning/30 rounded-md">
             <div className="flex items-center gap-2 text-warning">
               <Icon name="alert-triangle" className="w-4 h-4" />
               <span className="font-medium">
                 {validationResult.invalidCount} rows will be skipped
               </span>
             </div>
             <p className="text-sm text-muted-foreground mt-1">
               {validationResult.validCount} of {validationResult.totalRows} rows will be imported
             </p>
           </div>
         ) : (
           <div className="p-3 bg-success/10 border border-success/30 rounded-md">
             <div className="flex items-center gap-2 text-success">
               <Icon name="check-circle" className="w-4 h-4" />
               <span className="font-medium">
                 All {validationResult.totalRows} rows are valid
               </span>
             </div>
           </div>
         )}

         {/* Detailed validation report */}
         {validationResult.invalidCount > 0 && (
           <ValidationReport result={validationResult} />
         )}
       </div>
     )}
     ```

3. Update the "Import" button label to reflect what will happen:

   ```typescript
   <Button onClick={handleImport} disabled={importing || validationResult?.validCount === 0}>
     {importing ? 'Importing...' : (
       validationResult?.invalidCount
         ? `Import ${validationResult.validCount} valid rows`
         : `Import ${validationResult?.totalRows || 0} rows`
     )}
   </Button>
   ```

4. If no valid rows, disable import and show message:

   ```typescript
   {validationResult?.validCount === 0 && (
     <p className="text-sm text-destructive">
       No valid rows to import. Please fix the data or adjust the schema.
     </p>
   )}
   ```

5. After successful import, show summary:
   ```typescript
   toast.success(
     validationResult?.invalidCount
       ? `Imported ${validationResult.validCount} rows (${validationResult.invalidCount} skipped)`
       : `Imported ${validationResult?.totalRows} rows`,
   );
   ```
     </action>
     <verify>
       - `pnpm build` succeeds
       - CSV import shows validation summary before confirming
       - Skipped rows are clearly indicated
       - Import button shows count of valid rows
       - Success toast shows imported/skipped counts
     </verify>
     <done>CSV import confirmation shows clear validation summary with skip counts</done>
   </task>

</tasks>

<verification>
1. `cd packages/playground-ui && pnpm build` succeeds
2. Adding item with invalid input shows error: "input/name: must be string"
3. Editing item with invalid expectedOutput shows error below that field
4. CSV import with mixed valid/invalid rows shows: "X rows will be skipped"
5. CSV import shows detailed table of failing rows
6. Cannot import when all rows are invalid
</verification>

<success_criteria>

- Add item: validation errors appear under the failing field (input or expectedOutput)
- Edit item: same behavior as add item
- CSV import: confirmation step shows banner with skip count
- CSV import: detailed table shows first 10 failing rows with row number and error
- CSV import: button label reflects actual import count
  </success_criteria>

<output>
After completion, create `.planning/phases/11-dataset-schema-validation/11-06-SUMMARY.md`
</output>
