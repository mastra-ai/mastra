---
phase: 07-v2-tripwire
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/core/src/workflows/evented/execution-engine.ts
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Workflow result status is 'tripwire' when step fails due to TripWire"
    - "Workflow result includes tripwire field with reason, retry, metadata, processorId"
    - "TripWire tests pass for input processor and output stream processor"
    - "V2 model tests pass for agentOptions and structured output"
  artifacts:
    - path: "packages/core/src/workflows/evented/execution-engine.ts"
      provides: "TripWire status propagation"
      contains: "tripwire"
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "Unskipped and passing tests"
      contains: "it('should bubble up tripwire"
  key_links:
    - from: "packages/core/src/workflows/evented/execution-engine.ts"
      to: "step results"
      via: "tripwire field detection"
      pattern: "tripwireData"
    - from: "packages/core/src/workflows/evented/execution-engine.ts"
      to: "lifecycle callbacks"
      via: "tripwire parameter"
      pattern: "tripwire:"
---

<objective>
Propagate TripWire status from step results to workflow results and verify all V2/TripWire tests pass.

Purpose: Complete the TripWire error flow so that when an agent output processor throws TripWire, the workflow result reflects 'tripwire' status instead of 'failed', matching default runtime behavior.

Output: Modified execution-engine.ts with tripwire propagation and 4 unskipped passing tests.
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-v2-tripwire/07-RESEARCH.md

# Prior plan summary (contains implementation details)
@.planning/phases/07-v2-tripwire/07-01-SUMMARY.md

# Source files to modify
@packages/core/src/workflows/evented/execution-engine.ts
@packages/core/src/workflows/evented/evented-workflow.test.ts

# Reference implementations (default runtime patterns to match)
@packages/core/src/workflows/default.ts
@packages/core/src/agent/trip-wire.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TripWire status propagation in EventedExecutionEngine</name>
  <files>packages/core/src/workflows/evented/execution-engine.ts</files>
  <action>
Update the `execute` method to detect tripwire data in step results and propagate tripwire status.

1. Add import at top of file:
   ```typescript
   import { TripWire } from '../../agent/trip-wire';
   import type { StepTripwireInfo } from '../types';
   ```

2. Update the result handling section (around lines 193-281) to check for tripwire:
   - When `resultData.prevResult.status === 'failed'`, check if there's tripwire data
   - Look for tripwire in the step results that failed

3. Find the failed step with tripwire data. The tripwire will be on the step result, not on prevResult directly. Update the logic around line 256:

   ```typescript
   } else if (resultData.prevResult.status === 'failed') {
     // Check if failure was due to TripWire
     let tripwireData: StepTripwireInfo | undefined;

     // Find tripwire from step results
     for (const stepResult of Object.values(cleanStepResults)) {
       if (stepResult?.status === 'failed' && stepResult?.tripwire) {
         tripwireData = stepResult.tripwire;
         break;
       }
     }

     if (tripwireData && typeof tripwireData === 'object' && 'reason' in tripwireData) {
       result = {
         status: 'tripwire',
         tripwire: tripwireData,
         steps: callbackArg.steps,
       } as TOutput;
     } else {
       result = {
         status: callbackArg.status,
         error: callbackArg.error,
         steps: callbackArg.steps,
       } as TOutput;
     }
   }
   ```

4. Update the lifecycle callback invocation (around line 228) to include tripwire:
   ```typescript
   await this.invokeLifecycleCallbacks({
     status: callbackArg.status,
     result: callbackArg.result,
     error: callbackArg.error,
     steps: callbackArg.steps,
     tripwire: tripwireData,  // Add this
     // ... rest of params
   });
   ```

5. Also update the callbackArg building to track tripwire status:
   ```typescript
   if (resultData.prevResult.status === 'failed') {
     // Find tripwire first
     let tripwireData: StepTripwireInfo | undefined;
     for (const stepResult of Object.values(cleanStepResults)) {
       if (stepResult?.status === 'failed' && stepResult?.tripwire) {
         tripwireData = stepResult.tripwire;
         break;
       }
     }

     callbackArg = {
       status: tripwireData ? 'tripwire' : 'failed',
       error: tripwireData ? undefined : resultData.prevResult.error,
       steps: cleanStepResults,
       state: finalState,
       tripwire: tripwireData,
     };
   }
   ```

Reference: default.ts:496-518 for the exact status propagation pattern.

Important: TripWire instances lose their prototype chain when crossing pubsub boundaries, so always check for plain object with duck-typing (`'reason' in tripwireData`) rather than `instanceof TripWire`.
  </action>
  <verify>
Build succeeds: `cd packages/core && pnpm build`
TypeScript compiles without errors.
  </verify>
  <done>
EventedExecutionEngine detects tripwire in step results and sets workflow result status to 'tripwire' with tripwire data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unskip and verify V2 model and TripWire tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Remove `.skip` from the 4 tests that were waiting for V2 model and TripWire support.

1. Line 12648: Change `it.skip(` to `it(` for:
   "should bubble up tripwire from agent input processor to workflow result"

2. Line 12741: Change `it.skip(` to `it(` for:
   "should handle tripwire from output stream processor in agent within workflow"

3. Line 12831: Change `it.skip(` to `it(` for:
   "should pass agentOptions when wrapping agent with createStep"

4. Line 12935: Change `it.skip(` to `it(` for:
   "should pass structured output from agent step to next step with correct types"

5. Remove the skip reason comments from each test description (the "- evented runtime..." suffix).

Example transformation:
```typescript
// Before
it.skip('should bubble up tripwire from agent input processor to workflow result - evented runtime does not support tripwire propagation', async () => {

// After
it('should bubble up tripwire from agent input processor to workflow result', async () => {
```
  </action>
  <verify>
Run the specific tests:
```bash
cd packages/core && pnpm test -- --grep "tripwire" --grep "V2" --reporter=verbose
```

Or run the full test suite (may take longer):
```bash
cd packages/core && pnpm test evented-workflow.test.ts
```

All 4 unskipped tests should pass.
  </verify>
  <done>
4 tests unskipped and passing:
- tripwire from input processor
- tripwire from output stream processor
- V2 model with agentOptions
- V2 model with structured output
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd packages/core && pnpm build` succeeds
2. `cd packages/core && pnpm typecheck` passes
3. Run tripwire tests: `cd packages/core && pnpm test -- --grep "tripwire"`
4. Run V2 model tests: `cd packages/core && pnpm test -- --grep "V2 model\|structured output from agent step"`
5. Verify no regressions: `cd packages/core && pnpm test evented-workflow.test.ts`
</verification>

<success_criteria>
- Workflow result status is 'tripwire' when step fails due to TripWire (not 'failed')
- Workflow result.tripwire contains { reason, retry, metadata, processorId }
- All 4 previously-skipped tests now pass
- No test regressions in evented-workflow.test.ts
</success_criteria>

<output>
After completion, create `.planning/phases/07-v2-tripwire/07-02-SUMMARY.md`
</output>
