---
phase: 07-v2-tripwire
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/workflow.ts
  - packages/core/src/workflows/evented/step-executor.ts
autonomous: true

must_haves:
  truths:
    - "Agent step detects V2 models via isSupportedLanguageModel check"
    - "Agent step uses .stream() for V2+ models instead of .streamLegacy()"
    - "TripWire errors in step execution are caught and serialized with explicit fields"
    - "Serialized tripwire data includes reason, retry, metadata, processorId"
  artifacts:
    - path: "packages/core/src/workflows/evented/workflow.ts"
      provides: "V2 model branching in createStepFromAgent"
      contains: "isSupportedLanguageModel"
    - path: "packages/core/src/workflows/evented/step-executor.ts"
      provides: "TripWire catching and serialization"
      contains: "instanceof TripWire"
  key_links:
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "agent/utils.ts"
      via: "import isSupportedLanguageModel"
      pattern: "isSupportedLanguageModel"
    - from: "packages/core/src/workflows/evented/step-executor.ts"
      to: "agent/trip-wire.ts"
      via: "import TripWire"
      pattern: "TripWire"
---

<objective>
Implement V2 model detection in agent steps and TripWire error catching in step execution.

Purpose: Enable evented workflow agent steps to work with V2 models (required for structured output, tripwire chunks) and capture TripWire errors from processors for proper workflow status propagation.

Output: Modified workflow.ts with V2 model branching and step-executor.ts with TripWire serialization.
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-v2-tripwire/07-RESEARCH.md

# Source files to modify
@packages/core/src/workflows/evented/workflow.ts
@packages/core/src/workflows/evented/step-executor.ts

# Reference implementations (default runtime patterns to match)
@packages/core/src/workflows/default.ts
@packages/core/src/agent/utils.ts
@packages/core/src/agent/trip-wire.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add V2 model detection and branching in createStepFromAgent</name>
  <files>packages/core/src/workflows/evented/workflow.ts</files>
  <action>
Update the `createStepFromAgent` function (around line 327-393) to detect V2+ models and use the appropriate streaming method.

1. Add import at top of file:
   ```typescript
   import { isSupportedLanguageModel } from '../../agent/utils';
   ```

2. In the `execute` function of createStepFromAgent (around line 327):
   - Get LLM from agent: `const llm = await params.getLLM({ requestContext });`
   - Check model version: `const modelInfo = llm.getModel();`
   - Branch based on version:
     - If `isSupportedLanguageModel(modelInfo)`: use `params.stream()` (V2+)
     - Else: use `params.streamLegacy()` (V1)

3. For V2 path, the `.stream()` method returns a `MastraModelOutput` directly. You need to:
   - Await the result: `const modelOutput = await params.stream(prompt, options);`
   - Get text from modelOutput.text promise
   - Handle the fullStream for watch events

4. Keep the existing streamLegacy path as fallback for V1 models.

Reference the default runtime's agent.ts:3424-3442 for the pattern. The key difference is that evented workflow needs to handle the stream for pubsub events.

Important: The V2 `.stream()` method throws if model is V1, so version check is critical before calling.
  </action>
  <verify>
Build succeeds: `cd packages/core && pnpm build`
TypeScript compiles without errors.
  </verify>
  <done>
createStepFromAgent checks model version and uses .stream() for V2+ models, .streamLegacy() for V1 models.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TripWire catching and serialization in StepExecutor</name>
  <files>packages/core/src/workflows/evented/step-executor.ts</files>
  <action>
Update the `execute` method's catch block (lines 213-227) to detect and serialize TripWire errors.

1. Add import at top of file:
   ```typescript
   import { TripWire } from '../../agent/trip-wire';
   ```

2. In the catch block (around line 213), after getting errorInstance:
   ```typescript
   } catch (error: any) {
     const endedAt = Date.now();

     const errorInstance = getErrorFromUnknown(error, {
       serializeStack: false,
       fallbackMessage: 'Unknown step execution error',
     });

     return {
       ...stepInfo,
       status: 'failed',
       endedAt,
       error: errorInstance,
       // Preserve TripWire data as plain object for proper serialization
       tripwire:
         error instanceof TripWire
           ? {
               reason: error.message,
               retry: error.options?.retry,
               metadata: error.options?.metadata,
               processorId: error.processorId,
             }
           : undefined,
     };
   }
   ```

3. Important: Check `error instanceof TripWire` NOT `errorInstance instanceof TripWire` because getErrorFromUnknown converts the error and loses the prototype chain.

Reference: default.ts:446-462 for the exact pattern.
  </action>
  <verify>
Build succeeds: `cd packages/core && pnpm build`
TypeScript compiles without errors.
  </verify>
  <done>
StepExecutor catch block detects TripWire errors and serializes them with { reason, retry, metadata, processorId } structure.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd packages/core && pnpm build` succeeds
2. `cd packages/core && pnpm typecheck` passes
3. Grep confirms patterns exist:
   - `grep -n "isSupportedLanguageModel" packages/core/src/workflows/evented/workflow.ts`
   - `grep -n "instanceof TripWire" packages/core/src/workflows/evented/step-executor.ts`
</verification>

<success_criteria>
- createStepFromAgent detects V2 models using isSupportedLanguageModel
- createStepFromAgent branches to .stream() for V2+, .streamLegacy() for V1
- StepExecutor catches TripWire errors and serializes with explicit type markers
- Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-v2-tripwire/07-01-SUMMARY.md`
</output>
