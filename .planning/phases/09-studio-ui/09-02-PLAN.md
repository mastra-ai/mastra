---
phase: 09-studio-ui
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
  - packages/playground-ui/src/domains/agents/components/agent-layout.tsx
  - packages/playground-ui/src/domains/agents/components/browser-view/index.ts
autonomous: false

must_haves:
  truths:
    - "Browser panel appears as right sidebar when browser is streaming"
    - "Panel is resizable with drag handle"
    - "Panel auto-hides when browser is not active (idle/closed)"
    - "Panel shows loading skeleton during browser_starting"
    - "Panel fades out when browser closes"
  artifacts:
    - path: "packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx"
      provides: "Complete browser view panel with states"
      exports: ["BrowserViewPanel"]
    - path: "packages/playground-ui/src/domains/agents/components/agent-layout.tsx"
      provides: "AgentLayout with browserSlot"
      exports: ["AgentLayout", "AgentLayoutProps"]
  key_links:
    - from: "browser-view-panel.tsx"
      to: "browser-view-frame.tsx"
      via: "renders BrowserViewFrame"
      pattern: "<BrowserViewFrame"
    - from: "browser-view-panel.tsx"
      to: "browser-view-header.tsx"
      via: "renders BrowserViewHeader"
      pattern: "<BrowserViewHeader"
    - from: "agent-layout.tsx"
      to: "browser-view-panel.tsx"
      via: "browserSlot prop renders panel"
      pattern: "browserSlot"
---

<objective>
Assemble the BrowserViewPanel and integrate it into AgentLayout.

Purpose: Complete the browser view feature by combining components into a panel and adding it to the agent interface.
Output: Working browser panel that appears/disappears based on browser activity
</objective>

<execution_context>
@/Users/abhiramaiyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhiramaiyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-studio-ui/09-CONTEXT.md
@.planning/phases/09-studio-ui/09-01-SUMMARY.md
@packages/playground-ui/src/domains/agents/components/agent-layout.tsx
@packages/playground-ui/src/lib/resize/collapsible-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrowserViewPanel component</name>
  <files>
packages/playground-ui/src/domains/agents/components/browser-view/browser-view-panel.tsx
packages/playground-ui/src/domains/agents/components/browser-view/index.ts
  </files>
  <action>
Create the main panel component that assembles frame, header, and handles visibility.

**BrowserViewPanel (`browser-view-panel.tsx`):**

```typescript
interface BrowserViewPanelProps {
  agentId: string;
  className?: string;
}
```

**State management:**
1. Track `status` and `currentUrl` from BrowserViewFrame callbacks
2. Track `isVisible` for fade animation (use useState)
3. Track `shouldRender` for actual DOM presence (derived from status)

**Visibility logic:**
- `shouldRender = status !== 'idle'` (render panel when not idle)
- When status changes TO 'idle' (browser closed):
  1. Start fade-out animation (`isVisible = false`)
  2. After animation completes (~300ms), set `shouldRender = false`
- When status changes FROM 'idle' to anything else:
  1. Set `shouldRender = true`
  2. Trigger fade-in (`isVisible = true`)

**Component structure:**
```jsx
<div className={cn(
  "flex flex-col h-full bg-surface1 transition-opacity duration-300",
  isVisible ? "opacity-100" : "opacity-0",
  className
)}>
  <BrowserViewHeader url={currentUrl} status={status} />
  <div className="flex-1 p-2 overflow-hidden">
    <BrowserViewFrame
      agentId={agentId}
      onStatusChange={setStatus}
      onUrlChange={setCurrentUrl}
    />
  </div>
</div>
```

**Handle the fade-out timing:**
Use useEffect to delay removal after fade completes:
```typescript
useEffect(() => {
  if (status === 'idle') {
    const timer = setTimeout(() => setDelayedHide(true), 300);
    return () => clearTimeout(timer);
  } else {
    setDelayedHide(false);
  }
}, [status]);
```

Return `null` when `delayedHide && status === 'idle'`.

**Update index.ts:**
Add export: `export { BrowserViewPanel } from './browser-view-panel';`
  </action>
  <verify>
```bash
cd packages/playground-ui && pnpm tsc --noEmit
grep "BrowserViewPanel" src/domains/agents/components/browser-view/index.ts
```
  </verify>
  <done>
BrowserViewPanel assembles frame and header, handles visibility with fade animation, exports from index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add browserSlot to AgentLayout</name>
  <files>packages/playground-ui/src/domains/agents/components/agent-layout.tsx</files>
  <action>
Extend AgentLayout to support a browser panel slot.

**Update AgentLayoutProps:**
```typescript
export interface AgentLayoutProps {
  agentId: string;
  children: React.ReactNode;
  leftSlot?: React.ReactNode;
  rightSlot?: React.ReactNode;
  browserSlot?: React.ReactNode;  // NEW
}
```

**Layout structure when browserSlot is present:**
The browser panel should appear to the RIGHT of the existing rightSlot, as an additional collapsible panel.

```jsx
{/* Existing right slot */}
{rightSlot && (
  <>
    <PanelSeparator />
    <CollapsiblePanel direction="right" id="right-slot" ...>
      {rightSlot}
    </CollapsiblePanel>
  </>
)}

{/* NEW: Browser slot - additional right panel */}
{browserSlot && (
  <>
    <PanelSeparator />
    <CollapsiblePanel
      direction="right"
      id="browser-slot"
      minSize={300}
      maxSize={'50%'}
      defaultSize={400}
      collapsedSize={60}
      collapsible={true}
    >
      {browserSlot}
    </CollapsiblePanel>
  </>
)}
```

**Key settings for browser panel:**
- `minSize={300}` - minimum usable width for viewing
- `maxSize={'50%'}` - don't take over the whole screen
- `defaultSize={400}` - ~500px per CONTEXT.md (close enough with flex)
- `collapsedSize={60}` - consistent with other panels
- `id="browser-slot"` - unique for layout persistence

**Layout ID update:**
The useDefaultLayout id should include browser state for separate persistence:
```typescript
const { defaultLayout, onLayoutChange } = useDefaultLayout({
  id: `agent-layout-${agentId}${browserSlot ? '-browser' : ''}`,
  storage: localStorage,
});
```

This ensures the layout widths are remembered separately when browser is present vs not.
  </action>
  <verify>
```bash
cd packages/playground-ui && pnpm tsc --noEmit
grep "browserSlot" src/domains/agents/components/agent-layout.tsx
```
  </verify>
  <done>
AgentLayout accepts browserSlot prop. Browser panel renders as additional right panel with CollapsiblePanel. Layout persistence uses separate ID when browser is present.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete browser view panel integrated into agent layout:
- useBrowserStream hook with WebSocket management and auto-reconnect
- BrowserViewFrame with useRef pattern for performant frame updates
- BrowserViewHeader with URL display and status indicator
- BrowserViewPanel that fades in/out based on browser activity
- AgentLayout with new browserSlot prop
  </what-built>
  <how-to-verify>
1. Start the playground dev server:
   ```bash
   cd packages/playground-ui && pnpm dev
   ```

2. Navigate to an agent page in the browser

3. To test the components, you'll need to:
   - Temporarily add `<BrowserViewPanel agentId={agentId} />` to the browserSlot in where AgentLayout is used
   - Or verify the components build and export correctly

4. Verify visually:
   - Panel appears as right sidebar (when browser would be active)
   - Status badge shows correct states
   - Panel is resizable with drag handle
   - Skeleton shows during loading state

5. If no browser toolset is configured (likely), verify:
   - Panel handles connection gracefully
   - No console errors from WebSocket failures
   - Components render without crashing

Note: Full E2E testing requires a running browser toolset. For now, verify:
- TypeScript compiles: `pnpm tsc --noEmit`
- Package builds: `pnpm build`
- Components export correctly from index
  </how-to-verify>
  <resume-signal>Type "approved" if components build and look correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes in playground-ui
2. `pnpm build` succeeds in playground-ui
3. BrowserViewPanel exported from index
4. AgentLayout has browserSlot in interface and implementation
5. CollapsiblePanel wraps browser slot with correct settings
</verification>

<success_criteria>
- BrowserViewPanel assembles all components with proper visibility logic
- AgentLayout accepts and renders browserSlot as additional right panel
- Panel is resizable and collapsible
- Fade animation on browser close
- TypeScript compiles and package builds
</success_criteria>

<output>
After completion, create `.planning/phases/09-studio-ui/09-02-SUMMARY.md`
</output>
