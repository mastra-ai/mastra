---
phase: 02-api-paths-methods
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - auth/cloud/src/client.ts
autonomous: true

must_haves:
  truths:
    - 'getLoginUrl() returns URL with /auth/oss path'
    - 'All authenticated endpoints use /api/v1/ prefix'
    - 'getUser() accepts options object with userId and token'
    - 'getUserPermissions() accepts options object with userId and token'
    - 'All methods use request<T>() helper instead of raw fetch'
    - 'createSession() removed from client'
  artifacts:
    - path: 'auth/cloud/src/client.ts'
      provides: 'Migrated API client methods'
      exports: ['MastraCloudClient', 'CloudUser', 'CloudSession', 'CloudApiError']
      contains: '/api/v1/'
  key_links:
    - from: 'verifyToken()'
      to: 'request<T>()'
      via: 'internal call'
      pattern: "this\\.request<"
    - from: 'getUser()'
      to: 'request<T>()'
      via: 'internal call with token'
      pattern: "this\\.request<.*token"
    - from: 'getUserPermissions()'
      to: 'request<T>()'
      via: 'internal call with token'
      pattern: "this\\.request<.*token"
---

<objective>
Migrate all MastraCloudClient methods to use request<T>() helper with correct API paths.

Purpose: Client methods currently use raw fetch with old paths. Phase 1 built the transport layer — this phase wires all methods to use it with correct /api/v1/ prefix.

Output: Updated client.ts where every method uses request<T>() and all paths match Cloud spec.
</objective>

<execution_context>
@/Users/yj/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-transport-layer/01-01-SUMMARY.md
@auth/cloud/src/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update config and add option interfaces</name>
  <files>auth/cloud/src/client.ts</files>
  <action>
Update MastraCloudClientConfig interface:
- Add `apiPrefix?: string` — defaults to '/api/v1'
- Add `authPath?: string` — defaults to '/auth/oss'

Update constructor:

- Store apiPrefix (default '/api/v1')
- Store authPath (default '/auth/oss')
- Normalize baseUrl to remove trailing slash if present

Add option interfaces for methods that need them (per CONTEXT.md decision: all methods use options pattern):

```typescript
interface GetUserOptions {
  userId: string;
  token: string;
}

interface GetUserPermissionsOptions {
  userId: string;
  token: string;
}

interface DestroySessionOptions {
  sessionId: string;
  token?: string; // optional for backwards compat
}

interface GetLoginUrlOptions {
  redirectUri: string;
  state: string;
}

interface ExchangeCodeOptions {
  code: string;
}

interface VerifyTokenOptions {
  token: string;
}

interface ValidateSessionOptions {
  sessionToken: string;
}
```

Keep interfaces internal (not exported) — only client class is public API.
</action>
<verify>
TypeScript compiles: `cd auth/cloud && npx tsc --noEmit`
Config interface has apiPrefix and authPath fields.
</verify>
<done>
MastraCloudClientConfig has apiPrefix/authPath, constructor stores them with defaults, all option interfaces exist.
</done>
</task>

<task type="auto">
  <name>Task 2: Migrate all methods to request helper</name>
  <files>auth/cloud/src/client.ts</files>
  <action>
Migrate each method to use request<T>() with new paths:

**verifyToken(options: VerifyTokenOptions):**

- Path: `${this.apiPrefix}/auth/verify`
- Method: POST
- Body: `{ token: options.token }`
- Returns: `CloudUser | null`
- Use request<T>(), catch CloudApiError -> return null

**validateSession(options: ValidateSessionOptions):**

- Path: `${this.apiPrefix}/auth/session/validate`
- Method: POST
- Body: `{ token: options.sessionToken }`
- Returns: `CloudSession | null`
- Use request<T>(), catch CloudApiError -> return null

**createSession() — REMOVE:**

- Delete this method entirely from client
- Cloud doesn't support session creation — handled in index.ts Phase 3

**destroySession(options: DestroySessionOptions):**

- Path: `${this.apiPrefix}/auth/session/destroy`
- Method: POST
- Body: `{ sessionId: options.sessionId }`
- Token: options.token if provided
- Returns: void
- Use request<T>()

**getUser(options: GetUserOptions):**

- Path: `${this.apiPrefix}/users/${options.userId}`
- Method: GET
- Token: options.token (required)
- Returns: `CloudUser | null`
- Use request<T>(), catch CloudApiError -> return null

**getUserPermissions(options: GetUserPermissionsOptions):**

- Path: `${this.apiPrefix}/users/${options.userId}/permissions`
- Method: GET
- Token: options.token (required)
- Returns: `string[]`
- Use request<T>(), catch CloudApiError -> return []

**getLoginUrl(options: GetLoginUrlOptions):**

- Path: `${this.baseUrl}${this.authPath}?${params}`
- Change `/auth/login` to use `this.authPath` (defaults to '/auth/oss')
- Synchronous, no request<T>() needed

**exchangeCode(options: ExchangeCodeOptions):**

- Path: `${this.apiPrefix}/auth/callback`
- Method: POST
- Body: `{ code: options.code }`
- Returns: `{ user: CloudUser; session: CloudSession }`
- Use request<T>(), throw on error (no null return)

**Error handling pattern:**

- Methods that return null on failure: wrap in try/catch, return null/[] on CloudApiError
- Methods that throw on failure: let CloudApiError propagate

**Remove old response interfaces:**
Delete VerifyTokenResponse, ValidateSessionResponse, CreateSessionResponse, GetUserResponse, GetPermissionsResponse, ExchangeCodeResponse — no longer needed when using request<T>() with direct types.

**Keep parseUser/parseSession private methods** — still needed for response transformation.
</action>
<verify>

1. TypeScript compiles: `cd auth/cloud && npx tsc --noEmit`
2. No raw fetch calls remain (except in request<T>())
3. All paths use ${this.apiPrefix} pattern
4. getLoginUrl uses ${this.authPath}
5. createSession method no longer exists
   </verify>
   <done>

- All 7 remaining methods use request<T>() helper
- createSession removed from client
- All paths use /api/v1/ prefix
- getLoginUrl uses /auth/oss path
- Methods accept options objects, not positional params
  </done>
  </task>

</tasks>

<verification>
1. `cd auth/cloud && npx tsc --noEmit` — compiles without errors
2. `grep -c "fetch(" auth/cloud/src/client.ts` — returns 1 (only in request<T>())
3. `grep "/api/v1/" auth/cloud/src/client.ts` — shows all migrated paths
4. `grep "createSession" auth/cloud/src/client.ts` — returns 0 (method removed)
5. `grep "/auth/oss" auth/cloud/src/client.ts` — shows authPath default
</verification>

<success_criteria>

- TypeScript compiles with no errors
- All methods use request<T>() instead of raw fetch
- API paths use /api/v1/ prefix
- Login URL uses /auth/oss path
- getUser and getUserPermissions accept token in options
- createSession removed from client
- No old response interfaces remain
  </success_criteria>

<output>
After completion, create `.planning/phases/02-api-paths-methods/02-01-SUMMARY.md`
</output>
