---
phase: 07-csv-import
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - packages/playground-ui/src/domains/datasets/components/csv-import/csv-import-dialog.tsx
  - packages/playground-ui/src/domains/datasets/components/csv-import/csv-upload-step.tsx
  - packages/playground-ui/src/domains/datasets/components/csv-import/csv-preview-table.tsx
  - packages/playground-ui/src/domains/datasets/components/csv-import/validation-summary.tsx
  - packages/playground-ui/src/domains/datasets/components/csv-import/index.ts
autonomous: true

must_haves:
  truths:
    - "User can upload a CSV file via file input or drag-drop"
    - "User sees preview of first 5 rows with headers"
    - "User can map columns via drag-drop interface"
    - "Validation errors shown with row numbers before import"
    - "Import progress shown during sequential item creation"
    - "Successful import closes dialog and refreshes items list"
  artifacts:
    - path: "packages/playground-ui/src/domains/datasets/components/csv-import/csv-import-dialog.tsx"
      provides: "Multi-step import dialog orchestrating full flow"
      exports: ["CSVImportDialog"]
    - path: "packages/playground-ui/src/domains/datasets/components/csv-import/csv-upload-step.tsx"
      provides: "File upload dropzone component"
      exports: ["CSVUploadStep"]
    - path: "packages/playground-ui/src/domains/datasets/components/csv-import/csv-preview-table.tsx"
      provides: "Preview table showing parsed data"
      exports: ["CSVPreviewTable"]
    - path: "packages/playground-ui/src/domains/datasets/components/csv-import/validation-summary.tsx"
      provides: "Validation error display"
      exports: ["ValidationSummary"]
    - path: "packages/playground-ui/src/domains/datasets/components/csv-import/index.ts"
      provides: "Barrel export"
      exports: ["CSVImportDialog"]
  key_links:
    - from: "csv-import-dialog.tsx"
      to: "use-csv-parser.ts"
      via: "hook import"
      pattern: "useCSVParser"
    - from: "csv-import-dialog.tsx"
      to: "use-column-mapping.ts"
      via: "hook import"
      pattern: "useColumnMapping"
    - from: "csv-import-dialog.tsx"
      to: "use-dataset-mutations.ts"
      via: "addItem mutation"
      pattern: "addItem\\.mutateAsync"
---

<objective>
Create the full CSV import dialog with multi-step flow.

Purpose: Complete import workflow from upload through validation to item creation
Output: CSVImportDialog component ready for integration into dataset detail page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-csv-import/07-CONTEXT.md
@.planning/phases/07-csv-import/07-RESEARCH.md
@.planning/phases/07-csv-import/07-01-SUMMARY.md
@.planning/phases/07-csv-import/07-02-SUMMARY.md
@packages/playground-ui/src/domains/datasets/components/add-item-dialog.tsx
@packages/playground-ui/src/domains/datasets/hooks/use-dataset-mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file upload step component</name>
  <files>packages/playground-ui/src/domains/datasets/components/csv-import/csv-upload-step.tsx</files>
  <action>
    Create csv-upload-step.tsx:

    1. Props interface:
       ```typescript
       interface CSVUploadStepProps {
         onFileSelect: (file: File) => void;
         isParsing: boolean;
         error?: string | null;
       }
       ```

    2. Render a styled dropzone area:
       - Use hidden `<input type="file" accept=".csv" />` with ref
       - Click on dropzone triggers file input click
       - Support drag-over state (highlight border)
       - Handle onDrop event to extract file
       - Show upload icon (Upload from lucide-react) and instructions

    3. States:
       - Default: "Click to upload or drag and drop CSV file"
       - Drag over: highlight border
       - Parsing: show loading spinner or "Parsing..."
       - Error: show error message in red

    4. Use existing design tokens for styling (surface1, neutral3, etc.)
  </action>
  <verify>
    TypeScript compiles: `cd packages/playground-ui && pnpm tsc --noEmit`
  </verify>
  <done>File upload dropzone accepts CSV files and reports selection</done>
</task>

<task type="auto">
  <name>Task 2: Create preview table and validation summary components</name>
  <files>
    packages/playground-ui/src/domains/datasets/components/csv-import/csv-preview-table.tsx
    packages/playground-ui/src/domains/datasets/components/csv-import/validation-summary.tsx
  </files>
  <action>
    **csv-preview-table.tsx:**

    1. Props interface:
       ```typescript
       interface CSVPreviewTableProps {
         headers: string[];
         data: Record<string, unknown>[];
         maxRows?: number; // default 5
       }
       ```

    2. Render simple table using existing ds/Table components:
       - Header row with column names
       - First N data rows
       - Truncate long values (max 50 chars)
       - Show "(showing N of M rows)" below table

    3. Use existing Table, Thead, Tbody, Th, Row, Cell from design system

    **validation-summary.tsx:**

    1. Props interface:
       ```typescript
       interface ValidationSummaryProps {
         errors: Array<{ row: number; column: string; message: string }>;
       }
       ```

    2. If no errors: return null (don't render)

    3. If errors:
       - Show error count header: "N validation errors found"
       - List errors grouped or just flat list:
         "Row N: [column] - [message]"
       - Use existing Alert/error styling from design system
       - Scrollable if many errors (max-h with overflow-y-auto)
  </action>
  <verify>
    TypeScript compiles: `cd packages/playground-ui && pnpm tsc --noEmit`
  </verify>
  <done>Preview table shows CSV data, validation summary shows errors</done>
</task>

<task type="auto">
  <name>Task 3: Create main CSV import dialog</name>
  <files>
    packages/playground-ui/src/domains/datasets/components/csv-import/csv-import-dialog.tsx
    packages/playground-ui/src/domains/datasets/components/csv-import/index.ts
  </files>
  <action>
    **csv-import-dialog.tsx:**

    1. Props interface:
       ```typescript
       interface CSVImportDialogProps {
         datasetId: string;
         open: boolean;
         onOpenChange: (open: boolean) => void;
         onSuccess?: () => void;
       }
       ```

    2. State machine for steps:
       ```typescript
       type ImportStep = 'upload' | 'preview' | 'mapping' | 'importing' | 'complete';
       ```

    3. Step: 'upload'
       - Render CSVUploadStep
       - On file select: call parseFile from useCSVParser
       - On parse success: store ParsedCSV, advance to 'preview'

    4. Step: 'preview'
       - Render CSVPreviewTable with parsed data
       - Initialize column mapping via useColumnMapping
       - "Next" button advances to 'mapping'
       - "Back" button returns to 'upload'

    5. Step: 'mapping'
       - Render ColumnMappingStep
       - Show preview table below for reference
       - "Validate & Import" button:
         - Run validateMappedData
         - If valid: advance to 'importing'
         - If errors: show ValidationSummary, stay on step
       - "Back" button returns to 'preview'

    6. Step: 'importing'
       - Show progress: "Importing N of M items..."
       - Loop through parsed data rows
       - For each row, construct item from mapping:
         - input: value from column mapped to 'input'
         - expectedOutput: value from column mapped to 'expectedOutput' (or undefined)
         - metadata: combine all columns mapped to 'metadata' into object (or undefined)
       - Call addItem.mutateAsync for each
       - Track success/error counts
       - On complete: advance to 'complete'
       - Allow cancel (stop importing, show partial results)

    7. Step: 'complete'
       - Show success message: "Imported N items (M errors)"
       - "Done" button closes dialog, calls onSuccess

    8. Dialog uses existing Dialog pattern from add-item-dialog.tsx

    **index.ts:**
       - Barrel export: `export { CSVImportDialog } from './csv-import-dialog';`
  </action>
  <verify>
    TypeScript compiles: `cd packages/playground-ui && pnpm tsc --noEmit`
  </verify>
  <done>
    CSV import dialog orchestrates full flow: upload → preview → mapping → validate → import.
    Sequential addItem calls with progress tracking.
  </done>
</task>

</tasks>

<verification>
1. All files exist in csv-import/ folder
2. TypeScript compiles: `cd packages/playground-ui && pnpm tsc --noEmit`
3. Dialog uses useCSVParser: `grep "useCSVParser" packages/playground-ui/src/domains/datasets/components/csv-import/csv-import-dialog.tsx`
4. Dialog uses addItem mutation: `grep "addItem" packages/playground-ui/src/domains/datasets/components/csv-import/csv-import-dialog.tsx`
5. Barrel export exists: `grep "CSVImportDialog" packages/playground-ui/src/domains/datasets/components/csv-import/index.ts`
</verification>

<success_criteria>
- Dialog navigates through all steps (upload → preview → mapping → importing → complete)
- Validation blocks import when input column not mapped or values missing
- Import uses existing addItem mutation per row with progress feedback
- Errors during import are collected and shown in final summary
- Dialog closes on success and triggers onSuccess callback
</success_criteria>

<output>
After completion, create `.planning/phases/07-csv-import/07-03-SUMMARY.md`
</output>
