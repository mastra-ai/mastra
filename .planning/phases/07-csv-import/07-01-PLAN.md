---
phase: 07-csv-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/playground-ui/package.json
  - packages/playground-ui/src/domains/datasets/utils/csv-validation.ts
  - packages/playground-ui/src/domains/datasets/utils/json-cell-parser.ts
  - packages/playground-ui/src/domains/datasets/hooks/use-csv-parser.ts
autonomous: true

must_haves:
  truths:
    - "CSV file can be parsed into structured data with headers"
    - "JSON strings in CSV cells are auto-parsed, with warnings on failure"
    - "Empty cells become null, not empty string"
    - "Validation catches missing input column mapping"
    - "Validation reports row-level errors with line numbers"
  artifacts:
    - path: "packages/playground-ui/src/domains/datasets/utils/csv-validation.ts"
      provides: "validateMappedData function"
      exports: ["validateMappedData", "ValidationResult"]
    - path: "packages/playground-ui/src/domains/datasets/utils/json-cell-parser.ts"
      provides: "JSON cell parsing with warning"
      exports: ["parseJSONCell", "parseRow"]
    - path: "packages/playground-ui/src/domains/datasets/hooks/use-csv-parser.ts"
      provides: "React hook wrapping PapaParse"
      exports: ["useCSVParser", "ParsedCSV"]
  key_links:
    - from: "use-csv-parser.ts"
      to: "papaparse"
      via: "import Papa from 'papaparse'"
      pattern: "Papa\\.parse"
    - from: "csv-validation.ts"
      to: "json-cell-parser.ts"
      via: "import for row parsing"
      pattern: "parseRow"
---

<objective>
Install PapaParse and create CSV parsing/validation utilities for the import flow.

Purpose: Foundation for CSV import - parsing, JSON cell handling, and validation
Output: Utility functions and hook ready for use by import dialog
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-csv-import/07-CONTEXT.md
@.planning/phases/07-csv-import/07-RESEARCH.md
@packages/playground-ui/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PapaParse dependency</name>
  <files>packages/playground-ui/package.json</files>
  <action>
    Install papaparse and @types/papaparse to playground-ui:

    ```bash
    pnpm add papaparse @types/papaparse --filter @mastra/playground-ui
    ```

    Verify package.json updated with both dependencies.
  </action>
  <verify>
    `grep papaparse packages/playground-ui/package.json` shows both papaparse and @types/papaparse in dependencies
  </verify>
  <done>papaparse and types installed in playground-ui</done>
</task>

<task type="auto">
  <name>Task 2: Create JSON cell parser utility</name>
  <files>packages/playground-ui/src/domains/datasets/utils/json-cell-parser.ts</files>
  <action>
    Create json-cell-parser.ts with:

    1. `parseJSONCell(value: string | null | undefined)` function:
       - Return `{ parsed: null }` for null/undefined/empty string
       - If value looks like JSON (starts with { or [), try JSON.parse
       - On parse success: return `{ parsed: parsedValue }`
       - On parse failure: return `{ parsed: value, warning: "Could not parse as JSON, keeping as string" }`
       - For non-JSON strings: return `{ parsed: value }` (keep as-is)

    2. `parseRow(row: Record<string, unknown>)` function:
       - Apply parseJSONCell to each value in row
       - Convert empty strings to null
       - Return `{ data: Record<string, unknown>, warnings: string[] }` with per-cell warnings

    Export types: `ParsedCell`, `ParsedRow`
  </action>
  <verify>
    TypeScript compiles without errors: `cd packages/playground-ui && pnpm tsc --noEmit`
  </verify>
  <done>JSON cell parser handles all cases: null, JSON, plain strings, malformed JSON</done>
</task>

<task type="auto">
  <name>Task 3: Create CSV validation utility and parser hook</name>
  <files>
    packages/playground-ui/src/domains/datasets/utils/csv-validation.ts
    packages/playground-ui/src/domains/datasets/hooks/use-csv-parser.ts
  </files>
  <action>
    **csv-validation.ts:**

    1. Define ColumnMapping type: `Record<string, 'input' | 'expectedOutput' | 'metadata' | 'ignore'>`

    2. Define ValidationError: `{ row: number; column: string; message: string }`

    3. Define ValidationResult: `{ valid: boolean; errors: ValidationError[] }`

    4. `validateMappedData(data: Record<string, unknown>[], mapping: ColumnMapping)`:
       - First check: at least one column mapped to 'input' (error row 0 if not)
       - For each row, check the input column value is not null/undefined/empty
       - Row numbers are 1-indexed + 1 for header (so first data row is 2)
       - Return ValidationResult

    **use-csv-parser.ts:**

    1. Import Papa from 'papaparse' and parseRow from json-cell-parser

    2. Define ParsedCSV: `{ headers: string[]; data: Record<string, unknown>[]; errors: Papa.ParseError[]; warnings: string[] }`

    3. Create `useCSVParser()` hook returning:
       - `parseFile(file: File): Promise<ParsedCSV>` - async function
       - `isParsing: boolean` state
       - `error: Error | null` state

    4. In parseFile:
       - Use Papa.parse with `header: true`, `skipEmptyLines: 'greedy'`, `dynamicTyping: false`
       - Use `worker: true` if file.size > 1_000_000 (1MB)
       - After parsing, run each row through parseRow to handle JSON cells
       - Collect warnings from all rows
       - Return ParsedCSV
  </action>
  <verify>
    TypeScript compiles: `cd packages/playground-ui && pnpm tsc --noEmit`
  </verify>
  <done>
    CSV validation catches missing input mapping and null inputs.
    Parser hook wraps PapaParse with JSON cell handling.
  </done>
</task>

</tasks>

<verification>
1. papaparse in dependencies: `grep -A2 '"papaparse"' packages/playground-ui/package.json`
2. All files exist:
   - packages/playground-ui/src/domains/datasets/utils/json-cell-parser.ts
   - packages/playground-ui/src/domains/datasets/utils/csv-validation.ts
   - packages/playground-ui/src/domains/datasets/hooks/use-csv-parser.ts
3. TypeScript compiles: `cd packages/playground-ui && pnpm tsc --noEmit`
4. Exports exist: grep for exported functions/types
</verification>

<success_criteria>
- PapaParse installed and importable
- JSON cell parser handles null, JSON strings, plain strings, malformed JSON
- CSV validation catches: no input column, null/empty inputs
- Parser hook provides async parseFile with web worker for large files
- All TypeScript types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-csv-import/07-01-SUMMARY.md`
</output>
