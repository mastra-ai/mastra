---
phase: 06-playground-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/server/schemas/datasets.ts
  - packages/server/src/server/handlers/datasets.ts
  - packages/server/src/server/server-adapter/routes/datasets.ts
  - packages/server/src/server/server-adapter/routes/index.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/datasets returns list of datasets"
    - "POST /api/datasets creates a new dataset"
    - "GET /api/datasets/:id returns dataset with items"
    - "POST /api/datasets/:id/items adds item to dataset"
    - "GET /api/datasets/:id/runs returns run history"
    - "POST /api/datasets/:id/runs triggers a new run"
    - "GET /api/runs/:id/results returns run results"
    - "GET /api/runs/compare returns comparison between two runs"
  artifacts:
    - path: "packages/server/src/server/schemas/datasets.ts"
      provides: "Zod schemas for dataset API validation"
    - path: "packages/server/src/server/handlers/datasets.ts"
      provides: "Handler functions for dataset routes"
    - path: "packages/server/src/server/server-adapter/routes/datasets.ts"
      provides: "Route definitions for Hono app"
  key_links:
    - from: "packages/server/src/server/handlers/datasets.ts"
      to: "packages/core/src/storage/domains/datasets"
      via: "mastra.getStorage().getStore('datasets')"
    - from: "packages/server/src/server/handlers/datasets.ts"
      to: "packages/core/src/datasets/run"
      via: "runDataset import"
---

<objective>
Expose Datasets storage and run orchestration via REST API.

Purpose: Enable playground UI to interact with datasets, items, runs, and comparison.
Output: Complete REST API for datasets CRUD, run triggering, results retrieval, and comparison.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-playground-integration/06-CONTEXT.md
@.planning/phases/06-playground-integration/06-RESEARCH.md

# Reference implementations
@packages/server/src/server/handlers/scores.ts
@packages/server/src/server/schemas/scores.ts
@packages/server/src/server/server-adapter/routes/scorers.ts

# Core APIs to expose
@packages/core/src/storage/domains/datasets/base.ts
@packages/core/src/storage/domains/runs/base.ts
@packages/core/src/datasets/run/index.ts
@packages/core/src/datasets/run/analytics/compare.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas for datasets API</name>
  <files>packages/server/src/server/schemas/datasets.ts</files>
  <action>
Create Zod schemas following the scores.ts pattern:

1. Path params:
   - datasetIdPathParams: { datasetId: z.string() }
   - runIdPathParams: { runId: z.string() }
   - itemIdPathParams: { itemId: z.string() }

2. Request bodies:
   - createDatasetBodySchema: { name, description?, metadata? }
   - updateDatasetBodySchema: { name?, description?, metadata? }
   - addItemBodySchema: { input: unknown, expectedOutput?, metadata? }
   - updateItemBodySchema: { input?, expectedOutput?, metadata? }
   - triggerRunBodySchema: { targetType: 'agent'|'workflow'|'scorer', targetId, scorerIds?: string[] }
   - compareRunsBodySchema: { runIdA, runIdB, thresholds?: Record<string, ScorerThreshold> }

3. Response schemas:
   - datasetResponseSchema: matches Dataset type
   - datasetItemResponseSchema: matches DatasetItem type
   - runResponseSchema: matches Run type
   - runResultResponseSchema: matches RunResult type
   - comparisonResponseSchema: matches ComparisonResult type
   - listDatasetsResponseSchema: { datasets: Dataset[], pagination }
   - listItemsResponseSchema: { items: DatasetItem[], pagination }
   - listRunsResponseSchema: { runs: Run[], pagination }
   - listResultsResponseSchema: { results: RunResult[], pagination }

4. Query params:
   - paginationQuerySchema: { page?: number, perPage?: number }

Export all schemas for use in handlers and routes.
  </action>
  <verify>TypeScript compiles with no errors: `cd packages/server && pnpm tsc --noEmit`</verify>
  <done>All Zod schemas defined and exported for datasets API validation</done>
</task>

<task type="auto">
  <name>Task 2: Create handler functions for datasets API</name>
  <files>packages/server/src/server/handlers/datasets.ts</files>
  <action>
Create handler functions following scores.ts pattern. Each handler:
- Gets storage from context.get('mastra').getStorage()
- Validates request body/params
- Calls storage methods
- Returns JSON response

Handlers to implement:

1. Dataset CRUD:
   - listDatasetsHandler: GET /api/datasets - returns paginated list
   - createDatasetHandler: POST /api/datasets - creates dataset
   - getDatasetHandler: GET /api/datasets/:datasetId - returns dataset
   - updateDatasetHandler: PATCH /api/datasets/:datasetId - updates dataset
   - deleteDatasetHandler: DELETE /api/datasets/:datasetId - deletes dataset

2. Item CRUD:
   - listItemsHandler: GET /api/datasets/:datasetId/items - returns paginated items
   - addItemHandler: POST /api/datasets/:datasetId/items - adds item
   - getItemHandler: GET /api/datasets/:datasetId/items/:itemId - returns item
   - updateItemHandler: PATCH /api/datasets/:datasetId/items/:itemId - updates item
   - deleteItemHandler: DELETE /api/datasets/:datasetId/items/:itemId - deletes item

3. Run operations:
   - listRunsHandler: GET /api/datasets/:datasetId/runs - returns paginated runs
   - triggerRunHandler: POST /api/datasets/:datasetId/runs - triggers run using runDataset()
   - getRunHandler: GET /api/runs/:runId - returns run
   - listResultsHandler: GET /api/runs/:runId/results - returns paginated results

4. Analytics:
   - compareRunsHandler: POST /api/runs/compare - calls compareRuns() from analytics

For triggerRunHandler:
- Import runDataset from '@mastra/core/datasets'
- Get target from mastra.getAgent()/getWorkflow()/getScorer() based on targetType
- Resolve scorers from scorerIds
- Call runDataset() and return the run

Handle errors with HTTPException (404 for not found, 400 for validation errors).
  </action>
  <verify>TypeScript compiles: `cd packages/server && pnpm tsc --noEmit`</verify>
  <done>All handler functions implemented for datasets API</done>
</task>

<task type="auto">
  <name>Task 3: Create routes and register in router</name>
  <files>
    packages/server/src/server/server-adapter/routes/datasets.ts
    packages/server/src/server/server-adapter/routes/index.ts
  </files>
  <action>
1. Create datasets.ts routes file following scorers.ts pattern:

Import schemas and handlers. Define routes array using createRoute():

```typescript
export const datasetsRoutes: ServerRoute[] = [
  // Dataset CRUD
  createRoute({
    method: 'get',
    path: '/api/datasets',
    handler: listDatasetsHandler,
    // ... validation schemas
  }),
  createRoute({
    method: 'post',
    path: '/api/datasets',
    handler: createDatasetHandler,
    // ...
  }),
  // ... all other routes
];
```

Route paths:
- GET/POST /api/datasets
- GET/PATCH/DELETE /api/datasets/:datasetId
- GET/POST /api/datasets/:datasetId/items
- GET/PATCH/DELETE /api/datasets/:datasetId/items/:itemId
- GET/POST /api/datasets/:datasetId/runs
- GET /api/runs/:runId
- GET /api/runs/:runId/results
- POST /api/runs/compare

2. Update routes/index.ts:
- Import datasetsRoutes from './datasets'
- Add to allRoutes array spread

Ensure routes are properly typed for OpenAPI generation.
  </action>
  <verify>
1. TypeScript compiles: `cd packages/server && pnpm tsc --noEmit`
2. Routes registered: grep for "datasetsRoutes" in routes/index.ts
  </verify>
  <done>Dataset routes registered in server router</done>
</task>

</tasks>

<verification>
1. All TypeScript compiles without errors
2. Schemas export correctly from schemas/datasets.ts
3. Handlers import and use storage correctly
4. Routes are registered in allRoutes array
</verification>

<success_criteria>
- GET /api/datasets schema validates and handler returns datasets
- POST /api/datasets/:id/runs triggers runDataset execution
- POST /api/runs/compare returns ComparisonResult
- All routes follow existing server patterns (scores, agents)
</success_criteria>

<output>
After completion, create `.planning/phases/06-playground-integration/06-01-SUMMARY.md`
</output>
