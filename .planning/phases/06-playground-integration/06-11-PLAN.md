---
phase: 06-playground-integration
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/server/schemas/datasets.ts
  - packages/playground-ui/src/domains/datasets/hooks/use-dataset-runs.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "traceId returned in run results API response"
    - "Results auto-refresh when run completes"
  artifacts:
    - path: "packages/server/src/server/schemas/datasets.ts"
      provides: "traceId field in runResultResponseSchema"
      contains: "traceId: z.string()"
    - path: "packages/playground-ui/src/domains/datasets/hooks/use-dataset-runs.ts"
      provides: "Auto-refetch of results when run status changes"
      contains: "refetchInterval"
  key_links:
    - from: "runResultResponseSchema"
      to: "core storage schema"
      via: "traceId field alignment"
      pattern: "traceId.*nullable"
---

<objective>
Fix two UAT gaps from retest: traceId missing from API response schema and results not auto-refreshing when run completes.

Purpose: Complete dataset run results display with trace links and live updates.
Output: Working traceId in API, auto-refreshing results while run is active.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/server/src/server/schemas/datasets.ts
@packages/playground-ui/src/domains/datasets/hooks/use-dataset-runs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add traceId to server response schema</name>
  <files>packages/server/src/server/schemas/datasets.ts</files>
  <action>
Add traceId field to runResultResponseSchema (lines 141-155).

Location: After `retryCount: z.number()` (line 153), add:
```typescript
traceId: z.string().nullable(),
```

This aligns with the core storage schema updated in plan 06-10 which added traceId column to DATASET_RUN_RESULTS_SCHEMA.
  </action>
  <verify>Run `pnpm typecheck` from packages/server - no errors</verify>
  <done>runResultResponseSchema includes traceId: z.string().nullable()</done>
</task>

<task type="auto">
  <name>Task 2: Add refetchInterval to useDatasetRunResults</name>
  <files>packages/playground-ui/src/domains/datasets/hooks/use-dataset-runs.ts</files>
  <action>
Update useDatasetRunResults hook to poll while the parent run is still active.

The hook needs to accept an optional `runStatus` parameter to control polling:

```typescript
export const useDatasetRunResults = (
  datasetId: string,
  runId: string,
  pagination?: { page?: number; perPage?: number },
  runStatus?: string
) => {
  const client = useMastraClient();
  return useQuery({
    queryKey: ['dataset-run-results', datasetId, runId, pagination],
    queryFn: () => client.listDatasetRunResults(datasetId, runId, pagination),
    enabled: Boolean(datasetId) && Boolean(runId),
    refetchInterval: runStatus === 'running' || runStatus === 'pending' ? 2000 : false,
  });
};
```

The calling component (run detail page) already has run.status from useDatasetRun and can pass it through.
  </action>
  <verify>Run `pnpm build` from packages/playground-ui - builds successfully</verify>
  <done>useDatasetRunResults accepts runStatus param and polls every 2s while run is pending/running</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes in packages/server
- `pnpm build` passes in packages/playground-ui
- traceId field visible in runResultResponseSchema
- useDatasetRunResults has refetchInterval logic
</verification>

<success_criteria>
- traceId: z.string().nullable() added to runResultResponseSchema
- useDatasetRunResults polls while run status is pending/running
- Both packages build without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-playground-integration/06-11-SUMMARY.md`
</output>
