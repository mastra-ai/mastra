---
phase: 06-playground-integration
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/datasets/run/executor.ts
  - packages/core/src/datasets/run/index.ts
  - packages/core/src/storage/constants.ts
  - packages/core/src/storage/types.ts
  - packages/playground-ui/src/domains/datasets/components/results/results-table.tsx
  - packages/playground-ui/src/domains/datasets/components/results/result-detail-dialog.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "traceId captured from agent/workflow execution"
    - "traceId stored in run results"
    - "traceId displayed in result detail dialog"
    - "Trace link navigates to /traces/:traceId"
  artifacts:
    - path: "packages/core/src/datasets/run/executor.ts"
      provides: "ExecutionResult with traceId"
    - path: "packages/core/src/storage/constants.ts"
      provides: "traceId column in DATASET_RUN_RESULTS_SCHEMA"
  key_links:
    - from: "executor.ts executeAgent/executeWorkflow"
      to: "ExecutionResult.traceId"
      via: "capture from result object"
    - from: "result-detail-dialog.tsx"
      to: "/traces/:traceId"
      via: "Link component"
---

<objective>
Add trace link support to dataset run results.

Purpose: UAT test 16 - users want trace links for debugging execution
Output: traceId captured, stored, and displayed with link in UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/trace-links.md
@packages/core/src/datasets/run/executor.ts
@packages/core/src/datasets/run/index.ts
@packages/core/src/storage/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add traceId to ExecutionResult and capture from targets</name>
  <files>
    packages/core/src/datasets/run/executor.ts
  </files>
  <action>
Update ExecutionResult interface:
```typescript
export interface ExecutionResult {
  output: unknown;
  error: string | null;
  traceId: string | null;  // NEW: trace ID from agent/workflow
}
```

Update executeAgent function:
- Agent.generate() returns FullOutput which has traceId field
- Capture it: `return { output: result, error: null, traceId: result.traceId ?? null }`

Update executeWorkflow function:
- Workflow run.start() returns result with traceId
- Capture it: `return { output: result.result, error: null, traceId: result.traceId ?? null }`
- For error cases, return traceId: null

Update executeScorer function:
- Scorers don't have traces, return traceId: null

Update executeTarget catch block:
- Return traceId: null on error
  </action>
  <verify>
TypeScript compiles:
```bash
cd packages/core && pnpm build
```
  </verify>
  <done>
ExecutionResult includes traceId, captured from agent/workflow execution
  </done>
</task>

<task type="auto">
  <name>Task 2: Add traceId to storage schema and persist</name>
  <files>
    packages/core/src/storage/constants.ts
    packages/core/src/storage/types.ts
    packages/core/src/datasets/run/index.ts
  </files>
  <action>
Update DATASET_RUN_RESULTS_SCHEMA in constants.ts:
- Add after `retryCount`: `traceId: { type: 'text', nullable: true },`

Update types.ts (if RunResult type exists):
- Add traceId?: string to the interface

Update runDataset in index.ts:
- In the pMap callback after executeTarget, capture traceId from execResult
- Add traceId to the addResult call:
```typescript
await runsStore.addResult({
  runId,
  itemId: item.id,
  itemVersion: item.version,
  input: item.input,
  output: execResult.output,
  expectedOutput: item.expectedOutput ?? null,
  latency,
  error: execResult.error,
  startedAt: itemStartedAt,
  completedAt: itemCompletedAt,
  retryCount: 0,
  traceId: execResult.traceId,  // NEW
});
```
  </action>
  <verify>
Build succeeds:
```bash
cd packages/core && pnpm build
```
  </verify>
  <done>
traceId column in schema and persisted with results
  </done>
</task>

<task type="auto">
  <name>Task 3: Display traceId in UI with link</name>
  <files>
    packages/playground-ui/src/domains/datasets/components/results/results-table.tsx
    packages/playground-ui/src/domains/datasets/components/results/result-detail-dialog.tsx
  </files>
  <action>
Update RunResultData interface in results-table.tsx:
- Add `traceId?: string | null;`

Update ResultDetailDialog:
- Import Link component (use useLinkComponent pattern)
- Add trace link to KeyValueList data array (after latency, before error):
```typescript
...(result.traceId ? [{
  key: 'trace',
  label: 'Trace',
  value: (
    <Link to={`/traces/${result.traceId}`} className="text-accent1 hover:underline">
      View Trace
    </Link>
  ),
}] : []),
```

Pattern reference: See how other dialogs display links to related resources.
  </action>
  <verify>
Build succeeds:
```bash
cd packages/playground-ui && pnpm build
cd packages/playground && pnpm build
```

Manual test:
1. Trigger run against agent
2. Open result detail dialog
3. Verify "View Trace" link appears and navigates to trace page
  </verify>
  <done>
Trace link displayed in result detail dialog
  </done>
</task>

</tasks>

<verification>
1. Build all: `cd packages/core && pnpm build && cd ../server && pnpm build && cd ../playground-ui && pnpm build && cd ../playground && pnpm build`
2. Run dev server
3. Create dataset, trigger run against agent
4. Open result detail
5. Verify: "View Trace" link appears and navigates to /traces/:traceId
</verification>

<success_criteria>
- UAT test 16 passes: Trace links visible in dataset item results
- traceId persisted in storage
- Link navigates to trace detail page
</success_criteria>

<output>
After completion, create `.planning/phases/06-playground-integration/06-10-SUMMARY.md`
</output>
