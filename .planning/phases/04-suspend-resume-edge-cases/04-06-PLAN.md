---
phase: 04-suspend-resume-edge-cases
plan: 06
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/evented/workflow.ts
  - packages/core/src/workflows/evented/workflow-event-processor/foreach.ts
autonomous: true

must_haves:
  truths:
    - "Foreach with single item concurrency can suspend and resume"
    - "Foreach with all items concurrency can suspend and resume"
    - "Foreach with partial concurrency can suspend and resume"
    - "Foreach resume by index works for concurrent execution"
    - "Foreach resume by label works for concurrent execution"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "6 ported foreach suspend/resume tests"
      contains: "should suspend and resume when running.*for loop"
    - path: "packages/core/src/workflows/evented/workflow.ts"
      provides: "forEachIndex parameter in resume()"
      contains: "forEachIndex"
  key_links:
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "workflow-event-processor/foreach.ts"
      via: "foreach iteration suspend tracking"
      pattern: "suspendedIterations"
---

<objective>
Implement foreach suspend/resume functionality in the evented workflow runtime.

Purpose: Foreach loops that process arrays need to support suspension at individual iteration level. This is the most complex suspend/resume scenario, requiring tracking of which iterations are suspended and resuming specific iterations by index or label.

Output:
- 6 ported tests passing (single concurrency, all concurrency, partial concurrency, index resume, label resume)
- EventedRun.resume() supports `forEachIndex` parameter
- Foreach iteration suspension tracking implemented
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-suspend-resume-edge-cases/04-RESEARCH.md

# Key reference files
@packages/core/src/workflows/workflow.test.ts (lines 7678-7850, 7844-7930, 7930-8060, 8057-8225, 8223-8320, 8314-8420)
@packages/core/src/workflows/evented/workflow.ts
@packages/core/src/workflows/evented/workflow-event-processor/foreach.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 6 foreach suspend/resume tests (RED phase)</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the following 6 tests from workflow.test.ts to evented-workflow.test.ts.

Standard evented test setup required.

Tests to port:

1. **Line 7678** - `should suspend and resume when running a single item concurrency (default) for loop`
   - Create foreach step processing array [1, 2, 3]
   - Concurrency: 1 (default, sequential)
   - Item 2 suspends
   - Resume
   - Verify all items processed in order
   - Verify final result contains all processed items

2. **Line 7844** - `should suspend and resume when running all items concurrency for loop`
   - Create foreach step processing array
   - Concurrency: Infinity (all at once)
   - One item suspends
   - Resume
   - Verify all items eventually processed

3. **Line 7930** - `should suspend and resume provided index when running all items concurrency for loop`
   - Create foreach with multiple items, all concurrent
   - Multiple items suspend
   - Resume with `forEachIndex: 1` to resume specific iteration
   - Verify only that iteration resumes
   - Resume remaining iterations
   - Verify completion

4. **Line 8057** - `should suspend and resume provided label when running all items concurrency for loop`
   - Create foreach with items that suspend with different labels
   - Resume using `label: 'item-2-label'`
   - Verify correct iteration resumes by label

5. **Line 8223** - `should suspend and resume when running a partial item concurrency for loop`
   - Create foreach with concurrency: 2 (process 2 at a time)
   - Array has 5 items
   - One item suspends mid-batch
   - Resume
   - Verify batching continues correctly

6. **Line 8314** - `should suspend and resume provided index when running a partial item concurrency for loop`
   - Similar to test 5 but with explicit index resume
   - Verify correct iteration resumes with partial concurrency

Add to "Suspend/Resume Edge Cases - Phase 4" describe block.

These tests will likely fail initially - foreach suspend/resume is completely missing from evented runtime.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - tests should exist (will likely fail).
  </verify>
  <done>
6 new test cases for foreach suspend/resume added.
Tests cover single, all, and partial concurrency scenarios.
Tests cover index and label resume mechanisms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement foreach suspend/resume (GREEN phase)</name>
  <files>
packages/core/src/workflows/evented/workflow.ts
packages/core/src/workflows/evented/workflow-event-processor/foreach.ts
  </files>
  <action>
Implement foreach suspend/resume functionality.

**Part A: Add forEachIndex to resume() parameters** (workflow.ts)

```typescript
async resume<TResumeSchema>(params: {
  resumeData?: TResumeSchema;
  step?: Step<...> | [...] | string | string[];
  label?: string;
  forEachIndex?: number;  // NEW
  requestContext?: RequestContext;
  perStep?: boolean;
}): Promise<WorkflowResult<...>>
```

CHECKPOINT A: Run typecheck to verify parameter addition compiles.

**Part B: Track suspended iterations in snapshot**

The foreach processor needs to track which iterations are suspended:

```typescript
// In snapshot structure (or suspendedPaths)
suspendedIterations?: {
  [stepId: string]: {
    [index: number]: {
      label?: string;
      suspendPayload: any;
    }
  }
}
```

CHECKPOINT B: Verify snapshot type includes suspendedIterations (may need to extend type).

**Part C: Update foreach processor to handle suspend**

In `workflow-event-processor/foreach.ts`:

1. When an iteration suspends:
   - Store the iteration index in suspendedIterations
   - Store any resume label
   - Keep foreach step marked as "suspended" (not complete)

2. When other iterations complete:
   - Don't mark foreach as complete if any iterations are suspended
   - Allow concurrent iterations to finish independently

3. When resuming an iteration:
   - Find the iteration by index or label
   - Resume only that iteration
   - If all iterations now complete, mark foreach as complete

CHECKPOINT C: Run test for single concurrency (test 1) - should pass if basic foreach suspend works.

**Part D: Handle resume path for foreach**

When `forEachIndex` is provided:
```typescript
if (params.forEachIndex !== undefined) {
  // Look up suspended iteration at this index
  const suspendedIteration = snapshot.suspendedIterations?.[stepId]?.[params.forEachIndex];
  if (!suspendedIteration) {
    throw new Error(`Foreach iteration ${params.forEachIndex} is not suspended`);
  }
  // Resume this specific iteration
}
```

When `label` is provided for foreach:
```typescript
// Find iteration with this label
const iterations = snapshot.suspendedIterations?.[stepId];
const iterationEntry = Object.entries(iterations ?? {})
  .find(([idx, data]) => data.label === params.label);
```

CHECKPOINT D: Run tests 3 and 4 (index and label resume) - verify specific iteration targeting.

**Part E: Study default runtime foreach implementation**

Reference `packages/core/src/workflows/workflow.ts` foreach handling for the exact format and logic. The evented implementation should produce compatible results.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - all 6 foreach tests pass.
Run existing foreach tests to verify no regressions.
  </verify>
  <done>
All 6 foreach suspend/resume tests pass.
forEachIndex parameter supported in resume().
Resume by label works for foreach iterations.
Partial concurrency correctly handles suspended iterations.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run `cd packages/core && pnpm test evented-workflow.test.ts` - all tests pass
2. Verify these specific behaviors:
   - Foreach with suspended iteration doesn't mark step as complete
   - `forEachIndex` resumes correct iteration
   - `label` resumes correct iteration in foreach
   - Concurrent iterations can complete independently of suspended ones
</verification>

<success_criteria>
- 6 new foreach suspend/resume tests passing
- No regressions in existing foreach tests
- forEachIndex parameter supported
- Resume by label works in foreach context
- All concurrency modes (1, partial, all) handle suspend/resume
</success_criteria>

<output>
After completion, create `.planning/phases/04-suspend-resume-edge-cases/04-06-SUMMARY.md`
</output>
