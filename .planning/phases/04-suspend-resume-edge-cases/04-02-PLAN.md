---
phase: 04-suspend-resume-edge-cases
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/evented/workflow.ts
  - packages/core/src/workflows/evented/step-executor.ts
autonomous: true

must_haves:
  truths:
    - "Resume by label works - suspend with resumeLabel, resume by label instead of step"
    - "suspendData is accessible in step execution context on resume"
    - "closeOnSuspend: false keeps stream open after suspend"
    - "Input property from snapshot preserved after resume"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "4 ported resume label and suspendData tests"
      contains: "should handle basic suspend and resume flow using resumeLabel"
    - path: "packages/core/src/workflows/evented/workflow.ts"
      provides: "Resume label support in EventedRun.resume()"
      contains: "label.*resumeLabels"
  key_links:
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "snapshot.resumeLabels"
      via: "label parameter resolution"
      pattern: "resumeLabels.*stepId"
---

<objective>
Implement resume labels and verify suspendData access in the evented workflow runtime.

Purpose: Resume labels allow workflows to suspend with named labels, making resume calls more intuitive than using step paths. This is particularly useful for complex workflows where step paths may change.

Output:
- 4 ported tests passing (resume labels, suspendData access, closeOnSuspend, input preservation)
- EventedRun.resume() supports `label` parameter
- Resume labels stored in snapshot during suspend
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-suspend-resume-edge-cases/04-RESEARCH.md

# Key reference files
@packages/core/src/workflows/workflow.test.ts (lines 314-400, 1367-1450, 1920-2000, 20229-20310)
@packages/core/src/workflows/workflow.ts (lines 3253-3399 - default resume with label)
@packages/core/src/workflows/evented/workflow.ts
@packages/core/src/workflows/evented/step-executor.ts (lines 79-110 - suspendData handling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 4 resume label and context tests (RED phase)</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the following 4 tests from workflow.test.ts to evented-workflow.test.ts.

Each test needs the standard evented test setup:
- Workflow ID with `-evented` suffix
- Own Mastra instance with `storage: testStorage, pubsub: new EventEmitterPubSub()`
- `await mastra.startEventEngine()` / `await mastra.stopEventEngine()`

Tests to port:

1. **Line 314** - `should handle basic suspend and resume flow using resumeLabel`
   - Create workflow with step that suspends with `resumeLabel: 'my-label'`
   - Execute, verify suspended
   - Resume using `label: 'my-label'` instead of `step:`
   - Verify workflow completes with correct result

2. **Line 20229** - `should provide access to suspendData in workflow step on resume`
   - Create step that suspends with payload `{ key: 'value' }`
   - Resume with resumeData
   - Step should have access to `suspendData` containing the original suspend payload
   - Verify suspendData.key === 'value'

3. **Line 1920** - `should handle basic suspend and resume flow that does not close on suspend`
   - Create workflow with `closeOnSuspend: false` option
   - Execute using stream
   - Verify stream stays open after suspend
   - Resume, verify stream captures resume events
   - Verify final result

4. **Line 1367** - `should preserve input property from snapshot context after resume`
   - Create workflow with inputSchema
   - Execute with specific inputData
   - Suspend
   - Resume
   - Verify step has access to original input data via context

Add tests to the existing "Suspend/Resume Edge Cases - Phase 4" describe block.

Note: Resume label test (1) will likely fail until Task 2 implements label support.
Tests 2-4 may pass if existing implementation already supports these features.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - check which tests pass/fail.
  </verify>
  <done>
4 new test cases added to evented-workflow.test.ts.
Tests correctly assert resume label, suspendData access, closeOnSuspend, and input preservation behaviors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement resume label support (GREEN phase)</name>
  <files>
packages/core/src/workflows/evented/workflow.ts
packages/core/src/workflows/evented/step-executor.ts
  </files>
  <action>
Implement resume label support in the evented runtime.

**Part A: Add label parameter to resume() method** (workflow.ts)

1. Add `label?: string` to resume params:
   ```typescript
   async resume<TResumeSchema>(params: {
     resumeData?: TResumeSchema;
     step?: Step<...> | [...] | string | string[];
     label?: string;  // NEW
     requestContext?: RequestContext;
     perStep?: boolean;
   }): Promise<WorkflowResult<...>>
   ```

2. Add label resolution logic (after loading snapshot, before step detection):
   ```typescript
   // Resolve label to step path if provided
   const snapshotResumeLabel = params.label
     ? snapshot?.resumeLabels?.[params.label]
     : undefined;

   // Label takes precedence over step param
   const stepParam = snapshotResumeLabel?.stepId
     ? snapshotResumeLabel.stepId
     : params.step;

   // Validate label exists if provided
   if (params.label && !snapshotResumeLabel) {
     const availableLabels = Object.keys(snapshot?.resumeLabels ?? {});
     throw new Error(
       `Resume label "${params.label}" not found. ` +
       `Available labels: [${availableLabels.join(', ')}]`
     );
   }
   ```

3. Use `stepParam` instead of `params.step` in the existing step resolution logic.

**Part B: Store resume labels during suspend** (step-executor.ts)

Check if resume labels are already being captured when a step suspends. Look at how `suspendPayload` is built and ensure `resumeLabel` from suspend options is stored in snapshot.

The default runtime stores labels in `snapshot.resumeLabels[label] = { stepId }`.

If not already implemented, add to the suspend handling logic:
```typescript
// When building suspend payload, capture resume label
if (suspendOptions?.resumeLabel) {
  // Need to emit event or update snapshot to store:
  // resumeLabels[suspendOptions.resumeLabel] = { stepId: step.id }
}
```

This may require updates to workflow-event-processor to persist resumeLabels to snapshot.

**Part C: Verify suspendData access** (step-executor.ts)

Per research, this should already work (lines 79-87). Verify the test passes without changes.

**Part D: Verify closeOnSuspend behavior**

Check if evented runtime respects this option. If not, may need to update stream handling.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - all 4 new tests should pass.
Run full test suite to ensure no regressions.
  </verify>
  <done>
All 4 ported tests pass.
Resume by label works: `run.resume({ label: 'my-label', resumeData: x })`
suspendData accessible in step context on resume.
closeOnSuspend: false keeps stream open.
Input preserved after resume.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run `cd packages/core && pnpm test evented-workflow.test.ts` - all tests pass
2. Verify these specific behaviors:
   - `run.resume({ label: 'approval', resumeData: x })` resumes correct step
   - Step can read `suspendData` to access original suspend payload
   - Stream with closeOnSuspend: false captures suspend AND resume events
   - Input data from initial execution available in resumed step
</verification>

<success_criteria>
- 4 new tests passing
- No regressions in existing tests
- Resume label stored during suspend, resolved during resume
- EventedRun.resume() accepts `label` parameter
- Error message when label not found includes available labels
</success_criteria>

<output>
After completion, create `.planning/phases/04-suspend-resume-edge-cases/04-02-SUMMARY.md`
</output>
