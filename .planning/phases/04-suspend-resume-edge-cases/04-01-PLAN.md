---
phase: 04-suspend-resume-edge-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/evented/workflow.ts
autonomous: true

must_haves:
  truths:
    - "Auto-resume works when single step is suspended without specifying step parameter"
    - "Error thrown when resuming workflow that is not suspended"
    - "Error thrown when resuming step that is not suspended"
    - "Error thrown when multiple steps suspended and no step specified"
    - "Explicit step resume and auto-resume both work (backwards compatibility)"
    - "Missing suspendData handled gracefully (returns undefined)"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "6 ported auto-resume and error handling tests"
      contains: "should auto-resume simple suspended step"
    - path: "packages/core/src/workflows/evented/workflow.ts"
      provides: "Auto-resume detection in EventedRun.resume()"
      contains: "suspendedStepPaths"
  key_links:
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "snapshot.suspendedPaths"
      via: "auto-resume detection logic"
      pattern: "suspendedPaths.*length"
---

<objective>
Implement auto-resume functionality and error handling for the evented workflow runtime.

Purpose: The evented runtime currently requires explicit step parameter for resume. This plan adds auto-detection of single suspended steps and proper error messages for invalid resume attempts - matching default runtime behavior.

Output:
- 6 ported tests passing (auto-resume, error cases, suspendData handling)
- EventedRun.resume() method updated with optional step parameter and auto-detection
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-suspend-resume-edge-cases/04-RESEARCH.md

# Key reference files
@packages/core/src/workflows/workflow.test.ts (lines 12099-12232, 16367-16500, 20229-20400)
@packages/core/src/workflows/workflow.ts (lines 3253-3399 - default resume implementation)
@packages/core/src/workflows/evented/workflow.ts (lines 1324-1432 - current evented resume)
@packages/core/src/workflows/evented/evented-workflow.test.ts (test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 6 auto-resume and error handling tests (RED phase)</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the following 6 tests from workflow.test.ts to evented-workflow.test.ts. Each test needs:
- Workflow ID with `-evented` suffix
- Own Mastra instance with `storage: testStorage, pubsub: new EventEmitterPubSub()`
- `await mastra.startEventEngine()` before test logic
- `await mastra.stopEventEngine()` after test logic

Tests to port (reference line numbers in workflow.test.ts):

1. **Line 16367** - `should auto-resume simple suspended step without specifying step parameter`
   - Create workflow with single suspend step
   - Execute, verify suspended
   - Resume WITHOUT step parameter - should auto-detect
   - Verify workflow completes

2. **Line 16434** - `should throw error when multiple steps are suspended and no step specified`
   - Create workflow with parallel steps that both suspend
   - Execute, verify both suspended
   - Attempt resume WITHOUT step - should throw with message listing suspended steps
   - Error message format: `Multiple suspended steps found: [step1], [step2]. Please specify which step to resume using the "step" parameter.`

3. **Line 12099** - `should throw error when you try to resume a workflow that is not suspended`
   - Create workflow that completes normally (no suspend)
   - Execute to completion
   - Attempt resume - should throw `This workflow run was not suspended`

4. **Line 12152** - `should throw error when you try to resume a workflow step that is not suspended`
   - Create workflow with multiple steps, one suspends
   - Execute, verify suspended at step A
   - Attempt resume at step B (not suspended) - should throw with available suspended steps
   - Error format: `This workflow step "stepB" was not suspended. Available suspended steps: [stepA]`

5. **Line 12232** - `should support both explicit step resume and auto-resume (backwards compatibility)`
   - Create workflow with single suspend step
   - Test 1: Resume with explicit step param - should work
   - Test 2: Resume without step param (auto) - should work
   - Both approaches should produce same result

6. **Line 20311** - `should handle missing suspendData gracefully`
   - Create step that reads `suspendData` on resume
   - Suspend without payload
   - Resume without resumeData
   - Step should receive undefined for suspendData (not crash)

Add tests to a new describe block: `describe('Suspend/Resume Edge Cases - Phase 4', () => { ... })`

Tests may fail initially (RED phase) - this is expected. Implementation comes in Task 2.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - new tests should exist (may fail).
Count test additions with grep.
  </verify>
  <done>
6 new test cases added to evented-workflow.test.ts in "Suspend/Resume Edge Cases - Phase 4" describe block.
Tests reference the exact behaviors from default runtime tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement auto-resume and error handling in EventedRun.resume() (GREEN phase)</name>
  <files>packages/core/src/workflows/evented/workflow.ts</files>
  <action>
Update the `resume()` method in EventedRun class (around line 1324) to:

1. **Make step parameter optional** - Change from required to optional:
   ```typescript
   async resume<TResumeSchema>(params: {
     resumeData?: TResumeSchema;
     step?:  // Now optional
       | Step<...>
       | [...Step[], Step<...>]
       | string
       | string[];
     requestContext?: RequestContext;
     perStep?: boolean;
   }): Promise<WorkflowResult<...>>
   ```

2. **Add workflow suspended check** (before any step processing):
   ```typescript
   if (snapshot.status !== 'suspended') {
     throw new Error('This workflow run was not suspended');
   }
   ```

3. **Implement auto-resume detection** (when step param not provided):
   Copy logic from default runtime (workflow.ts lines 3346-3381):
   ```typescript
   if (!params.step) {
     // Build list of suspended step paths from snapshot
     const suspendedStepPaths: string[][] = [];

     Object.entries(snapshot?.suspendedPaths ?? {}).forEach(([stepId, _executionPath]) => {
       const stepResult = snapshot?.context?.[stepId];
       if (stepResult && typeof stepResult === 'object' && 'status' in stepResult) {
         const stepRes = stepResult as any;
         if (stepRes.status === 'suspended') {
           const nestedPath = stepRes.suspendPayload?.__workflow_meta?.path;
           if (nestedPath && Array.isArray(nestedPath)) {
             suspendedStepPaths.push([stepId, ...nestedPath]);
           } else {
             suspendedStepPaths.push([stepId]);
           }
         }
       }
     });

     if (suspendedStepPaths.length === 0) {
       throw new Error('No suspended steps found in this workflow run');
     }

     if (suspendedStepPaths.length === 1) {
       steps = suspendedStepPaths[0]!;
     } else {
       const pathStrings = suspendedStepPaths.map(path => `[${path.join(', ')}]`);
       throw new Error(
         `Multiple suspended steps found: ${pathStrings.join(', ')}. ` +
         'Please specify which step to resume using the "step" parameter.',
       );
     }
   } else {
     // Existing step parameter handling
     if (typeof params.step === 'string') {
       steps = params.step.split('.');
     } else {
       steps = (Array.isArray(params.step) ? params.step : [params.step]).map(step =>
         typeof step === 'string' ? step : step?.id,
       );
     }
   }
   ```

4. **Add step not suspended validation** (after steps determined, before execution):
   ```typescript
   const suspendedStepIds = Object.keys(snapshot?.suspendedPaths ?? {});
   const isStepSuspended = suspendedStepIds.includes(steps?.[0] ?? '');

   if (!isStepSuspended) {
     throw new Error(
       `This workflow step "${steps?.[0]}" was not suspended. ` +
       `Available suspended steps: [${suspendedStepIds.join(', ')}]`,
     );
   }
   ```

5. **Remove the existing resumePath check** that throws error - the new validation handles this better.

6. **Keep existing request context handling** - it already works correctly.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - all 6 new tests should pass.
Run full test suite to ensure no regressions.
  </verify>
  <done>
All 6 ported tests pass.
No regression in existing suspend/resume tests (basic suspend/resume, async syntax, dountil, nested, state).
EventedRun.resume() now supports auto-resume and has proper error messages.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run `cd packages/core && pnpm test evented-workflow.test.ts` - all tests pass
2. Verify test count increased by 6
3. Verify these specific behaviors work:
   - `run.resume({ resumeData: 'x' })` auto-detects single suspended step
   - `run.resume({ resumeData: 'x' })` throws when multiple steps suspended
   - `run.resume({ step: 'completed-step', resumeData: 'x' })` throws with helpful message
   - Resume on completed workflow throws
</verification>

<success_criteria>
- 6 new tests in "Suspend/Resume Edge Cases - Phase 4" describe block
- All 6 tests passing
- No regressions in existing evented workflow tests
- EventedRun.resume() step parameter now optional
- Auto-resume works for single suspended step
- Clear error messages match default runtime format
</success_criteria>

<output>
After completion, create `.planning/phases/04-suspend-resume-edge-cases/04-01-SUMMARY.md`
</output>
