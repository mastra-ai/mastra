---
phase: 04-suspend-resume-edge-cases
plan: 05
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/evented/workflow.ts
autonomous: true

must_haves:
  truths:
    - "Consecutive nested workflows with suspend/resume work correctly"
    - "Resume with only nested workflow step provided works"
    - "Correct input value accessible when resuming in a loop"
    - "Basic suspend/resume in nested dountil workflow works"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "4 ported nested workflow edge case tests"
      contains: "should handle consecutive nested workflows with suspend/resume"
  key_links:
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "nested workflow runId"
      via: "suspendPayload.__workflow_meta"
      pattern: "__workflow_meta.*runId"
---

<objective>
Handle nested workflow suspend/resume edge cases including consecutive nested workflows and loop contexts.

Purpose: Complex workflows often have multiple nested workflows or loops with suspends. These edge cases ensure the evented runtime handles nested runId tracking, input preservation in loops, and consecutive nested workflow execution correctly.

Output:
- 4 ported tests passing (consecutive nested, nested-only resume, loop input, nested dountil)
- Verified nested workflow path resolution works correctly
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-suspend-resume-edge-cases/04-RESEARCH.md

# Key reference files
@packages/core/src/workflows/workflow.test.ts (lines 12002-12100, 12306-12400, 18367-18500, 18494-18600)
@packages/core/src/workflows/evented/workflow.ts
@packages/core/src/workflows/evented/workflow-event-processor/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 4 nested workflow edge case tests (RED phase)</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the following 4 tests from workflow.test.ts to evented-workflow.test.ts.

Standard evented test setup required.

Tests to port:

1. **Line 18494** - `should handle consecutive nested workflows with suspend/resume`
   - Create parent workflow with TWO nested workflows executed consecutively
   - First nested workflow runs and completes
   - Second nested workflow suspends
   - Resume second nested workflow
   - Verify both nested workflows produced correct results
   - Verify parent workflow completes with combined results

2. **Line 18367** - `should be able to resume suspended nested workflow step with only nested workflow step provided`
   - Create parent workflow with nested workflow
   - Nested workflow has step that suspends
   - Execute parent, nested step suspends
   - Resume with ONLY the nested step id: `step: ['nested-step']` or `step: 'nested-workflow.nested-step'`
   - Verify nested workflow resumes correctly
   - Verify parent workflow completes

3. **Line 12306** - `should have access to the correct input value when resuming in a loop. bug #6669`
   - Create workflow with doUntil loop
   - Loop step suspends on certain condition
   - Resume
   - Verify step has access to CORRECT loop iteration input (not stale from previous iteration)
   - This tests that input is re-evaluated on resume, not cached

4. **Line 12002** - `should handle basic suspend and resume in nested dountil workflow - bug #5650`
   - Create parent workflow with nested workflow
   - Nested workflow has doUntil loop that suspends
   - Execute, loop suspends
   - Resume
   - Verify loop continues correctly
   - Verify nested workflow completes
   - Verify parent workflow completes

Add to "Suspend/Resume Edge Cases - Phase 4" describe block.

These test complex interactions between nested workflows, loops, and suspend/resume.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - check test existence and initial status.
  </verify>
  <done>
4 new test cases for nested workflow edge cases added.
Tests verify consecutive nested, nested-only resume, loop input, and nested dountil scenarios.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix nested workflow resume issues if needed (GREEN phase)</name>
  <files>packages/core/src/workflows/evented/workflow.ts</files>
  <action>
Run tests from Task 1. If they pass, no changes needed.

If tests fail, investigate these likely issues:

**Likely Issue 1: Consecutive nested workflows share state incorrectly**

When parent runs nested1, then nested2:
- nested1's results should be finalized before nested2 starts
- nested2's suspend should not interfere with nested1's results

Fix: Ensure workflow-event-processor properly isolates nested workflow contexts.

**Likely Issue 2: Nested-only step path resolution**

When resuming with `step: 'nested-step'` (without parent step prefix):
- Need to find which parent step contains this nested workflow
- Look in `suspendedPaths` for entry containing this nested step

The auto-resume logic from Plan 01 may help here - it builds full paths including nested paths:
```typescript
const nestedPath = stepRes.suspendPayload?.__workflow_meta?.path;
if (nestedPath && Array.isArray(nestedPath)) {
  suspendedStepPaths.push([stepId, ...nestedPath]);
}
```

**Likely Issue 3: Loop input stale after resume**

When resuming in a doUntil loop:
- The step should receive the current iteration's input, not cached input
- Check how step-executor gets input for resumed steps
- Input should come from current context, not from snapshot of suspend moment

**Likely Issue 4: Nested doUntil state tracking**

Nested workflow with doUntil needs:
- Loop iteration count preserved
- Loop condition re-evaluated correctly after resume
- Parent workflow waits for nested completion
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - all 4 new tests pass.
Run existing nested workflow tests to verify no regressions.
  </verify>
  <done>
All 4 nested workflow edge case tests pass.
Consecutive nested workflows work independently.
Nested-only step resume works.
Loop input correctly available after resume.
Nested doUntil suspend/resume works.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run `cd packages/core && pnpm test evented-workflow.test.ts` - all tests pass
2. Verify consecutive nested workflows have independent results
3. Verify nested-only resume finds the correct parent context
4. Verify loop iteration input is fresh after resume
</verification>

<success_criteria>
- 4 new tests passing
- No regressions in existing nested workflow tests
- Nested workflows can run consecutively with suspend/resume
- Loop input values are correct after resume
</success_criteria>

<output>
After completion, create `.planning/phases/04-suspend-resume-edge-cases/04-05-SUMMARY.md`
</output>
