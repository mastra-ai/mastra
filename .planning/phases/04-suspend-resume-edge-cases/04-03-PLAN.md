---
phase: 04-suspend-resume-edge-cases
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
  - packages/core/src/workflows/evented/workflow-event-processor/parallel.ts
autonomous: true

must_haves:
  truths:
    - "Partial resume of parallel suspended steps keeps workflow suspended"
    - "Multiple suspend/resume cycles in parallel workflow work correctly"
    - "Correct step status maintained after resuming in branching workflows"
    - "Incorrect branches not executed after resuming from nested workflow"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "4 ported parallel/branch suspend tests"
      contains: "should remain suspended when only one of multiple parallel"
    - path: "packages/core/src/workflows/evented/workflow-event-processor/parallel.ts"
      provides: "Parallel suspend tracking"
      contains: "suspendedPaths"
  key_links:
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "workflow-event-processor/parallel.ts"
      via: "parallel step suspend handling"
      pattern: "parallel.*suspend"
---

<objective>
Handle parallel and branching workflow suspend/resume edge cases.

Purpose: When multiple parallel steps suspend, resuming one should NOT clear the others' suspended status. The workflow should remain suspended until all parallel suspended steps are resumed. Branch workflows need correct status tracking.

Output:
- 4 ported tests passing (parallel partial resume, multiple cycles, branch status, nested branch)
- Parallel suspend tracking correctly maintains individual step suspension status
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-suspend-resume-edge-cases/04-RESEARCH.md

# Key reference files
@packages/core/src/workflows/workflow.test.ts (lines 19003-19200, 19190-19400, 20013-20130, 20134-20230)
@packages/core/src/workflows/evented/workflow-event-processor/parallel.ts
@packages/core/src/workflows/evented/workflow-event-processor/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 4 parallel and branch suspend tests (RED phase)</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the following 4 tests from workflow.test.ts to evented-workflow.test.ts.

Standard evented test setup required for each test.

Tests to port:

1. **Line 20013** - `should remain suspended when only one of multiple parallel suspended steps is resumed - #6418`
   - Create workflow with parallel steps A and B that both suspend
   - Execute, verify both are suspended
   - Resume ONLY step A
   - Verify workflow is STILL suspended (not complete)
   - Verify `result.suspended` still contains step B
   - Resume step B
   - Verify workflow completes

2. **Line 20134** - `should handle multiple suspend/resume cycles in parallel workflow`
   - Create workflow where parallel steps can suspend multiple times
   - Execute, first suspend cycle
   - Resume step A, step A suspends again
   - Resume step B, step B completes
   - Resume step A again
   - Verify final completion with all expected results

3. **Line 19190** - `should maintain correct step status after resuming in branching workflows - #6419`
   - Create workflow with branch (if/else style)
   - One branch suspends
   - Resume
   - Verify correct branch was taken
   - Verify step results show correct status for taken/not-taken branches

4. **Line 19003** - `should not execute incorrect branches after resuming from suspended nested workflow`
   - Create workflow with nested workflow in one branch
   - Nested workflow suspends
   - Resume nested workflow
   - Verify only the correct branch path executed
   - Verify other branches were NOT executed (check step results)

Add to "Suspend/Resume Edge Cases - Phase 4" describe block.

These tests verify complex interaction between parallel execution and suspend/resume.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - check test existence and initial status.
  </verify>
  <done>
4 new test cases added for parallel and branch suspend/resume scenarios.
Tests assert correct behavior for partial resume, multiple cycles, and branch correctness.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix parallel suspend tracking if needed (GREEN phase)</name>
  <files>
packages/core/src/workflows/evented/workflow-event-processor/parallel.ts
packages/core/src/workflows/evented/workflow-event-processor/index.ts
  </files>
  <action>
Run the tests from Task 1. If they pass, no implementation changes needed.

If they fail, investigate and fix the parallel suspend tracking:

**Likely Issue 1: Partial resume clears all suspended paths**

When resuming one parallel step, the workflow-event-processor may incorrectly:
- Clear ALL entries from `suspendedPaths`
- Set workflow status to completed

Fix: Only remove the RESUMED step from `suspendedPaths`. Keep workflow suspended if other paths remain.

```typescript
// In processWorkflowResume or similar
if (resumeStepId) {
  // Only remove this step from suspended paths
  delete snapshot.suspendedPaths[resumeStepId];
}

// Check if any suspended paths remain
const remainingSuspended = Object.keys(snapshot.suspendedPaths ?? {});
if (remainingSuspended.length > 0) {
  snapshot.status = 'suspended'; // Stay suspended
} else {
  // All paths resumed, can proceed to completion check
}
```

**Likely Issue 2: Step status not preserved correctly**

For branch workflows, verify step results preserve:
- Steps that ran: status 'completed'
- Steps skipped (other branch): status 'skipped' or not present
- Suspended step before resume: status 'suspended'

Check how workflow-event-processor updates `snapshot.context` during parallel execution.

**Likely Issue 3: Nested workflow resume in branches**

When nested workflow in a branch resumes:
- Parent workflow should only continue the branch that was suspended
- Other branches should NOT re-execute

Verify the resume path handling correctly identifies and follows only the suspended branch.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - all 4 new tests pass.
Run existing parallel/branch tests to verify no regressions.
  </verify>
  <done>
All 4 parallel/branch tests pass.
Partial resume keeps workflow suspended until all parallel steps resumed.
Multiple suspend/resume cycles work correctly.
Branch status correctly reflects taken vs not-taken paths.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run `cd packages/core && pnpm test evented-workflow.test.ts` - all tests pass
2. Verify these specific behaviors:
   - Resume stepA when stepA and stepB suspended -> workflow still suspended
   - Resume stepB after stepA -> workflow completes
   - Multiple suspend/resume cycles don't corrupt state
   - Only correct branch executes after nested resume
</verification>

<success_criteria>
- 4 new tests passing
- No regressions in existing parallel execution tests
- `result.suspended` array correctly reflects remaining suspended steps
- Branch execution paths are deterministic after resume
</success_criteria>

<output>
After completion, create `.planning/phases/04-suspend-resume-edge-cases/04-03-SUMMARY.md`
</output>
