---
phase: 04-suspend-resume-edge-cases
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/core/src/workflows/evented/evented-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Request context from before suspension available during resume"
    - "Request context preserved in nested workflows after suspend/resume"
  artifacts:
    - path: "packages/core/src/workflows/evented/evented-workflow.test.ts"
      provides: "2 ported context preservation tests"
      contains: "should have access to requestContext from before suspension"
  key_links:
    - from: "packages/core/src/workflows/evented/workflow.ts"
      to: "snapshot.requestContext"
      via: "context serialization and restoration"
      pattern: "requestContext.*entries"
---

<objective>
Verify request context preservation across suspend/resume boundaries.

Purpose: Request context (dependency injection values) must persist across suspend/resume, including in nested workflows. This is critical for workflows that depend on injected services or configuration.

Output:
- 2 ported tests passing (request context preservation in main and nested workflows)
- Verification that evented runtime correctly serializes/deserializes request context
</objective>

<execution_context>
@/Users/tonykovanen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonykovanen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-suspend-resume-edge-cases/04-RESEARCH.md

# Key reference files
@packages/core/src/workflows/workflow.test.ts (lines 18599-18700, 19608-19700)
@packages/core/src/workflows/evented/workflow.ts (lines 1373-1387 - existing context handling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port 2 context preservation tests</name>
  <files>packages/core/src/workflows/evented/evented-workflow.test.ts</files>
  <action>
Port the following 2 tests from workflow.test.ts to evented-workflow.test.ts.

Standard evented test setup required.

Tests to port:

1. **Line 19608** - `should have access to requestContext from before suspension during workflow resume`
   - Create workflow with requestContext dependency
   - Set requestContext value BEFORE execution: `requestContext.set('userId', '123')`
   - Execute workflow, step suspends
   - Resume (without passing new requestContext)
   - Verify step can access `requestContext.get('userId')` === '123'

2. **Line 18599** - `should preserve request context in nested workflows after suspend/resume`
   - Create parent workflow with nested workflow
   - Set requestContext before parent execution
   - Parent calls nested workflow
   - Nested workflow suspends
   - Resume nested workflow
   - Verify nested step has access to original requestContext values
   - Verify parent step (after nested completes) also has access

Add to "Suspend/Resume Edge Cases - Phase 4" describe block.

Per research, the evented runtime already handles this (workflow.ts lines 1373-1387):
```typescript
// First, set values from the snapshot
for (const [key, value] of Object.entries(requestContextObj)) {
  requestContext.set(key, value);
}
```

These tests may pass without implementation changes - they verify the existing behavior.
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - both new tests should pass.
  </verify>
  <done>
2 new test cases for context preservation added.
Tests verify requestContext survives suspend/resume in both main and nested workflows.
Both tests pass (existing implementation sufficient).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix context preservation if tests fail (conditional)</name>
  <files>packages/core/src/workflows/evented/workflow.ts</files>
  <action>
**Only execute this task if Task 1 tests fail.**

If context preservation tests fail, investigate and fix:

1. **Check snapshot serialization** (workflow.ts around line 900-950)
   - Verify requestContext is being serialized to snapshot
   - Look for `requestContext: Object.fromEntries(requestContext.entries())`

2. **Check snapshot restoration** (workflow.ts around line 1370-1390)
   - Verify requestContext is being restored from snapshot
   - Existing code should handle this, but may have edge cases

3. **Check nested workflow context propagation**
   - Ensure parent requestContext is passed to nested workflow
   - Verify nested workflow uses parent's snapshot requestContext on resume

4. **Apply minimal fix** to make tests pass
   - Document what was missing/broken
   - Keep fix focused on context preservation only
  </action>
  <verify>
Run `cd packages/core && pnpm test evented-workflow.test.ts` - both context tests pass.
  </verify>
  <done>
Context preservation tests pass (either from Task 1 or with fixes from Task 2).
  </done>
</task>

</tasks>

<verification>
After task completes:
1. Run `cd packages/core && pnpm test evented-workflow.test.ts` - all tests pass
2. Verify requestContext.get() returns values set before suspension
3. Verify nested workflow receives parent's requestContext after resume
</verification>

<success_criteria>
- 2 new tests passing
- No regressions in existing request context tests
- Request context values serialized to snapshot correctly
- Request context restored on resume correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-suspend-resume-edge-cases/04-04-SUMMARY.md`
</output>
