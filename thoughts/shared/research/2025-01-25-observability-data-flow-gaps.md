---
date: 2026-01-25T18:26:05Z
researcher: Claude
git_commit: 0cb445d5776d24dc806496896fc034fe4a673698
branch: mastra-admin-example
repository: mastra-ai/mastra
topic: "Observability Data Flow - Runner Logs vs Spans in Admin System"
tags: [research, observability, spans, logs, websocket, clickhouse]
status: complete
last_updated: 2026-01-25
last_updated_by: Claude
---

# Research: Observability Data Flow - Runner Logs vs Spans in Admin System

**Date**: 2026-01-25T18:26:05Z
**Researcher**: Claude
**Git Commit**: 0cb445d5776d24dc806496896fc034fe4a673698
**Branch**: mastra-admin-example
**Repository**: mastra-ai/mastra

## Research Question

Document the current state of observability in the Mastra admin system. There are spans and runner logs - currently only runner logs are making it through to admin. Document what exists and how data flows.

## Summary

The admin system has two distinct observability data flows that operate independently:

1. **Runner Logs** - Complete real-time pipeline via WebSocket
   - Logs flow from child processes → LogCollector → WebSocket → Admin UI
   - Also persisted to file storage via ObservabilityWriter

2. **Spans/Traces** - File-based pipeline with ClickHouse ingestion
   - Spans generated by `@mastra/observability` during agent/workflow execution
   - Written to file storage as JSONL via ObservabilityWriter (if configured)
   - ClickHouse IngestionWorker polls files and inserts into database
   - QueryProvider enables querying from ClickHouse

The runner logs have a complete real-time path to the admin UI via WebSocket. The spans have a file-based path that relies on ClickHouse ingestion but lack real-time WebSocket streaming.

## Detailed Findings

### Runner Logs Flow (Working Path)

#### 1. Log Generation (`runners/local/src/`)

**Process Spawning** (`process/spawner.ts:17-48`):
- `spawnCommand()` spawns child processes with `stdio: ['ignore', 'pipe', 'pipe']`
- Stdout/stderr listeners split buffer data into lines and call `onOutput` callback
- Empty lines filtered with `.filter(Boolean)`

**Log Collection** (`logs/collector.ts:9-102`):
- `LogCollector` stores logs in `RingBuffer<LogEntry>` (default 10,000 lines)
- `append(line)` creates timestamped entries and notifies all listeners
- `stream(callback)` registers listeners and returns cleanup function

**Ring Buffer** (`logs/ring-buffer.ts:12-78`):
- Circular buffer with configurable capacity
- Automatic eviction of oldest entries when at capacity

#### 2. Log Transmission via Callback Injection (`runner.ts`)

**Callback Registration** (`runner.ts:187-201`):
- `setOnServerLog(callback)` stores callback reference
- `setObservabilityStorage(storage)` enables file persistence

**Deployment Wiring** (`runner.ts:228-362`):
- Creates `LogCollector` at line 254
- If `observabilityStorage` configured, creates `ObservabilityWriter` (lines 260-269)
- Wires collector to writer via `stream()` callback (lines 276-291)
- Wires collector to WebSocket callback via second `stream()` listener (lines 294-301)

#### 3. WebSocket Broadcasting (`packages/admin-server/src/`)

**Server Initialization** (`server.ts:317-366`):
- Creates `AdminWebSocketServer` attached to HTTP server at path `/ws`
- Creates `ServerLogStreamer` helper
- Wires runner's `setOnServerLog` to `serverLogStreamer.broadcastLog()`

**Channel Subscription** (`websocket/index.ts:178-214`):
- Clients subscribe to channels like `server:{serverId}`
- RBAC validation via team membership check
- Broadcasts to all subscribers of a channel

**Message Types** (`websocket/types.ts:36-44`):
```typescript
{
  type: 'server:log',
  payload: {
    serverId: string,
    line: string,
    timestamp: string,
    stream: 'stdout' | 'stderr'
  }
}
```

### Spans/Traces Flow (File-Based Path)

#### 1. Span Generation (`observability/mastra/src/`)

**Span Factory** (`spans/default.ts:13-213`):
- `DefaultSpan` generates OpenTelemetry-compatible IDs
- Lifecycle methods: `end()`, `error()`, `update()`, `createChildSpan()`
- Emits tracing events: `SPAN_STARTED`, `SPAN_UPDATED`, `SPAN_ENDED`

**Observability Instance** (`instances/default.ts:6-15`):
- `DefaultObservabilityInstance` creates `DefaultSpan` instances
- Manages exporters, bridges, and span processors

**Context Propagation** (`packages/core/src/observability/context.ts:44-91`):
- Uses JavaScript Proxies to wrap Mastra, Agent, Workflow instances
- Injects `tracingContext` into `generate()`, `stream()`, `execute()` calls

#### 2. Span Export to File Storage (`observability/writer/src/`)

**ObservabilityWriter** (`writer.ts:52-258`):
- Batches observability events (traces, spans, logs, metrics, scores)
- Writes to file storage as JSONL files
- Configuration: `batchSize: 1000`, `flushIntervalMs: 5000`, `maxFileSize: 10MB`

**Event Recording**:
- `recordSpan(span)` adds span to batch buffer
- `flush()` forces immediate write to storage
- Files written at: `{basePath}/{type}/{projectId}/{timestamp}_{uuid}.jsonl`

#### 3. ClickHouse Ingestion (`observability/clickhouse/src/`)

**Schema Tables** (`schema/tables.ts`):
- `mastra_admin_spans` - Stores span data with ReplacingMergeTree engine
- Columns: `span_id`, `trace_id`, `parent_span_id`, `name`, `kind`, `status`, `start_time`, `end_time`, `attributes`, `events`
- Partitioned by month, 90-day TTL

**Ingestion Worker** (`ingestion/worker.ts`):
- Polls file storage every 10 seconds (default)
- Reads pending JSONL files
- Bulk inserts into ClickHouse
- Moves processed files to `processed/` directory

**Query Provider** (`query-provider/index.ts`):
- `listSpans()` - Paginated span queries with filters
- `getSpansForTrace()` - Get all spans for a trace
- `getSpan()` - Get single span by ID

#### 4. Admin Integration (`packages/admin/src/`)

**MastraAdmin Configuration** (`mastra-admin.ts:54-61`):
```typescript
interface ObservabilityConfig {
  fileStorage: FileStorageProvider;  // Where JSONL files are written
  queryProvider?: ObservabilityQueryProvider;  // ClickHouse for querying
  writer?: ObservabilityWriterInterface;  // Optional pre-configured writer
}
```

**Access Methods** (`mastra-admin.ts:374-380`):
- `getObservabilityQueryProvider()` - Returns ClickHouse query provider
- `getObservabilityFileStorage()` - Returns file storage for raw JSONL

### WebSocket Implementation (Logs Only)

**Current WebSocket Message Types** (`packages/admin-server/src/websocket/types.ts`):
- `build:log` - Build log streaming
- `build:status` - Build status changes
- `server:log` - Server log streaming (runner logs)
- `server:health` - Server health updates
- `deployment:status` - Deployment status changes

**No Span/Trace WebSocket Handlers**:
- The WebSocket implementation focuses on build logs, server logs, and health status
- No dedicated channels or message types for spans or traces
- Search for "span", "trace", "observability" in websocket directory returns no results

### ClickHouse vs WebSocket Data Paths

| Data Type | Generation | Transmission | Storage | Real-time UI |
|-----------|------------|--------------|---------|--------------|
| Runner Logs | LogCollector | WebSocket callback | ObservabilityWriter → File | Yes, via WebSocket |
| Build Logs | BuildOrchestrator | WebSocket callback | BuildLogWriter → File | Yes, via WebSocket |
| Spans | ObservabilityInstance | None (file only) | ObservabilityWriter → File → ClickHouse | No |
| Traces | ObservabilityInstance | None (file only) | ObservabilityWriter → File → ClickHouse | No |
| Metrics | ObservabilityInstance | None (file only) | ObservabilityWriter → File → ClickHouse | No |

## Code References

### Runner Logs (Working)
- `runners/local/src/process/spawner.ts:17-48` - Process spawning with stdout/stderr capture
- `runners/local/src/logs/collector.ts:9-102` - Log collection and streaming
- `runners/local/src/runner.ts:294-301` - WebSocket callback wiring
- `packages/admin-server/src/server.ts:359-365` - Runner log callback registration
- `packages/admin-server/src/websocket/server-logs.ts:66-75` - Log broadcast implementation

### Spans (File Path Only)
- `observability/mastra/src/spans/default.ts:13-213` - Span creation and lifecycle
- `observability/mastra/src/instances/default.ts:6-15` - Observability instance factory
- `observability/writer/src/writer.ts:138-144` - Span recording to file
- `observability/clickhouse/src/ingestion/worker.ts:183-198` - File polling and ingestion
- `observability/clickhouse/src/query-provider/index.ts:156-202` - Span querying

### WebSocket (No Span Support)
- `packages/admin-server/src/websocket/types.ts:36-44` - Server log message type
- `packages/admin-server/src/websocket/index.ts:331-360` - Broadcast implementation
- No span-related WebSocket handlers exist

## Architecture Documentation

### Current Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              RUNNER LOGS (WORKING)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Child Process → stdout/stderr → spawnCommand() → onOutput callback         │
│                                        │                                    │
│                                        ▼                                    │
│                                  LogCollector                               │
│                                   (RingBuffer)                              │
│                                        │                                    │
│                    ┌───────────────────┼───────────────────┐                │
│                    ▼                                       ▼                │
│           ObservabilityWriter                       onServerLog             │
│           (JSONL → FileStorage)                     (WebSocket callback)    │
│                    │                                       │                │
│                    ▼                                       ▼                │
│              File Storage                        ServerLogStreamer          │
│           (observability/)                       .broadcastLog()            │
│                    │                                       │                │
│                    ▼                                       ▼                │
│           ClickHouse Worker                      WebSocket Server           │
│           (polls & ingests)                      (broadcast to clients)     │
│                    │                                       │                │
│                    ▼                                       ▼                │
│              ClickHouse DB                            Admin UI              │
│            (mastra_admin_logs)                    (real-time display)       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              SPANS/TRACES (FILE ONLY)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Agent/Workflow Execution → observability.startSpan() → DefaultSpan        │
│                                        │                                    │
│                                        ▼                                    │
│                              Tracing Event Emitted                          │
│                         (SPAN_STARTED/UPDATED/ENDED)                        │
│                                        │                                    │
│                                        ▼                                    │
│                                DefaultExporter                              │
│                              (buffers & batches)                            │
│                                        │                                    │
│                                        ▼                                    │
│                            ObservabilityWriter                              │
│                           (JSONL → FileStorage)                             │
│                                        │                                    │
│                                        ▼                                    │
│                               File Storage                                  │
│                            (observability/)                                 │
│                                        │                                    │
│                                        ▼                                    │
│                           ClickHouse Ingestion Worker                       │
│                          (polls every 10s, bulk inserts)                    │
│                                        │                                    │
│                                        ▼                                    │
│                               ClickHouse DB                                 │
│                           (mastra_admin_spans)                              │
│                                        │                                    │
│                                        ▼                                    │
│                           ClickHouseQueryProvider                           │
│                          (REST API queries only)                            │
│                                        │                                    │
│                                        ▼                                    │
│                                    Admin UI                                 │
│                          (NOT real-time, poll-based)                        │
│                                                                             │
│                  ❌ NO WEBSOCKET PATH FOR SPANS ❌                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Key Components

**Runner Logs Pipeline**:
1. `LogCollector` with `RingBuffer` for in-memory storage
2. Multiple stream listeners (file persistence + WebSocket)
3. `ServerLogStreamer` for WebSocket broadcasting
4. Real-time delivery to subscribed clients

**Spans Pipeline**:
1. `DefaultObservabilityInstance` creates spans
2. `DefaultExporter` buffers and batches events
3. `ObservabilityWriter` writes JSONL files
4. `IngestionWorker` polls and inserts to ClickHouse
5. `ClickHouseQueryProvider` for REST API queries

## Related Research

- `thoughts/shared/research/2025-01-25-observability-injection-patterns.md` - Observability injection patterns
- `thoughts/shared/research/2025-01-25-admin-example-observability-alignment.md` - Admin example alignment
- `thoughts/shared/plans/2025-01-25-observability-architecture-refinement.md` - Architecture refinement plan
- `thoughts/shared/plans/2025-01-23-observability-clickhouse.md` - ClickHouse observability plan

## Open Questions

1. **Should spans have a WebSocket real-time path similar to runner logs?**
   - Would require adding span-related WebSocket message types
   - Would need a callback mechanism from ObservabilityWriter to WebSocket
   - Could be high volume depending on span generation rate

2. **How does the current ClickHouse polling latency affect observability UX?**
   - Default poll interval is 10 seconds
   - Spans only visible after ingestion completes
   - No real-time span streaming

3. **Is ObservabilityWriter being properly initialized in runner deployments?**
   - Runner checks for `observabilityStorage` at line 260
   - Creates writer with batch size 100, flush interval 5000ms
   - Wires to LogCollector but span generation happens elsewhere (in core/observability)

4. **Where do spans actually get generated during server execution?**
   - Spans come from `@mastra/observability` package
   - Generated during agent/workflow/tool execution via decorators/context
   - Need to verify the runner's deployed Mastra instance has observability configured
