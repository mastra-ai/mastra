# Working Memory

Working memory is a powerful feature that allows agents to maintain persistent information about users across conversations, even with minimal context. Unlike traditional message history, working memory focuses on continuously relevant information that should persist throughout interactions.

## What is Working Memory?

Working memory is:
- A system for persistently storing key information about users or interactions
- XML-based structured data that agents maintain automatically
- Injected into every conversation for continuous context
- Invisible to users but accessible to the agent

Working memory is ideal for:
- User preferences and personal details
- Ongoing tasks or stateful information
- Facts that should remain accessible regardless of conversation length
- Information that should persist across different conversation threads

## How Working Memory Works

Working memory operates using a system of XML tags that the agent updates during conversations:

1. **Template Definition**: You define what information should be remembered using XML tags
2. **Automatic Updates**: The agent includes special `<working_memory>...</working_memory>` tags in responses
3. **Memory Management**: The system extracts and stores these blocks
4. **Context Injection**: Working memory is injected into future conversations

This process is seamless to users, who never see the XML tags in the final responses.

## Enabling Working Memory

```typescript
import { Memory } from "@mastra/memory";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";

// Create memory with working memory enabled
const memory = new Memory({
  options: {
    workingMemory: {
      enabled: true,
      // Optional custom template
      template: `<user>
  <first_name></first_name>
  <last_name></last_name>
  <preferences>
    <food></food>
    <travel></travel>
  </preferences>
</user>`,
    },
  },
});

// Create agent with working memory
const agent = new Agent({
  name: "PersonalAssistant",
  instructions: "You are a helpful personal assistant.",
  model: openai("gpt-4o"),
  memory: memory,
});
```

If no template is provided, a default comprehensive template will be used.

## Working Memory Modes

There are two ways for agents to update working memory:

### 1. Text Stream Mode (Default)

The agent updates working memory by including XML tags directly in its response text:

```
User: My name is John Smith and I like Italian food.

Agent (raw): <working_memory><user><first_name>John</first_name><last_name>Smith</last_name><preferences><food>Italian</food></preferences></user></working_memory> I'll remember that you're John and you enjoy Italian cuisine!

User (sees): I'll remember that you're John and you enjoy Italian cuisine!
```

### 2. Tool Call Mode

The agent uses tool calls to update working memory:

```typescript
const memory = new Memory({
  options: {
    workingMemory: {
      enabled: true,
      use: 'tool-call', // Use tool-call mode instead of text-stream
    },
  },
});
```

## Handling Working Memory in Streaming

To prevent working memory XML tags from being visible to users:

```typescript
import { maskStreamTags } from "@mastra/core/utils";

// Mask working_memory tags in the stream
for await (const chunk of maskStreamTags(response.textStream, "working_memory")) {
  // Send clean chunk to user
  process.stdout.write(chunk);
}
```

You can also hook into memory update events:

```typescript
const maskedStream = maskStreamTags(response.textStream, "working_memory", {
  onStart: () => showLoadingSpinner(),
  onEnd: () => hideLoadingSpinner(),
  onMask: (chunk) => console.debug("Memory updated:", chunk),
});
```

## Working Memory Example

```typescript
// Create agent with working memory
const assistant = new Agent({
  name: "Personal Assistant",
  instructions: "You are a personal assistant who remembers user preferences.",
  model: openai("gpt-4o"),
  memory: new Memory({
    options: {
      workingMemory: {
        enabled: true,
      },
      // Only keep 5 recent messages in context
      lastMessages: 5,
    },
  }),
});

// First interaction - agent learns about the user
await assistant.stream("Hi, I'm Sarah and I prefer vegetarian food.", {
  resourceId: "user_sarah",
  threadId: "conversation_789",
});

// Later - agent remembers preferences even with minimal context
const response = await assistant.stream("Can you suggest a restaurant?", {
  resourceId: "user_sarah",
  threadId: "conversation_789",
});

// Mask working memory tags in output
for await (const chunk of maskStreamTags(response.textStream, "working_memory")) {
  process.stdout.write(chunk);
}
```

Working memory helps build agents that feel like they truly remember users, maintaining personalizations and preferences across conversations. 