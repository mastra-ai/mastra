# Last Messages: Turn-Based Interactions

The most fundamental form of memory in Mastra is the ability to maintain conversation context through recent message history. This section covers how Mastra handles turn-based interactions using the "last messages" feature.

## Understanding Last Messages

When agents engage in conversations, they need access to the recent exchanges to maintain context. The "last messages" feature:

- Automatically retrieves the most recent messages from a conversation thread
- Includes these messages in the agent's context window
- Ensures conversational continuity across multiple turns
- Works without any additional configuration

## How Last Messages Work

Each time you call an agent with a `resourceId` and `threadId`:

1. The agent automatically queries memory for recent messages from that thread
2. By default, the 40 most recent messages are retrieved
3. These messages are added to the agent's context window
4. The agent can then respond with awareness of the recent conversation

```
┌────────────────┐         ┌─────────────┐         ┌───────────────┐
│  Thread Store  │ ◄─────► │ Last Messages│ ◄─────► │ Context Window│
└────────────────┘         └─────────────┘         └───────────────┘
```

## Configuring Last Messages

You can customize how many recent messages are included:

```typescript
// Global configuration when creating memory
const memory = new Memory({
  options: {
    lastMessages: 20, // Retrieve 20 most recent messages
  },
});

// Per-request configuration
await agent.stream("Hello again", {
  resourceId: "user_123",
  threadId: "thread_456",
  memoryOptions: {
    lastMessages: 10, // Override to retrieve only 10 messages
  },
});
```

### Disabling Last Messages

In some cases, you might want to disable last messages entirely:

```typescript
// Disable globally
const memory = new Memory({
  options: {
    lastMessages: false, // Disable last messages retrieval
  },
});

// Disable for a specific request
await agent.stream("Start fresh", {
  resourceId: "user_123",
  threadId: "thread_456",
  memoryOptions: {
    lastMessages: false,
  },
});
```

## When to Use Last Messages

Last messages are ideal for:

- Standard conversational agents
- Short to medium-length conversations
- Interactions where immediate context is most important
- Situations where recency is more important than relevance

## Last Messages Example

```typescript
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { openai } from "@ai-sdk/openai";

// Create memory with custom last messages setting
const memory = new Memory({
  options: {
    lastMessages: 15, // Retrieve 15 most recent messages
  },
});

// Create an agent with memory
const agent = new Agent({
  name: "ConversationAgent",
  instructions: "You are a helpful assistant.",
  model: openai("gpt-4o"),
  memory: memory,
});

// First message in conversation
await agent.stream("My name is Jamie and I live in Toronto.", {
  resourceId: "user_jamie",
  threadId: "conversation_123",
});

// Second message - agent will remember the first message
await agent.stream("What's the weather like near me?", {
  resourceId: "user_jamie",
  threadId: "conversation_123",
});

// Third message - agent will remember both previous messages
await agent.stream("Can you recommend activities suitable for this weather?", {
  resourceId: "user_jamie",
  threadId: "conversation_123",
});
```

## Token Considerations

The more messages you include with the `lastMessages` setting, the more tokens will be consumed. Consider your model's context window limitations when configuring this setting.

For long-running conversations, you might need to:
1. Reduce the `lastMessages` count
2. Enable semantic recall to find relevant past messages
3. Use working memory to maintain important facts about the user

## Related Features

- **[Semantic Recall](./3.2-semantic-recall.md)**: For finding relevant messages regardless of recency
- **[Working Memory](./3.3-working-memory.md)**: For maintaining persistent information across conversations
- **[Token Management](./3.5-token-management.md)**: For optimizing token usage with various memory strategies 